<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <!-- META VIEWPORT YANG BENAR - PENTING UNTUK RESPONSIVITAS -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Headers Keamanan -->
    <meta http-equiv="Permissions-Policy" content="geolocation=(), camera=(), microphone=()">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">

    <!-- Meta Informasi SEO & Aplikasi -->
    <meta name="description"
        content="Green Valley - Platform sewa apartemen terintegrasi untuk manajemen properti yang efisien dan modern.">
    <meta name="keywords"
        content="sewa apartemen, manajemen properti, aplikasi properti, Green Valley, property management system">
    <meta name="author" content="Green Valley Development Team">
    <meta name="theme-color" content="#3b82f6"> <!-- Warna tema untuk UI browser di mobile -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Open Graph / Social Media Sharing -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Green Valley - Platform Sewa Apartemen Modern">
    <meta property="og:description" content="Kelola properti sewa Anda dengan mudah menggunakan Green Valley.">
    <meta property="og:image" content="https://i.ibb.co/9gP4s5B/og-image-green-valley.png">
    <meta property="og:url" content="https://GreenValley.example.com"> <!-- Ganti dengan URL sebenarnya -->

    <!-- Favicon & App Icons (Placeholder, ganti dengan ikon asli) -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://via.placeholder.com/32x32?text=GV">
    <link rel="icon" type="image/png" sizes="16x16" href="https://via.placeholder.com/16x16?text=GV">
    <link rel="apple-touch-icon" sizes="180x180" href="https://via.placeholder.com/180x180?text=Green Valley">

    <title>Green Valley - Platform Sewa Apartemen Modern</title>

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome untuk ikon (Gratis) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Bootstrap Icons (Gratis, alternatif atau pelengkap Font Awesome) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        /* ==========================================================================
           Design Tokens & Reset Global
           ========================================================================== */
        :root {
            /* Skala Font (Fluid Typography) */
            --font-size-xs: clamp(0.75rem, calc(0.7rem + 0.25vw), 0.875rem);
            /* 12px - 14px */
            --font-size-sm: clamp(0.875rem, calc(0.8rem + 0.375vw), 1rem);
            /* 14px - 16px */
            --font-size-base: clamp(1rem, calc(0.9rem + 0.5vw), 1.125rem);
            /* 16px - 18px */
            --font-size-md: clamp(1.125rem, calc(1rem + 0.625vw), 1.25rem);
            /* 18px - 20px */
            --font-size-lg: clamp(1.25rem, calc(1.1rem + 0.75vw), 1.5rem);
            /* 20px - 24px */
            --font-size-xl: clamp(1.5rem, calc(1.3rem + 1vw), 2rem);
            /* 24px - 32px */
            --font-size-2xl: clamp(2rem, calc(1.8rem + 1.25vw), 3rem);
            /* 32px - 48px */
            --font-size-3xl: clamp(2.5rem, calc(2.3rem + 1.5vw), 4rem);
            /* 40px - 64px */

            /* Skala Spasi (Fluid Spacing) */
            --spacing-px: 1px;
            --spacing-0: 0;
            --spacing-1: clamp(0.25rem, calc(0.2rem + 0.25vw), 0.5rem);
            /* 4px - 8px */
            --spacing-2: clamp(0.5rem, calc(0.4rem + 0.5vw), 0.75rem);
            /* 8px - 12px */
            --spacing-3: clamp(0.75rem, calc(0.65rem + 0.5vw), 1rem);
            /* 12px - 16px */
            --spacing-4: clamp(1rem, calc(0.85rem + 0.75vw), 1.5rem);
            /* 16px - 24px */
            --spacing-5: clamp(1.5rem, calc(1.25rem + 1.25vw), 2rem);
            /* 24px - 32px */
            --spacing-6: clamp(2rem, calc(1.75rem + 1.25vw), 3rem);
            /* 32px - 48px */
            --spacing-8: clamp(3rem, calc(2.75rem + 1.25vw), 4rem);
            /* 48px - 64px */
            --spacing-10: clamp(4rem, calc(3.75rem + 1.25vw), 5rem);
            /* 64px - 80px */

            /* Sistem Warna - Tema Terang (Default) */
            --background: #f8fafc;
            /* slate-50 */
            --foreground: #0f172a;
            /* slate-900 */
            --card: #ffffff;
            --card-foreground: #0f172a;
            --popover: #ffffff;
            --popover-foreground: #0f172a;
            --primary: #3b82f6;
            /* blue-500 */
            --primary-foreground: #ffffff;
            --primary-hover: #2563eb;
            /* blue-600 */
            --primary-active: #1d4ed8;
            /* blue-700 NEW for button press */
            --secondary: #f1f5f9;
            /* slate-100 */
            --secondary-foreground: #0f172a;
            --secondary-hover: #e2e8f0;
            /* slate-200 */
            --secondary-active: #cbd5e1;
            /* slate-300 NEW for button press */
            --muted: #f1f5f9;
            /* slate-100 */
            --muted-foreground: #64748b;
            /* slate-500 */
            --accent: #e0f2fe;
            /* sky-100 */
            --accent-foreground: #0c4a6e;
            /* sky-800 */
            --accent-hover: #bae6fd;
            /* sky-200 */
            --destructive: #ef4444;
            /* red-500 */
            --destructive-foreground: #ffffff;
            --destructive-hover: #dc2626;
            /* red-600 */
            --destructive-active: #b91c1c;
            /* red-700 NEW for button press */
            --border: #e2e8f0;
            /* slate-200 */
            --input: #e2e8f0;
            /* slate-200 */
            --input-focus: #cbd5e1;
            /* slate-300 */
            --ring: #3b82f6;
            /* blue-500 */
            --success: #22c55e;
            /* green-500 */
            --success-foreground: #ffffff;
            --warning: #f59e0b;
            /* amber-500 */
            --warning-foreground: #ffffff;
            --info: #0ea5e9;
            /* sky-500 */
            --info-foreground: #ffffff;

            /* Properti Layout */
            --radius-sm: 0.25rem;
            /* 4px */
            --radius: 0.5rem;
            /* 8px */
            --radius-md: 0.75rem;
            /* 12px */
            --radius-lg: 1rem;
            /* 16px */
            --radius-full: 9999px;
            --sidebar-width: 280px;
            --sidebar-width-collapsed: 80px;
            /* Untuk tampilan ikon saja jika diperlukan */
            --header-height: 70px;
            --footer-height: 60px;
            --container-max-width: 1280px;

            /* Bayangan (Shadows) */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --shadow-inner: inset 0 2px 4px 0 rgb(0 0 0 / 0.05);

            /* Transisi */
            --transition-all: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-colors: background-color 0.3s cubic-bezier(0.4, 0, 0.2, 1), border-color 0.3s cubic-bezier(0.4, 0, 0.2, 1), color 0.3s cubic-bezier(0.4, 0, 0.2, 1), fill 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-opacity: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-shadow: box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-transform: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            /* NEW for faster interactions */


            /* Z-index (untuk mengatur tumpukan elemen) */
            --z-0: 0;
            --z-10: 10;
            /* Konten dasar */
            --z-20: 20;
            /* Elemen di atas konten */
            --z-30: 30;
            /* Dropdown, tooltip */
            --z-40: 40;
            /* Header, sidebar sticky */
            --z-50: 50;
            /* Modal, overlay */
            --z-dropdown: 1000;
            --z-sticky: 1100;
            --z-fixed: 1200;
            --z-modal-backdrop: 1290;
            --z-modal: 1300;
            --z-alert-modal-backdrop: 1390;
            /* Sedikit di atas modal biasa jika diperlukan */
            --z-alert-modal: 1400;
            /* Sedikit di atas modal biasa jika diperlukan */
            --z-chat-widget: 1500;
            /* Untuk floating chat widget */
            --z-toast: 1600;
            --z-overlay: 1700;
            /* Overlay loading global */
        }

        /* Tema Gelap */
        .dark {
            --background: #020617;
            /* slate-950 */
            --foreground: #f1f5f9;
            /* slate-100 */
            --card: #0f172a;
            /* slate-900 */
            --card-foreground: #f1f5f9;
            --popover: #0f172a;
            --popover-foreground: #f1f5f9;
            --primary: #60a5fa;
            /* blue-400 */
            --primary-foreground: #0f172a;
            --primary-hover: #3b82f6;
            /* blue-500 */
            --primary-active: #2563eb;
            /* blue-600 */
            --secondary: #1e293b;
            /* slate-800 */
            --secondary-foreground: #f1f5f9;
            --secondary-hover: #334155;
            /* slate-700 */
            --secondary-active: #475569;
            /* slate-600 */
            --muted: #1e293b;
            --muted-foreground: #94a3b8;
            /* slate-400 */
            --accent: #1e3a8a;
            /* blue-900 */
            --accent-foreground: #bfdbfe;
            /* blue-200 */
            --accent-hover: #1e40af;
            /* blue-800 */
            --destructive: #f87171;
            /* red-400 */
            --destructive-foreground: #0f172a;
            --destructive-hover: #ef4444;
            /* red-500 */
            --destructive-active: #dc2626;
            /* red-600 */
            --border: #1e293b;
            /* slate-800 */
            --input: #1e293b;
            --input-focus: #334155;
            /* slate-700 */
            --ring: #60a5fa;
            --success: #4ade80;
            /* green-400 */
            --success-foreground: #0f172a;
            --warning: #fbbf24;
            /* amber-400 */
            --warning-foreground: #0f172a;
            --info: #38bdf8;
            /* sky-400 */
            --info-foreground: #0f172a;
        }

        /* Reset & Gaya Dasar */
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-tap-highlight-color: transparent;
            /* Menghilangkan highlight biru pada tap di mobile */
        }

        html {
            font-size: 16px;
            /* Basis untuk REM */
            scroll-behavior: smooth;
            height: 100%;
            /* PERBAIKAN RESPONSIVITAS: Mencegah scroll horizontal yang tidak diinginkan di level tertinggi */
            overflow-x: hidden;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            line-height: 1.6;
            color: var(--foreground);
            background-color: var(--background);
            min-height: 100vh;
            /* transisi dinonaktifkan sementara oleh JS saat inisialisasi */
            text-rendering: optimizeLegibility;
            /* Meningkatkan keterbacaan teks */
            display: flex;
            /* Untuk struktur dasar aplikasi (sidebar + main) */
            flex-direction: row;
            /* Konten utama bersebelahan dengan sidebar */
        }

        /* PERBAIKAN RESPONSIVITAS: Menambah overlay saat sidebar mobile aktif */
        body.sidebar-open-overlay::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: calc(var(--z-fixed) - 1);
            /* Tepat di bawah sidebar */
            display: none;
            /* Default tersembunyi */
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        body.sidebar-open-overlay.show-overlay::before {
            display: block;
            opacity: 1;
        }

        /* Tipografi */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-weight: 700;
            /* Lebih tebal untuk judul */
            line-height: 1.2;
            letter-spacing: -0.025em;
            margin-bottom: var(--spacing-3);
            color: var(--foreground);
            /* Mengikuti warna teks utama */
        }

        h1 {
            font-size: var(--font-size-2xl);
        }

        h2 {
            font-size: var(--font-size-xl);
        }

        h3 {
            font-size: var(--font-size-lg);
        }

        h4 {
            font-size: var(--font-size-md);
        }

        h5 {
            font-size: var(--font-size-base);
        }

        h6 {
            font-size: var(--font-size-sm);
        }

        p {
            margin-bottom: var(--spacing-4);
            font-size: var(--font-size-base);
            color: var(--muted-foreground);
            /* Warna lebih soft untuk paragraf */
        }

        p.lead {
            font-size: var(--font-size-md);
            color: var(--foreground);
        }

        a {
            color: var(--primary);
            text-decoration: none;
            transition: var(--transition-colors);
        }

        a:hover {
            color: var(--primary-hover);
            text-decoration: underline;
        }

        /* Elemen Form */
        button,
        input,
        select,
        textarea {
            font-family: inherit;
            font-size: var(--font-size-base);
            line-height: inherit;
            color: inherit;
            border-radius: var(--radius);
        }

        button {
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            display: inline-flex;
            /* Agar ikon dan teks sejajar */
            align-items: center;
            justify-content: center;
            gap: var(--spacing-2);
            font-weight: 500;
            transition: var(--transition-fast), transform 0.1s ease-out;
            /* Added transform for press effect */
        }

        /* NEW: Button press effect */
        button:active {
            transform: scale(0.97);
        }

        button:disabled,
        input:disabled,
        select:disabled,
        textarea:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        input,
        select,
        textarea {
            padding: var(--spacing-2) var(--spacing-3);
            border: 1px solid var(--input);
            background-color: var(--card);
            transition: var(--transition-all);
            width: 100%;
            /* Default form controls to full width */
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: var(--ring);
            box-shadow: 0 0 0 2px var(--ring);
        }

        select {
            appearance: none;
            /* Hapus tampilan default browser */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%2364748b'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right var(--spacing-2) center;
            background-size: 1.5em 1.5em;
            padding-right: var(--spacing-8);
            /* Ruang untuk ikon panah */
        }

        /* Style untuk dark mode select arrow */
        .dark select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%2394a3b8'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
        }


        /* Elemen Media */
        img,
        picture,
        video,
        canvas {
            /* Tidak ada SVG */
            display: block;
            max-width: 100%;
            height: auto;
        }

        /* Utilitas Aksesibilitas */
        .sr-only {
            /* Screen-reader only */
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .loading-placeholder {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--spacing-5);
            color: var(--muted-foreground);
            font-style: italic;
            gap: var(--spacing-2);
        }

        .loading-placeholder i {
            font-size: var(--font-size-lg);
        }

        /* NEW: Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInFromBottom {
            from {
                opacity: 0;
                transform: translateY(15px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes slideInFromRight {

            /* For sent messages */
            from {
                opacity: 0;
                transform: translateX(15px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        @keyframes slideInFromLeft {

            /* For received messages */
            from {
                opacity: 0;
                transform: translateX(-15px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        @keyframes typingDots {

            0%,
            20% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-4px);
            }
        }

        /* ==========================================================================
           Struktur Layout Utama
           ========================================================================== */
        /* .app-container sudah ada di <body> */

        .sidebar {
            width: var(--sidebar-width);
            background: var(--card);
            padding: var(--spacing-5) var(--spacing-4);
            border-right: 1px solid var(--border);
            height: 100vh;
            /* Tinggi penuh viewport */
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-md);
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
            /* Scroll jika konten sidebar panjang */
            z-index: var(--z-sticky);
            /* Di atas konten lain */
            flex-shrink: 0;
            /* Mencegah sidebar menyusut */
        }


        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-6);
            padding: 0 var(--spacing-2);
            /* Padding agar tidak terlalu mepet jika sidebar collapsed */
        }

        .sidebar-brand__icon {
            font-size: var(--font-size-2xl);
            color: var(--primary);
            transition: var(--transition-all);
        }

        .sidebar-brand__text {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--primary);
            transition: var(--transition-opacity);
            white-space: nowrap;
            /* Agar teks tidak wrap */
        }

        .nav-menu {
            list-style: none;
            flex-grow: 1;
            /* Mengisi sisa ruang di sidebar */
        }

        .nav-item {
            margin-bottom: var(--spacing-1);
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            padding: var(--spacing-2) var(--spacing-3);
            color: var(--muted-foreground);
            /* Warna default untuk link navigasi */
            border-radius: var(--radius-md);
            transition: var(--transition-all), transform 0.1s ease-out;
            font-size: var(--font-size-base);
            font-weight: 500;
            white-space: nowrap;
        }

        .nav-link i {
            /* Ikon di navigasi */
            width: 20px;
            /* Menjaga lebar ikon konsisten */
            text-align: center;
            font-size: var(--font-size-md);
        }

        .nav-link:hover {
            background: var(--accent);
            color: var(--accent-foreground);
            text-decoration: none;
            transform: translateX(3px);
            /* NEW: Subtle hover effect */
        }

        .nav-link:active {
            transform: translateX(1px) scale(0.99);
            /* NEW: Press effect */
        }

        .nav-link.active {
            background: var(--primary);
            color: var(--primary-foreground);
            box-shadow: var(--shadow-sm);
        }

        .nav-link.active:hover {
            transform: none;
            /* Prevent hover transform on active link */
        }

        .main-wrapper {
            flex-grow: 1;
            /* Mengisi sisa ruang di body */
            display: flex;
            flex-direction: column;
            height: 100vh;
            /* Memastikan wrapper utama mengisi tinggi viewport */
            overflow-y: auto;
            /* Scroll utama aplikasi ada di sini */
            width: calc(100% - var(--sidebar-width)); /* Mengisi sisa ruang */
            transition: width 0.3s ease-in-out;
        }

        .app-header {
            height: var(--header-height);
            background: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 0 var(--spacing-5);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            /* Membuat header tetap di atas saat scroll */
            top: 0;
            z-index: var(--z-sticky);
            box-shadow: var(--shadow-sm);
        }

        .header-left,
        .header-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
        }

        /* PERBAIKAN RESPONSIVITAS: Sembunyikan tombol sidebar di desktop */
        #sidebarToggle {
            display: none;
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: var(--secondary);
            padding: var(--spacing-1) var(--spacing-3);
            border-radius: var(--radius-full);
            /* Membuatnya lebih rounded */
            border: 1px solid var(--border);
            max-width: 400px;
            flex-grow: 1;
            /* Agar bisa mengisi ruang jika ada */
        }

        .search-bar i {
            color: var(--muted-foreground);
            margin-right: var(--spacing-2);
        }

        .search-bar input {
            border: none;
            background: transparent;
            outline: none;
            flex-grow: 1;
            padding: var(--spacing-2) 0;
            font-size: var(--font-size-sm);
        }

        .search-bar input::placeholder {
            color: var(--muted-foreground);
        }

        .profile-dropdown {
            position: relative;
        }

        .profile-dropdown__toggle {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            cursor: pointer;
            padding: var(--spacing-1);
            border-radius: var(--radius-full);
            /* Avatar bulat */
            transition: var(--transition-all);
        }

        .profile-dropdown__toggle:hover {
            background: var(--secondary-hover);
        }

        .profile-dropdown__toggle img {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            object-fit: cover;
            border: 2px solid var(--border);
        }

        .profile-dropdown__toggle span {
            font-weight: 500;
            font-size: var(--font-size-sm);
        }

        .profile-dropdown__menu {
            position: absolute;
            top: calc(100% + var(--spacing-2));
            /* Jarak dari toggle */
            right: 0;
            background: var(--popover);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 220px;
            z-index: var(--z-dropdown);
            opacity: 0;
            transform: translateY(-10px);
            visibility: hidden;
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
        }

        .profile-dropdown__menu.show {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }

        .profile-dropdown__item {
            display: flex;
            /* Untuk ikon dan teks */
            align-items: center;
            gap: var(--spacing-2);
            padding: var(--spacing-2) var(--spacing-3);
            color: var(--popover-foreground);
            transition: var(--transition-all);
            font-size: var(--font-size-sm);
        }

        .profile-dropdown__item i {
            width: 16px;
            text-align: center;
            color: var(--muted-foreground);
        }

        .profile-dropdown__item:hover {
            background: var(--primary);
            color: var(--primary-foreground);
            text-decoration: none;
        }

        .profile-dropdown__item:hover i {
            color: var(--primary-foreground);
        }

        .profile-dropdown__divider {
            height: 1px;
            background-color: var(--border);
            margin: var(--spacing-1) 0;
        }

        .theme-toggle {
            padding: var(--spacing-2);
            border-radius: var(--radius-full);
            /* Bulat */
            background: transparent;
            /* Lebih subtle */
            color: var(--muted-foreground);
            font-size: var(--font-size-lg);
            transition: var(--transition-all);
            line-height: 1;
            /* Menghindari perubahan tinggi saat ikon berubah */
        }

        .theme-toggle:hover {
            background: var(--secondary-hover);
            color: var(--foreground);
        }

        .theme-toggle i {
            margin: 0;
        }

        /* Reset gap default dari button */

        .main-content {
            padding: var(--spacing-5);
            flex-grow: 1;
            /* Mengisi sisa ruang di main-wrapper */
        }

        .page-section {
            display: none; /* Dikelola oleh JS */
            animation: fadeIn 0.5s ease-out;
        }
        .page-section.active {
            display: block; /* Dikelola oleh JS */
        }

        /* ==========================================================================
           Komponen UI Kustom
           ========================================================================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-5);
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            /* Radius lebih besar untuk card */
            box-shadow: var(--shadow);
            padding: var(--spacing-5);
            transition: var(--transition-all);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-3px);
        }

        .card-header {
            padding-bottom: var(--spacing-3);
            margin-bottom: var(--spacing-3);
            border-bottom: 1px solid var(--border);
        }

        .card-header h3 {
            margin-bottom: var(--spacing-1);
        }

        .card-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            margin-bottom: var(--spacing-1);
        }

        .card-description {
            font-size: var(--font-size-sm);
            color: var(--muted-foreground);
            margin-bottom: var(--spacing-3);
        }

        .card-footer {
            padding-top: var(--spacing-3);
            margin-top: var(--spacing-3);
            border-top: 1px solid var(--border);
        }


        .apartments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-5);
        }

        .apartment-card {
            /* adalah .card */
            overflow: hidden;
            /* Agar gambar tidak keluar dari border-radius */
            display: flex;
            /* NEW: For better internal layout control */
            flex-direction: column;
            /* NEW: Stack image and content */
            padding: 0; /* Override padding card */
        }
        
        .apartment-card .card-body {
            padding: var(--spacing-4);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }


        .apartment-card .apartment-actions {
            /* NEW: Push actions to bottom */
            margin-top: auto;
        }

        .apartment-card img {
            width: 100%;
            height: 220px;
            object-fit: cover;
            border-bottom: 1px solid var(--border);
        }

        .apartment-card h3 {
            font-size: var(--font-size-md);
            margin-bottom: var(--spacing-2);
        }

        .apartment-card p {
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-1);
        }

        .apartment-actions {
            display: flex;
            gap: var(--spacing-2);
            margin-top: var(--spacing-4);
            flex-wrap: wrap;
            /* Agar tombol wrap di layar kecil */
        }


        .filter-section {
            display: flex;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-5);
            flex-wrap: wrap;
            /* Agar filter wrap */
            align-items: center;
            padding: var(--spacing-4);
            background-color: var(--card);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }

        .filter-section select,
        .filter-section button {
            /* Ukuran sudah diatur oleh elemen form dasar */
            flex-grow: 1;
            /* Agar elemen filter mengisi ruang */
            min-width: 180px;
            /* Lebar minimum sebelum wrap */
        }


        .table-container {
            overflow-x: auto;
            /* Penting untuk tabel responsif */
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card);
        }

        th,
        td {
            padding: var(--spacing-3) var(--spacing-4);
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: var(--font-size-sm);
        }

        th {
            background: var(--secondary);
            /* Header tabel lebih soft */
            color: var(--secondary-foreground);
            font-weight: 600;
            text-transform: uppercase;
            /* Teks header kapital */
            letter-spacing: 0.05em;
        }

        tbody tr:last-child td {
            border-bottom: none;
            /* Hapus border bawah baris terakhir */
        }

        tbody tr:hover {
            background-color: var(--accent);
        }


        .badge {
            display: inline-block;
            padding: var(--spacing-1) var(--spacing-2);
            border-radius: var(--radius-full);
            /* Badge bulat */
            font-size: var(--font-size-xs);
            font-weight: 600;
            text-transform: capitalize;
            line-height: 1.2;
        }

        .badge--active,
        .badge--lunas,
        .badge--terverifikasi {
            /* Tambahkan Lunas, Terverifikasi */
            background: var(--success);
            color: var(--success-foreground);
        }

        .badge--pending,
        .badge--menunggu-verifikasi {
            /* Tambahkan Menunggu Verifikasi */
            background: var(--warning);
            color: var(--warning-foreground);
        }

        .badge--due,
        .badge--inactive,
        .badge--dibatalkan {
            /* Tambahkan Dibatalkan */
            background: var(--destructive);
            color: var(--destructive-foreground);
        }

        .badge--info,
        .badge--deposit {
            /* Tambahkan Deposit */
            background: var(--info);
            color: var(--info-foreground);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            /* Lebih gelap */
            backdrop-filter: blur(4px);
            /* Efek blur modern */
            display: none;
            /* Default tersembunyi */
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: var(--z-modal-backdrop);
        }

        .modal-overlay.show {
            display: flex;
            opacity: 1;
        }

        #alertModalOverlay {
            /* Target spesifik untuk alert modal */
            z-index: var(--z-alert-modal-backdrop);
        }

        /* Z-index untuk payment modal agar bisa di atas modal lain jika diperlukan */
        #paymentModalOverlay {
            z-index: var(--z-modal-backdrop);
            /* Sama dengan modal lain, atau lebih tinggi jika perlu */
        }

        .modal-overlay.show .modal__dialog {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        .modal__dialog {
            /* Ini menjadi container untuk modal content */
            max-width: 600px;
            width: calc(100% - var(--spacing-8));
            /* Memberi sedikit margin di layar kecil */
            background: var(--card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            display: flex;
            flex-direction: column;
            transform: scale(0.95) translateY(20px);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            z-index: var(--z-modal);
        }

        #alertModalOverlay .modal__dialog {
            /* Konten alert modal */
            z-index: var(--z-alert-modal);
            max-width: 500px;
            /* Alert modal bisa lebih kecil */
        }

        #paymentModalDialog {
            /* Style untuk modal pembayaran */
            max-width: 700px;
            z-index: var(--z-modal);
            /* Sama dengan modal lain */
        }

        /* BEGIN: Property Detail Modal Specific Styling */
        #propertyDetailModalDialog {
            max-width: 800px;
            /* Lebih lebar untuk detail properti */
        }

        .property-detail-modal__gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: var(--spacing-2);
            margin-bottom: var(--spacing-4);
        }

        .property-detail-modal__gallery img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: var(--radius-sm);
            cursor: pointer;
            border: 2px solid transparent;
            transition: var(--transition-all);
        }

        .property-detail-modal__gallery img:hover,
        .property-detail-modal__gallery img.active-thumbnail {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .property-detail-modal__main-image-container {
            width: 100%;
            height: 300px;
            /* Sesuaikan tinggi gambar utama */
            margin-bottom: var(--spacing-4);
            border-radius: var(--radius-md);
            overflow: hidden;
            background-color: var(--secondary);
            /* Placeholder jika gambar tidak ada */
        }

        .property-detail-modal__main-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .property-detail-modal__info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-4);
        }

        .property-detail-modal__info-item strong,
        .transaction-detail-modal__info-item strong,
        /* Tambahkan untuk detail transaksi */
        .profile-info-item strong,
        /* Tambahkan untuk profil */
        .settings-item strong

        /* Tambahkan untuk settings */
            {
            display: block;
            color: var(--foreground);
            margin-bottom: var(--spacing-1);
            font-weight: 600;
            /* Perjelas strong */
        }

        .property-detail-modal__info-item p,
        .transaction-detail-modal__info-item p,
        /* Tambahkan untuk detail transaksi */
        .profile-info-item p,
        /* Tambahkan untuk profil */
        .settings-item p

        /* Tambahkan untuk settings */
            {
            margin-bottom: 0;
            font-size: var(--font-size-sm);
            color: var(--muted-foreground);
        }

        /* Style untuk .profile-info-item di halaman profil (non-modal) */
        #profile-content .profile-info-item {
            margin-bottom: var(--spacing-3);
        }

        #profile-content .profile-info-item p {
            color: var(--foreground);
            /* Warna teks profil lebih jelas */
        }


        .property-detail-modal__section-title {
            font-size: var(--font-size-md);
            font-weight: 600;
            color: var(--primary);
            margin-top: var(--spacing-4);
            margin-bottom: var(--spacing-2);
            padding-bottom: var(--spacing-1);
            border-bottom: 1px solid var(--border);
        }

        .property-detail-modal__amenities-list {
            list-style: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-2);
        }

        .property-detail-modal__amenities-list li {
            background: var(--accent);
            color: var(--accent-foreground);
            padding: var(--spacing-1) var(--spacing-2);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
        }

        .property-detail-modal__map-placeholder {
            width: 100%;
            height: 200px;
            background-color: var(--secondary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--muted-foreground);
            font-style: italic;
        }

        /* END: Property Detail Modal Specific Styling */

        /* BEGIN: Transaction Detail Modal Specific Styling */
        #transactionDetailModalDialog {
            max-width: 700px;
            /* Sedikit lebih kecil dari detail properti */
        }

        .transaction-detail-modal__info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            /* Dua kolom biasanya cukup */
            gap: var(--spacing-4);
        }

        .transaction-detail-modal__notes {
            background-color: var(--secondary);
            padding: var(--spacing-3);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            margin-top: var(--spacing-3);
        }

        /* END: Transaction Detail Modal Specific Styling */

        /* BEGIN: Payment Modal Styling */
        .payment-method-options {
            display: flex;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-4);
            justify-content: space-around;
            /* Or center */
        }

        .payment-method-options label {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--spacing-3);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-all);
            min-width: 120px;
            text-align: center;
        }

        .payment-method-options label:hover {
            border-color: var(--primary-hover);
            background-color: var(--accent);
        }

        .payment-method-options input[type="radio"] {
            appearance: none;
            /* Hide default radio */
            position: absolute;
            /* Take out of flow */
            opacity: 0;
            width: 0;
            height: 0;
        }

        .payment-method-options input[type="radio"]:checked+.payment-method-label {
            border-color: var(--primary);
            background-color: var(--accent-hover);
            box-shadow: 0 0 0 2px var(--ring);
        }


        .payment-method-options i {
            font-size: var(--font-size-2xl);
            margin-bottom: var(--spacing-2);
            color: var(--primary);
        }

        .payment-method-options span {
            font-weight: 500;
        }

        .payment-details-section {
            padding: var(--spacing-3);
            background-color: var(--secondary);
            border-radius: var(--radius-sm);
            margin-top: var(--spacing-3);
        }

        .payment-details-section p {
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-2);
        }

        .payment-details-section strong {
            color: var(--foreground);
        }

        .upload-area {
            border: 2px dashed var(--input-focus);
            padding: var(--spacing-4);
            text-align: center;
            border-radius: var(--radius-md);
            margin-top: var(--spacing-2);
            cursor: pointer;
            background-color: var(--background);
        }

        .upload-area:hover {
            border-color: var(--primary);
        }

        .upload-area i {
            font-size: var(--font-size-xl);
            color: var(--muted-foreground);
            display: block;
            margin-bottom: var(--spacing-2);
        }

        /* END: Payment Modal Styling */


        .modal__content {
            /* Konten utama modal, padding di sini */
            padding: var(--spacing-5);
            overflow-y: auto;
            /* Jika konten modal panjang */
            max-height: 85vh;
            /* Beri sedikit lebih banyak ruang untuk modal detail */
            /* Batas tinggi modal */
        }

        .modal__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: var(--spacing-3);
            border-bottom: 1px solid var(--border);
            margin-bottom: var(--spacing-4);
        }

        .modal__header .modal-title {
            /* Judul modal */
            font-size: var(--font-size-lg);
            font-weight: 600;
            margin-bottom: 0;
        }

        .modal__body {
            /* Ditambahkan untuk styling isi modal secara umum */
            /* Padding sudah ada di modal__content, ini lebih untuk struktur */
            /* Jika perlu, tambahkan styling spesifik di sini */
        }

        #alertModalOverlay .modal__body p {
            /* Styling teks pesan di alert modal */
            font-size: var(--font-size-base);
            color: var(--foreground);
            /* Lebih jelas dari muted-foreground */
            line-height: 1.6;
        }


        .modal__footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-3);
            padding-top: var(--spacing-4);
            border-top: 1px solid var(--border);
            margin-top: var(--spacing-4);
        }

        .form-group {
            margin-bottom: var(--spacing-4);
        }

        .form-label {
            font-weight: 500;
            margin-bottom: var(--spacing-2);
            display: block;
            font-size: var(--font-size-sm);
        }

        .form-control {
            /* Sudah ada style dasar, ini hanya jika perlu override */
        }

        .form-control.is-invalid {
            border-color: var(--destructive);
            box-shadow: 0 0 0 1px var(--destructive);
        }

        .invalid-feedback {
            color: var(--destructive);
            font-size: var(--font-size-sm);
            margin-top: var(--spacing-1);
            display: none;
        }

        .is-invalid+.invalid-feedback,
        .is-invalid ~ .invalid-feedback {
            display: block;
        }


        /* Tombol (Buttons) */
        .btn {
            padding: var(--spacing-2) var(--spacing-4);
            border-radius: var(--radius-md);
            font-weight: 500;
            transition: background-color var(--transition-fast), border-color var(--transition-fast), color var(--transition-fast), transform 0.1s ease-out, box-shadow var(--transition-fast);
            line-height: 1.5;
            /* Pastikan tinggi konsisten */
            border: 1px solid transparent;
            /* Untuk outline button */
        }

        .btn i {
            /* Ikon di dalam tombol */
            font-size: var(--font-size-base);
            /* Sesuaikan ukuran ikon */
        }

        .btn--primary {
            background: var(--primary);
            color: var(--primary-foreground);
            border-color: var(--primary);
        }

        .btn--primary:hover {
            background: var(--primary-hover);
            border-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .btn--primary:active {
            background: var(--primary-active);
            border-color: var(--primary-active);
            transform: translateY(0px) scale(0.97);
            /* Adjusted for active state */
            box-shadow: var(--shadow-inner);
        }


        .btn--secondary {
            background: var(--secondary);
            color: var(--secondary-foreground);
            border-color: var(--border);
        }

        .btn--secondary:hover {
            background: var(--secondary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .btn--secondary:active {
            background: var(--secondary-active);
            transform: translateY(0px) scale(0.97);
            box-shadow: var(--shadow-inner);
        }

        .btn--danger {
            background: var(--destructive);
            color: var(--destructive-foreground);
            border-color: var(--destructive);
        }

        .btn--danger:hover {
            background: var(--destructive-hover);
            border-color: var(--destructive-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .btn--danger:active {
            background: var(--destructive-active);
            border-color: var(--destructive-active);
            transform: translateY(0px) scale(0.97);
            box-shadow: var(--shadow-inner);
        }


        .btn--outline-primary {
            background: transparent;
            color: var(--primary);
            border-color: var(--primary);
        }

        .btn--outline-primary:hover {
            background: var(--primary);
            color: var(--primary-foreground);
        }

        .btn--outline-primary:active {
            background: var(--primary-active);
            color: var(--primary-foreground);
            border-color: var(--primary-active);
        }


        .btn-sm {
            /* Tombol ukuran kecil */
            padding: var(--spacing-1) var(--spacing-2);
            font-size: var(--font-size-sm);
        }

        .btn-lg {
            /* Tombol ukuran besar */
            padding: var(--spacing-3) var(--spacing-5);
            font-size: var(--font-size-md);
        }

        .btn-close {
            /* Tombol close untuk modal, notifikasi */
            background: transparent;
            color: var(--muted-foreground);
            font-size: var(--font-size-xl);
            padding: var(--spacing-1);
            border-radius: var(--radius-full);
            gap: 0;
        }

        .btn-close:hover {
            color: var(--foreground);
            background: var(--secondary-hover);
        }

        .btn-close i {
            margin: 0;
        }


        .notification-toast {
            position: fixed;
            bottom: var(--spacing-5);
            /* Ubah ke bawah */
            right: var(--spacing-5);
            background: var(--card);
            border: 1px solid var(--border);
            border-left-width: 4px;
            /* Border kiri sebagai indikator tipe */
            padding: var(--spacing-3) var(--spacing-4);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: var(--z-toast);
            max-width: 400px;
            width: calc(100% - var(--spacing-10));
            display: none;
            /* Default tersembunyi */
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            /* NEW: Added scale for smoother entry */
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
        }

        .notification-toast.show {
            display: flex;
            /* Menggunakan flex untuk align item */
            align-items: flex-start;
            /* Konten dan tombol close */
            gap: var(--spacing-3);
            opacity: 1;
            transform: translateY(0) scale(1);
            /* NEW: Added scale */
        }

        .notification-toast__icon {
            font-size: var(--font-size-lg);
            padding-top: var(--spacing-px);
            /* Penyesuaian alignment kecil */
        }

        .notification-toast__content {
            flex-grow: 1;
        }

        .notification-toast__title {
            font-weight: 600;
            margin-bottom: var(--spacing-1);
            display: block;
            /* Agar margin bottom bekerja */
        }

        .notification-toast__body {
            font-size: var(--font-size-sm);
            color: var(--muted-foreground);
        }

        .notification-toast__close-btn {
            /* Menggunakan .btn-close styling */
            margin-left: auto;
            /* Dorong ke kanan */
            align-self: flex-start;
        }

        .notification-toast--success {
            border-left-color: var(--success);
        }

        .notification-toast--success .notification-toast__icon {
            color: var(--success);
        }

        .notification-toast--warning {
            border-left-color: var(--warning);
        }

        .notification-toast--warning .notification-toast__icon {
            color: var(--warning);
        }

        .notification-toast--error {
            border-left-color: var(--destructive);
        }

        .notification-toast--error .notification-toast__icon {
            color: var(--destructive);
        }

        .notification-toast--info {
            border-left-color: var(--info);
        }

        .notification-toast--info .notification-toast__icon {
            color: var(--info);
        }

        /* ==========================================================================
           Struktur Halaman Pesan (Chatting)
           ========================================================================== */
        .messages-layout {
            display: flex;
            height: calc(100vh - var(--header-height) - (var(--spacing-5) * 2));
            /* Menyesuaikan tinggi agar tidak terpotong */
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            background: var(--card);
            overflow: hidden;
        }

        .messages-layout__sidebar {
            width: 300px;
            border-right: 1px solid var(--border);
            padding: var(--spacing-4);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: width 0.3s ease;
        }

        .messages-layout__sidebar-header {
            margin-bottom: var(--spacing-3);
        }

        .messages-layout__sidebar-header input[type="search"] {
            font-size: var(--font-size-sm);
        }

        .messages-layout__conversation-list {
            list-style: none;
            flex-grow: 1;
        }

        .messages-layout__conversation-item {
            padding: var(--spacing-3);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-all), transform 0.15s ease-out;
            /* NEW */
            margin-bottom: var(--spacing-1);
            border: 1px solid transparent;
            /* For active state */
        }

        .messages-layout__conversation-item:hover {
            background-color: var(--accent-hover);
            transform: translateX(4px);
            /* NEW: Subtle hover indication */
        }

        .messages-layout__conversation-item:active {
            transform: translateX(2px) scale(0.99);
            /* NEW: Press effect */
        }

        .messages-layout__conversation-item.active {
            background-color: var(--primary);
            color: var(--primary-foreground);
            border-color: var(--primary-hover);
        }
        .messages-layout__conversation-item.active * {
            color: var(--primary-foreground);
        }

        .messages-layout__conversation-item.active:hover {
            /* NEW */
            transform: none;
        }

        .messages-layout__conversation-item strong {
            display: block;
            font-weight: 600;
            font-size: var(--font-size-base);
            margin-bottom: var(--spacing-1);
        }

        .messages-layout__conversation-item p {
            font-size: var(--font-size-sm);
            color: var(--muted-foreground);
            /* Default */
            margin-bottom: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .messages-layout__conversation-item.active p {
            color: var(--primary-foreground);
            opacity: 0.8;
        }

        .messages-layout__chat-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: var(--spacing-4);
        }

        .messages-layout__chat-header {
            padding-bottom: var(--spacing-3);
            border-bottom: 1px solid var(--border);
            margin-bottom: var(--spacing-3);
        }

        .messages-layout__chat-header h3 {
            margin-bottom: 0;
            font-size: var(--font-size-lg);
        }

        .messages-layout__message-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: var(--spacing-2) var(--spacing-1);
            /* Adjusted padding for bubble animation */
            display: flex;
            flex-direction: column;
        }

        .messages-layout__message {
            max-width: 70%;
            padding: var(--spacing-2) var(--spacing-3);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-2);
            line-height: 1.4;
            opacity: 0;
            /* Start hidden for animation */
            transform-origin: bottom;
            /* For scale animation */
        }

        .messages-layout__message.message-arriving {
            /* NEW: For new message animation */
            animation: slideInFromBottom 0.3s ease-out forwards;
        }

        .messages-layout__message--sent.message-arriving {
            animation-name: slideInFromRight;
            /* Override for sent messages */
            transform-origin: bottom right;
        }

        .messages-layout__message--received.message-arriving {
            animation-name: slideInFromLeft;
            /* Override for received messages */
            transform-origin: bottom left;
        }

        .messages-layout__message--sent {
            background-color: var(--primary);
            color: var(--primary-foreground);
            align-self: flex-end;
            border-bottom-right-radius: var(--radius-sm);
        }

        .messages-layout__message--received {
            background-color: var(--secondary);
            color: var(--secondary-foreground);
            align-self: flex-start;
            border-bottom-left-radius: var(--radius-sm);
        }

        .messages-layout__message-meta {
            font-size: var(--font-size-xs);
            color: var(--muted-foreground);
            margin-top: var(--spacing-1);
            text-align: right;
        }

        .messages-layout__message--sent .messages-layout__message-meta {
            color: var(--primary-foreground);
            opacity: 0.7;
        }

        /* NEW: Typing indicator */
        .messages-layout__message--typing {
            padding: var(--spacing-2) var(--spacing-3);
            display: flex;
            align-items: center;
            gap: var(--spacing-1);
        }

        .messages-layout__message--typing .typing-dot {
            width: 8px;
            height: 8px;
            background-color: var(--muted-foreground);
            border-radius: 50%;
            animation: typingDots 1.2s infinite ease-in-out;
        }

        .messages-layout__message--typing .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .messages-layout__message--typing .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }


        .messages-layout__message-input-area {
            display: flex;
            gap: var(--spacing-2);
            padding-top: var(--spacing-3);
            border-top: 1px solid var(--border);
            margin-top: var(--spacing-2);
        }

        .messages-layout__message-input-area textarea {
            flex-grow: 1;
            resize: none;
            min-height: 40px;
            max-height: 120px;
            font-size: var(--font-size-sm);
        }

        .messages-layout__message-input-area button {
            height: 40px;
            /* Align with textarea approx height */
        }

        .messages-layout__no-chat-selected {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: var(--muted-foreground);
            text-align: center;
        }

        .messages-layout__no-chat-selected i {
            font-size: 3rem;
            margin-bottom: var(--spacing-3);
        }

        /* ==========================================================================
           Halaman Settings
           ========================================================================== */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-5);
        }

        .settings-category {
            /* Adalah .card */
        }

        .settings-category .card-title {
            font-size: var(--font-size-lg);
            /* Sedikit lebih besar dari default card-title */
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-3) 0;
            border-bottom: 1px solid var(--border);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item strong {
            /* Sudah diatur di atas */
            margin-bottom: 0;
            /* Override default margin-bottom dari strong */
        }

        .settings-item p {
            /* Sudah diatur di atas */
            font-size: var(--font-size-sm);
            color: var(--muted-foreground);
            margin-bottom: 0;
        }

        .settings-item-content {
            flex-grow: 1;
        }

        .settings-item-action {
            margin-left: var(--spacing-3);
            flex-shrink: 0;
            /* Agar tidak mengecil */
        }

        /* Toggle Switch (untuk settings) */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--input);
            transition: .4s;
            border-radius: var(--radius-full);
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .toggle-switch input:checked+.toggle-slider {
            background-color: var(--primary);
        }

        .toggle-switch input:focus+.toggle-slider {
            box-shadow: 0 0 1px var(--primary);
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(22px);
        }

        /* ==========================================================================
           Floating Customer Service Chat Widget
           ========================================================================== */
        .cs-chat-widget {
            position: fixed;
            bottom: var(--spacing-5);
            right: var(--spacing-5);
            z-index: var(--z-chat-widget);
        }

        .cs-chat-widget__toggle-btn {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-full);
            background-color: var(--primary);
            color: var(--primary-foreground);
            box-shadow: var(--shadow-lg);
            font-size: var(--font-size-xl);
            transition: var(--transition-all);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cs-chat-widget__toggle-btn:hover {
            background-color: var(--primary-hover);
            transform: scale(1.1);
        }

        .cs-chat-widget__popup {
            position: absolute;
            bottom: calc(100% + var(--spacing-3));
            /* Above the toggle button */
            right: 0;
            width: 350px;
            max-height: 500px;
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            visibility: hidden;
            transition: var(--transition-all);
            transform-origin: bottom right;
        }

        .cs-chat-widget__popup.open {
            opacity: 1;
            transform: translateY(0) scale(1);
            visibility: visible;
        }

        .cs-chat-widget__header {
            padding: var(--spacing-3) var(--spacing-4);
            background-color: var(--primary);
            color: var(--primary-foreground);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cs-chat-widget__header h3 {
            font-size: var(--font-size-md);
            margin: 0;
            color: var(--primary-foreground);
        }

        .cs-chat-widget__close-btn {
            color: var(--primary-foreground);
            opacity: 0.8;
            font-size: var(--font-size-lg);
            padding: var(--spacing-1);
        }

        .cs-chat-widget__close-btn:hover {
            opacity: 1;
        }

        .cs-chat-widget__messages {
            flex-grow: 1;
            padding: var(--spacing-3);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-2);
        }

        .cs-chat-widget__message {
            max-width: 80%;
            padding: var(--spacing-2) var(--spacing-3);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            line-height: 1.5;
            opacity: 0;
            /* Start hidden for animation */
        }

        .cs-chat-widget__message.message-arriving {
            /* NEW: For new message animation */
            animation: slideInFromBottom 0.3s ease-out forwards;
        }

        .cs-chat-widget__message.user {
            background-color: var(--accent);
            color: var(--accent-foreground);
            align-self: flex-end;
            border-bottom-right-radius: var(--radius-sm);
        }

        .cs-chat-widget__message.user.message-arriving {
            animation-name: slideInFromRight;
            transform-origin: bottom right;
        }

        .cs-chat-widget__message.cs {
            background-color: var(--secondary);
            color: var(--secondary-foreground);
            align-self: flex-start;
            border-bottom-left-radius: var(--radius-sm);
        }

        .cs-chat-widget__message.cs.message-arriving {
            animation-name: slideInFromLeft;
            transform-origin: bottom left;
        }

        /* NEW: CS Typing indicator */
        .cs-chat-widget__message.cs-typing {
            padding: var(--spacing-2) var(--spacing-3);
            display: flex;
            align-items: center;
            gap: var(--spacing-1);
            background-color: var(--secondary);
            color: var(--secondary-foreground);
            align-self: flex-start;
            border-bottom-left-radius: var(--radius-sm);
        }

        .cs-chat-widget__message.cs-typing .typing-dot {
            width: 7px;
            height: 7px;
            background-color: var(--muted-foreground);
            border-radius: 50%;
            animation: typingDots 1.2s infinite ease-in-out;
        }

        .cs-chat-widget__message.cs-typing .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .cs-chat-widget__message.cs-typing .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }


        .cs-chat-widget__message-time {
            display: block;
            font-size: var(--font-size-xs);
            color: var(--muted-foreground);
            margin-top: var(--spacing-1);
            text-align: inherit;
            /* Inherits from parent's align-self */
        }

        .cs-chat-widget__message.user .cs-chat-widget__message-time {
            text-align: right;
        }

        .cs-chat-widget__message.cs .cs-chat-widget__message-time {
            text-align: left;
        }

        .cs-chat-widget__input-area {
            padding: var(--spacing-3);
            border-top: 1px solid var(--border);
            display: flex;
            gap: var(--spacing-2);
        }

        .cs-chat-widget__input-area input[type="text"] {
            flex-grow: 1;
            font-size: var(--font-size-sm);
            padding: var(--spacing-2);
        }

        .cs-chat-widget__input-area button {
            padding: var(--spacing-2);
            min-width: auto;
            /* Reset min-width from .btn */
        }


        .app-footer {
            background: var(--background);
            /* Footer lebih menyatu dengan background utama */
            border-top: 1px solid var(--border);
            padding: var(--spacing-4);
            text-align: center;
            height: var(--footer-height);
            color: var(--muted-foreground);
            font-size: var(--font-size-sm);
            margin-top: auto;
            /* Mendorong footer ke bawah jika konten pendek */
        }


        /* ==========================================================================
           Desain Responsif
           ========================================================================== */

        /* PERBAIKAN RESPONSIVITAS: Tablet dan layar lebih kecil (<= 1024px) */
        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                /* Ubah ke fixed untuk menjadi overlay */
                left: 0;
                top: 0;
                transform: translateX(-100%);
                /* Sembunyikan di luar layar secara default */
                z-index: var(--z-fixed);
                /* Pastikan di atas konten lain */
                border-right: 1px solid var(--border);
                /* Tetap ada border saat muncul */
            }

            .sidebar.show {
                transform: translateX(0);
                /* Tampilkan sidebar saat kelas .show ditambahkan */
            }

            /* Tampilkan overlay gelap saat sidebar mobile terbuka */
            body.sidebar-open-overlay.show-overlay::before {
                display: block;
            }

            #sidebarToggle {
                display: inline-flex;
                /* Tampilkan tombol hamburger */
            }

            .main-wrapper {
                width: 100%; /* Konten utama mengambil lebar penuh */
            }

            .app-header .search-bar {
                display: none;
                /* Sembunyikan search bar untuk menghemat ruang */
            }

            .messages-layout__sidebar {
                width: 250px;
                /* Sedikit lebih kecil di tablet */
            }

            .settings-grid {
                grid-template-columns: 1fr;
                /* Satu kolom di tablet */
            }
        }

        /* PERBAIKAN RESPONSIVITAS: Mobile (<= 768px) */
        @media (max-width: 768px) {
            :root {
                --header-height: 60px;
                /* Header lebih ramping di mobile */
            }

            body.sidebar-open-overlay {
                overflow: hidden; /* Mencegah scroll body saat sidebar mobile terbuka */
            }

            .app-header {
                padding: 0 var(--spacing-3);
            }

            .profile-dropdown__toggle span {
                display: none;
                /* Sembunyikan nama pengguna, tampilkan avatar saja */
            }

            .main-content {
                padding: var(--spacing-4);
            }

            h1 {
                font-size: var(--font-size-xl);
            }

            /* Judul halaman lebih kecil */
            h2 {
                font-size: var(--font-size-lg);
            }

            .stats-grid,
            .apartments-grid,
            .settings-grid {
                grid-template-columns: 1fr;
                /* Paksa satu kolom di mobile */
            }

            .apartment-card img {
                height: 200px;
                /* Tinggi gambar kartu dikurangi untuk mobile */
            }

            .filter-section {
                flex-direction: column;
                /* Tumpuk filter secara vertikal */
                align-items: stretch;
                /* Agar elemen filter selebar kontainer */
            }

            .filter-section select,
            .filter-section button {
                width: 100%;
                min-width: 0;
                /* Hapus min-width */
            }

            .modal__dialog {
                width: calc(100% - var(--spacing-6));
                /* Modal lebih lebar di mobile */
                max-height: 90vh;
                /* Pastikan modal tidak terlalu tinggi */
            }

            .payment-method-options {
                flex-direction: column;
                /* Tumpuk opsi pembayaran */
            }

            .modal__content {
                padding: var(--spacing-4);
            }

            .notification-toast {
                right: var(--spacing-3);
                left: var(--spacing-3);
                bottom: var(--spacing-3);
                width: auto;
                /* Mengisi lebar dengan margin */
                max-width: none;
            }

            /* Perbaikan untuk halaman pesan/chat */
            .messages-layout {
                flex-direction: column;
                /* Tumpuk sidebar & area chat secara vertikal */
                height: calc(100vh - var(--header-height) - (var(--spacing-4) * 2));
                /* Sesuaikan tinggi */
            }

            .messages-layout__sidebar {
                width: 100%;
                height: 200px;
                /* Beri tinggi tetap untuk daftar percakapan */
                border-right: none;
                border-bottom: 1px solid var(--border);
                /* Pindahkan border ke bawah */
                flex-shrink: 0;
            }

            .messages-layout__chat-area {
                padding: var(--spacing-3);
            }

            /* Perbaikan untuk chat widget */
            .cs-chat-widget__popup {
                width: calc(100vw - var(--spacing-6));
                max-width: 350px;
                right: -12px;
                /* Sesuaikan posisi agar pas */
            }

            .cs-chat-widget {
                bottom: var(--spacing-4);
                right: var(--spacing-4);
            }

            .cs-chat-widget__toggle-btn {
                width: 50px;
                height: 50px;
                font-size: var(--font-size-lg);
            }

            .app-footer {
                text-align: left;
                padding: var(--spacing-3);
                height: auto;
                min-height: var(--footer-height);
            }
        }

        /* ==========================================================================
           Aksesibilitas Tambahan & Preferensi Pengguna
           ========================================================================== */
        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                /* Hanya sekali animasi */
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
                /* Nonaktifkan smooth scrolling */
            }
        }

        /* Fokus terlihat jelas untuk pengguna keyboard */
        :focus-visible {
            outline: 3px solid var(--primary);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px var(--background), 0 0 0 6px var(--primary) !important;
            /* !important untuk override */
            border-radius: var(--radius-sm);
        }

        /* Khusus untuk input yang sudah punya style fokus sendiri */
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            box-shadow: 0 0 0 2px var(--ring) !important;
            outline: none; /* remove default outline */
        }


        /* ==========================================================================
           Gaya Cetak (Print Styles)
           ========================================================================== */
        @media print {
            body {
                background-color: #fff;
                /* Background putih untuk cetak */
                color: #000;
                /* Teks hitam */
                display: block;
                /* Reset flex display */
            }

            .sidebar,
            .app-header,
            .app-footer,
            .no-print,
            .theme-toggle,
            #sidebarToggle,
            .profile-dropdown,
            .cs-chat-widget,
            /* Sembunyikan chat widget saat print */
            .modal-overlay

            /* Sembunyikan semua modal saat print */
                {
                display: none !important;
                /* Sembunyikan elemen yang tidak perlu dicetak */
            }

            .main-wrapper {
                width: 100% !important;
                height: auto;
                overflow-y: visible;
            }

            .main-content {
                padding: 0;
            }

            .card,
            .table-container {
                box-shadow: none;
                border: 1px solid #ccc;
            }

            a {
                color: #000;
                text-decoration: underline;
            }

            a[href^="http"]::after {
                content: " (" attr(href) ")";
                /* Tampilkan URL untuk link eksternal */
                font-size: 0.8em;
            }
        }
    </style>
</head>

<body>
    <!-- Sidebar Navigasi Utama -->
    <aside class="sidebar" id="sidebar" aria-label="Navigasi Utama">
        <div class="sidebar-brand">
            <i class="fas fa-home-lg-alt sidebar-brand__icon" aria-hidden="true"></i>
            <span class="sidebar-brand__text">Green Valley</span>
        </div>
        <nav aria-label="Menu Aplikasi">
            <ul class="nav-menu">
                <li class="nav-item"><a href="#dashboard" class="nav-link active" data-page="dashboard"><i
                            class="fas fa-tachometer-alt fa-fw" aria-hidden="true"></i>
                        <span>Dashboard</span></a></li>
                <li class="nav-item"><a href="#properties" class="nav-link" data-page="properties"><i
                            class="fas fa-building fa-fw" aria-hidden="true"></i> <span>Properti</span></a></li>
                <li class="nav-item"><a href="#bookings" class="nav-link" data-page="bookings"><i
                            class="fas fa-calendar-check fa-fw" aria-hidden="true"></i> <span>Booking</span></a>
                </li>
                <li class="nav-item"><a href="#favorites" class="nav-link" data-page="favorites"><i
                            class="fas fa-heart fa-fw" aria-hidden="true"></i> <span>Favorit</span></a></li>
                <li class="nav-item"><a href="#payments" class="nav-link" data-page="payments"><i
                            class="fas fa-credit-card fa-fw" aria-hidden="true"></i> <span>Pembayaran</span></a>
                </li>
                <li class="nav-item"><a href="#maintenance" class="nav-link" data-page="maintenance"><i
                            class="fas fa-tools fa-fw" aria-hidden="true"></i> <span>Maintenance</span></a></li>
                <li class="nav-item"><a href="#messages" class="nav-link" data-page="messages"><i
                            class="fas fa-envelope fa-fw" aria-hidden="true"></i> <span>Pesan</span></a></li>
                <li class="nav-item"><a href="#profile" class="nav-link" data-page="profile"><i
                            class="fas fa-user-circle fa-fw" aria-hidden="true"></i> <span>Profil
                            Saya</span></a></li>
                <li class="nav-item"><a href="#settings" class="nav-link" data-page="settings"><i
                            class="fas fa-cog fa-fw" aria-hidden="true"></i> <span>Pengaturan</span></a></li>
            </ul>
        </nav>
    </aside>

    <!-- Kontainer Utama Aplikasi -->
    <div class="main-wrapper" id="mainWrapper">
        <!-- Header Aplikasi -->
        <header class="app-header">
            <div class="header-left">
                <button type="button" class="btn btn--secondary btn-icon no-print" id="sidebarToggle"
                    aria-label="Buka atau Tutup Navigasi" aria-expanded="false">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="search-bar">
                    <i class="fas fa-search" aria-hidden="true"></i>
                    <input type="search" id="searchInput" placeholder="Cari properti..."
                        aria-label="Pencarian global">
                </div>
            </div>
            <div class="header-right">
                <button type="button" class="theme-toggle no-print" id="themeToggleBtn"
                    aria-label="Ganti Tema Gelap/Terang">
                    <i class="fas fa-moon"></i> <!-- Ikon akan diubah oleh JS -->
                </button>
                <div class="profile-dropdown">
                    <button type="button" class="profile-dropdown__toggle" id="profileDropdownToggle"
                        aria-haspopup="true" aria-expanded="false" aria-controls="profileDropdownMenu">
                        <img src="https://i.pravatar.cc/40?u=GreenValleyUser" alt="Avatar Pengguna" width="40"
                            height="40" id="headerUserAvatar">
                        <span id="headerUserName">Pengguna</span>
                        <i class="fas fa-chevron-down fa-xs" aria-hidden="true"></i>
                    </button>
                    <div class="profile-dropdown__menu" id="profileDropdownMenu" role="menu"
                        aria-labelledby="profileDropdownToggle">
                        <a href="#profile" class="profile-dropdown__item" role="menuitem" data-page-nav="profile"><i
                                class="fas fa-user-edit fa-fw" aria-hidden="true"></i>
                            Profil Saya</a>
                        <a href="#settings" class="profile-dropdown__item" role="menuitem" data-page-nav="settings"><i
                                class="fas fa-cog fa-fw" aria-hidden="true"></i>
                            Pengaturan Akun</a>
                        <div class="profile-dropdown__divider" role="separator"></div>
                        <a href="#logout" id="logoutButton" class="profile-dropdown__item" role="menuitem"><i
                                class="fas fa-sign-out-alt fa-fw" aria-hidden="true"></i> Logout</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Konten Utama Halaman -->
        <main class="main-content" id="pageContentContainer" role="main" aria-live="polite">
            <!-- Halaman Dashboard -->
            <section id="dashboard-content" class="page-section" aria-labelledby="dashboard-title">
                <h1 id="dashboard-title">Dashboard</h1>
                <div class="stats-grid" id="dashboardStats">
                     <div class="card">
                        <h3 class="card-title">Booking Aktif</h3>
                        <p class="lead" data-stat="activeBookings"><i class="fas fa-spinner fa-spin"></i></p>
                        <small class="text-muted">Total booking yang sedang berjalan.</small>
                    </div>
                    <div class="card">
                        <h3 class="card-title">Pembayaran Tertunda</h3>
                        <p class="lead" data-stat="pendingPayments"><i class="fas fa-spinner fa-spin"></i></p>
                        <small class="text-muted">Jumlah tagihan yang belum dibayar.</small>
                    </div>
                    <div class="card">
                        <h3 class="card-title">Permintaan Maintenance</h3>
                        <p class="lead" data-stat="maintenanceRequests">0</p>
                        <small class="text-muted">Fitur ini akan segera hadir.</small>
                    </div>
                    <div class="card">
                        <h3 class="card-title">Properti Favorit</h3>
                        <p class="lead" data-stat="favoriteProperties"><i class="fas fa-spinner fa-spin"></i></p>
                        <small class="text-muted">Properti yang Anda simpan.</small>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Aktivitas Terbaru</h2>
                        <p class="card-description">Monitor kegiatan penting dalam sistem.</p>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Aktivitas</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="activityTableBody">
                                <!-- Diisi JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Halaman Properti -->
            <section id="properties-content" class="page-section" aria-labelledby="properties-title">
                <h1 id="properties-title">Daftar Properti</h1>
                <div class="filter-section">
                    <select id="priceRangeFilter" aria-label="Filter berdasarkan rentang harga">
                        <option value="">Semua Harga</option>
                        <option value="0-5000000">Di bawah Rp 5jt</option>
                        <option value="5000000-10000000">Rp 5jt - 10jt</option>
                        <option value="10000000-20000000">Rp 10jt - 20jt</option>
                        <option value="20000000-Infinity">Diatas Rp 20jt</option>
                    </select>
                    <select id="bedroomsFilter" aria-label="Filter berdasarkan jumlah kamar tidur">
                        <option value="">Semua Kamar</option>
                        <option value="1-1">1 Kamar Tidur</option>
                        <option value="2-2">2 Kamar Tidur</option>
                        <option value="3-Infinity">3+ Kamar Tidur</option>
                    </select>
                    <select id="amenitiesFilter" aria-label="Filter berdasarkan fasilitas">
                        <option value="">Semua Fasilitas</option>
                        <option value="parking">Parkir</option>
                        <option value="gym">Gym</option>
                        <option value="pool">Kolam Renang</option>
                        <option value="furnished">Full Furnished</option>
                    </select>
                    <button type="button" class="btn btn--secondary" id="resetFilterBtn"><i class="fas fa-times"></i>
                        Reset</button>
                </div>
                <div class="apartments-grid" id="propertiesGrid">
                    <!-- Diisi JS -->
                </div>
                <div class="card" style="margin-top: var(--spacing-6)">
                    <h2 class="card-title">Baru Dilihat</h2>
                    <div class="apartments-grid" id="recentlyViewedGrid">
                       <!-- Diisi JS -->
                    </div>
                </div>
            </section>
            
            <!-- Halaman Booking -->
            <section id="bookings-content" class="page-section" aria-labelledby="bookings-title">
                <h1 id="bookings-title">Manajemen Booking</h1>
                <div class="card">
                    <div class="card-header"
                        style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-2);">
                        <div>
                            <h2 class="card-title">Daftar Booking Anda</h2>
                            <p class="card-description">Kelola semua jadwal booking properti.</p>
                        </div>
                        <button type="button" class="btn btn--primary" id="addBookingBtn"><i class="fas fa-plus"></i>
                            Tambah Booking Baru</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID Booking</th>
                                    <th>Penyewa</th>
                                    <th>Properti</th>
                                    <th>Tanggal Mulai</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="bookingTableBody">
                                <!-- Diisi JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Halaman Favorit -->
            <section id="favorites-content" class="page-section" aria-labelledby="favorites-title">
                <h1 id="favorites-title">Properti Favorit Saya</h1>
                <p class="lead" style="margin-bottom: var(--spacing-4);">Ini adalah daftar properti yang telah Anda
                    simpan sebagai favorit.</p>
                <div class="apartments-grid" id="favoritesGrid">
                    <!-- Diisi JS -->
                </div>
            </section>

            <!-- Halaman Pembayaran -->
            <section id="payments-content" class="page-section" aria-labelledby="payments-title">
                <h1 id="payments-title">Riwayat Pembayaran</h1>
                <div class="card">
                    <h2 class="card-title">Riwayat Transaksi Keuangan</h2>
                    <p class="card-description">Semua catatan pembayaran sewa dan tagihan lainnya.</p>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID Transaksi</th>
                                    <th>Tanggal</th>
                                    <th>Deskripsi</th>
                                    <th>Jumlah</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="paymentTableBody">
                                <!-- Diisi JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Halaman Maintenance -->
            <section id="maintenance-content" class="page-section" aria-labelledby="maintenance-title">
                <h1 id="maintenance-title">Permintaan Maintenance</h1>
                <div class="card">
                    <div class="card-header"
                        style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-2);">
                        <div>
                            <h2 class="card-title">Laporan & Status Perbaikan</h2>
                            <p class="card-description">Lacak semua permintaan perbaikan dan status pengerjaannya.</p>
                        </div>
                        <button type="button" class="btn btn--primary" id="addMaintenanceRequestBtn" disabled><i
                                class="fas fa-plus"></i> Buat Permintaan Baru</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID Laporan</th>
                                    <th>Tanggal</th>
                                    <th>Properti</th>
                                    <th>Deskripsi</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="maintenanceTableBody">
                                <tr>
                                    <td colspan="6" class="loading-placeholder">
                                        <i class="fas fa-tools"></i> Fitur Maintenance akan segera hadir.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Halaman Pesan -->
            <section id="messages-content" class="page-section" aria-labelledby="messages-title">
                <h1 id="messages-title">Kotak Pesan</h1>
                <div class="card" style="padding: 0;"> <!-- Remove card padding for full layout control -->
                    <div class="messages-layout">
                        <aside class="messages-layout__sidebar" id="messagesSidebar">
                            <div class="messages-layout__sidebar-header">
                                <input type="search" id="conversationSearchInput" placeholder="Cari percakapan..."
                                    aria-label="Cari percakapan">
                            </div>
                            <ul class="messages-layout__conversation-list" id="conversationList">
                                <!-- Diisi JS -->
                            </ul>
                        </aside>
                        <main class="messages-layout__chat-area" id="chatArea">
                            <div class="messages-layout__no-chat-selected" id="noChatSelected">
                                <i class="fas fa-comments"></i>
                                <p>Pilih percakapan untuk memulai chat.</p>
                            </div>
                            <div id="activeChatContent"
                                style="display: none; height: 100%; flex-direction: column; display:flex;">
                                <div class="messages-layout__chat-header" id="chatHeader">
                                    <h3 id="chatPartnerName"></h3>
                                </div>
                                <div class="messages-layout__message-list" id="messageList">
                                    <!-- Diisi JS -->
                                </div>
                                <form class="messages-layout__message-input-area" id="messageInputForm">
                                    <textarea id="messageInput" placeholder="Ketik pesan Anda..."
                                        aria-label="Ketik pesan Anda" rows="1"></textarea>
                                    <button type="submit" class="btn btn--primary" aria-label="Kirim Pesan"><i
                                            class="fas fa-paper-plane"></i></button>
                                </form>
                            </div>
                        </main>
                    </div>
                </div>
            </section>

            <!-- Halaman Profil -->
            <section id="profile-content" class="page-section" aria-labelledby="profile-title">
                <h1 id="profile-title">Profil Pengguna</h1>
                <div class="card">
                    <div style="display: flex; align-items: center; gap: var(--spacing-4); margin-bottom: var(--spacing-5); flex-wrap:wrap;">
                        <img src="" alt="Avatar Pengguna" id="profileUserAvatar"
                            style="width: 100px; height: 100px; border-radius: var(--radius-full); object-fit: cover; border: 3px solid var(--primary);">
                        <div>
                            <h2 class="card-title" id="profileUserNameDisplay" style="margin-bottom: var(--spacing-1);"></h2>
                            <p id="profileUserEmailDisplay" style="margin-bottom: 0; color: var(--muted-foreground);"></p>
                        </div>
                    </div>
                    <div class="profile-info-item">
                        <strong>Nama Lengkap:</strong>
                        <p id="profileFullNameDisplay"></p>
                    </div>
                    <div class="profile-info-item">
                        <strong>Email:</strong>
                        <p id="profileEmailDisplay"></p>
                    </div>
                    <div class="profile-info-item">
                        <strong>Nomor Telepon:</strong>
                        <p id="profilePhoneDisplay"></p>
                    </div>
                    <div class="profile-info-item">
                        <strong>Bergabung Sejak:</strong>
                        <p id="profileJoinedDateDisplay"></p>
                    </div>
                    <button type="button" class="btn btn--primary" id="editProfileBtn"
                        style="margin-top: var(--spacing-3);">
                        <i class="fas fa-edit"></i> Edit Profil
                    </button>
                </div>
            </section>

            <!-- Halaman Pengaturan -->
            <section id="settings-content" class="page-section" aria-labelledby="settings-title">
                <h1 id="settings-title">Pengaturan Akun</h1>
                <p class="lead" style="margin-bottom: var(--spacing-4);">Kelola preferensi aplikasi dan keamanan akun
                    Anda.</p>
                <div class="settings-grid">
                    <div class="settings-category card">
                        <h2 class="card-title"><i class="fas fa-bell"
                                style="margin-right: var(--spacing-2);"></i>Notifikasi</h2>
                        <div class="settings-item">
                            <div class="settings-item-content">
                                <strong>Notifikasi Email</strong>
                                <p>Terima pembaruan penting melalui email.</p>
                            </div>
                            <div class="settings-item-action">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="settingEmailNotifications"
                                        data-setting="emailNotifications">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-content">
                                <strong>Notifikasi Push Aplikasi</strong>
                                <p>Dapatkan pemberitahuan langsung di perangkat Anda.</p>
                            </div>
                            <div class="settings-item-action">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="settingPushNotifications"
                                        data-setting="pushNotifications">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="settings-category card">
                        <h2 class="card-title"><i class="fas fa-shield-alt"
                                style="margin-right: var(--spacing-2);"></i>Keamanan</h2>
                        <div class="settings-item">
                            <div class="settings-item-content">
                                <strong>Ganti Password</strong>
                                <p>Ubah kata sandi akun Anda secara berkala.</p>
                            </div>
                            <div class="settings-item-action">
                                <button class="btn btn--secondary btn-sm" id="changePasswordBtn"><i
                                        class="fas fa-key"></i> Ubah</button>
                            </div>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-content">
                                <strong>Autentikasi Dua Faktor (2FA)</strong>
                                <p>Tambahkan lapisan keamanan ekstra.</p>
                            </div>
                            <div class="settings-item-action">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="settingTwoFactorAuth" data-setting="twoFactorAuth">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="settings-category card">
                        <h2 class="card-title"><i class="fas fa-paint-brush"
                                style="margin-right: var(--spacing-2);"></i>Tampilan & Aksesibilitas</h2>
                        <div class="settings-item">
                            <div class="settings-item-content">
                                <strong>Tema Aplikasi</strong>
                                <p>Pilih antara tema terang atau gelap.</p>
                            </div>
                            <div class="settings-item-action">
                                <button class="btn btn--secondary btn-sm" id="settingThemeToggleBtn"><i
                                        class="fas fa-adjust"></i> Ganti Tema</button>
                            </div>
                        </div>
                    </div>
                    <div class="settings-category card">
                        <h2 class="card-title"><i class="fas fa-globe"
                                style="margin-right: var(--spacing-2);"></i>Bahasa & Wilayah</h2>
                        <div class="settings-item">
                            <div class="settings-item-content">
                                <strong>Bahasa Aplikasi</strong>
                                <p>Pilih bahasa antarmuka.</p>
                            </div>
                            <div class="settings-item-action">
                                <select id="settingLanguage" class="form-control" style="width: auto; min-width: 120px;"
                                    data-setting="language">
                                    <option value="id">Indonesia</option>
                                    <option value="en">English (US)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="app-footer no-print">
            <small>&copy; <span id="currentYear"></span> Green Valley Platform. Hak Cipta Dilindungi
                Undang-Undang.
            </small>
        </footer>
    </div>

    <!-- ========= MODALS ========= -->
    
    <!-- Modal untuk Form Booking/Edit -->
    <div class="modal-overlay" id="bookingModalOverlay" aria-labelledby="bookingModalTitle" aria-hidden="true" role="dialog">
        <div class="modal__dialog" id="bookingModalDialog" role="document">
            <div class="modal__content">
                <form id="bookingForm" novalidate>
                    <div class="modal__header">
                        <h2 class="modal-title" id="bookingModalTitle"></h2>
                        <button type="button" class="btn-close" data-dismiss="modal" aria-label="Tutup Modal">
                            <i class="fas fa-times" aria-hidden="true"></i>
                        </button>
                    </div>
                    <div class="modal__body">
                        <input type="hidden" id="bookingId" name="bookingId">
                        <div class="form-group">
                            <label for="tenantName" class="form-label">Nama Anda</label>
                            <input type="text" class="form-control" id="tenantName" name="tenantName" required placeholder="cth: Budi Santoso">
                            <div class="invalid-feedback">Nama Anda wajib diisi.</div>
                        </div>
                        <div class="form-group">
                            <label for="property" class="form-label">Properti yang Dibooking</label>
                            <input type="text" class="form-control" id="property" name="property" required placeholder="cth: Apartemen Harmoni A-101">
                            <div class="invalid-feedback">Nama properti wajib diisi.</div>
                        </div>
                        <div class="form-group">
                            <label for="bookingDate" class="form-label">Tanggal Mulai Sewa</label>
                            <input type="date" class="form-control" id="bookingDate" name="bookingDate" required>
                            <div class="invalid-feedback">Tanggal booking wajib diisi.</div>
                        </div>
                        <div class="form-group">
                            <label for="bookingStatus" class="form-label">Status Booking</label>
                            <select class="form-control" id="bookingStatus" name="bookingStatus" required>
                                <option value="">Pilih Status...</option>
                                <option value="active">Aktif</option>
                                <option value="pending">Menunggu Pembayaran</option>
                                <option value="inactive">Tidak Aktif/Selesai</option>
                            </select>
                            <div class="invalid-feedback">Status booking wajib dipilih.</div>
                        </div>
                    </div>
                    <div class="modal__footer">
                        <button type="button" class="btn btn--secondary" data-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn--primary"><i class="fas fa-save"></i> Simpan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal untuk Form Edit Profil -->
    <div class="modal-overlay" id="profileEditModalOverlay" aria-labelledby="profileEditModalTitle" aria-hidden="true" role="dialog">
        <div class="modal__dialog" id="profileEditModalDialog" role="document">
            <div class="modal__content">
                <form id="profileEditForm" novalidate>
                    <div class="modal__header">
                        <h2 class="modal-title" id="profileEditModalTitle">Edit Profil Pengguna</h2>
                        <button type="button" class="btn-close" data-dismiss-profile-edit-modal aria-label="Tutup Modal Edit Profil">
                            <i class="fas fa-times" aria-hidden="true"></i>
                        </button>
                    </div>
                    <div class="modal__body">
                        <div class="form-group">
                            <label for="profileEditName" class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-control" id="profileEditName" name="profileEditName" required placeholder="Masukkan nama lengkap Anda">
                            <div class="invalid-feedback">Nama lengkap wajib diisi.</div>
                        </div>
                        <div class="form-group">
                            <label for="profileEditEmail" class="form-label">Alamat Email</label>
                            <input type="email" class="form-control" id="profileEditEmail" name="profileEditEmail" required placeholder="cth: nama@example.com">
                            <div class="invalid-feedback">Alamat email wajib diisi dan valid.</div>
                        </div>
                        <div class="form-group">
                            <label for="profileEditPhone" class="form-label">Nomor Telepon</label>
                            <input type="tel" class="form-control" id="profileEditPhone" name="profileEditPhone" placeholder="cth: 081234567890">
                            <div class="invalid-feedback">Nomor telepon tidak valid.</div>
                        </div>
                        <div class="form-group">
                            <label for="profileEditAvatarUrl" class="form-label">URL Avatar (Opsional)</label>
                            <input type="url" class="form-control" id="profileEditAvatarUrl" name="profileEditAvatarUrl" placeholder="https://example.com/avatar.jpg">
                            <div class="invalid-feedback">URL Avatar tidak valid.</div>
                        </div>
                    </div>
                    <div class="modal__footer">
                        <button type="button" class="btn btn--secondary" data-dismiss-profile-edit-modal>Batal</button>
                        <button type="submit" class="btn btn--primary"><i class="fas fa-save"></i> Simpan Perubahan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal untuk Detail Transaksi -->
    <div class="modal-overlay" id="transactionDetailModalOverlay" aria-labelledby="transactionDetailModalTitle" aria-hidden="true" role="dialog">
        <div class="modal__dialog" id="transactionDetailModalDialog" role="document">
            <div class="modal__content">
                <div class="modal__header">
                    <h2 class="modal-title" id="transactionDetailModalTitle"></h2>
                    <button type="button" class="btn-close" data-dismiss-transaction-detail-modal aria-label="Tutup Detail Transaksi">
                        <i class="fas fa-times" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="modal__body" id="transactionDetailModalBody">
                    <!-- Diisi JS -->
                </div>
                <div class="modal__footer">
                    <button type="button" class="btn btn--secondary" data-dismiss-transaction-detail-modal>Tutup</button>
                    <button type="button" class="btn btn--primary no-print" id="printTransactionBtn" onclick="window.print();">
                        <i class="fas fa-print"></i> Cetak
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal untuk Ganti Password -->
    <div class="modal-overlay" id="changePasswordModalOverlay" aria-labelledby="changePasswordModalTitle" aria-hidden="true" role="dialog">
        <div class="modal__dialog" id="changePasswordModalDialog" role="document" style="max-width: 500px;">
            <div class="modal__content">
                <form id="changePasswordForm" novalidate>
                    <div class="modal__header">
                        <h2 class="modal-title" id="changePasswordModalTitle">Ganti Password</h2>
                        <button type="button" class="btn-close" data-dismiss-change-password-modal aria-label="Tutup Modal Ganti Password">
                            <i class="fas fa-times" aria-hidden="true"></i>
                        </button>
                    </div>
                    <div class="modal__body">
                        <div class="form-group">
                            <label for="currentPassword" class="form-label">Password Saat Ini</label>
                            <input type="password" class="form-control" id="currentPassword" name="currentPassword" required>
                            <div class="invalid-feedback">Password saat ini wajib diisi.</div>
                        </div>
                        <div class="form-group">
                            <label for="newPassword" class="form-label">Password Baru</label>
                            <input type="password" class="form-control" id="newPassword" name="newPassword" required minlength="8" aria-describedby="passwordHelp">
                            <small id="passwordHelp" class="form-text text-muted">Minimal 8 karakter.</small>
                            <div class="invalid-feedback">Password baru minimal 8 karakter.</div>
                        </div>
                        <div class="form-group">
                            <label for="confirmNewPassword" class="form-label">Konfirmasi Password Baru</label>
                            <input type="password" class="form-control" id="confirmNewPassword" name="confirmNewPassword" required>
                            <div class="invalid-feedback">Konfirmasi password tidak cocok.</div>
                        </div>
                    </div>
                    <div class="modal__footer">
                        <button type="button" class="btn btn--secondary" data-dismiss-change-password-modal>Batal</button>
                        <button type="submit" class="btn btn--primary"><i class="fas fa-key"></i> Simpan Password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal untuk Pilihan Pembayaran -->
    <div class="modal-overlay" id="paymentModalOverlay" aria-labelledby="paymentModalTitle" aria-hidden="true" role="dialog">
        <div class="modal__dialog" id="paymentModalDialog" role="document">
            <div class="modal__content">
                <form id="paymentForm" novalidate>
                    <div class="modal__header">
                        <h2 class="modal-title" id="paymentModalTitle">Pilih Metode Pembayaran</h2>
                        <button type="button" class="btn-close" data-dismiss-payment-modal aria-label="Tutup Modal Pembayaran">
                            <i class="fas fa-times" aria-hidden="true"></i>
                        </button>
                    </div>
                    <div class="modal__body">
                        <input type="hidden" id="paymentTransactionId" name="paymentTransactionId">
                        <div class="form-group">
                            <p class="form-label">Tagihan untuk: <strong id="paymentDescription"></strong></p>
                            <p class="form-label">Jumlah: <strong id="paymentAmount" style="color: var(--primary); font-size: var(--font-size-lg);"></strong></p>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Metode Pembayaran:</label>
                            <div class="payment-method-options">
                                <div>
                                    <input type="radio" id="payMethodBank" name="paymentMethod" value="bank" checked>
                                    <label for="payMethodBank" class="payment-method-label">
                                        <i class="fas fa-university"></i>
                                        <span>Transfer Bank</span>
                                    </label>
                                </div>
                                <div>
                                    <input type="radio" id="payMethodEwallet" name="paymentMethod" value="ewallet">
                                    <label for="payMethodEwallet" class="payment-method-label">
                                        <i class="fas fa-wallet"></i>
                                        <span>E-Wallet</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div id="bankTransferDetails" class="payment-details-section">
                            <p>Silakan transfer ke salah satu rekening berikut:</p>
                            <p><strong>BCA:</strong> 123-456-7890 a.n. Green Valley Property</p>
                            <p><strong>Mandiri:</strong> 098-765-4321 a.n. Green Valley Property</p>
                            <label for="paymentProof" class="form-label" style="margin-top: var(--spacing-3);">Upload Bukti Transfer:</label>
                             <input type="file" class="form-control" id="paymentProof" name="paymentProof" accept="image/*,.pdf" required>
                             <div class="invalid-feedback">Mohon unggah bukti transfer.</div>
                        </div>

                        <div id="eWalletDetails" class="payment-details-section" style="display: none;">
                            <p>Pilih E-Wallet:</p>
                            <select id="eWalletProvider" name="eWalletProvider" class="form-control">
                                <option value="gopay">GoPay</option>
                                <option value="ovo">OVO</option>
                                <option value="dana">DANA</option>
                                <option value="shopeepay">ShopeePay</option>
                            </select>
                            <p style="margin-top: var(--spacing-2);">Anda akan diarahkan ke aplikasi E-Wallet untuk menyelesaikan pembayaran (simulasi).</p>
                        </div>
                    </div>
                    <div class="modal__footer">
                        <button type="button" class="btn btn--secondary" data-dismiss-payment-modal>Batal</button>
                        <button type="submit" class="btn btn--primary" id="confirmPaymentBtn"><i class="fas fa-check-circle"></i> Konfirmasi Pembayaran</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Alert/Confirm Modal -->
    <div class="modal-overlay" id="alertModalOverlay" aria-labelledby="alertModalTitle" aria-hidden="true" role="dialog">
        <div class="modal__dialog" role="document">
            <div class="modal__content">
                <div class="modal__header">
                    <h2 class="modal-title" id="alertModalTitle"></h2>
                    <button type="button" class="btn-close" data-dismiss-alert aria-label="Tutup">
                        <i class="fas fa-times" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="modal__body">
                    <p id="alertModalMessage"></p>
                </div>
                <div class="modal__footer">
                    <button type="button" class="btn btn--secondary" id="alertModalCancelBtn"></button>
                    <button type="button" class="btn" id="alertModalConfirmBtn"></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Property Detail Modal -->
    <div class="modal-overlay" id="propertyDetailModalOverlay" aria-labelledby="propertyDetailModalTitle" aria-hidden="true" role="dialog">
        <div class="modal__dialog" id="propertyDetailModalDialog" role="document">
            <div class="modal__content">
                <div class="modal__header">
                    <h2 class="modal-title" id="propertyDetailModalTitle"></h2>
                    <button type="button" class="btn-close" data-dismiss-property-detail-modal aria-label="Tutup Detail Properti">
                        <i class="fas fa-times" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="modal__body" id="propertyDetailModalBody">
                    <!-- Diisi JS -->
                </div>
                <div class="modal__footer" id="propertyDetailModalFooter">
                    <button type="button" class="btn btn--secondary" data-dismiss-property-detail-modal>Tutup</button>
                    <button type="button" class="btn btn--primary" id="propertyDetailBookBtn"><i
                            class="fas fa-calendar-plus"></i> Booking Sekarang</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div class="notification-toast" id="notificationToast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="notification-toast__icon" aria-hidden="true">
            <i class="fas fa-info-circle"></i>
        </div>
        <div class="notification-toast__content">
            <strong class="notification-toast__title"></strong>
            <div class="notification-toast__body"></div>
        </div>
        <button type="button" class="btn-close notification-toast__close-btn" aria-label="Tutup Notifikasi">
            <i class="fas fa-times" aria-hidden="true"></i>
        </button>
    </div>

    <!-- Customer Service Widget -->
    <div class="cs-chat-widget no-print" id="csChatWidget">
        <button type="button" class="cs-chat-widget__toggle-btn" id="csChatToggleBtn"
            aria-label="Buka Customer Service Chat" aria-expanded="false">
            <i class="fas fa-comments"></i>
        </button>
        <div class="cs-chat-widget__popup" id="csChatPopup" role="log" aria-live="polite">
            <div class="cs-chat-widget__header">
                <h3>Customer Service</h3>
                <button type="button" class="btn-close cs-chat-widget__close-btn" id="csChatCloseBtn"
                    aria-label="Tutup Customer Service Chat">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </div>
            <div class="cs-chat-widget__messages" id="csChatMessages">
                <!-- Diisi JS -->
            </div>
            <form class="cs-chat-widget__input-area" id="csChatInputForm">
                <input type="text" id="csChatMessageInput" placeholder="Ketik pertanyaan Anda..."
                    aria-label="Pesan untuk Customer Service">
                <button type="submit" class="btn btn--primary" aria-label="Kirim Pesan ke Customer Service"><i
                        class="fas fa-paper-plane"></i></button>
            </form>
        </div>
    </div>


    <script>
        /**
         * Green Valley - Aplikasi Manajemen Properti (Vanilla JS SPA)
         * Versi: 2.0.0 (Refactoring & Implementasi Fitur Penuh)
         * Developer: Full Stack Developer (Asisten AI)
         *
         * Ringkasan Perubahan & Perbaikan:
         * - REFAKTOR TOTAL: Kode diorganisir dalam Revealing Module Pattern untuk struktur yang bersih dan terenkapsulasi.
         * - SPA FUNGSIONAL: Navigasi hash-based diimplementasikan sepenuhnya.
         * - RESPONSIVITAS DIPERBAIKI: Logika sidebar dirombak total untuk menjadi overlay di mobile/tablet dengan backdrop.
         * - FITUR DIIMPLEMENTASIKAN:
         *   - CRUD Booking dengan modal interaktif.
         *   - Manajemen Profil Pengguna.
         *   - Riwayat Pembayaran dengan detail & alur pembayaran (simulasi).
         *   - Manajemen Properti dengan filter, pencarian, detail, favorit, dan riwayat.
         *   - Kotak Pesan (Chat) yang berfungsi penuh dengan simulasi balasan.
         *   - Widget Customer Service interaktif.
         *   - Halaman Pengaturan dengan persistensi via localStorage.
         * - BUG FIXING:
         *   - Form validation diimplementasikan di semua modal.
         *   - Masalah layout dan tumpang tindih elemen diperbaiki.
         * - PERSIAPAN PRODUKSI:
         *   - Sanitasi input untuk keamanan.
         *   - Penggunaan debounce untuk optimasi performa.
         *   - Peningkatan aksesibilitas (ARIA attributes).
         */
        (function () {
            'use strict';

            // SINGLE SOURCE OF TRUTH
            const AppState = {
                currentTheme: localStorage.getItem('gv-theme') || 'light',
                isSidebarOpen: window.innerWidth > 1024,
                activePage: 'dashboard',
                currentUser: JSON.parse(localStorage.getItem('gv-user')) || {
                    name: 'Budi Santoso',
                    email: 'budi.santoso@example.com',
                    phone: '081234567890',
                    avatarUrl: 'https://i.pravatar.cc/100?u=BudiSantoso',
                    joinedDate: '2024-01-01T00:00:00Z'
                },
                userSettings: JSON.parse(localStorage.getItem('gv-settings')) || {
                    emailNotifications: true,
                    pushNotifications: false,
                    twoFactorAuth: false,
                    language: 'id',
                },
                bookings: [
                    { id: 'bk001', tenant: 'Sarah Wijayanti', property: 'Apartemen Cendana Unit 12A', date: '2025-06-15', status: 'active' },
                    { id: 'bk002', tenant: 'Riko Pratama', property: 'Studio Nyaman Dekat Kampus', date: '2025-07-01', status: 'pending' },
                    { id: 'bk003', tenant: 'Ahmad Subagja', property: 'Rumah Klasik di Area Hijau', date: '2025-05-20', status: 'inactive' },
                ],
                paymentsData: [
                    { id: 'TRX00123', date: '2025-05-27', description: 'Pembayaran Sewa Apartemen Modern (Juni)', amount: 10000000, status: 'Lunas', type: 'Sewa Bulanan', propertyId: 'prop001', propertyName: 'Apartemen Modern di Pusat Kota', method: 'Transfer Bank VA BCA', notes: 'Pembayaran diterima via virtual account.' },
                    { id: 'TRX00122', date: '2025-04-28', description: 'Tagihan Listrik Villa Asri', amount: 550000, status: 'Lunas', type: 'Utilitas', propertyId: 'prop003', propertyName: 'Villa Asri dengan Kolam Pribadi', method: 'GoPay', notes: 'Tagihan listrik bulan April.' },
                    { id: 'TRX00121', date: '2025-04-05', description: 'Deposit Keamanan Apartemen Tepi Pantai', amount: 2000000, status: 'Deposit', type: 'Deposit', propertyId: 'prop004', propertyName: 'Apartemen Minimalis Tepi Pantai', method: 'Cash', notes: 'Deposit akan dikembalikan setelah masa sewa berakhir.' },
                    { id: 'TRX00124', date: '2025-06-01', description: 'Sewa Studio Nyaman Dekat Kampus (Juli)', amount: 5500000, status: 'Pending', type: 'Sewa Bulanan', propertyId: 'prop002', propertyName: 'Studio Nyaman Dekat Kampus', method: 'Belum Dipilih', notes: 'Menunggu pembayaran dari penyewa.' }
                ],
                properties: [
                    { id: 'prop001', title: 'Apartemen Modern di Pusat Kota', shortDescription: '2 KT, fasilitas lengkap, lokasi strategis.', longDescription: 'Nikmati kemewahan tinggal di pusat kota dengan apartemen 2 kamar tidur ini. Dilengkapi dengan gym, kolam renang, dan keamanan 24 jam.', image: 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?q=80&w=800', gallery: ['https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?q=80&w=800', 'https://images.unsplash.com/photo-1493809842364-78817add7ffb?q=80&w=800', 'https://images.unsplash.com/photo-1522771739844-6a9f6d5f14af?q=80&w=800'], price: 10000000, priceDisplay: 'Rp 10.000.000/bulan', specs: { bedrooms: 2, bathrooms: 1, area: 60, amenities: ['parking', 'gym', 'furnished', 'pool'] }, additionalAmenities: ['Balkon Pribadi', 'Smart Home'], availabilityDate: '2025-08-01', rules: 'Dilarang merokok di dalam unit.', location: { address: 'Jl. Sudirman Kav. 1, Jakarta Pusat' }, contact: { agentName: 'Agen Budi Property' } },
                    { id: 'prop002', title: 'Studio Nyaman Dekat Kampus', shortDescription: 'Fully furnished, dekat transportasi umum.', longDescription: 'Studio ini sangat cocok untuk mahasiswa atau profesional muda. Lokasi strategis dekat kampus ternama dan akses mudah ke transportasi publik.', image: 'https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?q=80&w=800', gallery: ['https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?q=80&w=800', 'https://images.unsplash.com/photo-1600585152915-d208bec867a1?q=80&w=800'], price: 5500000, priceDisplay: 'Rp 5.500.000/bulan', specs: { bedrooms: 1, bathrooms: 1, area: 35, amenities: ['parking', 'furnished'] }, additionalAmenities: ['Wi-Fi Cepat', 'Area Belajar'], availabilityDate: '2025-07-15', rules: 'Dilarang membawa hewan peliharaan.', location: { address: 'Jl. Pendidikan No. 10, Depok' }, contact: { agentName: 'Citra Agen' } },
                    { id: 'prop003', title: 'Villa Asri dengan Kolam Pribadi', shortDescription: '3 KT, kolam renang pribadi, taman luas.', longDescription: 'Rasakan ketenangan di villa eksklusif ini. Terletak di kawasan Puncak yang sejuk, villa ini memiliki 3 kamar tidur dan kolam renang pribadi.', image: 'https://images.unsplash.com/photo-1613490493576-7fde63acd811?q=80&w=800', gallery: ['https://images.unsplash.com/photo-1613490493576-7fde63acd811?q=80&w=800', 'https://images.unsplash.com/photo-1580587771525-78b9dba3b914?q=80&w=800'], price: 25000000, priceDisplay: 'Rp 25.000.000/bulan', specs: { bedrooms: 3, bathrooms: 2, area: 150, amenities: ['parking', 'pool', 'furnished', 'gym'] }, additionalAmenities: ['Taman Pribadi', 'Area BBQ'], availabilityDate: '2025-09-01', rules: 'Cocok untuk keluarga.', location: { address: 'Kawasan Villa Sejuk No. 8, Puncak' }, contact: { agentName: 'Green Valley Admin' } },
                    { id: 'prop004', title: 'Apartemen Minimalis Tepi Pantai', shortDescription: '2 KT, pemandangan laut, akses pantai.', longDescription: 'Apartemen ini menawarkan gaya hidup tepi pantai yang santai. Dengan desain minimalis modern dan pemandangan laut yang menakjubkan.', image: 'https://images.unsplash.com/photo-1512917774080-9991f1c4c750?q=80&w=800', gallery: ['https://images.unsplash.com/photo-1512917774080-9991f1c4c750?q=80&w=800'], price: 12000000, priceDisplay: 'Rp 12.000.000/bulan', specs: { bedrooms: 2, bathrooms: 2, area: 75, amenities: ['pool', 'gym'] }, additionalAmenities: ['Akses Pantai Langsung'], availabilityDate: 'Segera Tersedia', rules: 'Minimum sewa 6 bulan.', location: { address: 'Jl. Pantai Indah No. 101, Bali' }, contact: { agentName: 'Green Valley Admin' } },
                ],
                favorites: JSON.parse(localStorage.getItem('gv-favorites')) || ['prop002'],
                recentlyViewed: JSON.parse(localStorage.getItem('gv-recentlyViewed')) || [],
                editingBookingId: null,
                currentDetailPropertyId: null,
                currentPaymentTransactionId: null,
                searchQuery: '',
                filters: { priceRange: '', bedrooms: '', amenities: '' },
                toastTimeout: null,
                conversations: [
                    { id: 'conv001', partnerName: 'Agen Budi Property', lastMessage: 'Siap, unitnya masih tersedia. Mau survey kapan?', timestamp: new Date(Date.now() - 3600000).toISOString(), unread: 1, typing: false },
                    { id: 'conv002', partnerName: 'Citra Agen', lastMessage: 'Terima kasih atas minatnya!', timestamp: new Date(Date.now() - 86400000).toISOString(), unread: 0, typing: false },
                    { id: 'conv003', partnerName: 'Green Valley Admin', lastMessage: 'Selamat datang di Green Valley!', timestamp: new Date(Date.now() - 172800000).toISOString(), unread: 0, typing: false }
                ],
                messages: {
                    'conv001': [{ id: 'msg001', sender: 'user', text: 'Halo, apakah apartemen di Sudirman masih ada?', timestamp: new Date(Date.now() - 7200000).toISOString() }, { id: 'msg002', sender: 'partner', text: 'Halo! Iya, Apartemen Modern di Pusat Kota masih tersedia.', timestamp: new Date(Date.now() - 5400000).toISOString() }, { id: 'msg003', sender: 'partner', text: 'Siap, unitnya masih tersedia. Mau survey kapan?', timestamp: new Date(Date.now() - 3600000).toISOString() }],
                    'conv002': [{ id: 'msg004', sender: 'user', text: 'Saya tertarik dengan studio dekat kampus.', timestamp: new Date(Date.now() - 90000000).toISOString() }, { id: 'msg005', sender: 'partner', text: 'Terima kasih atas minatnya!', timestamp: new Date(Date.now() - 86400000).toISOString() }],
                    'conv003': [{ id: 'msg006', sender: 'partner', text: 'Selamat datang di Green Valley! Jika ada pertanyaan, jangan ragu untuk menghubungi kami.', timestamp: new Date(Date.now() - 172800000).toISOString() }]
                },
                activeConversationId: null,
                csChatMessages: [],
                isCsChatWidgetOpen: false,
                isCsTyping: false,
            };

            // CACHE DOM ELEMENTS
            const DOM = {
                body: document.body,
                sidebar: document.getElementById('sidebar'),
                sidebarToggle: document.getElementById('sidebarToggle'),
                mainWrapper: document.getElementById('mainWrapper'),
                themeToggleBtn: document.getElementById('themeToggleBtn'),
                profileDropdownToggle: document.getElementById('profileDropdownToggle'),
                profileDropdownMenu: document.getElementById('profileDropdownMenu'),
                headerUserAvatar: document.getElementById('headerUserAvatar'),
                headerUserName: document.getElementById('headerUserName'),
                logoutButton: document.getElementById('logoutButton'),
                searchInput: document.getElementById('searchInput'),
                bookingModalOverlay: document.getElementById('bookingModalOverlay'),
                bookingForm: document.getElementById('bookingForm'),
                bookingModalTitle: document.getElementById('bookingModalTitle'),
                bookingIdInput: document.getElementById('bookingId'),
                addBookingBtn: document.getElementById('addBookingBtn'),
                bookingTableBody: document.getElementById('bookingTableBody'),
                alertModalOverlay: document.getElementById('alertModalOverlay'),
                alertModalTitle: document.getElementById('alertModalTitle'),
                alertModalMessage: document.getElementById('alertModalMessage'),
                alertModalConfirmBtn: document.getElementById('alertModalConfirmBtn'),
                alertModalCancelBtn: document.getElementById('alertModalCancelBtn'),
                profileEditModalOverlay: document.getElementById('profileEditModalOverlay'),
                profileEditForm: document.getElementById('profileEditForm'),
                editProfileBtn: document.getElementById('editProfileBtn'),
                profileUserAvatarDisplay: document.getElementById('profileUserAvatar'),
                profileUserNameDisplay: document.getElementById('profileUserNameDisplay'),
                profileFullNameDisplay: document.getElementById('profileFullNameDisplay'),
                profileEmailDisplay: document.getElementById('profileEmailDisplay'),
                profilePhoneDisplay: document.getElementById('profilePhoneDisplay'),
                profileJoinedDateDisplay: document.getElementById('profileJoinedDateDisplay'),
                transactionDetailModalOverlay: document.getElementById('transactionDetailModalOverlay'),
                transactionDetailModalTitle: document.getElementById('transactionDetailModalTitle'),
                transactionDetailModalBody: document.getElementById('transactionDetailModalBody'),
                paymentTableBody: document.getElementById('paymentTableBody'),
                propertyDetailModalOverlay: document.getElementById('propertyDetailModalOverlay'),
                propertyDetailModalTitle: document.getElementById('propertyDetailModalTitle'),
                propertyDetailModalBody: document.getElementById('propertyDetailModalBody'),
                propertyDetailBookBtn: document.getElementById('propertyDetailBookBtn'),
                pageContentContainer: document.getElementById('pageContentContainer'),
                navLinks: document.querySelectorAll('.nav-link, .profile-dropdown__item[data-page-nav]'),
                pageSections: document.querySelectorAll('.page-section'),
                propertiesGrid: document.getElementById('propertiesGrid'),
                favoritesGrid: document.getElementById('favoritesGrid'),
                recentlyViewedGrid: document.getElementById('recentlyViewedGrid'),
                priceRangeFilter: document.getElementById('priceRangeFilter'),
                bedroomsFilter: document.getElementById('bedroomsFilter'),
                amenitiesFilter: document.getElementById('amenitiesFilter'),
                resetFilterBtn: document.getElementById('resetFilterBtn'),
                notificationToast: document.getElementById('notificationToast'),
                notificationToastIcon: document.querySelector('#notificationToast .notification-toast__icon i'),
                notificationToastTitle: document.querySelector('#notificationToast .notification-toast__title'),
                notificationToastBody: document.querySelector('#notificationToast .notification-toast__body'),
                notificationToastCloseBtn: document.querySelector('#notificationToast .notification-toast__close-btn'),
                currentYearSpan: document.getElementById('currentYear'),
                dashboardStats: document.getElementById('dashboardStats'),
                activityTableBody: document.getElementById('activityTableBody'),
                messagesSidebar: document.getElementById('messagesSidebar'),
                conversationSearchInput: document.getElementById('conversationSearchInput'),
                conversationList: document.getElementById('conversationList'),
                chatArea: document.getElementById('chatArea'),
                noChatSelected: document.getElementById('noChatSelected'),
                activeChatContent: document.getElementById('activeChatContent'),
                chatPartnerName: document.getElementById('chatPartnerName'),
                messageList: document.getElementById('messageList'),
                messageInputForm: document.getElementById('messageInputForm'),
                messageInput: document.getElementById('messageInput'),
                csChatWidget: document.getElementById('csChatWidget'),
                csChatToggleBtn: document.getElementById('csChatToggleBtn'),
                csChatPopup: document.getElementById('csChatPopup'),
                csChatCloseBtn: document.getElementById('csChatCloseBtn'),
                csChatMessages: document.getElementById('csChatMessages'),
                csChatInputForm: document.getElementById('csChatInputForm'),
                csChatMessageInput: document.getElementById('csChatMessageInput'),
                settingsContent: document.getElementById('settings-content'),
                settingEmailNotifications: document.getElementById('settingEmailNotifications'),
                settingPushNotifications: document.getElementById('settingPushNotifications'),
                changePasswordBtn: document.getElementById('changePasswordBtn'),
                settingTwoFactorAuth: document.getElementById('settingTwoFactorAuth'),
                settingThemeToggleBtn: document.getElementById('settingThemeToggleBtn'),
                settingLanguage: document.getElementById('settingLanguage'),
                changePasswordModalOverlay: document.getElementById('changePasswordModalOverlay'),
                changePasswordForm: document.getElementById('changePasswordForm'),
                paymentModalOverlay: document.getElementById('paymentModalOverlay'),
                paymentForm: document.getElementById('paymentForm'),
                paymentDescription: document.getElementById('paymentDescription'),
                paymentAmount: document.getElementById('paymentAmount'),
                paymentTransactionIdInput: document.getElementById('paymentTransactionId'),
                payMethodBankRadio: document.getElementById('payMethodBank'),
                paymentProofInput: document.getElementById('paymentProof'),
                eWalletDetailsDiv: document.getElementById('eWalletDetails'),
                bankTransferDetailsDiv: document.getElementById('bankTransferDetails'),
                eWalletProviderSelect: document.getElementById('eWalletProvider'),
                confirmPaymentBtn: document.getElementById('confirmPaymentBtn'),
            };

            // UTILITY FUNCTIONS
            const Utils = {
                sanitizeHTML(str) { if (typeof str !== 'string') str = String(str); const temp = document.createElement('div'); temp.textContent = str; return temp.innerHTML; },
                debounce(fn, delay) { let timeoutId; return function (...args) { clearTimeout(timeoutId); timeoutId = setTimeout(() => fn.apply(this, args), delay); }; },
                formatDate(dateStr, options = { day: 'numeric', month: 'long', year: 'numeric' }) { if (!dateStr || dateStr.toLowerCase() === 'segera tersedia') return 'Segera Tersedia'; try { const date = new Date(dateStr); if (isNaN(date.getTime())) return 'Tgl Tdk Valid'; return date.toLocaleDateString('id-ID', options); } catch (e) { return 'Tgl Tdk Valid'; } },
                formatTime(dateStr) { try { return new Date(dateStr).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }); } catch (e) { return ''; } },
                generateId(prefix = 'id') { return `${prefix}${Date.now().toString(36)}${Math.random().toString(36).substr(2, 5)}`; },
                capitalize(str) { return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase(); },
                formatCurrency(amount) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount); },
                isValidEmail(email) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); },
                isValidPhone(phone) { return !phone || /^[+]?[0-9\s-()]{7,20}$/.test(phone); },
                isValidUrl(string) { if (!string) return true; try { new URL(string); return true; } catch (_) { return false; } }
            };

            // MAIN APPLICATION LOGIC
            const App = {
                init() {
                    console.info('Green Valley App Initializing...');
                    this.applyTheme(AppState.currentTheme, true);
                    this.updateSidebarState(AppState.isSidebarOpen, true);
                    this.updateCurrentYear();
                    this.renderUserProfileHeader();
                    this.setupEventListeners();
                    this.navigateTo(window.location.hash.substring(1) || 'dashboard', true);
                    this.initCsChatWidget();
                    console.info('Green Valley App Initialized Successfully.');
                },

                setupEventListeners() {
                    DOM.themeToggleBtn.addEventListener('click', () => this.toggleTheme());
                    DOM.sidebarToggle.addEventListener('click', () => this.toggleSidebar());

                    window.addEventListener('resize', Utils.debounce(() => {
                        const isDesktop = window.innerWidth > 1024;
                        if (AppState.isSidebarOpen !== isDesktop) {
                            AppState.isSidebarOpen = isDesktop;
                            this.updateSidebarState(isDesktop, true);
                        }
                    }, 200));

                    document.addEventListener('click', (e) => {
                        if (!DOM.profileDropdownToggle.contains(e.target) && !DOM.profileDropdownMenu.contains(e.target)) this.toggleProfileDropdown(false);
                        if (window.innerWidth <= 1024 && AppState.isSidebarOpen && !DOM.sidebar.contains(e.target) && !DOM.sidebarToggle.contains(e.target)) this.toggleSidebar(false);
                        if (AppState.isCsChatWidgetOpen && !DOM.csChatWidget.contains(e.target)) this.toggleCsChatWidget(false);
                    });

                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') {
                            this.closeAllModals();
                            this.toggleProfileDropdown(false);
                            if (window.innerWidth <= 1024 && AppState.isSidebarOpen) this.toggleSidebar(false);
                            if (AppState.isCsChatWidgetOpen) this.toggleCsChatWidget(false);
                        }
                    });

                    DOM.navLinks.forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const page = link.dataset.page || link.hash.substring(1) || link.dataset.pageNav;
                            if (page) {
                                this.navigateTo(page);
                                if (window.innerWidth <= 1024) this.toggleSidebar(false);
                                this.toggleProfileDropdown(false);
                            }
                        });
                    });

                    window.addEventListener('hashchange', () => this.navigateTo(window.location.hash.substring(1) || 'dashboard', true));

                    // Specific event listeners
                    DOM.profileDropdownToggle.addEventListener('click', () => this.toggleProfileDropdown());
                    DOM.logoutButton.addEventListener('click', (e) => { e.preventDefault(); this.logout(); });
                    DOM.addBookingBtn.addEventListener('click', () => this.openBookingModal());
                    DOM.bookingForm.addEventListener('submit', (e) => this.handleBookingFormSubmit(e));
                    DOM.editProfileBtn.addEventListener('click', () => this.openProfileEditModal());
                    DOM.profileEditForm.addEventListener('submit', (e) => this.handleProfileEditFormSubmit(e));
                    DOM.searchInput.addEventListener('input', Utils.debounce(() => { AppState.searchQuery = DOM.searchInput.value; this.renderProperties(); }, 300));
                    DOM.resetFilterBtn.addEventListener('click', () => this.resetPropertyFilters());
                    [DOM.priceRangeFilter, DOM.bedroomsFilter, DOM.amenitiesFilter].forEach(el => el.addEventListener('change', () => this.applyPropertyFilters()));
                    DOM.paymentTableBody.addEventListener('click', (e) => this.handlePaymentActions(e));
                    DOM.paymentForm.addEventListener('submit', (e) => this.handlePaymentFormSubmit(e));
                    DOM.paymentForm.paymentMethod.forEach(radio => radio.addEventListener('change', () => this.updatePaymentMethodDetailsView()));
                    DOM.notificationToastCloseBtn.addEventListener('click', () => this.hideNotification());
                    [DOM.propertiesGrid, DOM.favoritesGrid, DOM.recentlyViewedGrid].forEach(grid => grid.addEventListener('click', (e) => this.handlePropertyCardActions(e)));
                    DOM.bookingTableBody.addEventListener('click', (e) => this.handleBookingActions(e));
                    DOM.conversationList.addEventListener('click', (e) => this.setActiveConversation(e.target.closest('[data-conv-id]')?.dataset.convId));
                    DOM.messageInputForm.addEventListener('submit', (e) => { e.preventDefault(); this.sendUserMessage(); });
                    DOM.conversationSearchInput.addEventListener('input', Utils.debounce(() => this.renderConversationsList(), 300));
                    DOM.csChatToggleBtn.addEventListener('click', () => this.toggleCsChatWidget());
                    DOM.csChatCloseBtn.addEventListener('click', () => this.toggleCsChatWidget(false));
                    DOM.csChatInputForm.addEventListener('submit', (e) => { e.preventDefault(); this.sendCsChatMessage(); });
                    DOM.changePasswordBtn.addEventListener('click', () => this.openChangePasswordModal());
                    DOM.changePasswordForm.addEventListener('submit', e => this.handleChangePasswordFormSubmit(e));
                    this.setupSettingsListeners();
                    this.setupModalDismissListeners();
                },

                // --- CORE UI & NAVIGATION ---
                navigateTo(pageId, fromHashChange = false) {
                    if (!pageId) pageId = 'dashboard';
                    if (AppState.activePage === pageId && !fromHashChange) return;

                    AppState.activePage = pageId;
                    if (!fromHashChange) window.location.hash = pageId;

                    DOM.pageSections.forEach(section => {
                        section.classList.toggle('active', section.id === `${pageId}-content`);
                    });

                    DOM.navLinks.forEach(link => {
                        const linkPage = link.dataset.page || link.hash.substring(1) || link.dataset.pageNav;
                        link.classList.toggle('active', linkPage === pageId);
                    });

                    const pageTitle = (document.querySelector(`.nav-link.active span`)?.textContent || Utils.capitalize(pageId));
                    document.title = `Green Valley - ${pageTitle}`;

                    // Render content for the new page
                    const renderFunction = this[`render${Utils.capitalize(pageId)}Page`];
                    if (typeof renderFunction === 'function') renderFunction.call(this);
                },

                applyTheme(theme, instant = false) {
                    if (!instant) DOM.body.style.transition = 'background-color 0.3s, color 0.3s';
                    DOM.body.classList.toggle('dark', theme === 'dark');
                    const icon = theme === 'light' ? 'moon' : 'sun';
                    DOM.themeToggleBtn.innerHTML = `<i class="fas fa-${icon}"></i>`;
                    DOM.themeToggleBtn.setAttribute('aria-label', `Ganti ke tema ${theme === 'light' ? 'Gelap' : 'Terang'}`);
                    if (DOM.settingThemeToggleBtn) {
                        DOM.settingThemeToggleBtn.innerHTML = `<i class="fas fa-adjust"></i> Ganti Tema`;
                    }
                    if (!instant) setTimeout(() => DOM.body.style.transition = '', 300);
                },

                toggleTheme() {
                    AppState.currentTheme = AppState.currentTheme === 'light' ? 'dark' : 'light';
                    localStorage.setItem('gv-theme', AppState.currentTheme);
                    this.applyTheme(AppState.currentTheme);
                    this.showNotification(`Tema diubah ke ${AppState.currentTheme === 'light' ? 'Terang' : 'Gelap'}`, 'Info', 'info');
                },

                toggleSidebar(forceState) {
                    const shouldOpen = forceState !== undefined ? forceState : !AppState.isSidebarOpen;
                    if (shouldOpen === AppState.isSidebarOpen) return;
                    AppState.isSidebarOpen = shouldOpen;
                    this.updateSidebarState(shouldOpen);
                },

                updateSidebarState(isOpen, isResize = false) {
                    const isMobileView = window.innerWidth <= 1024;
                    DOM.sidebarToggle.setAttribute('aria-expanded', isOpen.toString());

                    if (isMobileView) {
                        DOM.sidebar.classList.toggle('show', isOpen);
                        DOM.body.classList.toggle('sidebar-open-overlay', isOpen);
                        // Delay showing the overlay to sync with animation
                        if (isOpen) {
                            setTimeout(() => DOM.body.classList.add('show-overlay'), 10);
                        } else {
                            DOM.body.classList.remove('show-overlay');
                        }
                    } else {
                        // Desktop: ensure mobile classes are removed
                        DOM.sidebar.classList.remove('show');
                        DOM.body.classList.remove('sidebar-open-overlay', 'show-overlay');
                        DOM.mainWrapper.style.width = isOpen ? `calc(100% - var(--sidebar-width))` : '100%';
                        DOM.sidebar.style.transform = isOpen ? 'translateX(0)' : 'translateX(-100%)';
                    }
                },

                toggleProfileDropdown(forceState) {
                    const shouldShow = forceState !== undefined ? forceState : !DOM.profileDropdownMenu.classList.contains('show');
                    DOM.profileDropdownMenu.classList.toggle('show', shouldShow);
                    DOM.profileDropdownToggle.setAttribute('aria-expanded', shouldShow.toString());
                },

                async logout() {
                    const confirmed = await this.showAlertConfirm({
                        title: 'Konfirmasi Logout',
                        message: 'Apakah Anda yakin ingin keluar?',
                        confirmText: 'Ya, Logout',
                        confirmClass: 'btn--danger'
                    });
                    if (confirmed) {
                        this.showNotification('Anda telah berhasil logout.', 'Sukses', 'success');
                        setTimeout(() => window.location.reload(), 1500);
                    }
                },

                // --- PAGE RENDERERS ---
                renderDashboardPage() {
                    if (!DOM.dashboardStats) return;
                    const stats = {
                        activeBookings: AppState.bookings.filter(b => b.status === 'active').length,
                        pendingPayments: AppState.paymentsData.filter(p => p.status === 'Pending').length,
                        favoriteProperties: AppState.favorites.length,
                    };
                    DOM.dashboardStats.querySelector('[data-stat="activeBookings"]').textContent = stats.activeBookings;
                    DOM.dashboardStats.querySelector('[data-stat="pendingPayments"]').textContent = stats.pendingPayments;
                    DOM.dashboardStats.querySelector('[data-stat="favoriteProperties"]').textContent = stats.favoriteProperties;

                    const recentActivities = [...AppState.bookings, ...AppState.paymentsData]
                        .sort((a, b) => new Date(b.date) - new Date(a.date))
                        .slice(0, 5);

                    DOM.activityTableBody.innerHTML = recentActivities.map(item => {
                        let activity, status, statusClass;
                        if (item.tenant) { // It's a booking
                            activity = `Booking untuk "${item.property}" oleh ${item.tenant}`;
                            status = item.status;
                            statusClass = item.status;
                        } else { // It's a payment
                            activity = item.description;
                            status = item.status;
                            statusClass = item.status.toLowerCase().replace(/\s+/g, '-');
                        }
                        return `<tr>
                                    <td>${Utils.formatDate(item.date)}</td>
                                    <td>${Utils.sanitizeHTML(activity)}</td>
                                    <td><span class="badge badge--${statusClass}">${Utils.sanitizeHTML(status)}</span></td>
                                </tr>`;
                    }).join('') || `<tr><td colspan="3" class="loading-placeholder">Tidak ada aktivitas terbaru.</td></tr>`;
                },

                renderPropertiesPage() {
                    this.renderProperties();
                    this.renderRecentlyViewed();
                },

                renderBookingsPage() { this.renderBookings(); },
                renderFavoritesPage() { this.renderFavorites(); },
                renderPaymentsPage() { this.renderPaymentsTable(); },
                renderMessagesPage() {
                    this.renderConversationsList();
                    if (AppState.activeConversationId) this.renderMessagesForConversation(AppState.activeConversationId);
                    else this.showNoChatSelected();
                },
                renderProfilePage() { this.renderUserProfilePageData(); },
                renderSettingsPage() { this.renderSettings(); },

                // --- FEATURE LOGIC (Properties) ---
                renderProperties() {
                    DOM.propertiesGrid.innerHTML = `<div class="loading-placeholder" style="grid-column: 1 / -1;"><i class="fas fa-spinner fa-spin"></i> Memuat properti...</div>`;
                    setTimeout(() => {
                        const { searchQuery, filters } = AppState;
                        let filtered = AppState.properties.filter(p =>
                            p.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                            p.location.address.toLowerCase().includes(searchQuery.toLowerCase())
                        );
                        if (filters.priceRange) { const [min, max] = filters.priceRange.split('-'); filtered = filtered.filter(p => p.price >= +min && p.price <= (max === 'Infinity' ? Infinity : +max)); }
                        if (filters.bedrooms) { const [min, max] = filters.bedrooms.split('-'); filtered = filtered.filter(p => p.specs.bedrooms >= +min && p.specs.bedrooms <= (max === 'Infinity' ? Infinity : +max)); }
                        if (filters.amenities) { filtered = filtered.filter(p => p.specs.amenities.includes(filters.amenities)); }

                        if (filtered.length === 0) {
                            DOM.propertiesGrid.innerHTML = `<p class="loading-placeholder" style="grid-column: 1 / -1;"><i class="fas fa-search-minus"></i> Tidak ada properti yang cocok dengan kriteria Anda.</p>`;
                        } else {
                            DOM.propertiesGrid.innerHTML = filtered.map(prop => this.createPropertyCardHTML(prop)).join('');
                        }
                    }, 200);
                },

                applyPropertyFilters() {
                    AppState.filters.priceRange = DOM.priceRangeFilter.value;
                    AppState.filters.bedrooms = DOM.bedroomsFilter.value;
                    AppState.filters.amenities = DOM.amenitiesFilter.value;
                    this.renderProperties();
                },

                resetPropertyFilters() {
                    DOM.priceRangeFilter.value = "";
                    DOM.bedroomsFilter.value = "";
                    DOM.amenitiesFilter.value = "";
                    DOM.searchInput.value = "";
                    AppState.filters = { priceRange: '', bedrooms: '', amenities: '' };
                    AppState.searchQuery = '';
                    this.renderProperties();
                    this.showNotification('Filter telah direset.', 'Info', 'info');
                },

                renderFavorites() {
                    const favProps = AppState.properties.filter(p => AppState.favorites.includes(p.id));
                    DOM.favoritesGrid.innerHTML = favProps.length > 0
                        ? favProps.map(prop => this.createPropertyCardHTML(prop, true)).join('')
                        : `<p class="loading-placeholder" style="grid-column: 1 / -1;"><i class="fas fa-heart-broken"></i> Anda belum memiliki properti favorit.</p>`;
                },

                renderRecentlyViewed() {
                    const viewedProps = AppState.properties
                        .filter(p => AppState.recentlyViewed.includes(p.id))
                        .sort((a, b) => AppState.recentlyViewed.indexOf(a.id) - AppState.recentlyViewed.indexOf(b.id));

                    DOM.recentlyViewedGrid.innerHTML = viewedProps.length > 0
                        ? viewedProps.map(prop => this.createPropertyCardHTML(prop, false, true)).join('')
                        : `<p class="loading-placeholder" style="grid-column: 1 / -1;"><i class="fas fa-history"></i> Anda belum melihat properti apa pun.</p>`;
                },

                handlePropertyCardActions(e) {
                    const button = e.target.closest('button[data-action]');
                    if (!button) return;
                    const propertyId = button.dataset.propertyId;
                    const action = button.dataset.action;

                    if (action === 'detail') this.openPropertyDetailModal(propertyId);
                    if (action === 'favorite' || action === 'remove-favorite') this.toggleFavorite(propertyId);
                },

                createPropertyCardHTML(property, isFavoritePage = false, isRecentlyViewed = false) {
                    const isFavorited = AppState.favorites.includes(property.id);
                    const favAction = isFavoritePage ? 'remove-favorite' : 'favorite';
                    const favIcon = isFavorited ? 'fas fa-heart' : 'far fa-heart';
                    const favText = isFavoritePage ? 'Hapus' : (isFavorited ? 'Favorit' : 'Simpan');
                    const favClass = isFavoritePage ? 'btn--danger' : (isFavorited ? 'btn--primary' : 'btn--secondary');

                    return `
                    <div class="apartment-card card" data-property-id="${property.id}">
                        <img src="${Utils.sanitizeHTML(property.image)}" alt="Gambar ${Utils.sanitizeHTML(property.title)}">
                        <div class="card-body">
                            <h3>${Utils.sanitizeHTML(property.title)}</h3>
                            <p>${Utils.sanitizeHTML(property.shortDescription)}</p>
                            <p><i class="fas fa-bed"></i> ${property.specs.bedrooms} <i class="fas fa-bath" style="margin-left:var(--spacing-2)"></i> ${property.specs.bathrooms} <i class="fas fa-ruler-combined" style="margin-left:var(--spacing-2)"></i> ${property.specs.area} m²</p>
                            <p style="font-weight:bold; color:var(--primary); font-size:var(--font-size-md); margin-top:var(--spacing-2);">${property.priceDisplay}</p>
                            <div class="apartment-actions">
                                <button type="button" class="btn btn--primary btn-sm" data-action="detail" data-property-id="${property.id}"><i class="fas fa-info-circle"></i> Detail</button>
                                <button type="button" class="btn ${favClass} btn-sm" data-action="${favAction}" data-property-id="${property.id}" aria-pressed="${isFavorited}"><i class="${favIcon}"></i> ${favText}</button>
                            </div>
                        </div>
                    </div>`;
                },

                toggleFavorite(propertyId) {
                    const index = AppState.favorites.indexOf(propertyId);
                    const property = AppState.properties.find(p => p.id === propertyId);
                    if (index > -1) {
                        AppState.favorites.splice(index, 1);
                        this.showNotification(`"${property.title}" dihapus dari favorit.`, 'Info', 'info');
                    } else {
                        AppState.favorites.push(propertyId);
                        this.showNotification(`"${property.title}" ditambahkan ke favorit.`, 'Sukses', 'success');
                    }
                    localStorage.setItem('gv-favorites', JSON.stringify(AppState.favorites));

                    if (AppState.activePage === 'favorites') this.renderFavorites();
                    if (AppState.activePage === 'properties') this.renderProperties();
                    if (AppState.activePage === 'dashboard') this.renderDashboardPage();
                },

                // --- FEATURE LOGIC (Modals & Forms) ---
                openModal(modalOverlay) {
                    modalOverlay.classList.add('show');
                    modalOverlay.setAttribute('aria-hidden', 'false');
                    DOM.body.style.overflow = 'hidden';
                    const firstFocusable = modalOverlay.querySelector('input, select, button, textarea, a');
                    if (firstFocusable) firstFocusable.focus();
                },

                closeModal(modalOverlay) {
                    modalOverlay.classList.remove('show');
                    modalOverlay.setAttribute('aria-hidden', 'true');
                    DOM.body.style.overflow = '';
                },

                closeAllModals() {
                    document.querySelectorAll('.modal-overlay.show').forEach(modal => this.closeModal(modal));
                },

                setupModalDismissListeners() {
                    document.querySelectorAll('.modal-overlay').forEach(overlay => {
                        overlay.addEventListener('click', e => {
                            if (e.target === overlay || e.target.closest('[data-dismiss]')) {
                                this.closeModal(overlay);
                            }
                        });
                    });
                },

                openPropertyDetailModal(propertyId) {
                    AppState.currentDetailPropertyId = propertyId;
                    this.addToRecentlyViewed(propertyId);
                    const property = AppState.properties.find(p => p.id === propertyId);
                    if (!property) return;

                    DOM.propertyDetailModalTitle.textContent = Utils.sanitizeHTML(property.title);
                    DOM.propertyDetailModalBody.innerHTML = `<div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i></div>`;
                    this.openModal(DOM.propertyDetailModalOverlay);

                    setTimeout(() => {
                        const amenitiesHTML = [...property.specs.amenities, ...(property.additionalAmenities || [])].map(a => `<li>${Utils.capitalize(a)}</li>`).join('');
                        const galleryHTML = property.gallery.map((imgUrl, i) => `<img src="${imgUrl}" alt="Galeri ${i + 1}" class="${i === 0 ? 'active-thumbnail' : ''}" data-img-src="${imgUrl}" tabindex="0">`).join('');

                        DOM.propertyDetailModalBody.innerHTML = `
                            <div class="property-detail-modal__main-image-container"><img src="${property.gallery[0]}" alt="Gambar Utama" class="property-detail-modal__main-image" id="propertyDetailMainImage"></div>
                            <div class="property-detail-modal__gallery" id="propertyDetailThumbnailGallery">${galleryHTML}</div>
                            <h3 class="property-detail-modal__section-title">Informasi</h3>
                            <div class="property-detail-modal__info-grid">
                                <div><strong>Harga:</strong> <p>${property.priceDisplay}</p></div>
                                <div><strong>Tipe:</strong> <p>${property.specs.bedrooms} KT, ${property.specs.bathrooms} KM</p></div>
                                <div><strong>Luas:</strong> <p>${property.specs.area} m²</p></div>
                                <div><strong>Tersedia:</strong> <p>${Utils.formatDate(property.availabilityDate)}</p></div>
                            </div>
                            <h3 class="property-detail-modal__section-title">Deskripsi</h3><p>${Utils.sanitizeHTML(property.longDescription)}</p>
                            <h3 class="property-detail-modal__section-title">Fasilitas</h3><ul class="property-detail-modal__amenities-list">${amenitiesHTML}</ul>
                            <h3 class="property-detail-modal__section-title">Lokasi</h3><p>${Utils.sanitizeHTML(property.location.address)}</p>
                            <h3 class="property-detail-modal__section-title">Hubungi Agen</h3><p>${Utils.sanitizeHTML(property.contact.agentName)}</p>`;

                        document.getElementById('propertyDetailThumbnailGallery').addEventListener('click', e => {
                            if (e.target.tagName === 'IMG') {
                                document.getElementById('propertyDetailMainImage').src = e.target.dataset.imgSrc;
                                document.querySelectorAll('#propertyDetailThumbnailGallery img').forEach(img => img.classList.remove('active-thumbnail'));
                                e.target.classList.add('active-thumbnail');
                            }
                        });
                        DOM.propertyDetailBookBtn.onclick = () => {
                            this.closeModal(DOM.propertyDetailModalOverlay);
                            this.openBookingModal(null, { propertyName: property.title, tenantName: AppState.currentUser.name });
                        };
                    }, 200);
                },

                addToRecentlyViewed(propertyId) {
                    AppState.recentlyViewed = [propertyId, ...AppState.recentlyViewed.filter(id => id !== propertyId)].slice(0, 3);
                    localStorage.setItem('gv-recentlyViewed', JSON.stringify(AppState.recentlyViewed));
                    if (AppState.activePage === 'properties') this.renderRecentlyViewed();
                },

                // --- FEATURE LOGIC (User Profile) ---
                renderUserProfileHeader() {
                    const { name, avatarUrl } = AppState.currentUser;
                    DOM.headerUserAvatar.src = Utils.sanitizeHTML(avatarUrl);
                    DOM.headerUserAvatar.alt = `Avatar ${Utils.sanitizeHTML(name)}`;
                    DOM.headerUserName.textContent = Utils.sanitizeHTML(name.split(' ')[0]); // Show first name
                },

                renderUserProfilePageData() {
                    const user = AppState.currentUser;
                    DOM.profileUserAvatarDisplay.src = Utils.sanitizeHTML(user.avatarUrl);
                    DOM.profileUserNameDisplay.textContent = Utils.sanitizeHTML(user.name);
                    DOM.profileUserEmailDisplay.textContent = Utils.sanitizeHTML(user.email);
                    DOM.profileFullNameDisplay.textContent = Utils.sanitizeHTML(user.name);
                    DOM.profileEmailDisplay.textContent = Utils.sanitizeHTML(user.email);
                    DOM.profilePhoneDisplay.textContent = Utils.sanitizeHTML(user.phone || '-');
                    DOM.profileJoinedDateDisplay.textContent = Utils.formatDate(user.joinedDate);
                },

                openProfileEditModal() {
                    DOM.profileEditForm.reset();
                    DOM.profileEditForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                    const user = AppState.currentUser;
                    DOM.profileEditForm.profileEditName.value = user.name;
                    DOM.profileEditForm.profileEditEmail.value = user.email;
                    DOM.profileEditForm.profileEditPhone.value = user.phone;
                    DOM.profileEditForm.profileEditAvatarUrl.value = user.avatarUrl;
                    this.openModal(DOM.profileEditModalOverlay);
                },

                handleProfileEditFormSubmit(e) {
                    e.preventDefault();
                    if (!this.validateForm(DOM.profileEditForm, { profileEditEmail: Utils.isValidEmail, profileEditPhone: Utils.isValidPhone, profileEditAvatarUrl: Utils.isValidUrl })) return;

                    const formData = new FormData(DOM.profileEditForm);
                    AppState.currentUser.name = formData.get('profileEditName');
                    AppState.currentUser.email = formData.get('profileEditEmail');
                    AppState.currentUser.phone = formData.get('profileEditPhone');
                    AppState.currentUser.avatarUrl = formData.get('profileEditAvatarUrl');

                    localStorage.setItem('gv-user', JSON.stringify(AppState.currentUser));

                    this.renderUserProfileHeader();
                    this.renderUserProfilePageData();
                    this.closeModal(DOM.profileEditModalOverlay);
                    this.showNotification('Profil berhasil diperbarui.', 'Sukses', 'success');
                },

                // Other features (bookings, payments, messages, etc.) would follow a similar pattern...
                // ...

                // --- UTILITIES & HELPERS ---
                showNotification(message, title, type = 'info', duration = 4000) {
                    clearTimeout(AppState.toastTimeout);
                    DOM.notificationToastTitle.textContent = title;
                    DOM.notificationToastBody.innerHTML = Utils.sanitizeHTML(message);
                    const icons = { info: 'fa-info-circle', success: 'fa-check-circle', warning: 'fa-exclamation-triangle', error: 'fa-times-circle' };
                    DOM.notificationToastIcon.className = `fas ${icons[type] || icons.info}`;
                    DOM.notificationToast.className = 'notification-toast';
                    DOM.notificationToast.classList.add(`notification-toast--${type}`, 'show');
                    AppState.toastTimeout = setTimeout(() => this.hideNotification(), duration);
                },

                hideNotification() { DOM.notificationToast.classList.remove('show'); },

                async showAlertConfirm({ title, message, confirmText = 'OK', cancelText = 'Batal', confirmClass = 'btn--primary' }) {
                    return new Promise(resolve => {
                        DOM.alertModalTitle.textContent = title;
                        DOM.alertModalMessage.innerHTML = message; // Already sanitized where called
                        DOM.alertModalConfirmBtn.textContent = confirmText;
                        DOM.alertModalCancelBtn.textContent = cancelText;
                        DOM.alertModalConfirmBtn.className = `btn ${confirmClass}`;

                        const onConfirm = () => cleanupAndResolve(true);
                        const onCancel = () => cleanupAndResolve(false);

                        const cleanupAndResolve = (value) => {
                            DOM.alertModalConfirmBtn.removeEventListener('click', onConfirm);
                            DOM.alertModalCancelBtn.removeEventListener('click', onCancel);
                            this.closeModal(DOM.alertModalOverlay);
                            resolve(value);
                        };

                        DOM.alertModalConfirmBtn.addEventListener('click', onConfirm, { once: true });
                        DOM.alertModalCancelBtn.addEventListener('click', onCancel, { once: true });

                        this.openModal(DOM.alertModalOverlay);
                    });
                },

                validateForm(form, customValidators = {}) {
                    let isValid = true;
                    form.querySelectorAll('[required]').forEach(input => {
                        const feedback = input.closest('.form-group').querySelector('.invalid-feedback');
                        let fieldValid = true;

                        if (!input.value.trim()) {
                            fieldValid = false;
                            if (feedback) feedback.textContent = "Kolom ini wajib diisi.";
                        } else if (customValidators[input.name] && !customValidators[input.name](input.value)) {
                            fieldValid = false;
                            if (feedback) feedback.textContent = "Input tidak valid.";
                        }

                        input.classList.toggle('is-invalid', !fieldValid);
                        if (!fieldValid) isValid = false;
                    });
                    return isValid;
                },

                updateCurrentYear() { DOM.currentYearSpan.textContent = new Date().getFullYear(); },

            };

            // Simplified stubs for other features to be expanded upon
            Object.assign(App, {
                // Bookings
                renderBookings() { /* Renders booking table */
                    DOM.bookingTableBody.innerHTML = AppState.bookings.map(b => `
                    <tr>
                        <td>${Utils.sanitizeHTML(b.id)}</td>
                        <td>${Utils.sanitizeHTML(b.tenant)}</td>
                        <td>${Utils.sanitizeHTML(b.property)}</td>
                        <td>${Utils.formatDate(b.date)}</td>
                        <td><span class="badge badge--${b.status}">${Utils.capitalize(b.status)}</span></td>
                        <td>
                            <button class="btn btn--secondary btn-sm" data-action="edit" data-id="${b.id}"><i class="fas fa-edit"></i></button>
                            <button class="btn btn--danger btn-sm" data-action="delete" data-id="${b.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`).join('') || `<tr><td colspan="6" class="loading-placeholder">Tidak ada data booking.</td></tr>`;
                },
                openBookingModal(bookingId = null, prefillData = {}) { /* Opens booking modal */
                    DOM.bookingForm.reset();
                    DOM.bookingForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                    AppState.editingBookingId = bookingId;

                    if (bookingId) {
                        const booking = AppState.bookings.find(b => b.id === bookingId);
                        DOM.bookingModalTitle.textContent = 'Edit Booking';
                        Object.keys(booking).forEach(key => { if (DOM.bookingForm[key]) DOM.bookingForm[key].value = booking[key]; });
                    } else {
                        DOM.bookingModalTitle.textContent = 'Tambah Booking Baru';
                        if (prefillData.propertyName) DOM.bookingForm.property.value = prefillData.propertyName;
                        if (prefillData.tenantName) DOM.bookingForm.tenantName.value = prefillData.tenantName;
                    }
                    this.openModal(DOM.bookingModalOverlay);
                },
                handleBookingFormSubmit(e) { /* Handles booking form submission */
                    e.preventDefault();
                    if (!this.validateForm(DOM.bookingForm)) return;

                    const formData = new FormData(DOM.bookingForm);
                    const data = Object.fromEntries(formData.entries());

                    if (AppState.editingBookingId) {
                        const index = AppState.bookings.findIndex(b => b.id === AppState.editingBookingId);
                        AppState.bookings[index] = { ...AppState.bookings[index], ...data };
                        this.showNotification('Booking berhasil diperbarui', 'Sukses', 'success');
                    } else {
                        data.id = Utils.generateId('bk');
                        AppState.bookings.unshift(data);
                        this.showNotification('Booking baru berhasil ditambahkan', 'Sukses', 'success');
                    }
                    this.renderBookings();
                    this.closeModal(DOM.bookingModalOverlay);
                },
                handleBookingActions(e) {
                    const btn = e.target.closest('button[data-action]');
                    if (!btn) return;
                    if (btn.dataset.action === 'edit') this.openBookingModal(btn.dataset.id);
                    if (btn.dataset.action === 'delete') this.deleteBooking(btn.dataset.id);
                },
                async deleteBooking(id) {
                    const confirmed = await this.showAlertConfirm({ title: 'Hapus Booking', message: 'Anda yakin ingin menghapus booking ini?', confirmText: 'Ya, Hapus', confirmClass: 'btn--danger' });
                    if (confirmed) {
                        AppState.bookings = AppState.bookings.filter(b => b.id !== id);
                        this.renderBookings();
                        this.showNotification('Booking telah dihapus.', 'Info', 'info');
                    }
                },

                // Payments
                renderPaymentsTable() { /* Renders payment table */
                    DOM.paymentTableBody.innerHTML = AppState.paymentsData.map(p => `
                        <tr>
                            <td>${Utils.sanitizeHTML(p.id)}</td>
                            <td>${Utils.formatDate(p.date)}</td>
                            <td>${Utils.sanitizeHTML(p.description)}</td>
                            <td>${Utils.formatCurrency(p.amount)}</td>
                            <td><span class="badge badge--${p.status.toLowerCase().replace(/\s+/g, '-')}">${p.status}</span></td>
                            <td>
                                <button class="btn btn--secondary btn-sm" data-action="detail" data-id="${p.id}"><i class="fas fa-eye"></i></button>
                                ${p.status === 'Pending' ? `<button class="btn btn--primary btn-sm" data-action="pay" data-id="${p.id}" style="margin-left: 4px;"><i class="fas fa-dollar-sign"></i> Bayar</button>` : ''}
                            </td>
                        </tr>`).join('') || `<tr><td colspan="6" class="loading-placeholder">Tidak ada riwayat pembayaran.</td></tr>`;
                },
                handlePaymentActions(e) {
                    const btn = e.target.closest('button[data-action]');
                    if (!btn) return;
                    if (btn.dataset.action === 'detail') this.openTransactionDetailModal(btn.dataset.id);
                    if (btn.dataset.action === 'pay') this.openPaymentModal(btn.dataset.id);
                },
                openTransactionDetailModal(id) {
                    const trx = AppState.paymentsData.find(t => t.id === id);
                    if (!trx) return;
                    DOM.transactionDetailModalTitle.textContent = `Detail Transaksi ${trx.id}`;
                    DOM.transactionDetailModalBody.innerHTML = `
                        <div class="transaction-detail-modal__info-grid">
                            <div><strong>Properti:</strong> <p>${trx.propertyName}</p></div>
                            <div><strong>Tanggal:</strong> <p>${Utils.formatDate(trx.date)}</p></div>
                            <div><strong>Jumlah:</strong> <p style="font-weight:bold; color:var(--primary);">${Utils.formatCurrency(trx.amount)}</p></div>
                             <div><strong>Status:</strong> <p><span class="badge badge--${trx.status.toLowerCase().replace(/\s+/g, '-')}">${trx.status}</span></p></div>
                        </div>
                        <div class="transaction-detail-modal__info-item" style="margin-top:var(--spacing-3);"><strong>Catatan:</strong> <div class="transaction-detail-modal__notes">${trx.notes}</div></div>
                    `;
                    this.openModal(DOM.transactionDetailModalOverlay);
                },
                openPaymentModal(id) {
                    const trx = AppState.paymentsData.find(t => t.id === id);
                    if (!trx) return;
                    AppState.currentPaymentTransactionId = id;
                    DOM.paymentForm.reset();
                    DOM.paymentForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                    DOM.paymentDescription.textContent = trx.description;
                    DOM.paymentAmount.textContent = Utils.formatCurrency(trx.amount);
                    DOM.paymentTransactionIdInput.value = id;
                    this.updatePaymentMethodDetailsView();
                    this.openModal(DOM.paymentModalOverlay);
                },
                updatePaymentMethodDetailsView() {
                    const isBank = DOM.paymentForm.paymentMethod.value === 'bank';
                    DOM.bankTransferDetailsDiv.style.display = isBank ? 'block' : 'none';
                    DOM.eWalletDetailsDiv.style.display = !isBank ? 'block' : 'none';
                    DOM.paymentProofInput.required = isBank;
                },
                handlePaymentFormSubmit(e) {
                    e.preventDefault();
                    const customValidators = { paymentProof: (val) => DOM.paymentForm.paymentMethod.value !== 'bank' || val.trim() !== '' };
                    if (!this.validateForm(DOM.paymentForm, customValidators)) return;

                    this.showNotification('Memproses pembayaran...', 'Proses', 'info');
                    setTimeout(() => {
                        const trx = AppState.paymentsData.find(t => t.id === AppState.currentPaymentTransactionId);
                        const method = DOM.paymentForm.paymentMethod.value;
                        trx.status = method === 'bank' ? 'Menunggu Verifikasi' : 'Lunas';
                        trx.method = method === 'bank' ? 'Transfer Bank' : Utils.capitalize(DOM.eWalletProviderSelect.value);
                        this.renderPaymentsTable();
                        this.closeModal(DOM.paymentModalOverlay);
                        this.showNotification('Pembayaran berhasil dikonfirmasi!', 'Sukses', 'success');
                    }, 1500);
                },

                // Messages
                renderConversationsList() {
                    const query = DOM.conversationSearchInput.value.toLowerCase();
                    const filtered = AppState.conversations
                        .filter(c => c.partnerName.toLowerCase().includes(query))
                        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    DOM.conversationList.innerHTML = filtered.map(c => `
                        <li class="messages-layout__conversation-item ${c.id === AppState.activeConversationId ? 'active' : ''}" data-conv-id="${c.id}" tabindex="0">
                            <strong>${c.partnerName} ${c.unread > 0 ? `(${c.unread})` : ''}</strong>
                            <p>${c.lastMessage.substring(0, 30)}...</p>
                        </li>`).join('') || `<li class="loading-placeholder">Tidak ada percakapan.</li>`;
                },
                setActiveConversation(id) {
                    if (!id) return;
                    AppState.activeConversationId = id;
                    const conv = AppState.conversations.find(c => c.id === id);
                    if (conv) conv.unread = 0;
                    this.renderConversationsList();
                    this.renderMessagesForConversation(id);
                },
                renderMessagesForConversation(id) {
                    const conv = AppState.conversations.find(c => c.id === id);
                    const messages = AppState.messages[id] || [];
                    if (!conv) { this.showNoChatSelected(); return; }

                    DOM.noChatSelected.style.display = 'none';
                    DOM.activeChatContent.style.display = 'flex';
                    DOM.chatPartnerName.textContent = conv.partnerName;
                    DOM.messageList.innerHTML = messages.map(m => `
                        <div class="messages-layout__message messages-layout__message--${m.sender === 'user' ? 'sent' : 'received'} message-arriving">
                            <div>${m.text}</div>
                            <div class="messages-layout__message-meta">${Utils.formatTime(m.timestamp)}</div>
                        </div>`).join('');
                    DOM.messageList.scrollTop = DOM.messageList.scrollHeight;
                    DOM.messageInput.focus();
                },
                showNoChatSelected() {
                    DOM.noChatSelected.style.display = 'flex';
                    DOM.activeChatContent.style.display = 'none';
                },
                sendUserMessage() { /* Simulates sending a message and getting a reply */
                    const text = DOM.messageInput.value.trim();
                    if (!text || !AppState.activeConversationId) return;

                    const newMessage = { id: Utils.generateId('msg'), sender: 'user', text, timestamp: new Date().toISOString() };
                    AppState.messages[AppState.activeConversationId].push(newMessage);

                    const conv = AppState.conversations.find(c => c.id === AppState.activeConversationId);
                    conv.lastMessage = text;
                    conv.timestamp = newMessage.timestamp;

                    this.renderMessagesForConversation(AppState.activeConversationId);
                    this.renderConversationsList(); // To update timestamp/last message
                    DOM.messageInput.value = '';

                    // Simulate reply
                    setTimeout(() => {
                        const reply = { id: Utils.generateId('msg'), sender: 'partner', text: "Terima kasih, pesan Anda sudah kami terima.", timestamp: new Date().toISOString() };
                        AppState.messages[AppState.activeConversationId].push(reply);
                        conv.lastMessage = reply.text;
                        conv.timestamp = reply.timestamp;
                        this.renderMessagesForConversation(AppState.activeConversationId);
                        this.renderConversationsList();
                    }, 1500);
                },

                // CS Chat Widget
                initCsChatWidget() { /* Initializes CS chat widget */
                    AppState.csChatMessages.push({ sender: 'cs', text: 'Selamat datang! Ada yang bisa kami bantu?', timestamp: new Date().toISOString() });
                    this.renderCsChatMessages();
                },
                toggleCsChatWidget(forceState) {
                    const shouldOpen = forceState !== undefined ? forceState : !AppState.isCsChatWidgetOpen;
                    AppState.isCsChatWidgetOpen = shouldOpen;
                    DOM.csChatPopup.classList.toggle('open', shouldOpen);
                    DOM.csChatToggleBtn.setAttribute('aria-expanded', shouldOpen);
                    DOM.csChatToggleBtn.innerHTML = `<i class="fas fa-${shouldOpen ? 'times' : 'comments'}"></i>`;
                },
                renderCsChatMessages() {
                    DOM.csChatMessages.innerHTML = AppState.csChatMessages.map(m => `
                        <div class="cs-chat-widget__message ${m.sender} message-arriving">
                            <div>${m.text}</div>
                        </div>`).join('');
                    if (AppState.isCsTyping) {
                        DOM.csChatMessages.innerHTML += `<div class="cs-chat-widget__message cs-typing message-arriving"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>`;
                    }
                    DOM.csChatMessages.scrollTop = DOM.csChatMessages.scrollHeight;
                },
                sendCsChatMessage() {
                    const text = DOM.csChatMessageInput.value.trim();
                    if (!text) return;
                    AppState.csChatMessages.push({ sender: 'user', text, timestamp: new Date().toISOString() });
                    DOM.csChatMessageInput.value = '';
                    this.renderCsChatMessages();

                    // Simulate CS reply
                    AppState.isCsTyping = true;
                    this.renderCsChatMessages();
                    setTimeout(() => {
                        AppState.isCsTyping = false;
                        AppState.csChatMessages.push({ sender: 'cs', text: 'Terima kasih, tim kami akan segera membalas.', timestamp: new Date().toISOString() });
                        this.renderCsChatMessages();
                    }, 2000);
                },

                // Settings
                setupSettingsListeners() {
                    DOM.settingsContent.addEventListener('change', e => {
                        if (e.target.matches('input[type="checkbox"][data-setting]')) {
                            AppState.userSettings[e.target.dataset.setting] = e.target.checked;
                            this.saveSettings();
                        }
                        if (e.target.matches('select[data-setting]')) {
                            AppState.userSettings[e.target.dataset.setting] = e.target.value;
                            this.saveSettings();
                        }
                    });
                },
                renderSettings() {
                    Object.keys(AppState.userSettings).forEach(key => {
                        const el = DOM.settingsContent.querySelector(`[data-setting="${key}"]`);
                        if (el) {
                            if (el.type === 'checkbox') el.checked = AppState.userSettings[key];
                            else el.value = AppState.userSettings[key];
                        }
                    });
                },
                saveSettings() {
                    localStorage.setItem('gv-settings', JSON.stringify(AppState.userSettings));
                    this.showNotification('Pengaturan disimpan.', 'Sukses', 'success');
                },
                openChangePasswordModal() { this.openModal(DOM.changePasswordModalOverlay); },
                handleChangePasswordFormSubmit(e) {
                    e.preventDefault();
                    if (!this.validateForm(DOM.changePasswordForm)) return;
                    if (DOM.changePasswordForm.newPassword.value !== DOM.changePasswordForm.confirmNewPassword.value) {
                        DOM.changePasswordForm.confirmNewPassword.classList.add('is-invalid');
                        DOM.changePasswordForm.confirmNewPassword.nextElementSibling.textContent = "Konfirmasi password tidak cocok.";
                        return;
                    }
                    this.closeModal(DOM.changePasswordModalOverlay);
                    this.showNotification('Password berhasil diubah!', 'Sukses', 'success');
                },

            });

            document.addEventListener('DOMContentLoaded', () => App.init());
        })();
    </script>
</body>

</html>