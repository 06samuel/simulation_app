<!DOCTYPE html>

<html lang="id">

<head>
    <!-- =========================================================================
       HEAD - META, KONFIGURASI, & ASET
       Bagian ini berisi semua konfigurasi penting untuk aplikasi.
       Struktur ini dipertahankan, dengan penambahan tag meta standar,
       pre-koneksi untuk performa, dan aset ikon dari CDN.
       ========================================================================= -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green Valley - Platform Sewa Properti</title>

    <!-- Meta Deskripsi & SEO Dasar -->
    <meta name="description"
        content="Green Valley, platform modern untuk mencari dan menyewa properti apartemen dengan mudah, aman, dan cepat.">
    <meta name="keywords" content="sewa apartemen, properti, sewa properti, green valley, apartemen modern">
    <meta name="author" content="Green Valley Development">
    <meta name="theme-color" content="#3b82f6">

    <!-- Meta PWA & Mobile Experience -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" sizes="32x32" href="https://i.ibb.co/bWjX0V9/favicon.png">
    <link rel="apple-touch-icon" href="https://i.ibb.co/bWjX0V9/favicon.png">

    <!-- Pre-koneksi untuk Aset Font & Ikon dari CDN -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">

    <!-- Aset Font & Ikon (dari CDN populer, sesuai permintaan) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        /* ==========================================================================
       1. STYLING (CSS) - Fondasi Visual & Responsif
       CSS diorganisir menggunakan pendekatan modular, mulai dari token desain
       global, reset, struktur layout, hingga komponen spesifik.
       CSS yang ada dipertahankan untuk menjaga konsistensi visual, dengan
       penambahan CSS untuk fitur-fitur baru.
       ========================================================================== */

        /* 1.1: Design Tokens & Reset Global */
        :root {
            --font-size-xs: clamp(0.75rem, 0.7rem + 0.25vw, 0.875rem);
            --font-size-sm: clamp(0.875rem, 0.8rem + 0.375vw, 1rem);
            --font-size-base: clamp(1rem, 0.9rem + 0.5vw, 1.125rem);
            --font-size-lg: clamp(1.25rem, 1.1rem + 0.75vw, 1.5rem);
            --font-size-xl: clamp(1.5rem, 1.3rem + 1vw, 2rem);
            --spacing-1: clamp(0.25rem, 0.2rem + 0.25vw, 0.5rem);
            --spacing-2: clamp(0.5rem, 0.4rem + 0.5vw, 0.75rem);
            --spacing-3: clamp(0.75rem, 0.65rem + 0.5vw, 1rem);
            --spacing-4: clamp(1rem, 0.85rem + 0.75vw, 1.5rem);
            --spacing-5: clamp(1.5rem, 1.25rem + 1.25vw, 2rem);
            --spacing-6: clamp(2rem, 1.75rem + 1.25vw, 3rem);
            --background: #f8fafc;
            --foreground: #0f172a;
            --card: #ffffff;
            --card-foreground: #0f172a;
            --primary: #3b82f6;
            --primary-foreground: #ffffff;
            --primary-hover: #2563eb;
            --secondary: #f1f5f9;
            --secondary-foreground: #0f172a;
            --secondary-hover: #e2e8f0;
            --muted: #f1f5f9;
            --muted-foreground: #64748b;
            --accent: #e0f2fe;
            --accent-foreground: #0c4a6e;
            --destructive: #ef4444;
            --destructive-foreground: #ffffff;
            --destructive-hover: #dc2626;
            --border: #e2e8f0;
            --input: #e2e8f0;
            --ring: #3b82f6;
            --success: #22c55e;
            --success-foreground: #ffffff;
            --warning: #f59e0b;
            --warning-foreground: #ffffff;
            --radius: 0.5rem;
            --radius-lg: 1rem;
            --radius-full: 9999px;
            --sidebar-width: 280px;
            --header-height: 70px;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --z-fixed: 1100;
            --z-modal-backdrop: 1290;
            --z-modal: 1300;
            --z-toast: 1400;
        }

        .dark {
            --background: #020617;
            --foreground: #f1f5f9;
            --card: #0f172a;
            --card-foreground: #f1f5f9;
            --primary: #60a5fa;
            --primary-foreground: #0f172a;
            --primary-hover: #3b82f6;
            --secondary: #1e293b;
            --secondary-foreground: #f1f5f9;
            --secondary-hover: #334155;
            --muted-foreground: #94a3b8;
            --accent: #1e3a8a;
            --accent-foreground: #bfdbfe;
            --destructive: #f87171;
            --destructive-foreground: #0f172a;
            --destructive-hover: #ef4444;
            --border: #1e293b;
            --input: #1e293b;
            --ring: #60a5fa;
            --success: #4ade80;
            --warning: #fbbf24;
        }

        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html {
            scroll-behavior: smooth;
            height: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: var(--foreground);
            background-color: var(--background);
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        body.sidebar-overlay-open {
            overflow: hidden;
        }

        body.sidebar-overlay-open::before {
            content: '';
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: calc(var(--z-fixed) - 1);
            display: block;
        }

        img,
        picture,
        video {
            display: block;
            max-width: 100%;
            height: auto;
        }

        h1,
        h2,
        h3 {
            font-weight: 700;
            line-height: 1.2;
        }

        h1 {
            font-size: var(--font-size-xl);
        }

        h2 {
            font-size: var(--font-size-lg);
        }

        a {
            color: var(--primary);
            text-decoration: none;
            transition: color 0.2s;
        }

        a:hover {
            color: var(--primary-hover);
            text-decoration: underline;
        }

        /* 1.2: Struktur Layout Utama */
        #app-container {
            display: flex;
            flex-direction: row;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: var(--card);
            padding: var(--spacing-5) var(--spacing-4);
            border-right: 1px solid var(--border);
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease-in-out;
            flex-shrink: 0;
            z-index: var(--z-fixed);
            position: sticky;
            top: 0;
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-5);
        }

        .sidebar-brand i {
            font-size: var(--font-size-xl);
            color: var(--primary);
        }

        .sidebar-brand span {
            font-size: var(--font-size-lg);
            font-weight: 700;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            padding: var(--spacing-2) var(--spacing-3);
            color: var(--muted-foreground);
            border-radius: var(--radius);
            transition: var(--transition);
            font-weight: 500;
        }

        .nav-link:hover {
            background: var(--accent);
            color: var(--accent-foreground);
            text-decoration: none;
        }

        .nav-link.active {
            background: var(--primary);
            color: var(--primary-foreground);
        }

        .main-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow-y: auto;
            width: 100%;
            min-width: 0;
        }

        .app-header {
            height: var(--header-height);
            background: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 0 var(--spacing-5);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-left,
        .header-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
        }

        .sidebar-toggle {
            display: none;
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: var(--secondary);
            border-radius: var(--radius-full);
            max-width: 400px;
            flex-grow: 1;
        }

        .search-bar i {
            color: var(--muted-foreground);
            margin-left: var(--spacing-3);
        }

        .search-bar input {
            border: none;
            background: transparent;
            outline: none;
            padding: var(--spacing-2);
            flex-grow: 1;
            color: var(--foreground);
        }

        .profile-dropdown {
            position: relative;
        }

        .profile-dropdown__toggle {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            cursor: pointer;
            background: transparent;
            border: none;
        }

        .profile-dropdown__toggle img {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            object-fit: cover;
            border: 2px solid var(--border);
            cursor: pointer;
        }

        /* [FITUR] Tambahan cursor pointer untuk zoom */
        .profile-dropdown__menu {
            position: absolute;
            top: calc(100% + var(--spacing-2));
            right: 0;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            z-index: var(--z-modal);
            opacity: 0;
            transform: translateY(-10px);
            visibility: hidden;
            transition: var(--transition);
        }

        .profile-dropdown__menu.show {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }

        .profile-dropdown__item {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            padding: var(--spacing-2) var(--spacing-3);
            cursor: pointer;
            color: var(--card-foreground);
        }

        .profile-dropdown__item:hover {
            background-color: var(--secondary);
            text-decoration: none;
        }

        .main-content {
            padding: var(--spacing-5);
            flex-grow: 1;
        }

        .page-content {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 1.3: Komponen UI */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            padding: var(--spacing-4);
        }

        .card-header {
            padding-bottom: var(--spacing-3);
            margin-bottom: var(--spacing-3);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--spacing-3);
        }

        .card-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            margin: 0;
        }

        .stats-grid,
        .apartments-grid,
        .payment-options {
            display: grid;
            gap: var(--spacing-4);
        }

        .stats-grid {
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        .apartments-grid {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }

        .apartment-card {
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            cursor: pointer;
        }

        .apartment-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .apartment-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-bottom: 1px solid var(--border);
        }

        .apartment-card .card-body {
            flex-grow: 1;
            padding: var(--spacing-4);
            display: flex;
            flex-direction: column;
        }

        .apartment-card .card-title {
            margin-bottom: var(--spacing-2);
        }

        .apartment-actions {
            display: flex;
            gap: var(--spacing-2);
            margin-top: auto;
            padding-top: var(--spacing-3);
        }

        .table-container {
            overflow-x: auto;
            border: 1px solid var(--border);
            border-radius: var(--radius);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: var(--spacing-3) var(--spacing-4);
            text-align: left;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        th {
            background: var(--secondary);
            font-weight: 600;
        }

        tbody tr:hover {
            background-color: var(--accent);
        }

        .badge {
            padding: var(--spacing-1) var(--spacing-2);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: 600;
        }

        .badge-success {
            background: var(--success);
            color: var(--success-foreground);
        }

        .badge-warning {
            background: var(--warning);
            color: var(--warning-foreground);
        }

        .badge-danger {
            background: var(--destructive);
            color: var(--destructive-foreground);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-2);
            padding: var(--spacing-2) var(--spacing-4);
            border-radius: var(--radius);
            font-weight: 500;
            transition: var(--transition);
            border: 1px solid transparent;
            cursor: pointer;
            text-decoration: none;
        }

        .btn:hover {
            text-decoration: none;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--primary-foreground);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: var(--secondary);
            color: var(--secondary-foreground);
            border-color: var(--border);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--secondary-hover);
        }

        .btn-danger {
            background: var(--destructive);
            color: var(--destructive-foreground);
        }

        .btn-danger:hover:not(:disabled) {
            background: var(--destructive-hover);
        }

        .btn-sm {
            padding: var(--spacing-1) var(--spacing-2);
            font-size: var(--font-size-sm);
        }

        .btn-close {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--muted-foreground);
            line-height: 1;
            padding: 0;
        }

        .btn-close:hover {
            color: var(--foreground);
        }

        .form-group {
            margin-bottom: var(--spacing-4);
        }

        .form-label {
            font-weight: 500;
            margin-bottom: var(--spacing-2);
            display: block;
        }

        .form-control {
            width: 100%;
            padding: var(--spacing-2) var(--spacing-3);
            border: 1px solid var(--input);
            background-color: var(--background);
            border-radius: var(--radius);
            color: var(--foreground);
            transition: var(--transition);
        }

        .form-control:focus {
            outline: 2px solid transparent;
            border-color: var(--ring);
            box-shadow: 0 0 0 2px var(--ring);
        }

        .form-control.is-invalid {
            border-color: var(--destructive);
        }

        .invalid-feedback {
            color: var(--destructive);
            font-size: var(--font-size-sm);
            margin-top: var(--spacing-1);
            display: none;
        }

        .is-invalid~.invalid-feedback {
            display: block;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .loading-placeholder {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--spacing-6);
            color: var(--muted-foreground);
            gap: var(--spacing-2);
        }

        .loading-placeholder .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: var(--z-modal-backdrop);
            padding: var(--spacing-4);
            overflow-y: auto;
        }

        .modal-overlay.show {
            display: flex;
            opacity: 1;
        }

        .modal-dialog {
            max-width: 600px;
            width: 100%;
            background: var(--card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            transform: scale(0.95);
            transition: transform 0.3s ease;
            opacity: 0;
            z-index: var(--z-modal);
        }

        .modal-overlay.show .modal-dialog {
            transform: scale(1);
            opacity: 1;
        }

        .modal-content {
            padding: var(--spacing-5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            padding-bottom: var(--spacing-3);
            margin-bottom: var(--spacing-4);
        }

        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-3);
            border-top: 1px solid var(--border);
            padding-top: var(--spacing-4);
            margin-top: var(--spacing-4);
        }

        .toast-container {
            position: fixed;
            bottom: var(--spacing-4);
            right: var(--spacing-4);
            z-index: var(--z-toast);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-3);
        }

        .toast {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            background-color: var(--card);
            color: var(--foreground);
            padding: var(--spacing-3) var(--spacing-4);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            border-left: 4px solid var(--primary);
            opacity: 0;
            transform: translateX(120%);
            transition: all 0.4s ease;
            min-width: 300px;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.toast-success {
            border-color: var(--success);
        }

        .toast.toast-danger {
            border-color: var(--destructive);
        }

        .auth-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: var(--spacing-4);
        }

        .auth-card {
            max-width: 450px;
            width: 100%;
        }

        .auth-card .card-title {
            text-align: center;
            font-size: var(--font-size-xl);
        }

        .auth-footer {
            text-align: center;
            margin-top: var(--spacing-4);
            color: var(--muted-foreground);
        }

        /* 1.4: [PENAMBAHAN] CSS untuk Fitur Baru */
        .property-detail-img {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-4);
            cursor: zoom-in;
        }

        .image-zoom-modal .modal-dialog {
            max-width: 90vw;
            background: transparent;
            box-shadow: none;
        }

        .image-zoom-modal .modal-content {
            padding: 0;
            background: transparent;
        }

        .image-zoom-modal .zoomed-image {
            max-height: 90vh;
            width: auto;
            border-radius: var(--radius-lg);
            margin: auto;
        }

        .image-zoom-modal .btn-close {
            position: absolute;
            top: var(--spacing-4);
            right: var(--spacing-4);
            font-size: 2rem;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .review-list {
            list-style: none;
            margin-top: var(--spacing-4);
        }

        .review-item {
            display: flex;
            gap: var(--spacing-3);
            border-top: 1px solid var(--border);
            padding: var(--spacing-4) 0;
        }

        .review-item:first-child {
            border-top: none;
            padding-top: 0;
        }

        .review-avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            object-fit: cover;
            flex-shrink: 0;
        }

        .review-content p {
            margin: 0;
        }

        .avatar-upload-preview {
            display: block;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            margin: var(--spacing-3) auto;
            border: 3px solid var(--border);
            cursor: pointer;
        }

        #avatarUploadInput {
            display: none;
        }

        .payment-options {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }

        .payment-option {
            border: 2px solid var(--border);
            padding: var(--spacing-4);
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .payment-option:hover,
        .payment-option.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--ring);
            background-color: var(--accent);
        }

        .payment-option i {
            font-size: 2rem;
            margin-bottom: var(--spacing-2);
            color: var(--primary);
            display: block;
        }

        .qr-code-container img {
            margin: var(--spacing-4) auto;
            display: block;
            max-width: 250px;
            border-radius: var(--radius);
        }

        .receipt-content {
            line-height: 1.8;
        }

        .receipt-content .item {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-2) 0;
            border-bottom: 1px dashed var(--border);
        }

        .receipt-content .item span:first-child {
            color: var(--muted-foreground);
        }

        .receipt-content .total {
            font-size: var(--font-size-lg);
            font-weight: bold;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            #printable-area,
            #printable-area * {
                visibility: visible;
            }

            #printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                color: #000 !important;
            }

            .modal-footer,
            .sidebar-brand i {
                display: none !important;
            }

            .sidebar-brand span {
                color: #000;
            }
        }

        /* 1.5: Aturan Responsif */
        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                transform: translateX(-100%);
            }

            .sidebar.show {
                transform: translateX(0);
                box-shadow: var(--shadow-lg);
            }

            .sidebar-toggle {
                display: inline-flex;
            }

            .app-header .search-bar {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .app-header {
                padding: 0 var(--spacing-4);
            }

            .main-content {
                padding: var(--spacing-4);
            }

            .profile-dropdown__toggle span {
                display: none;
            }

            .modal-dialog {
                width: calc(100% - var(--spacing-4));
            }

            .toast-container {
                right: var(--spacing-2);
                left: var(--spacing-2);
                bottom: var(--spacing-2);
                align-items: center;
            }

            .toast {
                width: 100%;
                max-width: 400px;
            }
        }
    </style>

</head>

<body>
    <!-- =========================================================================
       2. BODY - STRUKTUR HTML APLIKASI
       Struktur dasar HTML dibagi menjadi dua kontainer utama:
       #auth-container untuk halaman login/register.
       #app-container untuk aplikasi utama setelah login.
       Hanya salah satu yang aktif pada satu waktu.
       ========================================================================= -->
    <div id="auth-container"></div>

    <div id="app-container" style="display: none;">

        <aside class="sidebar" id="sidebar" aria-label="Navigasi Utama">
            <div class="sidebar-brand">
                <i class="bi bi-buildings-fill"></i>
                <span>Green Valley</span>
            </div>
            <nav aria-label="Menu Aplikasi">
                <ul class="nav-menu" id="navMenu">
                    <!-- Navigasi dirender secara dinamis tetapi struktur dasarnya di sini -->
                    <li><a href="#dashboard" class="nav-link active" data-page="dashboard"><i
                                class="bi bi-grid-1x2-fill"></i> <span>Dashboard</span></a></li>
                    <li><a href="#properties" class="nav-link" data-page="properties"><i class="bi bi-building"></i>
                            <span>Properti</span></a></li>
                    <li><a href="#bookings" class="nav-link" data-page="bookings"><i class="bi bi-calendar-check"></i>
                            <span>Booking Saya</span></a></li>
                    <li><a href="#settings" class="nav-link" data-page="settings"><i class="bi bi-person-gear"></i>
                            <span>Profil & Akun</span></a></li>
                </ul>
            </nav>
        </aside>

        <div class="main-wrapper" id="mainWrapper">
            <header class="app-header">
                <div class="header-left">
                    <button type="button" class="btn btn-secondary btn-sm sidebar-toggle" id="sidebarToggle"
                        aria-label="Buka/Tutup Navigasi">
                        <i class="bi bi-list"></i>
                    </button>
                    <div class="search-bar">
                        <i class="bi bi-search"></i>
                        <input type="search" id="headerSearchInput" placeholder="Cari properti..."
                            aria-label="Pencarian Global">
                    </div>
                </div>
                <div class="header-right">
                    <button type="button" class="btn btn-secondary theme-toggle" id="themeToggleBtn"
                        aria-label="Ganti Tema">
                        <i class="bi bi-moon-fill"></i>
                    </button>
                    <div class="profile-dropdown">
                        <button type="button" class="profile-dropdown__toggle" id="profileDropdownToggle"
                            aria-haspopup="true" aria-expanded="false">
                            <img id="userAvatar" src="https://i.pravatar.cc/40?u=guest" alt="Avatar Pengguna"
                                data-action="zoom-profile-pic">
                            <span id="usernameDisplay">Pengguna</span>
                            <i class="bi bi-chevron-down"
                                style="font-size: var(--font-size-xs); margin-left: var(--spacing-1);"></i>
                        </button>
                        <div class="profile-dropdown__menu" id="profileDropdownMenu" role="menu">
                            <a href="#settings" class="profile-dropdown__item" role="menuitem" data-page="settings"><i
                                    class="bi bi-person-circle"></i> Profil</a>
                            <a href="#" class="profile-dropdown__item" role="menuitem" data-action="change-avatar"><i
                                    class="bi bi-camera"></i> Ganti Foto</a>
                            <a href="#logout" id="logoutButton" class="profile-dropdown__item" role="menuitem"><i
                                    class="bi bi-box-arrow-right"></i> Keluar</a>
                        </div>
                    </div>
                </div>
            </header>

            <main class="main-content" id="pageContentContainer" role="main" aria-live="polite"></main>
        </div>
    </div>

    <!-- Kontainer untuk elemen dinamis seperti Toast dan Modal -->
    <div id="toast-container" class="toast-container"></div>
    <div id="modal-container"></div>

    <!-- =========================================================================
   3. SCRIPT (JAVASCRIPT) - LOGIKA APLIKASI SPA
   Kode JavaScript dirombak total untuk mengikuti arsitektur berlapis,
   memperbaiki bug, dan menambahkan semua fitur yang diminta.
   ========================================================================= -->
    <script>
        (function () {
            'use strict';

            /**
             * =========================================================================
             * 4. DATA LAYER: State Management & Mock API
             * Lapisan ini bertanggung jawab untuk mengelola state aplikasi (data yang
             * sedang aktif) dan menyimulasikan komunikasi dengan server (API).
             * =========================================================================
             */
            const AppState = {
                isAuthenticated: sessionStorage.getItem('isAuthenticated') === 'true',
                currentUser: JSON.parse(sessionStorage.getItem('currentUser')) || null,
                activePage: 'dashboard',
                theme: localStorage.getItem('theme') || 'light',
                properties: [],
                bookings: [],
                reviews: JSON.parse(localStorage.getItem('app_reviews')) || {},
            };

            const API = {
                _simulateDelay: (data, delay = 400) => new Promise(resolve => setTimeout(() => resolve(data), delay)),

                // --- Auth API ---
                async login(email, password) {
                    // Dalam aplikasi nyata, validasi terjadi di server
                    if ((email.toLowerCase() === 'penyewa@mail.com' || email.toLowerCase() === 'budi@mail.com') && password === 'password') {
                        const user = {
                            id: 'user001',
                            name: 'Budi Penyewa',
                            email: 'budi@mail.com',
                            whatsapp: '081234567890',
                            ktpUploaded: true, // Simulasi KTP sudah diupload
                            avatar: sessionStorage.getItem('user_avatar_user001') || `https://i.pravatar.cc/150?u=budi`
                        };
                        AppState.isAuthenticated = true;
                        AppState.currentUser = user;
                        sessionStorage.setItem('isAuthenticated', 'true');
                        sessionStorage.setItem('currentUser', JSON.stringify(user));
                        return this._simulateDelay({ success: true, user });
                    }
                    return this._simulateDelay({ success: false, message: 'Email atau password salah.' });
                },

                async register(name, email, password) {
                    if (name && email && password) {
                        const newId = `user${Date.now()}`;
                        const user = {
                            id: newId,
                            name: name,
                            email: email,
                            whatsapp: '',
                            ktpUploaded: false,
                            avatar: `https://i.pravatar.cc/150?u=${newId}`
                        };
                        AppState.isAuthenticated = true;
                        AppState.currentUser = user;
                        sessionStorage.setItem('isAuthenticated', 'true');
                        sessionStorage.setItem('currentUser', JSON.stringify(user));
                        return this._simulateDelay({ success: true, user });
                    }
                    return this._simulateDelay({ success: false, message: 'Semua kolom wajib diisi.' });
                },

                logout() {
                    API.saveReviewsToLocal(); // Simpan ulasan sebelum logout
                    AppState.isAuthenticated = false;
                    AppState.currentUser = null;
                    sessionStorage.removeItem('isAuthenticated');
                    sessionStorage.removeItem('currentUser');
                },

                // --- Data Fetching API ---
                async fetchProperties() {
                    if (AppState.properties.length > 0) return AppState.properties;
                    const data = [
                        { id: 'p001', title: 'Apartemen Modern Pusat Kota', category: 'Premium', price: 10000000, image: 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?auto=format&fit=crop&w=800&q=80', available: true, location: 'Jakarta Pusat', beds: 2, baths: 1, area: 65, description: 'Apartemen modern 2 kamar tidur di jantung kota, menawarkan akses mudah ke pusat bisnis, perbelanjaan, dan hiburan. Dilengkapi dengan fasilitas gym dan kolam renang.' },
                        { id: 'p002', title: 'Studio Nyaman Dekat Kampus', category: 'Ekonomis', price: 5500000, image: 'https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?auto=format&fit=crop&w=800&q=80', available: true, location: 'Depok', beds: 1, baths: 1, area: 30, description: 'Studio efisien dan fully-furnished, sangat cocok untuk mahasiswa atau profesional muda. Hanya 5 menit jalan kaki ke universitas terkemuka.' },
                        { id: 'p003', title: 'Penthouse Mewah City View', category: 'Mewah', price: 25000000, image: 'https://images.unsplash.com/photo-1613490493576-7fde63acd811?auto=format&fit=crop&w=800&q=80', available: false, location: 'Surabaya', beds: 3, baths: 3, area: 180, description: 'Rasakan kemewahan di penthouse eksklusif dengan pemandangan kota 360 derajat. Dilengkapi kolam renang pribadi dan akses lift privat.' },
                        { id: 'p004', title: 'Apartemen Keluarga Tepi Danau', category: 'Keluarga', price: 12000000, image: 'https://images.unsplash.com/photo-1512917774080-9991f1c4c750?auto=format&fit=crop&w=800&q=80', available: true, location: 'Tangerang', beds: 3, baths: 2, area: 90, description: 'Nikmati suasana asri setiap hari di apartemen keluarga ini. Balkon pribadi menghadap langsung ke danau, cocok untuk bersantai bersama keluarga.' },
                    ];
                    AppState.properties = await this._simulateDelay(data);
                    return AppState.properties;
                },

                async fetchPropertyById(id) {
                    if (AppState.properties.length === 0) await this.fetchProperties();
                    return this._simulateDelay(AppState.properties.find(p => p.id === id));
                },

                async fetchBookings() {
                    // Simulasi histori booking yang disimpan
                    const storedBookings = JSON.parse(sessionStorage.getItem('user_bookings')) || [];
                    if (storedBookings.length > 0) {
                        AppState.bookings = storedBookings;
                        return AppState.bookings;
                    }
                    const data = [
                        { id: `b${Date.now() - 20000}`, tenant: 'Budi Penyewa', propertyId: 'p003', propertyTitle: 'Penthouse Mewah City View', date: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(), status: 'Selesai' },
                    ];
                    AppState.bookings = await this._simulateDelay(data);
                    sessionStorage.setItem('user_bookings', JSON.stringify(AppState.bookings));
                    return AppState.bookings;
                },

                async fetchReviewsForProperty(propertyId) {
                    return AppState.reviews[propertyId] || [];
                },

                // --- CRUD & Action API ---
                addBooking(bookingData) {
                    const newBooking = { id: `b${Date.now()}`, status: 'Aktif', ...bookingData };
                    AppState.bookings.unshift(newBooking);
                    sessionStorage.setItem('user_bookings', JSON.stringify(AppState.bookings));
                    return this._simulateDelay(newBooking);
                },
                deleteBooking(id) {
                    AppState.bookings = AppState.bookings.filter(b => b.id != id);
                    sessionStorage.setItem('user_bookings', JSON.stringify(AppState.bookings));
                    return this._simulateDelay({ success: true });
                },
                addReview(propertyId, reviewData) {
                    if (!AppState.reviews[propertyId]) AppState.reviews[propertyId] = [];
                    AppState.reviews[propertyId].unshift(reviewData);
                    this.saveReviewsToLocal();
                    return this._simulateDelay(reviewData);
                },
                saveReviewsToLocal() {
                    localStorage.setItem('app_reviews', JSON.stringify(AppState.reviews));
                },
                updateProfile(updates) {
                    if (!AppState.currentUser) return Promise.reject('Tidak ada pengguna yang login');
                    AppState.currentUser = { ...AppState.currentUser, ...updates };
                    sessionStorage.setItem('currentUser', JSON.stringify(AppState.currentUser));
                    if (updates.avatar) sessionStorage.setItem(`user_avatar_${AppState.currentUser.id}`, updates.avatar);
                    return this._simulateDelay(AppState.currentUser);
                }
            };

            /**
             * =========================================================================
             * 5. SERVICE/UTILITY LAYER: Fungsi Pendukung
             * Kumpulan fungsi bantuan murni yang tidak bergantung pada state aplikasi.
             * =========================================================================
             */
            const Utils = {
                sanitizeHTML: (str) => { const temp = document.createElement('div'); temp.textContent = str || ''; return temp.innerHTML; },
                formatCurrency: (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount),
                formatDate: (dateStr) => new Date(dateStr).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }),
                getGreeting: () => { const h = new Date().getHours(); return h < 12 ? 'Selamat Pagi' : h < 18 ? 'Selamat Siang' : 'Selamat Malam'; }
            };

            /**
             * =========================================================================
             * 6. UI LAYER: Templates & Komponen Visual
             * Lapisan ini bertanggung jawab untuk menghasilkan string HTML (template)
             * yang akan dirender ke DOM. Semua logika visual ada di sini.
             * =========================================================================
             */
            const Templates = {
                loadingPlaceholder: () => `<div class="loading-placeholder"><i class="bi bi-arrow-repeat spinner"></i> Memuat Konten...</div>`,
                modal(id, title, content, footer, extraClasses = '') { return `<div class="modal-overlay ${extraClasses}" id="${id}Overlay"><div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="${id}Title"><div class="modal-content"><div class="modal-header"><h2 class="card-title" id="${id}Title">${Utils.sanitizeHTML(title)}</h2><button type="button" class="btn-close" data-dismiss="modal" aria-label="Tutup"><i class="bi bi-x-lg"></i></button></div><div class="modal-body">${content}</div>${footer ? `<div class="modal-footer">${footer}</div>` : ''}</div></div></div>`; },

                auth(type = 'login') {
                    const isLogin = type === 'login';
                    return `<div class="auth-wrapper page-content"><div class="card auth-card"><form id="${type}Form" novalidate><div class="sidebar-brand" style="justify-content: center; margin-bottom: var(--spacing-5);"><i class="bi bi-buildings-fill"></i><span>Green Valley</span></div><h2 class="card-title">${isLogin ? 'Selamat Datang' : 'Buat Akun Baru'}</h2><p style="text-align:center; color: var(--muted-foreground); margin-top:-10px; margin-bottom: var(--spacing-4);">${isLogin ? 'Silakan masuk untuk melanjutkan' : 'Daftar untuk mulai menyewa'}</p>${!isLogin ? `<div class="form-group"><label for="registerName" class="form-label">Nama Lengkap</label><input type="text" id="registerName" class="form-control" required><div class="invalid-feedback">Nama lengkap wajib diisi.</div></div>` : ''}<div class="form-group"><label for="${type}Email" class="form-label">Email</label><input type="email" id="${type}Email" class="form-control" required value="penyewa@mail.com"><div class="invalid-feedback">Format email tidak valid.</div></div><div class="form-group"><label for="${type}Password" class="form-label">Password</label><input type="password" id="${type}Password" class="form-control" required value="password"><div class="invalid-feedback">Password wajib diisi.</div></div>${isLogin ? `<div style="text-align: right; margin-top: -15px; margin-bottom: 15px; font-size: var(--font-size-sm);"><a href="#" data-action="forgot-password">Lupa password?</a></div>` : ''}<button type="submit" class="btn btn-primary" style="width:100%;">${isLogin ? 'Masuk' : 'Daftar'}</button><div class="auth-footer">${isLogin ? `Belum punya akun? <a href="#register">Daftar di sini</a>` : `Sudah punya akun? <a href="#login">Masuk di sini</a>`}</div></form></div></div>`;
                },
                dashboard() {
                    const availableProps = AppState.properties.filter(p => p.available).length;
                    const totalBookings = AppState.bookings.length;
                    const activeBookings = AppState.bookings.filter(b => b.status === 'Aktif').length;
                    return `<div class="page-content"><h1>${Utils.getGreeting()}, ${Utils.sanitizeHTML(AppState.currentUser.name)}!</h1><p style="color:var(--muted-foreground); margin-top:-10px; margin-bottom: var(--spacing-4);">Berikut ringkasan aktivitas Anda di Green Valley.</p><div class="stats-grid"><div class="card"><h3 class="card-title">Properti Tersedia</h3><p style="font-size:var(--font-size-xl); font-weight:700;">${availableProps}</p></div><div class="card"><h3 class="card-title">Total Booking Saya</h3><p style="font-size:var(--font-size-xl); font-weight:700;">${totalBookings}</p></div><div class="card"><h3 class="card-title">Booking Aktif</h3><p style="font-size:var(--font-size-xl); font-weight:700;">${activeBookings}</p></div><div class="card"><a href="#properties" class="btn btn-primary" style="width: 100%; height: 100%; flex-direction: column; gap: 0;"><i class="bi bi-search" style="font-size: 1.5rem; margin-bottom: var(--spacing-2)"></i><span style="font-size: var(--font-size-lg)">Cari Properti</span></a></div></div><div class="card" style="margin-top:var(--spacing-5);"><h2 class="card-title">Histori Booking Terbaru</h2><div class="table-container"><table><thead><tr><th>Properti</th><th>Tanggal</th><th>Status</th></tr></thead><tbody>${AppState.bookings.slice(0, 5).map(b => `<tr><td><a href="#properties/${b.propertyId}">${Utils.sanitizeHTML(b.propertyTitle)}</a></td><td>${Utils.formatDate(b.date)}</td><td><span class="badge ${b.status === 'Aktif' ? 'badge-success' : 'badge-secondary'}">${b.status}</span></td></tr>`).join('') || `<tr><td colspan="3" style="text-align:center;">Belum ada data booking.</td></tr>`}</tbody></table></div></div></div>`;
                },
                properties() {
                    const categories = [...new Set(AppState.properties.map(p => p.category))];
                    return `<div class="page-content"><div class="card-header" style="padding:0; border:0; margin-bottom: var(--spacing-4);"><h1 style="margin:0;">Temukan Properti Impian Anda</h1></div><div style="display: flex; gap: var(--spacing-3); flex-wrap: wrap; margin-bottom: var(--spacing-4); align-items: stretch;"><div class="search-bar" style="max-width: none; flex-grow:1;"><i class="bi bi-search"></i><input type="search" id="pageSearchInput" placeholder="Cari nama, lokasi, harga..." aria-label="Pencarian Properti"></div><div class="form-group" style="margin-bottom:0; min-width: 200px;"><select id="categoryFilter" class="form-control" style="height:100%;"><option value="">Semua Kategori</option>${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}</select></div></div><div class="apartments-grid" id="propertiesGrid">${this.propertyCards(AppState.properties)}</div></div>`;
                },
                propertyCards(properties) {
                    if (properties.length === 0) return `<p style="grid-column: 1 / -1; text-align: center; color: var(--muted-foreground); padding: var(--spacing-5);">Tidak ada properti yang cocok dengan kriteria Anda.</p>`;
                    return properties.map(prop => `<div class="apartment-card card" data-action="view-details" data-id="${prop.id}"><img src="${prop.image}" alt="Gambar ${Utils.sanitizeHTML(prop.title)}" loading="lazy"><div class="card-body"><span class="badge" style="background-color: var(--accent); color: var(--accent-foreground); align-self: flex-start; margin-bottom: var(--spacing-2);">${Utils.sanitizeHTML(prop.category)}</span><h3 class="card-title">${Utils.sanitizeHTML(prop.title)}</h3><p style="color:var(--muted-foreground); font-size: var(--font-size-sm);"><i class="bi bi-geo-alt-fill"></i> ${Utils.sanitizeHTML(prop.location)}</p><p style="font-weight:bold; color:var(--primary); font-size:var(--font-size-lg); margin-top: auto;">${Utils.formatCurrency(prop.price)}<span style="font-weight:400; font-size: var(--font-size-sm); color:var(--muted-foreground)">/bulan</span></p><div class="apartment-actions" style="padding-top: var(--spacing-2)"><span class="badge ${prop.available ? 'badge-success' : 'badge-danger'}">${prop.available ? 'Tersedia' : 'Telah Disewa'}</span></div></div></div>`).join('');
                },
                propertyDetail(prop, reviews) {
                    if (!prop) return `<div class="page-content"><div class="card"><p>Properti tidak ditemukan. <a href="#properties">Kembali ke daftar properti</a>.</p></div></div>`;
                    return `<div class="page-content"><div class="card"><img src="${prop.image}" alt="Gambar ${Utils.sanitizeHTML(prop.title)}" class="property-detail-img" data-action="zoom-image" data-src="${prop.image}"><div class="card-header" style="border:0; padding:0; margin-bottom: var(--spacing-2); flex-wrap: wrap;"><h1 style="margin:0;">${Utils.sanitizeHTML(prop.title)}</h1><span class="badge ${prop.available ? 'badge-success' : 'badge-danger'}" style="font-size: var(--font-size-base);">${prop.available ? 'Tersedia' : 'Telah Disewa'}</span></div><p style="color:var(--muted-foreground); font-size: var(--font-size-lg); margin-top:-5px;"><i class="bi bi-geo-alt-fill"></i> ${Utils.sanitizeHTML(prop.location)}</p><div class="stats-grid" style="gap: var(--spacing-5); padding: var(--spacing-3) 0; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); margin: var(--spacing-4) 0;"><div><i class="bi bi-rulers"></i> <strong>${prop.area}</strong> m²</div><div><i class="bi bi-door-open-fill"></i> <strong>${prop.beds}</strong> KT</div><div><i class="bi bi-droplet-fill"></i> <strong>${prop.baths}</strong> KM</div><div><i class="bi bi-tags-fill"></i> <strong>${prop.category}</strong></div></div><h3 style="margin-bottom: var(--spacing-2);">Deskripsi</h3><p>${Utils.sanitizeHTML(prop.description)}</p><div style="margin-top: var(--spacing-5); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: var(--spacing-3);"><p style="font-weight:bold; color:var(--primary); font-size:var(--font-size-xl); margin:0;">${Utils.formatCurrency(prop.price)}<span style="font-weight:400; font-size: var(--font-size-base); color:var(--muted-foreground)">/bulan</span></p><button class="btn btn-primary btn-lg" data-action="rent" data-id="${prop.id}" ${!prop.available ? 'disabled' : ''}><i class="bi bi-calendar2-plus"></i> Sewa Sekarang</button></div></div><div class="card" style="margin-top: var(--spacing-5);"><h2 class="card-title">Ulasan & Penilaian (${reviews.length})</h2><div id="review-list" class="review-list">${reviews.length > 0 ? reviews.map(this.reviewItem).join('') : '<p style="color: var(--muted-foreground);">Belum ada ulasan untuk properti ini. Jadilah yang pertama!</p>'}</div><form id="reviewForm" novalidate style="margin-top: var(--spacing-4); border-top: 1px solid var(--border); padding-top: var(--spacing-4);"><h3 style="margin-bottom: var(--spacing-3);">Tulis Ulasan Anda</h3><div class="form-group"><textarea id="reviewText" class="form-control" placeholder="Bagikan pengalaman Anda menyewa properti ini..." required></textarea><div class="invalid-feedback">Ulasan tidak boleh kosong.</div></div><button type="submit" class="btn btn-primary">Kirim Ulasan</button></form></div></div>`;
                },
                reviewItem: (review) => `<li class="review-item"><img src="${review.avatar}" alt="Avatar ${review.user}" class="review-avatar"><div class="review-content"><p><strong>${Utils.sanitizeHTML(review.user)}</strong></p><p>${Utils.sanitizeHTML(review.text)}</p></div></li>`,
                bookings() {
                    return `<div class="page-content"><h1>Histori Booking & Aktivitas</h1><div class="card"><div class="card-header"><h2 class="card-title">Semua Transaksi Anda</h2><a href="#properties" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Sewa Properti Baru</a></div><div class="table-container"><table id="bookingTable"><thead><tr><th>ID</th><th>Properti</th><th>Tanggal Booking</th><th>Status</th><th>Aksi</th></tr></thead><tbody id="bookingTableBody">${AppState.bookings.map(b => `<tr data-id="${b.id}"><td>#${b.id.toString().slice(-6)}</td><td><a href="#properties/${b.propertyId}">${Utils.sanitizeHTML(b.propertyTitle)}</a></td><td>${Utils.formatDate(b.date)}</td><td><span class="badge ${b.status === 'Aktif' ? 'badge-success' : (b.status === 'Pending' ? 'badge-warning' : 'badge-secondary')}">${b.status}</span></td><td><button class="btn btn-danger btn-sm" data-action="delete-booking" data-id="${b.id}" aria-label="Batalkan Booking" ${b.status !== 'Aktif' ? 'disabled' : ''}><i class="bi bi-trash"></i></button></td></tr>`).join('') || `<tr><td colspan="5" style="text-align:center;">Belum ada data booking.</td></tr>`}</tbody></table></div></div></div>`;
                },
                settings() {
                    const user = AppState.currentUser;
                    return `<div class="page-content"><h1>Profil & Pengaturan Akun</h1><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-5);"><div class="card"><h2 class="card-title">Informasi Pribadi</h2><p class="text-muted" style="color:var(--muted-foreground); margin-top:-5px; margin-bottom:var(--spacing-4)">Perbarui informasi Anda di sini. Klik foto untuk menggantinya.</p><form id="profileForm" novalidate><div style="text-align:center; margin-bottom:var(--spacing-4);"><img src="${user.avatar}" alt="Avatar saat ini" class="avatar-upload-preview" data-action="change-avatar" id="avatarPreview"></div><div class="form-group"><label for="profileName" class="form-label">Nama</label><input type="text" id="profileName" class="form-control" required value="${Utils.sanitizeHTML(user.name)}"><div class="invalid-feedback">Nama tidak boleh kosong.</div></div><div class="form-group"><label for="profileEmail" class="form-label">Email</label><input type="email" id="profileEmail" class="form-control" value="${Utils.sanitizeHTML(user.email)}" disabled><small style="color:var(--muted-foreground);">Email tidak dapat diubah.</small></div><button type="submit" class="btn btn-primary">Simpan Perubahan</button></form></div><div class="card"><h2 class="card-title">Keamanan & Kontak</h2><div class="form-group"><label for="whatsapp" class="form-label">Nomor WhatsApp</label><div style="display:flex; gap:var(--spacing-2);"><input type="tel" id="whatsapp" class="form-control" value="${Utils.sanitizeHTML(user.whatsapp)}" placeholder="Contoh: 0812..."><button class="btn btn-secondary" data-action="update-whatsapp">Simpan</button></div></div><div class="form-group"><label class="form-label">Upload KTP</label>${user.ktpUploaded ? `<div style="display:flex; align-items:center; gap:var(--spacing-2); color:var(--success);"><i class="bi bi-check-circle-fill"></i><span>KTP sudah terverifikasi.</span></div>` : `<button class="btn btn-secondary" data-action="upload-ktp"><i class="bi bi-cloud-arrow-up-fill"></i> Upload KTP (sekali saja)</button>`}</div><div class="form-group"><label class="form-label">Ubah Password</label><button class="btn btn-secondary" data-action="change-password">Ubah Password Anda</button></div></div></div></div>`;
                },
                payment(property) {
                    if (!property) return `<div class="page-content"><div class="card"><h1 style="margin-bottom: var(--spacing-4);">Pembayaran</h1><p>Properti tidak ditemukan. Silakan pilih properti dari halaman <a href="#properties">Properti</a>.</p></div></div>`;
                    return `<div class="page-content"><h1>Pembayaran Sewa</h1><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-4); align-items: flex-start;"><div class="card"><h2 class="card-title">Detail Pesanan</h2><div class="receipt-content"><div class="item"><span>Properti:</span> <strong>${Utils.sanitizeHTML(property.title)}</strong></div><div class="item"><span>Lokasi:</span> <span>${Utils.sanitizeHTML(property.location)}</span></div><div class="item"><span>Durasi:</span> <span>1 Bulan</span></div><div class="item total" style="margin-top:var(--spacing-3)"><span>Total Bayar:</span> <span>${Utils.formatCurrency(property.price)}</span></div></div></div><div class="card"><h2 class="card-title">Pilih Metode Pembayaran</h2><div id="payment-gateway" class="payment-options"><div class="payment-option" data-method="ewallet"><i class="bi bi-wallet2"></i><span>E-Wallet</span></div><div class="payment-option" data-method="qris"><i class="bi bi-qr-code-scan"></i><span>QRIS</span></div><div class="payment-option" data-method="transfer"><i class="bi bi-bank"></i><span>Bank Transfer</span></div></div><div id="payment-details" style="margin-top: var(--spacing-4); min-height: 100px; transition: all 0.3s ease;"><p style="color: var(--muted-foreground); text-align: center; padding-top: var(--spacing-4);">Pilih salah satu metode pembayaran di atas.</p></div><div class="modal-footer" style="padding:0; margin-top:var(--spacing-4); border:0;"><button id="confirmPaymentBtn" class="btn btn-primary" data-propid="${property.id}" data-propname="${Utils.sanitizeHTML(property.title)}" data-propprice="${property.price}" disabled>Konfirmasi Pembayaran</button></div></div></div></div>`;
                },
            };

            /**
             * =========================================================================
             * 7. LOGIC/CONTROLLER LAYER: Otak Aplikasi
             * Mengelola interaksi pengguna, memanggil API, dan memerintahkan UI untuk
             * merender tampilan. Di sini semua alur logika utama berada.
             * =========================================================================
             */
            const DOM = {};

            const UI = {
                render(container, content) { container.innerHTML = content; },
                toggleSidebar(forceState) { const show = forceState !== undefined ? forceState : !document.body.classList.contains('sidebar-overlay-open'); DOM.sidebar.classList.toggle('show', show); document.body.classList.toggle('sidebar-overlay-open', show); },
                toggleProfileDropdown(forceState) { const show = forceState !== undefined ? forceState : !DOM.profileDropdownMenu.classList.contains('show'); DOM.profileDropdownMenu.classList.toggle('show', show); DOM.profileDropdownToggle.setAttribute('aria-expanded', show); },
                applyTheme(theme) { document.documentElement.className = theme === 'dark' ? 'dark' : ''; DOM.themeToggleBtn.innerHTML = `<i class="bi bi-${theme === 'light' ? 'moon-fill' : 'sun-fill'}"></i>`; localStorage.setItem('theme', theme); AppState.theme = theme; },
                updateUserInfo() {
                    if (AppState.currentUser) {
                        DOM.usernameDisplay.textContent = AppState.currentUser.name;
                        DOM.userAvatar.src = AppState.currentUser.avatar;
                        DOM.userAvatar.alt = `Avatar ${AppState.currentUser.name}`;
                    }
                },
                showToast(message, type = 'success', duration = 4000) {
                    const toast = document.createElement('div');
                    toast.className = `toast toast-${type}`;
                    toast.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle-fill' : 'exclamation-triangle-fill'}"></i> ${Utils.sanitizeHTML(message)}`;
                    DOM.toastContainer.appendChild(toast);
                    setTimeout(() => toast.classList.add('show'), 10);
                    setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, duration);
                },
                showModal(id, title, content, footer, extraClasses = '') {
                    if (document.getElementById(`${id}Overlay`)) return;
                    DOM.modalContainer.insertAdjacentHTML('beforeend', Templates.modal(id, title, content, footer, extraClasses));
                    const modalOverlay = document.getElementById(`${id}Overlay`);
                    setTimeout(() => modalOverlay.classList.add('show'), 10);
                    modalOverlay.addEventListener('click', e => { if (e.target === modalOverlay || e.target.closest('[data-dismiss="modal"]')) this.closeModal(id); });
                },
                closeModal(id) {
                    const modalOverlay = document.getElementById(`${id}Overlay`);
                    if (modalOverlay) { modalOverlay.classList.remove('show'); modalOverlay.addEventListener('transitionend', () => modalOverlay.remove()); }
                },
            };

            const App = {
                init() {
                    Object.assign(DOM, { authContainer: document.getElementById('auth-container'), appContainer: document.getElementById('app-container'), sidebar: document.getElementById('sidebar'), sidebarToggle: document.getElementById('sidebarToggle'), themeToggleBtn: document.getElementById('themeToggleBtn'), profileDropdownToggle: document.getElementById('profileDropdownToggle'), profileDropdownMenu: document.getElementById('profileDropdownMenu'), logoutButton: document.getElementById('logoutButton'), pageContentContainer: document.getElementById('pageContentContainer'), navMenu: document.getElementById('navMenu'), usernameDisplay: document.getElementById('usernameDisplay'), userAvatar: document.getElementById('userAvatar'), toastContainer: document.getElementById('toast-container'), modalContainer: document.getElementById('modal-container'), headerSearchInput: document.getElementById('headerSearchInput') });
                    UI.applyTheme(AppState.theme);
                    this.setupEventListeners();
                    Router.init();
                },

                setupEventListeners() {
                    DOM.sidebarToggle.addEventListener('click', () => UI.toggleSidebar());
                    DOM.themeToggleBtn.addEventListener('click', () => UI.applyTheme(AppState.theme === 'light' ? 'dark' : 'light'));
                    DOM.profileDropdownToggle.addEventListener('click', e => { e.stopPropagation(); UI.toggleProfileDropdown(); });
                    DOM.headerSearchInput.addEventListener('input', e => this.handleGlobalSearch(e.target.value));
                    document.body.addEventListener('click', e => {
                        const navLink = e.target.closest('a.nav-link[data-page]');
                        if (navLink) {
                            e.preventDefault();
                            if (window.location.hash !== navLink.getAttribute('href')) window.location.hash = navLink.getAttribute('href');
                            if (window.innerWidth <= 1024) UI.toggleSidebar(false);
                            return;
                        }
                        if (e.target.closest('#logoutButton')) { e.preventDefault(); API.logout(); Router.handleRouteChange(); UI.showToast('Anda telah berhasil keluar.'); return; }
                        if (!e.target.closest('.profile-dropdown')) UI.toggleProfileDropdown(false);
                        this.handleGlobalActions(e);
                    });
                    DOM.authContainer.addEventListener('submit', e => this.handleAuthForm(e));
                    DOM.pageContentContainer.addEventListener('submit', e => {
                        if (e.target.id === 'profileForm') this.handleProfileUpdate(e);
                        if (e.target.id === 'reviewForm') this.handleReviewSubmit(e);
                    });
                },

                async navigateTo(pageId, param) {
                    const validPages = ['dashboard', 'properties', 'bookings', 'settings', 'payment'];
                    if (!validPages.includes(pageId)) pageId = 'dashboard';
                    AppState.activePage = pageId;
                    UI.render(DOM.pageContentContainer, Templates.loadingPlaceholder());
                    await Promise.all([API.fetchProperties(), API.fetchBookings()]);

                    let pageContent = '';
                    switch (pageId) {
                        case 'properties':
                            if (param) {
                                const [prop, reviews] = await Promise.all([API.fetchPropertyById(param), API.fetchReviewsForProperty(param)]);
                                pageContent = Templates.propertyDetail(prop, reviews);
                            } else { pageContent = Templates.properties(); }
                            break;
                        case 'payment':
                            const propToPay = await API.fetchPropertyById(param);
                            pageContent = Templates.payment(propToPay);
                            break;
                        default:
                            if (typeof Templates[pageId] === 'function') pageContent = Templates[pageId]();
                            break;
                    }

                    UI.render(DOM.pageContentContainer, pageContent);
                    DOM.navMenu.querySelectorAll('.nav-link').forEach(link => link.classList.toggle('active', link.dataset.page === pageId));
                    document.title = `Green Valley - ${pageId.charAt(0).toUpperCase() + pageId.slice(1)}`;
                    UI.updateUserInfo();
                    this.postRenderSetup(pageId);
                },

                postRenderSetup(pageId) {
                    if (pageId === 'properties' && !window.location.hash.includes('/')) {
                        const pageSearchInput = document.getElementById('pageSearchInput');
                        const categoryFilter = document.getElementById('categoryFilter');
                        if (pageSearchInput) pageSearchInput.addEventListener('input', () => this.handlePropertyFilter());
                        if (categoryFilter) categoryFilter.addEventListener('change', () => this.handlePropertyFilter());
                    }
                    if (pageId === 'payment') {
                        const paymentGateway = document.getElementById('payment-gateway');
                        if (paymentGateway) paymentGateway.addEventListener('click', e => { const opt = e.target.closest('.payment-option'); if (opt) this.handlePaymentMethod(opt); });
                        const confirmBtn = document.getElementById('confirmPaymentBtn');
                        if (confirmBtn) confirmBtn.addEventListener('click', e => this.handleConfirmPayment(e));
                    }
                },

                handleGlobalActions(e) {
                    const target = e.target.closest('[data-action]');
                    if (!target) return;
                    e.preventDefault();
                    const { action, id, src } = target.dataset;

                    const actionHandlers = {
                        'view-details': () => window.location.hash = `#properties/${id}`,
                        'rent': () => AppState.currentUser.ktpUploaded ? (window.location.hash = `#payment/${id}`) : UI.showToast('Harap upload KTP Anda terlebih dahulu di halaman Profil & Akun.', 'danger'),
                        'delete-booking': () => this.confirmDeleteBooking(id),
                        'change-avatar': () => this.showAvatarModal(),
                        'zoom-image': () => this.showImageZoomModal(src),
                        'zoom-profile-pic': () => this.showImageZoomModal(DOM.userAvatar.src),
                        'forgot-password': () => UI.showModal('forgotPasswordModal', 'Lupa Password', '<p>Fitur ini memerlukan integrasi backend. Dalam aplikasi nyata, Anda akan diminta memasukkan email untuk menerima link reset password.</p>', `<button type="button" class="btn btn-secondary" data-dismiss="modal">Mengerti</button>`),
                        'change-password': () => UI.showModal('changePasswordModal', 'Ubah Password', '<p>Fitur ini memerlukan integrasi backend. Form untuk mengubah password akan ditampilkan di sini.</p>', `<button type="button" class="btn btn-secondary" data-dismiss="modal">Mengerti</button>`),
                        'upload-ktp': () => UI.showModal('uploadKtpModal', 'Upload KTP', '<p>Fitur ini memerlukan backend untuk menyimpan dan memverifikasi file dengan aman. Setelah upload berhasil, status profil Anda akan diperbarui.</p>', `<button type="button" class="btn btn-primary" id="confirmKtpUpload">Simulasikan Upload</button>`),
                        'update-whatsapp': async () => {
                            const input = document.getElementById('whatsapp');
                            if (input && input.value) {
                                await API.updateProfile({ whatsapp: input.value });
                                UI.showToast('Nomor WhatsApp berhasil diperbarui!', 'success');
                            }
                        },
                    };
                    if (actionHandlers[action]) actionHandlers[action]();

                    if (action === 'upload-ktp') {
                        const confirmBtn = document.getElementById('confirmKtpUpload');
                        if (confirmBtn) confirmBtn.onclick = async () => {
                            await API.updateProfile({ ktpUploaded: true });
                            UI.closeModal('uploadKtpModal');
                            UI.showToast('Simulasi upload KTP berhasil! Anda kini bisa menyewa.', 'success');
                            await this.navigateTo('settings');
                        };
                    }
                },

                handleGlobalSearch: (term) => (window.location.hash = '#properties', setTimeout(() => { const input = document.getElementById('pageSearchInput'); if (input) { input.value = term; input.dispatchEvent(new Event('input')); } }, 100)),

                handlePropertyFilter() {
                    const searchTerm = (document.getElementById('pageSearchInput')?.value || '').toLowerCase();
                    const category = document.getElementById('categoryFilter')?.value || '';
                    const filtered = AppState.properties.filter(prop => {
                        const matchSearch = prop.title.toLowerCase().includes(searchTerm) || prop.location.toLowerCase().includes(searchTerm) || prop.price.toString().includes(searchTerm);
                        const matchCategory = category ? prop.category === category : true;
                        return matchSearch && matchCategory;
                    });
                    const grid = document.getElementById('propertiesGrid');
                    if (grid) grid.innerHTML = Templates.propertyCards(filtered);
                },

                async handleAuthForm(e) {
                    e.preventDefault();
                    const form = e.target;
                    if (!form.checkValidity()) { form.classList.add('was-validated'); Array.from(form.elements).forEach(el => el.classList.toggle('is-invalid', !el.checkValidity())); UI.showToast('Harap isi semua kolom dengan benar.', 'danger'); return; }
                    const type = form.id.replace('Form', '');
                    const btn = form.querySelector('button[type="submit"]');
                    btn.disabled = true;
                    btn.innerHTML = '<i class="bi bi-arrow-repeat spinner"></i> Memproses...';
                    const result = type === 'login' ? await API.login(form.loginEmail.value, form.loginPassword.value) : await API.register(form.registerName.value, form.registerEmail.value, form.registerPassword.value);
                    if (result.success) { Router.handleRouteChange(); UI.showToast(`Selamat datang, ${result.user.name}!`, 'success'); }
                    else { UI.showToast(result.message, 'danger'); btn.disabled = false; btn.textContent = type === 'login' ? 'Masuk' : 'Daftar'; }
                },

                async handleProfileUpdate(e) {
                    e.preventDefault();
                    const form = e.target;
                    if (!form.checkValidity()) { form.classList.add('was-validated'); return; }
                    const newName = form.querySelector('#profileName').value.trim();
                    if (newName !== AppState.currentUser.name) {
                        await API.updateProfile({ name: newName });
                        UI.updateUserInfo();
                        UI.showToast('Nama berhasil diperbarui!', 'success');
                    } else { UI.showToast('Tidak ada perubahan yang disimpan.', 'warning'); }
                },

                async handleReviewSubmit(e) {
                    e.preventDefault();
                    const form = e.target;
                    const textarea = form.querySelector('#reviewText');
                    if (!form.checkValidity()) { textarea.classList.add('is-invalid'); return; }
                    const propertyId = window.location.hash.split('/')[1];
                    const newReview = { user: AppState.currentUser.name, avatar: AppState.currentUser.avatar, text: textarea.value };
                    await API.addReview(propertyId, newReview);
                    document.getElementById('review-list').insertAdjacentHTML('afterbegin', Templates.reviewItem(newReview));
                    form.reset();
                    textarea.classList.remove('is-invalid');
                    UI.showToast('Ulasan Anda berhasil dikirim!', 'success');
                },

                handlePaymentMethod(selectedOption) {
                    document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
                    selectedOption.classList.add('selected');
                    const method = selectedOption.dataset.method;
                    const detailsContainer = document.getElementById('payment-details');
                    let content = '';
                    switch (method) {
                        case 'ewallet': content = '<p style="text-align:center;">Buka aplikasi e-wallet Anda (GoPay, OVO, Dana) dan bayar ke nomor <strong>081234567890</strong> a/n PT Green Valley.</p>'; break;
                        case 'qris': content = '<div class="qr-code-container"><p style="text-align:center;">Pindai QR code ini menggunakan aplikasi banking atau e-wallet Anda:</p><img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=PembayaranSewaGreenValley" alt="QR Code Pembayaran"></div>'; break;
                        case 'transfer': content = '<p style="text-align:center;">Transfer ke rekening <strong>BCA</strong><br>No. Rek: <strong>123-456-7890</strong><br>a/n: <strong>PT Green Valley Properti</strong></p>'; break;
                    }
                    detailsContainer.innerHTML = content;
                    document.getElementById('confirmPaymentBtn').disabled = false;
                },

                handleConfirmPayment(e) {
                    const { propid, propname, propprice } = e.target.dataset;
                    const title = 'Konfirmasi Pembayaran Berhasil';
                    const content = `<div id="printable-area"><div class="sidebar-brand" style="justify-content: center; margin-bottom: var(--spacing-4);"><i class="bi bi-buildings-fill"></i><span>Green Valley</span></div><h3 style="text-align:center; font-weight: 500;">BUKTI PEMBAYARAN</h3><hr style="margin: var(--spacing-3) 0; border-color: var(--border);"><div class="receipt-content"><div class="item"><span>ID Transaksi:</span> <span>TRX${Date.now()}</span></div><div class="item"><span>Tanggal:</span> <span>${Utils.formatDate(new Date())}</span></div><div class="item"><span>Penyewa:</span> <span>${Utils.sanitizeHTML(AppState.currentUser.name)}</span></div><div class="item"><span>Properti:</span> <span>${propname}</span></div><div class="item total"><span>Total Bayar:</span> <span>${Utils.formatCurrency(propprice)}</span></div></div><p style="text-align:center; margin-top: var(--spacing-4); font-size: var(--font-size-sm); color: var(--muted-foreground);">Terima kasih! Tim kami akan segera menghubungi Anda untuk proses selanjutnya.</p></div>`;
                    const footer = `<button type="button" class="btn btn-secondary" data-dismiss="modal">Tutup</button><button type="button" class="btn btn-primary" onclick="window.print()"><i class="bi bi-printer"></i> Cetak Struk</button>`;
                    API.addBooking({ tenant: AppState.currentUser.name, propertyId: propid, propertyTitle: propname, date: new Date().toISOString() });
                    UI.showModal('receiptModal', title, content, footer);
                    window.location.hash = "#bookings";
                },

                confirmDeleteBooking(id) {
                    const booking = AppState.bookings.find(b => b.id == id);
                    if (!booking) return;
                    const content = `<p>Anda yakin ingin membatalkan booking untuk properti <strong>${Utils.sanitizeHTML(booking.propertyTitle)}</strong>?</p>`;
                    const footer = `<button type="button" class="btn btn-secondary" data-dismiss="modal">Tidak</button><button type="button" class="btn btn-danger" id="confirmDeleteBtn">Ya, Batalkan</button>`;
                    UI.showModal('deleteConfirmModal', 'Konfirmasi Pembatalan', content, footer);
                    document.getElementById('confirmDeleteBtn').onclick = async () => { await API.deleteBooking(id); UI.closeModal('deleteConfirmModal'); UI.showToast('Booking berhasil dibatalkan.', 'success'); await this.navigateTo('bookings'); };
                },

                showAvatarModal() {
                    const content = `<form id="avatarUploadForm"><input type="file" id="avatarUploadInput" accept="image/*"><label for="avatarUploadInput"><img src="${AppState.currentUser.avatar}" alt="Pratinjau avatar" class="avatar-upload-preview" id="avatarUploadPreview"></label><p style="text-align:center; color: var(--muted-foreground);">Klik pada gambar untuk memilih foto baru.</p></form>`;
                    const footer = `<button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button><button type="button" class="btn btn-primary" id="saveAvatarBtn" disabled>Simpan</button>`;
                    UI.showModal('avatarModal', 'Ganti Foto Profil', content, footer);
                    const input = document.getElementById('avatarUploadInput'), preview = document.getElementById('avatarUploadPreview'), saveBtn = document.getElementById('saveAvatarBtn');
                    input.onchange = () => { if (input.files[0]) { const reader = new FileReader(); reader.onload = e => { preview.src = e.target.result; saveBtn.disabled = false; }; reader.readAsDataURL(input.files[0]); } };
                    saveBtn.onclick = async () => { await API.updateProfile({ avatar: preview.src }); UI.updateUserInfo(); const settingsAvatar = document.getElementById('avatarPreview'); if (settingsAvatar) settingsAvatar.src = preview.src; UI.closeModal('avatarModal'); UI.showToast('Foto profil berhasil diperbarui!', 'success'); };
                },

                showImageZoomModal: (url) => UI.showModal('imageZoomModal', '', `<img src="${url}" alt="Gambar diperbesar" class="zoomed-image">`, null, 'image-zoom-modal'),
            };

            /**
             * =========================================================================
             * 8. ROUTING LAYER: Navigasi Single Page Application
             * Mengelola perubahan URL (hash) dan memicu pembaruan halaman yang sesuai.
             * =========================================================================
             */
            const Router = {
                init() {
                    window.addEventListener('hashchange', () => this.handleRouteChange());
                    this.handleRouteChange();
                },
                async handleRouteChange() {
                    UI.toggleProfileDropdown(false);
                    const hash = window.location.hash.slice(1) || (AppState.isAuthenticated ? 'dashboard' : 'login');
                    const [page, param] = hash.split('/');
                    const isAuthPage = ['login', 'register'].includes(page);
                    if (!AppState.isAuthenticated && !isAuthPage) { window.location.hash = 'login'; return; }
                    if (AppState.isAuthenticated && isAuthPage) { window.location.hash = 'dashboard'; return; }

                    DOM.appContainer.style.display = AppState.isAuthenticated ? 'flex' : 'none';
                    DOM.authContainer.style.display = AppState.isAuthenticated ? 'none' : 'block';

                    if (AppState.isAuthenticated) await App.navigateTo(page, param);
                    else UI.render(DOM.authContainer, Templates.auth(page));
                },
            };

            document.addEventListener('DOMContentLoaded', () => App.init());
        })();
    </script>

</body>

</html>