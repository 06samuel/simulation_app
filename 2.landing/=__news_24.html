<!DOCTYPE html>
<html lang="id" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description"
        content="Green Valley - Temukan hunian impian Anda dengan apartemen modern dan fasilitas lengkap di lokasi strategis.">
    <meta name="keywords" content="apartemen, hunian, properti, green valley, sewa apartemen, beli apartemen">
    <meta name="author" content="Green Valley Premier Properties">
    <meta name="theme-color" content="#2ecc71">
    <title>Green Valley - Hunian Impian Anda</title>

    <!-- Favicon - Menggunakan ikon emoji sebagai contoh sederhana, bisa diganti dengan file .ico atau .png -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè°</text></svg>">

    <!-- Font Awesome Icons (Online Gratis) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Google Fonts (Inter & Poppins) -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@500;600;700;800&display=swap"
        rel="stylesheet">

    <style>
        /* === Variabel Global & Tema === */
        :root {
            --primary-color: #2ecc71;
            /* Hijau segar */
            --primary-color-darker: #27ae60;
            --secondary-color: #f1c40f;
            /* Kuning cerah */
            --secondary-color-darker: #f39c12;
            --accent-color: #3498db;
            /* Biru modern */
            --accent-color-darker: #2980b9;

            --text-color: #34495e;
            /* Abu-abu tua untuk teks */
            --text-color-light: #7f8c8d;
            --bg-color: #ecf0f1;
            /* Abu-abu sangat muda untuk latar belakang */
            --card-bg: #ffffff;
            --border-color: #bdc3c7;
            --success-color: #27ae60;
            --error-color: #e74c3c;
            --warning-color: #f39c12;

            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.1);

            --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);

            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 16px;

            --spacing-xs: 0.25rem;
            /* 4px */
            --spacing-sm: 0.5rem;
            /* 8px */
            --spacing-md: 1rem;
            /* 16px */
            --spacing-lg: 1.5rem;
            /* 24px */
            --spacing-xl: 2rem;
            /* 32px */
            --spacing-xxl: 3rem;
            /* 48px */

            --font-family-primary: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --font-family-secondary: 'Poppins', sans-serif;

            --header-height: 70px;
        }

        [data-theme="dark"] {
            --primary-color: #55efc4;
            --primary-color-darker: #00b894;
            --secondary-color: #fdcb6e;
            --secondary-color-darker: #e1b12c;
            --accent-color: #74b9ff;
            --accent-color-darker: #0984e3;

            --text-color: #ecf0f1;
            --text-color-light: #bdc3c7;
            --bg-color: #2c3e50;
            /* Biru tua sebagai latar belakang gelap */
            --card-bg: #34495e;
            /* Abu-abu sedikit lebih terang untuk kartu */
            --border-color: #7f8c8d;
            --success-color: #55efc4;
            --error-color: #ff7675;
            --warning-color: #fdcb6e;

            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.15);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.25);
        }

        /* === Reset & Pengaturan Dasar === */
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family-primary);
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color var(--transition-normal), color var(--transition-normal);
            line-height: 1.6;
        }

        /* === Utilitas === */
        .container {
            width: 90%;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
            padding: var(--spacing-lg);
        }

        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-primary {
            color: var(--primary-color);
        }

        .mb-1 {
            margin-bottom: var(--spacing-sm);
        }

        .mb-2 {
            margin-bottom: var(--spacing-md);
        }

        .mb-3 {
            margin-bottom: var(--spacing-lg);
        }

        .mt-1 {
            margin-top: var(--spacing-sm);
        }

        .mt-2 {
            margin-top: var(--spacing-md);
        }

        .mt-3 {
            margin-top: var(--spacing-lg);
        }

        /* === Animasi === */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s var(--transition-normal) forwards;
        }

        @keyframes slideInModal {
            from {
                transform: translateY(-30px) scale(0.95);
                opacity: 0;
            }

            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        /* === Header === */
        header {
            background-color: var(--card-bg);
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            height: var(--header-height);
            transition: background-color var(--transition-normal), box-shadow var(--transition-normal);
        }

        header .container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 100%;
            padding-top: 0;
            padding-bottom: 0;
        }

        .brand {
            font-family: var(--font-family-secondary);
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            text-decoration: none;
        }

        .brand i {
            font-size: 2rem;
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: var(--spacing-sm);
        }

        .nav-link,
        .nav-button {
            color: var(--text-color-light);
            text-decoration: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            font-weight: 600;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .nav-link i,
        .nav-button i {
            font-size: 1.1rem;
            width: 20px;
            /* Untuk alignment yang konsisten */
            text-align: center;
        }

        .nav-link:hover,
        .nav-button:hover,
        .nav-link.active {
            background-color: var(--primary-color);
            color: #fff;
        }

        .nav-link.active {
            box-shadow: var(--shadow-sm);
        }

        .notification-indicator {
            position: relative;
        }

        .notification-count {
            position: absolute;
            top: 2px;
            right: 2px;
            background-color: var(--secondary-color);
            color: #fff;
            border-radius: 50%;
            padding: 0px 5px;
            font-size: 0.7rem;
            font-weight: 700;
            border: 2px solid var(--card-bg);
            display: none;
            /* Ditampilkan oleh JS */
        }

        /* === Main Content === */
        main {
            flex-grow: 1;
            padding-top: var(--spacing-xl);
            padding-bottom: var(--spacing-xl);
            transition: opacity var(--transition-slow);
        }

        /* === Footer === */
        footer {
            background-color: var(--card-bg);
            padding: var(--spacing-lg) 0;
            text-align: center;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.07);
            font-size: 0.9rem;
            color: var(--text-color-light);
            transition: background-color var(--transition-normal), box-shadow var(--transition-normal);
        }

        /* === Tombol (Buttons) === */
        .btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            font-weight: 600;
            font-size: 1rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            box-shadow: var(--shadow-sm);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: #fff;
        }

        .btn-primary:hover {
            background-color: var(--primary-color-darker);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: #fff;
        }

        .btn-secondary:hover {
            background-color: var(--secondary-color-darker);
        }

        .btn-accent {
            background-color: var(--accent-color);
            color: #fff;
        }

        .btn-accent:hover {
            background-color: var(--accent-color-darker);
        }

        .btn-outline {
            background-color: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .btn-outline:hover {
            background-color: var(--primary-color);
            color: #fff;
        }

        /* === Kartu (Cards) === */
        .card {
            background-color: var(--card-bg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--spacing-lg);
            transition: var(--transition-normal);
            overflow: hidden;
            /* Untuk border-radius pada gambar */
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .card img {
            width: 100%;
            height: 220px;
            object-fit: cover;
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
            display: block;
        }

        .card h3 {
            font-family: var(--font-family-secondary);
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--primary-color);
        }

        .card h4 {
            font-family: var(--font-family-secondary);
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .card p {
            font-size: 0.95rem;
            color: var(--text-color-light);
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .card p i {
            color: var(--accent-color);
            font-size: 1rem;
        }

        /* === Grid Properti === */
        .property-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: var(--spacing-lg);
        }

        /* === Formulir (Forms) === */
        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-label {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: var(--spacing-sm);
            display: block;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background-color: var(--bg-color);
            /* Sedikit berbeda dari card-bg untuk kontras */
            color: var(--text-color);
            transition: var(--transition-fast);
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 20%, transparent);
            background-color: var(--card-bg);
        }

        .form-control.is-invalid {
            border-color: var(--error-color);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--error-color) 20%, transparent);
        }

        .invalid-feedback {
            color: var(--error-color);
            font-size: 0.8rem;
            margin-top: var(--spacing-xs);
            display: none;
        }

        .form-control.is-invalid~.invalid-feedback {
            display: block;
        }

        /* === Modal === */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.65);
            /* Lebih gelap untuk fokus */
            backdrop-filter: blur(5px);
            display: none;
            /* Diubah oleh JS */
            align-items: center;
            justify-content: center;
            z-index: 1050;
            padding: var(--spacing-md);
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            max-width: 600px;
            width: 100%;
            animation: slideInModal 0.4s var(--transition-normal) forwards;
            box-shadow: var(--shadow-lg);
            position: relative;
            /* Untuk modal-close */
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-family: var(--font-family-secondary);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.8rem;
            /* Lebih besar untuk mudah diklik */
            cursor: pointer;
            color: var(--text-color-light);
            transition: var(--transition-fast);
            padding: var(--spacing-xs);
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--error-color);
            transform: rotate(90deg);
        }

        .modal-body p {
            margin-bottom: var(--spacing-sm);
        }

        .modal-body img {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
        }

        /* === Hero Section === */
        .hero {
            text-align: center;
            padding: var(--spacing-xxl) var(--spacing-lg);
            background: linear-gradient(135deg, color-mix(in srgb, var(--primary-color) 80%, black), color-mix(in srgb, var(--accent-color) 80%, black)),
                url('https://source.unsplash.com/random/1600x900/?modern,architecture,city') no-repeat center center/cover;
            background-blend-mode: multiply;
            color: #fff;
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-xxl);
            box-shadow: var(--shadow-lg);
        }

        .hero h2 {
            font-family: var(--font-family-secondary);
            font-size: 2.8rem;
            font-weight: 800;
            margin-bottom: var(--spacing-md);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .hero p {
            font-size: 1.2rem;
            margin-bottom: var(--spacing-lg);
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            opacity: 0.9;
        }

        /* === Dashboard Summary === */
        .dashboard-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .summary-card {
            background-color: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            text-align: center;
            box-shadow: var(--shadow-md);
            transition: var(--transition-normal);
        }

        .summary-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .summary-card i {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: var(--spacing-sm);
            display: block;
        }

        .summary-card h4 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color-light);
            margin-bottom: var(--spacing-xs);
        }

        .summary-card p {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-color);
            margin: 0;
        }

        /* === Notifikasi === */
        .notification-item {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            transition: background-color var(--transition-fast);
            cursor: pointer;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item:hover {
            background-color: color-mix(in srgb, var(--primary-color) 5%, transparent);
        }

        .notification-item.unread {
            background-color: color-mix(in srgb, var(--primary-color) 10%, transparent);
            font-weight: 600;
        }

        .notification-item p {
            font-size: 0.95rem;
            margin-bottom: var(--spacing-xs);
        }

        .notification-item small {
            font-size: 0.8rem;
            color: var(--text-color-light);
        }

        .notification-item.info {
            border-left: 4px solid var(--accent-color);
        }

        .notification-item.success {
            border-left: 4px solid var(--success-color);
        }

        .notification-item.warning {
            border-left: 4px solid var(--warning-color);
        }

        .notification-item.error {
            border-left: 4px solid var(--error-color);
        }

        /* === Pencarian === */
        .search-form {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
            align-items: flex-end;
        }

        .search-form .form-group {
            flex-grow: 1;
            margin-bottom: 0;
        }

        /* === Section Title === */
        .section-title {
            font-family: var(--font-family-secondary);
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: var(--spacing-lg);
            text-align: center;
            position: relative;
            padding-bottom: var(--spacing-sm);
        }

        .section-title::after {
            content: '';
            display: block;
            width: 60px;
            height: 4px;
            background-color: var(--primary-color);
            margin: var(--spacing-sm) auto 0;
            border-radius: var(--radius-sm);
        }

        /* === Responsivitas === */
        @media (max-width: 991px) {
            .brand {
                font-size: 1.6rem;
            }

            nav ul {
                display: none;
                /* Sembunyikan di mobile, bisa di-toggle dengan JS jika diperlukan menu hamburger */
                /* Jika tetap ditampilkan:
                position: fixed; top: var(--header-height); left: 0; width: 100%;
                background-color: var(--card-bg); box-shadow: var(--shadow-md);
                flex-direction: column; padding: var(--spacing-md); gap: var(--spacing-sm);
                */
            }

            /* Placeholder untuk tombol menu mobile jika diperlukan */
            .mobile-menu-toggle {
                display: block;
                /* JS akan menghandle ini */
            }

            .property-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }

            .search-form {
                flex-direction: column;
                align-items: stretch;
            }

            .search-form .btn {
                width: 100%;
            }

            .hero h2 {
                font-size: 2.2rem;
            }

            .hero p {
                font-size: 1rem;
            }
        }

        @media (max-width: 576px) {
            .container {
                width: 95%;
                padding: var(--spacing-md);
            }

            .brand {
                font-size: 1.4rem;
            }

            .brand i {
                font-size: 1.6rem;
            }

            .hero h2 {
                font-size: 1.8rem;
            }

            .nav-link,
            .nav-button {
                padding: var(--spacing-sm);
                font-size: 0.9rem;
            }

            .nav-link i,
            .nav-button i {
                font-size: 1rem;
            }

            .modal-content {
                padding: var(--spacing-md);
            }

            .modal-title {
                font-size: 1.3rem;
            }

            .section-title {
                font-size: 1.6rem;
            }

            .btn {
                font-size: 0.9rem;
                padding: var(--spacing-sm) var(--spacing-md);
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="container">
            <a href="#home" class="brand" data-route="home"><i class="fas fa-leaf"></i> Green Valley</a>
            <nav id="mainNav">
                <ul>
                    <li><a href="#home" class="nav-link active" data-route="home" aria-label="Beranda"><i
                                class="fas fa-home"></i> Beranda</a></li>
                    <li><a href="#listings" class="nav-link" data-route="listings" aria-label="Daftar Properti"><i
                                class="fas fa-building"></i> Properti</a></li>
                    <li><a href="#dashboard" class="nav-link" data-route="dashboard" aria-label="Dashboard Manager"><i
                                class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    <li>
                        <button type="button" class="nav-button notification-indicator" id="notificationsButton"
                            aria-label="Notifikasi" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-bell"></i>
                            <span class="notification-count" id="notificationCountBadge" aria-live="polite">0</span>
                        </button>
                    </li>
                    <li>
                        <button type="button" class="nav-button" id="themeToggleBtn"
                            aria-label="Ganti Tema Gelap/Terang">
                            <i class="fas fa-moon"></i> <!-- Ikon akan diubah oleh JS -->
                        </button>
                    </li>
                </ul>
            </nav>
            <!-- Tombol menu mobile (bisa diaktifkan dengan JS jika navigasi kompleks) -->
            <!-- <button class="nav-button mobile-menu-toggle" aria-label="Buka Menu" aria-controls="mainNav" aria-expanded="false"><i class="fas fa-bars"></i></button> -->
        </div>
    </header>

    <main id="routerView" class="container" role="main"></main>

    <footer>
        <div class="container">
            <p>¬© <span id="currentYear">2024</span> Green Valley Premier Properties. Semua hak dilindungi.</p>
            <p>Dirancang dengan <i class="fas fa-heart text-primary"></i> untuk kenyamanan Anda.</p>
        </div>
    </footer>

    <!-- Templates untuk SPA -->
    <template id="homePageTemplate">
        <section id="home-page" class="fade-in">
            <div class="hero">
                <h2>Temukan Hunian Impian Anda di Green Valley</h2>
                <p>Apartemen modern dengan fasilitas premium, desain elegan, dan lokasi strategis untuk gaya hidup urban
                    yang dinamis.</p>
                <button class="btn btn-primary btn-lg" data-route="listings"><i class="fas fa-search"></i> Jelajahi
                    Properti</button>
            </div>

            <h3 class="section-title">Keunggulan Kami</h3>
            <div class="property-grid">
                <div class="card text-center">
                    <i class="fas fa-map-marker-alt fa-3x text-primary mb-2"></i>
                    <h4>Lokasi Strategis</h4>
                    <p>Akses mudah ke pusat bisnis, hiburan, dan transportasi publik terintegrasi.</p>
                </div>
                <div class="card text-center">
                    <i class="fas fa-shield-alt fa-3x text-primary mb-2"></i>
                    <h4>Fasilitas Premium & Aman</h4>
                    <p>Kolam renang, gym modern, area hijau, dan sistem keamanan 24/7.</p>
                </div>
                <div class="card text-center">
                    <i class="fas fa-couch fa-3x text-primary mb-2"></i>
                    <h4>Desain Modern & Nyaman</h4>
                    <p>Interior elegan, fungsional, dengan material berkualitas tinggi untuk kenyamanan maksimal.</p>
                </div>
            </div>
        </section>
    </template>

    <template id="listingsPageTemplate">
        <section id="listings-page" class="fade-in">
            <h2 class="section-title">Daftar Properti</h2>
            <form id="searchForm" class="search-form card" role="search">
                <div class="form-group">
                    <label for="searchLocation" class="form-label">Cari Properti Impian Anda</label>
                    <input type="search" id="searchLocation" class="form-control"
                        placeholder="Masukkan lokasi, nama properti, atau kata kunci...">
                </div>
                <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> Cari</button>
            </form>
            <div id="propertyListingsGrid" class="property-grid mt-3">
                <!-- Kartu properti akan dirender di sini oleh JS -->
            </div>
            <p id="noResultsMessage" class="hidden text-center mt-3">Properti yang Anda cari tidak ditemukan. Silakan
                coba kata kunci lain.</p>
        </section>
    </template>

    <template id="propertyCardTemplate">
        <article class="card property-item" data-id="{id}" lang="id">
            <img src="{gambar}" alt="Visual Properti {nama}">
            <h3>{nama}</h3>
            <p><i class="fas fa-map-pin"></i> {lokasi}</p>
            <p><i class="fas fa-money-bill-wave"></i> Rp {harga}/bulan</p>
            <p><i class="fas fa-check-circle {ketersediaanClass}"></i> {statusKetersediaan}</p>
            <button class="btn btn-accent view-details-btn" data-id="{id}" aria-label="Lihat detail untuk {nama}"><i
                    class="fas fa-eye"></i> Lihat Detail</button>
        </article>
    </template>

    <template id="dashboardPageTemplate">
        <section id="dashboard-page" class="fade-in">
            <h2 class="section-title">Dashboard Manager</h2>
            <div class="dashboard-summary">
                <div class="summary-card">
                    <i class="fas fa-building"></i>
                    <h4>Total Properti</h4>
                    <p id="dashboardTotalProperties">0</p>
                </div>
                <div class="summary-card">
                    <i class="fas fa-check-circle"></i>
                    <h4>Properti Tersedia</h4>
                    <p id="dashboardAvailableProperties">0</p>
                </div>
                <div class="summary-card">
                    <i class="fas fa-coins"></i>
                    <h4>Estimasi Pendapatan</h4>
                    <p id="dashboardEstimatedRevenue">Rp 0</p>
                </div>
            </div>
            <h3 class="mt-3 mb-2">Manajemen Properti Anda</h3>
            <div id="dashboardPropertyList" class="property-grid">
                <!-- Item properti dashboard akan dirender di sini -->
            </div>
        </section>
    </template>

    <template id="dashboardPropertyItemTemplate">
        <div class="card dashboard-property-item" data-id="{id}" lang="id">
            <h4>{nama}</h4>
            <p><i class="fas fa-map-pin"></i> {lokasi}</p>
            <p><i class="fas fa-money-bill-wave"></i> Rp {harga}/bulan</p>
            <p><i class="fas fa-check-circle {ketersediaanClass}"></i> {statusKetersediaan}</p>
            <button class="btn btn-secondary toggle-availability-btn" data-id="{id}"
                aria-label="Ubah status ketersediaan untuk {nama}"><i class="fas fa-exchange-alt"></i>
                {tombolAksiKetersediaan}</button>
        </div>
    </template>

    <!-- Modal Detail Properti -->
    <div id="propertyDetailModal" class="modal" role="dialog" aria-labelledby="propertyDetailTitle" aria-modal="true"
        tabindex="-1">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="propertyDetailTitle" class="modal-title">Detail Properti</h2>
                <button type="button" class="modal-close" data-modal-id="propertyDetailModal"
                    aria-label="Tutup Modal">√ó</button>
            </div>
            <div id="modalPropertyContent" class="modal-body">
                <!-- Konten detail akan diisi oleh JS -->
            </div>
        </div>
    </div>

    <template id="propertyDetailContentTemplate">
        <h2 id="propertyDetailTitleContent" class="modal-title"
            style="font-size: 1.8rem; margin-bottom: var(--spacing-md);">{nama}</h2>
        <img src="{gambar}" alt="Gambar Properti {nama}">
        <p><i class="fas fa-map-marker-alt"></i> <strong>Lokasi:</strong> {lokasi}</p>
        <p><i class="fas fa-money-bill-wave"></i> <strong>Harga:</strong> Rp {harga}/bulan</p>
        <p><i class="fas fa-info-circle"></i> <strong>Deskripsi:</strong> {deskripsi}</p>
        <p><i class="fas fa-concierge-bell"></i> <strong>Fasilitas:</strong> {fasilitas}</p>
        <p><i class="fas fa-check-circle {ketersediaanClass}"></i> <strong>Status:</strong> {statusKetersediaan}</p>
        <button class="btn btn-primary book-now-btn mt-2" data-id="{id}" {disabledPesan}><i
                class="fas fa-calendar-check"></i> Pesan Sekarang</button>
    </template>

    <!-- Modal Form Pemesanan -->
    <div id="bookingFormModal" class="modal" role="dialog" aria-labelledby="bookingFormTitle" aria-modal="true"
        tabindex="-1">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="bookingFormTitle" class="modal-title">Formulir Pemesanan</h3>
                <button type="button" class="modal-close" data-modal-id="bookingFormModal"
                    aria-label="Tutup Modal">√ó</button>
            </div>
            <form id="bookingForm" novalidate class="modal-body">
                <p>Properti: <strong id="bookingPropertyName">Nama Properti</strong></p>
                <input type="hidden" id="bookingPropertyId">
                <div class="form-group">
                    <label for="bookerName" class="form-label">Nama Lengkap Anda</label>
                    <input type="text" id="bookerName" class="form-control" required minlength="3"
                        placeholder="Contoh: Budi Santoso">
                    <div class="invalid-feedback">Nama lengkap wajib diisi (minimal 3 karakter).</div>
                </div>
                <div class="form-group">
                    <label for="bookerEmail" class="form-label">Alamat Email</label>
                    <input type="email" id="bookerEmail" class="form-control" required
                        placeholder="Contoh: email@example.com">
                    <div class="invalid-feedback">Format email tidak valid.</div>
                </div>
                <div class="form-group">
                    <label for="bookerPhone" class="form-label">Nomor Telepon (WhatsApp)</label>
                    <input type="tel" id="bookerPhone" class="form-control" required pattern="^\+?[0-9\s-]{10,15}$"
                        placeholder="Contoh: 081234567890">
                    <div class="invalid-feedback">Nomor telepon tidak valid (10-15 digit).</div>
                </div>
                <div class="form-group">
                    <label for="bookerMoveinDate" class="form-label">Tanggal Rencana Masuk</label>
                    <input type="date" id="bookerMoveinDate" class="form-control" required>
                    <div class="invalid-feedback">Tanggal rencana masuk wajib diisi.</div>
                </div>
                <button type="submit" class="btn btn-primary w-100"><i class="fas fa-paper-plane"></i> Kirim
                    Pemesanan</button>
            </form>
        </div>
    </div>

    <!-- Modal Konfirmasi Pemesanan -->
    <div id="bookingConfirmationModal" class="modal" role="alertdialog" aria-labelledby="confirmationTitleModal"
        aria-modal="true" tabindex="-1">
        <div class="modal-content text-center">
            <div class="modal-header" style="justify-content: center; border-bottom: none;">
                <h2 id="confirmationTitleModal" class="modal-title"><i class="fas fa-check-circle fa-2x text-success"
                        style="vertical-align: middle; margin-right: var(--spacing-sm);"></i> Pemesanan Berhasil!</h2>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage" class="mb-2">Detail konfirmasi akan dikirimkan ke email Anda.</p>
                <p><strong>ID Transaksi Anda:</strong> <span id="transactionId" class="text-primary"></span></p>
            </div>
            <button class="btn btn-success modal-action-close mt-2" data-modal-id="bookingConfirmationModal"
                aria-label="Tutup Konfirmasi"><i class="fas fa-thumbs-up"></i> Oke, Mengerti</button>
        </div>
    </div>

    <!-- Modal Notifikasi -->
    <div id="notificationsModal" class="modal" role="dialog" aria-labelledby="notificationsTitleModal" aria-modal="true"
        tabindex="-1">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="notificationsTitleModal" class="modal-title"><i class="fas fa-bell"></i> Notifikasi Anda</h3>
                <button type="button" class="modal-close" data-modal-id="notificationsModal"
                    aria-label="Tutup Modal">√ó</button>
            </div>
            <div id="notificationsList" class="modal-body" style="max-height: 400px; overflow-y: auto;">
                <!-- Daftar notifikasi akan dirender di sini -->
            </div>
            <button id="markAllReadBtn" class="btn btn-outline mt-2 w-100"><i class="fas fa-check-double"></i> Tandai
                Semua Telah Dibaca</button>
        </div>
    </div>

    <script>
        (function () {
            'use strict';

            // === STATE APLIKASI (Penyimpanan Data Terpusat) ===
            const AppState = {
                currentPage: 'home', // Halaman aktif saat ini
                currentUser: { id: 'manager01', role: 'manager' }, // Contoh pengguna, bisa dikembangkan
                theme: localStorage.getItem('theme') || 'light', // Tema default adalah terang
                properties: [ // Data properti (contoh)
                    { id: 'prop1', nama: 'Apartemen Tulip A101', lokasi: 'Green Valley Central Tower', harga: 5000000, gambar: 'https://source.unsplash.com/random/800x600/?apartment,modern,interior', deskripsi: 'Apartemen 1BR modern dengan pemandangan kota yang menakjubkan, fully furnished dan siap huni.', fasilitas: 'Kolam Renang Infinity, Gym Center, Co-working Space, Parkir Basement', ketersediaan: true, idPemilik: 'manager01' },
                    { id: 'prop2', nama: 'Studio Mawar B205', lokasi: 'Green Valley Residence Park', harga: 3500000, gambar: 'https://source.unsplash.com/random/800x600/?apartment,cozy,studio', deskripsi: 'Studio nyaman dan fungsional, ideal untuk profesional muda atau mahasiswa.', fasilitas: 'Dapur Mini Lengkap, Keamanan 24 Jam, Akses Kartu, Laundry Koin', ketersediaan: true, idPemilik: 'manager01' },
                    { id: 'prop3', nama: 'Apartemen Anggrek C310', lokasi: 'Green Valley Heights View', harga: 7500000, gambar: 'https://source.unsplash.com/random/800x600/?apartment,luxury,balcony', deskripsi: 'Apartemen 2BR luas dengan balkon pribadi menghadap taman, cocok untuk keluarga kecil.', fasilitas: 'Playground Anak, Jogging Track, BBQ Area, Ruang Serbaguna', ketersediaan: false, idPemilik: 'manager01' },
                    { id: 'prop4', nama: 'Penthouse Edelweiss PH-01', lokasi: 'Green Valley Skytower Exclusive', harga: 15000000, gambar: 'https://source.unsplash.com/random/800x600/?apartment,penthouse,luxury', deskripsi: 'Penthouse super mewah dengan pemandangan 360 derajat kota, lift pribadi dan kolam renang di rooftop.', fasilitas: 'Kolam Pribadi, Rooftop Garden, Home Cinema, Smart Home System', ketersediaan: true, idPemilik: 'manager01' }
                ],
                bookings: [], // Data pemesanan
                notifications: [], // Data notifikasi
            };

            // === SELEKTOR DOM (Elemen HTML yang Sering Digunakan) ===
            const DOM = {
                routerView: document.getElementById('routerView'),
                themeToggleBtn: document.getElementById('themeToggleBtn'),
                currentYearSpan: document.getElementById('currentYear'),
                notificationsButton: document.getElementById('notificationsButton'),
                notificationCountBadge: document.getElementById('notificationCountBadge'),
                // Selektor untuk template diambil saat dibutuhkan untuk efisiensi
            };

            // === UTILITAS (Fungsi Pembantu Umum) ===
            const Utils = {
                formatCurrency(amount) { // Format angka menjadi mata uang Rupiah
                    return new Intl.NumberFormat('id-ID', { /*style: 'currency', currency: 'IDR',*/ minimumFractionDigits: 0 }).format(amount);
                },
                sanitize(str) { // Membersihkan string dari potensi HTML berbahaya (dasar)
                    const temp = document.createElement('div');
                    temp.textContent = str;
                    return temp.innerHTML;
                },
                debounce(fn, delay) { // Mencegah fungsi dieksekusi berulang kali terlalu cepat
                    let timeoutId;
                    return function (...args) {
                        clearTimeout(timeoutId);
                        timeoutId = setTimeout(() => fn.apply(this, args), delay);
                    };
                },
                validateEmail(email) { // Validasi format email
                    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email).toLowerCase());
                },
                validatePhone(phone) { // Validasi format nomor telepon (sederhana)
                    return /^\+?[0-9\s-]{10,15}$/.test(phone);
                },
                getTemplateClone(templateId) { // Mengambil dan meng-kloning template HTML
                    const template = document.getElementById(templateId);
                    if (!template) {
                        console.error(`Template dengan ID "${templateId}" tidak ditemukan.`);
                        return null;
                    }
                    return template.content.cloneNode(true);
                }
            };

            // === LOGIKA UTAMA APLIKASI ===
            const App = {
                // Inisialisasi Aplikasi
                init() {
                    console.info('Green Valley App Initializing...');
                    // Pastikan elemen DOM penting ada
                    for (const key in DOM) {
                        if (Object.hasOwnProperty.call(DOM, key) && !DOM[key]) {
                            console.error(`Elemen DOM krusial '${key}' tidak ditemukan. Aplikasi mungkin tidak berfungsi.`);
                            // return; // Hentikan inisialisasi jika elemen krusial hilang
                        }
                    }

                    this.applyTheme(AppState.theme, true); // Terapkan tema yang tersimpan atau default (instan)
                    this.updateCurrentYear(); // Update tahun di footer
                    this.setupEventListeners(); // Pasang semua event listener global
                    this.navigateTo(window.location.hash || '#home', true); // Navigasi ke halaman awal atau berdasarkan hash URL
                    this.addNotification('Selamat datang di Green Valley! Temukan hunian impian Anda.', 'all', 'info');
                    console.info('Green Valley App berhasil dimuat dan siap digunakan.');
                },

                // Pengaturan Event Listener Global
                setupEventListeners() {
                    DOM.themeToggleBtn?.addEventListener('click', () => this.toggleTheme());
                    DOM.notificationsButton?.addEventListener('click', () => {
                        this.openModal('notificationsModal');
                        DOM.notificationsButton.setAttribute('aria-expanded', 'true');
                    });

                    // Navigasi SPA menggunakan data-route
                    document.body.addEventListener('click', e => {
                        const targetLink = e.target.closest('[data-route]');
                        if (targetLink) {
                            e.preventDefault();
                            this.navigateTo(targetLink.dataset.route);
                        }
                        // Penanganan tombol tutup modal generik
                        const modalCloseButton = e.target.closest('.modal-close, .modal-action-close');
                        if (modalCloseButton && modalCloseButton.dataset.modalId) {
                            this.closeModal(modalCloseButton.dataset.modalId);
                        }
                    });

                    // Navigasi menggunakan hash URL (untuk bookmark, back/forward browser)
                    window.addEventListener('hashchange', () => this.navigateTo(window.location.hash || '#home', true));

                    // Menutup modal dengan klik di luar area modal atau tombol Escape
                    window.addEventListener('click', e => {
                        document.querySelectorAll('.modal.show').forEach(modal => {
                            if (e.target === modal) this.closeModal(modal.id);
                        });
                    });
                    window.addEventListener('keydown', e => {
                        if (e.key === 'Escape') {
                            document.querySelectorAll('.modal.show').forEach(modal => this.closeModal(modal.id));
                        }
                    });

                    // Contoh listener untuk resize (jika diperlukan aksi tertentu)
                    // window.addEventListener('resize', Utils.debounce(() => this.handleResize(), 200));
                },

                // Menerapkan Tema (Light/Dark)
                applyTheme(theme, instant = false) {
                    document.documentElement.setAttribute('data-theme', theme);
                    if (DOM.themeToggleBtn) {
                        DOM.themeToggleBtn.innerHTML = `<i class="fas fa-${theme === 'light' ? 'moon' : 'sun'}"></i>`;
                        DOM.themeToggleBtn.setAttribute('aria-label', `Ganti ke tema ${theme === 'light' ? 'Gelap' : 'Terang'}`);
                    }
                    AppState.theme = theme;
                    localStorage.setItem('theme', theme); // Simpan preferensi tema
                    if (!instant && document.body) { // Efek transisi hanya jika tidak instan
                        document.body.style.transition = 'background-color var(--transition-normal), color var(--transition-normal)';
                    }
                },

                // Mengganti Tema
                toggleTheme() {
                    const newTheme = AppState.theme === 'light' ? 'dark' : 'light';
                    this.applyTheme(newTheme);
                    this.addNotification(`Tema berhasil diubah ke mode ${newTheme === 'light' ? 'Terang' : 'Gelap'}.`, AppState.currentUser.id, 'info');
                },

                // Navigasi Antar Halaman (Routing SPA)
                navigateTo(path, isInitialOrFromHash = false) {
                    const page = path.startsWith('#') ? path.substring(1) : path;
                    if (!page) { // Jika path kosong, default ke home
                        this.navigateTo('home', isInitialOrFromHash);
                        return;
                    }
                    AppState.currentPage = page;

                    if (!isInitialOrFromHash) { // Update hash hanya jika navigasi dari klik internal
                        window.location.hash = page;
                    }

                    if (DOM.routerView) {
                        DOM.routerView.style.opacity = '0'; // Efek fade out
                        setTimeout(() => {
                            this.renderPage(page); // Render halaman baru
                            DOM.routerView.style.opacity = '1'; // Efek fade in
                            window.scrollTo(0, 0); // Scroll ke atas halaman
                        }, 300); // Sesuaikan dengan durasi transisi CSS
                    }

                    // Update status 'active' pada link navigasi
                    document.querySelectorAll('.nav-link').forEach(link => {
                        link.classList.toggle('active', link.dataset.route === page);
                    });
                },

                // Merender Konten Halaman Sesuai Route
                renderPage(page) {
                    if (!DOM.routerView) return;
                    DOM.routerView.innerHTML = ''; // Bersihkan konten sebelumnya

                    const routes = { // Definisi rute dan fungsi render-nya
                        home: this.renderHomePage,
                        listings: this.renderListingsPage,
                        dashboard: this.renderDashboardPage,
                    };

                    if (routes[page]) {
                        routes[page].call(this); // Panggil fungsi render yang sesuai
                    } else {
                        console.warn(`Halaman untuk rute "${page}" tidak ditemukan. Mengarahkan ke Beranda.`);
                        this.navigateTo('home', true); // Arahkan ke Beranda jika rute tidak dikenal
                        // Atau tampilkan halaman 404
                        // DOM.routerView.innerHTML = '<div class="card text-center"><h2 class="section-title">404 - Halaman Tidak Ditemukan</h2><p>Maaf, halaman yang Anda cari tidak ada.</p><a href="#home" data-route="home" class="btn btn-primary">Kembali ke Beranda</a></div>';
                    }
                },

                // === FUNGSI RENDER UNTUK SETIAP HALAMAN ===
                renderHomePage() {
                    const homeContent = Utils.getTemplateClone('homePageTemplate');
                    if (homeContent) DOM.routerView.appendChild(homeContent);
                },

                renderListingsPage(searchTerm = '') {
                    const listingsContent = Utils.getTemplateClone('listingsPageTemplate');
                    if (!listingsContent) return;

                    const grid = listingsContent.querySelector('#propertyListingsGrid');
                    const noResultsMsg = listingsContent.querySelector('#noResultsMessage');
                    const searchForm = listingsContent.querySelector('#searchForm');
                    const searchInput = listingsContent.querySelector('#searchLocation');

                    if (searchInput) searchInput.value = searchTerm; // Pertahankan nilai pencarian

                    const filteredProperties = AppState.properties.filter(p =>
                        p.nama.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        p.lokasi.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        p.deskripsi.toLowerCase().includes(searchTerm.toLowerCase())
                    );

                    if (grid && noResultsMsg) {
                        grid.innerHTML = ''; // Bersihkan grid sebelum mengisi
                        if (filteredProperties.length === 0) {
                            noResultsMsg.classList.remove('hidden');
                        } else {
                            noResultsMsg.classList.add('hidden');
                            filteredProperties.forEach(prop => {
                                const card = this.createPropertyCard(prop);
                                if (card) grid.appendChild(card);
                            });
                        }
                    }

                    searchForm?.addEventListener('submit', e => {
                        e.preventDefault();
                        this.renderListingsPage(searchInput ? searchInput.value : '');
                    });

                    DOM.routerView.appendChild(listingsContent);
                },

                createPropertyCard(prop) {
                    const cardTemplate = Utils.getTemplateClone('propertyCardTemplate');
                    if (!cardTemplate) return null;

                    const cardFragment = cardTemplate; // Sudah merupakan DocumentFragment

                    // Fungsi untuk mengganti placeholder di template
                    const replacePlaceholder = (selector, content, attribute = 'textContent') => {
                        const element = cardFragment.querySelector(selector);
                        if (element) {
                            if (attribute === 'innerHTML') element.innerHTML = content;
                            else if (attribute) element[attribute] = content;
                            else element.textContent = content;
                        }
                    };
                    const element = cardFragment.querySelector('.property-item');
                    if (element) element.dataset.id = prop.id;


                    cardFragment.querySelector('img').src = Utils.sanitize(prop.gambar);
                    cardFragment.querySelector('img').alt = `Visual Properti ${Utils.sanitize(prop.nama)}`;
                    cardFragment.querySelector('h3').textContent = Utils.sanitize(prop.nama);
                    cardFragment.querySelector('.fa-map-pin').nextSibling.textContent = ` ${Utils.sanitize(prop.lokasi)}`;
                    cardFragment.querySelector('.fa-money-bill-wave').nextSibling.textContent = ` Rp ${Utils.formatCurrency(prop.harga)}/bulan`;

                    const statusElement = cardFragment.querySelector('.fa-check-circle');
                    statusElement.nextSibling.textContent = ` ${prop.ketersediaan ? 'Tersedia' : 'Sudah Disewa'}`;
                    statusElement.classList.toggle('text-success', prop.ketersediaan);
                    statusElement.classList.toggle('text-error', !prop.ketersediaan); // Atau warna lain

                    const detailsBtn = cardFragment.querySelector('.view-details-btn');
                    detailsBtn.dataset.id = prop.id;
                    detailsBtn.setAttribute('aria-label', `Lihat detail untuk ${Utils.sanitize(prop.nama)}`);

                    if (!prop.ketersediaan) {
                        const propertyItem = cardFragment.querySelector('.property-item');
                        if (propertyItem) propertyItem.style.opacity = '0.7';
                    }
                    return cardFragment;
                },

                showPropertyDetail(id) {
                    const prop = AppState.properties.find(p => p.id === id);
                    if (!prop) {
                        this.addNotification('Detail properti tidak ditemukan.', AppState.currentUser.id, 'error');
                        return;
                    }

                    const detailTemplate = Utils.getTemplateClone('propertyDetailContentTemplate');
                    if (!detailTemplate) return;

                    const modalContent = document.getElementById('modalPropertyContent');
                    if (!modalContent) return;

                    // Mengisi template dengan data properti
                    detailTemplate.querySelector('#propertyDetailTitleContent').textContent = Utils.sanitize(prop.nama);
                    detailTemplate.querySelector('img').src = Utils.sanitize(prop.gambar);
                    detailTemplate.querySelector('img').alt = `Gambar Properti ${Utils.sanitize(prop.nama)}`;

                    const setDetailText = (selector, prefix, value) => {
                        const el = detailTemplate.querySelector(selector);
                        if (el && el.nextSibling) el.nextSibling.nextSibling.textContent = ` ${Utils.sanitize(value)}`;
                    };
                    setDetailText('.fa-map-marker-alt', 'Lokasi:', prop.lokasi);
                    setDetailText('.fa-money-bill-wave', 'Harga:', `Rp ${Utils.formatCurrency(prop.harga)}/bulan`);
                    setDetailText('.fa-info-circle', 'Deskripsi:', prop.deskripsi);
                    setDetailText('.fa-concierge-bell', 'Fasilitas:', prop.fasilitas);

                    const statusElement = detailTemplate.querySelector('.fa-check-circle');
                    if (statusElement && statusElement.nextSibling && statusElement.nextSibling.nextSibling) {
                        statusElement.nextSibling.nextSibling.textContent = ` ${prop.ketersediaan ? 'Tersedia' : 'Sudah Disewa'}`;
                        statusElement.classList.toggle('text-success', prop.ketersediaan);
                        statusElement.classList.toggle('text-error', !prop.ketersediaan);
                    }


                    const bookBtn = detailTemplate.querySelector('.book-now-btn');
                    bookBtn.dataset.id = prop.id;
                    if (!prop.ketersediaan) {
                        bookBtn.disabled = true;
                        bookBtn.textContent = 'Sudah Dipesan';
                    } else {
                        bookBtn.disabled = false;
                        bookBtn.innerHTML = '<i class="fas fa-calendar-check"></i> Pesan Sekarang';
                        // Hapus event listener lama jika ada, lalu tambahkan yang baru
                        const newBookBtn = bookBtn.cloneNode(true);
                        bookBtn.parentNode.replaceChild(newBookBtn, bookBtn);
                        newBookBtn.addEventListener('click', () => {
                            this.closeModal('propertyDetailModal');
                            this.showBookingForm(prop.id);
                        }, { once: true }); // Pastikan listener hanya ditambahkan sekali jika modal dibuka lagi
                    }

                    modalContent.innerHTML = ''; // Bersihkan konten modal sebelumnya
                    modalContent.appendChild(detailTemplate);
                    document.getElementById('propertyDetailTitle').textContent = `Detail: ${Utils.sanitize(prop.nama)}`;
                    this.openModal('propertyDetailModal');
                },

                showBookingForm(propertyId) {
                    const prop = AppState.properties.find(p => p.id === propertyId);
                    if (!prop || !prop.ketersediaan) {
                        this.addNotification('Properti ini tidak tersedia untuk dipesan saat ini.', 'all', 'warning');
                        return;
                    }

                    document.getElementById('bookingPropertyName').textContent = Utils.sanitize(prop.nama);
                    document.getElementById('bookingPropertyId').value = prop.id;

                    const bookingForm = document.getElementById('bookingForm');
                    if (bookingForm) {
                        bookingForm.reset(); // Reset form
                        // Hapus kelas error sebelumnya
                        bookingForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

                        // Hapus event listener lama (jika ada) dan tambahkan yang baru
                        // Ini penting untuk mencegah multiple submissions jika modal dibuka berkali-kali
                        const newBookingForm = bookingForm.cloneNode(true); // Kloning form untuk membersihkan listener
                        bookingForm.parentNode.replaceChild(newBookingForm, bookingForm);
                        newBookingForm.addEventListener('submit', this.handleBookingForm.bind(this)); // Bind 'this'
                    }

                    this.openModal('bookingFormModal');
                },

                handleBookingForm(e) {
                    e.preventDefault();
                    const form = e.target; // form adalah e.target
                    let isValid = true;

                    // Validasi field
                    const fieldsToValidate = [
                        { id: 'bookerName', validate: val => val.trim().length >= 3, msg: 'Nama wajib diisi (min. 3 karakter).' },
                        { id: 'bookerEmail', validate: Utils.validateEmail, msg: 'Email tidak valid.' },
                        { id: 'bookerPhone', validate: Utils.validatePhone, msg: 'Nomor telepon tidak valid.' },
                        { id: 'bookerMoveinDate', validate: val => !!val, msg: 'Tanggal masuk wajib diisi.' }
                    ];

                    fieldsToValidate.forEach(field => {
                        const input = form.querySelector(`#${field.id}`);
                        if (input) {
                            if (!field.validate(input.value)) {
                                input.classList.add('is-invalid');
                                isValid = false;
                            } else {
                                input.classList.remove('is-invalid');
                            }
                        }
                    });

                    if (!isValid) {
                        this.addNotification('Harap periksa kembali isian formulir Anda. Ada data yang tidak valid.', 'system', 'error');
                        // Fokus ke field pertama yang error (opsional)
                        const firstInvalid = form.querySelector('.is-invalid');
                        if (firstInvalid) firstInvalid.focus();
                        return;
                    }

                    // Proses data jika valid
                    const bookingData = {
                        id: `booking-${Date.now()}`,
                        propertyId: form.querySelector('#bookingPropertyId').value,
                        bookerName: form.querySelector('#bookerName').value,
                        bookerEmail: form.querySelector('#bookerEmail').value,
                        bookerPhone: form.querySelector('#bookerPhone').value,
                        moveInDate: form.querySelector('#bookerMoveinDate').value,
                        transactionId: `TRX-${Date.now()}-${Math.random().toString(36).substring(2, 8).toUpperCase()}`,
                        status: 'pending', // Status awal pemesanan
                        timestamp: new Date().toISOString()
                    };

                    // Simulasi proses asynchronous (misalnya, kirim ke server)
                    const submitButton = form.querySelector('button[type="submit"]');
                    if (submitButton) {
                        submitButton.disabled = true;
                        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
                    }

                    setTimeout(() => { // Simulasi delay jaringan
                        const propertyToBook = AppState.properties.find(p => p.id === bookingData.propertyId);
                        if (propertyToBook && propertyToBook.ketersediaan) {
                            propertyToBook.ketersediaan = false; // Tandai properti sebagai tidak tersedia
                            AppState.bookings.push(bookingData); // Simpan data pemesanan

                            this.addNotification(`Pemesanan untuk ${Utils.sanitize(propertyToBook.nama)} oleh ${Utils.sanitize(bookingData.bookerName)} berhasil!`, AppState.currentUser.id, 'success');
                            this.closeModal('bookingFormModal');

                            // Tampilkan modal konfirmasi
                            document.getElementById('confirmationMessage').textContent = `Terima kasih, ${Utils.sanitize(bookingData.bookerName)}! Pemesanan Anda untuk properti "${Utils.sanitize(propertyToBook.nama)}" telah berhasil kami terima. Kami akan segera menghubungi Anda.`;
                            document.getElementById('transactionId').textContent = bookingData.transactionId;
                            this.openModal('bookingConfirmationModal');

                            // Re-render halaman saat ini (misalnya, listings) untuk update status properti
                            if (AppState.currentPage === 'listings') this.renderListingsPage(document.getElementById('searchLocation')?.value || '');
                            if (AppState.currentPage === 'dashboard') this.renderDashboardPage();

                        } else {
                            this.addNotification('Maaf, properti ini baru saja tidak tersedia atau terjadi kesalahan.', 'system', 'error');
                        }
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.innerHTML = '<i class="fas fa-paper-plane"></i> Kirim Pemesanan';
                        }
                    }, 1500);
                },

                renderDashboardPage() {
                    if (AppState.currentUser.role !== 'manager') {
                        DOM.routerView.innerHTML = '<div class="card text-center"><h2 class="section-title">Akses Ditolak</h2><p>Halaman ini hanya dapat diakses oleh Manager.</p><a href="#home" data-route="home" class="btn btn-primary">Kembali ke Beranda</a></div>';
                        return;
                    }

                    const dashboardContent = Utils.getTemplateClone('dashboardPageTemplate');
                    if (!dashboardContent) return;

                    const totalProperties = AppState.properties.length;
                    const availableProperties = AppState.properties.filter(p => p.ketersediaan).length;
                    const estimatedRevenue = AppState.properties
                        .filter(p => !p.ketersediaan && AppState.bookings.find(b => b.propertyId === p.id)) // Hitung hanya yg sudah ada booking
                        .reduce((sum, p) => sum + p.harga, 0);

                    dashboardContent.getElementById('dashboardTotalProperties').textContent = totalProperties;
                    dashboardContent.getElementById('dashboardAvailableProperties').textContent = availableProperties;
                    dashboardContent.getElementById('dashboardEstimatedRevenue').textContent = `Rp ${Utils.formatCurrency(estimatedRevenue)}`;

                    const propertyListContainer = dashboardContent.getElementById('dashboardPropertyList');
                    if (propertyListContainer) {
                        propertyListContainer.innerHTML = ''; // Bersihkan list
                        const managerProperties = AppState.properties.filter(p => p.idPemilik === AppState.currentUser.id);
                        if (managerProperties.length === 0) {
                            propertyListContainer.innerHTML = '<p class="text-center">Anda belum memiliki properti untuk dikelola.</p>';
                        } else {
                            managerProperties.forEach(prop => {
                                const itemTemplate = Utils.getTemplateClone('dashboardPropertyItemTemplate');
                                if (itemTemplate) {
                                    itemTemplate.querySelector('.dashboard-property-item').dataset.id = prop.id;
                                    itemTemplate.querySelector('h4').textContent = Utils.sanitize(prop.nama);
                                    itemTemplate.querySelector('.fa-map-pin').nextSibling.textContent = ` ${Utils.sanitize(prop.lokasi)}`;
                                    itemTemplate.querySelector('.fa-money-bill-wave').nextSibling.textContent = ` Rp ${Utils.formatCurrency(prop.harga)}`;

                                    const statusElement = itemTemplate.querySelector('.fa-check-circle');
                                    statusElement.nextSibling.textContent = ` ${prop.ketersediaan ? 'Tersedia' : 'Sudah Disewa'}`;
                                    statusElement.classList.toggle('text-success', prop.ketersediaan); // Warna untuk status
                                    statusElement.classList.toggle('text-error', !prop.ketersediaan);


                                    const toggleBtn = itemTemplate.querySelector('.toggle-availability-btn');
                                    toggleBtn.dataset.id = prop.id;
                                    toggleBtn.setAttribute('aria-label', `Ubah status ketersediaan untuk ${Utils.sanitize(prop.nama)}`);
                                    toggleBtn.innerHTML = `<i class="fas ${prop.ketersediaan ? 'fa-times-circle' : 'fa-check-circle'}"></i> ${prop.ketersediaan ? 'Tandai Disewa' : 'Tandai Tersedia'}`;

                                    propertyListContainer.appendChild(itemTemplate);
                                }
                            });
                        }
                    }
                    DOM.routerView.appendChild(dashboardContent);
                },

                togglePropertyAvailability(id) {
                    const prop = AppState.properties.find(p => p.id === id && p.idPemilik === AppState.currentUser.id);
                    if (prop) {
                        prop.ketersediaan = !prop.ketersediaan;
                        this.addNotification(`Status properti "${Utils.sanitize(prop.nama)}" berhasil diubah menjadi ${prop.ketersediaan ? 'Tersedia' : 'Disewa'}.`, AppState.currentUser.id, 'info');
                        this.renderDashboardPage(); // Re-render dashboard untuk update
                        // Jika halaman listings aktif dan menampilkan properti ini, update juga (opsional, tergantung kebutuhan)
                        if (AppState.currentPage === 'listings') {
                            this.renderListingsPage(document.getElementById('searchLocation')?.value || '');
                        }
                    } else {
                        this.addNotification('Gagal mengubah status properti. Properti tidak ditemukan atau Anda tidak berhak.', 'system', 'error');
                    }
                },

                // === MANAJEMEN NOTIFIKASI ===
                addNotification(message, recipientId = 'all', type = 'info', isUrgent = false) {
                    const notification = {
                        id: `notif-${Date.now()}-${Math.random().toString(36).substring(2, 5)}`,
                        message: Utils.sanitize(message),
                        recipient: recipientId, // 'all' atau user ID spesifik
                        read: false,
                        timestamp: new Date(),
                        type: type, // 'info', 'success', 'warning', 'error'
                        isUrgent: isUrgent // Untuk notifikasi yang lebih menonjol
                    };
                    AppState.notifications.unshift(notification); // Tambah di awal array agar terbaru di atas
                    this.renderNotifications(); // Update tampilan daftar notifikasi (jika modal terbuka)
                    this.updateNotificationBadge(); // Update badge jumlah notifikasi

                    // Optional: Tampilkan notifikasi toast non-intrusif (belum diimplementasikan)
                    // if (type === 'success' || type === 'error' || isUrgent) this.showToastNotification(notification);
                },

                renderNotifications() {
                    const listContainer = document.getElementById('notificationsList');
                    const markAllReadBtn = document.getElementById('markAllReadBtn');

                    if (!listContainer) return; // Jika modal notifikasi tidak ada/tidak aktif

                    listContainer.innerHTML = ''; // Bersihkan list
                    const userNotifications = AppState.notifications.filter(n => n.recipient === 'all' || n.recipient === AppState.currentUser.id)
                        .sort((a, b) => b.timestamp - a.timestamp); // Urutkan terbaru di atas

                    if (userNotifications.length === 0) {
                        listContainer.innerHTML = '<p class="text-center text-muted p-3">Tidak ada notifikasi baru untuk Anda.</p>';
                        if (markAllReadBtn) markAllReadBtn.classList.add('hidden');
                        return;
                    }

                    if (markAllReadBtn) markAllReadBtn.classList.remove('hidden');

                    userNotifications.forEach(n => {
                        const item = document.createElement('div');
                        item.className = `notification-item ${n.read ? '' : 'unread'} ${n.type}`;
                        item.setAttribute('role', 'alert');
                        item.setAttribute('tabindex', '0'); // Agar bisa di-fokus
                        item.dataset.notificationId = n.id;
                        item.innerHTML = `
                            <p>${n.message}</p>
                            <small>${new Date(n.timestamp).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' })}</small>
                        `;
                        item.addEventListener('click', () => this.markNotificationAsRead(n.id));
                        item.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                this.markNotificationAsRead(n.id);
                            }
                        });
                        listContainer.appendChild(item);
                    });

                    if (markAllReadBtn) {
                        const newMarkAllReadBtn = markAllReadBtn.cloneNode(true);
                        markAllReadBtn.parentNode.replaceChild(newMarkAllReadBtn, markAllReadBtn);
                        newMarkAllReadBtn.addEventListener('click', () => this.markAllNotificationsAsRead());
                    }
                },

                markNotificationAsRead(notificationId) {
                    const notification = AppState.notifications.find(n => n.id === notificationId);
                    if (notification && !notification.read) {
                        notification.read = true;
                        this.renderNotifications(); // Re-render list
                        this.updateNotificationBadge();
                    }
                },

                markAllNotificationsAsRead() {
                    AppState.notifications.forEach(n => {
                        if (n.recipient === 'all' || n.recipient === AppState.currentUser.id) {
                            n.read = true;
                        }
                    });
                    this.renderNotifications();
                    this.updateNotificationBadge();
                    this.addNotification('Semua notifikasi telah ditandai terbaca.', AppState.currentUser.id, 'info');
                },

                updateNotificationBadge() {
                    if (!DOM.notificationCountBadge) return;
                    const unreadCount = AppState.notifications.filter(n => !n.read && (n.recipient === 'all' || n.recipient === AppState.currentUser.id)).length;
                    DOM.notificationCountBadge.textContent = unreadCount > 9 ? '9+' : unreadCount.toString();
                    DOM.notificationCountBadge.style.display = unreadCount > 0 ? 'inline-block' : 'none';
                },

                // === MANAJEMEN MODAL ===
                openModal(modalId) {
                    const modal = document.getElementById(modalId);
                    if (modal) {
                        modal.classList.add('show');
                        document.body.style.overflow = 'hidden'; // Cegah scroll background
                        modal.setAttribute('aria-hidden', 'false');

                        const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                        if (focusableElements.length > 0) {
                            focusableElements[0].focus(); // Fokus ke elemen pertama yang bisa difokus di modal
                        }

                        if (modalId === 'notificationsModal') {
                            this.renderNotifications(); // Render notifikasi saat modal dibuka
                            DOM.notificationsButton?.setAttribute('aria-expanded', 'true');
                        }
                    }
                },

                closeModal(modalId) {
                    const modal = document.getElementById(modalId);
                    if (modal) {
                        modal.classList.remove('show');
                        document.body.style.overflow = ''; // Kembalikan scroll background
                        modal.setAttribute('aria-hidden', 'true');

                        if (modalId === 'notificationsModal') {
                            DOM.notificationsButton?.setAttribute('aria-expanded', 'false');
                            DOM.notificationsButton?.focus(); // Kembalikan fokus ke tombol notifikasi
                        }
                    }
                },

                // Update tahun di footer secara dinamis
                updateCurrentYear() {
                    if (DOM.currentYearSpan) {
                        DOM.currentYearSpan.textContent = new Date().getFullYear();
                    }
                },
            };

            // Event Listener untuk memastikan DOM siap sebelum aplikasi dijalankan
            if (document.readyState === 'loading') { // Loading hasn't finished yet
                document.addEventListener('DOMContentLoaded', () => App.init());
            } else { // `DOMContentLoaded` has already fired
                App.init();
            }

            // Expose App ke global scope untuk debugging (opsional)
            // window.GreenValleyApp = App;
            // window.GreenValleyState = AppState;

        })();
    </script>
</body>

</html>