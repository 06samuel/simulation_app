<!DOCTYPE html>
<html lang="id" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Green Valley - Platform penyewaan apartemen modern, responsif, dan memanjakan pengguna. Cari dan sewa apartemen impian Anda dengan mudah.">
    <meta name="keywords"
        content="sewa apartemen, rental apartemen, apartemen premium, cari apartemen, aplikasi sewa apartemen">
    <meta name="author" content="Green Valley Native Team">
    <title>Green Valley - Platform Penyewaan Apartemen Impian Anda</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè¢</text></svg>">

    <!-- Preconnect and Preload Fonts for Performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
            rel="stylesheet">
    </noscript>

    <!-- Font Awesome (CDN for Icons - assumed permissible as basic utility) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* ------------------------- */
        /* -- DESIGN TOKENS & THEME -- */
        /* ------------------------- */
        :root {
            --font-family-primary: 'Poppins', 'Roboto', sans-serif;
            /* Fallback font */

            /* Primary Colors */
            --primary-hue: 243;
            /* Indigo-like blue */
            --primary-saturation: 75%;
            --primary-lightness: 60%;
            --primary-color: hsl(var(--primary-hue), var(--primary-saturation), var(--primary-lightness));
            --primary-color-light: hsl(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) + 15%));
            --primary-color-dark: hsl(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) - 10%));
            --primary-color-translucent: hsla(var(--primary-hue), var(--primary-saturation), var(--primary-lightness), 0.1);

            /* Accent/Secondary Colors */
            --accent-hue: 330;
            /* Pinkish-red for accent */
            --accent-saturation: 80%;
            --accent-lightness: 65%;
            --accent-color: hsl(var(--accent-hue), var(--accent-saturation), var(--accent-lightness));

            /* Semantic Colors */
            --success-color: hsl(145, 63%, 42%);
            --warning-color: hsl(45, 100%, 51%);
            --error-color: hsl(0, 79%, 63%);
            --info-color: hsl(200, 80%, 55%);

            /* Surface & Text Colors (Light Theme - Default) */
            --surface-color: hsl(0, 0%, 100%);
            --surface-variant-color: hsl(220, 25%, 97%);
            /* Slightly off-white */
            --on-surface-color: hsl(220, 15%, 20%);
            /* Dark gray for text */
            --on-surface-variant-color: hsl(220, 10%, 45%);
            /* Lighter gray for secondary text */
            --border-color: hsl(220, 15%, 88%);
            --on-primary-color: hsl(0, 0%, 100%);
            /* Text on primary background */

            /* Spacing & Sizing */
            --spacing-unit: 8px;
            --spacing-xs: calc(var(--spacing-unit) * 0.5);
            /* 4px */
            --spacing-sm: var(--spacing-unit);
            /* 8px */
            --spacing-md: calc(var(--spacing-unit) * 2);
            /* 16px */
            --spacing-lg: calc(var(--spacing-unit) * 3);
            /* 24px */
            --spacing-xl: calc(var(--spacing-unit) * 4);
            /* 32px */

            /* Borders & Radius */
            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --border-radius-lg: 16px;

            /* Shadows (subtle and layered) */
            --shadow-xs: 0 1px 2px hsla(0, 0%, 0%, 0.05);
            --shadow-sm: 0 2px 4px hsla(0, 0%, 0%, 0.07);
            --shadow-md: 0 4px 8px hsla(0, 0%, 0%, 0.08), 0 2px 4px hsla(0, 0%, 0%, 0.05);
            --shadow-lg: 0 10px 20px hsla(0, 0%, 0%, 0.1), 0 3px 6px hsla(0, 0%, 0%, 0.07);

            /* Transitions */
            --transition-duration-fast: 0.15s;
            --transition-duration-normal: 0.3s;
            --transition-easing: ease-in-out;
            --transition-base: all var(--transition-duration-normal) var(--transition-easing);

            /* Z-Indexes */
            --z-index-dropdown: 1000;
            --z-index-sticky: 1020;
            --z-index-modal-backdrop: 1040;
            --z-index-modal: 1050;
            --z-index-popover: 1060;
            --z-index-tooltip: 1070;
            --z-index-chatbox: 1100;
            --z-index-notification: 1200;
        }

        [data-theme="dark"] {
            --primary-lightness: 50%;
            /* Adjust primary for dark mode */

            --surface-color: hsl(220, 18%, 12%);
            /* Dark gray */
            --surface-variant-color: hsl(220, 15%, 18%);
            /* Slightly lighter dark */
            --on-surface-color: hsl(220, 25%, 90%);
            /* Light gray for text */
            --on-surface-variant-color: hsl(220, 15%, 65%);
            --border-color: hsl(220, 15%, 30%);

            --shadow-xs: 0 1px 2px hsla(0, 0%, 0%, 0.2);
            --shadow-sm: 0 2px 4px hsla(0, 0%, 0%, 0.3);
            --shadow-md: 0 4px 8px hsla(0, 0%, 0%, 0.35), 0 2px 4px hsla(0, 0%, 0%, 0.2);
            --shadow-lg: 0 10px 20px hsla(0, 0%, 0%, 0.4), 0 3px 6px hsla(0, 0%, 0%, 0.25);
        }

        /* ----------------- */
        /* -- BASE STYLES -- */
        /* ----------------- */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html {
            font-size: 16px;
            /* Base font size */
            scroll-behavior: smooth;
            height: 100%;
        }

        body {
            font-family: var(--font-family-primary);
            line-height: 1.6;
            color: var(--on-surface-color);
            background-color: var(--surface-color);
            display: flex;
            /* For sidebar layout */
            min-height: 100vh;
            transition: background-color var(--transition-duration-normal), color var(--transition-duration-normal);
        }

        a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color var(--transition-duration-fast);
        }

        a:hover,
        a:focus {
            color: var(--primary-color-dark);
            text-decoration: underline;
        }

        img,
        picture,
        video,
        canvas,
        svg {
            max-width: 100%;
            height: auto;
            display: block;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-weight: 600;
            /* Semi-bold for headings */
            line-height: 1.3;
            margin-bottom: var(--spacing-md);
        }

        h1 {
            font-size: 2.25rem;
        }

        /* ~36px */
        h2 {
            font-size: 1.75rem;
        }

        /* ~28px */
        h3 {
            font-size: 1.25rem;
        }

        /* ~20px */

        p {
            margin-bottom: var(--spacing-md);
        }

        ul,
        ol {
            list-style-position: inside;
            padding-left: var(--spacing-md);
        }

        /* -------------------- */
        /* -- UTILITY CLASSES -- */
        /* -------------------- */
        .container {
            width: 100%;
            max-width: 1280px;
            /* Wider container */
            margin-left: auto;
            margin-right: auto;
            padding-left: var(--spacing-lg);
            padding-right: var(--spacing-lg);
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-center {
            justify-content: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-xs {
            gap: var(--spacing-xs);
        }

        .gap-sm {
            gap: var(--spacing-sm);
        }

        .gap-md {
            gap: var(--spacing-md);
        }

        .gap-lg {
            gap: var(--spacing-lg);
        }

        .grid {
            display: grid;
        }

        .grid-cols-auto-fill {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        /* Responsive grid */
        .p-sm {
            padding: var(--spacing-sm);
        }

        .p-md {
            padding: var(--spacing-md);
        }

        .p-lg {
            padding: var(--spacing-lg);
        }

        .my-md {
            margin-top: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .my-lg {
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .mt-auto {
            margin-top: auto;
        }

        .text-center {
            text-align: center;
        }

        .w-full {
            width: 100%;
        }

        .rounded-sm {
            border-radius: var(--border-radius-sm);
        }

        .rounded-md {
            border-radius: var(--border-radius-md);
        }

        .rounded-lg {
            border-radius: var(--border-radius-lg);
        }

        .shadow-sm {
            box-shadow: var(--shadow-sm);
        }

        .shadow-md {
            box-shadow: var(--shadow-md);
        }

        .shadow-lg {
            box-shadow: var(--shadow-lg);
        }

        .hidden {
            display: none !important;
        }

        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .text-muted {
            color: var(--on-surface-variant-color);
        }

        .text-sm {
            font-size: 0.875rem;
        }

        /* ~14px */
        .font-bold {
            font-weight: 700;
        }

        .font-semibold {
            font-weight: 600;
        }

        .bg-primary {
            background-color: var(--primary-color);
        }

        .bg-surface {
            background-color: var(--surface-color);
        }

        .bg-surface-variant {
            background-color: var(--surface-variant-color);
        }

        /* ---------------- */
        /* -- COMPONENTS -- */
        /* ---------------- */

        /* Sidebar Navigation */
        .app-sidebar {
            width: 260px;
            /* Slightly wider */
            background-color: var(--surface-variant-color);
            padding: var(--spacing-lg) var(--spacing-md);
            position: sticky;
            top: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            transition: var(--transition-base);
            overflow-y: auto;
        }

        .app-sidebar-header {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: var(--spacing-xl);
            text-align: center;
        }

        .app-sidebar nav ul {
            list-style: none;
            padding-left: 0;
        }

        .app-sidebar nav ul li {
            margin-bottom: var(--spacing-sm);
        }

        .app-sidebar nav ul li a {
            color: var(--on-surface-variant-color);
            padding: var(--spacing-sm) var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            border-radius: var(--border-radius-md);
            font-weight: 500;
            transition: var(--transition-base);
            text-decoration: none;
        }

        .app-sidebar nav ul li a:hover,
        .app-sidebar nav ul li a:focus {
            background-color: var(--primary-color-translucent);
            color: var(--primary-color);
        }

        .app-sidebar nav ul li a.active {
            background-color: var(--primary-color);
            color: var(--on-primary-color);
            font-weight: 600;
            box-shadow: var(--shadow-sm);
        }

        .app-sidebar nav ul li a .nav-icon {
            width: 20px;
            text-align: center;
        }

        .app-sidebar-footer {
            margin-top: auto;
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
        }

        .theme-switcher {
            cursor: pointer;
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-md);
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--on-surface-variant-color);
        }

        .theme-switcher:hover {
            background-color: var(--surface-color);
        }


        /* Main Content Area */
        .app-main {
            flex: 1;
            padding: var(--spacing-xl);
            background-color: var(--surface-color);
            overflow-y: auto;
            /* For content scroll, not entire body */
        }

        .app-main header h1 {
            margin-bottom: var(--spacing-lg);
        }

        /* Forms & Inputs */
        .form-control {
            display: block;
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: 1rem;
            font-family: inherit;
            color: var(--on-surface-color);
            background-color: var(--surface-color);
            background-clip: padding-box;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            transition: border-color var(--transition-duration-fast), box-shadow var(--transition-duration-fast);
        }

        .form-control:focus {
            border-color: var(--primary-color);
            outline: 0;
            box-shadow: 0 0 0 0.2rem var(--primary-color-translucent);
        }

        .form-control::placeholder {
            color: var(--on-surface-variant-color);
            opacity: 0.7;
        }

        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-group label {
            display: inline-block;
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
        }

        .form-check {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .form-check input[type="checkbox"],
        .form-check input[type="radio"] {
            width: 1.25em;
            height: 1.25em;
            cursor: pointer;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-lg);
            font-family: inherit;
            font-size: 1rem;
            font-weight: 500;
            line-height: 1.5;
            text-align: center;
            text-decoration: none;
            vertical-align: middle;
            cursor: pointer;
            user-select: none;
            background-color: transparent;
            border: 1px solid transparent;
            border-radius: var(--border-radius-md);
            transition: var(--transition-base);
        }

        .btn:disabled {
            opacity: 0.65;
            cursor: not-allowed;
        }

        .btn-primary {
            color: var(--on-primary-color);
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover,
        .btn-primary:focus {
            background-color: var(--primary-color-dark);
            border-color: var(--primary-color-dark);
            color: var(--on-primary-color);
            text-decoration: none;
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-outline-primary:hover,
        .btn-outline-primary:focus {
            color: var(--on-primary-color);
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            text-decoration: none;
        }

        .btn-danger {
            color: var(--on-primary-color);
            background-color: var(--error-color);
            border-color: var(--error-color);
        }

        .btn-danger:hover,
        .btn-danger:focus {
            background-color: hsl(0, 79%, calc(63% - 10%));
            border-color: hsl(0, 79%, calc(63% - 10%));
            color: var(--on-primary-color);
            text-decoration: none;
        }

        .btn-icon {
            padding: var(--spacing-sm);
            line-height: 1;
            /* Ensure icon is centered */
        }

        /* Cards */
        .card {
            background-color: var(--surface-variant-color);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-lg);
            /* Softer radius */
            box-shadow: var(--shadow-md);
            transition: transform var(--transition-duration-fast), box-shadow var(--transition-duration-fast);
            border: 1px solid var(--border-color);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .card-img {
            width: 100%;
            height: 220px;
            /* Increased height */
            object-fit: cover;
            border-radius: var(--border-radius-md) var(--border-radius-md) 0 0;
            /* Match card radius */
            margin-bottom: var(--spacing-md);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
        }

        .card-subtitle {
            color: var(--on-surface-variant-color);
            font-size: 0.9rem;
            margin-bottom: var(--spacing-md);
        }

        .price-tag {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 1.2rem;
            margin-top: var(--spacing-sm);
        }

        /* Gallery */
        .gallery {
            position: relative;
            overflow: hidden;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            background-color: hsl(0, 0%, 90%);
            /* Placeholder BG */
        }

        .gallery-images {
            display: flex;
            transition: transform var(--transition-duration-normal) var(--transition-easing);
        }

        .gallery-image {
            flex: 0 0 100%;
            height: 400px;
            /* Taller gallery */
            object-fit: cover;
            transition: transform 0.4s ease-in-out;
            /* Softer zoom */
        }

        .gallery-image:hover {
            transform: scale(1.05);
            /* Subtle zoom */
            cursor: zoom-in;
        }

        .gallery-nav {
            position: absolute;
            top: 50%;
            width: 100%;
            transform: translateY(-50%);
            display: flex;
            justify-content: space-between;
            padding: 0 var(--spacing-sm);
            opacity: 0;
            /* Hidden by default */
            transition: opacity var(--transition-duration-fast);
        }

        .gallery:hover .gallery-nav {
            opacity: 1;
            /* Show on hover */
        }

        .gallery-nav button {
            background-color: hsla(0, 0%, 0%, 0.6);
            border: none;
            color: var(--on-primary-color);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: 50%;
            /* Circular buttons */
            cursor: pointer;
            font-size: 1.2rem;
            transition: background-color var(--transition-duration-fast);
        }

        .gallery-nav button:hover {
            background-color: hsla(0, 0%, 0%, 0.8);
        }

        .gallery-dots {
            position: absolute;
            bottom: var(--spacing-md);
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: var(--spacing-sm);
        }

        .gallery-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: hsla(0, 0%, 100%, 0.5);
            cursor: pointer;
            transition: background-color var(--transition-duration-fast);
        }

        .gallery-dot.active {
            background-color: hsl(0, 0%, 100%);
        }

        /* Modal */
        .modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: hsla(0, 0%, 0%, 0.5);
            /* Semi-transparent backdrop */
            justify-content: center;
            align-items: center;
            z-index: var(--z-index-modal-backdrop);
            opacity: 0;
            transition: opacity var(--transition-duration-fast);
            padding: var(--spacing-md);
        }

        .modal.open {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background-color: var(--surface-color);
            padding: var(--spacing-xl);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            max-width: 600px;
            width: 100%;
            /* Responsive width */
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform var(--transition-duration-fast) var(--transition-easing);
        }

        .modal.open .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            margin-bottom: 0;
            /* Override default h2 margin */
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--on-surface-variant-color);
            cursor: pointer;
        }

        .modal-close-btn:hover {
            color: var(--error-color);
        }

        /* Chatbox */
        .chatbox-toggle-btn {
            position: fixed;
            bottom: var(--spacing-lg);
            right: var(--spacing-lg);
            z-index: calc(var(--z-index-chatbox) - 1);
            /* Below chatbox itself */
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 1.5rem;
            box-shadow: var(--shadow-lg);
        }

        .chatbox {
            position: fixed;
            bottom: var(--spacing-lg);
            right: var(--spacing-lg);
            background-color: var(--surface-color);
            width: 350px;
            /* Wider chatbox */
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            display: none;
            /* Controlled by JS */
            flex-direction: column;
            height: 450px;
            z-index: var(--z-index-chatbox);
            border: 1px solid var(--border-color);
            transform: translateY(20px) scale(0.95);
            opacity: 0;
            transition: transform var(--transition-duration-normal) var(--transition-easing),
                opacity var(--transition-duration-normal) var(--transition-easing);
        }

        .chatbox.open {
            display: flex;
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .chat-header {
            background-color: var(--primary-color);
            color: var(--on-primary-color);
            padding: var(--spacing-md);
            border-top-left-radius: var(--border-radius-lg);
            border-top-right-radius: var(--border-radius-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            margin-bottom: 0;
            font-size: 1.1rem;
        }

        .chat-close-btn {
            background: none;
            border: none;
            color: var(--on-primary-color);
            font-size: 1.2rem;
            opacity: 0.8;
            cursor: pointer;
        }

        .chat-close-btn:hover {
            opacity: 1;
        }

        .chat-body {
            flex-grow: 1;
            overflow-y: auto;
            padding: var(--spacing-md);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .chat-message {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-md);
            max-width: 80%;
            word-wrap: break-word;
        }

        .chat-message.user {
            background-color: var(--primary-color-light);
            color: var(--primary-color-dark);
            align-self: flex-end;
            border-bottom-right-radius: var(--border-radius-sm);
        }

        .chat-message.bot,
        .chat-message.support {
            background-color: var(--surface-variant-color);
            color: var(--on-surface-color);
            align-self: flex-start;
            border-bottom-left-radius: var(--border-radius-sm);
        }

        .chat-message.error {
            background-color: var(--error-color);
            color: var(--on-primary-color);
            font-size: 0.9rem;
            text-align: center;
            align-self: center;
        }

        .chat-input-area {
            /* Renamed from .chat-input for clarity */
            display: flex;
            border-top: 1px solid var(--border-color);
            padding: var(--spacing-sm);
        }

        .chat-input-area input[type="text"] {
            flex-grow: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            margin-right: var(--spacing-sm);
        }

        .chat-input-area input[type="text"]:focus {
            border-color: var(--primary-color);
            box-shadow: none;
            /* Simpler focus for chat input */
        }

        .chat-input-area button {
            border-radius: var(--border-radius-md);
            padding: var(--spacing-sm) var(--spacing-md);
        }

        /* Calendar */
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
            user-select: none;
        }

        .calendar-header {
            text-align: center;
            font-weight: 600;
            padding: var(--spacing-xs);
            color: var(--on-surface-variant-color);
        }

        .calendar-day {
            padding: var(--spacing-sm);
            text-align: center;
            cursor: pointer;
            border-radius: var(--border-radius-sm);
            transition: background-color var(--transition-duration-fast), color var(--transition-duration-fast);
        }

        .calendar-day:hover:not(.disabled):not(.booked) {
            background-color: var(--primary-color-translucent);
        }

        .calendar-day.disabled {
            color: var(--on-surface-variant-color);
            opacity: 0.5;
            cursor: not-allowed;
        }

        .calendar-day.booked {
            background-color: var(--error-color) !important;
            color: var(--on-primary-color) !important;
            text-decoration: line-through;
            cursor: not-allowed;
        }

        .calendar-day.selected {
            background-color: var(--primary-color) !important;
            color: var(--on-primary-color) !important;
            font-weight: 600;
        }

        .calendar-day.today {
            border: 1px solid var(--primary-color);
            font-weight: 600;
        }

        /* Testimonials */
        .testimonial {
            background-color: var(--surface-color);
            /* Lighter background for contrast */
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--primary-color);
        }

        .testimonial p {
            font-style: italic;
            margin-bottom: var(--spacing-sm);
        }

        .testimonial figcaption {
            text-align: right;
            font-weight: 500;
            color: var(--on-surface-variant-color);
        }

        .testimonial figcaption::before {
            content: "‚Äî ";
        }

        /* Map Placeholder */
        .map-placeholder {
            width: 100%;
            height: 250px;
            background-color: var(--surface-variant-color);
            border: 1px dashed var(--border-color);
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--on-surface-variant-color);
            font-style: italic;
            border-radius: var(--border-radius-md);
        }

        /* Notifications (Toast-like) */
        .app-notification {
            position: fixed;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            background-color: var(--on-surface-color);
            color: var(--surface-color);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-lg);
            z-index: var(--z-index-notification);
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity var(--transition-duration-normal), transform var(--transition-duration-normal);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .app-notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .app-notification.success {
            background-color: var(--success-color);
            color: var(--on-primary-color);
        }

        .app-notification.error {
            background-color: var(--error-color);
            color: var(--on-primary-color);
        }

        .app-notification.info {
            background-color: var(--info-color);
            color: var(--on-primary-color);
        }


        /* Footer */
        .app-footer {
            text-align: center;
            padding: var(--spacing-lg);
            background-color: var(--surface-variant-color);
            color: var(--on-surface-variant-color);
            border-top: 1px solid var(--border-color);
            margin-top: var(--spacing-xl);
            /* Ensure space above footer in main content */
            font-size: 0.9rem;
        }

        /* --------------------- */
        /* -- RESPONSIVE DESIGN -- */
        /* --------------------- */
        @media (max-width: 1024px) {

            /* Tablet */
            .app-sidebar {
                width: 220px;
            }

            .app-main {
                padding: var(--spacing-lg);
            }

            .grid-cols-detail {
                /* For apartment detail layout */
                grid-template-columns: 1fr;
                /* Stack on smaller screens */
            }

            .gallery-image {
                height: 300px;
            }
        }

        @media (max-width: 768px) {

            /* Mobile */
            body {
                flex-direction: column;
                /* Stack sidebar and main content */
            }

            .app-sidebar {
                width: 100%;
                height: auto;
                position: static;
                /* No longer sticky */
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding: var(--spacing-md);
            }

            .app-sidebar-header {
                font-size: 1.5rem;
                margin-bottom: var(--spacing-md);
                text-align: left;
            }

            .app-sidebar nav ul {
                display: flex;
                /* Horizontal scroll for nav items */
                overflow-x: auto;
                padding-bottom: var(--spacing-sm);
                /* For scrollbar */
            }

            .app-sidebar nav ul li {
                flex-shrink: 0;
                /* Prevent items from shrinking */
                margin-right: var(--spacing-sm);
                margin-bottom: 0;
            }

            .app-sidebar-footer {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .app-main {
                padding: var(--spacing-md);
            }

            .search-bar {
                flex-direction: column;
            }

            .search-bar .form-control,
            .search-bar .btn {
                width: 100%;
            }

            .card-grid {
                /* In case you use a specific class for card containers */
                grid-template-columns: 1fr;
            }

            .gallery-image {
                height: 250px;
            }

            .chatbox {
                width: calc(100% - (2 * var(--spacing-md)));
                /* Full width with padding */
                left: var(--spacing-md);
                bottom: var(--spacing-md);
                height: 70vh;
                /* Taller on mobile */
            }

            .chatbox-toggle-btn {
                bottom: var(--spacing-md);
                right: var(--spacing-md);
            }

            .modal-content {
                max-height: 85vh;
                padding: var(--spacing-lg);
            }

            h1 {
                font-size: 1.8rem;
            }

            h2 {
                font-size: 1.5rem;
            }
        }

        /* ----------------- */
        /* -- ACCESSIBILITY -- */
        /* ----------------- */
        [role="button"]:focus,
        button:focus-visible,
        a:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            outline: 3px solid var(--primary-color-light);
            /* Clearer focus */
            outline-offset: 2px;
            box-shadow: 0 0 0 3px var(--primary-color-translucent);
            /* Consistent with form-control */
        }

        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
    </style>
</head>

<body>
    <!-- Sidebar Navigation -->
    <aside class="app-sidebar" role="navigation" aria-label="Navigasi Utama">
        <h2 class="app-sidebar-header">Green Valley</h2>
        <nav>
            <ul>
                <li><a href="#home" data-page="home" class="active" aria-current="page"><i
                            class="nav-icon fas fa-search"></i>Cari</a></li>
                <li><a href="#favorites" data-page="favorites"><i class="nav-icon fas fa-heart"></i>Favorit</a></li>
                <li><a href="#bookings" data-page="bookings"><i class="nav-icon fas fa-calendar-check"></i>Pesanan</a>
                </li>
                <li><a href="#account" data-page="account"><i class="nav-icon fas fa-user-circle"></i>Akun</a></li>
                <li><a href="#support" data-page="support"><i class="nav-icon fas fa-headset"></i>Dukungan</a></li>
            </ul>
        </nav>
        <div class="app-sidebar-footer">
            <div class="user-info flex flex-col gap-xs">
                <p class="font-semibold text-sm" id="sidebar-user-name">Halo, Dinda</p>
                <small class="text-muted text-sm">Penyewa</small>
            </div>
            <button id="theme-toggle-btn" class="theme-switcher btn-icon" aria-label="Ganti Tema">
                <i class="fas fa-moon"></i> <!-- Icon will change with theme -->
            </button>
        </div>
    </aside>

    <!-- Main Content Area -->
    <div class="app-main" role="main">
        <!-- Home Section -->
        <section id="home" class="app-page" aria-labelledby="home-heading">
            <header>
                <h1 id="home-heading">Temukan Apartemen Impian Anda</h1>
                <form class="search-bar grid gap-md my-lg p-lg bg-surface-variant rounded-lg shadow-sm"
                    aria-label="Formulir Pencarian Apartemen">
                    <div class="form-group">
                        <label for="search-lokasi" class="visually-hidden">Lokasi</label>
                        <input type="text" class="form-control" id="search-lokasi"
                            placeholder="Masukkan kota atau area (mis: Jakarta Pusat)" aria-label="Input Lokasi">
                    </div>
                    <div class="form-group">
                        <label for="search-harga" class="visually-hidden">Harga Maksimum</label>
                        <input type="number" class="form-control" id="search-harga" placeholder="Harga Maks (Rp)"
                            aria-label="Input Harga Maksimum">
                    </div>
                    <div class="form-group">
                        <label for="search-radius">Radius Pencarian: <span id="search-radius-value"
                                class="font-semibold">10 km</span></label>
                        <input type="range" class="form-control" id="search-radius" min="1" max="50" value="10"
                            aria-label="Radius pencarian dalam kilometer">
                    </div>
                    <div class="form-group">
                        <label for="search-tipe" class="visually-hidden">Tipe Apartemen</label>
                        <select class="form-control" id="search-tipe" aria-label="Pilih Tipe Apartemen">
                            <option value="">Semua Tipe</option>
                            <option value="Studio">Studio</option>
                            <option value="1BR">1 Kamar Tidur (1BR)</option>
                            <option value="2BR">2 Kamar Tidur (2BR)</option>
                            <option value="3BR+">3+ Kamar Tidur</option>
                        </select>
                    </div>
                    <fieldset class="form-group">
                        <legend class="font-semibold mb-sm">Fasilitas Tambahan:</legend>
                        <div class="flex gap-md flex-wrap">
                            <label class="form-check"><input type="checkbox" name="amenities" value="WiFi"> WiFi</label>
                            <label class="form-check"><input type="checkbox" name="amenities" value="AC"> AC</label>
                            <label class="form-check"><input type="checkbox" name="amenities" value="Pool"> Kolam
                                Renang</label>
                            <label class="form-check"><input type="checkbox" name="amenities" value="Gym"> Gym</label>
                            <label class="form-check"><input type="checkbox" name="amenities" value="Parking">
                                Parkir</label>
                        </div>
                    </fieldset>
                    <button type="submit" class="btn btn-primary w-full"><i class="fas fa-search"></i> Cari
                        Apartemen</button>
                </form>
            </header>
            <div class="card-grid grid grid-cols-auto-fill gap-lg" id="apartemen-list" aria-live="polite"
                aria-atomic="true" aria-label="Daftar Hasil Pencarian Apartemen">
                <!-- Apartment cards will be rendered here by JavaScript -->
                <p id="no-results-message" class="text-center text-muted hidden col-span-full">Tidak ada apartemen yang
                    cocok dengan kriteria pencarian Anda.</p>
            </div>

            <section class="my-lg pt-lg border-t border-border-color" aria-labelledby="testimonial-heading">
                <h2 id="testimonial-heading" class="text-center mb-lg">Apa Kata Mereka?</h2>
                <div class="grid grid-cols-auto-fill gap-lg">
                    <blockquote class="testimonial">
                        <p>"Sangat puas! Proses sewa di Green Valley sangat mudah dan cepat. Apartemen yang saya
                            dapatkan
                            bersih, modern, dan persis seperti di foto. Tim support juga responsif."</p>
                        <figcaption>Rina Amelia, Jakarta</figcaption>
                    </blockquote>
                    <blockquote class="testimonial">
                        <p>"Pilihan apartemennya banyak dan beragam. Fitur pencarian detail sangat membantu saya
                            menemukan unit yang sesuai dengan kebutuhan dan budget. Highly recommended!"</p>
                        <figcaption>Budi Prasetyo, Surabaya</figcaption>
                    </blockquote>
                    <blockquote class="testimonial">
                        <p>"Aplikasi yang intuitif dan desainnya memanjakan mata. Saya suka fitur favorit dan notifikasi
                            update harga. Pengalaman terbaik sewa apartemen sejauh ini."</p>
                        <figcaption>Citra Lestari, Bandung</figcaption>
                    </blockquote>
                </div>
            </section>
        </section>

        <!-- Favorites Section -->
        <section id="favorites" class="app-page hidden" aria-labelledby="favorites-heading">
            <h1 id="favorites-heading" class="my-lg">Apartemen Favorit Anda</h1>
            <div class="card-grid grid grid-cols-auto-fill gap-lg" id="favorites-list"
                aria-label="Daftar Apartemen Favorit">
                <!-- Favorite apartment cards will be rendered here -->
                <p id="no-favorites-message" class="text-center text-muted hidden col-span-full">Anda belum memiliki
                    apartemen favorit. Mulai tambahkan sekarang!</p>
            </div>
        </section>

        <!-- Apartment Detail Section -->
        <section id="apartment-detail" class="app-page hidden" aria-labelledby="apartment-detail-title">
            <!-- Content dynamically loaded by JS -->
            <button class="btn btn-outline-primary mb-md" onclick="app.goBack()"><i class="fas fa-arrow-left"></i>
                Kembali ke Daftar</button>
            <article id="apartment-detail-content">
                <h1 id="apartment-detail-title" class="my-lg"></h1>
                <div class="grid gap-lg grid-cols-detail" style="grid-template-columns: 2fr 1fr;">
                    <!-- Custom grid for this layout -->
                    <div class="apartment-main-info">
                        <figure class="gallery mb-lg rounded-lg" id="apartment-gallery">
                            <div class="gallery-images" id="gallery-images-container">
                                <!-- Images loaded by JS -->
                            </div>
                            <div class="gallery-nav">
                                <button id="gallery-prev-btn" aria-label="Gambar Sebelumnya"><i
                                        class="fas fa-chevron-left"></i></button>
                                <button id="gallery-next-btn" aria-label="Gambar Berikutnya"><i
                                        class="fas fa-chevron-right"></i></button>
                            </div>
                            <div class="gallery-dots" id="gallery-dots-container">
                                <!-- Dots loaded by JS -->
                            </div>
                            <figcaption id="gallery-caption" class="visually-hidden">Galeri gambar apartemen
                            </figcaption>
                        </figure>

                        <div class="card mb-lg">
                            <h2 class="text-xl font-semibold">Deskripsi & Fasilitas</h2>
                            <p id="detail-description" class="text-muted"></p>
                            <p><strong>Harga Sewa:</strong> <span id="detail-price" class="price-tag"></span></p>
                            <p><strong>Lokasi:</strong> <i class="fas fa-map-marker-alt text-primary-color"></i> <span
                                    id="detail-location"></span></p>
                            <p><strong>Tipe Unit:</strong> <span id="detail-type"></span></p>
                            <p><strong>Fasilitas Utama:</strong> <span id="detail-amenities"></span></p>
                        </div>

                        <div class="card mb-lg">
                            <h3 class="text-lg font-semibold">Peta Lokasi (Simulasi)</h3>
                            <div class="map-placeholder my-md rounded-md" id="detail-map-placeholder">Memuat peta...
                            </div>
                        </div>

                        <div class="card mb-lg">
                            <details class="my-md">
                                <summary class="font-semibold text-lg cursor-pointer">Informasi Pemilik/Agen</summary>
                                <div class="mt-md">
                                    <p><strong>Nama:</strong> <span id="owner-name"></span> <span id="owner-status"
                                            class="text-sm"></span></p>
                                    <p class="text-sm text-muted">Terdaftar sejak: <span id="owner-joined-date"></span>
                                    </p>
                                    <button class="btn btn-outline-primary btn-sm mt-sm"
                                        onclick="app.openChat('owner')"><i class="fas fa-comments"></i> Chat dengan
                                        Pemilik/Agen</button>
                                </div>
                            </details>
                        </div>

                        <div class="card">
                            <h3 class="text-lg font-semibold mb-md">Ulasan Penghuni</h3>
                            <div id="reviews-container" aria-label="Ulasan Apartemen">
                                <!-- Reviews loaded by JS -->
                            </div>
                            <p id="no-reviews-message" class="text-muted hidden">Belum ada ulasan untuk apartemen ini.
                            </p>
                            <button class="btn btn-outline-primary mt-md" onclick="app.openModal('add-review-modal')"><i
                                    class="fas fa-plus-circle"></i> Tambah Ulasan</button>
                        </div>

                    </div>

                    <div class="apartment-sidebar-info">
                        <div class="card sticky-booking-form" style="top: var(--spacing-xl);"> <!-- Sticky form -->
                            <h3 class="text-lg font-semibold mb-md">Pesan Apartemen Ini</h3>
                            <div class="calendar mb-md" id="booking-calendar">
                                <!-- Calendar days loaded by JS -->
                            </div>
                            <form id="booking-form" aria-label="Formulir Pemesanan Apartemen">
                                <div class="form-group">
                                    <label for="checkin-date" class="font-semibold">Tanggal Check-in</label>
                                    <input type="date" id="checkin-date" class="form-control" required
                                        aria-label="Tanggal Check-in">
                                </div>
                                <div class="form-group">
                                    <label for="checkout-date" class="font-semibold">Tanggal Check-out</label>
                                    <input type="date" id="checkout-date" class="form-control" required
                                        aria-label="Tanggal Check-out">
                                </div>
                                <div class="form-group">
                                    <label class="form-check">
                                        <input type="checkbox" id="booking-insurance"
                                            aria-label="Tambah Asuransi Perjalanan">
                                        Tambah Asuransi Perjalanan (+10%)
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label for="payment-method" class="font-semibold">Metode Pembayaran</label>
                                    <select id="payment-method" class="form-control"
                                        aria-label="Pilih Metode Pembayaran">
                                        <option value="credit_card">Kartu Kredit/Debit</option>
                                        <option value="bank_transfer">Transfer Bank Virtual Account</option>
                                        <option value="ewallet">E-Wallet (GoPay, OVO, Dana)</option>
                                    </select>
                                </div>
                                <div id="cost-breakdown"
                                    class="text-sm my-md p-md bg-surface rounded-md border border-border-color">
                                    <p class="font-semibold mb-sm">Rincian Biaya:</p>
                                    <!-- Cost breakdown loaded by JS -->
                                    <p>Total Biaya: <strong id="total-booking-cost">Rp 0</strong></p>
                                </div>
                                <button type="submit" class="btn btn-primary w-full"><i class="fas fa-check-circle"></i>
                                    Pesan Sekarang</button>
                                <p class="text-sm text-muted mt-md text-center">Pembayaran Anda aman dan terjamin
                                    melalui sistem escrow kami.</p>
                            </form>
                        </div>
                        <button class="btn btn-danger w-full mt-lg" onclick="app.openModal('report-modal')"><i
                                class="fas fa-flag"></i> Laporkan Properti Ini</button>
                    </div>
                </div>
            </article>
        </section>

        <!-- Bookings Section -->
        <section id="bookings" class="app-page hidden" aria-labelledby="bookings-heading">
            <h1 id="bookings-heading" class="my-lg">Riwayat Pesanan Anda</h1>
            <div class="card-grid grid grid-cols-auto-fill gap-lg" id="booking-list" aria-label="Daftar Pesanan Anda">
                <!-- Booking cards will be rendered here -->
                <p id="no-bookings-message" class="text-center text-muted hidden col-span-full">Anda belum memiliki
                    riwayat pesanan.</p>
            </div>
        </section>

        <!-- Account Section -->
        <section id="account" class="app-page hidden" aria-labelledby="account-heading">
            <h1 id="account-heading" class="my-lg">Informasi Akun Anda</h1>
            <div class="grid gap-lg" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                <div class="card">
                    <h2 class="text-xl font-semibold mb-md">Profil Pengguna</h2>
                    <p><strong>Nama:</strong> <span id="user-profile-name">Dinda Ayu</span></p>
                    <p><strong>Email:</strong> <span id="user-profile-email">dinda.ayu@example.com</span></p>
                    <p><strong>Telepon:</strong> <span id="user-profile-phone">081234567890</span></p>
                    <p><strong>Terdaftar Sejak:</strong> <span id="user-profile-joined">15 Januari 2024</span></p>
                    <button class="btn btn-outline-primary mt-lg" onclick="app.openModal('edit-profile-modal')"><i
                            class="fas fa-edit"></i> Edit Profil</button>
                </div>
                <div class="card">
                    <h2 class="text-xl font-semibold mb-md">Keamanan & Preferensi</h2>
                    <p><strong>Poin Loyalitas:</strong> <span id="user-loyalty-points"
                            class="font-bold text-primary-color">1250 Poin</span></p>
                    <div class="form-group">
                        <label class="form-check">
                            <input type="checkbox" id="notification-prefs" checked>
                            Terima Notifikasi Email
                        </label>
                    </div>
                    <button class="btn btn-outline-primary mt-md" onclick="app.openModal('change-password-modal')"><i
                            class="fas fa-key"></i> Ubah Kata Sandi</button>
                </div>
            </div>
        </section>

        <!-- Support Section -->
        <section id="support" class="app-page hidden" aria-labelledby="support-heading">
            <h1 id="support-heading" class="my-lg">Pusat Bantuan & Dukungan</h1>
            <p class="text-muted mb-lg">Kami siap membantu Anda 24/7. Pilih salah satu opsi di bawah ini untuk
                menghubungi tim dukungan kami atau temukan jawaban atas pertanyaan Anda.</p>
            <div class="grid grid-cols-auto-fill gap-lg">
                <div class="card text-center">
                    <i class="fas fa-comments fa-3x text-primary-color mb-md"></i>
                    <h3 class="text-xl font-semibold mb-md">Live Chat</h3>
                    <p class="text-muted mb-md">Dapatkan bantuan instan dari tim kami.</p>
                    <button class="btn btn-primary" onclick="app.openChat('support')"><i
                            class="fas fa-comment-dots"></i> Mulai Chat Sekarang</button>
                </div>
                <div class="card text-center">
                    <i class="fas fa-envelope fa-3x text-primary-color mb-md"></i>
                    <h3 class="text-xl font-semibold mb-md">Kirim Email</h3>
                    <p class="text-muted mb-md">Hubungi kami melalui email untuk pertanyaan lebih detail.</p>
                    <a href="mailto:dukungan@Green Valley.com" class="btn btn-outline-primary"><i
                            class="fas fa-paper-plane"></i> dukungan@Green Valley.com</a>
                </div>
                <div class="card text-center">
                    <i class="fas fa-phone-alt fa-3x text-primary-color mb-md"></i>
                    <h3 class="text-xl font-semibold mb-md">Hotline Telepon</h3>
                    <p class="text-muted mb-md">Bicara langsung dengan tim customer service kami.</p>
                    <a href="tel:+628001234567" class="btn btn-outline-primary"><i class="fas fa-phone"></i> +62 800 123
                        4567</a>
                </div>
                <div class="card text-center">
                    <i class="fas fa-question-circle fa-3x text-primary-color mb-md"></i>
                    <h3 class="text-xl font-semibold mb-md">FAQ (Tanya Jawab)</h3>
                    <p class="text-muted mb-md">Temukan jawaban untuk pertanyaan umum.</p>
                    <button class="btn btn-outline-primary" onclick="app.openModal('faq-modal')"><i
                            class="fas fa-book-open"></i> Lihat FAQ</button>
                </div>
            </div>
        </section>

        <footer class="app-footer">
            <p>&copy; <span id="current-year"></span> Green Valley - Platform Penyewaan Apartemen Impian Anda. Hak Cipta
                Dilindungi.</p>
            <p class="text-sm">Dirancang dengan ‚ù§Ô∏è oleh Tim Green Valley Native.</p>
        </footer>
    </div>

    <!-- Modals Container -->
    <div id="modal-container">
        <!-- Edit Profile Modal -->
        <div class="modal" id="edit-profile-modal" role="dialog" aria-labelledby="edit-profile-heading"
            aria-modal="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="edit-profile-heading" class="text-xl font-semibold">Edit Profil Anda</h2>
                    <button class="modal-close-btn" aria-label="Tutup Modal"
                        onclick="app.closeModal('edit-profile-modal')"><i class="fas fa-times"></i></button>
                </div>
                <form id="edit-profile-form" aria-label="Formulir Edit Profil">
                    <div class="form-group">
                        <label for="edit-name" class="font-semibold">Nama Lengkap</label>
                        <input type="text" id="edit-name" class="form-control" value="Dinda Ayu" required
                            aria-describedby="edit-name-help">
                        <small id="edit-name-help" class="text-muted">Nama yang akan ditampilkan di profil Anda.</small>
                    </div>
                    <div class="form-group">
                        <label for="edit-email" class="font-semibold">Alamat Email</label>
                        <input type="email" id="edit-email" class="form-control" value="dinda.ayu@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-phone" class="font-semibold">Nomor Telepon</label>
                        <input type="tel" id="edit-phone" class="form-control" value="081234567890">
                    </div>
                    <div class="flex gap-md mt-lg">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Simpan
                            Perubahan</button>
                        <button type="button" class="btn btn-outline-primary"
                            onclick="app.closeModal('edit-profile-modal')">Batal</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Report Issue Modal -->
        <div class="modal" id="report-modal" role="dialog" aria-labelledby="report-heading" aria-modal="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="report-heading" class="text-xl font-semibold">Laporkan Properti/Masalah</h2>
                    <button class="modal-close-btn" aria-label="Tutup Modal" onclick="app.closeModal('report-modal')"><i
                            class="fas fa-times"></i></button>
                </div>
                <form id="report-form" aria-label="Formulir Pelaporan Masalah">
                    <div class="form-group">
                        <label for="report-category" class="font-semibold">Kategori Laporan</label>
                        <select id="report-category" class="form-control" required>
                            <option value="">Pilih Kategori...</option>
                            <option value="informasi_tidak_akurat">Informasi Properti Tidak Akurat</option>
                            <option value="foto_menyesatkan">Foto Menyesatkan</option>
                            <option value="properti_tidak_tersedia">Properti Sudah Tidak Tersedia</option>
                            <option value="perilaku_pemilik">Perilaku Pemilik/Agen Mencurigakan</option>
                            <option value="bug_teknis">Bug atau Masalah Teknis di Aplikasi</option>
                            <option value="lainnya">Lainnya</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="report-description" class="font-semibold">Deskripsi Masalah</label>
                        <textarea id="report-description" class="form-control" rows="5"
                            placeholder="Jelaskan masalah yang Anda temui secara detail..." required
                            aria-label="Deskripsi Masalah"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="report-attachment" class="font-semibold">Lampiran (Opsional)</label>
                        <input type="file" id="report-attachment" class="form-control"
                            aria-label="Lampirkan Berkas Pendukung">
                        <small class="text-muted">Format: JPG, PNG, PDF. Maks: 2MB.</small>
                    </div>
                    <div class="flex gap-md mt-lg">
                        <button type="submit" class="btn btn-danger"><i class="fas fa-paper-plane"></i> Kirim
                            Laporan</button>
                        <button type="button" class="btn btn-outline-primary"
                            onclick="app.closeModal('report-modal')">Batal</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Review Modal -->
        <div class="modal" id="add-review-modal" role="dialog" aria-labelledby="add-review-heading" aria-modal="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="add-review-heading" class="text-xl font-semibold">Bagikan Ulasan Anda</h2>
                    <button class="modal-close-btn" aria-label="Tutup Modal"
                        onclick="app.closeModal('add-review-modal')"><i class="fas fa-times"></i></button>
                </div>
                <form id="add-review-form" aria-label="Formulir Tambah Ulasan">
                    <div class="form-group">
                        <label class="font-semibold">Rating Keseluruhan</label>
                        <div id="review-rating-stars" class="flex gap-xs text-2xl text-warning-color"
                            aria-label="Pilih Rating Bintang">
                            <i class="far fa-star cursor-pointer" data-value="1"></i>
                            <i class="far fa-star cursor-pointer" data-value="2"></i>
                            <i class="far fa-star cursor-pointer" data-value="3"></i>
                            <i class="far fa-star cursor-pointer" data-value="4"></i>
                            <i class="far fa-star cursor-pointer" data-value="5"></i>
                        </div>
                        <input type="hidden" id="review-rating-value" name="rating" required>
                    </div>
                    <div class="form-group">
                        <label for="review-comment" class="font-semibold">Ulasan Anda</label>
                        <textarea id="review-comment" class="form-control" rows="5"
                            placeholder="Ceritakan pengalaman Anda menginap di properti ini..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-check">
                            <input type="checkbox" id="review-anonymous">
                            Kirim sebagai anonim
                        </label>
                    </div>
                    <div class="flex gap-md mt-lg">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-check"></i> Kirim Ulasan</button>
                        <button type="button" class="btn btn-outline-primary"
                            onclick="app.closeModal('add-review-modal')">Batal</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Change Password Modal (Placeholder) -->
        <div class="modal" id="change-password-modal" role="dialog" aria-labelledby="change-password-heading"
            aria-modal="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="change-password-heading" class="text-xl font-semibold">Ubah Kata Sandi</h2>
                    <button class="modal-close-btn" aria-label="Tutup Modal"
                        onclick="app.closeModal('change-password-modal')"><i class="fas fa-times"></i></button>
                </div>
                <p class="text-muted">Fitur ubah kata sandi sedang dalam pengembangan. Silakan cek kembali nanti.</p>
                <button type="button" class="btn btn-primary mt-lg"
                    onclick="app.closeModal('change-password-modal')">Mengerti</button>
            </div>
        </div>

        <!-- FAQ Modal (Placeholder) -->
        <div class="modal" id="faq-modal" role="dialog" aria-labelledby="faq-heading" aria-modal="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="faq-heading" class="text-xl font-semibold">Pertanyaan Umum (FAQ)</h2>
                    <button class="modal-close-btn" aria-label="Tutup Modal" onclick="app.closeModal('faq-modal')"><i
                            class="fas fa-times"></i></button>
                </div>
                <p class="text-muted">Halaman FAQ sedang dalam tahap penyempurnaan. Terima kasih atas kesabaran Anda.
                </p>
                <details class="my-md p-md border border-border-color rounded-md">
                    <summary class="font-semibold cursor-pointer">Bagaimana cara memesan apartemen?</summary>
                    <p class="mt-sm text-muted">Cari apartemen yang Anda inginkan, pilih tanggal, lalu klik tombol
                        "Pesan Sekarang" dan ikuti instruksi pembayaran.</p>
                </details>
                <details class="my-md p-md border border-border-color rounded-md">
                    <summary class="font-semibold cursor-pointer">Apakah pembayaran saya aman?</summary>
                    <p class="mt-sm text-muted">Ya, semua pembayaran diproses melalui sistem escrow yang aman untuk
                        melindungi dana Anda hingga proses check-in selesai.</p>
                </details>
                <button type="button" class="btn btn-primary mt-lg" onclick="app.closeModal('faq-modal')">Tutup</button>
            </div>
        </div>

    </div> <!-- End Modal Container -->

    <!-- Chatbox Toggle & Window -->
    <button class="btn btn-primary chatbox-toggle-btn" id="chat-toggle-btn" aria-label="Buka atau Tutup Jendela Chat"
        aria-expanded="false" aria-controls="chatbox-window">
        <i class="fas fa-comments"></i>
    </button>
    <div class="chatbox" id="chatbox-window" role="log" aria-live="polite" aria-relevant="additions"
        aria-atomic="false">
        <div class="chat-header">
            <h3 id="chatbox-title">Dukungan Pelanggan</h3>
            <button class="chat-close-btn" aria-label="Tutup Chat" onclick="app.toggleChatbox(false)">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-body" id="chat-messages-container">
            <!-- Chat messages will be rendered here by JavaScript -->
            <div class="chat-message support">Selamat datang di Green Valley! Ada yang bisa kami bantu hari ini?</div>
        </div>
        <form class="chat-input-area" id="chat-form" aria-label="Formulir Input Pesan Chat">
            <input type="text" id="chat-input-message" class="form-control" placeholder="Ketik pesan Anda..."
                aria-label="Input Pesan Chat">
            <button type="submit" class="btn btn-primary btn-icon" aria-label="Kirim Pesan">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>

    <!-- App Notification Area (Toast) -->
    <div id="app-notification-area">
        <!-- Notifications will be injected here -->
    </div>

    <script>
        // ==========================================================================================
        // Green Valley NATIVE SINGLE PAGE APPLICATION (SPA) - VANILLA JAVASCRIPT
        // ==========================================================================================
        // Author: Green Valley Native Team
        // Version: 1.0.0
        // Description: Core JavaScript for Green Valley, a modern apartment rental platform.
        // Built with Vanilla JS, HTML5, and CSS3 for optimal performance and maintainability.
        // ==========================================================================================

        /**
         * @class AppUtils
         * @description Kumpulan fungsi utilitas untuk aplikasi Green Valley.
         */
        const AppUtils = {
            /**
             * Memformat angka menjadi format mata uang Rupiah.
             * @param {number} number - Angka yang akan diformat.
             * @returns {string} String mata uang Rupiah (e.g., "Rp 1.500.000").
             */
            formatCurrency: (number) => {
                if (typeof number !== 'number' || isNaN(number)) {
                    return "Rp 0";
                }
                return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
            },

            /**
             * Menghasilkan ID unik sederhana.
             * @returns {string} ID unik.
             */
            generateUID: () => `uid-${Date.now().toString(36)}-${Math.random().toString(36).substr(2, 5)}`,

            /**
             * Membersihkan string HTML untuk mencegah XSS (implementasi dasar).
             * @param {string} str - String yang akan dibersihkan.
             * @returns {string} String yang sudah dibersihkan.
             */
            sanitizeHTML: (str) => {
                if (!str) return '';
                const temp = document.createElement('div');
                temp.textContent = str;
                return temp.innerHTML;
            },

            /**
             * Menyimpan data ke localStorage dengan error handling.
             * @param {string} key - Kunci penyimpanan.
             * @param {any} value - Nilai yang akan disimpan.
             */
            saveToLocalStorage: (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (e) {
                    console.warn(`Gagal menyimpan '${key}' ke localStorage:`, e);
                    // Mungkin tampilkan notifikasi ke pengguna jika penyimpanan kritis gagal
                }
            },

            /**
             * Memuat data dari localStorage dengan error handling.
             * @param {string} key - Kunci penyimpanan.
             * @param {any} defaultValue - Nilai default jika data tidak ditemukan atau error.
             * @returns {any} Data yang dimuat atau nilai default.
             */
            loadFromLocalStorage: (key, defaultValue) => {
                try {
                    const storedValue = localStorage.getItem(key);
                    return storedValue ? JSON.parse(storedValue) : defaultValue;
                } catch (e) {
                    console.warn(`Gagal memuat '${key}' dari localStorage, menggunakan nilai default:`, e);
                    return defaultValue;
                }
            },

            /**
             * Memformat tanggal menjadi format yang lebih mudah dibaca.
             * @param {string | Date} dateInput - Tanggal dalam string atau objek Date.
             * @param {object} options - Opsi format Intl.DateTimeFormat.
             * @returns {string} Tanggal yang diformat.
             */
            formatDate: (dateInput, options = { year: 'numeric', month: 'long', day: 'numeric' }) => {
                try {
                    return new Date(dateInput).toLocaleDateString('id-ID', options);
                } catch (e) {
                    return 'Tanggal tidak valid';
                }
            },

            /**
             * Debounce function untuk menunda eksekusi fungsi.
             * @param {Function} func - Fungsi yang akan di-debounce.
             * @param {number} delay - Waktu tunda dalam milidetik.
             * @returns {Function} Fungsi yang sudah di-debounce.
             */
            debounce: (func, delay) => {
                let timeoutId;
                return (...args) => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => func.apply(this, args), delay);
                };
            },
        };

        /**
         * @class SimulatedBackendService
         * @description Kelas untuk menyimulasikan interaksi dengan layanan backend.
         * Ini membantu dalam pengembangan frontend tanpa ketergantungan backend langsung.
         */
        class SimulatedBackendService {
            constructor() {
                this.latency = 500; // Latency simulasi dalam ms
            }

            _simulateRequest(data, successCondition = true) {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        if (successCondition) {
                            resolve({ success: true, data: data, timestamp: new Date().toISOString() });
                        } else {
                            reject({ success: false, message: "Operasi gagal disimulasikan.", timestamp: new Date().toISOString() });
                        }
                    }, this.latency);
                });
            }

            async processPayment(paymentDetails) {
                // Simulasi: Pembayaran selalu berhasil
                console.log("Memproses pembayaran:", paymentDetails);
                const transactionId = `TRX-${AppUtils.generateUID()}`;
                return this._simulateRequest({ transactionId, message: "Pembayaran berhasil diproses." });
            }

            async submitReport(reportData) {
                console.log("Mengirim laporan:", reportData);
                // Simulasi: Laporan selalu berhasil dikirim
                return this._simulateRequest({ message: "Laporan Anda telah berhasil dikirim." });
            }

            async submitReview(reviewData) {
                console.log("Mengirim ulasan:", reviewData);
                // Simulasi: Ulasan selalu berhasil dikirim
                return this._simulateRequest({ reviewId: AppUtils.generateUID(), ...reviewData });
            }

            async sendMessageToChat(messageData) {
                console.log("Mengirim pesan chat:", messageData);
                let replyMessage = "Terima kasih atas pesan Anda. Kami akan segera merespons.";
                if (messageData.type === 'owner') {
                    replyMessage = `Pemilik: Pesan Anda "${messageData.text}" telah diterima. Akan kami tindak lanjuti.`;
                } else if (messageData.text.toLowerCase().includes("halo")) {
                    replyMessage = "Halo! Ada yang bisa kami bantu?";
                } else if (messageData.text.toLowerCase().includes("bantuan")) {
                    replyMessage = "Tentu, silakan jelaskan masalah atau pertanyaan Anda.";
                }
                return this._simulateRequest({
                    id: AppUtils.generateUID(),
                    text: replyMessage,
                    sender: messageData.type === 'owner' ? 'owner' : 'support',
                    timestamp: new Date().toISOString()
                });
            }

            async updateUserProfile(profileData) {
                console.log("Memperbarui profil pengguna:", profileData);
                return this._simulateRequest({ ...profileData, message: "Profil berhasil diperbarui." });
            }

            // Simulasi layanan peta
            renderMap(elementId, location, radius) {
                const mapElement = document.getElementById(elementId);
                if (mapElement) {
                    mapElement.innerHTML = `
                    <p class="text-sm">Menampilkan peta untuk: <strong>${AppUtils.sanitizeHTML(location)}</strong></p>
                    <p class="text-sm">Radius pencarian: <strong>${radius} km</strong></p>
                    <p class="text-xs text-muted">(Ini adalah simulasi peta. Integrasi peta nyata seperti Google Maps/Leaflet akan memerlukan API key dan library eksternal.)</p>
                `;
                }
            }
        }

        /**
         * @class Green ValleyApp
         * @description Kelas utama aplikasi Green Valley. Mengelola state, routing, rendering, dan interaksi pengguna.
         */
        class Green ValleyApp {
            constructor() {
                this.state = {
                    // Data inti
                    properties: this.getInitialProperties(), // Data apartemen
                    currentUser: { // Informasi pengguna yang login
                        id: 'user-dinda-001',
                        name: 'Dinda Ayu',
                        email: 'dinda.ayu@example.com',
                        phone: '081234567890',
                        role: 'penyewa', // 'penyewa' atau 'pemilik'
                        loyaltyPoints: 1250,
                        joinedDate: '2024-01-15T10:00:00Z',
                        preferences: {
                            notificationsEnabled: true,
                        }
                    },
                    favorites: AppUtils.loadFromLocalStorage('Green Valley_favorites', []), // ID properti favorit
                    bookings: AppUtils.loadFromLocalStorage('Green Valley_bookings', []),   // Objek pesanan

                    // State UI & Navigasi
                    currentView: 'home',            // Halaman yang sedang aktif
                    selectedApartmentId: null,      // ID apartemen yang sedang dilihat detailnya
                    galleryState: {
                        currentIndex: 0,
                        images: []
                    },
                    chatState: {
                        isOpen: false,
                        type: 'support', // 'support' or 'owner'
                        messages: []
                    },
                    currentTheme: AppUtils.loadFromLocalStorage('Green Valley_theme', 'light'),
                    lastSearchCriteria: null, // Menyimpan kriteria pencarian terakhir
                    previousView: null, // Menyimpan view sebelumnya untuk tombol back
                };

                this.uiElements = {}; // Cache untuk elemen UI yang sering diakses
                this.backendService = new SimulatedBackendService(); // Layanan backend simulasi
                this.eventListeners = []; // Untuk melacak event listener yang perlu dihapus

                this._initializeApplication();
            }

            // ======================================================================================
            // INISIALISASI & SETUP APLIKASI
            // ======================================================================================

            /**
             * Inisialisasi seluruh aplikasi.
             * @private
             */
            _initializeApplication() {
                this._cacheUIElements();
                this._setupEventListeners();
                this._applyInitialTheme();

                // Inisialisasi tampilan berdasarkan hash URL atau default ke 'home'
                const initialView = window.location.hash.substring(1) || 'home';
                this.navigateTo(initialView, true); // true untuk replace history state awal

                // Update elemen UI yang bergantung pada state awal
                this._updateSidebarUserInfo();
                this._updateFooterYear();

                console.info("Green Valley Application Initialized");
            }

            /**
             * Meng-cache elemen DOM yang sering digunakan untuk performa.
             * @private
             */
            _cacheUIElements() {
                this.uiElements = {
                    // Navigasi & Pages
                    sidebarNavLinks: document.querySelectorAll('.app-sidebar nav a'),
                    appPages: document.querySelectorAll('.app-page'),

                    // Home Page
                    apartemenListContainer: document.getElementById('apartemen-list'),
                    noResultsMessage: document.getElementById('no-results-message'),
                    searchForm: document.querySelector('.search-bar'),
                    searchInputLokasi: document.getElementById('search-lokasi'),
                    searchInputHarga: document.getElementById('search-harga'),
                    searchInputRadius: document.getElementById('search-radius'),
                    searchRadiusValue: document.getElementById('search-radius-value'),
                    searchSelectTipe: document.getElementById('search-tipe'),
                    searchAmenitiesCheckboxes: document.querySelectorAll('input[name="amenities"]'),

                    // Favorites Page
                    favoritesListContainer: document.getElementById('favorites-list'),
                    noFavoritesMessage: document.getElementById('no-favorites-message'),

                    // Apartment Detail Page
                    apartmentDetailContent: document.getElementById('apartment-detail-content'),
                    apartmentDetailTitle: document.getElementById('apartment-detail-title'),
                    galleryImagesContainer: document.getElementById('gallery-images-container'),
                    galleryDotsContainer: document.getElementById('gallery-dots-container'),
                    galleryPrevBtn: document.getElementById('gallery-prev-btn'),
                    galleryNextBtn: document.getElementById('gallery-next-btn'),
                    detailDescription: document.getElementById('detail-description'),
                    detailPrice: document.getElementById('detail-price'),
                    detailLocation: document.getElementById('detail-location'),
                    detailType: document.getElementById('detail-type'),
                    detailAmenities: document.getElementById('detail-amenities'),
                    detailMapPlaceholder: document.getElementById('detail-map-placeholder'),
                    ownerName: document.getElementById('owner-name'),
                    ownerStatus: document.getElementById('owner-status'),
                    ownerJoinedDate: document.getElementById('owner-joined-date'),
                    reviewsContainer: document.getElementById('reviews-container'),
                    noReviewsMessage: document.getElementById('no-reviews-message'),
                    bookingCalendarContainer: document.getElementById('booking-calendar'),
                    bookingForm: document.getElementById('booking-form'),
                    checkinDateInput: document.getElementById('checkin-date'),
                    checkoutDateInput: document.getElementById('checkout-date'),
                    bookingInsuranceCheckbox: document.getElementById('booking-insurance'),
                    paymentMethodSelect: document.getElementById('payment-method'),
                    totalBookingCostElement: document.getElementById('total-booking-cost'),
                    costBreakdownContainer: document.getElementById('cost-breakdown'),

                    // Bookings Page
                    bookingListContainer: document.getElementById('booking-list'),
                    noBookingsMessage: document.getElementById('no-bookings-message'),

                    // Account Page
                    userProfileName: document.getElementById('user-profile-name'),
                    userProfileEmail: document.getElementById('user-profile-email'),
                    userProfilePhone: document.getElementById('user-profile-phone'),
                    userProfileJoined: document.getElementById('user-profile-joined'),
                    userLoyaltyPoints: document.getElementById('user-loyalty-points'),
                    notificationPrefsCheckbox: document.getElementById('notification-prefs'),
                    sidebarUserName: document.getElementById('sidebar-user-name'),

                    // Modals
                    modalContainer: document.getElementById('modal-container'),
                    allModals: document.querySelectorAll('.modal'),
                    editProfileModal: document.getElementById('edit-profile-modal'),
                    editProfileForm: document.getElementById('edit-profile-form'),
                    editProfileNameInput: document.getElementById('edit-name'),
                    editProfileEmailInput: document.getElementById('edit-email'),
                    editProfilePhoneInput: document.getElementById('edit-phone'),
                    reportModal: document.getElementById('report-modal'),
                    reportForm: document.getElementById('report-form'),
                    reportCategorySelect: document.getElementById('report-category'),
                    reportDescriptionTextarea: document.getElementById('report-description'),
                    addReviewModal: document.getElementById('add-review-modal'),
                    addReviewForm: document.getElementById('add-review-form'),
                    reviewRatingStarsContainer: document.getElementById('review-rating-stars'),
                    reviewRatingValueInput: document.getElementById('review-rating-value'),
                    reviewCommentTextarea: document.getElementById('review-comment'),

                    // Chatbox
                    chatToggleBtn: document.getElementById('chat-toggle-btn'),
                    chatboxWindow: document.getElementById('chatbox-window'),
                    chatboxTitle: document.getElementById('chatbox-title'),
                    chatMessagesContainer: document.getElementById('chat-messages-container'),
                    chatForm: document.getElementById('chat-form'),
                    chatInputMessage: document.getElementById('chat-input-message'),

                    // Theme & Footer
                    themeToggleBtn: document.getElementById('theme-toggle-btn'),
                    htmlElement: document.documentElement,
                    footerYear: document.getElementById('current-year'),

                    // Notifications
                    appNotificationArea: document.getElementById('app-notification-area'),
                };
            }

            /**
             * Menyiapkan semua event listener utama aplikasi.
             * @private
             */
            _setupEventListeners() {
                // Navigasi Sidebar
                this.uiElements.sidebarNavLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.navigateTo(link.dataset.page);
                    });
                });

                // Navigasi Browser (Back/Forward)
                window.addEventListener('popstate', (e) => {
                    const view = e.state?.view || (window.location.hash.substring(1) || 'home');
                    this.navigateTo(view, false, true); // false: don't push, true: isPopState
                });

                // Tema Aplikasi
                this.uiElements.themeToggleBtn.addEventListener('click', () => this.toggleTheme());

                // Form Pencarian
                if (this.uiElements.searchForm) {
                    this.uiElements.searchForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleSearchProperties();
                    });
                    this.uiElements.searchInputRadius.addEventListener('input', (e) => {
                        this.uiElements.searchRadiusValue.textContent = `${e.target.value} km`;
                    });
                }

                // Tombol Kembali di Detail Apartemen
                const backButton = document.querySelector('#apartment-detail button[onclick="app.goBack()"]');
                if (backButton) {
                    backButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.goBack();
                    });
                }

                // Form Booking
                if (this.uiElements.bookingForm) {
                    this.uiElements.bookingForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleProcessBooking();
                    });
                    // Update rincian biaya saat tanggal atau asuransi berubah
                    ['change', 'input'].forEach(eventType => {
                        this.uiElements.checkinDateInput.addEventListener(eventType, () => this._updateBookingCostBreakdown());
                        this.uiElements.checkoutDateInput.addEventListener(eventType, () => this._updateBookingCostBreakdown());
                        this.uiElements.bookingInsuranceCheckbox.addEventListener(eventType, () => this._updateBookingCostBreakdown());
                    });
                }

                // Modal: Edit Profil
                if (this.uiElements.editProfileForm) {
                    this.uiElements.editProfileForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleUpdateProfile();
                    });
                }

                // Modal: Lapor Masalah
                if (this.uiElements.reportForm) {
                    this.uiElements.reportForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleReportIssue();
                    });
                }

                // Modal: Tambah Ulasan
                if (this.uiElements.addReviewForm) {
                    this.uiElements.addReviewForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleAddReview();
                    });
                    // Rating stars interaction
                    this.uiElements.reviewRatingStarsContainer.querySelectorAll('.far.fa-star').forEach(star => {
                        star.addEventListener('click', (e) => this._handleStarRatingClick(e));
                        star.addEventListener('mouseover', (e) => this._handleStarRatingHover(e, true));
                        star.addEventListener('mouseout', () => this._handleStarRatingHover(null, false));
                    });
                }


                // Chatbox
                this.uiElements.chatToggleBtn.addEventListener('click', () => this.toggleChatbox());
                if (this.uiElements.chatForm) {
                    this.uiElements.chatForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleSendChatMessage();
                    });
                }

                // Event listener untuk menutup modal dengan tombol Escape
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        const openModal = document.querySelector('.modal.open');
                        if (openModal) {
                            this.closeModal(openModal.id);
                        } else if (this.state.chatState.isOpen) {
                            this.toggleChatbox(false);
                        }
                    }
                });

                // Event listener untuk menutup modal dengan klik di luar konten modal
                this.uiElements.allModals.forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) { // Jika klik pada backdrop modal
                            this.closeModal(modal.id);
                        }
                    });
                });
            }

            _handleStarRatingClick(event) {
                const rating = event.target.dataset.value;
                this.uiElements.reviewRatingValueInput.value = rating;
                this._updateStarRatingDisplay(rating);
            }

            _handleStarRatingHover(event, isHovering) {
                if (!isHovering) { // On mouseout, revert to selected rating
                    this._updateStarRatingDisplay(this.uiElements.reviewRatingValueInput.value);
                    return;
                }
                const hoverRating = event.target.dataset.value;
                this._updateStarRatingDisplay(hoverRating, true);
            }

            _updateStarRatingDisplay(rating, isPreview = false) {
                const stars = this.uiElements.reviewRatingStarsContainer.querySelectorAll('.far.fa-star, .fas.fa-star');
                stars.forEach(star => {
                    if (star.dataset.value <= rating) {
                        star.classList.remove('far');
                        star.classList.add('fas'); // Solid star
                    } else {
                        star.classList.remove('fas');
                        star.classList.add('far'); // Outline star
                    }
                    if (isPreview) { // Add subtle effect for hover preview
                        star.style.opacity = star.dataset.value <= rating ? '1' : '0.7';
                    } else {
                        star.style.opacity = '1';
                    }
                });
            }


            // ======================================================================================
            // MANAJEMEN NAVIGASI & TAMPILAN (VIEW)
            // ======================================================================================

            /**
             * Pindah ke tampilan/halaman tertentu.
             * @param {string} viewId - ID halaman tujuan (e.g., 'home', 'favorites').
             * @param {boolean} [replaceState=false] - Apakah akan mengganti history state (untuk navigasi awal).
             * @param {boolean} [isPopState=false] - Apakah navigasi dipicu oleh popstate (browser back/forward).
             */
            navigateTo(viewId, replaceState = false, isPopState = false) {
                if (!viewId || typeof viewId !== 'string') {
                    console.warn(`Navigasi gagal: viewId tidak valid '${viewId}'. Kembali ke 'home'.`);
                    viewId = 'home';
                }

                if (this.state.currentView !== viewId) {
                    this.state.previousView = this.state.currentView;
                }
                this.state.currentView = viewId;

                // Update URL hash dan history state (kecuali jika dari popstate)
                if (!isPopState) {
                    const historyMethod = replaceState ? 'replaceState' : 'pushState';
                    window.history[historyMethod]({ view: viewId }, `Green Valley - ${viewId}`, `#${viewId}`);
                }

                // Tampilkan halaman yang aktif, sembunyikan yang lain
                this.uiElements.appPages.forEach(page => {
                    page.classList.toggle('hidden', page.id !== viewId);
                });

                // Update status 'active' pada link navigasi sidebar
                this.uiElements.sidebarNavLinks.forEach(link => {
                    const isActive = link.dataset.page === viewId;
                    link.classList.toggle('active', isActive);
                    link.setAttribute('aria-current', isActive ? 'page' : 'false');
                });

                // Panggil fungsi untuk memuat data spesifik untuk halaman tersebut
                this._loadViewData(viewId);

                // Scroll ke atas halaman
                window.scrollTo({ top: 0, behavior: 'smooth' });

                // Umumkan perubahan halaman untuk screen reader
                this._announceNavigation(viewId);

                console.log(`Navigated to: ${viewId}`);
            }

            /**
             * Kembali ke view sebelumnya (jika ada).
             */
            goBack() {
                if (this.state.previousView && this.state.previousView !== this.state.currentView) {
                    this.navigateTo(this.state.previousView);
                } else {
                    // Fallback jika tidak ada previousView atau sama dengan currentView
                    // Bisa juga menggunakan window.history.back() tapi navigateTo lebih terkontrol
                    this.navigateTo('home');
                }
            }

            /**
             * Memuat data yang relevan berdasarkan tampilan yang aktif.
             * @param {string} viewId - ID halaman yang aktif.
             * @private
             */
            _loadViewData(viewId) {
                // Bersihkan listener spesifik halaman sebelumnya jika ada
                // this._clearPageSpecificListeners();

                switch (viewId) {
                    case 'home':
                        // Jika ada kriteria pencarian terakhir, gunakan itu. Jika tidak, tampilkan semua.
                        if (this.state.lastSearchCriteria) {
                            this._applyLastSearchCriteria();
                            this._renderProperties(this.filterProperties(this.state.lastSearchCriteria));
                        } else {
                            this._renderProperties(this.state.properties);
                        }
                        this.backendService.renderMap('detail-map-placeholder', 'Area Pencarian Umum', 10); // Reset peta
                        break;
                    case 'favorites':
                        this._renderFavorites();
                        break;
                    case 'apartment-detail':
                        if (this.state.selectedApartmentId) {
                            this._renderApartmentDetail(this.state.selectedApartmentId);
                        } else {
                            // Jika tidak ada apartemen terpilih, kembali ke home atau tampilkan pesan
                            this.showNotification("Apartemen tidak ditemukan. Kembali ke halaman utama.", "error");
                            this.navigateTo('home');
                        }
                        break;
                    case 'bookings':
                        this._renderBookings();
                        break;
                    case 'account':
                        this._renderAccountPage();
                        break;
                    case 'support':
                        // Tidak ada data spesifik yang perlu dimuat untuk halaman support statis ini
                        break;
                    default:
                        console.warn(`View '${viewId}' tidak dikenal. Tidak ada data spesifik yang dimuat.`);
                }
            }

            _applyLastSearchCriteria() {
                const criteria = this.state.lastSearchCriteria;
                if (!criteria) return;

                this.uiElements.searchInputLokasi.value = criteria.lokasi || '';
                this.uiElements.searchInputHarga.value = criteria.hargaMaks || '';
                this.uiElements.searchInputRadius.value = criteria.radius || 10;
                this.uiElements.searchRadiusValue.textContent = `${criteria.radius || 10} km`;
                this.uiElements.searchSelectTipe.value = criteria.tipe || '';
                this.uiElements.searchAmenitiesCheckboxes.forEach(cb => {
                    cb.checked = criteria.amenities?.includes(cb.value) || false;
                });
            }

            /**
             * Mengumumkan navigasi ke screen reader.
             * @param {string} viewId - ID halaman yang baru dinavigasi.
             * @private
             */
            _announceNavigation(viewId) {
                const pageTitleElement = document.getElementById(`${viewId}-heading`) || document.querySelector(`#${viewId} h1`);
                let announcement = `Anda sekarang berada di halaman ${pageTitleElement ? pageTitleElement.textContent : viewId}.`;

                // Buat elemen live region jika belum ada
                let liveRegion = document.getElementById('app-live-region');
                if (!liveRegion) {
                    liveRegion = document.createElement('div');
                    liveRegion.id = 'app-live-region';
                    liveRegion.className = 'visually-hidden';
                    liveRegion.setAttribute('aria-live', 'assertive');
                    liveRegion.setAttribute('aria-atomic', 'true');
                    document.body.appendChild(liveRegion);
                }
                liveRegion.textContent = announcement;
            }

            // ======================================================================================
            // MANAJEMEN DATA PROPERTI (CRUD SIMULASI)
            // ======================================================================================

            /**
             * Mendapatkan data properti awal (simulasi).
             * @returns {Array<Object>} Daftar properti.
             */
            getInitialProperties() {
                // Data ini bisa diperluas atau diambil dari file JSON/API nantinya
                return [
                    {
                        id: "apt-001",
                        name: "Apartemen Sudirman Park Residence",
                        location: "Jakarta Pusat, DKI Jakarta",
                        type: "2BR", // 2 Kamar Tidur
                        pricePerMonth: 8500000,
                        size: 75, // m2
                        amenities: ["WiFi", "AC", "Pool", "Gym", "Parking"],
                        images: [
                            "https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8YXBhcnRtZW50fGVufDB8fDB8fHww&auto=format&fit=crop&w=500&q=60",
                            "https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8YXBhcnRtZW50fGVufDB8fDB8fHww&auto=format&fit=crop&w=500&q=60",
                            "https://images.unsplash.com/photo-1493809842364-78817add7ffb?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Nnx8YXBhcnRtZW50fGVufDB8fDB8fHww&auto=format&fit=crop&w=500&q=60"
                        ],
                        description: "Apartemen 2 kamar tidur yang luas dan modern di jantung kota Jakarta. Akses mudah ke pusat bisnis, perbelanjaan, dan hiburan. Fasilitas lengkap termasuk kolam renang infinity, gym, dan area parkir pribadi.",
                        bookedDates: ["2025-08-10", "2025-08-11", "2025-08-15"], // Contoh tanggal terpesan
                        owner: { name: "Budi Santoso Property", verified: true, joinedDate: "2023-05-01T00:00:00Z" },
                        reviews: [
                            { id: "rev-001", userId: "user-rina-002", userName: "Rina Amelia", rating: 5, comment: "Sangat nyaman dan lokasinya strategis! Fasilitasnya juga lengkap.", date: "2025-06-10T14:30:00Z" },
                            { id: "rev-002", userId: "user-agus-003", userName: "Agus Wijaya", rating: 4, comment: "Apartemen bagus, bersih. Hanya saja proses check-in agak lama.", date: "2025-07-02T10:00:00Z" }
                        ],
                        rating: 4.5, // Rata-rata rating
                        isFeatured: true,
                    },
                    {
                        id: "apt-002",
                        name: "Green Pramuka City Apartment",
                        location: "Jakarta Timur, DKI Jakarta",
                        type: "Studio",
                        pricePerMonth: 3200000,
                        size: 30, // m2
                        amenities: ["WiFi", "AC", "Pool"],
                        images: [
                            "https://images.unsplash.com/photo-1604061982446-c76110514354?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTJ8fGFwYXJ0bWVudCUyMGphbnNlbnxlbnwwfHwwfHx8MA&auto=format&fit=crop&w=500&q=60",
                            "https://images.unsplash.com/photo-1580041068208-cad9cb7705e4?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTB8fGFwYXJ0bWVudCUyMGphbnNlbnxlbnwwfHwwfHx8MA&auto=format&fit=crop&w=500&q=60"
                        ],
                        description: "Studio apartemen yang nyaman dan terjangkau di Green Pramuka City. Cocok untuk mahasiswa atau profesional muda. Terintegrasi dengan mall dan fasilitas umum.",
                        bookedDates: [],
                        owner: { name: "Siti Property Management", verified: true, joinedDate: "2023-10-12T00:00:00Z" },
                        reviews: [
                            { id: "rev-003", userId: "user-dinda-001", userName: "Dinda Ayu", rating: 4, comment: "Tempatnya cukup nyaman untuk sendiri, akses ke mall mudah.", date: "2025-05-20T09:15:00Z" }
                        ],
                        rating: 4.0,
                        isFeatured: false,
                    },
                    {
                        id: "apt-003",
                        name: "The Peak Apartment Sudirman",
                        location: "Bandung, Jawa Barat", // Contoh lokasi berbeda
                        type: "3BR+", // 3+ Kamar Tidur
                        pricePerMonth: 15000000,
                        size: 120, // m2
                        amenities: ["WiFi", "AC", "Pool", "Gym", "Parking", "Private Lift"],
                        images: [
                            "https://images.unsplash.com/photo-1512917774080-9991f1c4c750?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTF8fGx1eHVyeSUyMGFwYXJ0bWVudHxlbnwwfHwwfHx8MA&auto=format&fit=crop&w=500&q=60",
                            "https://images.unsplash.com/photo-1616047006789-b7af5afb8c20?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fGx1eHVyeSUyMGFwYXJ0bWVudHxlbnwwfHwwfHx8MA&auto=format&fit=crop&w=500&q=60",
                            "https://images.unsplash.com/photo-1613553507753-696e297369yg?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTd8fGx1eHVyeSUyMGFwYXJ0bWVudCUyMGJhbGNvbnl8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=500&q=60"
                        ],
                        description: "Apartemen penthouse mewah dengan 3 kamar tidur plus ruang kerja, menawarkan pemandangan kota Bandung yang spektakuler. Dilengkapi lift pribadi dan fasilitas bintang lima.",
                        bookedDates: ["2025-09-01", "2025-09-02", "2025-09-03"],
                        owner: { name: "Luxury Living Bandung", verified: true, joinedDate: "2022-11-20T00:00:00Z" },
                        reviews: [],
                        rating: null, // Belum ada review
                        isFeatured: true,
                    },
                    {
                        id: "apt-004",
                        name: "Apartemen Taman Anggrek Residence",
                        location: "Jakarta Barat, DKI Jakarta",
                        type: "1BR",
                        pricePerMonth: 5500000,
                        size: 50,
                        amenities: ["WiFi", "AC", "Pool", "Gym", "Parking", "Mall Access"],
                        images: [
                            "https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTZ8fGFwYXJ0bWVudHxlbnwwfHwwfHx8MA&auto=format&fit=crop&w=500&q=60",
                            "https://images.unsplash.com/photo-1631684454647-98d1b5976087?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8N3x8YXBhcnRtZW50JTIwaW50ZXJpb3J8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=500&q=60"
                        ],
                        description: "Apartemen 1 kamar tidur yang nyaman dengan akses langsung ke Mall Taman Anggrek. Ideal untuk Anda yang menginginkan kemudahan dan gaya hidup modern.",
                        bookedDates: [],
                        owner: { name: "Anggrek Propertindo", verified: false, joinedDate: "2024-02-10T00:00:00Z" },
                        reviews: [
                            { id: "rev-004", userId: "user-susan-004", userName: "Susan Wijaya", rating: 5, comment: "Lokasi super strategis, unit bersih dan terawat.", date: "2025-07-15T11:00:00Z" }
                        ],
                        rating: 5.0,
                        isFeatured: false,
                    }
                ];
            }

            /**
             * Render daftar properti ke DOM.
             * @param {Array<Object>} propertiesToRender - Daftar properti yang akan dirender.
             * @private
             */
            _renderProperties(propertiesToRender) {
                if (!this.uiElements.apartemenListContainer) return;

                this.uiElements.apartemenListContainer.innerHTML = ''; // Kosongkan kontainer
                if (propertiesToRender.length === 0) {
                    this.uiElements.noResultsMessage.classList.remove('hidden');
                    return;
                }
                this.uiElements.noResultsMessage.classList.add('hidden');

                const fragment = document.createDocumentFragment();
                propertiesToRender.forEach(apt => {
                    const card = this._createPropertyCard(apt);
                    fragment.appendChild(card);
                });
                this.uiElements.apartemenListContainer.appendChild(fragment);
            }

            /**
             * Membuat elemen kartu properti.
             * @param {Object} apt - Objek data apartemen.
             * @returns {HTMLElement} Elemen artikel kartu.
             * @private
             */
            _createPropertyCard(apt) {
                const card = document.createElement('article');
                card.className = 'card property-card flex flex-col'; // Tambah property-card
                card.setAttribute('aria-labelledby', `apt-title-${apt.id}`);
                card.dataset.propertyId = apt.id;

                const isFavorited = this.state.favorites.includes(apt.id);
                const favoriteIconClass = isFavorited ? 'fas fa-heart text-accent-color' : 'far fa-heart'; // text-accent-color dari CSS

                // Menambahkan badge "Unggulan" jika properti isFeatured
                const featuredBadge = apt.isFeatured ? `<span class="absolute top-md right-md bg-accent-color text-on-primary-color text-xs font-semibold px-sm py-xs rounded-md shadow-sm">Unggulan</span>` : '';

                card.innerHTML = `
                <figure class="relative"> ${featuredBadge}
                    <img src="${AppUtils.sanitizeHTML(apt.images[0])}" alt="Tampilan depan ${AppUtils.sanitizeHTML(apt.name)}" class="card-img" loading="lazy">
                </figure>
                <div class="card-content p-md flex flex-col flex-grow">
                    <h3 id="apt-title-${apt.id}" class="card-title text-lg font-semibold mb-xs">${AppUtils.sanitizeHTML(apt.name)}</h3>
                    <p class="card-subtitle text-sm text-muted mb-sm">
                        <i class="fas fa-map-marker-alt text-xs"></i> ${AppUtils.sanitizeHTML(apt.location)} &bull; ${AppUtils.sanitizeHTML(apt.type)}
                    </p>
                    <div class="flex items-center gap-xs text-sm text-muted mb-md">
                        ${apt.rating ? `<i class="fas fa-star text-warning-color"></i> ${apt.rating.toFixed(1)} (${apt.reviews.length} ulasan)` : 'Belum ada ulasan'}
                    </div>
                    <p class="price-tag text-lg font-bold text-primary-color mb-md">${AppUtils.formatCurrency(apt.pricePerMonth)}<span class="text-sm font-normal text-muted">/bulan</span></p>
                    <div class="mt-auto flex gap-sm">
                        <button class="btn btn-primary flex-grow view-detail-btn" data-id="${apt.id}" aria-label="Lihat Detail ${AppUtils.sanitizeHTML(apt.name)}">
                            <i class="fas fa-eye"></i> Lihat Detail
                        </button>
                        <button class="btn btn-outline-primary btn-icon favorite-btn" data-id="${apt.id}" aria-pressed="${isFavorited}" aria-label="${isFavorited ? 'Hapus dari Favorit' : 'Tambah ke Favorit'}">
                            <i class="${favoriteIconClass}"></i>
                        </button>
                    </div>
                </div>
            `;

                // Tambahkan event listener untuk tombol di kartu
                card.querySelector('.view-detail-btn').addEventListener('click', () => this.handleViewApartmentDetail(apt.id));
                card.querySelector('.favorite-btn').addEventListener('click', () => this.handleToggleFavorite(apt.id));

                return card;
            }

            /**
             * Handler untuk melihat detail apartemen.
             * @param {string} apartmentId - ID apartemen yang akan dilihat.
             */
            handleViewApartmentDetail(apartmentId) {
                this.state.selectedApartmentId = apartmentId;
                this.navigateTo('apartment-detail');
            }

            /**
             * Render detail apartemen ke DOM.
             * @param {string} apartmentId - ID apartemen.
             * @private
             */
            _renderApartmentDetail(apartmentId) {
                const apt = this.state.properties.find(p => p.id === apartmentId);
                if (!apt) {
                    this.showNotification("Detail apartemen tidak ditemukan.", "error");
                    this.navigateTo('home'); // Kembali ke home jika apartemen tidak ditemukan
                    return;
                }

                // Update judul halaman
                this.uiElements.apartmentDetailTitle.textContent = AppUtils.sanitizeHTML(apt.name);

                // Render galeri gambar
                this._renderGallery(apt.images, apt.name);

                // Isi informasi dasar
                this.uiElements.detailDescription.textContent = AppUtils.sanitizeHTML(apt.description) || "Deskripsi tidak tersedia.";
                this.uiElements.detailPrice.textContent = AppUtils.formatCurrency(apt.pricePerMonth) + "/bulan";
                this.uiElements.detailLocation.innerHTML = `<i class="fas fa-map-marker-alt text-primary-color"></i> ${AppUtils.sanitizeHTML(apt.location)}`;
                this.uiElements.detailType.textContent = AppUtils.sanitizeHTML(apt.type);
                this.uiElements.detailAmenities.textContent = apt.amenities.join(', ') || 'Tidak ada fasilitas tercantum.';

                // Informasi pemilik
                this.uiElements.ownerName.textContent = AppUtils.sanitizeHTML(apt.owner.name);
                this.uiElements.ownerStatus.innerHTML = apt.owner.verified
                    ? `<span class="text-sm text-success-color font-semibold"><i class="fas fa-check-circle"></i> Terverifikasi</span>`
                    : `<span class="text-sm text-warning-color font-semibold"><i class="fas fa-exclamation-triangle"></i> Belum Terverifikasi</span>`;
                this.uiElements.ownerJoinedDate.textContent = AppUtils.formatDate(apt.owner.joinedDate);

                // Render ulasan
                this._renderReviews(apt.reviews);

                // Render peta (simulasi)
                this.backendService.renderMap(this.uiElements.detailMapPlaceholder.id, apt.location, 2); // Radius kecil untuk detail

                // Render kalender booking
                this._renderBookingCalendar(apt.bookedDates);

                // Reset form booking & rincian biaya
                this.uiElements.bookingForm.reset();
                this._updateBookingCostBreakdown(); // Update dengan nilai default setelah reset

                // Pastikan semua elemen detail terlihat
                this.uiElements.apartmentDetailContent.classList.remove('hidden');
            }

            /**
             * Render galeri gambar untuk detail apartemen.
             * @param {Array<string>} images - Array URL gambar.
             * @param {string} apartmentName - Nama apartemen untuk alt text.
             * @private
             */
            _renderGallery(images, apartmentName) {
                this.state.galleryState.images = images;
                this.state.galleryState.currentIndex = 0;

                this.uiElements.galleryImagesContainer.innerHTML = images.map((imgSrc, index) => `
                <img src="${AppUtils.sanitizeHTML(imgSrc)}" 
                     alt="${AppUtils.sanitizeHTML(apartmentName)} - Gambar ${index + 1}" 
                     class="gallery-image" 
                     loading="${index === 0 ? 'eager' : 'lazy'}"> 
            `).join('');

                this.uiElements.galleryDotsContainer.innerHTML = images.map((_, index) => `
                <button class="gallery-dot ${index === 0 ? 'active' : ''}" 
                        data-index="${index}" 
                        aria-label="Pindah ke gambar ${index + 1}"></button>
            `).join('');

                this._updateGalleryView();

                // Hapus event listener lama jika ada, lalu tambahkan yang baru
                // Ini penting jika _renderGallery dipanggil beberapa kali untuk properti berbeda
                const newPrevBtn = this.uiElements.galleryPrevBtn.cloneNode(true);
                this.uiElements.galleryPrevBtn.parentNode.replaceChild(newPrevBtn, this.uiElements.galleryPrevBtn);
                this.uiElements.galleryPrevBtn = newPrevBtn;
                this.uiElements.galleryPrevBtn.addEventListener('click', () => this._navigateGallery(-1));

                const newNextBtn = this.uiElements.galleryNextBtn.cloneNode(true);
                this.uiElements.galleryNextBtn.parentNode.replaceChild(newNextBtn, this.uiElements.galleryNextBtn);
                this.uiElements.galleryNextBtn = newNextBtn;
                this.uiElements.galleryNextBtn.addEventListener('click', () => this._navigateGallery(1));

                this.uiElements.galleryDotsContainer.querySelectorAll('.gallery-dot').forEach(dot => {
                    // Hapus listener lama sebelum menambahkan yang baru untuk dot
                    const newDot = dot.cloneNode(true);
                    dot.parentNode.replaceChild(newDot, dot);
                    newDot.addEventListener('click', (e) => this._jumpToGalleryImage(parseInt(e.target.dataset.index)));
                });
            }

            _navigateGallery(direction) {
                const numImages = this.state.galleryState.images.length;
                if (numImages === 0) return;

                let newIndex = this.state.galleryState.currentIndex + direction;
                if (newIndex < 0) newIndex = numImages - 1;
                if (newIndex >= numImages) newIndex = 0;

                this.state.galleryState.currentIndex = newIndex;
                this._updateGalleryView();
            }

            _jumpToGalleryImage(index) {
                if (index >= 0 && index < this.state.galleryState.images.length) {
                    this.state.galleryState.currentIndex = index;
                    this._updateGalleryView();
                }
            }

            _updateGalleryView() {
                const currentIndex = this.state.galleryState.currentIndex;
                this.uiElements.galleryImagesContainer.style.transform = `translateX(-${currentIndex * 100}%)`;

                this.uiElements.galleryDotsContainer.querySelectorAll('.gallery-dot').forEach((dot, index) => {
                    dot.classList.toggle('active', index === currentIndex);
                });
                // Bisa tambahkan caption jika diperlukan: 
                // document.getElementById('gallery-caption').textContent = `Gambar ${currentIndex + 1} dari ${this.state.galleryState.images.length}`;
            }

            /**
             * Render ulasan untuk detail apartemen.
             * @param {Array<Object>} reviews - Array objek ulasan.
             * @private
             */
            _renderReviews(reviews) {
                if (!reviews || reviews.length === 0) {
                    this.uiElements.reviewsContainer.innerHTML = '';
                    this.uiElements.noReviewsMessage.classList.remove('hidden');
                    return;
                }

                this.uiElements.noReviewsMessage.classList.add('hidden');
                this.uiElements.reviewsContainer.innerHTML = reviews.map(review => `
                <article class="review-item border-b border-border-color py-md mb-md">
                    <div class="flex justify-between items-center mb-xs">
                        <h4 class="font-semibold">${AppUtils.sanitizeHTML(review.userName)}</h4>
                        <div class="review-stars text-warning-color text-sm">
                            ${Array(5).fill(0).map((_, i) => `<i class="${i < review.rating ? 'fas' : 'far'} fa-star"></i>`).join('')}
                        </div>
                    </div>
                    <p class="text-muted text-sm mb-sm">Diulas pada: ${AppUtils.formatDate(review.date)}</p>
                    <p class="text-on-surface-color">${AppUtils.sanitizeHTML(review.comment)}</p>
                </article>
            `).join('');
            }

            // ======================================================================================
            // FITUR PENCARIAN
            // ======================================================================================

            /**
             * Handler untuk melakukan pencarian properti.
             */
            handleSearchProperties() {
                const searchCriteria = {
                    lokasi: this.uiElements.searchInputLokasi.value.trim().toLowerCase(),
                    hargaMaks: parseInt(this.uiElements.searchInputHarga.value) || null,
                    radius: parseInt(this.uiElements.searchInputRadius.value),
                    tipe: this.uiElements.searchSelectTipe.value,
                    amenities: Array.from(this.uiElements.searchAmenitiesCheckboxes)
                        .filter(cb => cb.checked)
                        .map(cb => cb.value)
                };

                this.state.lastSearchCriteria = searchCriteria; // Simpan kriteria pencarian
                const filteredProperties = this.filterProperties(searchCriteria);
                this._renderProperties(filteredProperties);

                // Update peta (simulasi)
                this.backendService.renderMap('detail-map-placeholder', searchCriteria.lokasi || 'Area Pencarian Umum', searchCriteria.radius);

                this.showNotification(`Menampilkan ${filteredProperties.length} apartemen sesuai kriteria Anda.`, "info");
            }

            /**
             * Memfilter properti berdasarkan kriteria.
             * @param {Object} criteria - Objek kriteria pencarian.
             * @returns {Array<Object>} Array properti yang terfilter.
             */
            filterProperties(criteria) {
                return this.state.properties.filter(apt => {
                    let matches = true;

                    if (criteria.lokasi && !apt.location.toLowerCase().includes(criteria.lokasi)) {
                        matches = false;
                    }
                    if (criteria.hargaMaks && apt.pricePerMonth > criteria.hargaMaks) {
                        matches = false;
                    }
                    if (criteria.tipe && apt.type !== criteria.tipe) {
                        matches = false;
                    }
                    if (criteria.amenities && criteria.amenities.length > 0) {
                        if (!criteria.amenities.every(amenity => apt.amenities.includes(amenity))) {
                            matches = false;
                        }
                    }
                    // Logika radius akan lebih kompleks dan memerlukan data geolokasi. Untuk simulasi, kita abaikan dulu.
                    return matches;
                });
            }


            // ======================================================================================
            // FITUR FAVORIT
            // ======================================================================================

            /**
             * Handler untuk menambah/menghapus properti dari favorit.
             * @param {string} apartmentId - ID apartemen.
             */
            handleToggleFavorite(apartmentId) {
                const index = this.state.favorites.indexOf(apartmentId);
                let message = '';
                if (index === -1) {
                    this.state.favorites.push(apartmentId);
                    message = 'Ditambahkan ke favorit!';
                } else {
                    this.state.favorites.splice(index, 1);
                    message = 'Dihapus dari favorit.';
                }
                AppUtils.saveToLocalStorage('Green Valley_favorites', this.state.favorites);
                this.showNotification(message, "success");

                // Update UI (tombol favorit di kartu & daftar favorit jika di halaman favorit)
                this._updateFavoriteButtonState(apartmentId);
                if (this.state.currentView === 'favorites') {
                    this._renderFavorites();
                }
            }

            /**
             * Memperbarui tampilan tombol favorit pada kartu properti.
             * @param {string} apartmentId - ID apartemen.
             * @private
             */
            _updateFavoriteButtonState(apartmentId) {
                const favButton = document.querySelector(`.favorite-btn[data-id="${apartmentId}"]`);
                if (favButton) {
                    const isFavorited = this.state.favorites.includes(apartmentId);
                    favButton.setAttribute('aria-pressed', isFavorited.toString());
                    favButton.innerHTML = `<i class="${isFavorited ? 'fas fa-heart text-accent-color' : 'far fa-heart'}"></i>`;
                    favButton.setAttribute('aria-label', isFavorited ? 'Hapus dari Favorit' : 'Tambah ke Favorit');
                }
            }

            /**
             * Render daftar properti favorit ke DOM.
             * @private
             */
            _renderFavorites() {
                const favoriteProperties = this.state.properties.filter(apt => this.state.favorites.includes(apt.id));
                this.uiElements.favoritesListContainer.innerHTML = ''; // Kosongkan kontainer

                if (favoriteProperties.length === 0) {
                    this.uiElements.noFavoritesMessage.classList.remove('hidden');
                    return;
                }
                this.uiElements.noFavoritesMessage.classList.add('hidden');

                const fragment = document.createDocumentFragment();
                favoriteProperties.forEach(apt => {
                    const card = this._createPropertyCard(apt); // Gunakan fungsi yang sama untuk konsistensi
                    fragment.appendChild(card);
                });
                this.uiElements.favoritesListContainer.appendChild(fragment);
            }


            // ======================================================================================
            // FITUR BOOKING & KALENDER
            // ======================================================================================

            /**
             * Render kalender booking untuk detail apartemen.
             * @param {Array<string>} bookedDates - Array tanggal yang sudah dipesan (format YYYY-MM-DD).
             * @private
             */
            _renderBookingCalendar(bookedDates = []) {
                const calendarContainer = this.uiElements.bookingCalendarContainer;
                calendarContainer.innerHTML = ''; // Kosongkan

                const today = new Date();
                today.setHours(0, 0, 0, 0); // Normalisasi ke awal hari
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();

                // Header kalender (Nama hari)
                const daysOfWeek = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
                daysOfWeek.forEach(day => {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'calendar-header text-sm';
                    dayHeader.textContent = day;
                    calendarContainer.appendChild(dayHeader);
                });

                // Dapatkan hari pertama bulan ini dan jumlah hari dalam bulan ini
                const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

                // Tambahkan sel kosong untuk hari sebelum tanggal 1
                for (let i = 0; i < firstDayOfMonth.getDay(); i++) {
                    const emptyCell = document.createElement('div');
                    calendarContainer.appendChild(emptyCell);
                }

                // Tambahkan sel untuk setiap hari dalam bulan
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateCell = document.createElement('div');
                    dateCell.className = 'calendar-day text-sm';
                    dateCell.textContent = day;

                    const currentDate = new Date(currentYear, currentMonth, day);
                    const dateString = currentDate.toISOString().split('T')[0]; // Format YYYY-MM-DD
                    dateCell.dataset.date = dateString;

                    if (currentDate < today) {
                        dateCell.classList.add('disabled'); // Tanggal lampau
                    } else if (bookedDates.includes(dateString)) {
                        dateCell.classList.add('booked'); // Tanggal sudah dipesan
                    } else {
                        // Tambahkan event listener untuk tanggal yang bisa dipilih
                        dateCell.addEventListener('click', () => this._handleCalendarDateSelect(dateCell, dateString));
                    }

                    if (dateString === today.toISOString().split('T')[0]) {
                        dateCell.classList.add('today');
                    }

                    calendarContainer.appendChild(dateCell);
                }
            }

            _handleCalendarDateSelect(dateCellElement, dateString) {
                const checkinInput = this.uiElements.checkinDateInput;
                const checkoutInput = this.uiElements.checkoutDateInput;

                // Hapus kelas 'selected' dari semua tanggal dulu
                this.uiElements.bookingCalendarContainer.querySelectorAll('.calendar-day.selected').forEach(d => d.classList.remove('selected'));

                if (!checkinInput.value || (checkinInput.value && checkoutInput.value)) {
                    // Kasus 1: Belum ada check-in ATAU keduanya sudah terisi (mulai dari awal)
                    checkinInput.value = dateString;
                    checkoutInput.value = '';
                    dateCellElement.classList.add('selected');
                } else if (checkinInput.value && !checkoutInput.value) {
                    // Kasus 2: Check-in sudah terisi, mengisi check-out
                    if (new Date(dateString) > new Date(checkinInput.value)) {
                        checkoutInput.value = dateString;
                        // Tandai tanggal check-in dan check-out yang dipilih
                        const selectedCheckinCell = this.uiElements.bookingCalendarContainer.querySelector(`.calendar-day[data-date="${checkinInput.value}"]`);
                        if (selectedCheckinCell) selectedCheckinCell.classList.add('selected');
                        dateCellElement.classList.add('selected');
                    } else {
                        // Jika tanggal check-out sebelum check-in, reset ke tanggal ini sebagai check-in baru
                        checkinInput.value = dateString;
                        checkoutInput.value = '';
                        dateCellElement.classList.add('selected');
                        this.showNotification("Tanggal check-out harus setelah tanggal check-in. Tanggal check-in diatur ulang.", "warning");
                    }
                }
                this._updateBookingCostBreakdown();
            }

            /**
             * Memperbarui tampilan rincian biaya booking.
             * @private
             */
            _updateBookingCostBreakdown() {
                const apt = this.state.properties.find(p => p.id === this.state.selectedApartmentId);
                if (!apt) return;

                const checkinDate = this.uiElements.checkinDateInput.value;
                const checkoutDate = this.uiElements.checkoutDateInput.value;
                const insurance = this.uiElements.bookingInsuranceCheckbox.checked;

                let totalCost = 0;
                let breakdownHTML = `<p class="font-semibold mb-sm">Rincian Biaya:</p>`;

                if (checkinDate && checkoutDate && new Date(checkoutDate) > new Date(checkinDate)) {
                    const oneDay = 24 * 60 * 60 * 1000; // milidetik dalam sehari
                    const startDate = new Date(checkinDate);
                    const endDate = new Date(checkoutDate);
                    const numberOfNights = Math.round(Math.abs((endDate - startDate) / oneDay));

                    if (numberOfNights > 0) {
                        // Biaya sewa dihitung per malam, misal harga per bulan dibagi 30
                        // Atau bisa juga properti punya harga harian/mingguan
                        const pricePerNight = apt.pricePerMonth / 30; // Asumsi sederhana
                        const baseCost = pricePerNight * numberOfNights;
                        const insuranceCost = insurance ? baseCost * 0.10 : 0;
                        totalCost = baseCost + insuranceCost;

                        breakdownHTML += `
                        <p>Biaya Sewa (${numberOfNights} malam): ${AppUtils.formatCurrency(baseCost)}</p>
                        ${insurance ? `<p>Asuransi Perjalanan: ${AppUtils.formatCurrency(insuranceCost)}</p>` : ''}
                    `;
                    } else {
                        breakdownHTML += `<p class="text-muted">Pilih tanggal check-in dan check-out yang valid.</p>`;
                    }
                } else {
                    breakdownHTML += `<p class="text-muted">Pilih tanggal check-in dan check-out.</p>`;
                }

                breakdownHTML += `<hr class="my-sm border-border-color">
                              <p>Total Biaya: <strong id="total-booking-cost" class="text-primary-color">${AppUtils.formatCurrency(totalCost)}</strong></p>`;
                this.uiElements.costBreakdownContainer.innerHTML = breakdownHTML;
            }


            /**
             * Handler untuk memproses booking.
             */
            async handleProcessBooking() {
                const apt = this.state.properties.find(p => p.id === this.state.selectedApartmentId);
                if (!apt) {
                    this.showNotification("Apartemen tidak valid untuk dibooking.", "error");
                    return;
                }

                const checkin = this.uiElements.checkinDateInput.value;
                const checkout = this.uiElements.checkoutDateInput.value;
                const insurance = this.uiElements.bookingInsuranceCheckbox.checked;
                const paymentMethod = this.uiElements.paymentMethodSelect.value;

                if (!checkin || !checkout) {
                    this.showNotification("Harap pilih tanggal check-in dan check-out.", "warning");
                    return;
                }
                if (new Date(checkout) <= new Date(checkin)) {
                    this.showNotification("Tanggal check-out harus setelah tanggal check-in.", "warning");
                    return;
                }

                const oneDay = 24 * 60 * 60 * 1000;
                const numberOfNights = Math.round(Math.abs((new Date(checkout) - new Date(checkin)) / oneDay));
                const pricePerNight = apt.pricePerMonth / 30; // Asumsi
                const baseCost = pricePerNight * numberOfNights;
                const insuranceCost = insurance ? baseCost * 0.10 : 0;
                const totalCost = baseCost + insuranceCost;

                this.showNotification("Memproses pemesanan Anda...", "info", true); // true for persistent

                try {
                    const paymentDetails = {
                        apartmentId: apt.id,
                        apartmentName: apt.name,
                        checkin, checkout, numberOfNights,
                        totalAmount: totalCost,
                        paymentMethod,
                        userId: this.state.currentUser.id
                    };
                    const paymentResult = await this.backendService.processPayment(paymentDetails);

                    if (paymentResult.success) {
                        const newBooking = {
                            id: paymentResult.data.transactionId,
                            apartmentId: apt.id,
                            apartmentName: apt.name,
                            apartmentImage: apt.images[0], // Simpan gambar utama untuk tampilan list booking
                            checkinDate: checkin,
                            checkoutDate: checkout,
                            totalCost: totalCost,
                            paymentMethod: paymentMethod,
                            bookingDate: new Date().toISOString(),
                            status: "Confirmed" // atau "Pending Payment" jika ada langkah konfirmasi
                        };
                        this.state.bookings.unshift(newBooking); // Tambah ke awal array
                        AppUtils.saveToLocalStorage('Green Valley_bookings', this.state.bookings);

                        // Update tanggal yang dipesan untuk apartemen ini
                        const bookedDatesToAdd = [];
                        let currentDate = new Date(checkin);
                        while (currentDate < new Date(checkout)) {
                            bookedDatesToAdd.push(currentDate.toISOString().split('T')[0]);
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                        apt.bookedDates = [...new Set([...(apt.bookedDates || []), ...bookedDatesToAdd])]; // Gabung & unik

                        // Update poin loyalitas (misal 1 poin per Rp10.000)
                        this.state.currentUser.loyaltyPoints += Math.floor(totalCost / 10000);
                        this._updateAccountData(); // Untuk simpan user state jika perlu

                        this.showNotification(`Pemesanan berhasil! ID Transaksi: ${newBooking.id}. Terima kasih!`, "success");
                        this.uiElements.bookingForm.reset();
                        this._renderBookingCalendar(apt.bookedDates); // Re-render kalender
                        this._updateBookingCostBreakdown(); // Re-render rincian biaya
                        this.navigateTo('bookings'); // Pindah ke halaman pesanan
                    } else {
                        this.showNotification(`Pemesanan gagal: ${paymentResult.message || 'Silakan coba lagi.'}`, "error");
                    }
                } catch (error) {
                    console.error("Error saat booking:", error);
                    this.showNotification("Terjadi kesalahan server saat memproses pesanan. Mohon coba beberapa saat lagi.", "error");
                }
            }

            /**
             * Render daftar pesanan ke DOM.
             * @private
             */
            _renderBookings() {
                this.uiElements.bookingListContainer.innerHTML = ''; // Kosongkan

                if (this.state.bookings.length === 0) {
                    this.uiElements.noBookingsMessage.classList.remove('hidden');
                    return;
                }
                this.uiElements.noBookingsMessage.classList.add('hidden');

                const fragment = document.createDocumentFragment();
                this.state.bookings.forEach(booking => {
                    const card = document.createElement('article');
                    card.className = 'card booking-card flex gap-md items-start'; // Layout kartu booking
                    card.innerHTML = `
                    <img src="${AppUtils.sanitizeHTML(booking.apartmentImage)}" alt="Apartemen ${AppUtils.sanitizeHTML(booking.apartmentName)}" class="w-1/3 h-auto object-cover rounded-md" style="max-width: 150px;" loading="lazy">
                    <div class="booking-details flex-grow">
                        <h3 class="font-semibold text-lg">${AppUtils.sanitizeHTML(booking.apartmentName)}</h3>
                        <p class="text-sm text-muted">ID Pesanan: ${AppUtils.sanitizeHTML(booking.id)}</p>
                        <p class="text-sm">Check-in: ${AppUtils.formatDate(booking.checkinDate)}</p>
                        <p class="text-sm">Check-out: ${AppUtils.formatDate(booking.checkoutDate)}</p>
                        <p class="font-semibold mt-xs">Total: ${AppUtils.formatCurrency(booking.totalCost)}</p>
                        <p class="text-xs text-muted mt-xs">Dipesan pada: ${AppUtils.formatDate(booking.bookingDate, { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                        <span class="inline-block mt-sm px-sm py-xs rounded-full text-xs font-semibold 
                            ${booking.status === 'Confirmed' ? 'bg-success-color text-on-primary-color' : 'bg-warning-color text-on-surface-color'}">
                            ${booking.status === 'Confirmed' ? '<i class="fas fa-check-circle"></i> Terkonfirmasi' : '<i class="fas fa-clock"></i> Menunggu'}
                        </span>
                        ${booking.status === 'Confirmed' ? `<button class="btn btn-outline-primary btn-sm mt-sm cancel-booking-btn" data-booking-id="${booking.id}" aria-label="Batalkan Pesanan ${booking.id}">Batalkan</button>` : ''}
                    </div>
                `;
                    // Tambah event listener untuk tombol batalkan jika ada
                    const cancelButton = card.querySelector('.cancel-booking-btn');
                    if (cancelButton) {
                        cancelButton.addEventListener('click', () => this.handleCancelBooking(booking.id));
                    }
                    fragment.appendChild(card);
                });
                this.uiElements.bookingListContainer.appendChild(fragment);
            }

            /**
             * Handler untuk membatalkan pesanan (simulasi).
             * @param {string} bookingId - ID pesanan yang akan dibatalkan.
             */
            async handleCancelBooking(bookingId) {
                if (!confirm("Apakah Anda yakin ingin membatalkan pesanan ini? Biaya pembatalan mungkin berlaku.")) {
                    return;
                }

                // Simulasi proses pembatalan
                this.showNotification(`Memproses pembatalan untuk pesanan ${bookingId}...`, "info", true);
                await new Promise(resolve => setTimeout(resolve, 1000)); // Simulasi delay

                const bookingIndex = this.state.bookings.findIndex(b => b.id === bookingId);
                if (bookingIndex > -1) {
                    const cancelledBooking = this.state.bookings[bookingIndex];
                    // Hapus tanggal yang dibooking dari properti terkait
                    const property = this.state.properties.find(p => p.id === cancelledBooking.apartmentId);
                    if (property && property.bookedDates) {
                        const datesToUnbook = [];
                        let currentDate = new Date(cancelledBooking.checkinDate);
                        while (currentDate < new Date(cancelledBooking.checkoutDate)) {
                            datesToUnbook.push(currentDate.toISOString().split('T')[0]);
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                        property.bookedDates = property.bookedDates.filter(d => !datesToUnbook.includes(d));
                    }

                    // Hapus booking dari state
                    this.state.bookings.splice(bookingIndex, 1);
                    AppUtils.saveToLocalStorage('Green Valley_bookings', this.state.bookings);

                    this._renderBookings(); // Re-render daftar booking
                    if (this.state.currentView === 'apartment-detail' && this.state.selectedApartmentId === cancelledBooking.apartmentId) {
                        this._renderBookingCalendar(property.bookedDates); // Update kalender jika di halaman detail
                    }
                    this.showNotification(`Pesanan ${bookingId} telah berhasil dibatalkan.`, "success");
                } else {
                    this.showNotification(`Gagal membatalkan: Pesanan ${bookingId} tidak ditemukan.`, "error");
                }
            }


            // ======================================================================================
            // FITUR AKUN PENGGUNA
            // ======================================================================================

            /**
             * Render informasi halaman akun.
             * @private
             */
            _renderAccountPage() {
                const user = this.state.currentUser;
                this.uiElements.userProfileName.textContent = AppUtils.sanitizeHTML(user.name);
                this.uiElements.userProfileEmail.textContent = AppUtils.sanitizeHTML(user.email);
                this.uiElements.userProfilePhone.textContent = AppUtils.sanitizeHTML(user.phone) || '-';
                this.uiElements.userProfileJoined.textContent = AppUtils.formatDate(user.joinedDate);
                this.uiElements.userLoyaltyPoints.textContent = `${user.loyaltyPoints.toLocaleString('id-ID')} Poin`;
                this.uiElements.notificationPrefsCheckbox.checked = user.preferences.notificationsEnabled;

                // Isi form modal edit profil dengan data saat ini
                this.uiElements.editProfileNameInput.value = user.name;
                this.uiElements.editProfileEmailInput.value = user.email;
                this.uiElements.editProfilePhoneInput.value = user.phone || '';
            }

            /**
             * Handler untuk memperbarui profil pengguna.
             */
            async handleUpdateProfile() {
                const newName = this.uiElements.editProfileNameInput.value.trim();
                const newEmail = this.uiElements.editProfileEmailInput.value.trim();
                const newPhone = this.uiElements.editProfilePhoneInput.value.trim();

                if (!newName || !newEmail) {
                    this.showNotification("Nama dan Email tidak boleh kosong.", "warning");
                    return;
                }
                // Validasi email sederhana
                if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(newEmail)) {
                    this.showNotification("Format email tidak valid.", "warning");
                    return;
                }

                this.showNotification("Menyimpan perubahan profil...", "info", true);
                try {
                    const updatedProfileData = { name: newName, email: newEmail, phone: newPhone };
                    const result = await this.backendService.updateUserProfile(updatedProfileData);

                    if (result.success) {
                        this.state.currentUser.name = newName;
                        this.state.currentUser.email = newEmail;
                        this.state.currentUser.phone = newPhone;

                        this._updateAccountData(); // Menyimpan state pengguna jika diperlukan dan re-render
                        this.closeModal('edit-profile-modal');
                        this.showNotification("Profil berhasil diperbarui!", "success");
                    } else {
                        this.showNotification(`Gagal memperbarui profil: ${result.message || 'Silakan coba lagi.'}`, "error");
                    }
                } catch (error) {
                    console.error("Error update profil:", error);
                    this.showNotification("Terjadi kesalahan server saat memperbarui profil.", "error");
                }
            }

            /**
             * Memperbarui data akun dan UI terkait.
             * @private
             */
            _updateAccountData() {
                // Simpan state currentUser jika perlu (misal ke localStorage jika tidak ada backend nyata)
                // AppUtils.saveToLocalStorage('Green Valley_currentUser', this.state.currentUser);

                // Re-render bagian yang menampilkan info user
                this._renderAccountPage();
                this._updateSidebarUserInfo();
            }

            _updateSidebarUserInfo() {
                this.uiElements.sidebarUserName.textContent = `Halo, ${AppUtils.sanitizeHTML(this.state.currentUser.name.split(' ')[0])}`; // Hanya nama depan
            }

            // ======================================================================================
            // FITUR Ulasan
            // ======================================================================================

            /**
             * Handler untuk menambahkan ulasan baru.
             */
            async handleAddReview() {
                const apartmentId = this.state.selectedApartmentId;
                if (!apartmentId) {
                    this.showNotification("Tidak ada apartemen yang dipilih untuk diberi ulasan.", "error");
                    return;
                }

                const rating = parseInt(this.uiElements.reviewRatingValueInput.value);
                const comment = this.uiElements.reviewCommentTextarea.value.trim();
                const isAnonymous = document.getElementById('review-anonymous').checked;

                if (!rating || rating < 1 || rating > 5) {
                    this.showNotification("Harap berikan rating bintang (1-5).", "warning");
                    return;
                }
                if (!comment) {
                    this.showNotification("Ulasan tidak boleh kosong.", "warning");
                    return;
                }

                this.showNotification("Mengirim ulasan Anda...", "info", true);
                const reviewData = {
                    apartmentId,
                    userId: this.state.currentUser.id,
                    userName: isAnonymous ? "Pengguna Anonim" : this.state.currentUser.name,
                    rating,
                    comment,
                    date: new Date().toISOString()
                };

                try {
                    const result = await this.backendService.submitReview(reviewData);
                    if (result.success) {
                        const property = this.state.properties.find(p => p.id === apartmentId);
                        if (property) {
                            property.reviews.unshift(result.data); // Tambah ulasan baru ke awal
                            // Hitung ulang rating rata-rata properti
                            const totalRating = property.reviews.reduce((sum, rev) => sum + rev.rating, 0);
                            property.rating = property.reviews.length > 0 ? (totalRating / property.reviews.length) : null;
                        }

                        this.closeModal('add-review-modal');
                        this.uiElements.addReviewForm.reset(); // Reset form ulasan
                        this._updateStarRatingDisplay(0); // Reset bintang rating
                        this._renderReviews(property ? property.reviews : []); // Re-render bagian ulasan
                        this.showNotification("Ulasan Anda berhasil dikirim. Terima kasih!", "success");
                    } else {
                        this.showNotification(`Gagal mengirim ulasan: ${result.message || 'Silakan coba lagi.'}`, "error");
                    }
                } catch (error) {
                    console.error("Error saat mengirim ulasan:", error);
                    this.showNotification("Terjadi kesalahan server saat mengirim ulasan.", "error");
                }
            }


            // ======================================================================================
            // FITUR MODAL
            // ======================================================================================

            /**
             * Membuka modal berdasarkan ID.
             * @param {string} modalId - ID modal yang akan dibuka.
             */
            openModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    // Set aria-hidden false untuk elemen utama saat modal terbuka
                    // document.querySelector('.app-main').setAttribute('aria-hidden', 'true');
                    // document.querySelector('.app-sidebar').setAttribute('aria-hidden', 'true');

                    modal.classList.add('open');
                    modal.setAttribute('aria-hidden', 'false');

                    // Fokus pada elemen pertama yang bisa difokus di dalam modal
                    const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                    if (focusableElements.length > 0) {
                        focusableElements[0].focus();
                    }

                    // Reset form di dalam modal jika ada (misal untuk Report atau Review)
                    const form = modal.querySelector('form');
                    if (form) form.reset();
                    if (modalId === 'add-review-modal') this._updateStarRatingDisplay(0);


                    // Tambahkan event listener untuk focus trapping
                    this._currentModalFocusTrapListener = (e) => this._focusTrap(e, modal);
                    document.addEventListener('keydown', this._currentModalFocusTrapListener);

                } else {
                    console.warn(`Modal dengan ID '${modalId}' tidak ditemukan.`);
                }
            }

            /**
             * Menutup modal yang sedang aktif.
             * @param {string} modalId - ID modal yang akan ditutup.
             */
            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal && modal.classList.contains('open')) {
                    modal.classList.remove('open');
                    modal.setAttribute('aria-hidden', 'true');

                    // Hapus atribut aria-hidden dari elemen utama
                    // document.querySelector('.app-main').setAttribute('aria-hidden', 'false');
                    // document.querySelector('.app-sidebar').setAttribute('aria-hidden', 'false');

                    // Kembalikan fokus ke elemen yang membuka modal jika ada (opsional, bisa kompleks)
                    // Untuk saat ini, fokus akan kembali ke body secara default

                    // Hapus listener focus trap
                    if (this._currentModalFocusTrapListener) {
                        document.removeEventListener('keydown', this._currentModalFocusTrapListener);
                        this._currentModalFocusTrapListener = null;
                    }
                }
            }

            /**
             * Fungsi untuk menjaga fokus di dalam modal (focus trapping).
             * @param {Event} e - Event keydown.
             * @param {HTMLElement} modalElement - Elemen modal yang aktif.
             * @private
             */
            _focusTrap(e, modalElement) {
                if (e.key !== 'Tab') return;

                const focusableElements = Array.from(modalElement.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'))
                    .filter(el => el.offsetParent !== null); // Hanya elemen yang visible

                if (focusableElements.length === 0) return;

                const firstFocusableElement = focusableElements[0];
                const lastFocusableElement = focusableElements[focusableElements.length - 1];

                if (e.shiftKey) { // Shift + Tab
                    if (document.activeElement === firstFocusableElement) {
                        lastFocusableElement.focus();
                        e.preventDefault();
                    }
                } else { // Tab
                    if (document.activeElement === lastFocusableElement) {
                        firstFocusableElement.focus();
                        e.preventDefault();
                    }
                }
            }


            // ======================================================================================
            // FITUR CHATBOX
            // ======================================================================================

            /**
             * Membuka atau menutup jendela chatbox.
             * @param {boolean} [forceOpenState] - Opsional, paksa state buka/tutup.
             */
            toggleChatbox(forceOpenState) {
                const isOpen = typeof forceOpenState === 'boolean' ? forceOpenState : !this.state.chatState.isOpen;
                this.state.chatState.isOpen = isOpen;

                this.uiElements.chatboxWindow.classList.toggle('open', isOpen);
                this.uiElements.chatToggleBtn.setAttribute('aria-expanded', isOpen.toString());

                if (isOpen) {
                    this.uiElements.chatInputMessage.focus();
                    // Jika membuka chat 'owner', pastikan ada selectedApartment
                    if (this.state.chatState.type === 'owner' && !this.state.selectedApartmentId) {
                        this.showNotification("Pilih apartemen terlebih dahulu untuk chat dengan pemilik.", "warning");
                        this.toggleChatbox(false); // Tutup lagi
                        return;
                    }
                }
            }

            /**
             * Memulai sesi chat baru (support atau owner).
             * @param {string} type - Tipe chat ('support' atau 'owner').
             */
            openChat(type = 'support') {
                this.state.chatState.type = type;
                // Bersihkan pesan lama atau sesuaikan pesan sambutan
                this.state.chatState.messages = [];

                const apt = type === 'owner' ? this.state.properties.find(p => p.id === this.state.selectedApartmentId) : null;

                if (type === 'owner' && !apt) {
                    this.showNotification("Tidak dapat memulai chat: Properti tidak ditemukan.", "error");
                    return;
                }

                this.uiElements.chatboxTitle.textContent = type === 'support'
                    ? 'Dukungan Pelanggan 24/7'
                    : `Chat dengan ${AppUtils.sanitizeHTML(apt.owner.name)}`;

                // Tambahkan pesan sambutan awal
                const initialMessageText = type === 'support'
                    ? 'Selamat datang di layanan dukungan Green Valley! Ada yang bisa kami bantu?'
                    : `Halo! Anda terhubung dengan ${AppUtils.sanitizeHTML(apt.owner.name)}. Ada pertanyaan mengenai ${AppUtils.sanitizeHTML(apt.name)}?`;

                const initialMessage = {
                    id: AppUtils.generateUID(),
                    text: initialMessageText,
                    sender: type, // 'support' or 'owner'
                    timestamp: new Date().toISOString()
                };
                this.state.chatState.messages.push(initialMessage);
                this._renderChatMessages();

                this.toggleChatbox(true); // Buka chatbox
            }

            /**
             * Handler untuk mengirim pesan chat.
             */
            async handleSendChatMessage() {
                const messageText = this.uiElements.chatInputMessage.value.trim();
                if (!messageText) return;

                // Tambah pesan pengguna ke UI
                const userMessage = {
                    id: AppUtils.generateUID(),
                    text: messageText,
                    sender: 'user',
                    timestamp: new Date().toISOString()
                };
                this.state.chatState.messages.push(userMessage);
                this._renderChatMessages();
                this.uiElements.chatInputMessage.value = ''; // Kosongkan input
                this.uiElements.chatInputMessage.focus();

                // Simulasi pengiriman ke backend dan terima balasan
                try {
                    const messageData = { text: messageText, type: this.state.chatState.type, userId: this.state.currentUser.id };
                    const response = await this.backendService.sendMessageToChat(messageData);

                    if (response.success && response.data) {
                        this.state.chatState.messages.push(response.data); // response.data harusnya objek pesan
                        this._renderChatMessages();
                    } else {
                        throw new Error(response.message || "Gagal mengirim pesan.");
                    }
                } catch (error) {
                    console.error("Error kirim chat:", error);
                    const errorMessage = {
                        id: AppUtils.generateUID(),
                        text: "Maaf, terjadi kesalahan saat mengirim pesan Anda. Silakan coba lagi.",
                        sender: 'system-error', // Tipe khusus untuk error
                        timestamp: new Date().toISOString()
                    };
                    this.state.chatState.messages.push(errorMessage);
                    this._renderChatMessages();
                }
            }

            /**
             * Render pesan chat ke DOM.
             * @private
             */
            _renderChatMessages() {
                this.uiElements.chatMessagesContainer.innerHTML = this.state.chatState.messages.map(msg => {
                    let senderClass = '';
                    if (msg.sender === 'user') senderClass = 'user';
                    else if (msg.sender === 'support' || msg.sender === 'owner') senderClass = msg.sender; // 'support' atau 'owner'
                    else if (msg.sender === 'system-error') senderClass = 'error';

                    return `
                    <div class="chat-message ${senderClass}">
                        ${AppUtils.sanitizeHTML(msg.text)}
                        <span class="text-xs text-muted block mt-xs" style="font-size:0.7rem; opacity:0.7;">
                            ${new Date(msg.timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}
                        </span>
                    </div>
                `;
                }).join('');
                // Scroll ke pesan terbaru
                this.uiElements.chatMessagesContainer.scrollTop = this.uiElements.chatMessagesContainer.scrollHeight;
            }

            // ======================================================================================
            // FITUR LAINNYA (Tema, Notifikasi, Laporan)
            // ======================================================================================

            /**
             * Handler untuk melaporkan masalah.
             */
            async handleReportIssue() {
                const category = this.uiElements.reportCategorySelect.value;
                const description = this.uiElements.reportDescriptionTextarea.value.trim();
                // const attachment = document.getElementById('report-attachment').files[0]; // Handle file jika perlu

                if (!category || !description) {
                    this.showNotification("Kategori dan deskripsi laporan tidak boleh kosong.", "warning");
                    return;
                }

                this.showNotification("Mengirim laporan Anda...", "info", true);
                const reportData = {
                    category, description,
                    userId: this.state.currentUser.id,
                    apartmentId: this.state.selectedApartmentId, // Jika relevan
                    page: this.state.currentView,
                    timestamp: new Date().toISOString()
                };

                try {
                    const result = await this.backendService.submitReport(reportData);
                    if (result.success) {
                        this.closeModal('report-modal');
                        this.uiElements.reportForm.reset();
                        this.showNotification("Laporan Anda telah berhasil dikirim. Terima kasih atas masukannya!", "success");
                    } else {
                        this.showNotification(`Gagal mengirim laporan: ${result.message || 'Silakan coba lagi.'}`, "error");
                    }
                } catch (error) {
                    console.error("Error lapor masalah:", error);
                    this.showNotification("Terjadi kesalahan server saat mengirim laporan.", "error");
                }
            }


            /**
             * Mengganti tema aplikasi (light/dark).
             */
            toggleTheme() {
                const newTheme = this.state.currentTheme === 'light' ? 'dark' : 'light';
                this.state.currentTheme = newTheme;
                this.uiElements.htmlElement.dataset.theme = newTheme;
                AppUtils.saveToLocalStorage('Green Valley_theme', newTheme);

                // Update ikon tombol tema
                const themeIcon = this.uiElements.themeToggleBtn.querySelector('i');
                themeIcon.className = newTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
                this.uiElements.themeToggleBtn.setAttribute('aria-label', newTheme === 'light' ? 'Ganti ke Tema Gelap' : 'Ganti ke Tema Terang');

                this.showNotification(`Tema diubah ke ${newTheme === 'light' ? 'Terang' : 'Gelap'}.`, "info");
            }

            /**
             * Menerapkan tema awal saat aplikasi dimuat.
             * @private
             */
            _applyInitialTheme() {
                this.uiElements.htmlElement.dataset.theme = this.state.currentTheme;
                const themeIcon = this.uiElements.themeToggleBtn.querySelector('i');
                themeIcon.className = this.state.currentTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
                this.uiElements.themeToggleBtn.setAttribute('aria-label', this.state.currentTheme === 'light' ? 'Ganti ke Tema Gelap' : 'Ganti ke Tema Terang');
            }

            /**
             * Menampilkan notifikasi (toast).
             * @param {string} message - Pesan notifikasi.
             * @param {'success'|'error'|'info'|'warning'} type - Tipe notifikasi.
             * @param {boolean} [persistent=false] - Apakah notifikasi tetap tampil hingga ditutup manual.
             * @param {number} [duration=3000] - Durasi tampil jika tidak persisten (ms).
             */
            showNotification(message, type = 'info', persistent = false, duration = 3000) {
                const notificationId = `notif-${AppUtils.generateUID()}`;
                const notificationElement = document.createElement('div');
                notificationElement.id = notificationId;
                notificationElement.className = `app-notification ${type}`;
                notificationElement.setAttribute('role', 'alert');
                notificationElement.setAttribute('aria-live', 'assertive');

                let iconClass = 'fas fa-info-circle';
                if (type === 'success') iconClass = 'fas fa-check-circle';
                else if (type === 'error') iconClass = 'fas fa-exclamation-circle';
                else if (type === 'warning') iconClass = 'fas fa-exclamation-triangle';

                notificationElement.innerHTML = `
                <i class="${iconClass}"></i>
                <span>${AppUtils.sanitizeHTML(message)}</span>
                ${persistent ? `<button class="ml-auto bg-transparent border-none text-inherit cursor-pointer" aria-label="Tutup Notifikasi" data-dismiss-notif="${notificationId}">&times;</button>` : ''}
            `;

                this.uiElements.appNotificationArea.appendChild(notificationElement);

                // Trigger animation
                requestAnimationFrame(() => {
                    notificationElement.classList.add('show');
                });

                if (!persistent) {
                    setTimeout(() => {
                        notificationElement.classList.remove('show');
                        // Hapus elemen setelah transisi selesai
                        notificationElement.addEventListener('transitionend', () => notificationElement.remove(), { once: true });
                    }, duration);
                } else {
                    const dismissButton = notificationElement.querySelector(`[data-dismiss-notif="${notificationId}"]`);
                    if (dismissButton) {
                        dismissButton.addEventListener('click', () => {
                            notificationElement.classList.remove('show');
                            notificationElement.addEventListener('transitionend', () => notificationElement.remove(), { once: true });
                        }, { once: true });
                    }
                }
            }

            /**
             * Update tahun di footer.
             * @private
             */
            _updateFooterYear() {
                if (this.uiElements.footerYear) {
                    this.uiElements.footerYear.textContent = new Date().getFullYear();
                }
            }
        }

        // ======================================================================================
        // INISIALISASI APLIKASI SAAT DOM SIAP
        // ======================================================================================
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new Green ValleyApp(); // Buat instance aplikasi dan simpan global untuk akses mudah (opsional, bisa dihindari dengan event bus)
        });

    </script>
</body>

</html>