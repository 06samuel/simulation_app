<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description"
    content="Rentelindo - Platform penyewaan apartemen modern dan terpercaya. Temukan apartemen impian Anda dengan mudah.">
  <meta name="keywords" content="sewa apartemen, apartemen, rental, properti, Rentelindo">
  <meta name="author" content="Rentelindo">
  <title>Rentelindo - Penyewaan Apartemen Premium</title>
  <!-- Ikon Material Google -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Font Inter Google -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* SISTEM DESAIN & VARIABEL GLOBAL */
    :root {
      --color-primary: hsl(210, 85%, 55%);
      /* Biru yang lebih modern */
      --color-primary-light: hsl(210, 85%, 95%);
      --color-primary-dark: hsl(210, 85%, 45%);
      --color-secondary: hsl(170, 70%, 45%);
      /* Teal/Hijau Mint */
      --color-secondary-light: hsl(170, 70%, 95%);
      --color-secondary-dark: hsl(170, 70%, 35%);
      --color-accent: hsl(30, 90%, 60%);
      --color-background: hsl(0, 0%, 98%);
      --color-surface: hsl(0, 0%, 100%);
      --color-foreground: hsl(210, 15%, 25%);
      --color-foreground-muted: hsl(210, 15%, 55%);
      --color-border: hsl(210, 20%, 88%);
      --color-success: hsl(140, 60%, 50%);
      --color-error: hsl(0, 70%, 60%);
      --color-warning: hsl(40, 80%, 60%);
      --color-warning-light: hsl(40, 80%, 95%);


      --font-family-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --font-size-base: 1rem;
      /* 16px default */
      --line-height-base: 1.6;

      --space-xxs: 0.25rem;
      /* 4px */
      --space-xs: 0.5rem;
      /* 8px */
      --space-sm: 0.75rem;
      /* 12px */
      --space-md: 1rem;
      /* 16px */
      --space-lg: 1.5rem;
      /* 24px */
      --space-xl: 2rem;
      /* 32px */
      --space-xxl: 3rem;
      /* 48px */

      --radius-sm: 0.25rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-full: 9999px;

      --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.03);
      --shadow-sm: 0 2px 4px -1px rgba(0, 0, 0, 0.06), 0 2px 2px -1px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 4px 8px -2px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

      --transition-base: all 0.25s ease-in-out;
      --transition-fast: all 0.15s ease-in-out;

      --z-index-dropdown: 1000;
      --z-index-sticky: 1020;
      --z-index-modal-backdrop: 1040;
      --z-index-modal: 1050;
      --z-index-popover: 1060;
      --z-index-tooltip: 1070;
      --z-index-chatbox: 1100;
    }

    /* RESET & DASAR */
    *,
    *::before,
    *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
      font-size: var(--font-size-base);
    }

    body {
      font-family: var(--font-family-sans);
      background-color: var(--color-background);
      color: var(--color-foreground);
      line-height: var(--line-height-base);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      display: flex;
      /* Memungkinkan footer menempel di bawah */
      flex-direction: column;
      /* Konten bertumpuk secara vertikal */
      min-height: 100vh;
      /* Minimal setinggi viewport */
    }

    .main-content {
      flex-grow: 1;
      /* Konten utama mengisi ruang yang tersedia */
    }

    a {
      text-decoration: none;
      color: var(--color-primary);
      transition: var(--transition-fast);
    }

    a:hover {
      color: var(--color-primary-dark);
      text-decoration: underline;
    }

    img,
    picture,
    video,
    canvas {
      /* SVG dikecualikan sesuai permintaan */
      display: block;
      max-width: 100%;
    }

    button,
    input,
    select,
    textarea {
      font-family: inherit;
      font-size: inherit;
      line-height: inherit;
      color: inherit;
      outline: none;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
    }

    button {
      cursor: pointer;
      background-color: transparent;
      /* Default tombol tanpa background */
      border: none;
      /* Default tombol tanpa border, akan di-override oleh kelas .btn */
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      font-weight: 600;
      line-height: 1.3;
      margin-bottom: var(--space-md);
    }

    h1 {
      font-size: 2.25rem;
    }

    /* 36px */
    h2 {
      font-size: 1.875rem;
    }

    /* 30px */
    h3 {
      font-size: 1.5rem;
    }

    /* 24px */
    p {
      margin-bottom: var(--space-md);
    }

    ul,
    ol {
      list-style: none;
    }

    /* KELAS UTILITAS */
    .container {
      width: 100%;
      max-width: 1280px;
      /* Lebar kontainer lebih besar */
      margin-left: auto;
      margin-right: auto;
      padding-left: var(--space-lg);
      padding-right: var(--space-lg);
    }

    .flex {
      display: flex;
    }

    .flex-col {
      flex-direction: column;
    }

    .items-center {
      align-items: center;
    }

    .justify-center {
      justify-content: center;
    }

    .justify-between {
      justify-content: space-between;
    }

    .justify-end {
      justify-content: flex-end;
    }

    .gap-xxs {
      gap: var(--space-xxs);
    }

    .gap-xs {
      gap: var(--space-xs);
    }

    .gap-sm {
      gap: var(--space-sm);
    }

    .gap-md {
      gap: var(--space-md);
    }

    .gap-lg {
      gap: var(--space-lg);
    }

    .gap-xl {
      gap: var(--space-xl);
    }

    .p-xs {
      padding: var(--space-xs);
    }

    .p-sm {
      padding: var(--space-sm);
    }

    .p-md {
      padding: var(--space-md);
    }

    .p-lg {
      padding: var(--space-lg);
    }

    .p-xl {
      padding: var(--space-xl);
    }

    .m-xs {
      margin: var(--space-xs);
    }

    .m-sm {
      margin: var(--space-sm);
    }

    .m-md {
      margin: var(--space-md);
    }

    .m-lg {
      margin: var(--space-lg);
    }

    .m-xl {
      margin: var(--space-xl);
    }

    .my-auto {
      margin-top: auto;
      margin-bottom: auto;
    }

    .mx-auto {
      margin-left: auto;
      margin-right: auto;
    }

    .mt-auto {
      margin-top: auto;
    }

    .mt-xxs {
      margin-top: var(--space-xxs);
    }

    .mt-xs {
      margin-top: var(--space-xs);
    }

    .mt-sm {
      margin-top: var(--space-sm);
    }

    .mt-md {
      margin-top: var(--space-md);
    }

    .mt-lg {
      margin-top: var(--space-lg);
    }

    .mt-xl {
      margin-top: var(--space-xl);
    }

    .mb-auto {
      margin-bottom: auto;
    }

    .mb-xxs {
      margin-bottom: var(--space-xxs);
    }

    .mb-xs {
      margin-bottom: var(--space-xs);
    }

    .mb-sm {
      margin-bottom: var(--space-sm);
    }

    .mb-md {
      margin-bottom: var(--space-md);
    }

    .mb-lg {
      margin-bottom: var(--space-lg);
    }

    .mb-xl {
      margin-bottom: var(--space-xl);
    }

    .ml-auto {
      margin-left: auto;
    }

    .mr-auto {
      margin-right: auto;
    }

    .mr-sm {
      margin-right: var(--space-sm);
    }

    .ml-sm {
      margin-left: var(--space-sm);
    }


    .w-full {
      width: 100%;
    }

    .w-1\/2 {
      width: 50%;
    }

    .text-primary {
      color: var(--color-primary);
    }

    .text-secondary {
      color: var(--color-secondary);
    }

    .text-accent {
      color: var(--color-accent);
    }

    .text-muted {
      color: var(--color-foreground-muted);
    }

    .text-error {
      color: var(--color-error);
    }

    .text-success {
      color: var(--color-success);
    }


    .text-xs {
      font-size: 0.75rem;
    }

    /* 12px */
    .text-sm {
      font-size: 0.875rem;
    }

    /* 14px */
    .text-lg {
      font-size: 1.125rem;
    }

    /* 18px */
    .text-xl {
      font-size: 1.25rem;
    }

    /* 20px */
    .text-2xl {
      font-size: 1.5rem;
    }

    /* 24px */
    .text-3xl {
      font-size: 1.875rem;
    }

    /* 30px */


    .font-light {
      font-weight: 300;
    }

    .font-normal {
      font-weight: 400;
    }

    .font-medium {
      font-weight: 500;
    }

    .font-semibold {
      font-weight: 600;
    }

    .font-bold {
      font-weight: 700;
    }

    .rounded-sm {
      border-radius: var(--radius-sm);
    }

    .rounded-md {
      border-radius: var(--radius-md);
    }

    .rounded-lg {
      border-radius: var(--radius-lg);
    }

    .rounded-full {
      border-radius: var(--radius-full);
    }

    .shadow-xs {
      box-shadow: var(--shadow-xs);
    }

    .shadow-sm {
      box-shadow: var(--shadow-sm);
    }

    .shadow-md {
      box-shadow: var(--shadow-md);
    }

    .shadow-lg {
      box-shadow: var(--shadow-lg);
    }

    .shadow-xl {
      box-shadow: var(--shadow-xl);
    }


    .transition {
      transition: var(--transition-base);
    }

    .hidden {
      display: none !important;
    }

    .sr-only {
      /* Screen reader only */
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }

    .fade-in {
      opacity: 0;
      transform: translateY(15px);
      animation: fadeInAnimation 0.5s ease-out forwards;
    }

    @keyframes fadeInAnimation {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .text-center {
      text-align: center;
    }

    /* GRID SYSTEM */
    .grid {
      display: grid;
      gap: var(--space-lg);
      /* Default gap */
    }

    .grid-cols-1 {
      grid-template-columns: repeat(1, 1fr);
    }

    .grid-cols-2 {
      grid-template-columns: repeat(2, 1fr);
    }

    .grid-cols-3 {
      grid-template-columns: repeat(3, 1fr);
    }

    .grid-cols-4 {
      grid-template-columns: repeat(4, 1fr);
    }

    .md\:grid-cols-3 {
      /* Hanya berlaku pada medium screen ke atas */
      /* Dihandle oleh @media query di bawah */
    }

    .lg\:grid-cols-12 {
      /* Hanya berlaku pada large screen ke atas */
      /* Dihandle oleh @media query di bawah */
    }

    .lg\:col-span-4,
    .lg\:col-span-8,
    .lg\:col-span-2,
    .lg\:col-span-1 {
      /* Dihandle oleh @media query di bawah */
    }


    .grid-cols-autofit-200 {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    .grid-cols-autofit-250 {
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }

    .grid-cols-autofit-300 {
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }

    .col-span-full {
      grid-column: 1 / -1;
    }


    /* KOMPONEN: TOMBOL (BUTTON) */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-xs);
      padding: var(--space-sm) var(--space-lg);
      font-weight: 500;
      text-align: center;
      vertical-align: middle;
      cursor: pointer;
      border: 1px solid transparent;
      border-radius: var(--radius-md);
      transition: var(--transition-base);
      user-select: none;
      /* Mencegah teks terseleksi saat klik cepat */
      line-height: 1;
      /* Untuk konsistensi tinggi tombol */
    }

    .btn .material-icons {
      font-size: 1.25em;
      /* Relatif terhadap font size tombol */
      line-height: 1;
      /* Untuk alignment vertikal yang lebih baik */
    }

    .btn-primary {
      background-color: var(--color-primary);
      color: var(--color-surface);
      border-color: var(--color-primary);
    }

    .btn-primary:hover,
    .btn-primary:focus-visible {
      background-color: var(--color-primary-dark);
      border-color: var(--color-primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .btn-primary:focus-visible {
      outline: 2px solid var(--color-primary-light);
      outline-offset: 2px;
    }


    .btn-secondary {
      background-color: var(--color-secondary);
      color: var(--color-surface);
      border-color: var(--color-secondary);
    }

    .btn-secondary:hover,
    .btn-secondary:focus-visible {
      background-color: hsl(170, 70%, 35%);
      border-color: hsl(170, 70%, 35%);
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .btn-outline {
      background-color: transparent;
      border-color: var(--color-border);
      color: var(--color-foreground);
    }

    .btn-outline:hover,
    .btn-outline:focus-visible {
      border-color: var(--color-primary);
      color: var(--color-primary);
      background-color: var(--color-primary-light);
    }

    .btn-error {
      background-color: var(--color-error);
      color: var(--color-surface);
      border-color: var(--color-error);
    }

    .btn-error:hover,
    .btn-error:focus-visible {
      background-color: hsl(0, 70%, 50%);
      border-color: hsl(0, 70%, 50%);
    }

    .btn-link {
      background-color: transparent;
      border-color: transparent;
      color: var(--color-primary);
      padding-left: var(--space-xs);
      padding-right: var(--space-xs);
      text-decoration: none;
      /* Umumnya link button tidak ada underline default */
    }

    .btn-link:hover,
    .btn-link:focus-visible {
      color: var(--color-primary-dark);
      text-decoration: underline;
    }

    .btn-sm {
      padding: var(--space-xs) var(--space-sm);
      font-size: var(--text-sm);
    }

    .btn-lg {
      padding: var(--space-md) var(--space-xl);
      font-size: var(--text-lg);
    }

    .btn-full {
      width: 100%;
    }

    /* KOMPONEN: FORMULIR (FORM) */
    .form-group {
      margin-bottom: var(--space-lg);
    }

    .form-group label {
      display: block;
      font-weight: 500;
      margin-bottom: var(--space-xs);
      color: var(--color-foreground);
    }

    .form-group input[type="text"],
    .form-group input[type="email"],
    .form-group input[type="password"],
    .form-group input[type="date"],
    .form-group input[type="number"],
    .form-group input[type="range"],
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: var(--space-sm) var(--space-md);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background-color: var(--color-surface);
      transition: var(--transition-fast);
      font-size: 1rem;
      /* Jaga konsistensi ukuran font input */
    }

    .form-group input[type="range"] {
      padding: 0;
      /* Range slider biasanya tidak butuh padding vertikal */
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px var(--color-primary-light);
      /* Ganti ke box-shadow untuk outline internal */
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-group input[type="checkbox"],
    .form-group input[type="radio"] {
      margin-right: var(--space-xs);
      accent-color: var(--color-primary);
      /* Modern checkbox color */
      width: auto;
      /* Checkbox tidak perlu full width */
      vertical-align: middle;
    }

    .form-group .checkbox-label,
    .form-group .radio-label {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-weight: normal;
      /* Label checkbox biasanya tidak bold */
    }

    .search-form-quick {
      /* Untuk form di homepage */
    }

    .md\:grid-cols-3 .form-group {
      /* Untuk form di homepage pada layar md */
      margin-bottom: 0;
      /* Hapus margin bawah jika sudah diatur oleh grid gap */
    }


    /* KOMPONEN: KARTU (CARD) */
    .card {
      background-color: var(--color-surface);
      border-radius: var(--radius-lg);
      /* Lebih bulat */
      box-shadow: var(--shadow-md);
      overflow: hidden;
      transition: var(--transition-base);
      display: flex;
      flex-direction: column;
    }

    .card:hover,
    .card:focus-within {
      /* Tambahkan focus-within untuk aksesibilitas */
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }

    .card-img {
      width: 100%;
      height: 220px;
      /* Lebih tinggi */
      object-fit: cover;
    }

    .card-body {
      padding: var(--space-lg);
      flex-grow: 1;
      /* Agar body mengisi sisa ruang */
      display: flex;
      flex-direction: column;
    }

    .card-title {
      font-size: 1.25rem;
      /* 20px */
      margin-bottom: var(--space-sm);
      color: var(--color-foreground);
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }

    .card-title .material-icons {
      color: var(--color-success);
      font-size: 1.1em;
      /* Relatif ke font card-title */
    }

    .card-subtitle {
      font-size: 0.9rem;
      color: var(--color-foreground-muted);
      margin-bottom: var(--space-md);
    }

    .card-text {
      margin-bottom: var(--space-md);
      flex-grow: 1;
      /* Agar teks mengisi sebelum tombol */
      font-size: var(--text-sm);
      /* Teks deskripsi kartu biasanya lebih kecil */
    }

    .card-details {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-sm);
      font-size: var(--text-sm);
    }

    .card-price {
      color: var(--color-primary);
      font-weight: 600;
      font-size: 1.1rem;
    }

    .card-location {
      display: flex;
      align-items: center;
      gap: var(--space-xxs);
      color: var(--color-foreground-muted);
    }

    .card-location .material-icons {
      font-size: 1.1em;
      /* Relatif ke font card-location */
    }

    .card-features {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-sm);
      /* Beri jarak antar fitur */
      color: var(--color-foreground-muted);
      font-size: var(--text-sm);
      margin-bottom: var(--space-md);
    }

    .card-features span {
      display: inline-flex;
      align-items: center;
      gap: var(--space-xxs);
    }

    .card-features .material-icons {
      font-size: 1.1em;
      /* Relatif ke font card-features */
    }

    .card-actions {
      margin-top: auto;
      /* Mendorong tombol ke bawah */
    }

    details.card-details-extra {
      padding: var(--space-md);
      border-top: 1px solid var(--color-border);
      margin-top: var(--space-md);
    }

    details.card-details-extra summary {
      cursor: pointer;
      color: var(--color-primary);
      font-weight: 500;
      list-style: none;
      /* Hapus marker default */
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-xs) 0;
      /* Beri sedikit padding untuk area klik yang lebih baik */
    }

    details.card-details-extra summary:focus-visible {
      /* Aksesibilitas */
      outline: 2px solid var(--color-accent);
      outline-offset: 1px;
    }


    details.card-details-extra summary::-webkit-details-marker {
      display: none;
    }

    /* Chrome/Safari */
    details.card-details-extra summary::after {
      content: 'expand_more';
      font-family: 'Material Icons';
      font-weight: normal;
      font-style: normal;
      font-size: 24px;
      line-height: 1;
      letter-spacing: normal;
      text-transform: none;
      display: inline-block;
      white-space: nowrap;
      word-wrap: normal;
      direction: ltr;
      -webkit-font-feature-settings: 'liga';
      -webkit-font-smoothing: antialiased;
      transition: transform 0.2s ease-in-out;
    }

    details.card-details-extra[open] summary::after {
      transform: rotate(180deg);
    }

    details.card-details-extra p,
    details.card-details-extra ul {
      /* Juga untuk list dalam details */
      margin-top: var(--space-sm);
      font-size: var(--text-sm);
      /* Konten details biasanya lebih kecil */
    }

    details.card-details-extra ul {
      padding-left: var(--space-md);
      /* Indentasi untuk list */
      list-style: disc;
      /* Tampilkan bullet point */
    }


    /* KOMPONEN: KUTIPAN (QUOTE) */
    blockquote.quote {
      /* Ganti .quote menjadi blockquote.quote untuk semantik */
      font-style: italic;
      margin: var(--space-md) 0;
      padding: var(--space-sm) var(--space-md);
      border-left: 4px solid var(--color-secondary);
      background-color: hsl(170, 70%, 95%);
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      color: var(--color-foreground-muted);
    }

    blockquote.quote p {
      margin-bottom: 0;
    }

    /* Override default p margin */

    /* HEADER & NAVIGASI */
    .app-header {
      background-color: var(--color-surface);
      padding-top: var(--space-md);
      padding-bottom: var(--space-md);
      position: sticky;
      top: 0;
      z-index: var(--z-index-sticky);
      box-shadow: var(--shadow-sm);
      border-bottom: 1px solid var(--color-border);
    }

    .navbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .nav-brand {
      font-size: 1.75rem;
      /* 28px */
      font-weight: 700;
      color: var(--color-primary);
      letter-spacing: -0.5px;
      text-decoration: none;
      /* Hapus underline dari brand link */
    }

    .nav-brand:hover {
      text-decoration: none;
      /* Pastikan tidak ada underline saat hover */
      opacity: 0.8;
    }

    .nav-links {
      display: flex;
      gap: var(--space-lg);
      list-style: none;
    }

    .nav-link {
      font-weight: 500;
      color: var(--color-foreground);
      cursor: pointer;
      position: relative;
      padding-bottom: var(--space-xs);
      transition: var(--transition-fast);
      text-decoration: none;
      /* Hapus underline default dari link */
    }

    .nav-link:hover,
    .nav-link.active {
      color: var(--color-primary);
      text-decoration: none;
      /* Pastikan tidak ada underline saat hover/active */
    }

    .nav-link::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 2px;
      background-color: var(--color-primary);
      transition: width 0.3s ease;
    }

    .nav-link:hover::after,
    .nav-link.active::after {
      width: 100%;
    }

    .nav-toggle {
      display: none;
      /* Sembunyikan di desktop */
      background: none;
      border: none;
      color: var(--color-foreground);
      font-size: 1.8rem;
      /* Ukuran ikon menu */
      padding: var(--space-xs);
      /* Beri area klik yang lebih baik */
    }

    /* KONTEN UTAMA (MAIN CONTENT) */
    .main-content {
      padding-top: var(--space-xl);
      padding-bottom: var(--space-xl);
    }

    .page {
      display: block;
      /* Defaultnya block, akan di-toggle ke none oleh JS */
      animation: fadeInAnimation 0.5s ease-out forwards;
      opacity: 0;
      /* Mulai dari transparan untuk animasi */
    }

    .page.hidden {
      /* Overwrite display: block saat hidden */
      display: none !important;
      opacity: 0;
      animation: none;
      /* Hapus animasi jika disembunyikan lagi */
    }


    /* HALAMAN PENCARIAN */
    .search-filters {
      background-color: var(--color-surface);
      padding: var(--space-lg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      /* Sticky behavior diatur via @media query */
      align-self: flex-start;
      /* Agar tidak stretch di flex container */
    }

    .map-canvas {
      width: 100%;
      height: 200px;
      background-color: hsl(200, 20%, 95%);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-md);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-foreground-muted);
      font-style: italic;
      border: 1px solid var(--color-border);
      /* Beri border tipis */
      text-align: center;
      /* Agar teks simulasi di tengah */
    }

    .radius-display,
    .price-display {
      display: inline-block;
      min-width: 50px;
      /* Agar tidak loncat-loncat saat nilai berubah */
      font-weight: 500;
      color: var(--color-primary);
      /* Warna agar menonjol */
    }

    /* KALENDER */
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: var(--space-xs);
      border: 1px solid var(--color-border);
      padding: var(--space-sm);
      border-radius: var(--radius-md);
      background-color: var(--color-surface);
      /* Background kalender */
    }

    .calendar-header {
      text-align: center;
      font-weight: 500;
      padding: var(--space-xs) 0;
      color: var(--color-foreground-muted);
      font-size: var(--text-sm);
      /* Ukuran font header hari lebih kecil */
    }

    .calendar-day {
      padding: var(--space-sm);
      text-align: center;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition-fast);
      border: 1px solid transparent;
      /* Border default transparan */
      line-height: 1;
      /* Untuk konsistensi tinggi sel */
      aspect-ratio: 1 / 1;
      /* Membuat sel jadi kotak */
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .calendar-day:hover:not(.empty):not(.booked):not(.disabled),
    .calendar-day:focus-visible:not(.empty):not(.booked):not(.disabled) {
      background-color: var(--color-primary-light);
      border-color: var(--color-primary);
      color: var(--color-primary-dark);
    }

    .calendar-day.empty {
      cursor: default;
      visibility: hidden;
      /* Sembunyikan hari kosong */
    }

    .calendar-day.disabled {
      /* Untuk tanggal yang sudah lewat */
      background-color: hsl(0, 0%, 92%);
      color: var(--color-foreground-muted);
      cursor: not-allowed;
      text-decoration: line-through;
      /* Coret tanggal lewat */
      opacity: 0.7;
    }

    .calendar-day.available {
      /* Default state */
    }

    .calendar-day.booked {
      background-color: hsl(0, 0%, 85%);
      /* Lebih gelap dari disabled */
      color: var(--color-foreground-muted);
      cursor: not-allowed;
      text-decoration: line-through;
      font-style: italic;
      /* Tambahan pembeda */
    }

    .calendar-day.selected {
      background-color: var(--color-primary);
      color: var(--color-surface);
      border-color: var(--color-primary-dark);
      font-weight: bold;
    }

    .calendar-day.selected:hover {
      background-color: var(--color-primary-dark);
    }

    .calendar-day.today {
      font-weight: bold;
      border: 1px dashed var(--color-secondary);
      color: var(--color-secondary-dark);
    }

    .calendar-day.today.selected {
      /* Jika hari ini juga terpilih */
      border-color: var(--color-primary-dark);
      /* Prioritaskan style selected */
      color: var(--color-surface);
    }


    .calendar-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-md);
    }

    .calendar-nav button {
      background: none;
      border: none;
      padding: var(--space-xs);
      color: var(--color-primary);
      /* Warna tombol navigasi kalender */
    }

    .calendar-nav button:hover,
    .calendar-nav button:focus-visible {
      background-color: var(--color-primary-light);
      border-radius: var(--radius-full);
    }

    .calendar-nav .material-icons {
      font-size: 1.5rem;
    }

    #currentMonthYearCalendarSearch,
    #currentMonthYearBookingCalendar {
      /* Untuk teks bulan dan tahun */
      font-weight: 500;
      color: var(--color-foreground);
    }


    /* HALAMAN DETAIL APARTEMEN */
    .apartment-gallery {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      /* Kolom utama besar, dua lainnya kecil */
      grid-template-rows: auto auto;
      gap: var(--space-sm);
      margin-bottom: var(--space-xl);
      max-height: 500px;
      /* Batasi tinggi galeri */
      border-radius: var(--radius-lg);
      /* Radius untuk kontainer galeri */
      overflow: hidden;
      /* Agar gambar tidak keluar dari radius */
    }

    .gallery-item {
      overflow: hidden;
      /* border-radius: var(--radius-md); Dihapus, radius di parent .apartment-gallery */
      cursor: pointer;
      position: relative;
      /* Untuk overlay */
    }

    .gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .gallery-item:hover img {
      transform: scale(1.05);
    }

    .gallery-item:first-child {
      grid-row: 1 / span 2;
      /* Gambar pertama mengisi 2 baris */
      grid-column: 1 / span 1;
      /* Gambar pertama mengisi 1 kolom */
    }

    /* Untuk 3 gambar atau kurang, agar tidak aneh */
    .apartment-gallery.single-image .gallery-item:first-child {
      grid-column: 1 / -1;
      /* Span semua kolom */
      grid-row: 1 / -1;
      /* Span semua baris */
    }

    .apartment-gallery.two-images .gallery-item:nth-child(1) {
      grid-column: 1 / span 1;
      grid-row: 1 / -1;
    }

    .apartment-gallery.two-images .gallery-item:nth-child(2) {
      grid-column: 2 / -1;
      grid-row: 1 / -1;
    }

    .virtual-tour-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: var(--transition-base);
      pointer-events: none;
      /* Agar tidak menghalangi klik ke gambar */
    }

    .gallery-item:first-child:hover .virtual-tour-overlay,
    .gallery-item:first-child:focus-within .virtual-tour-overlay {
      /* Tampilkan juga saat fokus */
      opacity: 1;
    }

    .virtual-tour-overlay .material-icons {
      font-size: 3rem;
      margin-bottom: var(--space-xs);
    }

    .apartment-details-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      /* Konten utama lebih lebar dari sidebar booking */
      gap: var(--space-xl);
    }

    .booking-form-sticky {
      position: sticky;
      top: calc(var(--space-md) * 2 + 60px + var(--space-lg));
      /* Header + padding main-content */
      align-self: flex-start;
      background-color: var(--color-surface);
      padding: var(--space-lg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
    }

    .payment-methods {
      display: flex;
      gap: var(--space-sm);
      margin-bottom: var(--space-md);
    }

    .payment-method {
      padding: var(--space-sm) var(--space-md);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition-fast);
      flex-grow: 1;
      text-align: center;
      background-color: var(--color-surface);
      /* Warna dasar */
      font-size: var(--text-sm);
      /* Ukuran font lebih kecil */
    }

    .payment-method:hover,
    .payment-method:focus-visible {
      border-color: var(--color-primary);
      background-color: var(--color-primary-light);
      color: var(--color-primary-dark);
    }

    .payment-method.selected {
      border-color: var(--color-primary);
      background-color: var(--color-primary);
      color: var(--color-surface);
      font-weight: 500;
      box-shadow: var(--shadow-xs);
    }

    .cost-breakdown {
      background-color: var(--color-primary-light);
      padding: var(--space-md);
      border-radius: var(--radius-md);
      margin-top: var(--space-lg);
      border: 1px solid var(--color-primary);
    }

    .cost-breakdown h4 {
      margin-bottom: var(--space-sm);
      /* Jarak judul rincian */
      font-size: 1rem;
      /* Ukuran font judul rincian */
    }

    .cost-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: var(--space-xs);
      font-size: var(--text-sm);
    }

    .cost-line.total {
      font-weight: bold;
      font-size: 1rem;
      /* Default font size */
      margin-top: var(--space-sm);
      padding-top: var(--space-sm);
      border-top: 1px dashed var(--color-primary);
    }

    .escrow-info {
      background-color: var(--color-warning-light);
      padding: var(--space-md);
      border-left: 4px solid var(--color-warning);
      margin: var(--space-lg) 0;
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      display: flex;
      /* Untuk alignment ikon dan teks */
      align-items: flex-start;
      /* Agar ikon di atas jika teks panjang */
      gap: var(--space-xs);
    }

    .escrow-info .material-icons {
      color: var(--color-warning);
      font-size: 1.2em;
      /* Sedikit lebih besar */
      margin-top: 2px;
      /* Penyesuaian alignment vertikal */
    }

    .escrow-info p {
      margin-bottom: 0;
    }

    .review-item {
      border-bottom: 1px solid var(--color-border);
      padding-bottom: var(--space-md);
      margin-bottom: var(--space-md);
    }

    .review-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
      /* Hapus padding bawah untuk item terakhir */
    }

    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-xs);
    }

    .review-user {
      font-weight: 500;
    }

    .review-rating .material-icons {
      color: var(--color-accent);
      font-size: 1.1em;
      /* Relatif ke font review-rating */
      vertical-align: middle;
      /* Alignment bintang lebih baik */
    }

    .review-comment {
      color: var(--color-foreground-muted);
    }

    .report-form-container {
      background-color: hsl(0, 70%, 97%);
      padding: var(--space-md);
      border-radius: var(--radius-md);
      margin-top: var(--space-lg);
      border: 1px solid var(--color-error);
    }

    .report-form-container h3 {
      /* Judul form laporan */
      color: var(--color-error);
      font-size: 1.1rem;
    }

    /* HALAMAN PROFIL */
    .chat-window {
      height: 200px;
      overflow-y: auto;
      border: 1px solid var(--color-border);
      padding: var(--space-md);
      border-radius: var(--radius-md);
      background-color: hsl(0, 0%, 96%);
      margin-bottom: var(--space-sm);
    }

    .chat-message {
      margin-bottom: var(--space-sm);
      padding: var(--space-xs) var(--space-sm);
      border-radius: var(--radius-md);
      max-width: 75%;
      word-wrap: break-word;
      line-height: 1.4;
      /* Jarak antar baris dalam pesan */
    }

    .chat-message.sent {
      background-color: var(--color-primary);
      color: var(--color-surface);
      margin-left: auto;
      /* Dorong ke kanan */
      border-bottom-right-radius: var(--radius-xs);
    }

    .chat-message.received {
      background-color: var(--color-surface);
      border: 1px solid var(--color-border);
      margin-right: auto;
      /* Dorong ke kiri */
      border-bottom-left-radius: var(--radius-xs);
    }

    .chat-message.system {
      background-color: var(--color-secondary-light);
      color: var(--color-secondary-dark);
      font-size: var(--text-sm);
      text-align: center;
      max-width: 100%;
      padding: var(--space-xs);
      font-style: italic;
      /* Pesan sistem biasanya italic */
    }

    .chat-input-group {
      display: flex;
      gap: var(--space-sm);
    }

    .chat-input-group input {
      flex-grow: 1;
    }

    .chat-input-group button .material-icons {
      /* Ukuran ikon send di chat input */
      font-size: 1.3rem;
    }


    .loyalty-badge {
      background-color: var(--color-accent);
      color: var(--color-surface);
      padding: var(--space-xxs) var(--space-xs);
      border-radius: var(--radius-sm);
      font-size: 0.8rem;
      font-weight: 500;
      display: inline-block;
      /* Agar padding dan style lain berlaku benar */
      vertical-align: middle;
      /* Alignment dengan teks sekitarnya */
    }

    .notification-item {
      background-color: var(--color-primary-light);
      padding: var(--space-md);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-sm);
      border-left: 4px solid var(--color-primary);
    }

    .notification-item p {
      margin-bottom: var(--space-xs);
    }

    .notification-item p:last-child {
      margin-bottom: 0;
    }


    /* CHATBOX GLOBAL */
    .global-chat-btn {
      position: fixed;
      bottom: var(--space-lg);
      right: var(--space-lg);
      z-index: var(--z-index-chatbox);
      border-radius: var(--radius-full);
      width: 60px;
      height: 60px;
      padding: 0;
      /* Hapus padding default tombol */
      box-shadow: var(--shadow-lg);
      /* Warna dan style dari .btn-primary */
    }

    .global-chat-btn .material-icons {
      font-size: 2rem;
    }

    .chatbox-widget {
      position: fixed;
      bottom: calc(var(--space-lg) + 70px + var(--space-sm));
      /* Di atas tombol chat, beri sedikit jarak */
      right: var(--space-lg);
      width: 320px;
      background-color: var(--color-surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      display: flex;
      flex-direction: column;
      height: 450px;
      /* Tinggi chatbox */
      z-index: var(--z-index-chatbox);
      overflow: hidden;
      /* Mencegah konten keluar dari border radius */
      transform: translateY(20px) scale(0.95);
      opacity: 0;
      visibility: hidden;
      transition: transform 0.3s ease, opacity 0.3s ease, visibility 0s 0.3s;
    }

    .chatbox-widget.open {
      transform: translateY(0) scale(1);
      opacity: 1;
      visibility: visible;
      transition: transform 0.3s ease, opacity 0.3s ease, visibility 0s 0s;
    }

    .chatbox-header {
      background-color: var(--color-primary);
      color: var(--color-surface);
      padding: var(--space-md);
      font-weight: 500;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chatbox-header .close-chat-btn {
      background: none;
      border: none;
      color: var(--color-surface);
      opacity: 0.8;
      padding: var(--space-xs);
      /* Area klik lebih baik */
    }

    .chatbox-header .close-chat-btn:hover,
    .chatbox-header .close-chat-btn:focus-visible {
      opacity: 1;
      background-color: rgba(255, 255, 255, 0.1);
      /* Feedback visual */
      border-radius: var(--radius-full);
    }

    .chatbox-header .close-chat-btn .material-icons {
      font-size: 1.3rem;
      /* Ukuran ikon close di chatbox header */
    }

    .chatbox-body {
      flex-grow: 1;
      overflow-y: auto;
      padding: var(--space-md);
      background-color: hsl(0, 0%, 96%);
    }

    .chatbox-input-area {
      display: flex;
      padding: var(--space-sm);
      border-top: 1px solid var(--color-border);
      background-color: var(--color-surface);
    }

    .chatbox-input-area input {
      flex-grow: 1;
      border-right: none;
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
    }

    .chatbox-input-area button {
      /* Tombol send di chatbox */
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
      padding-left: var(--space-md);
      padding-right: var(--space-md);
      /* Style dari .btn-primary */
      background-color: var(--color-primary);
      color: var(--color-surface);
      border: 1px solid var(--color-primary);
    }

    .chatbox-input-area button:hover,
    .chatbox-input-area button:focus-visible {
      background-color: var(--color-primary-dark);
      border-color: var(--color-primary-dark);
    }

    .chatbox-input-area button .material-icons {
      font-size: 1.5rem;
    }

    /* FOOTER */
    .app-footer {
      background-color: var(--color-foreground);
      color: hsl(0, 0%, 85%);
      padding: var(--space-xl) 0;
      text-align: center;
      font-size: var(--text-sm);
      margin-top: auto;
      /* Mendorong footer ke bawah jika konten pendek */
    }

    .app-footer p {
      margin-bottom: var(--space-xs);
    }

    .app-footer p:last-child {
      margin-bottom: 0;
    }

    .app-footer a {
      color: var(--color-surface);
      text-decoration: underline;
    }

    .app-footer a:hover,
    .app-footer a:focus-visible {
      color: var(--color-primary-light);
      text-decoration: none;
      /* Hapus underline saat hover, beri pembeda lain jika perlu */
    }

    .app-footer .material-icons {
      /* Ikon hati di footer */
      font-size: 1em;
      vertical-align: middle;
      color: var(--color-accent);
    }


    /* MODAL (Untuk galeri atau notifikasi kustom) */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.6);
      z-index: var(--z-index-modal-backdrop);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-md);
      /* Padding agar modal tidak mentok pinggir di mobile */
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0s 0.3s;
    }

    .modal-backdrop.open {
      opacity: 1;
      visibility: visible;
      transition-delay: 0s;
    }

    .modal-content {
      background-color: var(--color-surface);
      padding: var(--space-xl);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      width: 100%;
      /* Lebar modal */
      max-width: 600px;
      /* Max lebar modal, sesuaikan */
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.95) translateY(20px);
      transition: transform 0.3s ease;
    }

    .modal-backdrop.open .modal-content {
      transform: scale(1) translateY(0);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-lg);
      padding-bottom: var(--space-md);
      border-bottom: 1px solid var(--color-border);
    }

    .modal-title {
      margin-bottom: 0;
      font-size: 1.25rem;
      /* Ukuran judul modal */
    }

    .modal-close-btn {
      background: none;
      border: none;
      font-size: 1.8rem;
      color: var(--color-foreground-muted);
      padding: 0;
      line-height: 1;
      /* Untuk alignment ikon */
    }

    .modal-close-btn:hover,
    .modal-close-btn:focus-visible {
      color: var(--color-foreground);
      transform: scale(1.1);
    }

    .modal-close-btn .material-icons {
      font-size: inherit;
      /* Warisi ukuran font dari tombol */
    }

    .modal-body img {
      max-width: 100%;
      height: auto;
      /* Biarkan tinggi menyesuaikan agar tidak terdistorsi */
      max-height: 70vh;
      /* Batasi tinggi gambar dalam modal */
      object-fit: contain;
      /* Agar gambar tidak terpotong */
      border-radius: var(--radius-md);
      margin: 0 auto;
      /* Gambar di tengah jika lebih kecil dari modal body */
      display: block;
      /* Untuk margin auto bekerja */
    }

    .modal-body p {
      /* Styling default paragraf dalam modal body */
      margin-bottom: var(--space-sm);
    }

    .modal-body p:last-child {
      margin-bottom: 0;
    }


    /* RESPONSIVE DESIGN */
    @media (min-width: 769px) {

      /* Medium screens and up */
      .md\:grid-cols-3 {
        grid-template-columns: repeat(3, 1fr);
      }

      /* Kelas untuk layout di halaman pencarian dan detail */
      .search-filters,
      .booking-form-sticky {
        position: sticky;
        top: calc(var(--space-md) * 2 + 60px);
        /* Sesuaikan dengan tinggi header */
      }
    }

    @media (min-width: 1025px) {

      /* Large screens and up */
      .lg\:grid-cols-12 {
        grid-template-columns: repeat(12, 1fr);
      }

      .lg\:col-span-1 {
        grid-column: span 1 / span 1;
      }

      .lg\:col-span-2 {
        grid-column: span 2 / span 2;
      }

      .lg\:col-span-3 {
        grid-column: span 3 / span 3;
      }

      .lg\:col-span-4 {
        grid-column: span 4 / span 4;
      }

      .lg\:col-span-8 {
        grid-column: span 8 / span 8;
      }
    }


    @media (max-width: 1024px) {

      /* Tablet dan di bawahnya */
      .apartment-details-grid {
        grid-template-columns: 1fr;
        /* Tumpuk di tablet */
      }

      .search-filters,
      .booking-form-sticky {
        position: static;
        /* Hapus sticky di tablet agar tidak mengganggu */
        width: 100%;
        margin-bottom: var(--space-xl);
        top: auto;
        /* Reset nilai top */
      }

      .grid-cols-autofit-300 {
        /* Di tablet, mungkin lebih baik jadi 2 kolom atau 1 */
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }
    }

    @media (max-width: 768px) {

      /* Mobile */
      .container {
        padding-left: var(--space-md);
        padding-right: var(--space-md);
      }

      h1 {
        font-size: 1.875rem;
      }

      h2 {
        font-size: 1.5rem;
      }

      h3 {
        font-size: 1.25rem;
      }


      .nav-links {
        display: none;
        /* Sembunyikan link navigasi default */
        flex-direction: column;
        position: absolute;
        top: 100%;
        /* Di bawah header */
        left: 0;
        right: 0;
        background-color: var(--color-surface);
        box-shadow: var(--shadow-md);
        padding: var(--space-md);
        border-top: 1px solid var(--color-border);
        z-index: calc(var(--z-index-sticky) - 1);
        /* Di bawah header tapi di atas konten lain */
      }

      .nav-links.open {
        display: flex;
        /* Tampilkan saat menu dibuka */
      }

      .nav-link {
        padding: var(--space-sm) 0;
        width: 100%;
        text-align: left;
        /* Teks rata kiri di mobile nav */
        padding-left: var(--space-md);
        /* Indentasi */
      }

      .nav-link::after {
        display: none;
        /* Hapus underline di mobile nav */
      }

      .nav-link.active {
        background-color: var(--color-primary-light);
        border-radius: var(--radius-sm);
        color: var(--color-primary-dark);
        /* Warna teks aktif lebih jelas */
      }

      .nav-toggle {
        display: block;
        /* Tampilkan tombol burger */
      }

      /* Semua grid menjadi satu kolom di mobile, kecuali yang sangat spesifik */
      .grid-cols-2,
      .grid-cols-3,
      .grid-cols-4,
      .grid-cols-autofit-200,
      .grid-cols-autofit-250,
      .grid-cols-autofit-300,
      .md\:grid-cols-3 {
        /* Override md juga untuk mobile */
        grid-template-columns: 1fr;
      }

      .apartment-gallery {
        grid-template-columns: 1fr;
        /* Galeri jadi satu kolom */
        grid-template-rows: auto;
        /* Biarkan tinggi otomatis */
        max-height: none;
        /* Hapus batasan tinggi di mobile */
      }

      .gallery-item:first-child {
        /* Reset aturan grid untuk gambar pertama di mobile */
        grid-row: auto;
        grid-column: auto;
      }

      .gallery-item img {
        height: 250px;
        /* Tinggi gambar galeri di mobile */
      }

      .gallery-item:first-child img {
        height: 300px;
        /* Gambar utama sedikit lebih tinggi */
      }


      .chatbox-widget {
        width: calc(100vw - (var(--space-md) * 2));
        /* Lebar penuh dikurangi padding */
        max-width: 320px;
        /* Batasi agar tidak terlalu lebar di tablet potrait */
        height: 70vh;
        max-height: 400px;
        bottom: calc(var(--space-lg) + 65px);
        right: var(--space-md);
        /* Sesuaikan dengan padding container */
        left: var(--space-md);
        margin: 0 auto;
        /* Tengahkan jika max-width tercapai */
      }

      .global-chat-btn {
        width: 50px;
        height: 50px;
        bottom: var(--space-md);
        right: var(--space-md);
      }

      .global-chat-btn .material-icons {
        font-size: 1.5rem;
      }

      .form-group input[type="date"] {
        font-size: 0.9rem;
        /* Ukuran font tanggal agar muat di mobile */
      }

      .search-form-quick .grid,
      .search-form-quick .md\:grid-cols-3 {
        /* Form pencarian cepat di mobile */
        grid-template-columns: 1fr;
        /* Semua input jadi satu kolom */
      }

      .search-form-quick .form-group {
        margin-bottom: var(--space-md);
        /* Kembalikan margin bawah */
      }

      .search-form-quick .btn {
        margin-top: 0;
        /* Hapus margin atas tombol jika form sudah diatur oleh gap grid */
      }

      .payment-methods {
        flex-direction: column;
        /* Tumpuk metode pembayaran di mobile */
      }
    }

    /* AKSESIBILITAS */
    @media (prefers-reduced-motion: reduce) {

      *,
      *::before,
      *::after {
        /* Target semua elemen */
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }

    /* Fokus yang jelas untuk semua elemen interaktif */
    a:focus-visible,
    button:focus-visible,
    input:focus-visible,
    select:focus-visible,
    textarea:focus-visible,
    details>summary:focus-visible,
    [tabindex="0"]:focus-visible {
      /* Juga untuk elemen dengan tabindex */
      outline: 3px solid var(--color-accent) !important;
      /* !important untuk override jika ada style lain */
      outline-offset: 2px !important;
      box-shadow: 0 0 0 3px var(--color-accent) !important;
      /* Fallback jika outline-offset tidak didukung */
    }

    /* Pastikan outline tidak terpotong oleh overflow:hidden pada parent */
    /* Tidak ada solusi CSS murni yang universal, tergantung struktur DOM.
       Biasanya, hindari overflow:hidden pada parent elemen yang bisa fokus,
       atau pastikan padding cukup. */
  </style>
</head>

<body>

  <!-- Header Aplikasi -->
  <header class="app-header">
    <div class="container">
      <nav class="navbar" aria-label="Navigasi utama">
        <a href="#home" class="nav-brand">Rentelindo</a>
        <button class="nav-toggle" id="navToggleBtn" aria-label="Buka menu navigasi" aria-expanded="false"
          aria-controls="navLinksMenu">
          <span class="material-icons">menu</span>
        </button>
        <ul class="nav-links" id="navLinksMenu">
          <li><a href="#home" class="nav-link active" data-page="home">Beranda</a></li>
          <li><a href="#search" class="nav-link" data-page="search">Pencarian</a></li>
          <li><a href="#profile" class="nav-link" data-page="profile">Profil</a></li>
          <li><a href="#support" class="nav-link" data-page="support">Dukungan</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Konten Utama Aplikasi -->
  <main class="main-content container">
    <!-- Halaman Beranda -->
    <section id="home" class="page" aria-labelledby="home-title">
      <h1 id="home-title" class="text-center font-bold mb-md">Temukan Apartemen Impian Anda di Rentelindo</h1>
      <p class="text-center text-lg text-muted mb-xl">Sewa apartemen modern dengan fasilitas premium, aman, dan
        terpercaya.</p>

      <!-- Pencarian Cepat -->
      <form class="search-form-quick card p-lg shadow-lg mb-xl" id="quickSearchForm" role="search">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-md items-end">
          <div class="form-group">
            <label for="quick-location">Lokasi Impian</label>
            <input type="text" id="quick-location" placeholder="Masukkan kota atau nama area" aria-label="Cari lokasi">
          </div>
          <div class="form-group">
            <label for="quick-checkin">Tanggal Check-in</label>
            <input type="date" id="quick-checkin" aria-label="Tanggal check-in" min=""> <!-- min akan diisi JS -->
          </div>
          <div class="form-group">
            <label for="quick-checkout">Tanggal Check-out</label>
            <input type="date" id="quick-checkout" aria-label="Tanggal check-out" min=""> <!-- min akan diisi JS -->
          </div>
        </div>
        <button type="submit" class="btn btn-primary btn-lg btn-full mt-lg">
          <span class="material-icons">search</span>Cari Apartemen
        </button>
      </form>

      <!-- Properti Unggulan -->
      <h2 class="font-semibold mt-xl mb-lg" id="featured-properties-title">Properti Unggulan Pilihan Kami</h2>
      <div class="grid grid-cols-autofit-300 gap-lg mb-xl" id="featuredProperties"
        aria-labelledby="featured-properties-title">
        <!-- Kartu properti akan dimuat oleh JavaScript -->
        <p id="loadingFeaturedMessage" class="text-muted col-span-full text-center">Memuat properti unggulan...</p>
      </div>

      <!-- Testimoni -->
      <h2 class="font-semibold mt-xl mb-lg" id="testimonials-title">Apa Kata Mereka Tentang Rentelindo?</h2>
      <div class="grid grid-cols-autofit-300 gap-lg" aria-labelledby="testimonials-title">
        <div class="card p-lg">
          <blockquote class="quote">
            <p>"Proses pemesanan di Rentelindo sangat mudah dan cepat. Apartemennya juga sesuai dengan deskripsi. Sangat
              direkomendasikan!"</p>
          </blockquote>
          <p class="font-medium mt-md">- Anisa Wulandari</p>
          <p class="text-sm text-muted">Penyewa Terverifikasi</p>
        </div>
        <div class="card p-lg">
          <blockquote class="quote">
            <p>"Saya menemukan apartemen studio yang sempurna untuk perjalanan bisnis saya. Fasilitas lengkap dan lokasi
              strategis. Terima kasih Rentelindo!"</p>
          </blockquote>
          <p class="font-medium mt-md">- Budi Santoso</p>
          <p class="text-sm text-muted">Profesional Muda</p>
        </div>
        <div class="card p-lg">
          <blockquote class="quote">
            <p>"Pelayanan pelanggan sangat responsif. Mereka membantu saya menyelesaikan masalah kecil dengan cepat.
              Pengalaman yang menyenangkan!"</p>
          </blockquote>
          <p class="font-medium mt-md">- Citra Dewi</p>
          <p class="text-sm text-muted">Keluarga Bahagia</p>
        </div>
      </div>
    </section>

    <!-- Halaman Pencarian -->
    <section id="search" class="page hidden" aria-labelledby="search-title">
      <h1 id="search-title" class="font-bold mb-lg">Cari Apartemen Sesuai Keinginan Anda</h1>
      <div class="grid md:grid-cols-1 lg:grid-cols-12 gap-xl">
        <!-- Kolom Filter -->
        <aside class="lg:col-span-4">
          <form class="search-filters" id="detailedSearchForm" role="search">
            <h3 class="font-semibold mb-md">Filter Pencarian</h3>
            <div class="form-group">
              <label for="search-location">Lokasi</label>
              <input type="text" id="search-location" placeholder="cth: Jakarta Selatan">
              <div class="map-canvas mt-sm" id="searchMapCanvas" aria-label="Peta interaktif (simulasi)">Memuat simulasi
                peta...</div>
            </div>
            <div class="form-group">
              <label for="search-radius">Radius Pencarian (Simulasi)</label>
              <input type="range" min="1" max="20" value="5" id="search-radius" class="w-full"
                aria-label="Filter radius pencarian (simulasi)">
              <p class="text-sm text-muted">Jarak: <span id="radiusValueDisplay" class="radius-display">5</span> km</p>
            </div>
            <div class="form-group">
              <label>Tanggal Ketersediaan</label>
              <div class="calendar-nav">
                <button type="button" id="prevMonthBtnCalendarSearch" aria-label="Bulan sebelumnya"><span
                    class="material-icons">chevron_left</span></button>
                <span id="currentMonthYearCalendarSearch" class="font-medium" aria-live="polite">Memuat...</span>
                <button type="button" id="nextMonthBtnCalendarSearch" aria-label="Bulan berikutnya"><span
                    class="material-icons">chevron_right</span></button>
              </div>
              <div class="calendar" id="searchPageCalendar" role="grid" aria-label="Kalender ketersediaan">
                <!-- Hari kalender akan dimuat oleh JavaScript -->
                <p class="text-muted col-span-full text-center">Memuat kalender...</p>
              </div>
              <div class="flex gap-sm mt-sm">
                <input type="date" id="search-checkin-date" class="w-1/2" aria-label="Tanggal check-in terpilih"
                  readonly>
                <input type="date" id="search-checkout-date" class="w-1/2" aria-label="Tanggal check-out terpilih"
                  readonly>
              </div>
            </div>
            <div class="form-group">
              <label for="search-price">Rentang Harga (per bulan)</label>
              <input type="range" min="5000000" max="50000000" value="15000000" step="500000" id="search-price"
                class="w-full" aria-label="Filter harga maksimum per bulan">
              <p class="text-sm text-muted">Maks: Rp <span id="priceValueDisplay"
                  class="price-display">15.000.000</span>
              </p>
            </div>
            <fieldset class="form-group"> <!-- Gunakan fieldset untuk grup checkbox -->
              <legend class="font-medium mb-xs">Fasilitas Utama</legend>
              <div class="grid grid-cols-2 gap-sm">
                <label class="checkbox-label text-sm"><input type="checkbox" name="amenities" value="pool"> Kolam
                  Renang</label>
                <label class="checkbox-label text-sm"><input type="checkbox" name="amenities" value="gym"> Gym</label>
                <label class="checkbox-label text-sm"><input type="checkbox" name="amenities" value="wifi"> WiFi
                  Cepat</label>
                <label class="checkbox-label text-sm"><input type="checkbox" name="amenities" value="parking">
                  Parkir</label>
                <label class="checkbox-label text-sm"><input type="checkbox" name="amenities" value="ac"> AC</label>
                <label class="checkbox-label text-sm"><input type="checkbox" name="amenities" value="laundry">
                  Laundry</label>
                <label class="checkbox-label text-sm"><input type="checkbox" name="amenities" value="kitchen">
                  Dapur</label>
                <label class="checkbox-label text-sm"><input type="checkbox" name="amenities" value="pet-friendly">
                  Ramah Hewan</label>
              </div>
            </fieldset>
            <div class="form-group">
              <label for="search-apartment-type">Tipe Apartemen</label>
              <select id="search-apartment-type">
                <option value="">Semua Tipe</option>
                <option value="studio">Studio</option>
                <option value="1br">1 Kamar Tidur</option>
                <option value="2br">2 Kamar Tidur</option>
                <option value="3br+">3+ Kamar Tidur</option>
                <option value="penthouse">Penthouse</option>
                <option value="loft">Loft</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary btn-full mt-md">
              <span class="material-icons">filter_alt</span>Terapkan Filter
            </button>
            <button type="reset" class="btn btn-outline btn-full mt-sm" id="resetSearchFiltersBtn">
              <span class="material-icons">refresh</span>Reset Filter
            </button>
          </form>
        </aside>
        <!-- Kolom Hasil Pencarian -->
        <div class="lg:col-span-8">
          <h2 class="font-semibold mb-md" id="search-results-title">Hasil Pencarian (<span
              id="searchResultsCount">0</span> apartemen ditemukan)
          </h2>
          <div class="grid grid-cols-autofit-250 gap-lg" id="searchResultsContainer"
            aria-labelledby="search-results-title">
            <!-- Hasil pencarian akan dimuat oleh JavaScript -->
            <p id="noResultsMessage" class="text-muted text-center col-span-full hidden">Maaf, tidak ada apartemen yang
              sesuai dengan kriteria Anda. Coba ubah filter pencarian.</p>
            <p id="loadingSearchResultsMessage" class="text-muted col-span-full text-center">Memuat hasil pencarian...
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Halaman Detail Apartemen -->
    <section id="apartment" class="page hidden" aria-live="polite"> <!-- aria-live untuk update konten dinamis -->
      <div id="apartmentDetailContent">
        <!-- Konten detail akan dimuat oleh JavaScript -->
        <p class="text-center text-lg text-muted p-xl">Memuat detail apartemen...</p>
      </div>
    </section>

    <!-- Halaman Profil Pengguna -->
    <section id="profile" class="page hidden" aria-labelledby="profile-title">
      <h1 id="profile-title" class="font-bold mb-lg">Profil Pengguna Rentelindo</h1>
      <div class="grid md:grid-cols-1 lg:grid-cols-3 gap-xl">
        <!-- Kolom Info Akun & Pesan -->
        <div class="lg:col-span-2">
          <div class="card p-lg mb-xl">
            <h2 class="font-semibold mb-md">Informasi Akun</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-md">
              <div>
                <p><strong>Nama:</strong> <span id="profileName">Ani Wulandari</span></p>
                <p><strong>Email:</strong> <span id="profileEmail">ani.wulandari@example.com</span></p>
                <p><strong>Telepon:</strong> <span id="profilePhone">+62 812 3456 7890</span></p>
              </div>
              <div>
                <p><strong>Poin Loyalitas:</strong> <span id="profileLoyaltyPoints" class="loyalty-badge">1250</span>
                </p>
                <p><strong>Member Sejak:</strong> <span id="profileMemberSince">15 Januari 2023</span></p>
              </div>
            </div>
            <button class="btn btn-outline mt-lg btn-sm">
              <span class="material-icons">edit</span>Edit Profil
            </button>
          </div>

          <div class="card p-lg mb-xl">
            <h2 class="font-semibold mb-md">Pesan dengan Pemilik/Admin (Simulasi)</h2>
            <div class="chat-window" id="profileChatWindow" aria-live="polite">
              <div class="chat-message received">Halo! Ada yang bisa saya bantu terkait properti di Sudirman?</div>
              <div class="chat-message sent">Halo, saya ingin bertanya tentang ketersediaan parkir mobil. Apakah sudah
                termasuk dalam biaya sewa?</div>
              <div class="chat-message system">Admin telah membaca pesan Anda.</div>
            </div>
            <form id="profileChatForm" class="chat-input-group" aria-label="Formulir chat profil">
              <input type="text" id="profileChatInput" placeholder="Ketik pesan Anda di sini..."
                aria-label="Input pesan chat profil">
              <button type="submit" class="btn btn-primary" aria-label="Kirim pesan chat profil">
                <span class="material-icons">send</span><span class="sr-only">Kirim</span>
              </button>
            </form>
          </div>
        </div>

        <!-- Kolom Riwayat & Notifikasi -->
        <div class="lg:col-span-1">
          <div class="card p-lg mb-xl">
            <h2 class="font-semibold mb-md" id="booking-history-title">Riwayat Pemesanan</h2>
            <div id="bookingHistoryContainer" aria-labelledby="booking-history-title">
              <!-- Riwayat akan dimuat JavaScript -->
              <p class="text-sm text-muted">Memuat riwayat pemesanan...</p>
            </div>
            <button class="btn btn-link btn-sm mt-md" id="loadMoreBookingsBtn">Lihat Semua Riwayat</button>
          </div>

          <div class="card p-lg">
            <h2 class="font-semibold mb-md" id="notifications-title">Notifikasi Terbaru</h2>
            <div id="notificationsContainer" aria-labelledby="notifications-title">
              <div class="notification-item">
                <p class="font-medium">Pembayaran Berhasil!</p>
                <p class="text-sm">Pembayaran untuk "Apartemen Senayan View" telah dikonfirmasi.</p>
                <p class="text-xs text-muted mt-xs">2 jam lalu</p>
              </div>
              <div class="notification-item">
                <p class="font-medium">Pengingat Check-in</p>
                <p class="text-sm">Check-in Anda untuk "Studio Harmoni Pusat Kota" adalah besok.</p>
                <p class="text-xs text-muted mt-xs">1 hari lalu</p>
              </div>
              <p id="noNotificationsMessage" class="text-sm text-muted hidden">Tidak ada notifikasi baru.</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Halaman Dukungan Pelanggan -->
    <section id="support" class="page hidden" aria-labelledby="support-title">
      <h1 id="support-title" class="font-bold mb-lg text-center">Pusat Bantuan Rentelindo</h1>
      <p class="text-lg text-muted mb-xl text-center">Kami siap membantu Anda 24/7. Pilih metode dukungan yang paling
        nyaman.</p>
      <div class="grid grid-cols-autofit-300 gap-lg">
        <div class="card p-lg text-center">
          <span class="material-icons text-primary mb-md" style="font-size: 3rem;" aria-hidden="true">chat</span>
          <h3 class="font-semibold">Live Chat</h3>
          <p class="text-muted mb-md">Dapatkan bantuan instan dari tim dukungan kami.</p>
          <button class="btn btn-primary mt-auto" onclick="app.ui.openGlobalChat()">
            <!-- mt-auto untuk tombol di bawah -->
            <span class="material-icons">question_answer</span>Mulai Chat Sekarang
          </button>
        </div>
        <div class="card p-lg text-center">
          <span class="material-icons text-primary mb-md" style="font-size: 3rem;" aria-hidden="true">email</span>
          <h3 class="font-semibold">Kirim Email</h3>
          <p class="text-muted mb-md">Hubungi kami melalui email untuk pertanyaan lebih detail.</p>
          <a href="mailto:dukungan@rentelindo.com" class="btn btn-primary mt-auto">
            <span class="material-icons">send</span>dukungan@rentelindo.com
          </a>
        </div>
        <div class="card p-lg text-center">
          <span class="material-icons text-primary mb-md" style="font-size: 3rem;" aria-hidden="true">phone</span>
          <h3 class="font-semibold">Hubungi Kami</h3>
          <p class="text-muted mb-md">Bicaralah langsung dengan agen kami untuk solusi cepat.</p>
          <a href="tel:+6280012345678" class="btn btn-primary mt-auto">
            <span class="material-icons">call</span>+62 800 1234 5678
          </a>
        </div>
      </div>

      <div class="mt-xl card p-lg">
        <h2 class="font-semibold mb-lg text-center">Pertanyaan Umum (FAQ)</h2>
        <details class="card-details-extra mb-sm">
          <summary>Bagaimana cara melakukan pemesanan?</summary>
          <p>Cari apartemen yang Anda inginkan menggunakan filter di halaman Pencarian. Pilih tanggal yang tersedia pada
            kalender, lalu klik tombol "Lihat Detail". Pada halaman detail, Anda dapat mengisi form pemesanan dan
            memilih metode pembayaran. Ikuti langkah-langkah hingga selesai.</p>
        </details>
        <details class="card-details-extra mb-sm">
          <summary>Apakah pembayaran aman?</summary>
          <p>Ya, semua transaksi pembayaran di Rentelindo dijamin aman. Kami menggunakan enkripsi terkini untuk
            melindungi data Anda. Untuk penyewaan, kami juga menerapkan sistem escrow dimana dana Anda akan kami tahan
            dan baru diteruskan ke pemilik setelah Anda berhasil check-in.</p>
        </details>
        <details class="card-details-extra">
          <summary>Bagaimana jika saya ingin membatalkan pesanan?</summary>
          <p>Kebijakan pembatalan berbeda untuk setiap properti dan biasanya tercantum pada halaman detail apartemen.
            Silakan periksa syarat dan ketentuan pembatalan sebelum melakukan pemesanan. Jika Anda memerlukan bantuan
            lebih lanjut terkait pembatalan, hubungi tim dukungan kami.</p>
        </details>
      </div>
    </section>
  </main>

  <!-- Tombol Chat Global Mengambang -->
  <button class="btn btn-primary global-chat-btn" id="globalChatToggleBtn" aria-label="Buka chat dukungan"
    aria-haspopup="true" aria-expanded="false">
    <span class="material-icons">chat</span>
  </button>

  <!-- Widget Chatbox Global -->
  <div class="chatbox-widget" id="globalChatbox" role="dialog" aria-modal="true" aria-labelledby="chatboxTitle" hidden>
    <div class="chatbox-header">
      <span id="chatboxTitle">Dukungan Pelanggan Rentelindo</span>
      <button class="close-chat-btn" id="closeChatboxBtn" aria-label="Tutup chat">
        <span class="material-icons">close</span>
      </button>
    </div>
    <div class="chatbox-body" id="globalChatBody" aria-live="polite">
      <div class="chat-message system">Selamat datang di Rentelindo! Ada yang bisa kami bantu hari ini?</div>
      <!-- Pesan chat akan ditambahkan di sini oleh JavaScript -->
    </div>
    <form class="chatbox-input-area" id="globalChatForm" aria-label="Formulir chat dukungan">
      <input type="text" id="globalChatInput" placeholder="Ketik pertanyaan Anda..."
        aria-label="Input pesan chat dukungan">
      <button type="submit" class="btn btn-primary" aria-label="Kirim pesan chat dukungan">
        <span class="material-icons">send</span><span class="sr-only">Kirim</span>
      </button>
    </form>
  </div>

  <!-- Modal Universal -->
  <div class="modal-backdrop" id="universalModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" hidden>
    <div class="modal-content" role="document">
      <div class="modal-header">
        <h2 id="modalTitle" class="modal-title font-semibold text-lg">Judul Modal</h2>
        <button class="modal-close-btn" aria-label="Tutup modal">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Konten modal akan dimuat oleh JavaScript -->
      </div>
    </div>
  </div>


  <!-- Footer Aplikasi -->
  <footer class="app-footer">
    <div class="container">
      <p>&copy; <span id="currentYear">2024</span> Rentelindo. Semua hak cipta dilindungi undang-undang.</p>
      <p>
        <a href="#privacy" data-page="privacy">Kebijakan Privasi</a> | <!-- Asumsi ada halaman privacy -->
        <a href="#terms" data-page="terms">Syarat & Ketentuan</a> <!-- Asumsi ada halaman terms -->
      </p>
      <p class="mt-md">Dibuat dengan <span class="material-icons" aria-label="cinta">favorite</span> untuk kemudahan
        Anda.</p>
    </div>
  </footer>

  <script>
    // MAIN APP SCRIPT (RENTELINDO NATIVE SPA)
    // Struktur aplikasi mengikuti paradigma modularitas sederhana
    // tanpa menggunakan sistem modul ES6 eksplisit untuk menjaga kesederhanaan monolith.

    const app = {
      // STATE: Menyimpan kondisi aplikasi saat ini
      state: {
        currentPage: 'home',
        apartments: [], // Akan diisi dengan data mock
        selectedApartmentId: null,
        searchFilters: {
          location: '',
          radius: 5, // km, simulasi
          checkin: null, // YYYY-MM-DD
          checkout: null, // YYYY-MM-DD
          maxPrice: 15000000, // Dalam Rupiah absolut
          amenities: [],
          type: ''
        },
        bookingHistory: [], // Akan diisi dari localStorage atau mock
        // State kalender untuk halaman pencarian
        searchCalendar: {
          currentMonth: new Date().getMonth(),
          currentYear: new Date().getFullYear(),
        },
        // State kalender untuk halaman detail (booking form)
        bookingCalendar: {
          currentMonth: new Date().getMonth(),
          currentYear: new Date().getFullYear(),
          bookedDatesForCurrentApartment: [], // Diisi saat detail apartemen dimuat
        },
        globalChatOpen: false,
        isMobileNavOpen: false,
        isLoading: { // State untuk indikator loading
          featuredProperties: false,
          searchResults: false,
          apartmentDetail: false,
          bookingHistory: false
        }
      },

      // CONFIG: Pengaturan aplikasi
      config: {
        currency: 'Rp',
        // priceMultiplier: 1000000, // Tidak digunakan lagi, harga disimpan absolut
        featuredPropertiesCount: 3,
        searchResultsPerPage: 9, // Belum diimplementasikan paginasi
        defaultMapMessage: 'Simulasi Peta Interaktif - Klik untuk interaksi (fitur mendatang)',
        minBookingDurationDays: 1, // Minimal durasi sewa
        localStorageKeys: {
          bookingHistory: 'rentelindoBookingHistory'
        }
      },

      // MOCK DATA: Data simulasi untuk aplikasi
      mockData: {
        apartments: [
          {
            id: 1,
            title: 'Penthouse Mewah Sudirman View',
            slug: 'penthouse-mewah-sudirman-view',
            price: 25000000, // Harga per bulan dalam Rupiah
            location: 'Jakarta Pusat, Sudirman',
            coordinates: { lat: -6.2088, lng: 106.8456 },
            type: 'penthouse',
            bedrooms: 3,
            bathrooms: 3,
            sqft: 200,
            amenities: ['pool', 'gym', 'wifi', 'parking', 'ac', 'kitchen', 'pet-friendly'],
            images: [
              'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8YXBhcnRtZW50fGVufDB8fDB8fHww&auto=format&fit=crop&w=800&q=60',
              'https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8YXBhcnRtZW50fGVufDB8fDB8fHww&auto=format&fit=crop&w=600&q=60',
              'https://images.unsplash.com/photo-1600585154340-be6161a56a0c?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8N3x8YXBhcnRtZW50fGVufDB8fDB8fHww&auto=format&fit=crop&w=600&q=60',
              'https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTB8fGFwYXJ0bWVudHxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=600&q=60',
              'https://images.unsplash.com/photo-1493809842364-78817add7ffb?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTZ8fGFwYXJ0bWVudHxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=600&q=60'
            ],
            description: 'Nikmati kemewahan tinggal di jantung kota Jakarta. Penthouse eksklusif dengan pemandangan kota yang menakjubkan, fasilitas lengkap, dan desain interior modern. Keamanan 24 jam dan akses mudah ke pusat bisnis dan hiburan.',
            host: { name: 'Bapak Propertio', verified: true },
            reviews: [
              { user: 'Rina M.', rating: 5, comment: 'Pemandangan kota dari balkon sangat luar biasa! Fasilitas gym dan kolam renangnya juga top.', date: '2024-07-15' },
              { user: 'David K.', rating: 4, comment: 'Lokasi strategis, interior mewah. Sedikit bising karena di pusat kota, tapi terbayar dengan kenyamanan.', date: '2024-06-20' }
            ],
            bookedDates: ['2024-08-10', '2024-08-11', '2024-08-12', '2024-09-01', '2024-09-02'] // Format YYYY-MM-DD
          },
          {
            id: 2,
            title: 'Studio Modern Kemang Village',
            slug: 'studio-modern-kemang-village',
            price: 12000000,
            location: 'Jakarta Selatan, Kemang',
            coordinates: { lat: -6.2607, lng: 106.8101 },
            type: 'studio',
            bedrooms: 1, // Studio dihitung 1 kamar
            bathrooms: 1,
            sqft: 50,
            amenities: ['wifi', 'ac', 'kitchen', 'laundry'],
            images: [
              'https://images.unsplash.com/photo-1512917774080-9991f1c4c750?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fGFwYXJ0bWVudHxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=800&q=60',
              'https://images.unsplash.com/photo-1560185007-c5ca99790167?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTh8fGFwYXJ0bWVudCUyMGludGVyaW9yfGVufDB8fDB8fHww&auto=format&fit=crop&w=600&q=60',
              'https://images.unsplash.com/photo-1616046229478-9901c5536a45?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NTF8fGFwYXJ0bWVudCUyMGludGVyaW9yfGVufDB8fDB8fHww&auto=format&fit=crop&w=600&q=60'
            ],
            description: 'Studio apartemen yang chic dan modern di area Kemang yang trendi. Sempurna untuk profesional muda atau pasangan. Dilengkapi dengan dapur mini dan akses mudah ke kafe, restoran, dan pusat perbelanjaan.',
            host: { name: 'Ibu Gaya Hidup', verified: true },
            reviews: [
              { user: 'Sarah L.', rating: 4, comment: 'Cocok untuk solo traveler atau pasangan. Bersih dan nyaman.', date: '2024-07-01' }
            ],
            bookedDates: ['2024-08-05', '2024-08-06', '2024-12-24', '2024-12-25']
          },
          {
            id: 3,
            title: 'Apartemen Keluarga Nyaman BSD City',
            slug: 'apartemen-keluarga-nyaman-bsd-city',
            price: 18000000,
            location: 'Tangerang Selatan, BSD City',
            coordinates: { lat: -6.3019, lng: 106.6533 },
            type: '2br',
            bedrooms: 2,
            bathrooms: 2,
            sqft: 120,
            amenities: ['pool', 'parking', 'ac', 'kitchen', 'laundry', 'playground'],
            images: [
              'https://images.unsplash.com/photo-1580037354587-5988391711c2?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8ZmFtaWx5JTIwYXBhcnRtZW50fGVufDB8fDB8fHww&auto=format&fit=crop&w=800&q=60',
              'https://images.unsplash.com/photo-1576547971028-a3f4e3e07122?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Nnx8a2lkcyUyMGJlZHJvb218ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=600&q=60',
              'https://images.unsplash.com/photo-1575003077002-c3442b51e2a3?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTJ8fGFwYXJ0bWVudCUyMHBvb2x8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=600&q=60'
            ],
            description: 'Apartemen luas dan nyaman untuk keluarga Anda di BSD City. Dekat dengan sekolah internasional, rumah sakit, dan pusat perbelanjaan. Fasilitas ramah anak tersedia.',
            host: { name: 'Keluarga Harmoni', verified: false },
            reviews: [
              { user: 'Andi F.', rating: 5, comment: 'Sangat puas! Anak-anak suka kolam renang dan playgroundnya.', date: '2024-07-10' }
            ],
            bookedDates: []
          },
          {
            id: 4,
            title: 'Loft Artistik Cikini Menteng',
            slug: 'loft-artistik-cikini-menteng',
            price: 15500000,
            location: 'Jakarta Pusat, Cikini',
            coordinates: { lat: -6.1927, lng: 106.8402 },
            type: 'loft',
            bedrooms: 1,
            bathrooms: 1,
            sqft: 90,
            amenities: ['wifi', 'ac', 'kitchen', 'art-studio-space'],
            images: [
              'https://images.unsplash.com/photo-1505691938895-1758d7feb511?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MzN8fGFwYXJ0bWVudCUyMGludGVyaW9yfGVufDB8fDB8fHww&auto=format&fit=crop&w=800&q=60',
              'https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MzR8fGFwYXJ0bWVudCUyMGludGVyaW9yfGVufDB8fDB8fHww&auto=format&fit=crop&w=600&q=60',
              'https://images.unsplash.com/photo-1598928506311-c55ded91a20c?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NzF8fGFwYXJ0bWVudCUyMGludGVyaW9yfGVufDB8fDB8fHww&auto=format&fit=crop&w=600&q=60'
            ],
            description: 'Loft unik dengan sentuhan artistik di area Cikini yang bersejarah. Ruang terbuka luas dengan langit-langit tinggi, cocok untuk para seniman atau mereka yang mencari inspirasi. Dekat dengan galeri seni dan pusat budaya.',
            host: { name: 'Sang Seniman', verified: true },
            reviews: [
              { user: 'Elisa G.', rating: 5, comment: 'Tempat ini luar biasa inspiratif! Suka sekali dengan desainnya.', date: '2024-06-28' }
            ],
            bookedDates: ['2024-08-20', '2024-08-21', '2024-08-22']
          },
          {
            id: 5,
            title: 'Apartemen Tepi Pantai Ancol Bay',
            slug: 'apartemen-tepi-pantai-ancol-bay',
            price: 20000000,
            location: 'Jakarta Utara, Ancol',
            coordinates: { lat: -6.1220, lng: 106.8421 },
            type: '3br+',
            bedrooms: 3,
            bathrooms: 2,
            sqft: 150,
            amenities: ['pool', 'wifi', 'parking', 'ac', 'kitchen', 'beach-access'],
            images: [
              'https://images.unsplash.com/photo-1613553507747-209418d1c198?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8YmVhY2glMjBhcGFydG1lbnR8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=800&q=60',
              'https://images.unsplash.com/photo-1567016432779-1f1185091776?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8N3x8YmVhY2glMjBhcGFydG1lbnR8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=600&q=60',
              'https://images.unsplash.com/photo-1590470603830-7c7951095a48?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTR8fGJlYWNoJTIwYXBhcnRtZW50fGVufDB8fDB8fHww&auto=format&fit=crop&w=600&q=60'
            ],
            description: 'Rasakan sensasi liburan setiap hari di apartemen tepi pantai Ancol. Pemandangan laut yang menenangkan, akses langsung ke pantai, dan fasilitas rekreasi keluarga. Ideal untuk liburan atau tinggal jangka panjang.',
            host: { name: 'Kapten Bahari', verified: true },
            reviews: [
              { user: 'Keluarga Siregar', rating: 4, comment: 'Anak-anak senang sekali bisa main di pantai setiap hari. Apartemennya bersih dan luas.', date: '2024-07-05' }
            ],
            bookedDates: ['2024-09-10', '2024-09-11', '2024-09-12', '2024-09-13', '2024-09-14']
          },
          {
            id: 6,
            title: 'Apartemen Minimalis Kuningan',
            slug: 'apartemen-minimalis-kuningan',
            price: 9500000,
            location: 'Jakarta Selatan, Kuningan',
            coordinates: { lat: -6.2250, lng: 106.8275 },
            type: '1br',
            bedrooms: 1,
            bathrooms: 1,
            sqft: 60,
            amenities: ['gym', 'wifi', 'ac', 'kitchen'],
            images: [
              'https://images.unsplash.com/photo-1526925539332-aa3b66e35444?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Nnx8bWluaW1hbCUyMGFwYXJ0bWVudHxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=800&q=60',
              'https://images.unsplash.com/photo-1595526114035-0d45ed16cfbf?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTJ8fG1pbmltYWwlMjBhcGFydG1lbnR8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=600&q=60',
            ],
            description: 'Apartemen 1 kamar tidur dengan desain minimalis modern di area strategis Kuningan. Dekat dengan perkantoran dan pusat perbelanjaan. Cocok untuk profesional yang dinamis.',
            host: { name: 'Desainer Interior', verified: true },
            reviews: [],
            bookedDates: ['2024-10-01', '2024-10-02', '2024-10-03']
          },
        ],
        bookingHistory: [ // Harga disimpan dalam Rupiah absolut
          { id: 'BK001', apartmentId: 1, apartmentTitle: 'Penthouse Mewah Sudirman View', checkin: '2024-05-01', checkout: '2024-05-07', totalCost: 5833333 * 1.15, status: 'Selesai' }, // (25jt/30hr * 7hr) * (1 + 0.05 service + 0.1 insurance)
          { id: 'BK002', apartmentId: 2, apartmentTitle: 'Studio Modern Kemang Village', checkin: '2024-06-10', checkout: '2024-06-15', totalCost: 2000000 * 1.05, status: 'Selesai' }, // (12jt/30hr * 5hr) * (1 + 0.05 service)
        ]
      },

      // UTILITIES: Fungsi bantuan umum
      utils: {
        formatPrice: (price) => {
          if (typeof price !== 'number') return `${app.config.currency} -`;
          return `${app.config.currency} ${price.toLocaleString('id-ID')}`;
        },
        formatDate: (dateString, options = { day: 'numeric', month: 'long', year: 'numeric' }) => {
          if (!dateString) return 'N/A';
          try {
            const date = new Date(dateString);
            // Periksa apakah tanggal valid setelah parsing
            if (isNaN(date.getTime())) {
              // Jika dateString tidak bisa diparsing sebagai tanggal yang valid, coba tambahkan waktu
              const dateWithTime = new Date(dateString + "T00:00:00");
              if (isNaN(dateWithTime.getTime())) return 'Tanggal Tidak Valid';
              return dateWithTime.toLocaleDateString('id-ID', options);
            }
            return date.toLocaleDateString('id-ID', options);
          } catch (error) {
            console.warn("Error formatting date:", dateString, error);
            return 'Tanggal Error';
          }
        },
        getDaysDifference: (dateStr1, dateStr2) => {
          if (!dateStr1 || !dateStr2) return 0;
          // Pastikan format tanggal adalah YYYY-MM-DD untuk konsistensi parsing
          const d1 = new Date(dateStr1.split('T')[0] + "T00:00:00Z"); // Tambah Z untuk UTC
          const d2 = new Date(dateStr2.split('T')[0] + "T00:00:00Z");

          if (isNaN(d1.getTime()) || isNaN(d2.getTime())) return 0; // Invalid date

          const diffTime = Math.abs(d2.getTime() - d1.getTime());
          return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        },
        debounce: (func, delay) => {
          let timeout;
          return function (...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
          };
        },
        throttle: (func, limit) => {
          let inThrottle;
          return function (...args) {
            const context = this;
            if (!inThrottle) {
              func.apply(context, args);
              inThrottle = true;
              setTimeout(() => inThrottle = false, limit);
            }
          };
        },
        generateId: (prefix = '') => {
          return prefix + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        },
        scrollToTop: () => {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        },
        getTodayDateString: () => {
          const today = new Date();
          return today.toISOString().split('T')[0]; // YYYY-MM-DD
        },
        getTomorrowDateString: () => {
          const tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          return tomorrow.toISOString().split('T')[0];
        },
        // Fungsi untuk escape HTML untuk mencegah XSS sederhana jika menampilkan input pengguna
        escapeHTML: (str) => {
          if (typeof str !== 'string') return str;
          return str.replace(/[&<>"']/g, function (match) {
            return {
              '&': '&amp;',
              '<': '&lt;',
              '>': '&gt;',
              '"': '&quot;',
              "'": '&#39;'
            }[match];
          });
        }
      },

      // UI: Mengelola elemen dan interaksi antarmuka pengguna
      ui: {
        elements: {
          // Navigasi
          navLinks: null,
          navToggleBtn: null,
          navLinksMenu: null,
          // Pages
          pages: null,
          // Beranda
          quickSearchForm: null,
          quickSearchCheckin: null,
          quickSearchCheckout: null,
          featuredPropertiesContainer: null,
          loadingFeaturedMessage: null,
          // Pencarian
          detailedSearchForm: null,
          searchLocationInput: null,
          searchMapCanvas: null,
          searchRadiusSlider: null,
          radiusValueDisplay: null,
          searchPageCalendarContainer: null,
          prevMonthBtnCalendarSearch: null,
          nextMonthBtnCalendarSearch: null,
          currentMonthYearCalendarSearch: null,
          searchCheckinDateInput: null,
          searchCheckoutDateInput: null,
          searchPriceSlider: null,
          priceValueDisplay: null,
          searchAmenitiesCheckboxes: null,
          searchApartmentTypeSelect: null,
          searchResultsContainer: null,
          searchResultsCountDisplay: null,
          noResultsMessage: null,
          loadingSearchResultsMessage: null,
          resetSearchFiltersBtn: null,
          // Detail Apartemen
          apartmentDetailContainer: null,
          // Profil
          profileName: null,
          profileEmail: null,
          profilePhone: null,
          profileLoyaltyPoints: null,
          profileMemberSince: null,
          profileChatWindow: null,
          profileChatForm: null,
          profileChatInput: null,
          bookingHistoryContainer: null,
          notificationsContainer: null,
          noNotificationsMessage: null,
          // Chat Global
          globalChatToggleBtn: null,
          globalChatbox: null,
          closeChatboxBtn: null,
          globalChatBody: null,
          globalChatForm: null,
          globalChatInput: null,
          // Footer
          currentYearDisplay: null,
          // Modal
          universalModal: null,
          modalTitle: null,
          modalBody: null,
          modalCloseBtns: null,
        },

        cacheElements: () => {
          const els = app.ui.elements;
          els.navLinks = document.querySelectorAll('.nav-link');
          els.navToggleBtn = document.getElementById('navToggleBtn');
          els.navLinksMenu = document.getElementById('navLinksMenu');
          els.pages = document.querySelectorAll('.page');

          els.quickSearchForm = document.getElementById('quickSearchForm');
          els.quickSearchCheckin = document.getElementById('quick-checkin');
          els.quickSearchCheckout = document.getElementById('quick-checkout');
          els.featuredPropertiesContainer = document.getElementById('featuredProperties');
          els.loadingFeaturedMessage = document.getElementById('loadingFeaturedMessage');


          els.detailedSearchForm = document.getElementById('detailedSearchForm');
          els.searchLocationInput = document.getElementById('search-location');
          els.searchMapCanvas = document.getElementById('searchMapCanvas');
          els.searchRadiusSlider = document.getElementById('search-radius');
          els.radiusValueDisplay = document.getElementById('radiusValueDisplay');
          els.searchPageCalendarContainer = document.getElementById('searchPageCalendar');
          els.prevMonthBtnCalendarSearch = document.getElementById('prevMonthBtnCalendarSearch');
          els.nextMonthBtnCalendarSearch = document.getElementById('nextMonthBtnCalendarSearch');
          els.currentMonthYearCalendarSearch = document.getElementById('currentMonthYearCalendarSearch');
          els.searchCheckinDateInput = document.getElementById('search-checkin-date');
          els.searchCheckoutDateInput = document.getElementById('search-checkout-date');
          els.searchPriceSlider = document.getElementById('search-price');
          els.priceValueDisplay = document.getElementById('priceValueDisplay');
          els.searchAmenitiesCheckboxes = document.querySelectorAll('#detailedSearchForm input[name="amenities"]');
          els.searchApartmentTypeSelect = document.getElementById('search-apartment-type');
          els.searchResultsContainer = document.getElementById('searchResultsContainer');
          els.searchResultsCountDisplay = document.getElementById('searchResultsCount');
          els.noResultsMessage = document.getElementById('noResultsMessage');
          els.loadingSearchResultsMessage = document.getElementById('loadingSearchResultsMessage');
          els.resetSearchFiltersBtn = document.getElementById('resetSearchFiltersBtn');

          els.apartmentDetailContainer = document.getElementById('apartmentDetailContent');

          els.profileName = document.getElementById('profileName');
          els.profileEmail = document.getElementById('profileEmail');
          els.profilePhone = document.getElementById('profilePhone');
          els.profileLoyaltyPoints = document.getElementById('profileLoyaltyPoints');
          els.profileMemberSince = document.getElementById('profileMemberSince');
          els.profileChatWindow = document.getElementById('profileChatWindow');
          els.profileChatForm = document.getElementById('profileChatForm');
          els.profileChatInput = document.getElementById('profileChatInput');
          els.bookingHistoryContainer = document.getElementById('bookingHistoryContainer');
          els.notificationsContainer = document.getElementById('notificationsContainer');
          els.noNotificationsMessage = document.getElementById('noNotificationsMessage');


          els.globalChatToggleBtn = document.getElementById('globalChatToggleBtn');
          els.globalChatbox = document.getElementById('globalChatbox');
          els.closeChatboxBtn = document.getElementById('closeChatboxBtn');
          els.globalChatBody = document.getElementById('globalChatBody');
          els.globalChatForm = document.getElementById('globalChatForm');
          els.globalChatInput = document.getElementById('globalChatInput');

          els.currentYearDisplay = document.getElementById('currentYear');

          els.universalModal = document.getElementById('universalModal');
          els.modalTitle = document.getElementById('modalTitle');
          els.modalBody = document.getElementById('modalBody');
          // Event listener untuk backdrop modal akan ditangani secara terpisah karena bisa berupa backdrop itu sendiri
          els.modalCloseBtns = document.querySelectorAll('.modal-close-btn');
        },

        showPage: (pageId) => {
          if (!pageId || !document.getElementById(pageId)) { // Jika pageId tidak ada atau elemen tidak ditemukan
            console.warn(`Page with id "${pageId}" not found, redirecting to home.`);
            pageId = 'home'; // Default ke home
            window.location.hash = 'home'; // Update hash juga
          }

          app.state.currentPage = pageId;
          app.ui.elements.pages.forEach(page => {
            const isCurrentPage = page.id === pageId;
            page.classList.toggle('hidden', !isCurrentPage);
            page.classList.toggle('fade-in', isCurrentPage);
            // Atur aria-hidden untuk aksesibilitas
            page.setAttribute('aria-hidden', !isCurrentPage);
          });
          app.ui.updateNavLinks(pageId);
          app.utils.scrollToTop();
          app.services.loadPageSpecificData(pageId);

          if (app.state.isMobileNavOpen) {
            app.handlers.handleNavToggle(); // Tutup menu mobile
          }
        },

        updateNavLinks: (activePageId) => {
          app.ui.elements.navLinks.forEach(link => {
            link.classList.toggle('active', link.dataset.page === activePageId);
            link.setAttribute('aria-current', link.dataset.page === activePageId ? 'page' : 'false');
          });
        },

        renderApartmentCard: (apartment, isFeatured = false) => {
          const priceDisplay = app.utils.formatPrice(apartment.price);
          const iconMap = { pool: 'pool', gym: 'fitness_center', wifi: 'wifi', parking: 'local_parking', ac: 'ac_unit', kitchen: 'kitchen', laundry: 'local_laundry_service', 'pet-friendly': 'pets', playground: 'child_friendly', 'beach-access': 'beach_access', 'art-studio-space': 'palette' };

          const amenitiesIcons = apartment.amenities.slice(0, 3).map(amenity =>
            `<span><i class="material-icons" title="${amenity.replace('-', ' ')}">${iconMap[amenity] || 'apartment'}</i></span>`
          ).join('');

          const cardId = `apt-card-${apartment.id}`;

          const cardHtml = `
            <article class="card" data-id="${apartment.id}" tabindex="0" aria-labelledby="${cardId}-title">
              <img src="${apartment.images[0]}" alt="Tampilan ${app.utils.escapeHTML(apartment.title)}" class="card-img" loading="lazy">
              <div class="card-body">
                <h3 class="card-title" id="${cardId}-title">
                  ${app.utils.escapeHTML(apartment.title)}
                  ${apartment.host.verified ? '<span class="material-icons text-success" title="Pemilik Terverifikasi">verified_user</span>' : ''}
                </h3>
                <div class="card-details">
                  <span class="card-price">${priceDisplay}/bulan</span>
                  <span class="card-location"><i class="material-icons">location_on</i> ${app.utils.escapeHTML(apartment.location)}</span>
                </div>
                <div class="card-features mb-sm">
                  <span><i class="material-icons">hotel</i> ${apartment.bedrooms} KT</span>
                  <span><i class="material-icons">bathtub</i> ${apartment.bathrooms} KM</span>
                  <span><i class="material-icons">square_foot</i> ${apartment.sqft} m²</span>
                </div>
                 <div class="card-features">
                  ${amenitiesIcons}
                  ${apartment.amenities.length > 3 ? '<span>...</span>' : ''}
                </div>
                <p class="card-text text-muted mt-sm">${app.utils.escapeHTML(apartment.description.substring(0, 80))}...</p>
                <div class="card-actions">
                  <a href="#apartment/${apartment.slug || apartment.id}" class="btn btn-primary btn-sm btn-full nav-link" data-page="apartment" data-id="${apartment.id}">
                    <span class="material-icons">visibility</span>Lihat Detail
                  </a>
                </div>
              </div>
              ${isFeatured ? `
                <details class="card-details-extra">
                  <summary>Fasilitas Lengkap</summary>
                  <div class="p-md">
                    <ul class="list-disc pl-md">
                      ${apartment.amenities.map(a => `<li>${app.utils.escapeHTML(a.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()))}</li>`).join('')}
                    </ul>
                  </div>
                </details>
              ` : ''}
            </article>
          `;
          return cardHtml;
        },

        renderFeaturedProperties: () => {
          const container = app.ui.elements.featuredPropertiesContainer;
          const loadingMsg = app.ui.elements.loadingFeaturedMessage;
          if (!container || !loadingMsg) return;

          app.state.isLoading.featuredProperties = true;
          loadingMsg.classList.remove('hidden');
          container.innerHTML = ''; // Kosongkan dulu

          // Simulasi delay API
          setTimeout(() => {
            const featured = app.state.apartments.slice(0, app.config.featuredPropertiesCount);
            if (featured.length > 0) {
              container.innerHTML = featured.map(apt => app.ui.renderApartmentCard(apt, true)).join('');
              loadingMsg.classList.add('hidden');
            } else {
              loadingMsg.textContent = "Tidak ada properti unggulan saat ini.";
            }
            app.state.isLoading.featuredProperties = false;
          }, 500);
        },

        renderSearchResults: (results) => {
          const container = app.ui.elements.searchResultsContainer;
          const countDisplay = app.ui.elements.searchResultsCountDisplay;
          const noResultsMsg = app.ui.elements.noResultsMessage;
          const loadingMsg = app.ui.elements.loadingSearchResultsMessage;


          if (!container || !countDisplay || !noResultsMsg || !loadingMsg) return;

          loadingMsg.classList.add('hidden'); // Sembunyikan pesan loading
          countDisplay.textContent = results.length;

          if (results.length === 0) {
            container.innerHTML = '';
            noResultsMsg.classList.remove('hidden');
          } else {
            container.innerHTML = results.map(apt => app.ui.renderApartmentCard(apt)).join('');
            noResultsMsg.classList.add('hidden');
          }
        },

        showLoading: (type, show = true) => {
          app.state.isLoading[type] = show;
          let messageElement;
          let container;

          switch (type) {
            case 'featuredProperties':
              messageElement = app.ui.elements.loadingFeaturedMessage;
              container = app.ui.elements.featuredPropertiesContainer;
              break;
            case 'searchResults':
              messageElement = app.ui.elements.loadingSearchResultsMessage;
              container = app.ui.elements.searchResultsContainer;
              app.ui.elements.noResultsMessage.classList.add('hidden'); // Sembunyikan no results juga
              break;
            case 'apartmentDetail':
              container = app.ui.elements.apartmentDetailContainer;
              if (show && container) {
                container.innerHTML = '<p class="text-center text-lg text-muted p-xl">Memuat detail apartemen...</p>';
              }
              return; // Penanganan khusus untuk detail
            case 'bookingHistory':
              container = app.ui.elements.bookingHistoryContainer;
              if (show && container) {
                container.innerHTML = '<p class="text-sm text-muted">Memuat riwayat pemesanan...</p>';
              }
              return; // Penanganan khusus

            // Tambahkan case lain jika perlu
          }

          if (messageElement) {
            messageElement.classList.toggle('hidden', !show);
          }
          if (container && show) { // Kosongkan kontainer saat loading dimulai
            container.innerHTML = '';
          }
        },


        renderApartmentDetail: (apartment) => {
          const container = app.ui.elements.apartmentDetailContainer;
          if (!container) return;

          app.ui.showLoading('apartmentDetail', false); // Sembunyikan loading

          const priceDisplay = app.utils.formatPrice(apartment.price);
          const iconMap = { pool: 'pool', gym: 'fitness_center', wifi: 'wifi', parking: 'local_parking', ac: 'ac_unit', kitchen: 'kitchen', laundry: 'local_laundry_service', 'pet-friendly': 'pets', playground: 'child_friendly', 'beach-access': 'beach_access', 'art-studio-space': 'palette' };
          const amenitiesHtml = apartment.amenities.map(amenity =>
            `<li class="flex items-center gap-xs"><span class="material-icons text-primary">${iconMap[amenity] || 'check_circle'}</span> ${app.utils.escapeHTML(amenity.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()))}</li>`
          ).join('');

          const reviewsHtml = apartment.reviews.length > 0 ? apartment.reviews.map((review, index) => `
                <div class="review-item">
                    <div class="review-header">
                        <span class="review-user">${app.utils.escapeHTML(review.user)}</span>
                        <span class="review-rating" aria-label="Rating ${review.rating} dari 5 bintang">
                            ${Array(5).fill(0).map((_, i) => `<span class="material-icons">${i < review.rating ? 'star' : 'star_border'}</span>`).join('')}
                        </span>
                    </div>
                    <p class="review-comment text-sm mb-xs">${app.utils.escapeHTML(review.comment)}</p>
                    <p class="text-xs text-muted">Pada: ${app.utils.formatDate(review.date)}</p>
                    <button class="btn btn-link btn-sm text-error p-0 mt-xs btn-report-review" data-review-id="${index}" data-apartment-id="${apartment.id}">
                        <span class="material-icons text-sm">flag</span> Laporkan ulasan
                    </button>
                </div>
            `).join('') : '<p class="text-muted">Belum ada ulasan untuk properti ini.</p>';

          const galleryItemsHtml = apartment.images.map((img, index) => `
                <div class="gallery-item" tabindex="0" role="button" aria-label="Lihat gambar ${index + 1} dari ${app.utils.escapeHTML(apartment.title)}" data-img-src="${img}" data-img-alt="Gambar ${index + 1} dari ${app.utils.escapeHTML(apartment.title)}">
                    <img src="${img}" alt="Gambar ${index + 1} dari ${app.utils.escapeHTML(apartment.title)}" loading="lazy">
                    ${index === 0 ? `
                        <div class="virtual-tour-overlay" aria-hidden="true">
                            <span class="material-icons">visibility</span>
                            <span>Lihat Tur Virtual (Simulasi)</span>
                        </div>
                    ` : ''}
                </div>
            `).join('');

          let galleryClass = 'apartment-gallery';
          if (apartment.images.length === 1) galleryClass += ' single-image';
          else if (apartment.images.length === 2) galleryClass += ' two-images';

          const today = app.utils.getTodayDateString();
          const tomorrow = app.utils.getTomorrowDateString();


          container.innerHTML = `
                <h1 class="font-bold text-2xl md:text-3xl mb-sm" id="apartment-title-heading">${app.utils.escapeHTML(apartment.title)}</h1>
                <div class="flex flex-wrap items-center gap-x-md gap-y-xs mb-lg text-muted">
                    <span><i class="material-icons">location_on</i> ${app.utils.escapeHTML(apartment.location)}</span>
                    <span><i class="material-icons">hotel</i> ${apartment.bedrooms} KT</span>
                    <span><i class="material-icons">bathtub</i> ${apartment.bathrooms} KM</span>
                    <span><i class="material-icons">square_foot</i> ${apartment.sqft} m²</span>
                </div>

                <div class="${galleryClass} mb-xl" aria-label="Galeri foto apartemen">
                    ${galleryItemsHtml}
                </div>

                <div class="apartment-details-grid">
                    <div class="apartment-main-content">
                        <h2 class="font-semibold text-xl mb-md">Deskripsi Properti</h2>
                        <p class="text-muted mb-lg">${app.utils.escapeHTML(apartment.description)}</p>

                        <h2 class="font-semibold text-xl mb-md">Fasilitas Unggulan</h2>
                        <ul class="grid grid-cols-1 sm:grid-cols-2 gap-md mb-lg" aria-label="Daftar fasilitas">
                            ${amenitiesHtml}
                        </ul>
                        
                        <h2 class="font-semibold text-xl mb-md">Lokasi Properti (Simulasi)</h2>
                        <div class="map-canvas mb-lg" id="apartmentDetailMapCanvas" aria-label="Peta lokasi properti (simulasi)">
                            ${app.config.defaultMapMessage} - Lokasi: ${app.utils.escapeHTML(apartment.location)}
                        </div>

                        <h2 class="font-semibold text-xl mb-md" id="reviews-heading">Ulasan dari Penyewa</h2>
                        <div id="apartmentReviewsContainer" class="mb-lg" aria-labelledby="reviews-heading">
                            ${reviewsHtml}
                        </div>
                        <div id="reportFormContainer" class="report-form-container hidden" role="form" aria-labelledby="report-form-title">
                            <!-- Form laporan akan di-render di sini jika diperlukan -->
                        </div>

                    </div>
                    <aside class="apartment-booking-sidebar">
                        <form class="booking-form-sticky" id="apartmentBookingForm" aria-labelledby="booking-form-title">
                            <h3 class="font-semibold text-lg mb-md" id="booking-form-title">Pesan Apartemen Ini</h3>
                            <p class="text-2xl font-bold text-primary mb-lg">${priceDisplay}<span class="text-base font-normal text-muted">/bulan</span></p>
                            
                            <div class="form-group">
                                <label for="book-checkin">Tanggal Check-in</label>
                                <input type="date" id="book-checkin" required min="${today}" aria-describedby="booking-date-error">
                            </div>
                            <div class="form-group">
                                <label for="book-checkout">Tanggal Check-out</label>
                                <input type="date" id="book-checkout" required min="${tomorrow}" aria-describedby="booking-date-error">
                            </div>
                             <div id="booking-date-error" class="text-error text-sm mb-sm hidden" role="alert"></div>

                             <div class="form-group">
                                <label>Kalender Ketersediaan</label>
                                <div class="calendar-nav">
                                    <button type="button" id="prevMonthBtnBookingCalendar" aria-label="Bulan sebelumnya (Booking)"><span class="material-icons">chevron_left</span></button>
                                    <span id="currentMonthYearBookingCalendar" class="font-medium" aria-live="polite">Memuat...</span>
                                    <button type="button" id="nextMonthBtnBookingCalendar" aria-label="Bulan berikutnya (Booking)"><span class="material-icons">chevron_right</span></button>
                                </div>
                                <div class="calendar" id="bookingPageCalendar" role="grid" aria-label="Kalender ketersediaan untuk booking">
                                    <p class="text-muted col-span-full text-center">Memuat kalender...</p>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="book-guests">Jumlah Tamu</label>
                                <input type="number" id="book-guests" min="1" value="1" max="${apartment.bedrooms * 2 || 2}" required>
                            </div>
                            <fieldset class="form-group">
                                <legend class="font-medium mb-xs">Metode Pembayaran</legend>
                                <div class="payment-methods" role="radiogroup" aria-label="Pilih metode pembayaran">
                                    <div class="payment-method" data-method="credit-card" tabindex="0" role="radio" aria-checked="false">Kartu Kredit</div>
                                    <div class="payment-method" data-method="bank-transfer" tabindex="0" role="radio" aria-checked="false">Transfer Bank</div>
                                    <div class="payment-method" data-method="e-wallet" tabindex="0" role="radio" aria-checked="false">E-Wallet</div>
                                </div>
                                <input type="hidden" id="selected-payment-method" name="paymentMethod" required> <!-- Required agar form validasi -->
                                 <div id="payment-method-error" class="text-error text-sm mt-xs hidden" role="alert">Pilih metode pembayaran.</div>
                            </fieldset>
                            <div class="form-group">
                                <label class="checkbox-label"><input type="checkbox" id="book-insurance"> Tambah Asuransi Perjalanan (+10%)</label>
                            </div>
                            
                            <div class="cost-breakdown hidden" id="bookingCostBreakdown" aria-live="polite">
                                <h4 class="font-medium mb-sm">Rincian Biaya</h4>
                                <div class="cost-line"><span>Harga Sewa (<span id="booking-duration-days">0</span> hari)</span><span id="base-cost-value">Rp 0</span></div>
                                <div class="cost-line"><span>Biaya Layanan (5%)</span><span id="service-cost-value">Rp 0</span></div>
                                <div class="cost-line hidden" id="insurance-cost-line"><span>Asuransi Perjalanan (10%)</span><span id="insurance-cost-value">Rp 0</span></div>
                                <div class="cost-line total"><span>Total Pembayaran</span><span id="total-cost-value">Rp 0</span></div>
                            </div>
                            
                            <div class="escrow-info">
                                <span class="material-icons" aria-hidden="true">verified_user</span>
                                <p>Pembayaran Anda aman melalui sistem escrow Rentelindo. Dana akan diteruskan ke pemilik setelah Anda check-in.</p>
                            </div>
                            
                            <button type="submit" class="btn btn-primary btn-lg btn-full">
                                <span class="material-icons">event_available</span>Pesan Sekarang
                            </button>
                        </form>
                    </aside>
                </div>
            `;
          app.ui.setupApartmentDetailPageListeners(apartment);
          app.ui.initMap('apartmentDetailMapCanvas', apartment.coordinates, `Peta Lokasi: ${apartment.location}`);
          app.state.bookingCalendar.bookedDatesForCurrentApartment = apartment.bookedDates;
          app.ui.renderCalendarForBooking();
        },

        showReportForm: (buttonElement) => {
          const reviewId = buttonElement.dataset.reviewId;
          const apartmentId = buttonElement.dataset.apartmentId;
          const apartment = app.state.apartments.find(a => a.id == apartmentId);
          if (!apartment || !apartment.reviews || !apartment.reviews[reviewId]) {
            app.ui.openModal('Error', '<p>Data ulasan tidak ditemukan.</p>');
            return;
          }
          const review = apartment.reviews[reviewId];

          const reportFormContainer = document.getElementById('reportFormContainer');
          if (!reportFormContainer) return;

          reportFormContainer.innerHTML = `
                <h3 class="font-semibold text-lg mb-md text-error" id="report-form-title">Laporkan Ulasan oleh ${app.utils.escapeHTML(review.user)}</h3>
                <form id="reviewReportForm" aria-labelledby="report-form-title">
                    <input type="hidden" name="reviewId" value="${reviewId}">
                    <input type="hidden" name="apartmentId" value="${apartmentId}">
                    <div class="form-group">
                        <label for="report-reason">Alasan Pelaporan</label>
                        <textarea id="report-reason" name="reason" placeholder="Jelaskan mengapa ulasan ini tidak pantas atau melanggar ketentuan..." required rows="4"></textarea>
                    </div>
                    <div class="flex gap-sm justify-end">
                        <button type="button" class="btn btn-outline btn-sm" id="cancelReportBtn">
                            Batal
                        </button>
                        <button type="submit" class="btn btn-error btn-sm">
                            <span class="material-icons">send</span> Kirim Laporan
                        </button>
                    </div>
                </form>
            `;
          reportFormContainer.classList.remove('hidden');
          document.getElementById('reviewReportForm').addEventListener('submit', app.handlers.handleReviewReportSubmit);
          document.getElementById('cancelReportBtn').addEventListener('click', app.ui.hideReportForm);
          document.getElementById('report-reason').focus(); // Fokus ke textarea
        },

        hideReportForm: () => {
          const reportFormContainer = document.getElementById('reportFormContainer');
          if (reportFormContainer) {
            reportFormContainer.classList.add('hidden');
            reportFormContainer.innerHTML = '';
          }
        },

        updateBookingCost: (apartment) => {
          const checkinDateStr = document.getElementById('book-checkin').value;
          const checkoutDateStr = document.getElementById('book-checkout').value;
          const insuranceChecked = document.getElementById('book-insurance').checked;
          const costBreakdownEl = document.getElementById('bookingCostBreakdown');
          const dateErrorEl = document.getElementById('booking-date-error');

          if (!costBreakdownEl || !dateErrorEl) return;
          dateErrorEl.classList.add('hidden'); // Sembunyikan error dulu

          if (!checkinDateStr || !checkoutDateStr) {
            costBreakdownEl.classList.add('hidden');
            return;
          }

          const checkinDate = new Date(checkinDateStr + "T00:00:00");
          const checkoutDate = new Date(checkoutDateStr + "T00:00:00");

          if (checkoutDate <= checkinDate) {
            costBreakdownEl.classList.add('hidden');
            dateErrorEl.textContent = 'Tanggal check-out harus setelah tanggal check-in.';
            dateErrorEl.classList.remove('hidden');
            return;
          }

          const durationDays = app.utils.getDaysDifference(checkinDateStr, checkoutDateStr);
          if (durationDays < app.config.minBookingDurationDays) {
            costBreakdownEl.classList.add('hidden');
            dateErrorEl.textContent = `Durasi sewa minimal adalah ${app.config.minBookingDurationDays} hari.`;
            dateErrorEl.classList.remove('hidden');
            return;
          }


          document.getElementById('booking-duration-days').textContent = durationDays;

          // Asumsi harga di 'apartment.price' adalah per BULAN.
          // Kalkulasi harga harian, lalu total biaya dasar.
          const dailyRate = apartment.price / 30;
          const calculatedBaseCost = dailyRate * durationDays;
          const serviceFee = calculatedBaseCost * 0.05; // 5% biaya layanan
          const insuranceCost = insuranceChecked ? calculatedBaseCost * 0.10 : 0; // 10% biaya asuransi
          const totalCost = calculatedBaseCost + serviceFee + insuranceCost;

          document.getElementById('base-cost-value').textContent = app.utils.formatPrice(calculatedBaseCost);
          document.getElementById('service-cost-value').textContent = app.utils.formatPrice(serviceFee);

          const insuranceCostLine = document.getElementById('insurance-cost-line');
          if (insuranceChecked) {
            document.getElementById('insurance-cost-value').textContent = app.utils.formatPrice(insuranceCost);
            insuranceCostLine.classList.remove('hidden');
          } else {
            insuranceCostLine.classList.add('hidden');
          }

          document.getElementById('total-cost-value').textContent = app.utils.formatPrice(totalCost);
          costBreakdownEl.classList.remove('hidden');
        },

        renderCalendar: (container, year, month, bookedDates = [], onDateSelectCallback = null, calendarStateRef, isBookingCalendar = false) => {
          if (!container) return;
          container.innerHTML = '';

          const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
          const dayNames = ["Min", "Sen", "Sel", "Rab", "Kam", "Jum", "Sab"];

          const currentMonthYearDisplayId = isBookingCalendar ? 'currentMonthYearBookingCalendar' : 'currentMonthYearCalendarSearch';
          const currentMonthYearEl = document.getElementById(currentMonthYearDisplayId);
          if (currentMonthYearEl) currentMonthYearEl.textContent = `${monthNames[month]} ${year}`;


          dayNames.forEach(dayName => {
            const dayHeaderEl = document.createElement('div');
            dayHeaderEl.classList.add('calendar-header');
            dayHeaderEl.textContent = dayName;
            container.appendChild(dayHeaderEl);
          });

          const firstDayOfMonth = new Date(year, month, 1).getDay();
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          for (let i = 0; i < firstDayOfMonth; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.classList.add('calendar-day', 'empty');
            container.appendChild(emptyCell);
          }

          for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('button'); // Ganti div menjadi button untuk aksesibilitas
            dayCell.type = 'button'; // Agar tidak submit form jika di dalam form
            dayCell.classList.add('calendar-day');
            dayCell.textContent = day;
            const currentDate = new Date(year, month, day);
            currentDate.setHours(0, 0, 0, 0);
            const dateString = currentDate.toISOString().split('T')[0];

            dayCell.dataset.date = dateString;
            dayCell.setAttribute('aria-label', `Pilih tanggal ${day} ${monthNames[month]} ${year}`);


            if (currentDate < today) {
              dayCell.classList.add('disabled');
              dayCell.disabled = true;
            } else if (bookedDates.includes(dateString)) {
              dayCell.classList.add('booked');
              dayCell.disabled = true;
              dayCell.setAttribute('aria-label', `Tanggal ${day} ${monthNames[month]} ${year} tidak tersedia`);
            } else {
              dayCell.classList.add('available');
              if (onDateSelectCallback) {
                dayCell.addEventListener('click', () => {
                  onDateSelectCallback(dateString, calendarStateRef, isBookingCalendar);
                });
              }
            }

            if (currentDate.getTime() === today.getTime()) {
              dayCell.classList.add('today');
            }

            // Tandai tanggal yang dipilih
            const checkinRef = isBookingCalendar ? document.getElementById('book-checkin')?.value : app.state.searchFilters.checkin;
            const checkoutRef = isBookingCalendar ? document.getElementById('book-checkout')?.value : app.state.searchFilters.checkout;

            if (checkinRef === dateString || checkoutRef === dateString) {
              dayCell.classList.add('selected');
              dayCell.setAttribute('aria-pressed', 'true');
            }
            if (checkinRef && checkoutRef && currentDate > new Date(checkinRef) && currentDate < new Date(checkoutRef)) {
              dayCell.classList.add('in-range'); // Untuk menandai range jika perlu styling
            }


            container.appendChild(dayCell);
          }
        },

        renderCalendarForSearch: () => {
          const calState = app.state.searchCalendar;
          app.ui.renderCalendar(
            app.ui.elements.searchPageCalendarContainer,
            calState.currentYear,
            calState.currentMonth,
            [], // Di search page, kita tidak disable tanggal berdasarkan 1 properti
            app.handlers.handleCalendarDateSelect,
            calState, // Pass reference to searchCalendar state
            false
          );
        },

        renderCalendarForBooking: () => {
          const calState = app.state.bookingCalendar;
          const container = document.getElementById('bookingPageCalendar'); // Dinamis dibuat
          if (!container) return;

          app.ui.renderCalendar(
            container,
            calState.currentYear,
            calState.currentMonth,
            calState.bookedDatesForCurrentApartment,
            app.handlers.handleCalendarDateSelect,
            calState, // Pass reference to bookingCalendar state
            true
          );
        },


        renderBookingHistory: () => {
          const container = app.ui.elements.bookingHistoryContainer;
          if (!container) return;

          app.ui.showLoading('bookingHistory', false); // Sembunyikan loading
          const history = app.state.bookingHistory;

          if (history.length === 0) {
            container.innerHTML = '<p class="text-sm text-muted">Tidak ada riwayat pemesanan.</p>';
            return;
          }

          container.innerHTML = history.map(booking => `
                <div class="card p-sm mb-sm shadow-xs">
                    <h4 class="font-medium text-sm mb-xs">${app.utils.escapeHTML(booking.apartmentTitle)}</h4>
                    <p class="text-xs text-muted">ID: ${app.utils.escapeHTML(booking.id)}</p>
                    <p class="text-xs text-muted">Check-in: ${app.utils.formatDate(booking.checkin)}</p>
                    <p class="text-xs text-muted">Check-out: ${app.utils.formatDate(booking.checkout)}</p>
                    <p class="text-xs font-semibold mt-xs">Total: ${app.utils.formatPrice(booking.totalCost)} (${app.utils.escapeHTML(booking.status)})</p>
                    <a href="#apartment/${app.state.apartments.find(a => a.id === booking.apartmentId)?.slug || booking.apartmentId}" class="btn btn-link btn-xs nav-link mt-xs p-0" data-page="apartment" data-id="${booking.apartmentId}">Lihat Properti</a>
                </div>
            `).join('');
        },

        addChatMessage: (message, type, chatBodyElement) => {
          if (!chatBodyElement) return;
          const messageEl = document.createElement('div');
          messageEl.classList.add('chat-message', type);
          messageEl.textContent = message; // Diasumsikan message sudah di-escape jika dari user input
          chatBodyElement.appendChild(messageEl);
          chatBodyElement.scrollTop = chatBodyElement.scrollHeight;
        },

        toggleGlobalChat: (forceOpen = null) => {
          const isOpen = app.ui.elements.globalChatbox.classList.contains('open');
          const shouldOpen = forceOpen !== null ? forceOpen : !isOpen;

          app.ui.elements.globalChatbox.classList.toggle('open', shouldOpen);
          app.ui.elements.globalChatbox.hidden = !shouldOpen;
          app.ui.elements.globalChatToggleBtn.innerHTML = `<span class="material-icons">${shouldOpen ? 'close' : 'chat'}</span>`;
          app.ui.elements.globalChatToggleBtn.setAttribute('aria-label', shouldOpen ? 'Tutup chat dukungan' : 'Buka chat dukungan');
          app.ui.elements.globalChatToggleBtn.setAttribute('aria-expanded', shouldOpen.toString());
          app.state.globalChatOpen = shouldOpen;
          if (shouldOpen) {
            app.ui.elements.globalChatInput.focus();
          }
        },
        openGlobalChat: () => app.ui.toggleGlobalChat(true),

        openModal: (title, contentHtml, type = 'info') => {
          if (!app.ui.elements.universalModal || !app.ui.elements.modalTitle || !app.ui.elements.modalBody) return;

          app.ui.elements.modalTitle.textContent = title;
          app.ui.elements.modalBody.innerHTML = contentHtml; // Pastikan contentHtml aman (sudah di-escape jika perlu)
          app.ui.elements.universalModal.hidden = false; // Hapus hidden dulu
          // Paksa reflow sebelum menambahkan class 'open' untuk transisi
          void app.ui.elements.universalModal.offsetWidth;
          app.ui.elements.universalModal.classList.add('open');

          // Tambahkan class berdasarkan tipe untuk styling (misal: modal-info, modal-error)
          app.ui.elements.universalModal.dataset.modalType = type;


          const focusableElements = app.ui.elements.universalModal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
          if (focusableElements.length) {
            focusableElements[0].focus();
          } else {
            // Jika tidak ada elemen fokus, fokus ke modal content untuk screen reader
            app.ui.elements.universalModal.querySelector('.modal-content').setAttribute('tabindex', '-1');
            app.ui.elements.universalModal.querySelector('.modal-content').focus();
          }
        },

        closeModal: () => {
          if (app.ui.elements.universalModal) {
            app.ui.elements.universalModal.classList.remove('open');
            // Tunggu transisi selesai sebelum menyembunyikan dengan 'hidden'
            app.ui.elements.universalModal.addEventListener('transitionend', () => {
              if (!app.ui.elements.universalModal.classList.contains('open')) { // Cek lagi kalau-kalau modal dibuka lagi cepat
                app.ui.elements.universalModal.hidden = true;
              }
            }, { once: true });
          }
        },

        openImageModal: (imageUrl, altText) => {
          const safeAltText = app.utils.escapeHTML(altText);
          app.ui.openModal(safeAltText, `<img src="${imageUrl}" alt="${safeAltText}" style="width:100%; height:auto; max-height: 80vh; object-fit:contain;">`);
        },

        initMap: (canvasId, coordinates = null, messageOverride = null) => {
          const canvas = document.getElementById(canvasId);
          if (!canvas) return;
          const ctx = canvas.getContext('2d');
          canvas.width = canvas.offsetWidth;
          canvas.height = canvas.offsetHeight;

          ctx.fillStyle = 'hsl(200, 30%, 92%)';
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          ctx.strokeStyle = 'hsl(200, 20%, 80%)';
          ctx.lineWidth = Math.max(2, canvas.width / 100); // Skala garis jalan
          for (let i = 0; i < 5; i++) {
            ctx.beginPath();
            ctx.moveTo(Math.random() * canvas.width, Math.random() * canvas.height);
            ctx.lineTo(Math.random() * canvas.width, Math.random() * canvas.height);
            ctx.stroke();
          }

          if (coordinates) {
            const markerSize = Math.max(6, canvas.width / 50);
            const markerX = canvas.width / 2 + (Math.random() - 0.5) * (canvas.width / 10);
            const markerY = canvas.height / 2 + (Math.random() - 0.5) * (canvas.height / 10);

            ctx.fillStyle = 'hsl(0, 70%, 60%)';
            ctx.beginPath();
            ctx.arc(markerX, markerY, markerSize, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = 'white';
            ctx.lineWidth = Math.max(1, markerSize / 4);
            ctx.stroke();
          }

          ctx.fillStyle = 'hsl(210, 15%, 45%)'; // Warna teks lebih kontras
          ctx.font = `${Math.max(10, canvas.width / 30)}px ${getComputedStyle(document.body).fontFamily}`; // Skala font
          ctx.textAlign = 'center';
          const textToDisplay = messageOverride || canvas.dataset.defaultMessage || app.config.defaultMapMessage;
          ctx.fillText(textToDisplay, canvas.width / 2, canvas.height - Math.max(15, canvas.height / 10));

          canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ctx.fillStyle = 'hsla(210, 85%, 55%, 0.3)';
            ctx.beginPath();
            ctx.arc(x, y, Math.max(10, canvas.width / 20), 0, Math.PI * 2);
            ctx.fill();
          });
        },

        setupApartmentDetailPageListeners: (apartment) => {
          const bookingForm = document.getElementById('apartmentBookingForm');
          if (bookingForm) {
            bookingForm.addEventListener('submit', (e) => app.handlers.handleBookingSubmit(e, apartment));
            ['book-checkin', 'book-checkout', 'book-insurance'].forEach(id => {
              const el = document.getElementById(id);
              if (el) el.addEventListener('change', () => app.ui.updateBookingCost(apartment));
            });
            // Untuk validasi dinamis input tanggal
            const checkinInput = document.getElementById('book-checkin');
            const checkoutInput = document.getElementById('book-checkout');
            if (checkinInput) checkinInput.addEventListener('change', () => {
              checkoutInput.min = checkinInput.value ? app.utils.getTomorrowDateString(checkinInput.value) : app.utils.getTomorrowDateString();
              app.ui.updateBookingCost(apartment);
            });
            if (checkoutInput) checkoutInput.addEventListener('change', () => app.ui.updateBookingCost(apartment));
          }

          const paymentMethods = document.querySelectorAll('.payment-method');
          paymentMethods.forEach(method => {
            const handleClickAndKey = () => {
              paymentMethods.forEach(m => {
                m.classList.remove('selected');
                m.setAttribute('aria-checked', 'false');
              });
              method.classList.add('selected');
              method.setAttribute('aria-checked', 'true');
              document.getElementById('selected-payment-method').value = method.dataset.method;
              document.getElementById('payment-method-error').classList.add('hidden'); // Sembunyikan error jika ada
            };
            method.addEventListener('click', handleClickAndKey);
            method.addEventListener('keydown', (e) => {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                handleClickAndKey();
              }
            });
          });

          // Listener untuk galeri gambar
          const galleryItems = document.querySelectorAll('.gallery-item[data-img-src]');
          galleryItems.forEach(item => {
            const openImage = () => app.ui.openImageModal(item.dataset.imgSrc, item.dataset.imgAlt);
            item.addEventListener('click', openImage);
            item.addEventListener('keydown', (e) => {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                openImage();
              }
            });
          });

          // Listener untuk tombol lapor ulasan
          const reportReviewButtons = document.querySelectorAll('.btn-report-review');
          reportReviewButtons.forEach(btn => {
            btn.addEventListener('click', () => app.ui.showReportForm(btn));
          });

          // Listener untuk navigasi kalender booking
          const prevBtnBooking = document.getElementById('prevMonthBtnBookingCalendar');
          const nextBtnBooking = document.getElementById('nextMonthBtnBookingCalendar');
          if (prevBtnBooking) prevBtnBooking.addEventListener('click', () => app.handlers.handleCalendarNav('prev', app.state.bookingCalendar, true));
          if (nextBtnBooking) nextBtnBooking.addEventListener('click', () => app.handlers.handleCalendarNav('next', app.state.bookingCalendar, true));
        },

        updateFooterYear: () => {
          if (app.ui.elements.currentYearDisplay) {
            app.ui.elements.currentYearDisplay.textContent = new Date().getFullYear();
          }
        },

        initializeDateInputs: () => {
          const today = app.utils.getTodayDateString();
          const tomorrow = app.utils.getTomorrowDateString();

          if (app.ui.elements.quickSearchCheckin) app.ui.elements.quickSearchCheckin.min = today;
          if (app.ui.elements.quickSearchCheckout) app.ui.elements.quickSearchCheckout.min = tomorrow;
          // Untuk search page, min date dihandle oleh logika kalender (disabled dates)
        },


        init: () => {
          app.ui.cacheElements();
          app.ui.updateFooterYear();
          app.ui.initializeDateInputs();
          // Render kalender di search page dan inisialisasi peta akan dipanggil oleh loadPageSpecificData
          // Peta juga akan di-init oleh loadPageSpecificData ketika halaman search atau detail dikunjungi
        }
      },

      handlers: {
        handleNavClick: (event) => {
          const targetLink = event.target.closest('.nav-link');
          if (targetLink && targetLink.dataset.page) {
            event.preventDefault(); // Hanya preventDefault jika itu link navigasi SPA
            const pageId = targetLink.dataset.page;
            let apartmentId = targetLink.dataset.id;

            if (pageId === 'apartment' && apartmentId) {
              app.state.selectedApartmentId = parseInt(apartmentId);
              const apartment = app.state.apartments.find(a => a.id === app.state.selectedApartmentId);
              window.location.hash = `${pageId}/${apartment ? apartment.slug : apartmentId}`;
            } else if (pageId === 'privacy' || pageId === 'terms') {
              // Untuk halaman statis sederhana seperti privacy/terms, kita bisa buatkan section juga
              // atau, jika ini link ke halaman eksternal/file lain, jangan preventDefault
              // Untuk demo ini, kita anggap ini bagian dari SPA
              window.location.hash = pageId;
            }
            else {
              window.location.hash = pageId;
            }
          }
        },

        handleNavToggle: () => {
          app.state.isMobileNavOpen = !app.state.isMobileNavOpen;
          app.ui.elements.navLinksMenu.classList.toggle('open', app.state.isMobileNavOpen);
          app.ui.elements.navToggleBtn.setAttribute('aria-expanded', app.state.isMobileNavOpen.toString());
          app.ui.elements.navToggleBtn.innerHTML = `<span class="material-icons">${app.state.isMobileNavOpen ? 'close' : 'menu'}</span>`;
          app.ui.elements.navToggleBtn.setAttribute('aria-label', app.state.isMobileNavOpen ? 'Tutup menu navigasi' : 'Buka menu navigasi');
        },

        handleRouteChange: () => {
          const hash = window.location.hash.substring(1);
          let pageId = 'home';
          let slugOrId = null;

          if (hash) {
            const parts = hash.split('/');
            pageId = parts[0];
            if (parts.length > 1 && pageId === 'apartment') {
              slugOrId = parts[1];
              const foundApartment = app.state.apartments.find(apt => apt.slug === slugOrId || apt.id == slugOrId);
              if (foundApartment) {
                app.state.selectedApartmentId = foundApartment.id;
              } else {
                pageId = 'home'; // Jika tidak ditemukan, kembali ke home
                window.location.hash = 'home'; // Redirect hash
              }
            } else if (pageId === 'privacy' || pageId === 'terms') {
              // Logika untuk menampilkan halaman privacy/terms (bisa jadi section HTML terpisah)
              // Jika belum ada, default ke home atau tampilkan pesan "Halaman tidak ditemukan"
              if (!document.getElementById(pageId)) {
                console.warn(`Static page section for "${pageId}" not found. Defaulting to home.`);
                pageId = 'home';
                window.location.hash = 'home';
              }
            }
          }
          app.ui.showPage(pageId);
        },

        handleQuickSearch: (event) => {
          event.preventDefault();
          const location = document.getElementById('quick-location').value;
          const checkin = app.ui.elements.quickSearchCheckin.value;
          const checkout = app.ui.elements.quickSearchCheckout.value;

          if (checkin && checkout && new Date(checkout) <= new Date(checkin)) {
            app.ui.openModal('Tanggal Tidak Valid', '<p>Tanggal check-out harus setelah tanggal check-in.</p>', 'error');
            return;
          }

          app.state.searchFilters.location = location;
          app.state.searchFilters.checkin = checkin || null; // Set ke null jika kosong
          app.state.searchFilters.checkout = checkout || null;

          window.location.hash = 'search';
        },

        handleDetailedSearch: (event) => {
          event.preventDefault();
          app.state.searchFilters.location = app.ui.elements.searchLocationInput.value.trim().toLowerCase();
          app.state.searchFilters.radius = parseInt(app.ui.elements.searchRadiusSlider.value);
          app.state.searchFilters.maxPrice = parseInt(app.ui.elements.searchPriceSlider.value);

          const selectedAmenities = [];
          app.ui.elements.searchAmenitiesCheckboxes.forEach(checkbox => {
            if (checkbox.checked) selectedAmenities.push(checkbox.value);
          });
          app.state.searchFilters.amenities = selectedAmenities;
          app.state.searchFilters.type = app.ui.elements.searchApartmentTypeSelect.value;

          app.services.filterApartments();
        },

        handleResetSearchFilters: () => {
          if (app.ui.elements.detailedSearchForm) {
            app.ui.elements.detailedSearchForm.reset();
          }

          app.state.searchFilters = { // Reset ke default
            location: '',
            radius: 5,
            checkin: null,
            checkout: null,
            maxPrice: 15000000,
            amenities: [],
            type: ''
          };
          // Update tampilan slider, display nilai, dan input tanggal
          if (app.ui.elements.searchRadiusSlider) app.ui.elements.searchRadiusSlider.value = app.state.searchFilters.radius;
          if (app.ui.elements.radiusValueDisplay) app.ui.elements.radiusValueDisplay.textContent = app.state.searchFilters.radius;

          if (app.ui.elements.searchPriceSlider) app.ui.elements.searchPriceSlider.value = app.state.searchFilters.maxPrice;
          if (app.ui.elements.priceValueDisplay) app.ui.elements.priceValueDisplay.textContent = app.state.searchFilters.maxPrice.toLocaleString('id-ID');

          if (app.ui.elements.searchCheckinDateInput) app.ui.elements.searchCheckinDateInput.value = '';
          if (app.ui.elements.searchCheckoutDateInput) app.ui.elements.searchCheckoutDateInput.value = '';

          app.ui.renderCalendarForSearch();
          app.services.filterApartments();
        },

        handleCalendarDateSelect: (dateString, calendarStateRef, isBookingCalendar = false) => {
          const date = new Date(dateString + "T00:00:00");
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          if (date < today) return; // Abaikan jika tanggal sudah lewat (seharusnya sudah di-disable)

          const targetCheckinInputId = isBookingCalendar ? 'book-checkin' : 'search-checkin-date';
          const targetCheckoutInputId = isBookingCalendar ? 'book-checkout' : 'search-checkout-date';

          const checkinInput = document.getElementById(targetCheckinInputId);
          const checkoutInput = document.getElementById(targetCheckoutInputId);

          if (!checkinInput || !checkoutInput) return;

          let currentCheckin = checkinInput.value;
          let currentCheckout = checkoutInput.value;

          if (!currentCheckin || (currentCheckin && currentCheckout)) {
            currentCheckin = dateString;
            currentCheckout = null;
            if (isBookingCalendar) checkoutInput.min = app.utils.getTomorrowDateString(dateString);
          } else if (date > new Date(currentCheckin + "T00:00:00")) {
            currentCheckout = dateString;
          } else {
            currentCheckin = dateString;
            currentCheckout = null;
            if (isBookingCalendar) checkoutInput.min = app.utils.getTomorrowDateString(dateString);
          }

          checkinInput.value = currentCheckin || '';
          checkoutInput.value = currentCheckout || '';

          if (!isBookingCalendar) { // Update state filter pencarian
            app.state.searchFilters.checkin = currentCheckin || null;
            app.state.searchFilters.checkout = currentCheckout || null;
            app.ui.renderCalendarForSearch();
            app.services.filterApartments();
          } else { // Update UI booking & biaya
            app.ui.renderCalendarForBooking();
            const apartment = app.state.apartments.find(a => a.id === app.state.selectedApartmentId);
            if (apartment) app.ui.updateBookingCost(apartment);
          }
        },


        handleCalendarNav: (direction, calendarStateRef, isBookingCalendar = false) => {
          if (direction === 'prev') {
            calendarStateRef.currentMonth--;
            if (calendarStateRef.currentMonth < 0) {
              calendarStateRef.currentMonth = 11;
              calendarStateRef.currentYear--;
            }
          } else {
            calendarStateRef.currentMonth++;
            if (calendarStateRef.currentMonth > 11) {
              calendarStateRef.currentMonth = 0;
              calendarStateRef.currentYear++;
            }
          }
          if (isBookingCalendar) {
            app.ui.renderCalendarForBooking();
          } else {
            app.ui.renderCalendarForSearch();
          }
        },

        handleSliderInput: (event) => {
          const slider = event.target;
          if (slider.id === 'search-radius' && app.ui.elements.radiusValueDisplay) {
            app.ui.elements.radiusValueDisplay.textContent = slider.value;
          } else if (slider.id === 'search-price' && app.ui.elements.priceValueDisplay) {
            app.ui.elements.priceValueDisplay.textContent = parseInt(slider.value).toLocaleString('id-ID');
          }
          // Debounce filtering agar tidak terlalu sering trigger saat slider digeser cepat
          app.utils.debounce(app.services.filterApartments, 350)();
        },

        handleBookingSubmit: (event, apartment) => {
          event.preventDefault();
          const form = event.target;
          const checkin = form.querySelector('#book-checkin').value;
          const checkout = form.querySelector('#book-checkout').value;
          const guests = form.querySelector('#book-guests').value;
          const paymentMethod = form.querySelector('#selected-payment-method').value;
          const insurance = form.querySelector('#book-insurance').checked;
          const dateErrorEl = document.getElementById('booking-date-error');
          const paymentErrorEl = document.getElementById('payment-method-error');

          dateErrorEl.classList.add('hidden');
          paymentErrorEl.classList.add('hidden');
          let isValid = true;

          if (!checkin || !checkout) {
            dateErrorEl.textContent = 'Tanggal check-in dan check-out harus diisi.';
            dateErrorEl.classList.remove('hidden');
            isValid = false;
          } else if (new Date(checkout) <= new Date(checkin)) {
            dateErrorEl.textContent = 'Tanggal check-out harus setelah tanggal check-in.';
            dateErrorEl.classList.remove('hidden');
            isValid = false;
          } else if (app.utils.getDaysDifference(checkin, checkout) < app.config.minBookingDurationDays) {
            dateErrorEl.textContent = `Durasi sewa minimal adalah ${app.config.minBookingDurationDays} hari.`;
            dateErrorEl.classList.remove('hidden');
            isValid = false;
          }

          if (!paymentMethod) {
            paymentErrorEl.classList.remove('hidden');
            isValid = false;
          }

          if (!isValid) {
            app.ui.openModal('Error Pemesanan', '<p>Mohon perbaiki kesalahan pada formulir.</p>', 'error');
            return;
          }


          let isDateRangeBooked = false;
          const startDate = new Date(checkin + "T00:00:00");
          const endDate = new Date(checkout + "T00:00:00");

          for (let d = new Date(startDate); d < endDate; d.setDate(d.getDate() + 1)) { // Loop sampai < endDate
            if (apartment.bookedDates.includes(d.toISOString().split('T')[0])) {
              isDateRangeBooked = true;
              break;
            }
          }
          if (isDateRangeBooked) {
            app.ui.openModal('Error Pemesanan', '<p>Maaf, sebagian atau seluruh tanggal yang Anda pilih sudah tidak tersedia untuk properti ini.</p>', 'error');
            return;
          }

          const durationDays = app.utils.getDaysDifference(checkin, checkout);
          const dailyRate = apartment.price / 30;
          const calculatedBaseCost = dailyRate * durationDays;
          const serviceFee = calculatedBaseCost * 0.05;
          const insuranceCost = insurance ? calculatedBaseCost * 0.10 : 0;
          const totalCost = calculatedBaseCost + serviceFee + insuranceCost;

          // Tambahkan tanggal yang dibooking ke properti (state dan mockData jika perlu update permanen)
          for (let d = new Date(startDate); d < endDate; d.setDate(d.getDate() + 1)) {
            const dateToBook = d.toISOString().split('T')[0];
            if (!apartment.bookedDates.includes(dateToBook)) {
              apartment.bookedDates.push(dateToBook);
            }
          }
          // Update juga di mockData.apartments agar persist jika halaman direfresh (untuk demo)
          const mockApartment = app.mockData.apartments.find(a => a.id === apartment.id);
          if (mockApartment) mockApartment.bookedDates = [...apartment.bookedDates];


          const newBooking = {
            id: app.utils.generateId('BK'),
            apartmentId: apartment.id,
            apartmentTitle: apartment.title,
            checkin,
            checkout,
            guests,
            totalCost: totalCost, // Simpan dalam nilai absolut
            paymentMethod,
            insurance,
            status: 'Menunggu Pembayaran'
          };
          app.state.bookingHistory.unshift(newBooking);
          app.services.saveBookingHistory();

          app.ui.openModal(
            'Pemesanan Berhasil (Simulasi)',
            `<p>Selamat! Pemesanan Anda untuk <strong>${app.utils.escapeHTML(apartment.title)}</strong> dari tanggal ${app.utils.formatDate(checkin)} hingga ${app.utils.formatDate(checkout)} telah berhasil diproses.</p>
                 <p>Total Pembayaran: <strong>${app.utils.formatPrice(totalCost)}</strong></p>
                 <p>Metode Pembayaran: ${app.utils.escapeHTML(paymentMethod.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()))}</p>
                 <p>Detail pemesanan telah dikirim ke email Anda (simulasi) dan dapat dilihat di halaman profil.</p>`,
            'success'
          );

          form.reset();
          document.getElementById('bookingCostBreakdown').classList.add('hidden');
          document.querySelectorAll('.payment-method.selected').forEach(pm => {
            pm.classList.remove('selected');
            pm.setAttribute('aria-checked', 'false');
          });
          app.state.bookingCalendar.bookedDatesForCurrentApartment = apartment.bookedDates; // Update state kalender
          app.ui.renderCalendarForBooking(); // Re-render kalender di detail page
        },

        handleProfileChatSubmit: (event) => {
          event.preventDefault();
          const input = app.ui.elements.profileChatInput;
          const message = input.value.trim();
          if (message) {
            app.ui.addChatMessage(app.utils.escapeHTML(message), 'sent', app.ui.elements.profileChatWindow);
            input.value = '';
            setTimeout(() => {
              app.ui.addChatMessage('Terima kasih atas pesan Anda. Kami akan segera merespons.', 'received', app.ui.elements.profileChatWindow);
            }, 1500);
          }
        },

        handleGlobalChatSubmit: (event) => {
          event.preventDefault();
          const input = app.ui.elements.globalChatInput;
          const message = input.value.trim();
          if (message) {
            app.ui.addChatMessage(app.utils.escapeHTML(message), 'sent', app.ui.elements.globalChatBody);
            input.value = '';
            setTimeout(() => {
              app.ui.addChatMessage('Terima kasih telah menghubungi dukungan Rentelindo. Seorang agen akan segera membantu Anda.', 'system', app.ui.elements.globalChatBody);
            }, 1000);
            setTimeout(() => {
              app.ui.addChatMessage('Halo! Saya agen Rentelindo. Ada yang bisa saya bantu?', 'received', app.ui.elements.globalChatBody);
            }, 2500);
          }
        },

        handleReviewReportSubmit: (event) => {
          event.preventDefault();
          const form = event.target;
          const reason = form.reason.value.trim();
          const reviewId = form.reviewId.value;
          const apartmentId = form.apartmentId.value;

          if (!reason) {
            app.ui.openModal('Error Laporan', '<p>Mohon isi alasan mengapa Anda melaporkan ulasan ini.</p>', 'error');
            return;
          }
          console.log(`Laporan dikirim untuk review ID ${reviewId} di apartemen ID ${apartmentId}. Alasan: ${reason}`);
          app.ui.openModal('Laporan Terkirim', '<p>Terima kasih atas laporan Anda. Tim kami akan meninjau ulasan tersebut.</p>', 'success');
          app.ui.hideReportForm();
        },

        handleModalClose: (event) => {
          if (event.target === app.ui.elements.universalModal || event.target.closest('.modal-close-btn')) {
            app.ui.closeModal();
          }
        },

        handleDocumentClick: (event) => {
          // Menutup mobile nav jika klik di luar
          if (app.state.isMobileNavOpen &&
            app.ui.elements.navLinksMenu && // Pastikan elemen ada
            !app.ui.elements.navLinksMenu.contains(event.target) &&
            !app.ui.elements.navToggleBtn.contains(event.target)) {
            app.handlers.handleNavToggle();
          }
          // Menutup global chatbox jika klik di luar (kecuali tombol toggle nya)
          if (app.state.globalChatOpen &&
            app.ui.elements.globalChatbox &&
            !app.ui.elements.globalChatbox.contains(event.target) &&
            !app.ui.elements.globalChatToggleBtn.contains(event.target)) {
            app.ui.toggleGlobalChat(false);
          }
        },

        init: () => {
          window.addEventListener('hashchange', app.handlers.handleRouteChange);
          document.body.addEventListener('click', app.handlers.handleNavClick); // Delegasi untuk semua .nav-link

          if (app.ui.elements.navToggleBtn) app.ui.elements.navToggleBtn.addEventListener('click', app.handlers.handleNavToggle);

          if (app.ui.elements.quickSearchForm) app.ui.elements.quickSearchForm.addEventListener('submit', app.handlers.handleQuickSearch);

          if (app.ui.elements.detailedSearchForm) {
            app.ui.elements.detailedSearchForm.addEventListener('submit', app.handlers.handleDetailedSearch);
            if (app.ui.elements.searchRadiusSlider) app.ui.elements.searchRadiusSlider.addEventListener('input', app.handlers.handleSliderInput);
            if (app.ui.elements.searchPriceSlider) app.ui.elements.searchPriceSlider.addEventListener('input', app.handlers.handleSliderInput);
            if (app.ui.elements.resetSearchFiltersBtn) app.ui.elements.resetSearchFiltersBtn.addEventListener('click', app.handlers.handleResetSearchFilters);
            // Listener untuk checkbox dan select di form filter agar langsung filter
            app.ui.elements.searchAmenitiesCheckboxes.forEach(cb => cb.addEventListener('change', app.services.filterApartments));
            if (app.ui.elements.searchApartmentTypeSelect) app.ui.elements.searchApartmentTypeSelect.addEventListener('change', app.services.filterApartments);

          }

          if (app.ui.elements.prevMonthBtnCalendarSearch) app.ui.elements.prevMonthBtnCalendarSearch.addEventListener('click', () => app.handlers.handleCalendarNav('prev', app.state.searchCalendar, false));
          if (app.ui.elements.nextMonthBtnCalendarSearch) app.ui.elements.nextMonthBtnCalendarSearch.addEventListener('click', () => app.handlers.handleCalendarNav('next', app.state.searchCalendar, false));


          if (app.ui.elements.profileChatForm) app.ui.elements.profileChatForm.addEventListener('submit', app.handlers.handleProfileChatSubmit);
          if (app.ui.elements.globalChatToggleBtn) app.ui.elements.globalChatToggleBtn.addEventListener('click', () => app.ui.toggleGlobalChat());
          if (app.ui.elements.closeChatboxBtn) app.ui.elements.closeChatboxBtn.addEventListener('click', () => app.ui.toggleGlobalChat(false));
          if (app.ui.elements.globalChatForm) app.ui.elements.globalChatForm.addEventListener('submit', app.handlers.handleGlobalChatSubmit);

          if (app.ui.elements.universalModal) {
            app.ui.elements.universalModal.addEventListener('click', app.handlers.handleModalClose);
            app.ui.elements.modalCloseBtns.forEach(btn => btn.addEventListener('click', app.ui.closeModal));
          }
          document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && app.ui.elements.universalModal && app.ui.elements.universalModal.classList.contains('open')) {
              app.ui.closeModal();
            }
            if (event.key === 'Escape' && app.state.globalChatOpen && app.ui.elements.globalChatbox) {
              app.ui.toggleGlobalChat(false);
            }
          });

          document.addEventListener('click', app.handlers.handleDocumentClick);
        }
      },

      services: {
        loadInitialData: () => {
          // Salin array agar tidak memodifikasi mockData asli dan bisa dimodifikasi (misal bookedDates)
          app.state.apartments = JSON.parse(JSON.stringify(app.mockData.apartments));
          app.services.loadBookingHistory();
        },

        loadPageSpecificData: (pageId) => {
          switch (pageId) {
            case 'home':
              app.ui.renderFeaturedProperties();
              break;
            case 'search':
              // Set nilai filter dari state ke form jika ada (misal dari quick search)
              if (app.ui.elements.searchLocationInput) app.ui.elements.searchLocationInput.value = app.state.searchFilters.location;
              if (app.ui.elements.searchCheckinDateInput) app.ui.elements.searchCheckinDateInput.value = app.state.searchFilters.checkin || '';
              if (app.ui.elements.searchCheckoutDateInput) app.ui.elements.searchCheckoutDateInput.value = app.state.searchFilters.checkout || '';
              if (app.ui.elements.searchPriceSlider) app.ui.elements.searchPriceSlider.value = app.state.searchFilters.maxPrice;
              if (app.ui.elements.priceValueDisplay) app.ui.elements.priceValueDisplay.textContent = app.state.searchFilters.maxPrice.toLocaleString('id-ID');

              app.ui.showLoading('searchResults', true);
              app.ui.renderCalendarForSearch();
              app.ui.initMap('searchMapCanvas', null, 'Pilih lokasi pada filter untuk simulasi pencarian area.'); // Peta generik
              // Simulasi delay API untuk hasil pencarian
              setTimeout(() => {
                app.services.filterApartments(); // Filter setelah state form diset
              }, 300);

              break;
            case 'apartment':
              app.ui.showLoading('apartmentDetail', true);
              if (app.state.selectedApartmentId) {
                const apartment = app.state.apartments.find(a => a.id === app.state.selectedApartmentId);
                // Simulasi delay
                setTimeout(() => {
                  if (apartment) {
                    app.ui.renderApartmentDetail(apartment);
                  } else {
                    app.ui.elements.apartmentDetailContainer.innerHTML = '<p class="text-center text-lg text-error p-xl">Apartemen tidak ditemukan.</p>';
                  }
                }, 500);
              } else {
                app.ui.elements.apartmentDetailContainer.innerHTML = '<p class="text-center text-lg text-muted p-xl">Silakan pilih apartemen untuk dilihat detailnya.</p>';
              }
              break;
            case 'profile':
              app.ui.showLoading('bookingHistory', true);
              setTimeout(() => { // Simulasi fetch data profil
                app.ui.renderBookingHistory();
                // Cek jika tidak ada notifikasi
                if (app.ui.elements.notificationsContainer && app.ui.elements.notificationsContainer.children.length === 0 && app.ui.elements.noNotificationsMessage) {
                  app.ui.elements.noNotificationsMessage.classList.remove('hidden');
                }
              }, 300);
              break;
            case 'support':
            case 'privacy': // Asumsi ada section #privacy
            case 'terms':   // Asumsi ada section #terms
              // Tidak ada data spesifik untuk dimuat saat ini
              break;
            default:
            // Jika halaman tidak dikenal oleh switch ini, tidak ada aksi khusus.
            // Penanganan halaman tidak ditemukan sudah ada di showPage.
          }
        },

        filterApartments: () => {
          app.ui.showLoading('searchResults', true);
          // Simulasi delay filter
          setTimeout(() => {
            const filters = app.state.searchFilters;
            const filteredResults = app.state.apartments.filter(apt => {
              let match = true;

              if (filters.location && !apt.location.toLowerCase().includes(filters.location)) {
                match = false;
              }
              // Radius tidak diimplementasikan secara fungsional, hanya UI
              if (apt.price > filters.maxPrice) {
                match = false;
              }
              if (filters.type && apt.type !== filters.type) {
                match = false;
              }
              if (filters.amenities.length > 0) {
                if (!filters.amenities.every(amenity => apt.amenities.includes(amenity))) {
                  match = false;
                }
              }
              if (filters.checkin && filters.checkout) {
                const checkinDate = new Date(filters.checkin + "T00:00:00");
                const checkoutDate = new Date(filters.checkout + "T00:00:00");
                let isRangeBooked = false;
                for (let d = new Date(checkinDate); d < checkoutDate; d.setDate(d.getDate() + 1)) {
                  if (apt.bookedDates.includes(d.toISOString().split('T')[0])) {
                    isRangeBooked = true;
                    break;
                  }
                }
                if (isRangeBooked) match = false;
              } else if (filters.checkin) {
                if (apt.bookedDates.includes(filters.checkin)) {
                  match = false;
                }
              }
              return match;
            });
            app.ui.renderSearchResults(filteredResults);
          }, 400);
        },

        loadBookingHistory: () => {
          const storedHistory = localStorage.getItem(app.config.localStorageKeys.bookingHistory);
          if (storedHistory) {
            try {
              app.state.bookingHistory = JSON.parse(storedHistory);
            } catch (e) {
              console.error("Gagal memuat riwayat booking dari localStorage:", e);
              app.state.bookingHistory = JSON.parse(JSON.stringify(app.mockData.bookingHistory)); // Fallback ke mock jika error
            }
          } else {
            app.state.bookingHistory = JSON.parse(JSON.stringify(app.mockData.bookingHistory)); // Salin dari mock
          }
        },

        saveBookingHistory: () => {
          try {
            localStorage.setItem(app.config.localStorageKeys.bookingHistory, JSON.stringify(app.state.bookingHistory));
          } catch (e) {
            console.error("Gagal menyimpan riwayat booking ke localStorage:", e);
            app.ui.openModal("Peringatan", "<p>Gagal menyimpan riwayat booking Anda. Penyimpanan lokal mungkin penuh atau tidak didukung.</p>", "warning");
          }
        },

      },

      init: () => {
        console.log("Rentelindo App Initializing...");
        app.services.loadInitialData();
        app.ui.init(); // Cache elements, etc.
        app.handlers.init(); // Attach event listeners.

        app.handlers.handleRouteChange(); // Handle initial route.
        console.log("Rentelindo App Ready!");
      }
    };

    document.addEventListener('DOMContentLoaded', app.init);

  </script>
</body>

</html>