<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description"
    content="Green Valley - Platform penyewaan apartemen modern dan terpercaya. Temukan apartemen impian Anda dengan mudah.">
  <meta name="keywords" content="sewa apartemen, apartemen, rental, properti, Green Valley">
  <meta name="author" content="Green Valley">
  <title>Green Valley - Penyewaan Apartemen Premium</title>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>GV</text></svg>"
    type="image/svg+xml">

  <!-- Ikon Material Google (sesuai permintaan, bukan SVG) -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Font Inter Google -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">

  <style>
    /* SISTEM DESAIN & VARIABEL GLOBAL */
    :root {
      --color-primary: hsl(140, 60%, 45%);
      /* Hijau dedaunan modern */
      --color-primary-light: hsl(140, 60%, 95%);
      --color-primary-dark: hsl(140, 60%, 35%);
      --color-secondary: hsl(200, 70%, 50%);
      /* Biru langit yang menenangkan */
      --color-secondary-light: hsl(200, 70%, 95%);
      --color-secondary-dark: hsl(200, 70%, 40%);
      --color-accent: hsl(35, 90%, 60%);
      /* Oranye hangat untuk aksen */
      --color-background: hsl(0, 0%, 98%);
      /* Putih gading yang lembut */
      --color-surface: hsl(0, 0%, 100%);
      /* Putih bersih untuk permukaan kartu dll */
      --color-foreground: hsl(210, 10%, 23%);
      /* Abu-abu gelap untuk teks utama */
      --color-foreground-muted: hsl(210, 10%, 55%);
      /* Abu-abu lebih terang untuk teks sekunder */
      --color-border: hsl(210, 15%, 88%);
      /* Abu-abu terang untuk border */
      --color-success: hsl(140, 65%, 40%);
      --color-error: hsl(0, 70%, 55%);
      --color-warning: hsl(40, 90%, 55%);
      --color-warning-light: hsl(40, 90%, 96%);


      --font-family-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --font-size-base: 1rem;
      /* 16px default */
      --line-height-base: 1.6;

      --space-xxs: 0.25rem;
      /* 4px */
      --space-xs: 0.5rem;
      /* 8px */
      --space-sm: 0.75rem;
      /* 12px */
      --space-md: 1rem;
      /* 16px */
      --space-lg: 1.5rem;
      /* 24px */
      --space-xl: 2rem;
      /* 32px */
      --space-xxl: 3rem;
      /* 48px */

      --radius-sm: 0.25rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      /* Tambahan untuk elemen lebih besar */
      --radius-full: 9999px;

      --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.03);
      --shadow-sm: 0 2px 4px -1px rgba(0, 0, 0, 0.06), 0 2px 2px -1px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 4px 8px -2px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

      --transition-base: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      /* Easing lebih smooth */
      --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);

      --z-index-dropdown: 1000;
      --z-index-sticky: 1020;
      --z-index-modal-backdrop: 1040;
      --z-index-modal: 1050;
      --z-index-popover: 1060;
      --z-index-tooltip: 1070;
      --z-index-chatbox: 1100;
    }

    /* RESET & DASAR */
    *,
    *::before,
    *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
      font-size: var(--font-size-base);
    }

    body {
      font-family: var(--font-family-sans);
      background-color: var(--color-background);
      color: var(--color-foreground);
      line-height: var(--line-height-base);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .main-content {
      flex-grow: 1;
    }

    a {
      text-decoration: none;
      color: var(--color-primary);
      transition: var(--transition-fast);
    }

    a:hover {
      color: var(--color-primary-dark);
      text-decoration: underline;
    }

    img,
    picture,
    video,
    canvas {
      display: block;
      max-width: 100%;
    }

    button,
    input,
    select,
    textarea {
      font-family: inherit;
      font-size: inherit;
      line-height: inherit;
      color: inherit;
      outline: none;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
    }

    button {
      cursor: pointer;
      background-color: transparent;
      border: none;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      font-weight: 700;
      /* Lebih bold untuk heading */
      line-height: 1.3;
      margin-bottom: var(--space-md);
      color: var(--color-foreground);
      /* Warna heading konsisten */
    }

    h1 {
      font-size: 2.5rem;
    }

    /* 40px, lebih besar */
    h2 {
      font-size: 2rem;
    }

    /* 32px */
    h3 {
      font-size: 1.5rem;
    }

    /* 24px */
    p {
      margin-bottom: var(--space-md);
    }

    ul,
    ol {
      list-style: none;
    }

    /* KELAS UTILITAS (sebagian besar sudah baik, penyesuaian minor) */
    .container {
      width: 100%;
      max-width: 1320px;
      /* Sedikit lebih lebar untuk desktop */
      margin-left: auto;
      margin-right: auto;
      padding-left: var(--space-lg);
      padding-right: var(--space-lg);
    }

    .flex {
      display: flex;
    }

    .flex-col {
      flex-direction: column;
    }

    .items-center {
      align-items: center;
    }

    .justify-center {
      justify-content: center;
    }

    .justify-between {
      justify-content: space-between;
    }

    .justify-end {
      justify-content: flex-end;
    }

    .gap-xxs {
      gap: var(--space-xxs);
    }

    .gap-xs {
      gap: var(--space-xs);
    }

    .gap-sm {
      gap: var(--space-sm);
    }

    .gap-md {
      gap: var(--space-md);
    }

    .gap-lg {
      gap: var(--space-lg);
    }

    .gap-xl {
      gap: var(--space-xl);
    }

    .p-xs {
      padding: var(--space-xs);
    }

    .p-sm {
      padding: var(--space-sm);
    }

    .p-md {
      padding: var(--space-md);
    }

    .p-lg {
      padding: var(--space-lg);
    }

    .p-xl {
      padding: var(--space-xl);
    }

    .m-xs {
      margin: var(--space-xs);
    }

    .m-sm {
      margin: var(--space-sm);
    }

    .m-md {
      margin: var(--space-md);
    }

    .m-lg {
      margin: var(--space-lg);
    }

    .m-xl {
      margin: var(--space-xl);
    }

    .my-auto {
      margin-top: auto;
      margin-bottom: auto;
    }

    .mx-auto {
      margin-left: auto;
      margin-right: auto;
    }

    .mt-auto {
      margin-top: auto;
    }

    .mt-xxs {
      margin-top: var(--space-xxs);
    }

    .mt-xs {
      margin-top: var(--space-xs);
    }

    .mt-sm {
      margin-top: var(--space-sm);
    }

    .mt-md {
      margin-top: var(--space-md);
    }

    .mt-lg {
      margin-top: var(--space-lg);
    }

    .mt-xl {
      margin-top: var(--space-xl);
    }

    .mb-auto {
      margin-bottom: auto;
    }

    .mb-xxs {
      margin-bottom: var(--space-xxs);
    }

    .mb-xs {
      margin-bottom: var(--space-xs);
    }

    .mb-sm {
      margin-bottom: var(--space-sm);
    }

    .mb-md {
      margin-bottom: var(--space-md);
    }

    .mb-lg {
      margin-bottom: var(--space-lg);
    }

    .mb-xl {
      margin-bottom: var(--space-xl);
    }

    .ml-auto {
      margin-left: auto;
    }

    .mr-auto {
      margin-right: auto;
    }

    .mr-sm {
      margin-right: var(--space-sm);
    }

    .ml-sm {
      margin-left: var(--space-sm);
    }

    .w-full {
      width: 100%;
    }

    .w-1\/2 {
      width: 50%;
    }

    .text-primary {
      color: var(--color-primary);
    }

    .text-secondary {
      color: var(--color-secondary);
    }

    .text-accent {
      color: var(--color-accent);
    }

    .text-muted {
      color: var(--color-foreground-muted);
    }

    .text-error {
      color: var(--color-error);
    }

    .text-success {
      color: var(--color-success);
    }

    .text-xs {
      font-size: 0.75rem;
    }

    /* 12px */
    .text-sm {
      font-size: 0.875rem;
    }

    /* 14px */
    .text-lg {
      font-size: 1.125rem;
    }

    /* 18px */
    .text-xl {
      font-size: 1.25rem;
    }

    /* 20px */
    .text-2xl {
      font-size: 1.5rem;
    }

    /* 24px */
    .text-3xl {
      font-size: 1.875rem;
    }

    /* 30px */
    .font-light {
      font-weight: 300;
    }

    .font-normal {
      font-weight: 400;
    }

    .font-medium {
      font-weight: 500;
    }

    .font-semibold {
      font-weight: 600;
    }

    .font-bold {
      font-weight: 700;
    }

    .rounded-sm {
      border-radius: var(--radius-sm);
    }

    .rounded-md {
      border-radius: var(--radius-md);
    }

    .rounded-lg {
      border-radius: var(--radius-lg);
    }

    .rounded-xl {
      border-radius: var(--radius-xl);
    }

    /* Baru */
    .rounded-full {
      border-radius: var(--radius-full);
    }

    .shadow-xs {
      box-shadow: var(--shadow-xs);
    }

    .shadow-sm {
      box-shadow: var(--shadow-sm);
    }

    .shadow-md {
      box-shadow: var(--shadow-md);
    }

    .shadow-lg {
      box-shadow: var(--shadow-lg);
    }

    .shadow-xl {
      box-shadow: var(--shadow-xl);
    }

    .transition {
      transition: var(--transition-base);
    }

    .hidden {
      display: none !important;
    }

    .sr-only {
      /* Screen reader only */
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }

    .fade-in {
      opacity: 0;
      transform: translateY(10px);
      /* Sedikit lebih halus */
      animation: fadeInAnimation 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    @keyframes fadeInAnimation {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .text-center {
      text-align: center;
    }

    /* GRID SYSTEM (sebagian besar sudah baik) */
    .grid {
      display: grid;
      gap: var(--space-lg);
    }

    .grid-cols-1 {
      grid-template-columns: repeat(1, 1fr);
    }

    .grid-cols-2 {
      grid-template-columns: repeat(2, 1fr);
    }

    .grid-cols-3 {
      grid-template-columns: repeat(3, 1fr);
    }

    .grid-cols-4 {
      grid-template-columns: repeat(4, 1fr);
    }

    .grid-cols-autofit-200 {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    .grid-cols-autofit-250 {
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }

    .grid-cols-autofit-300 {
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }

    .col-span-full {
      grid-column: 1 / -1;
    }

    /* KOMPONEN: TOMBOL (BUTTON) */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-xs);
      padding: var(--space-sm) var(--space-lg);
      font-weight: 600;
      /* Lebih tegas */
      text-align: center;
      vertical-align: middle;
      cursor: pointer;
      border: 1px solid transparent;
      border-radius: var(--radius-md);
      transition: var(--transition-base);
      user-select: none;
      line-height: 1;
    }

    .btn .material-icons {
      font-size: 1.25em;
      line-height: 1;
    }

    .btn-primary {
      background-color: var(--color-primary);
      color: var(--color-surface);
      border-color: var(--color-primary);
    }

    .btn-primary:hover,
    .btn-primary:focus-visible {
      background-color: var(--color-primary-dark);
      border-color: var(--color-primary-dark);
      transform: translateY(-2px) scale(1.02);
      /* Efek hover lebih dinamis */
      box-shadow: var(--shadow-md);
    }

    .btn-primary:focus-visible {
      outline: 3px solid var(--color-primary-light);
      outline-offset: 2px;
    }

    .btn-secondary {
      background-color: var(--color-secondary);
      color: var(--color-surface);
      border-color: var(--color-secondary);
    }

    .btn-secondary:hover,
    .btn-secondary:focus-visible {
      background-color: var(--color-secondary-dark);
      border-color: var(--color-secondary-dark);
      transform: translateY(-2px) scale(1.02);
      box-shadow: var(--shadow-md);
    }

    .btn-outline {
      background-color: transparent;
      border-color: var(--color-border);
      color: var(--color-foreground);
    }

    .btn-outline:hover,
    .btn-outline:focus-visible {
      border-color: var(--color-primary);
      color: var(--color-primary);
      background-color: var(--color-primary-light);
    }

    .btn-error {
      background-color: var(--color-error);
      color: var(--color-surface);
      border-color: var(--color-error);
    }

    .btn-error:hover,
    .btn-error:focus-visible {
      background-color: hsl(0, 70%, 45%);
      border-color: hsl(0, 70%, 45%);
    }

    .btn-link {
      background-color: transparent;
      border-color: transparent;
      color: var(--color-primary);
      padding-left: var(--space-xs);
      padding-right: var(--space-xs);
      text-decoration: none;
    }

    .btn-link:hover,
    .btn-link:focus-visible {
      color: var(--color-primary-dark);
      text-decoration: underline;
    }

    .btn-sm {
      padding: var(--space-xs) var(--space-sm);
      font-size: var(--text-sm);
    }

    .btn-lg {
      padding: var(--space-md) var(--space-xl);
      font-size: var(--text-lg);
    }

    .btn-full {
      width: 100%;
    }

    /* KOMPONEN: FORMULIR (FORM) */
    .form-group {
      margin-bottom: var(--space-lg);
    }

    .form-group label {
      display: block;
      font-weight: 500;
      margin-bottom: var(--space-xs);
      color: var(--color-foreground);
    }

    .form-group input[type="text"],
    .form-group input[type="email"],
    .form-group input[type="password"],
    .form-group input[type="date"],
    .form-group input[type="number"],
    .form-group input[type="tel"],
    /* Tambah type tel */
    .form-group input[type="range"],
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: var(--space-sm) var(--space-md);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background-color: var(--color-surface);
      transition: var(--transition-fast);
      font-size: 1rem;
    }

    .form-group input[type="range"] {
      padding: 0;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px var(--color-primary-light);
    }

    .form-group textarea {
      min-height: 120px;
      resize: vertical;
    }

    .form-group input[type="checkbox"],
    .form-group input[type="radio"] {
      margin-right: var(--space-xs);
      accent-color: var(--color-primary);
      width: auto;
      vertical-align: middle;
    }

    .form-group .checkbox-label,
    .form-group .radio-label {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-weight: normal;
    }

    .search-form-quick .form-group {
      margin-bottom: 0;
    }

    /* Dihandle grid gap */

    /* KOMPONEN: KARTU (CARD) */
    .card {
      background-color: var(--color-surface);
      border-radius: var(--radius-xl);
      /* Lebih besar */
      box-shadow: var(--shadow-md);
      overflow: hidden;
      transition: var(--transition-base);
      display: flex;
      flex-direction: column;
      border: 1px solid var(--color-border);
      /* Border halus */
    }

    .card:hover,
    .card:focus-within {
      transform: translateY(-6px) scale(1.01);
      /* Efek hover lebih jelas */
      box-shadow: var(--shadow-lg);
    }

    .card-img {
      width: 100%;
      height: 240px;
      /* Sedikit lebih tinggi */
      object-fit: cover;
    }

    .card-body {
      padding: var(--space-lg);
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .card-title {
      font-size: 1.375rem;
      /* 22px */
      margin-bottom: var(--space-sm);
      color: var(--color-foreground);
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      font-weight: 600;
      /* Lebih bold untuk judul kartu */
    }

    .card-title .material-icons {
      color: var(--color-success);
      font-size: 1.1em;
    }

    .card-subtitle {
      font-size: 0.9rem;
      color: var(--color-foreground-muted);
      margin-bottom: var(--space-md);
    }

    .card-text {
      margin-bottom: var(--space-md);
      flex-grow: 1;
      font-size: var(--text-sm);
      color: var(--color-foreground-muted);
    }

    .card-details {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-sm);
      font-size: var(--text-sm);
    }

    .card-price {
      color: var(--color-primary);
      font-weight: 700;
      font-size: 1.2rem;
    }

    .card-location {
      display: flex;
      align-items: center;
      gap: var(--space-xxs);
      color: var(--color-foreground-muted);
    }

    .card-location .material-icons {
      font-size: 1.1em;
    }

    .card-features {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-sm);
      color: var(--color-foreground-muted);
      font-size: var(--text-sm);
      margin-bottom: var(--space-md);
    }

    .card-features span {
      display: inline-flex;
      align-items: center;
      gap: var(--space-xxs);
      background-color: var(--color-background);
      padding: var(--space-xxs) var(--space-xs);
      border-radius: var(--radius-sm);
    }

    .card-features .material-icons {
      font-size: 1.1em;
      color: var(--color-secondary);
    }

    .card-actions {
      margin-top: auto;
    }

    details.card-details-extra {
      padding: 0;
      /* Padding di-handle oleh summary dan konten */
      border-top: 1px solid var(--color-border);
      margin-top: var(--space-md);
    }

    details.card-details-extra summary {
      cursor: pointer;
      color: var(--color-primary);
      font-weight: 500;
      list-style: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-sm) var(--space-lg);
      /* Padding summary */
    }

    details.card-details-extra summary:focus-visible {
      outline: 2px solid var(--color-accent);
      outline-offset: 1px;
    }

    details.card-details-extra summary::-webkit-details-marker {
      display: none;
    }

    details.card-details-extra summary::after {
      content: 'expand_more';
      font-family: 'Material Icons';
      font-weight: normal;
      font-style: normal;
      font-size: 24px;
      line-height: 1;
      letter-spacing: normal;
      text-transform: none;
      display: inline-block;
      white-space: nowrap;
      word-wrap: normal;
      direction: ltr;
      -webkit-font-feature-settings: 'liga';
      -webkit-font-smoothing: antialiased;
      transition: transform 0.2s ease-in-out;
    }

    details.card-details-extra[open] summary::after {
      transform: rotate(180deg);
    }

    details.card-details-extra>div {
      /* Konten di dalam details */
      padding: 0 var(--space-lg) var(--space-lg);
      /* Padding untuk konten di bawah summary */
    }

    details.card-details-extra p,
    details.card-details-extra ul {
      margin-top: var(--space-sm);
      font-size: var(--text-sm);
    }

    details.card-details-extra ul {
      padding-left: var(--space-md);
      list-style: disc;
    }

    /* KOMPONEN: KUTIPAN (QUOTE) */
    blockquote.quote {
      font-style: italic;
      margin: var(--space-md) 0;
      padding: var(--space-md) var(--space-lg);
      /* Padding lebih besar */
      border-left: 5px solid var(--color-secondary);
      /* Border lebih tebal */
      background-color: var(--color-secondary-light);
      border-radius: 0 var(--radius-md) var(--radius-md) 0;
      color: var(--color-secondary-dark);
      /* Teks lebih kontras */
    }

    blockquote.quote p {
      margin-bottom: 0;
    }

    /* HEADER & NAVIGASI */
    .app-header {
      background-color: rgba(255, 255, 255, 0.85);
      /* Transparansi subtle */
      backdrop-filter: blur(10px);
      /* Efek glassmorphism */
      -webkit-backdrop-filter: blur(10px);
      padding-top: var(--space-md);
      padding-bottom: var(--space-md);
      position: sticky;
      top: 0;
      z-index: var(--z-index-sticky);
      box-shadow: var(--shadow-sm);
      border-bottom: 1px solid var(--color-border);
    }

    .navbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .nav-brand {
      font-size: 1.875rem;
      /* 30px */
      font-weight: 700;
      color: var(--color-primary);
      letter-spacing: -0.5px;
      text-decoration: none;
    }

    .nav-brand:hover {
      text-decoration: none;
      opacity: 0.85;
    }

    .nav-links {
      display: flex;
      gap: var(--space-lg);
      list-style: none;
    }

    .nav-link {
      font-weight: 500;
      color: var(--color-foreground);
      cursor: pointer;
      position: relative;
      padding: var(--space-xs) var(--space-sm);
      /* Padding agar area klik lebih baik */
      transition: var(--transition-fast);
      text-decoration: none;
      border-radius: var(--radius-sm);
      /* Radius halus */
    }

    .nav-link:hover,
    .nav-link.active {
      color: var(--color-primary-dark);
      text-decoration: none;
      background-color: var(--color-primary-light);
      /* Highlight background */
    }

    .nav-link::after {
      /* Hapus underline, pakai background highlight saja */
      content: '';
      display: none;
    }

    .nav-toggle {
      display: none;
      background: none;
      border: none;
      color: var(--color-foreground);
      font-size: 1.8rem;
      padding: var(--space-xs);
    }

    /* KONTEN UTAMA (MAIN CONTENT) */
    .main-content {
      padding-top: var(--space-xl);
      padding-bottom: var(--space-xl);
    }

    .page {
      display: block;
      animation: fadeInAnimation 0.5s ease-out forwards;
      opacity: 0;
    }

    .page.hidden {
      display: none !important;
      opacity: 0;
      animation: none;
    }

    /* HALAMAN PENCARIAN */
    .search-filters {
      background-color: var(--color-surface);
      padding: var(--space-lg);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-md);
      align-self: flex-start;
      border: 1px solid var(--color-border);
    }

    .search-filters h3 {
      margin-bottom: var(--space-lg);
      font-size: 1.25rem;
    }

    /* Judul filter lebih besar */
    .map-canvas {
      width: 100%;
      height: 200px;
      background-color: hsl(200, 20%, 95%);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-md);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-foreground-muted);
      font-style: italic;
      border: 1px solid var(--color-border);
      text-align: center;
    }

    .radius-display,
    .price-display {
      display: inline-block;
      min-width: 60px;
      /* Sedikit lebih lebar */
      font-weight: 600;
      color: var(--color-primary);
    }

    /* KALENDER (Penyempurnaan Desain) */
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: var(--space-xs);
      border: 1px solid var(--color-border);
      padding: var(--space-md);
      /* Padding lebih besar */
      border-radius: var(--radius-lg);
      /* Radius lebih besar */
      background-color: var(--color-surface);
    }

    .calendar-header {
      text-align: center;
      font-weight: 600;
      /* Header hari lebih bold */
      padding: var(--space-xs) 0;
      color: var(--color-foreground-muted);
      font-size: 0.8rem;
      /* Ukuran font lebih kecil */
    }

    .calendar-day {
      padding: var(--space-sm);
      text-align: center;
      border-radius: var(--radius-md);
      /* Radius lebih besar untuk sel */
      cursor: pointer;
      transition: var(--transition-fast);
      border: 1px solid transparent;
      line-height: 1;
      aspect-ratio: 1 / 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      /* Font tanggal lebih tebal */
    }

    .calendar-day:hover:not(.empty):not(.booked):not(.disabled),
    .calendar-day:focus-visible:not(.empty):not(.booked):not(.disabled) {
      background-color: var(--color-primary-light);
      border-color: var(--color-primary);
      color: var(--color-primary-dark);
      transform: scale(1.05);
      /* Efek hover */
    }

    .calendar-day.empty {
      cursor: default;
      visibility: hidden;
    }

    .calendar-day.disabled {
      background-color: hsl(0, 0%, 94%);
      color: var(--color-foreground-muted);
      cursor: not-allowed;
      text-decoration: line-through;
      opacity: 0.6;
    }

    .calendar-day.booked {
      background-color: hsl(0, 0%, 88%);
      color: var(--color-foreground-muted);
      cursor: not-allowed;
      text-decoration: line-through;
      font-style: italic;
    }

    .calendar-day.selected {
      background-color: var(--color-primary);
      color: var(--color-surface);
      border-color: var(--color-primary-dark);
      font-weight: bold;
      box-shadow: var(--shadow-sm);
    }

    .calendar-day.selected:hover {
      background-color: var(--color-primary-dark);
    }

    .calendar-day.today {
      font-weight: bold;
      border: 2px solid var(--color-secondary);
      /* Border hari ini lebih jelas */
      color: var(--color-secondary-dark);
    }

    .calendar-day.today.selected {
      border-color: var(--color-primary-dark);
      color: var(--color-surface);
    }

    .calendar-day.in-range {
      /* Untuk range tanggal */
      background-color: var(--color-primary-light);
      color: var(--color-primary-dark);
      border-radius: 0;
      /* Hilangkan radius jika bagian dari range */
    }

    .calendar-day.in-range.selected {
      /* Jika start/end date */
      border-radius: var(--radius-md);
    }

    .calendar-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-md);
    }

    .calendar-nav button {
      background: none;
      border: none;
      padding: var(--space-xs);
      color: var(--color-primary);
    }

    .calendar-nav button:hover,
    .calendar-nav button:focus-visible {
      background-color: var(--color-primary-light);
      border-radius: var(--radius-full);
    }

    .calendar-nav .material-icons {
      font-size: 1.5rem;
    }

    #currentMonthYearCalendarSearch,
    #currentMonthYearBookingCalendar {
      font-weight: 600;
      font-size: 1.1rem;
      /* Lebih besar dan bold */
      color: var(--color-foreground);
    }

    /* HALAMAN DETAIL APARTEMEN */
    .apartment-gallery {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      grid-template-rows: 200px 200px;
      /* Tinggi row diset */
      gap: var(--space-sm);
      margin-bottom: var(--space-xl);
      max-height: 416px;
      /* (200px * 2) + 16px gap */
      border-radius: var(--radius-xl);
      overflow: hidden;
    }

    .gallery-item {
      overflow: hidden;
      cursor: pointer;
      position: relative;
    }

    .gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .gallery-item:hover img,
    .gallery-item:focus-within img {
      transform: scale(1.08);
    }

    /* Efek hover lebih besar */
    .gallery-item:first-child {
      grid-row: 1 / span 2;
      grid-column: 1 / span 1;
    }

    .apartment-gallery.single-image .gallery-item:first-child {
      grid-column: 1 / -1;
      grid-row: 1 / -1;
    }

    .apartment-gallery.two-images .gallery-item:nth-child(1) {
      grid-column: 1 / span 1;
      grid-row: 1 / -1;
    }

    .apartment-gallery.two-images .gallery-item:nth-child(2) {
      grid-column: 2 / -1;
      grid-row: 1 / -1;
    }

    .virtual-tour-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.6);
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: var(--transition-base);
      pointer-events: none;
    }

    .gallery-item:first-child:hover .virtual-tour-overlay,
    .gallery-item:first-child:focus-within .virtual-tour-overlay {
      opacity: 1;
    }

    .virtual-tour-overlay .material-icons {
      font-size: 3.5rem;
      margin-bottom: var(--space-xs);
    }

    .apartment-details-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: var(--space-xl);
    }

    .booking-form-sticky {
      position: sticky;
      top: calc(var(--space-md) * 2 + 60px + var(--space-lg));
      /* Sesuaikan jika header berubah tinggi */
      align-self: flex-start;
      background-color: var(--color-surface);
      padding: var(--space-lg);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--color-border);
      /* Border halus */
    }

    .payment-methods {
      display: flex;
      gap: var(--space-sm);
      margin-bottom: var(--space-md);
    }

    .payment-method {
      padding: var(--space-sm) var(--space-md);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition-fast);
      flex-grow: 1;
      text-align: center;
      background-color: var(--color-surface);
      font-size: var(--text-sm);
      font-weight: 500;
      /* Font lebih tegas */
    }

    .payment-method:hover,
    .payment-method:focus-visible {
      border-color: var(--color-primary);
      background-color: var(--color-primary-light);
      color: var(--color-primary-dark);
      transform: translateY(-2px);
      /* Efek hover */
    }

    .payment-method.selected {
      border-color: var(--color-primary-dark);
      background-color: var(--color-primary);
      color: var(--color-surface);
      font-weight: 600;
      box-shadow: var(--shadow-sm);
    }

    .cost-breakdown {
      background-color: var(--color-primary-light);
      padding: var(--space-md);
      border-radius: var(--radius-lg);
      margin-top: var(--space-lg);
      border: 1px solid var(--color-primary);
    }

    .cost-breakdown h4 {
      margin-bottom: var(--space-sm);
      font-size: 1.1rem;
      font-weight: 600;
    }

    .cost-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: var(--space-xs);
      font-size: var(--text-sm);
    }

    .cost-line.total {
      font-weight: 700;
      font-size: 1.1rem;
      /* Total lebih menonjol */
      margin-top: var(--space-sm);
      padding-top: var(--space-sm);
      border-top: 2px solid var(--color-primary);
      /* Garis total lebih tebal */
    }

    .escrow-info {
      background-color: var(--color-warning-light);
      padding: var(--space-md);
      border-left: 4px solid var(--color-warning);
      margin: var(--space-lg) 0;
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      display: flex;
      align-items: flex-start;
      gap: var(--space-sm);
      /* Gap lebih besar */
    }

    .escrow-info .material-icons {
      color: var(--color-warning);
      font-size: 1.5em;
      /* Ikon lebih besar */
      margin-top: 1px;
    }

    .escrow-info p {
      margin-bottom: 0;
    }

    .review-item {
      border-bottom: 1px solid var(--color-border);
      padding-bottom: var(--space-lg);
      /* Padding lebih */
      margin-bottom: var(--space-lg);
      /* Margin lebih */
    }

    .review-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-xs);
    }

    .review-user {
      font-weight: 600;
    }

    .review-rating .material-icons {
      color: var(--color-accent);
      font-size: 1.2em;
      vertical-align: middle;
    }

    .review-comment {
      color: var(--color-foreground-muted);
      line-height: 1.5;
    }

    /* Jarak baris lebih nyaman */
    .report-form-container {
      background-color: hsl(0, 80%, 97%);
      /* Warna lebih soft error */
      padding: var(--space-lg);
      border-radius: var(--radius-lg);
      margin-top: var(--space-xl);
      border: 1px solid var(--color-error);
    }

    .report-form-container h3 {
      color: var(--color-error);
      font-size: 1.2rem;
    }

    /* HALAMAN PROFIL */
    .chat-window {
      height: 250px;
      /* Lebih tinggi */
      overflow-y: auto;
      border: 1px solid var(--color-border);
      padding: var(--space-md);
      border-radius: var(--radius-lg);
      /* Radius lebih */
      background-color: hsl(210, 20%, 97%);
      /* Warna background chat lebih soft */
      margin-bottom: var(--space-sm);
    }

    .chat-message {
      margin-bottom: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      /* Padding lebih */
      border-radius: var(--radius-lg);
      max-width: 80%;
      /* Max width lebih besar */
      word-wrap: break-word;
      line-height: 1.5;
      box-shadow: var(--shadow-xs);
      /* Shadow halus */
    }

    .chat-message.sent {
      background-color: var(--color-primary);
      color: var(--color-surface);
      margin-left: auto;
      border-bottom-right-radius: var(--radius-sm);
      /* Sudut berbeda */
    }

    .chat-message.received {
      background-color: var(--color-surface);
      border: 1px solid var(--color-border);
      margin-right: auto;
      border-bottom-left-radius: var(--radius-sm);
      /* Sudut berbeda */
    }

    .chat-message.system {
      background-color: var(--color-secondary-light);
      color: var(--color-secondary-dark);
      font-size: var(--text-sm);
      text-align: center;
      max-width: 100%;
      padding: var(--space-xs);
      font-style: italic;
      box-shadow: none;
    }

    .chat-input-group {
      display: flex;
      gap: var(--space-sm);
    }

    .chat-input-group input {
      flex-grow: 1;
    }

    .chat-input-group button .material-icons {
      font-size: 1.3rem;
    }

    .loyalty-badge {
      background-color: var(--color-accent);
      color: var(--color-surface);
      padding: var(--space-xs) var(--space-sm);
      /* Padding lebih */
      border-radius: var(--radius-md);
      font-size: 0.85rem;
      /* Sedikit lebih besar */
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: var(--space-xxs);
      vertical-align: middle;
    }

    .loyalty-badge .material-icons {
      font-size: 1em;
    }

    /* Untuk ikon di badge jika ada */
    .notification-item {
      background-color: var(--color-surface);
      /* Surface color */
      padding: var(--space-md);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-sm);
      border-left: 5px solid var(--color-secondary);
      /* Border lebih tebal dan beda warna */
      box-shadow: var(--shadow-sm);
      /* Shadow halus */
    }

    .notification-item p {
      margin-bottom: var(--space-xs);
    }

    .notification-item p:last-child {
      margin-bottom: 0;
    }

    /* CHATBOX GLOBAL */
    .global-chat-btn {
      position: fixed;
      bottom: var(--space-lg);
      right: var(--space-lg);
      z-index: var(--z-index-chatbox);
      border-radius: var(--radius-full);
      width: 64px;
      height: 64px;
      /* Lebih besar */
      padding: 0;
      box-shadow: var(--shadow-xl);
      /* Shadow lebih kuat */
      /* Warna dan style dari .btn-primary otomatis terpakai */
    }

    .global-chat-btn .material-icons {
      font-size: 2.25rem;
    }

    /* Ikon lebih besar */
    .chatbox-widget {
      position: fixed;
      bottom: calc(var(--space-lg) + 70px + var(--space-md));
      /* Disesuaikan */
      right: var(--space-lg);
      width: 350px;
      /* Lebih lebar */
      background-color: var(--color-surface);
      border-radius: var(--radius-xl);
      /* Radius lebih */
      box-shadow: var(--shadow-xl);
      display: flex;
      flex-direction: column;
      height: 500px;
      /* Lebih tinggi */
      z-index: var(--z-index-chatbox);
      overflow: hidden;
      transform: translateY(20px) scale(0.95);
      opacity: 0;
      visibility: hidden;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease, visibility 0s 0.3s;
      border: 1px solid var(--color-border);
      /* Border halus */
    }

    .chatbox-widget.open {
      transform: translateY(0) scale(1);
      opacity: 1;
      visibility: visible;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease, visibility 0s 0s;
    }

    .chatbox-header {
      background-color: var(--color-primary);
      color: var(--color-surface);
      padding: var(--space-md) var(--space-lg);
      /* Padding horizontal lebih */
      font-weight: 600;
      /* Lebih bold */
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chatbox-header .close-chat-btn {
      background: none;
      border: none;
      color: var(--color-surface);
      opacity: 0.8;
      padding: var(--space-xs);
    }

    .chatbox-header .close-chat-btn:hover,
    .chatbox-header .close-chat-btn:focus-visible {
      opacity: 1;
      background-color: rgba(255, 255, 255, 0.15);
      border-radius: var(--radius-full);
    }

    .chatbox-header .close-chat-btn .material-icons {
      font-size: 1.5rem;
    }

    /* Ikon close lebih besar */
    .chatbox-body {
      flex-grow: 1;
      overflow-y: auto;
      padding: var(--space-md);
      background-color: hsl(210, 20%, 97%);
      /* Sama dengan chat profil */
    }

    .chatbox-input-area {
      display: flex;
      padding: var(--space-sm);
      border-top: 1px solid var(--color-border);
      background-color: var(--color-surface);
    }

    .chatbox-input-area input {
      flex-grow: 1;
      border-right: none;
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
      padding: var(--space-sm) var(--space-md);
      /* Padding input lebih nyaman */
    }

    .chatbox-input-area button {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
      padding-left: var(--space-md);
      padding-right: var(--space-md);
      background-color: var(--color-primary);
      color: var(--color-surface);
      border: 1px solid var(--color-primary);
    }

    .chatbox-input-area button:hover,
    .chatbox-input-area button:focus-visible {
      background-color: var(--color-primary-dark);
      border-color: var(--color-primary-dark);
    }

    .chatbox-input-area button .material-icons {
      font-size: 1.5rem;
    }

    /* FOOTER */
    .app-footer {
      background-color: var(--color-foreground);
      color: hsl(0, 0%, 90%);
      /* Kontras lebih baik */
      padding: var(--space-xl) 0 var(--space-xxl);
      /* Padding bawah lebih besar */
      text-align: center;
      font-size: var(--text-sm);
      margin-top: auto;
    }

    .app-footer p {
      margin-bottom: var(--space-xs);
    }

    .app-footer p:last-child {
      margin-bottom: 0;
    }

    .app-footer a {
      color: var(--color-surface);
      text-decoration: underline;
    }

    .app-footer a:hover,
    .app-footer a:focus-visible {
      color: var(--color-primary-light);
      text-decoration: none;
    }

    .app-footer .material-icons {
      font-size: 1em;
      vertical-align: middle;
      color: var(--color-accent);
    }

    /* MODAL */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(30, 40, 50, 0.7);
      /* Latar lebih gelap dan kebiruan */
      backdrop-filter: blur(5px);
      /* Efek blur halus */
      -webkit-backdrop-filter: blur(5px);
      z-index: var(--z-index-modal-backdrop);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-md);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0s 0.3s;
    }

    .modal-backdrop.open {
      opacity: 1;
      visibility: visible;
      transition-delay: 0s;
    }

    .modal-content {
      background-color: var(--color-surface);
      padding: var(--space-xl);
      border-radius: var(--radius-xl);
      /* Radius lebih besar */
      box-shadow: var(--shadow-xl);
      width: 100%;
      max-width: 640px;
      /* Max lebar modal lebih besar */
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.95) translateY(20px);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid var(--color-border);
      /* Border halus */
    }

    .modal-backdrop.open .modal-content {
      transform: scale(1) translateY(0);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-lg);
      padding-bottom: var(--space-md);
      border-bottom: 1px solid var(--color-border);
    }

    .modal-title {
      margin-bottom: 0;
      font-size: 1.5rem;
      /* Judul modal lebih besar */
      font-weight: 600;
    }

    .modal-close-btn {
      background: none;
      border: none;
      font-size: 2rem;
      /* Ikon close lebih besar */
      color: var(--color-foreground-muted);
      padding: 0;
      line-height: 1;
      transition: var(--transition-fast);
      /* Transisi untuk hover */
    }

    .modal-close-btn:hover,
    .modal-close-btn:focus-visible {
      color: var(--color-error);
      transform: scale(1.1) rotate(90deg);
      /* Efek hover menarik */
    }

    .modal-close-btn .material-icons {
      font-size: inherit;
    }

    .modal-body img {
      max-width: 100%;
      height: auto;
      max-height: 70vh;
      object-fit: contain;
      border-radius: var(--radius-lg);
      /* Radius gambar */
      margin: 0 auto;
      display: block;
    }

    .modal-body p {
      margin-bottom: var(--space-sm);
    }

    .modal-body p:last-child {
      margin-bottom: 0;
    }

    /* RESPONSIVE DESIGN */
    @media (min-width: 769px) {

      /* Medium screens and up (md) */
      .md\:grid-cols-3 {
        grid-template-columns: repeat(3, 1fr);
      }

      .search-filters,
      .booking-form-sticky {
        position: sticky;
        top: calc(var(--app-header-height, 70px) + var(--space-lg));
        /* Dinamis dengan tinggi header + margin */
      }
    }

    @media (min-width: 1025px) {

      /* Large screens and up (lg) */
      .lg\:grid-cols-12 {
        grid-template-columns: repeat(12, 1fr);
      }

      .lg\:col-span-1 {
        grid-column: span 1 / span 1;
      }

      .lg\:col-span-2 {
        grid-column: span 2 / span 2;
      }

      .lg\:col-span-3 {
        grid-column: span 3 / span 3;
      }

      .lg\:col-span-4 {
        grid-column: span 4 / span 4;
      }

      .lg\:col-span-8 {
        grid-column: span 8 / span 8;
      }
    }

    @media (max-width: 1024px) {

      /* Tablet dan di bawahnya */
      .apartment-details-grid {
        grid-template-columns: 1fr;
      }

      .search-filters,
      .booking-form-sticky {
        position: static;
        width: 100%;
        margin-bottom: var(--space-xl);
        top: auto;
      }

      .grid-cols-autofit-300 {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }

      :root {
        --app-header-height: 60px;
        /* Sesuaikan jika tinggi header berubah di mobile */
      }
    }

    @media (max-width: 768px) {

      /* Mobile (sm) */
      .container {
        padding-left: var(--space-md);
        padding-right: var(--space-md);
      }

      h1 {
        font-size: 2rem;
      }

      /* Sedikit lebih kecil dari desktop, tapi tetap besar */
      h2 {
        font-size: 1.625rem;
      }

      h3 {
        font-size: 1.375rem;
      }

      .nav-links {
        display: none;
        flex-direction: column;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: var(--color-surface);
        box-shadow: var(--shadow-lg);
        /* Shadow lebih kuat */
        padding: var(--space-md);
        border-top: 1px solid var(--color-border);
        z-index: calc(var(--z-index-sticky) - 1);
        border-bottom-left-radius: var(--radius-lg);
        /* Radius di mobile menu */
        border-bottom-right-radius: var(--radius-lg);
      }

      .nav-links.open {
        display: flex;
      }

      .nav-link {
        padding: var(--space-md) var(--space-lg);
        /* Padding lebih besar di mobile */
        width: 100%;
        text-align: left;
      }

      .nav-link.active {
        background-color: var(--color-primary-light);
        border-radius: var(--radius-md);
        color: var(--color-primary-dark);
        font-weight: 600;
        /* Lebih jelas */
      }

      .nav-toggle {
        display: block;
      }

      .grid-cols-2,
      .grid-cols-3,
      .grid-cols-4,
      .grid-cols-autofit-200,
      .grid-cols-autofit-250,
      .grid-cols-autofit-300,
      .md\:grid-cols-3 {
        grid-template-columns: 1fr;
      }

      .apartment-gallery {
        grid-template-columns: 1fr;
        grid-template-rows: auto;
        max-height: none;
        gap: var(--space-md);
        /* Gap lebih besar di mobile */
      }

      .gallery-item:first-child {
        grid-row: auto;
        grid-column: auto;
      }

      .gallery-item img {
        height: 280px;
      }

      /* Tinggi gambar galeri lebih konsisten */
      .gallery-item:first-child img {
        height: 320px;
      }

      .chatbox-widget {
        width: calc(100vw - (var(--space-md) * 2));
        max-width: 350px;
        /* Max width chatbox */
        height: 75vh;
        max-height: 450px;
        /* Disesuaikan */
        bottom: var(--space-lg);
        /* Langsung di atas footer (kurang lebih) */
        right: var(--space-md);
        left: var(--space-md);
        margin: 0 auto;
      }

      .global-chat-btn {
        width: 56px;
        height: 56px;
        bottom: var(--space-md);
        right: var(--space-md);
      }

      .global-chat-btn .material-icons {
        font-size: 1.8rem;
      }

      .form-group input[type="date"] {
        font-size: 1rem;
        /* Ukuran font tanggal normal kembali */
      }

      .search-form-quick .grid,
      .search-form-quick .md\:grid-cols-3 {
        grid-template-columns: 1fr;
      }

      .search-form-quick .form-group {
        margin-bottom: var(--space-md);
      }

      .payment-methods {
        flex-direction: column;
      }
    }

    /* AKSESIBILITAS */
    @media (prefers-reduced-motion: reduce) {

      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }

    a:focus-visible,
    button:focus-visible,
    input:focus-visible,
    select:focus-visible,
    textarea:focus-visible,
    details>summary:focus-visible,
    [tabindex="0"]:focus-visible {
      outline: 3px solid var(--color-accent) !important;
      outline-offset: 2px !important;
      box-shadow: 0 0 0 3px var(--color-accent), var(--shadow-md) !important;
      /* Tambah shadow asli juga */
    }
  </style>
</head>

<body>

  <!-- Header Aplikasi -->
  <header class="app-header" id="appHeader">
    <div class="container">
      <nav class="navbar" aria-label="Navigasi utama">
        <a href="#home" class="nav-brand">Green Valley</a>
        <button class="nav-toggle" id="navToggleBtn" aria-label="Buka menu navigasi" aria-expanded="false"
          aria-controls="navLinksMenu">
          <span class="material-icons">menu</span>
        </button>
        <ul class="nav-links" id="navLinksMenu" role="menubar">
          <li role="none"><a href="#home" class="nav-link active" data-page="home" role="menuitem">Beranda</a>
          </li>
          <li role="none"><a href="#search" class="nav-link" data-page="search" role="menuitem">Pencarian</a>
          </li>
          <li role="none"><a href="#profile" class="nav-link" data-page="profile" role="menuitem">Profil</a>
          </li>
          <li role="none"><a href="#support" class="nav-link" data-page="support" role="menuitem">Dukungan</a>
          </li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Konten Utama Aplikasi -->
  <main class="main-content container">
    <!-- Halaman Beranda -->
    <section id="home" class="page" aria-labelledby="home-title">
      <h1 id="home-title" class="text-center font-bold mb-md">Temukan Apartemen Impian Anda di Green Valley</h1>
      <p class="text-center text-lg text-muted mb-xl">Sewa apartemen modern dengan fasilitas premium, aman, dan
        terpercaya untuk gaya hidup urban Anda.</p>

      <!-- Pencarian Cepat -->
      <form class="search-form-quick card p-lg shadow-lg mb-xl" id="quickSearchForm" role="search">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-md items-end">
          <div class="form-group">
            <label for="quick-location">Lokasi Impian Anda</label>
            <input type="text" id="quick-location" placeholder="Masukkan kota atau nama area"
              aria-label="Cari lokasi">
          </div>
          <div class="form-group">
            <label for="quick-checkin">Tanggal Check-in</label>
            <input type="date" id="quick-checkin" aria-label="Tanggal check-in" min="">
          </div>
          <div class="form-group">
            <label for="quick-checkout">Tanggal Check-out</label>
            <input type="date" id="quick-checkout" aria-label="Tanggal check-out" min="">
          </div>
        </div>
        <button type="submit" class="btn btn-primary btn-lg btn-full mt-lg">
          <i class="material-icons">search</i>Cari Apartemen
        </button>
      </form>

      <!-- Properti Unggulan -->
      <h2 class="font-semibold mt-xl mb-lg" id="featured-properties-title">Properti Unggulan Pilihan Kami</h2>
      <div class="grid grid-cols-autofit-300 gap-lg mb-xl" id="featuredProperties"
        aria-labelledby="featured-properties-title">
        <p id="loadingFeaturedMessage" class="text-muted col-span-full text-center p-xl">Memuat properti
          unggulan...</p>
      </div>

      <!-- Testimoni -->
      <h2 class="font-semibold mt-xl mb-lg" id="testimonials-title">Apa Kata Mereka Tentang Green Valley?</h2>
      <div class="grid grid-cols-autofit-300 gap-lg" aria-labelledby="testimonials-title">
        <div class="card p-lg">
          <blockquote class="quote">
            <p>"Proses pemesanan di Green Valley sangat mudah dan cepat. Apartemennya juga sesuai dengan
              deskripsi. Sangat direkomendasikan!"</p>
          </blockquote>
          <p class="font-medium mt-md">- Anisa Wulandari</p>
          <p class="text-sm text-muted">Penyewa Terverifikasi</p>
        </div>
        <div class="card p-lg">
          <blockquote class="quote">
            <p>"Saya menemukan apartemen studio yang sempurna untuk perjalanan bisnis saya. Fasilitas lengkap
              dan lokasi strategis. Terima kasih Green Valley!"</p>
          </blockquote>
          <p class="font-medium mt-md">- Budi Santoso</p>
          <p class="text-sm text-muted">Profesional Muda</p>
        </div>
        <div class="card p-lg">
          <blockquote class="quote">
            <p>"Pelayanan pelanggan sangat responsif. Mereka membantu saya menyelesaikan masalah kecil dengan
              cepat. Pengalaman yang menyenangkan!"</p>
          </blockquote>
          <p class="font-medium mt-md">- Citra Dewi</p>
          <p class="text-sm text-muted">Keluarga Bahagia</p>
        </div>
      </div>
    </section>

    <!-- Halaman Pencarian -->
    <section id="search" class="page hidden" aria-labelledby="search-title">
      <h1 id="search-title" class="font-bold mb-lg">Cari Apartemen Sesuai Keinginan Anda</h1>
      <div class="grid md:grid-cols-1 lg:grid-cols-12 gap-xl">
        <aside class="lg:col-span-4">
          <form class="search-filters" id="detailedSearchForm" role="search">
            <h3 class="font-semibold mb-md">Filter Pencarian</h3>
            <div class="form-group">
              <label for="search-location">Lokasi</label>
              <input type="text" id="search-location" placeholder="cth: Jakarta Selatan">
              <div class="map-canvas mt-sm" id="searchMapCanvas" aria-label="Peta interaktif (simulasi)">Memuat
                simulasi peta...</div>
            </div>
            <div class="form-group">
              <label for="search-radius">Radius Pencarian (Simulasi)</label>
              <input type="range" min="1" max="20" value="5" id="search-radius" class="w-full"
                aria-label="Filter radius pencarian (simulasi)">
              <p class="text-sm text-muted">Jarak: <span id="radiusValueDisplay" class="radius-display">5</span>
                km</p>
            </div>
            <div class="form-group">
              <label>Tanggal Ketersediaan</label>
              <div class="calendar-nav">
                <button type="button" id="prevMonthBtnCalendarSearch" aria-label="Bulan sebelumnya"><i
                    class="material-icons">chevron_left</i></button>
                <span id="currentMonthYearCalendarSearch" class="font-medium"
                  aria-live="polite">Memuat...</span>
                <button type="button" id="nextMonthBtnCalendarSearch" aria-label="Bulan berikutnya"><i
                    class="material-icons">chevron_right</i></button>
              </div>
              <div class="calendar" id="searchPageCalendar" role="grid" aria-label="Kalender ketersediaan">
                <p class="text-muted col-span-full text-center p-md">Memuat kalender...</p>
              </div>
              <div class="flex gap-sm mt-sm">
                <input type="date" id="search-checkin-date" class="w-1/2" aria-label="Tanggal check-in terpilih"
                  readonly>
                <input type="date" id="search-checkout-date" class="w-1/2"
                  aria-label="Tanggal check-out terpilih" readonly>
              </div>
            </div>
            <div class="form-group">
              <label for="search-price">Rentang Harga (per bulan)</label>
              <input type="range" min="5000000" max="50000000" value="15000000" step="500000" id="search-price"
                class="w-full" aria-label="Filter harga maksimum per bulan">
              <p class="text-sm text-muted">Maks: Rp <span id="priceValueDisplay"
                  class="price-display">15.000.000</span></p>
            </div>
            <fieldset class="form-group">
              <legend class="font-medium mb-xs">Fasilitas Utama</legend>
              <div class="grid grid-cols-2 gap-sm">
                <label class="checkbox-label text-sm"><input type="checkbox" name="amenities" value="pool">
                  Kolam Renang</label>
                <label class="checkbox-label text-sm"><input type="checkbox" name="amenities" value="gym">
                  Gym</label>
                <label class="checkbox-label text-sm"><input type="checkbox" name="amenities" value="wifi"> WiFi
                  Cepat</label>
                <label class="checkbox-label text-sm"><input type="checkbox" name="amenities" value="parking">
                  Parkir</label>
                <label class="checkbox-label text-sm"><input type="checkbox" name="amenities" value="ac">
                  AC</label>
                <label class="checkbox-label text-sm"><input type="checkbox" name="amenities" value="laundry">
                  Laundry</label>
                <label class="checkbox-label text-sm"><input type="checkbox" name="amenities" value="kitchen">
                  Dapur</label>
                <label class="checkbox-label text-sm"><input type="checkbox" name="amenities"
                    value="pet-friendly"> Ramah Hewan</label>
              </div>
            </fieldset>
            <div class="form-group">
              <label for="search-apartment-type">Tipe Apartemen</label>
              <select id="search-apartment-type">
                <option value="">Semua Tipe</option>
                <option value="studio">Studio</option>
                <option value="1br">1 Kamar Tidur</option>
                <option value="2br">2 Kamar Tidur</option>
                <option value="3br+">3+ Kamar Tidur</option>
                <option value="penthouse">Penthouse</option>
                <option value="loft">Loft</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary btn-full mt-md">
              <i class="material-icons">filter_alt</i>Terapkan Filter
            </button>
            <button type="reset" class="btn btn-outline btn-full mt-sm" id="resetSearchFiltersBtn">
              <i class="material-icons">refresh</i>Reset Filter
            </button>
          </form>
        </aside>
        <div class="lg:col-span-8">
          <h2 class="font-semibold mb-md" id="search-results-title">Hasil Pencarian (<span
              id="searchResultsCount">0</span> apartemen ditemukan)</h2>
          <div class="grid grid-cols-autofit-250 gap-lg" id="searchResultsContainer"
            aria-labelledby="search-results-title">
            <p id="noResultsMessage" class="text-muted text-center col-span-full hidden p-xl">Maaf, tidak ada
              apartemen yang sesuai dengan kriteria Anda. Coba ubah filter pencarian.</p>
            <p id="loadingSearchResultsMessage" class="text-muted col-span-full text-center p-xl">Memuat hasil
              pencarian...</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Halaman Detail Apartemen -->
    <section id="apartment" class="page hidden" aria-live="polite">
      <div id="apartmentDetailContent">
        <p class="text-center text-lg text-muted p-xl">Memuat detail apartemen...</p>
      </div>
    </section>

    <!-- Halaman Profil Pengguna -->
    <section id="profile" class="page hidden" aria-labelledby="profile-title">
      <h1 id="profile-title" class="font-bold mb-lg">Profil Pengguna Green Valley</h1>
      <div class="grid md:grid-cols-1 lg:grid-cols-3 gap-xl">
        <div class="lg:col-span-2">
          <div class="card p-lg mb-xl">
            <h2 class="font-semibold mb-md">Informasi Akun</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-md">
              <div>
                <p><strong>Nama:</strong> <span id="profileName">Ani Wulandari</span></p>
                <p><strong>Email:</strong> <span id="profileEmail">ani.wulandari@example.com</span></p>
                <p><strong>Telepon:</strong> <span id="profilePhone">+62 812 3456 7890</span></p>
              </div>
              <div>
                <p><strong>Poin Loyalitas:</strong> <span id="profileLoyaltyPoints" class="loyalty-badge"><i
                      class="material-icons">star</i> 1250</span></p>
                <p><strong>Member Sejak:</strong> <span id="profileMemberSince">15 Januari 2023</span></p>
              </div>
            </div>
            <button class="btn btn-outline mt-lg btn-sm">
              <i class="material-icons">edit</i>Edit Profil
            </button>
          </div>

          <div class="card p-lg mb-xl">
            <h2 class="font-semibold mb-md">Pesan dengan Pemilik/Admin (Simulasi)</h2>
            <div class="chat-window" id="profileChatWindow" aria-live="polite">
              <div class="chat-message received">Halo! Ada yang bisa saya bantu terkait properti di Sudirman?
              </div>
              <div class="chat-message sent">Halo, saya ingin bertanya tentang ketersediaan parkir mobil. Apakah
                sudah termasuk dalam biaya sewa?</div>
              <div class="chat-message system">Admin telah membaca pesan Anda.</div>
            </div>
            <form id="profileChatForm" class="chat-input-group" aria-label="Formulir chat profil">
              <input type="text" id="profileChatInput" placeholder="Ketik pesan Anda di sini..."
                aria-label="Input pesan chat profil">
              <button type="submit" class="btn btn-primary" aria-label="Kirim pesan chat profil">
                <i class="material-icons">send</i><span class="sr-only">Kirim</span>
              </button>
            </form>
          </div>
        </div>

        <div class="lg:col-span-1">
          <div class="card p-lg mb-xl">
            <h2 class="font-semibold mb-md" id="booking-history-title">Riwayat Pemesanan</h2>
            <div id="bookingHistoryContainer" aria-labelledby="booking-history-title">
              <p class="text-sm text-muted p-md">Memuat riwayat pemesanan...</p>
            </div>
            <button class="btn btn-link btn-sm mt-md" id="loadMoreBookingsBtn">Lihat Semua Riwayat</button>
          </div>

          <div class="card p-lg">
            <h2 class="font-semibold mb-md" id="notifications-title">Notifikasi Terbaru</h2>
            <div id="notificationsContainer" aria-labelledby="notifications-title">
              <div class="notification-item">
                <p class="font-medium">Pembayaran Berhasil!</p>
                <p class="text-sm">Pembayaran untuk "Apartemen Senayan View" telah dikonfirmasi.</p>
                <p class="text-xs text-muted mt-xs">2 jam lalu</p>
              </div>
              <div class="notification-item">
                <p class="font-medium">Pengingat Check-in</p>
                <p class="text-sm">Check-in Anda untuk "Studio Harmoni Pusat Kota" adalah besok.</p>
                <p class="text-xs text-muted mt-xs">1 hari lalu</p>
              </div>
              <p id="noNotificationsMessage" class="text-sm text-muted hidden p-md">Tidak ada notifikasi baru.
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Halaman Dukungan Pelanggan -->
    <section id="support" class="page hidden" aria-labelledby="support-title">
      <h1 id="support-title" class="font-bold mb-lg text-center">Pusat Bantuan Green Valley</h1>
      <p class="text-lg text-muted mb-xl text-center">Kami siap membantu Anda 24/7. Pilih metode dukungan yang
        paling nyaman.</p>
      <div class="grid grid-cols-autofit-300 gap-lg">
        <div class="card p-lg text-center">
          <i class="material-icons text-primary mb-md" style="font-size: 3.5rem;"
            aria-hidden="true">chat_bubble</i>
          <h3 class="font-semibold">Live Chat</h3>
          <p class="text-muted mb-md">Dapatkan bantuan instan dari tim dukungan kami.</p>
          <button class="btn btn-primary mt-auto" onclick="app.ui.openGlobalChat()">
            <i class="material-icons">question_answer</i>Mulai Chat Sekarang
          </button>
        </div>
        <div class="card p-lg text-center">
          <i class="material-icons text-primary mb-md" style="font-size: 3.5rem;" aria-hidden="true">email</i>
          <h3 class="font-semibold">Kirim Email</h3>
          <p class="text-muted mb-md">Hubungi kami melalui email untuk pertanyaan lebih detail.</p>
          <a href="mailto:dukungan@greenvalley.app" class="btn btn-primary mt-auto">
            <i class="material-icons">send</i>dukungan@greenvalley.app
          </a>
        </div>
        <div class="card p-lg text-center">
          <i class="material-icons text-primary mb-md" style="font-size: 3.5rem;"
            aria-hidden="true">support_agent</i>
          <h3 class="font-semibold">Hubungi Kami</h3>
          <p class="text-muted mb-md">Bicaralah langsung dengan agen kami untuk solusi cepat.</p>
          <a href="tel:+6280012345678" class="btn btn-primary mt-auto">
            <i class="material-icons">call</i>+62 800 1234 5678
          </a>
        </div>
      </div>

      <div class="mt-xl card p-lg">
        <h2 class="font-semibold mb-lg text-center">Pertanyaan Umum (FAQ)</h2>
        <details class="card-details-extra mb-sm">
          <summary>Bagaimana cara melakukan pemesanan?</summary>
          <div>
            <p>Cari apartemen yang Anda inginkan menggunakan filter di halaman Pencarian. Pilih tanggal yang
              tersedia pada kalender, lalu klik tombol "Lihat Detail". Pada halaman detail, Anda dapat mengisi
              form pemesanan dan memilih metode pembayaran. Ikuti langkah-langkah hingga selesai.</p>
          </div>
        </details>
        <details class="card-details-extra mb-sm">
          <summary>Apakah pembayaran aman?</summary>
          <div>
            <p>Ya, semua transaksi pembayaran di Green Valley dijamin aman. Kami menggunakan enkripsi terkini
              untuk melindungi data Anda. Untuk penyewaan, kami juga menerapkan sistem escrow dimana dana Anda
              akan kami tahan dan baru diteruskan ke pemilik setelah Anda berhasil check-in.</p>
          </div>
        </details>
        <details class="card-details-extra">
          <summary>Bagaimana jika saya ingin membatalkan pesanan?</summary>
          <div>
            <p>Kebijakan pembatalan berbeda untuk setiap properti dan biasanya tercantum pada halaman detail
              apartemen. Silakan periksa syarat dan ketentuan pembatalan sebelum melakukan pemesanan. Jika Anda
              memerlukan bantuan lebih lanjut terkait pembatalan, hubungi tim dukungan kami.</p>
          </div>
        </details>
      </div>
    </section>

    <!-- Halaman Kebijakan Privasi (Contoh) -->
    <section id="privacy" class="page hidden" aria-labelledby="privacy-title">
      <h1 id="privacy-title" class="font-bold mb-lg">Kebijakan Privasi</h1>
      <div class="card p-lg">
        <p>Di Green Valley, kami menghargai privasi Anda. Kebijakan Privasi ini menjelaskan bagaimana kami
          mengumpulkan, menggunakan, mengungkapkan, dan melindungi informasi pribadi Anda saat Anda menggunakan
          layanan kami.</p>
        <h3 class="font-semibold mt-md mb-sm">Informasi yang Kami Kumpulkan</h3>
        <p>Kami dapat mengumpulkan informasi pribadi seperti nama, alamat email, nomor telepon, dan detail
          pembayaran saat Anda mendaftar, melakukan pemesanan, atau berinteraksi dengan platform kami.</p>
        <h3 class="font-semibold mt-md mb-sm">Penggunaan Informasi</h3>
        <p>Informasi Anda digunakan untuk memproses transaksi, menyediakan layanan pelanggan, mempersonalisasi
          pengalaman Anda, dan meningkatkan platform kami. Kami tidak akan membagikan informasi pribadi Anda
          kepada pihak ketiga tanpa persetujuan Anda, kecuali diwajibkan oleh hukum.</p>
        <h3 class="font-semibold mt-md mb-sm">Keamanan Data</h3>
        <p>Kami menerapkan langkah-langkah keamanan teknis dan organisasi yang sesuai untuk melindungi informasi
          pribadi Anda dari akses, penggunaan, atau pengungkapan yang tidak sah.</p>
        <p class="mt-lg">Untuk detail lebih lanjut, silakan hubungi kami di <a
            href="mailto:privacy@greenvalley.app">privacy@greenvalley.app</a>.</p>
      </div>
    </section>

    <!-- Halaman Syarat & Ketentuan (Contoh) -->
    <section id="terms" class="page hidden" aria-labelledby="terms-title">
      <h1 id="terms-title" class="font-bold mb-lg">Syarat & Ketentuan</h1>
      <div class="card p-lg">
        <p>Selamat datang di Green Valley! Dengan menggunakan platform kami, Anda setuju untuk mematuhi Syarat
          dan Ketentuan berikut:</p>
        <h3 class="font-semibold mt-md mb-sm">Penggunaan Platform</h3>
        <ol class="list-decimal pl-lg">
          <li class="mb-sm">Anda bertanggung jawab atas keakuratan informasi yang Anda berikan.</li>
          <li class="mb-sm">Penggunaan platform untuk tujuan ilegal atau melanggar hukum dilarang keras.</li>
          <li class="mb-sm">Green Valley berhak untuk menangguhkan atau menghentikan akun Anda jika terjadi
            pelanggaran terhadap syarat ini.</li>
        </ol>
        <h3 class="font-semibold mt-md mb-sm">Pemesanan dan Pembayaran</h3>
        <p>Semua pemesanan tunduk pada ketersediaan dan konfirmasi. Harga dapat berubah tanpa pemberitahuan
          sebelumnya. Kebijakan pembatalan berlaku dan dapat berbeda untuk setiap properti.</p>
        <h3 class="font-semibold mt-md mb-sm">Batasan Tanggung Jawab</h3>
        <p>Green Valley tidak bertanggung jawab atas kerugian atau kerusakan tidak langsung yang timbul dari
          penggunaan platform kami. Tanggung jawab kami terbatas pada jumlah yang Anda bayarkan untuk layanan
          tersebut.</p>
        <p class="mt-lg">Jika Anda memiliki pertanyaan mengenai Syarat & Ketentuan ini, silakan hubungi kami di
          <a href="mailto:legal@greenvalley.app">legal@greenvalley.app</a>.</p>
      </div>
    </section>
  </main>

  <!-- Tombol Chat Global Mengambang -->
  <button class="btn btn-primary global-chat-btn" id="globalChatToggleBtn" aria-label="Buka chat dukungan"
    aria-haspopup="true" aria-expanded="false">
    <i class="material-icons">chat_bubble</i>
  </button>

  <!-- Widget Chatbox Global -->
  <div class="chatbox-widget" id="globalChatbox" role="dialog" aria-modal="true" aria-labelledby="chatboxTitle"
    hidden>
    <div class="chatbox-header">
      <span id="chatboxTitle">Dukungan Pelanggan Green Valley</span>
      <button class="close-chat-btn" id="closeChatboxBtn" aria-label="Tutup chat">
        <i class="material-icons">close</i>
      </button>
    </div>
    <div class="chatbox-body" id="globalChatBody" aria-live="polite">
      <div class="chat-message system">Selamat datang di Green Valley! Ada yang bisa kami bantu hari ini?</div>
    </div>
    <form class="chatbox-input-area" id="globalChatForm" aria-label="Formulir chat dukungan">
      <input type="text" id="globalChatInput" placeholder="Ketik pertanyaan Anda..."
        aria-label="Input pesan chat dukungan">
      <button type="submit" class="btn btn-primary" aria-label="Kirim pesan chat dukungan">
        <i class="material-icons">send</i><span class="sr-only">Kirim</span>
      </button>
    </form>
  </div>

  <!-- Modal Universal -->
  <div class="modal-backdrop" id="universalModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle"
    hidden>
    <div class="modal-content" role="document">
      <div class="modal-header">
        <h2 id="modalTitle" class="modal-title font-semibold text-lg">Judul Modal</h2>
        <button class="modal-close-btn" aria-label="Tutup modal">
          <i class="material-icons">close</i>
        </button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Konten modal akan dimuat oleh JavaScript -->
      </div>
    </div>
  </div>

  <!-- Footer Aplikasi -->
  <footer class="app-footer">
    <div class="container">
      <p>&copy; <span id="currentYear">2024</span> Green Valley. Semua hak cipta dilindungi undang-undang.</p>
      <p>
        <a href="#privacy" data-page="privacy">Kebijakan Privasi</a> |
        <a href="#terms" data-page="terms">Syarat & Ketentuan</a>
      </p>
      <p class="mt-md">Dibuat dengan <i class="material-icons" aria-label="cinta">favorite</i> untuk kenyamanan
        Anda.</p>
    </div>
  </footer>

  <script>
    // MAIN APP SCRIPT (Green Valley NATIVE SPA)
    // Penjelasan Umum:
    // Aplikasi ini adalah Single Page Application (SPA) yang dibangun murni dengan HTML, CSS, dan JavaScript.
    // Tidak ada framework atau library eksternal yang digunakan untuk logika inti SPA.
    //
    // Arsitektur JavaScript:
    // - `app`: Objek global utama yang menampung semua logika aplikasi.
    // - `app.state`: Menyimpan semua data dinamis dan kondisi aplikasi (misalnya halaman aktif, filter pencarian).
    // - `app.config`: Menyimpan konfigurasi statis aplikasi (misalnya mata uang, kunci localStorage).
    // - `app.mockData`: Menyimpan data simulasi (apartemen, riwayat booking) untuk keperluan demo.
    // - `app.utils`: Kumpulan fungsi utilitas umum (format harga, tanggal, debounce, dll.).
    // - `app.ui`: Mengelola semua interaksi dengan DOM, rendering komponen, dan pembaruan tampilan.
    // - `app.handlers`: Berisi semua fungsi event listener dan logika penanganan event.
    // - `app.services`: Mengelola logika bisnis, seperti memfilter apartemen, memuat data, interaksi localStorage.
    // - `app.init()`: Fungsi utama yang dipanggil saat DOM siap, menginisialisasi seluruh aplikasi.
    //
    // Routing SPA:
    // Menggunakan `window.location.hash` untuk navigasi tanpa reload halaman.
    // Event `hashchange` didengarkan untuk mendeteksi perubahan hash dan menampilkan halaman yang sesuai.
    // Link navigasi menggunakan atribut `data-page` untuk menentukan target halaman.
    //
    // State Management:
    // State aplikasi terpusat di `app.state`. Perubahan pada state akan memicu pembaruan UI yang relevan.
    // Contoh: `app.state.currentPage` menentukan halaman mana yang ditampilkan.
    //
    // Modul UI & Rendering:
    // Fungsi-fungsi di `app.ui` bertanggung jawab untuk membuat HTML dinamis (misalnya kartu apartemen, kalender)
    // dan memasukkannya ke dalam DOM. Mereka membaca data dari `app.state` atau `app.mockData`.
    //
    // Event Handling:
    // `app.handlers` berisi fungsi-fungsi yang merespons interaksi pengguna (klik, submit form, dll.).
    // Event listener utama di-attach pada elemen body atau elemen kontainer (event delegation) untuk efisiensi,
    // atau pada elemen spesifik saat elemen tersebut di-render (misalnya, form di halaman detail).
    //
    // Optimasi:
    // - CSS dan JS diminimalkan (meskipun tidak ada proses build di sini, kode diusahakan ringkas).
    // - Event delegation untuk mengurangi jumlah event listener.
    // - Debounce untuk input yang memicu filter agar tidak terlalu sering.
    // - Lazy loading untuk gambar (`loading="lazy"`).
    // - Animasi menggunakan CSS transition dan animation untuk performa lebih baik.
    //
    // Keamanan:
    // - Implementasi `app.utils.escapeHTML` untuk mencegah XSS sederhana saat menampilkan data dinamis ke HTML.
    //
    // Aksesibilitas (A11Y):
    // - Penggunaan atribut ARIA (misalnya `aria-label`, `aria-expanded`, `role`, `aria-hidden`, `aria-live`).
    // - Navigasi keyboard yang baik (fokus terlihat jelas, tombol bisa dioperasikan dengan Enter/Space).
    // - Kontras warna yang memadai (diusahakan sesuai WCAG).
    // - Struktur semantik HTML.

    const app = {
      state: {
        currentPage: 'home',
        apartments: [],
        selectedApartmentId: null,
        searchFilters: {
          location: '',
          radius: 5,
          checkin: null,
          checkout: null,
          maxPrice: 15000000,
          amenities: [],
          type: ''
        },
        bookingHistory: [],
        searchCalendar: {
          currentMonth: new Date().getMonth(),
          currentYear: new Date().getFullYear(),
        },
        bookingCalendar: {
          currentMonth: new Date().getMonth(),
          currentYear: new Date().getFullYear(),
          bookedDatesForCurrentApartment: [],
        },
        globalChatOpen: false,
        isMobileNavOpen: false,
        isLoading: {
          featuredProperties: false,
          searchResults: false,
          apartmentDetail: false,
          bookingHistory: false
        },
        appHeaderHeight: 70, // Default, akan di-update
      },

      config: {
        currency: 'Rp',
        featuredPropertiesCount: 3,
        defaultMapMessage: 'Simulasi Peta Interaktif - Fungsionalitas peta akan datang.',
        minBookingDurationDays: 1,
        localStorageKeys: {
          bookingHistory: 'GreenValleyBookingHistory_v2' // Versi baru untuk menghindari konflik
        },
        debounceDelay: 350, // ms
      },

      mockData: {
        apartments: [
          {
            id: 1, title: 'Penthouse Mewah Sudirman View', slug: 'penthouse-mewah-sudirman-view', price: 25000000, location: 'Jakarta Pusat, Sudirman',
            coordinates: { lat: -6.2088, lng: 106.8456 }, type: 'penthouse', bedrooms: 3, bathrooms: 3, sqft: 200,
            amenities: ['pool', 'gym', 'wifi', 'parking', 'ac', 'kitchen', 'pet-friendly', 'playground'],
            images: [
              'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8YXBhcnRtZW50fGVufDB8fDB8fHww&auto=format&fit=crop&w=800&q=60',
              'https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8YXBhcnRtZW50fGVufDB8fDB8fHww&auto=format&fit=crop&w=600&q=60',
              'https://images.unsplash.com/photo-1600585154340-be6161a56a0c?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8N3x8YXBhcnRtZW50fGVufDB8fDB8fHww&auto=format&fit=crop&w=600&q=60',
              'https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTB8fGFwYXJ0bWVudHxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=600&q=60',
              'https://images.unsplash.com/photo-1493809842364-78817add7ffb?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTZ8fGFwYXJ0bWVudHxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=600&q=60'
            ],
            description: 'Nikmati kemewahan tinggal di jantung kota Jakarta. Penthouse eksklusif dengan pemandangan kota yang menakjubkan, fasilitas lengkap, dan desain interior modern. Keamanan 24 jam dan akses mudah ke pusat bisnis dan hiburan.',
            host: { name: 'Bapak Propertio', verified: true },
            reviews: [
              { user: 'Rina M.', rating: 5, comment: 'Pemandangan kota dari balkon sangat luar biasa! Fasilitas gym dan kolam renangnya juga top.', date: '2024-07-15' },
              { user: 'David K.', rating: 4, comment: 'Lokasi strategis, interior mewah. Sedikit bising karena di pusat kota, tapi terbayar dengan kenyamanan.', date: '2024-06-20' }
            ],
            bookedDates: ['2024-08-10', '2024-08-11', '2024-08-12', '2024-09-01', '2024-09-02', '2024-12-20', '2024-12-21', '2024-12-22', '2024-12-23', '2024-12-24', '2024-12-25']
          },
          {
            id: 2, title: 'Studio Modern Kemang Village', slug: 'studio-modern-kemang-village', price: 12000000, location: 'Jakarta Selatan, Kemang',
            coordinates: { lat: -6.2607, lng: 106.8101 }, type: 'studio', bedrooms: 1, bathrooms: 1, sqft: 50,
            amenities: ['wifi', 'ac', 'kitchen', 'laundry'],
            images: [
              'https://images.unsplash.com/photo-1512917774080-9991f1c4c750?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fGFwYXJ0bWVudHxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=800&q=60',
              'https://images.unsplash.com/photo-1560185007-c5ca99790167?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTh8fGFwYXJ0bWVudCUyMGludGVyaW9yfGVufDB8fDB8fHww&auto=format&fit=crop&w=600&q=60',
              'https://images.unsplash.com/photo-1616046229478-9901c5536a45?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NTF8fGFwYXJ0bWVudCUyMGludGVyaW9yfGVufDB8fDB8fHww&auto=format&fit=crop&w=600&q=60'
            ],
            description: 'Studio apartemen yang chic dan modern di area Kemang yang trendi. Sempurna untuk profesional muda atau pasangan. Dilengkapi dengan dapur mini dan akses mudah ke kafe, restoran, dan pusat perbelanjaan.',
            host: { name: 'Ibu Gaya Hidup', verified: true },
            reviews: [{ user: 'Sarah L.', rating: 4, comment: 'Cocok untuk solo traveler atau pasangan. Bersih dan nyaman.', date: '2024-07-01' }],
            bookedDates: ['2024-08-05', '2024-08-06', '2024-11-15', '2024-11-16']
          },
          {
            id: 3, title: 'Apartemen Keluarga Nyaman BSD City', slug: 'apartemen-keluarga-nyaman-bsd-city', price: 18000000, location: 'Tangerang Selatan, BSD City',
            coordinates: { lat: -6.3019, lng: 106.6533 }, type: '2br', bedrooms: 2, bathrooms: 2, sqft: 120,
            amenities: ['pool', 'parking', 'ac', 'kitchen', 'laundry', 'playground'],
            images: [
              'https://images.unsplash.com/photo-1580037354587-5988391711c2?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8ZmFtaWx5JTIwYXBhcnRtZW50fGVufDB8fDB8fHww&auto=format&fit=crop&w=800&q=60',
              'https://images.unsplash.com/photo-1576547971028-a3f4e3e07122?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Nnx8a2lkcyUyMGJlZHJvb218ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=600&q=60',
            ],
            description: 'Apartemen luas dan nyaman untuk keluarga Anda di BSD City. Dekat dengan sekolah internasional, rumah sakit, dan pusat perbelanjaan. Fasilitas ramah anak tersedia.',
            host: { name: 'Keluarga Harmoni', verified: false },
            reviews: [{ user: 'Andi F.', rating: 5, comment: 'Sangat puas! Anak-anak suka kolam renang dan playgroundnya.', date: '2024-07-10' }],
            bookedDates: ['2024-09-20', '2024-09-21']
          },
          // Tambahkan lebih banyak mock data jika perlu untuk pengujian yang lebih baik
        ],
        bookingHistory: [
          { id: 'BK001', apartmentId: 1, apartmentTitle: 'Penthouse Mewah Sudirman View', checkin: '2024-05-01', checkout: '2024-05-07', totalCost: 5833333 * 1.15, status: 'Selesai' },
          { id: 'BK002', apartmentId: 2, apartmentTitle: 'Studio Modern Kemang Village', checkin: '2024-06-10', checkout: '2024-06-15', totalCost: 2000000 * 1.05, status: 'Selesai' },
        ]
      },

      utils: {
        formatPrice: (price) => {
          if (typeof price !== 'number' || isNaN(price)) return `${app.config.currency} -`;
          return `${app.config.currency} ${price.toLocaleString('id-ID')}`;
        },
        formatDate: (dateString, options = { day: 'numeric', month: 'long', year: 'numeric' }) => {
          if (!dateString) return 'N/A';
          try {
            const date = new Date(dateString + "T00:00:00Z"); // Tambah T00:00:00Z untuk interpretasi UTC
            if (isNaN(date.getTime())) return 'Tanggal Tidak Valid';
            return date.toLocaleDateString('id-ID', options);
          } catch (error) {
            console.warn("Error formatting date:", dateString, error); return 'Tanggal Error';
          }
        },
        getDaysDifference: (dateStr1, dateStr2) => {
          if (!dateStr1 || !dateStr2) return 0;
          const d1 = new Date(dateStr1 + "T00:00:00Z");
          const d2 = new Date(dateStr2 + "T00:00:00Z");
          if (isNaN(d1.getTime()) || isNaN(d2.getTime())) return 0;
          const diffTime = Math.abs(d2.getTime() - d1.getTime());
          return Math.max(0, Math.ceil(diffTime / (1000 * 60 * 60 * 24))); // Pastikan tidak negatif
        },
        debounce: (func, delay) => {
          let timeout;
          return function (...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
          };
        },
        generateId: (prefix = '') => `${prefix}${Date.now().toString(36)}${Math.random().toString(36).substr(2, 5)}`,
        scrollToTop: () => window.scrollTo({ top: 0, behavior: 'smooth' }),
        getTodayDateString: () => new Date().toISOString().split('T')[0],
        getFutureDateString: (baseDateStr, daysToAdd = 1) => {
          const baseDate = baseDateStr ? new Date(baseDateStr + "T00:00:00Z") : new Date();
          if (isNaN(baseDate.getTime())) baseDate = new Date(); // Fallback jika baseDateStr tidak valid
          baseDate.setDate(baseDate.getDate() + daysToAdd);
          return baseDate.toISOString().split('T')[0];
        },
        escapeHTML: (str) => {
          if (typeof str !== 'string') return str;
          return str.replace(/[&<>"']/g, match => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
          }[match]));
        },
        updateAppHeaderHeight: () => {
          const header = document.getElementById('appHeader');
          if (header) {
            app.state.appHeaderHeight = header.offsetHeight;
            document.documentElement.style.setProperty('--app-header-height', `${app.state.appHeaderHeight}px`);
          }
        }
      },

      ui: {
        elements: {}, // Akan di-cache di cacheElements
        cacheElements: () => {
          const els = app.ui.elements;
          els.appHeader = document.getElementById('appHeader');
          els.navLinks = document.querySelectorAll('.nav-link');
          els.navToggleBtn = document.getElementById('navToggleBtn');
          els.navLinksMenu = document.getElementById('navLinksMenu');
          els.pages = document.querySelectorAll('.page');
          els.quickSearchForm = document.getElementById('quickSearchForm');
          els.quickSearchCheckin = document.getElementById('quick-checkin');
          els.quickSearchCheckout = document.getElementById('quick-checkout');
          els.featuredPropertiesContainer = document.getElementById('featuredProperties');
          els.loadingFeaturedMessage = document.getElementById('loadingFeaturedMessage');
          els.detailedSearchForm = document.getElementById('detailedSearchForm');
          els.searchLocationInput = document.getElementById('search-location');
          els.searchMapCanvas = document.getElementById('searchMapCanvas');
          els.searchRadiusSlider = document.getElementById('search-radius');
          els.radiusValueDisplay = document.getElementById('radiusValueDisplay');
          els.searchPageCalendarContainer = document.getElementById('searchPageCalendar');
          els.prevMonthBtnCalendarSearch = document.getElementById('prevMonthBtnCalendarSearch');
          els.nextMonthBtnCalendarSearch = document.getElementById('nextMonthBtnCalendarSearch');
          els.currentMonthYearCalendarSearch = document.getElementById('currentMonthYearCalendarSearch');
          els.searchCheckinDateInput = document.getElementById('search-checkin-date');
          els.searchCheckoutDateInput = document.getElementById('search-checkout-date');
          els.searchPriceSlider = document.getElementById('search-price');
          els.priceValueDisplay = document.getElementById('priceValueDisplay');
          els.searchAmenitiesCheckboxes = document.querySelectorAll('#detailedSearchForm input[name="amenities"]');
          els.searchApartmentTypeSelect = document.getElementById('search-apartment-type');
          els.searchResultsContainer = document.getElementById('searchResultsContainer');
          els.searchResultsCountDisplay = document.getElementById('searchResultsCount');
          els.noResultsMessage = document.getElementById('noResultsMessage');
          els.loadingSearchResultsMessage = document.getElementById('loadingSearchResultsMessage');
          els.resetSearchFiltersBtn = document.getElementById('resetSearchFiltersBtn');
          els.apartmentDetailContainer = document.getElementById('apartmentDetailContent');
          els.profileName = document.getElementById('profileName');
          els.profileEmail = document.getElementById('profileEmail');
          els.profilePhone = document.getElementById('profilePhone');
          els.profileLoyaltyPoints = document.getElementById('profileLoyaltyPoints');
          els.profileMemberSince = document.getElementById('profileMemberSince');
          els.profileChatWindow = document.getElementById('profileChatWindow');
          els.profileChatForm = document.getElementById('profileChatForm');
          els.profileChatInput = document.getElementById('profileChatInput');
          els.bookingHistoryContainer = document.getElementById('bookingHistoryContainer');
          els.notificationsContainer = document.getElementById('notificationsContainer');
          els.noNotificationsMessage = document.getElementById('noNotificationsMessage');
          els.globalChatToggleBtn = document.getElementById('globalChatToggleBtn');
          els.globalChatbox = document.getElementById('globalChatbox');
          els.closeChatboxBtn = document.getElementById('closeChatboxBtn');
          els.globalChatBody = document.getElementById('globalChatBody');
          els.globalChatForm = document.getElementById('globalChatForm');
          els.globalChatInput = document.getElementById('globalChatInput');
          els.currentYearDisplay = document.getElementById('currentYear');
          els.universalModal = document.getElementById('universalModal');
          els.modalTitle = document.getElementById('modalTitle');
          els.modalBody = document.getElementById('modalBody');
          els.modalCloseBtns = document.querySelectorAll('.modal-close-btn'); // Bisa ada beberapa
        },

        showPage: (pageId) => {
          const targetPage = document.getElementById(pageId);
          if (!targetPage) {
            console.warn(`Halaman dengan ID "${pageId}" tidak ditemukan. Mengalihkan ke Beranda.`);
            pageId = 'home';
            window.location.hash = '#home';
          }
          app.state.currentPage = pageId;
          app.ui.elements.pages.forEach(page => {
            const isCurrentPage = page.id === pageId;
            page.classList.toggle('hidden', !isCurrentPage);
            page.classList.toggle('fade-in', isCurrentPage);
            page.setAttribute('aria-hidden', String(!isCurrentPage));
          });
          app.ui.updateNavLinks(pageId);
          app.utils.scrollToTop();
          app.services.loadPageSpecificData(pageId);
          if (app.state.isMobileNavOpen) app.handlers.handleNavToggle(); // Tutup menu mobile
        },

        updateNavLinks: (activePageId) => {
          app.ui.elements.navLinks.forEach(link => {
            link.classList.toggle('active', link.dataset.page === activePageId);
            link.setAttribute('aria-current', link.dataset.page === activePageId ? 'page' : 'false');
          });
        },

        renderApartmentCard: (apartment, isFeatured = false) => {
          const { utils, config } = app;
          const priceDisplay = utils.formatPrice(apartment.price);
          const iconMap = { pool: 'pool', gym: 'fitness_center', wifi: 'wifi', parking: 'local_parking', ac: 'ac_unit', kitchen: 'kitchen', laundry: 'local_laundry_service', 'pet-friendly': 'pets', playground: 'child_friendly', 'beach-access': 'beach_access', 'art-studio-space': 'palette' };

          const amenitiesHtml = apartment.amenities.slice(0, 3).map(amenity =>
            `<span><i class="material-icons" title="${utils.escapeHTML(amenity.replace('-', ' '))}">${iconMap[amenity] || 'apartment'}</i> ${utils.escapeHTML(amenity.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()))}</span>`
          ).join('');

          const cardId = `apt-card-${apartment.id}`;
          const title = utils.escapeHTML(apartment.title);
          const location = utils.escapeHTML(apartment.location);
          const description = utils.escapeHTML(apartment.description.substring(0, 80));

          return `
            <article class="card" data-id="${apartment.id}" tabindex="0" aria-labelledby="${cardId}-title">
              <img src="${apartment.images[0]}" alt="Tampilan ${title}" class="card-img" loading="lazy">
              <div class="card-body">
                <h3 class="card-title" id="${cardId}-title">
                  ${title}
                  ${apartment.host.verified ? '<span class="material-icons text-success" title="Pemilik Terverifikasi">verified_user</span>' : ''}
                </h3>
                <div class="card-details">
                  <span class="card-price">${priceDisplay}/bulan</span>
                  <span class="card-location"><i class="material-icons">location_on</i> ${location}</span>
                </div>
                <div class="card-features mb-sm">
                  <span><i class="material-icons">hotel</i> ${apartment.bedrooms} KT</span>
                  <span><i class="material-icons">bathtub</i> ${apartment.bathrooms} KM</span>
                  <span><i class="material-icons">square_foot</i> ${apartment.sqft} m</span>
                </div>
                <div class="card-features">
                  ${amenitiesHtml}
                  ${apartment.amenities.length > 3 ? '<span>...</span>' : ''}
                </div>
                <p class="card-text text-muted mt-sm">${description}...</p>
                <div class="card-actions">
                  <a href="#apartment/${apartment.slug || apartment.id}" class="btn btn-primary btn-sm btn-full nav-link" data-page="apartment" data-id="${apartment.id}">
                    <i class="material-icons">visibility</i>Lihat Detail
                  </a>
                </div>
              </div>
              ${isFeatured ? `
                <details class="card-details-extra">
                  <summary>Fasilitas Lengkap</summary>
                  <div>
                    <ul class="list-disc pl-md">
                      ${apartment.amenities.map(a => `<li>${utils.escapeHTML(a.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()))}</li>`).join('')}
                    </ul>
                  </div>
                </details>
              ` : ''}
            </article>
          `;
        },

        renderFeaturedProperties: () => {
          const { ui, state, config } = app;
          ui.showLoading('featuredProperties', true);
          setTimeout(() => { // Simulasi API call
            const featured = state.apartments.slice(0, config.featuredPropertiesCount);
            if (featured.length > 0) {
              ui.elements.featuredPropertiesContainer.innerHTML = featured.map(apt => ui.renderApartmentCard(apt, true)).join('');
            } else {
              ui.elements.loadingFeaturedMessage.textContent = "Tidak ada properti unggulan saat ini.";
              ui.elements.loadingFeaturedMessage.classList.remove('hidden'); // Pastikan tetap terlihat jika tidak ada data
            }
            ui.showLoading('featuredProperties', false);
          }, 500);
        },

        renderSearchResults: (results) => {
          const { ui } = app;
          ui.elements.searchResultsCountDisplay.textContent = results.length;
          if (results.length === 0) {
            ui.elements.searchResultsContainer.innerHTML = '';
            ui.elements.noResultsMessage.classList.remove('hidden');
          } else {
            ui.elements.searchResultsContainer.innerHTML = results.map(apt => ui.renderApartmentCard(apt)).join('');
            ui.elements.noResultsMessage.classList.add('hidden');
          }
          ui.showLoading('searchResults', false);
        },

        showLoading: (type, show = true) => {
          app.state.isLoading[type] = show;
          let messageElement, container, defaultMessage;

          switch (type) {
            case 'featuredProperties':
              messageElement = app.ui.elements.loadingFeaturedMessage;
              container = app.ui.elements.featuredPropertiesContainer;
              defaultMessage = "Memuat properti unggulan...";
              break;
            case 'searchResults':
              messageElement = app.ui.elements.loadingSearchResultsMessage;
              container = app.ui.elements.searchResultsContainer;
              defaultMessage = "Memuat hasil pencarian...";
              if (app.ui.elements.noResultsMessage) app.ui.elements.noResultsMessage.classList.add('hidden');
              break;
            case 'apartmentDetail':
              container = app.ui.elements.apartmentDetailContainer;
              if (show && container) container.innerHTML = `<p class="text-center text-lg text-muted p-xl fade-in">Memuat detail apartemen...</p>`;
              return;
            case 'bookingHistory':
              container = app.ui.elements.bookingHistoryContainer;
              if (show && container) container.innerHTML = `<p class="text-sm text-muted p-md fade-in">Memuat riwayat pemesanan...</p>`;
              return;
          }

          if (messageElement) {
            messageElement.textContent = defaultMessage; // Set default message
            messageElement.classList.toggle('hidden', !show);
          }
          if (container && show) container.innerHTML = ''; // Kosongkan kontainer saat loading
        },

        renderApartmentDetail: (apartment) => {
          const { ui, utils, config, state } = app;
          ui.showLoading('apartmentDetail', false);
          const priceDisplay = utils.formatPrice(apartment.price);
          const iconMap = { pool: 'pool', gym: 'fitness_center', wifi: 'wifi', parking: 'local_parking', ac: 'ac_unit', kitchen: 'kitchen', laundry: 'local_laundry_service', 'pet-friendly': 'pets', playground: 'child_friendly', 'beach-access': 'beach_access', 'art-studio-space': 'palette' };

          const amenitiesHtml = apartment.amenities.map(amenity =>
            `<li class="flex items-center gap-xs"><i class="material-icons text-primary">${iconMap[amenity] || 'check_circle'}</i> ${utils.escapeHTML(amenity.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()))}</li>`
          ).join('');

          const reviewsHtml = apartment.reviews.length > 0 ? apartment.reviews.map((review, index) => `
            <div class="review-item">
              <div class="review-header">
                <span class="review-user">${utils.escapeHTML(review.user)}</span>
                <span class="review-rating" aria-label="Rating ${review.rating} dari 5 bintang">
                  ${Array(5).fill(0).map((_, i) => `<i class="material-icons">${i < review.rating ? 'star' : 'star_border'}</i>`).join('')}
                </span>
              </div>
              <p class="review-comment text-sm mb-xs">${utils.escapeHTML(review.comment)}</p>
              <p class="text-xs text-muted">Pada: ${utils.formatDate(review.date)}</p>
              <button class="btn btn-link btn-sm text-error p-0 mt-xs btn-report-review" data-review-id="${index}" data-apartment-id="${apartment.id}">
                <i class="material-icons text-sm">flag</i> Laporkan ulasan
              </button>
            </div>`).join('') : '<p class="text-muted">Belum ada ulasan untuk properti ini.</p>';

          let galleryClass = 'apartment-gallery';
          if (apartment.images.length === 1) galleryClass += ' single-image';
          else if (apartment.images.length === 2) galleryClass += ' two-images';

          const galleryItemsHtml = apartment.images.map((img, index) => `
            <div class="gallery-item" tabindex="0" role="button" aria-label="Lihat gambar ${index + 1} dari ${utils.escapeHTML(apartment.title)}" data-img-src="${img}" data-img-alt="Gambar ${index + 1} dari ${utils.escapeHTML(apartment.title)}">
              <img src="${img}" alt="Gambar ${index + 1} dari ${utils.escapeHTML(apartment.title)}" loading="lazy">
              ${index === 0 ? `
                <div class="virtual-tour-overlay" aria-hidden="true">
                  <i class="material-icons">visibility</i>
                  <span>Lihat Tur Virtual (Simulasi)</span>
                </div>` : ''}
            </div>`).join('');

          const today = utils.getTodayDateString();
          const tomorrow = utils.getFutureDateString(today);
          const title = utils.escapeHTML(apartment.title);
          const location = utils.escapeHTML(apartment.location);
          const description = utils.escapeHTML(apartment.description);

          ui.elements.apartmentDetailContainer.innerHTML = `
            <h1 class="font-bold text-2xl md:text-3xl mb-sm" id="apartment-title-heading">${title}</h1>
            <div class="flex flex-wrap items-center gap-x-md gap-y-xs mb-lg text-muted">
              <span><i class="material-icons">location_on</i> ${location}</span>
              <span><i class="material-icons">hotel</i> ${apartment.bedrooms} KT</span>
              <span><i class="material-icons">bathtub</i> ${apartment.bathrooms} KM</span>
              <span><i class="material-icons">square_foot</i> ${apartment.sqft} m</span>
            </div>
            <div class="${galleryClass} mb-xl" aria-label="Galeri foto apartemen">${galleryItemsHtml}</div>
            <div class="apartment-details-grid">
              <div class="apartment-main-content">
                <h2 class="font-semibold text-xl mb-md">Deskripsi Properti</h2>
                <p class="text-muted mb-lg">${description}</p>
                <h2 class="font-semibold text-xl mb-md">Fasilitas Unggulan</h2>
                <ul class="grid grid-cols-1 sm:grid-cols-2 gap-md mb-lg" aria-label="Daftar fasilitas">${amenitiesHtml}</ul>
                <h2 class="font-semibold text-xl mb-md">Lokasi Properti (Simulasi)</h2>
                <div class="map-canvas mb-lg" id="apartmentDetailMapCanvas" aria-label="Peta lokasi properti (simulasi)" data-default-message="${config.defaultMapMessage} - Lokasi: ${location}"></div>
                <h2 class="font-semibold text-xl mb-md" id="reviews-heading">Ulasan dari Penyewa</h2>
                <div id="apartmentReviewsContainer" class="mb-lg" aria-labelledby="reviews-heading">${reviewsHtml}</div>
                <div id="reportFormContainer" class="report-form-container hidden" role="form" aria-labelledby="report-form-title"></div>
              </div>
              <aside class="apartment-booking-sidebar">
                <form class="booking-form-sticky" id="apartmentBookingForm" aria-labelledby="booking-form-title">
                  <h3 class="font-semibold text-lg mb-md" id="booking-form-title">Pesan Apartemen Ini</h3>
                  <p class="text-2xl font-bold text-primary mb-lg">${priceDisplay}<span class="text-base font-normal text-muted">/bulan</span></p>
                  <div class="form-group">
                    <label for="book-checkin">Tanggal Check-in</label>
                    <input type="date" id="book-checkin" required min="${today}" aria-describedby="booking-date-error">
                  </div>
                  <div class="form-group">
                    <label for="book-checkout">Tanggal Check-out</label>
                    <input type="date" id="book-checkout" required min="${tomorrow}" aria-describedby="booking-date-error">
                  </div>
                  <div id="booking-date-error" class="text-error text-sm mb-sm hidden" role="alert"></div>
                  <div class="form-group">
                    <label>Kalender Ketersediaan</label>
                    <div class="calendar-nav">
                      <button type="button" id="prevMonthBtnBookingCalendar" aria-label="Bulan sebelumnya (Booking)"><i class="material-icons">chevron_left</i></button>
                      <span id="currentMonthYearBookingCalendar" class="font-medium" aria-live="polite">Memuat...</span>
                      <button type="button" id="nextMonthBtnBookingCalendar" aria-label="Bulan berikutnya (Booking)"><i class="material-icons">chevron_right</i></button>
                    </div>
                    <div class="calendar" id="bookingPageCalendar" role="grid" aria-label="Kalender ketersediaan untuk booking">
                      <p class="text-muted col-span-full text-center p-md">Memuat kalender...</p>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="book-guests">Jumlah Tamu</label>
                    <input type="number" id="book-guests" min="1" value="1" max="${apartment.bedrooms * 2 || 2}" required>
                  </div>
                  <fieldset class="form-group">
                    <legend class="font-medium mb-xs">Metode Pembayaran</legend>
                    <div class="payment-methods" role="radiogroup" aria-label="Pilih metode pembayaran">
                      <div class="payment-method" data-method="credit-card" tabindex="0" role="radio" aria-checked="false">Kartu Kredit</div>
                      <div class="payment-method" data-method="bank-transfer" tabindex="0" role="radio" aria-checked="false">Transfer Bank</div>
                      <div class="payment-method" data-method="e-wallet" tabindex="0" role="radio" aria-checked="false">E-Wallet</div>
                    </div>
                    <input type="hidden" id="selected-payment-method" name="paymentMethod" required>
                    <div id="payment-method-error" class="text-error text-sm mt-xs hidden" role="alert">Pilih metode pembayaran.</div>
                  </fieldset>
                  <div class="form-group">
                    <label class="checkbox-label"><input type="checkbox" id="book-insurance"> Tambah Asuransi Perjalanan (+10%)</label>
                  </div>
                  <div class="cost-breakdown hidden" id="bookingCostBreakdown" aria-live="polite">
                    <h4 class="font-medium mb-sm">Rincian Biaya</h4>
                    <div class="cost-line"><span>Harga Sewa (<span id="booking-duration-days">0</span> hari)</span><span id="base-cost-value">${utils.formatPrice(0)}</span></div>
                    <div class="cost-line"><span>Biaya Layanan (5%)</span><span id="service-cost-value">${utils.formatPrice(0)}</span></div>
                    <div class="cost-line hidden" id="insurance-cost-line"><span>Asuransi Perjalanan (10%)</span><span id="insurance-cost-value">${utils.formatPrice(0)}</span></div>
                    <div class="cost-line total"><span>Total Pembayaran</span><span id="total-cost-value">${utils.formatPrice(0)}</span></div>
                  </div>
                  <div class="escrow-info">
                    <i class="material-icons" aria-hidden="true">verified_user</i>
                    <p>Pembayaran Anda aman melalui sistem escrow Green Valley. Dana akan diteruskan ke pemilik setelah Anda check-in.</p>
                  </div>
                  <button type="submit" class="btn btn-primary btn-lg btn-full">
                    <i class="material-icons">event_available</i>Pesan Sekarang
                  </button>
                </form>
              </aside>
            </div>`;
          ui.setupApartmentDetailPageListeners(apartment);
          ui.initMap('apartmentDetailMapCanvas', apartment.coordinates);
          state.bookingCalendar.bookedDatesForCurrentApartment = apartment.bookedDates || [];
          ui.renderCalendarForBooking();
        },

        showReportForm: (buttonElement) => {
          const { utils, state, ui } = app;
          const reviewId = buttonElement.dataset.reviewId;
          const apartmentId = buttonElement.dataset.apartmentId;
          const apartment = state.apartments.find(a => a.id == apartmentId);
          if (!apartment || !apartment.reviews || !apartment.reviews[reviewId]) {
            ui.openModal('Error', '<p>Data ulasan tidak ditemukan.</p>', 'error');
            return;
          }
          const review = apartment.reviews[reviewId];
          const reportFormContainer = document.getElementById('reportFormContainer');
          if (!reportFormContainer) return;

          reportFormContainer.innerHTML = `
            <h3 class="font-semibold text-lg mb-md text-error" id="report-form-title">Laporkan Ulasan oleh ${utils.escapeHTML(review.user)}</h3>
            <form id="reviewReportForm" aria-labelledby="report-form-title">
              <input type="hidden" name="reviewId" value="${reviewId}">
              <input type="hidden" name="apartmentId" value="${apartmentId}">
              <div class="form-group">
                <label for="report-reason">Alasan Pelaporan</label>
                <textarea id="report-reason" name="reason" placeholder="Jelaskan mengapa ulasan ini tidak pantas atau melanggar ketentuan..." required rows="4"></textarea>
              </div>
              <div class="flex gap-sm justify-end">
                <button type="button" class="btn btn-outline btn-sm" id="cancelReportBtn">Batal</button>
                <button type="submit" class="btn btn-error btn-sm"><i class="material-icons">send</i> Kirim Laporan</button>
              </div>
            </form>`;
          reportFormContainer.classList.remove('hidden');
          document.getElementById('reviewReportForm').addEventListener('submit', app.handlers.handleReviewReportSubmit);
          document.getElementById('cancelReportBtn').addEventListener('click', ui.hideReportForm);
          document.getElementById('report-reason').focus();
        },

        hideReportForm: () => {
          const reportFormContainer = document.getElementById('reportFormContainer');
          if (reportFormContainer) {
            reportFormContainer.classList.add('hidden');
            reportFormContainer.innerHTML = '';
          }
        },

        updateBookingCost: (apartment) => {
          const { utils, config } = app;
          const checkinDateStr = document.getElementById('book-checkin').value;
          const checkoutDateStr = document.getElementById('book-checkout').value;
          const insuranceChecked = document.getElementById('book-insurance').checked;
          const costBreakdownEl = document.getElementById('bookingCostBreakdown');
          const dateErrorEl = document.getElementById('booking-date-error');

          if (!costBreakdownEl || !dateErrorEl) return;
          dateErrorEl.classList.add('hidden');

          if (!checkinDateStr || !checkoutDateStr) {
            costBreakdownEl.classList.add('hidden');
            return;
          }

          const checkinDate = new Date(checkinDateStr + "T00:00:00Z");
          const checkoutDate = new Date(checkoutDateStr + "T00:00:00Z");

          if (checkoutDate <= checkinDate) {
            costBreakdownEl.classList.add('hidden');
            dateErrorEl.textContent = 'Tanggal check-out harus setelah tanggal check-in.';
            dateErrorEl.classList.remove('hidden');
            return;
          }

          const durationDays = utils.getDaysDifference(checkinDateStr, checkoutDateStr);
          if (durationDays < config.minBookingDurationDays) {
            costBreakdownEl.classList.add('hidden');
            dateErrorEl.textContent = `Durasi sewa minimal adalah ${config.minBookingDurationDays} hari.`;
            dateErrorEl.classList.remove('hidden');
            return;
          }

          document.getElementById('booking-duration-days').textContent = durationDays;
          const dailyRate = apartment.price / 30;
          const calculatedBaseCost = dailyRate * durationDays;
          const serviceFee = calculatedBaseCost * 0.05;
          const insuranceCost = insuranceChecked ? calculatedBaseCost * 0.10 : 0;
          const totalCost = calculatedBaseCost + serviceFee + insuranceCost;

          document.getElementById('base-cost-value').textContent = utils.formatPrice(calculatedBaseCost);
          document.getElementById('service-cost-value').textContent = utils.formatPrice(serviceFee);
          const insuranceCostLine = document.getElementById('insurance-cost-line');
          if (insuranceChecked) {
            document.getElementById('insurance-cost-value').textContent = utils.formatPrice(insuranceCost);
            insuranceCostLine.classList.remove('hidden');
          } else {
            insuranceCostLine.classList.add('hidden');
          }
          document.getElementById('total-cost-value').textContent = utils.formatPrice(totalCost);
          costBreakdownEl.classList.remove('hidden');
        },

        renderCalendar: (container, year, month, bookedDates = [], onDateSelectCallback = null, calendarStateRef, isBookingCalendar = false) => {
          if (!container) return;
          container.innerHTML = ''; // Kosongkan kontainer

          const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
          const dayNames = ["Min", "Sen", "Sel", "Rab", "Kam", "Jum", "Sab"];

          const currentMonthYearDisplayId = isBookingCalendar ? 'currentMonthYearBookingCalendar' : 'currentMonthYearCalendarSearch';
          const currentMonthYearEl = document.getElementById(currentMonthYearDisplayId);
          if (currentMonthYearEl) currentMonthYearEl.textContent = `${monthNames[month]} ${year}`;

          dayNames.forEach(dayName => {
            const dayHeaderEl = document.createElement('div');
            dayHeaderEl.classList.add('calendar-header');
            dayHeaderEl.textContent = dayName;
            container.appendChild(dayHeaderEl);
          });

          const firstDayOfMonth = new Date(year, month, 1).getDay();
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          const today = new Date(); today.setHours(0, 0, 0, 0);

          for (let i = 0; i < firstDayOfMonth; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.classList.add('calendar-day', 'empty');
            container.appendChild(emptyCell);
          }

          const checkinRefStr = isBookingCalendar ? document.getElementById('book-checkin')?.value : app.state.searchFilters.checkin;
          const checkoutRefStr = isBookingCalendar ? document.getElementById('book-checkout')?.value : app.state.searchFilters.checkout;
          const checkinDateRef = checkinRefStr ? new Date(checkinRefStr + "T00:00:00Z") : null;
          const checkoutDateRef = checkoutRefStr ? new Date(checkoutRefStr + "T00:00:00Z") : null;


          for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('button');
            dayCell.type = 'button';
            dayCell.classList.add('calendar-day');
            dayCell.textContent = day;
            const currentDate = new Date(year, month, day); currentDate.setHours(0, 0, 0, 0);
            const dateString = currentDate.toISOString().split('T')[0];

            dayCell.dataset.date = dateString;
            dayCell.setAttribute('aria-label', `Pilih tanggal ${day} ${monthNames[month]} ${year}`);

            if (currentDate < today) {
              dayCell.classList.add('disabled'); dayCell.disabled = true;
            } else if (bookedDates.includes(dateString)) {
              dayCell.classList.add('booked'); dayCell.disabled = true;
              dayCell.setAttribute('aria-label', `Tanggal ${day} ${monthNames[month]} ${year} tidak tersedia`);
            } else {
              dayCell.classList.add('available');
              if (onDateSelectCallback) {
                dayCell.addEventListener('click', () => onDateSelectCallback(dateString, calendarStateRef, isBookingCalendar));
              }
            }
            if (currentDate.getTime() === today.getTime()) dayCell.classList.add('today');

            if (dateString === checkinRefStr || dateString === checkoutRefStr) {
              dayCell.classList.add('selected'); dayCell.setAttribute('aria-pressed', 'true');
            } else if (checkinDateRef && checkoutDateRef && currentDate > checkinDateRef && currentDate < checkoutDateRef) {
              dayCell.classList.add('in-range');
            }
            container.appendChild(dayCell);
          }
        },

        renderCalendarForSearch: () => {
          const { searchCalendar } = app.state;
          app.ui.renderCalendar(
            app.ui.elements.searchPageCalendarContainer,
            searchCalendar.currentYear, searchCalendar.currentMonth,
            [], // Search page tidak memblokir tanggal spesifik properti
            app.handlers.handleCalendarDateSelect, searchCalendar, false
          );
        },

        renderCalendarForBooking: () => {
          const { bookingCalendar } = app.state;
          const container = document.getElementById('bookingPageCalendar');
          if (!container) return;
          app.ui.renderCalendar(
            container,
            bookingCalendar.currentYear, bookingCalendar.currentMonth,
            bookingCalendar.bookedDatesForCurrentApartment,
            app.handlers.handleCalendarDateSelect, bookingCalendar, true
          );
        },

        renderBookingHistory: () => {
          const { ui, state, utils } = app;
          ui.showLoading('bookingHistory', false);
          if (state.bookingHistory.length === 0) {
            ui.elements.bookingHistoryContainer.innerHTML = '<p class="text-sm text-muted p-md">Tidak ada riwayat pemesanan.</p>';
            return;
          }
          ui.elements.bookingHistoryContainer.innerHTML = state.bookingHistory.map(booking => `
            <div class="card p-sm mb-sm shadow-xs">
              <h4 class="font-medium text-sm mb-xs">${utils.escapeHTML(booking.apartmentTitle)}</h4>
              <p class="text-xs text-muted">ID: ${utils.escapeHTML(booking.id)}</p>
              <p class="text-xs text-muted">Check-in: ${utils.formatDate(booking.checkin)}</p>
              <p class="text-xs text-muted">Check-out: ${utils.formatDate(booking.checkout)}</p>
              <p class="text-xs font-semibold mt-xs">Total: ${utils.formatPrice(booking.totalCost)} (${utils.escapeHTML(booking.status)})</p>
              <a href="#apartment/${state.apartments.find(a => a.id === booking.apartmentId)?.slug || booking.apartmentId}" class="btn btn-link btn-xs nav-link mt-xs p-0" data-page="apartment" data-id="${booking.apartmentId}">Lihat Properti</a>
            </div>`).join('');
        },

        addChatMessage: (message, type, chatBodyElement) => {
          if (!chatBodyElement) return;
          const messageEl = document.createElement('div');
          messageEl.classList.add('chat-message', type, 'fade-in');
          messageEl.textContent = message; // Diasumsikan message sudah di-escape jika dari user input
          chatBodyElement.appendChild(messageEl);
          chatBodyElement.scrollTop = chatBodyElement.scrollHeight;
        },

        toggleGlobalChat: (forceOpen = null) => {
          const { ui, state } = app;
          const isOpen = ui.elements.globalChatbox.classList.contains('open');
          const shouldOpen = forceOpen !== null ? forceOpen : !isOpen;

          ui.elements.globalChatbox.classList.toggle('open', shouldOpen);
          ui.elements.globalChatbox.hidden = !shouldOpen;
          ui.elements.globalChatToggleBtn.innerHTML = `<i class="material-icons">${shouldOpen ? 'close' : 'chat_bubble'}</i>`;
          ui.elements.globalChatToggleBtn.setAttribute('aria-label', shouldOpen ? 'Tutup chat dukungan' : 'Buka chat dukungan');
          ui.elements.globalChatToggleBtn.setAttribute('aria-expanded', String(shouldOpen));
          state.globalChatOpen = shouldOpen;
          if (shouldOpen) ui.elements.globalChatInput.focus();
        },
        openGlobalChat: () => app.ui.toggleGlobalChat(true),

        openModal: (title, contentHtml, type = 'info') => {
          const { ui } = app;
          if (!ui.elements.universalModal || !ui.elements.modalTitle || !ui.elements.modalBody) return;
          ui.elements.modalTitle.textContent = title;
          ui.elements.modalBody.innerHTML = contentHtml; // Pastikan contentHtml aman
          ui.elements.universalModal.hidden = false;
          void ui.elements.universalModal.offsetWidth; // Paksa reflow
          ui.elements.universalModal.classList.add('open');
          ui.elements.universalModal.dataset.modalType = type;

          const focusableElements = ui.elements.universalModal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
          if (focusableElements.length) focusableElements[0].focus();
          else {
            const modalContent = ui.elements.universalModal.querySelector('.modal-content');
            modalContent.setAttribute('tabindex', '-1');
            modalContent.focus();
          }
        },

        closeModal: () => {
          const { ui } = app;
          if (ui.elements.universalModal) {
            ui.elements.universalModal.classList.remove('open');
            ui.elements.universalModal.addEventListener('transitionend', () => {
              if (!ui.elements.universalModal.classList.contains('open')) ui.elements.universalModal.hidden = true;
            }, { once: true });
          }
        },

        openImageModal: (imageUrl, altText) => {
          const safeAltText = app.utils.escapeHTML(altText);
          app.ui.openModal(safeAltText, `<img src="${imageUrl}" alt="${safeAltText}">`);
        },

        initMap: (canvasId, coordinates = null) => {
          const canvas = document.getElementById(canvasId);
          if (!canvas) return;
          const ctx = canvas.getContext('2d');
          const dpi = window.devicePixelRatio || 1;
          canvas.width = canvas.offsetWidth * dpi;
          canvas.height = canvas.offsetHeight * dpi;
          ctx.scale(dpi, dpi);

          ctx.fillStyle = 'hsl(200, 30%, 92%)';
          ctx.fillRect(0, 0, canvas.offsetWidth, canvas.offsetHeight);
          ctx.strokeStyle = 'hsl(200, 20%, 80%)';
          ctx.lineWidth = Math.max(1, canvas.offsetWidth / 150);
          for (let i = 0; i < 5; i++) {
            ctx.beginPath();
            ctx.moveTo(Math.random() * canvas.offsetWidth, Math.random() * canvas.offsetHeight);
            ctx.lineTo(Math.random() * canvas.offsetWidth, Math.random() * canvas.offsetHeight);
            ctx.stroke();
          }
          if (coordinates) { // Simulasi marker
            const markerSize = Math.max(5, canvas.offsetWidth / 60);
            const markerX = canvas.offsetWidth / 2 + (Math.random() - 0.5) * (canvas.offsetWidth / 10);
            const markerY = canvas.offsetHeight / 2 + (Math.random() - 0.5) * (canvas.offsetHeight / 10);
            ctx.fillStyle = 'hsl(0, 70%, 60%)'; ctx.beginPath();
            ctx.arc(markerX, markerY, markerSize, 0, Math.PI * 2); ctx.fill();
            ctx.strokeStyle = 'white'; ctx.lineWidth = Math.max(0.5, markerSize / 4); ctx.stroke();
          }
          ctx.fillStyle = 'hsl(210, 15%, 45%)';
          ctx.font = `${Math.max(9, canvas.offsetWidth / 35)}px ${getComputedStyle(document.body).fontFamily}`;
          ctx.textAlign = 'center';
          const textToDisplay = canvas.dataset.defaultMessage || app.config.defaultMapMessage;
          ctx.fillText(textToDisplay, canvas.offsetWidth / 2, canvas.offsetHeight - Math.max(12, canvas.offsetHeight / 12));
          // Simulasi interaksi klik sederhana
          canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / dpi / rect.width); // Scale click to canvas coords
            const y = (e.clientY - rect.top) * (canvas.height / dpi / rect.height);
            ctx.fillStyle = 'hsla(210, 85%, 55%, 0.3)'; ctx.beginPath();
            ctx.arc(x, y, Math.max(8, canvas.offsetWidth / 25), 0, Math.PI * 2); ctx.fill();
          });
        },

        setupApartmentDetailPageListeners: (apartment) => {
          const bookingForm = document.getElementById('apartmentBookingForm');
          if (bookingForm) {
            bookingForm.addEventListener('submit', (e) => app.handlers.handleBookingSubmit(e, apartment));
            ['book-checkin', 'book-checkout', 'book-insurance'].forEach(id => {
              const el = document.getElementById(id);
              if (el) el.addEventListener('change', () => app.ui.updateBookingCost(apartment));
            });
            const checkinInput = document.getElementById('book-checkin');
            const checkoutInput = document.getElementById('book-checkout');
            if (checkinInput) checkinInput.addEventListener('change', () => {
              checkoutInput.min = app.utils.getFutureDateString(checkinInput.value);
              app.ui.updateBookingCost(apartment);
            });
          }
          document.querySelectorAll('.payment-method').forEach(method => {
            const selectMethod = () => {
              document.querySelectorAll('.payment-method').forEach(m => {
                m.classList.remove('selected'); m.setAttribute('aria-checked', 'false');
              });
              method.classList.add('selected'); method.setAttribute('aria-checked', 'true');
              document.getElementById('selected-payment-method').value = method.dataset.method;
              document.getElementById('payment-method-error').classList.add('hidden');
            };
            method.addEventListener('click', selectMethod);
            method.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectMethod(); } });
          });
          document.querySelectorAll('.gallery-item[data-img-src]').forEach(item => {
            const openImage = () => app.ui.openImageModal(item.dataset.imgSrc, item.dataset.imgAlt);
            item.addEventListener('click', openImage);
            item.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openImage(); } });
          });
          document.querySelectorAll('.btn-report-review').forEach(btn => btn.addEventListener('click', () => app.ui.showReportForm(btn)));

          const prevBtnBooking = document.getElementById('prevMonthBtnBookingCalendar');
          const nextBtnBooking = document.getElementById('nextMonthBtnBookingCalendar');
          if (prevBtnBooking) prevBtnBooking.addEventListener('click', () => app.handlers.handleCalendarNav('prev', app.state.bookingCalendar, true));
          if (nextBtnBooking) nextBtnBooking.addEventListener('click', () => app.handlers.handleCalendarNav('next', app.state.bookingCalendar, true));
        },

        updateFooterYear: () => {
          if (app.ui.elements.currentYearDisplay) app.ui.elements.currentYearDisplay.textContent = new Date().getFullYear();
        },

        initializeDateInputs: () => {
          const today = app.utils.getTodayDateString();
          const tomorrow = app.utils.getFutureDateString(today);
          if (app.ui.elements.quickSearchCheckin) app.ui.elements.quickSearchCheckin.min = today;
          if (app.ui.elements.quickSearchCheckout) app.ui.elements.quickSearchCheckout.min = tomorrow;
          // Untuk search page dan booking page, min date dihandle oleh renderCalendar dan event listener
        },

        init: () => {
          app.ui.cacheElements();
          app.utils.updateAppHeaderHeight(); // Panggil setelah cacheElements
          app.ui.updateFooterYear();
          app.ui.initializeDateInputs();
        }
      },

      handlers: {
        handleNavClick: (event) => {
          const targetLink = event.target.closest('.nav-link');
          if (targetLink && targetLink.dataset.page) {
            event.preventDefault();
            const pageId = targetLink.dataset.page;
            const apartmentId = targetLink.dataset.id;
            if (pageId === 'apartment' && apartmentId) {
              app.state.selectedApartmentId = parseInt(apartmentId);
              const apartment = app.state.apartments.find(a => a.id === app.state.selectedApartmentId);
              window.location.hash = `#${pageId}/${apartment ? apartment.slug : apartmentId}`;
            } else {
              window.location.hash = `#${pageId}`;
            }
          }
        },

        handleNavToggle: () => {
          const { state, ui } = app;
          state.isMobileNavOpen = !state.isMobileNavOpen;
          ui.elements.navLinksMenu.classList.toggle('open', state.isMobileNavOpen);
          ui.elements.navToggleBtn.setAttribute('aria-expanded', String(state.isMobileNavOpen));
          ui.elements.navToggleBtn.innerHTML = `<i class="material-icons">${state.isMobileNavOpen ? 'close' : 'menu'}</i>`;
          ui.elements.navToggleBtn.setAttribute('aria-label', state.isMobileNavOpen ? 'Tutup menu navigasi' : 'Buka menu navigasi');
        },

        handleRouteChange: () => {
          const hash = window.location.hash.substring(1);
          let pageId = 'home';
          let slugOrId = null;

          if (hash) {
            const parts = hash.split('/');
            pageId = parts[0];
            if (parts.length > 1 && pageId === 'apartment') {
              slugOrId = parts[1];
              const foundApartment = app.state.apartments.find(apt => apt.slug === slugOrId || String(apt.id) === slugOrId);
              if (foundApartment) app.state.selectedApartmentId = foundApartment.id;
              else {
                console.warn(`Apartemen dengan slug/ID "${slugOrId}" tidak ditemukan.`);
                pageId = 'home'; window.location.hash = '#home';
              }
            } else if (!document.getElementById(pageId)) { // Jika halaman non-apartemen tidak ada
              console.warn(`Section untuk halaman "${pageId}" tidak ditemukan. Mengalihkan ke Beranda.`);
              pageId = 'home'; window.location.hash = '#home';
            }
          }
          app.ui.showPage(pageId);
        },

        handleQuickSearch: (event) => {
          event.preventDefault();
          const { state, ui } = app;
          const location = document.getElementById('quick-location').value;
          const checkin = ui.elements.quickSearchCheckin.value;
          const checkout = ui.elements.quickSearchCheckout.value;

          if (checkin && checkout && new Date(checkout) <= new Date(checkin)) {
            ui.openModal('Tanggal Tidak Valid', '<p>Tanggal check-out harus setelah tanggal check-in.</p>', 'error');
            return;
          }
          state.searchFilters.location = location;
          state.searchFilters.checkin = checkin || null;
          state.searchFilters.checkout = checkout || null;
          window.location.hash = '#search';
        },

        handleDetailedSearch: (event) => {
          event.preventDefault();
          const { state, ui, services } = app;
          state.searchFilters.location = ui.elements.searchLocationInput.value.trim().toLowerCase();
          state.searchFilters.radius = parseInt(ui.elements.searchRadiusSlider.value);
          state.searchFilters.maxPrice = parseInt(ui.elements.searchPriceSlider.value);
          const selectedAmenities = [];
          ui.elements.searchAmenitiesCheckboxes.forEach(cb => { if (cb.checked) selectedAmenities.push(cb.value); });
          state.searchFilters.amenities = selectedAmenities;
          state.searchFilters.type = ui.elements.searchApartmentTypeSelect.value;
          services.filterApartments();
        },

        handleResetSearchFilters: () => {
          const { ui, state, services } = app;
          if (ui.elements.detailedSearchForm) ui.elements.detailedSearchForm.reset();
          state.searchFilters = { location: '', radius: 5, checkin: null, checkout: null, maxPrice: 15000000, amenities: [], type: '' };

          if (ui.elements.searchRadiusSlider) ui.elements.searchRadiusSlider.value = state.searchFilters.radius;
          if (ui.elements.radiusValueDisplay) ui.elements.radiusValueDisplay.textContent = state.searchFilters.radius;
          if (ui.elements.searchPriceSlider) ui.elements.searchPriceSlider.value = state.searchFilters.maxPrice;
          if (ui.elements.priceValueDisplay) ui.elements.priceValueDisplay.textContent = state.searchFilters.maxPrice.toLocaleString('id-ID');
          if (ui.elements.searchCheckinDateInput) ui.elements.searchCheckinDateInput.value = '';
          if (ui.elements.searchCheckoutDateInput) ui.elements.searchCheckoutDateInput.value = '';

          ui.renderCalendarForSearch();
          services.filterApartments(); // Terapkan filter setelah reset
        },

        handleCalendarDateSelect: (dateString, calendarStateRef, isBookingCalendar = false) => {
          const { state, ui, services, utils } = app;
          const date = new Date(dateString + "T00:00:00Z");
          const today = new Date(); today.setHours(0, 0, 0, 0);
          if (date < today) return;

          const targetCheckinInputId = isBookingCalendar ? 'book-checkin' : 'search-checkin-date';
          const targetCheckoutInputId = isBookingCalendar ? 'book-checkout' : 'search-checkout-date';
          const checkinInput = document.getElementById(targetCheckinInputId);
          const checkoutInput = document.getElementById(targetCheckoutInputId);
          if (!checkinInput || !checkoutInput) return;

          let currentCheckinStr = checkinInput.value;
          let currentCheckoutStr = checkoutInput.value;

          // Logika pemilihan tanggal:
          // 1. Jika belum ada checkin ATAU checkin dan checkout sudah ada: set tanggal ini sebagai checkin baru, reset checkout.
          // 2. Jika sudah ada checkin tapi belum ada checkout:
          //    a. Jika tanggal ini SETELAH checkin: set sebagai checkout.
          //    b. Jika tanggal ini SEBELUM ATAU SAMA DENGAN checkin: set tanggal ini sebagai checkin baru, reset checkout.
          if (!currentCheckinStr || (currentCheckinStr && currentCheckoutStr)) {
            currentCheckinStr = dateString;
            currentCheckoutStr = null;
          } else { // Ada checkin, belum ada checkout
            const currentCheckinDate = new Date(currentCheckinStr + "T00:00:00Z");
            if (date > currentCheckinDate) {
              currentCheckoutStr = dateString;
            } else {
              currentCheckinStr = dateString;
              currentCheckoutStr = null;
            }
          }

          checkinInput.value = currentCheckinStr || '';
          checkoutInput.value = currentCheckoutStr || '';

          // Set min untuk checkout input jika ini kalender booking
          if (isBookingCalendar && currentCheckinStr) {
            checkoutInput.min = utils.getFutureDateString(currentCheckinStr);
          }

          if (!isBookingCalendar) {
            state.searchFilters.checkin = currentCheckinStr || null;
            state.searchFilters.checkout = currentCheckoutStr || null;
            ui.renderCalendarForSearch(); // Re-render untuk update selection visual
            services.filterApartments(); // Filter ulang jika tanggal berubah
          } else {
            ui.renderCalendarForBooking(); // Re-render untuk update selection visual
            const apartment = state.apartments.find(a => a.id === state.selectedApartmentId);
            if (apartment) ui.updateBookingCost(apartment);
          }
        },

        handleCalendarNav: (direction, calendarStateRef, isBookingCalendar = false) => {
          if (direction === 'prev') {
            calendarStateRef.currentMonth--;
            if (calendarStateRef.currentMonth < 0) { calendarStateRef.currentMonth = 11; calendarStateRef.currentYear--; }
          } else {
            calendarStateRef.currentMonth++;
            if (calendarStateRef.currentMonth > 11) { calendarStateRef.currentMonth = 0; calendarStateRef.currentYear++; }
          }
          if (isBookingCalendar) app.ui.renderCalendarForBooking();
          else app.ui.renderCalendarForSearch();
        },

        handleSliderInput: (event) => {
          const { ui, state, services, utils, config } = app;
          const slider = event.target;
          if (slider.id === 'search-radius' && ui.elements.radiusValueDisplay) {
            ui.elements.radiusValueDisplay.textContent = slider.value;
          } else if (slider.id === 'search-price' && ui.elements.priceValueDisplay) {
            ui.elements.priceValueDisplay.textContent = parseInt(slider.value).toLocaleString('id-ID');
          }
          utils.debounce(services.filterApartments, config.debounceDelay)();
        },

        handleBookingSubmit: (event, apartment) => {
          event.preventDefault();
          const { ui, state, utils, config, services } = app;
          const form = event.target;
          const checkin = form.querySelector('#book-checkin').value;
          const checkout = form.querySelector('#book-checkout').value;
          const guests = form.querySelector('#book-guests').value;
          const paymentMethod = form.querySelector('#selected-payment-method').value;
          const insurance = form.querySelector('#book-insurance').checked;
          const dateErrorEl = document.getElementById('booking-date-error');
          const paymentErrorEl = document.getElementById('payment-method-error');

          dateErrorEl.classList.add('hidden'); paymentErrorEl.classList.add('hidden');
          let isValid = true;

          if (!checkin || !checkout) {
            dateErrorEl.textContent = 'Tanggal check-in dan check-out harus diisi.';
            dateErrorEl.classList.remove('hidden'); isValid = false;
          } else if (new Date(checkout + "T00:00:00Z") <= new Date(checkin + "T00:00:00Z")) {
            dateErrorEl.textContent = 'Tanggal check-out harus setelah tanggal check-in.';
            dateErrorEl.classList.remove('hidden'); isValid = false;
          } else if (utils.getDaysDifference(checkin, checkout) < config.minBookingDurationDays) {
            dateErrorEl.textContent = `Durasi sewa minimal adalah ${config.minBookingDurationDays} hari.`;
            dateErrorEl.classList.remove('hidden'); isValid = false;
          }
          if (!paymentMethod) { paymentErrorEl.classList.remove('hidden'); isValid = false; }
          if (!isValid) {
            ui.openModal('Error Pemesanan', '<p>Mohon perbaiki kesalahan pada formulir.</p>', 'error');
            return;
          }

          let isDateRangeBooked = false;
          const startDate = new Date(checkin + "T00:00:00Z");
          const endDate = new Date(checkout + "T00:00:00Z");
          for (let d = new Date(startDate); d < endDate; d.setDate(d.getDate() + 1)) {
            if (apartment.bookedDates.includes(d.toISOString().split('T')[0])) {
              isDateRangeBooked = true; break;
            }
          }
          if (isDateRangeBooked) {
            ui.openModal('Error Pemesanan', '<p>Maaf, sebagian atau seluruh tanggal yang Anda pilih sudah tidak tersedia untuk properti ini.</p>', 'error');
            return;
          }

          const durationDays = utils.getDaysDifference(checkin, checkout);
          const dailyRate = apartment.price / 30;
          const calculatedBaseCost = dailyRate * durationDays;
          const serviceFee = calculatedBaseCost * 0.05;
          const insuranceCost = insurance ? calculatedBaseCost * 0.10 : 0;
          const totalCost = calculatedBaseCost + serviceFee + insuranceCost;

          for (let d = new Date(startDate); d < endDate; d.setDate(d.getDate() + 1)) {
            const dateToBook = d.toISOString().split('T')[0];
            if (!apartment.bookedDates.includes(dateToBook)) apartment.bookedDates.push(dateToBook);
          }
          const mockApartment = app.mockData.apartments.find(a => a.id === apartment.id);
          if (mockApartment) mockApartment.bookedDates = [...apartment.bookedDates];

          const newBooking = {
            id: utils.generateId('BK'), apartmentId: apartment.id, apartmentTitle: apartment.title,
            checkin, checkout, guests, totalCost, paymentMethod, insurance, status: 'Menunggu Pembayaran'
          };
          state.bookingHistory.unshift(newBooking);
          services.saveBookingHistory();
          ui.openModal('Pemesanan Berhasil (Simulasi)',
            `<p>Selamat! Pemesanan Anda untuk <strong>${utils.escapeHTML(apartment.title)}</strong> dari tanggal ${utils.formatDate(checkin)} hingga ${utils.formatDate(checkout)} telah berhasil diproses.</p>
             <p>Total Pembayaran: <strong>${utils.formatPrice(totalCost)}</strong></p>
             <p>Metode Pembayaran: ${utils.escapeHTML(paymentMethod.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()))}</p>
             <p>Detail pemesanan telah dikirim ke email Anda (simulasi) dan dapat dilihat di halaman profil.</p>`,
            'success'
          );
          form.reset();
          document.getElementById('bookingCostBreakdown').classList.add('hidden');
          document.querySelectorAll('.payment-method.selected').forEach(pm => {
            pm.classList.remove('selected'); pm.setAttribute('aria-checked', 'false');
          });
          state.bookingCalendar.bookedDatesForCurrentApartment = apartment.bookedDates;
          ui.renderCalendarForBooking();
        },

        handleProfileChatSubmit: (event) => {
          event.preventDefault();
          const { ui, utils } = app;
          const input = ui.elements.profileChatInput;
          const message = input.value.trim();
          if (message) {
            ui.addChatMessage(utils.escapeHTML(message), 'sent', ui.elements.profileChatWindow);
            input.value = '';
            setTimeout(() => ui.addChatMessage('Terima kasih atas pesan Anda. Kami akan segera merespons.', 'received', ui.elements.profileChatWindow), 1500);
          }
        },

        handleGlobalChatSubmit: (event) => {
          event.preventDefault();
          const { ui, utils } = app;
          const input = ui.elements.globalChatInput;
          const message = input.value.trim();
          if (message) {
            ui.addChatMessage(utils.escapeHTML(message), 'sent', ui.elements.globalChatBody);
            input.value = '';
            setTimeout(() => ui.addChatMessage('Terima kasih telah menghubungi dukungan Green Valley. Seorang agen akan segera membantu Anda.', 'system', ui.elements.globalChatBody), 1000);
            setTimeout(() => ui.addChatMessage('Halo! Saya agen Green Valley. Ada yang bisa saya bantu?', 'received', ui.elements.globalChatBody), 2500);
          }
        },

        handleReviewReportSubmit: (event) => {
          event.preventDefault();
          const { ui } = app;
          const form = event.target;
          const reason = form.reason.value.trim();
          if (!reason) {
            ui.openModal('Error Laporan', '<p>Mohon isi alasan mengapa Anda melaporkan ulasan ini.</p>', 'error');
            return;
          }
          // Simulasi pengiriman laporan
          console.log(`Laporan dikirim: Review ID ${form.reviewId.value}, Apt ID ${form.apartmentId.value}, Alasan: ${reason}`);
          ui.openModal('Laporan Terkirim', '<p>Terima kasih atas laporan Anda. Tim kami akan meninjau ulasan tersebut.</p>', 'success');
          ui.hideReportForm();
        },

        handleModalClose: (event) => {
          if (event.target === app.ui.elements.universalModal || event.target.closest('.modal-close-btn')) {
            app.ui.closeModal();
          }
        },

        handleDocumentClick: (event) => {
          const { state, ui, handlers } = app;
          if (state.isMobileNavOpen && ui.elements.navLinksMenu &&
            !ui.elements.navLinksMenu.contains(event.target) &&
            !ui.elements.navToggleBtn.contains(event.target)) {
            handlers.handleNavToggle();
          }
          if (state.globalChatOpen && ui.elements.globalChatbox &&
            !ui.elements.globalChatbox.contains(event.target) &&
            !ui.elements.globalChatToggleBtn.contains(event.target)) {
            ui.toggleGlobalChat(false);
          }
        },

        handleEscapeKey: (event) => {
          if (event.key === 'Escape') {
            if (app.ui.elements.universalModal && app.ui.elements.universalModal.classList.contains('open')) {
              app.ui.closeModal();
            }
            if (app.state.globalChatOpen && app.ui.elements.globalChatbox) {
              app.ui.toggleGlobalChat(false);
            }
          }
        },

        init: () => {
          window.addEventListener('hashchange', app.handlers.handleRouteChange);
          window.addEventListener('resize', app.utils.debounce(app.utils.updateAppHeaderHeight, 200)); // Update tinggi header saat resize
          document.body.addEventListener('click', app.handlers.handleNavClick);
          document.addEventListener('click', app.handlers.handleDocumentClick); // Untuk menutup mobile nav/chatbox
          document.addEventListener('keydown', app.handlers.handleEscapeKey); // Untuk menutup modal/chatbox dengan Escape

          const { elements, handlers: h, services, config } = app.ui; // Destructure untuk keringkasan
          if (elements.navToggleBtn) elements.navToggleBtn.addEventListener('click', h.handleNavToggle);
          if (elements.quickSearchForm) elements.quickSearchForm.addEventListener('submit', h.handleQuickSearch);
          if (elements.detailedSearchForm) {
            elements.detailedSearchForm.addEventListener('submit', h.handleDetailedSearch);
            if (elements.searchRadiusSlider) elements.searchRadiusSlider.addEventListener('input', h.handleSliderInput);
            if (elements.searchPriceSlider) elements.searchPriceSlider.addEventListener('input', h.handleSliderInput);
            if (elements.resetSearchFiltersBtn) elements.resetSearchFiltersBtn.addEventListener('click', h.handleResetSearchFilters);
            elements.searchAmenitiesCheckboxes.forEach(cb => cb.addEventListener('change', app.utils.debounce(services.filterApartments, config.debounceDelay)));
            if (elements.searchApartmentTypeSelect) elements.searchApartmentTypeSelect.addEventListener('change', app.utils.debounce(services.filterApartments, config.debounceDelay));
          }
          if (elements.prevMonthBtnCalendarSearch) elements.prevMonthBtnCalendarSearch.addEventListener('click', () => h.handleCalendarNav('prev', app.state.searchCalendar, false));
          if (elements.nextMonthBtnCalendarSearch) elements.nextMonthBtnCalendarSearch.addEventListener('click', () => h.handleCalendarNav('next', app.state.searchCalendar, false));
          if (elements.profileChatForm) elements.profileChatForm.addEventListener('submit', h.handleProfileChatSubmit);
          if (elements.globalChatToggleBtn) elements.globalChatToggleBtn.addEventListener('click', () => app.ui.toggleGlobalChat());
          if (elements.closeChatboxBtn) elements.closeChatboxBtn.addEventListener('click', () => app.ui.toggleGlobalChat(false));
          if (elements.globalChatForm) elements.globalChatForm.addEventListener('submit', h.handleGlobalChatSubmit);
          if (elements.universalModal) {
            elements.universalModal.addEventListener('click', h.handleModalClose);
            elements.modalCloseBtns.forEach(btn => btn.addEventListener('click', app.ui.closeModal));
          }
        }
      },

      services: {
        loadInitialData: () => {
          app.state.apartments = JSON.parse(JSON.stringify(app.mockData.apartments));
          app.services.loadBookingHistory();
        },

        loadPageSpecificData: (pageId) => {
          const { ui, state, services, utils, config } = app;
          switch (pageId) {
            case 'home':
              ui.renderFeaturedProperties();
              break;
            case 'search':
              if (ui.elements.searchLocationInput) ui.elements.searchLocationInput.value = state.searchFilters.location;
              if (ui.elements.searchCheckinDateInput) ui.elements.searchCheckinDateInput.value = state.searchFilters.checkin || '';
              if (ui.elements.searchCheckoutDateInput) ui.elements.searchCheckoutDateInput.value = state.searchFilters.checkout || '';
              if (ui.elements.searchPriceSlider) ui.elements.searchPriceSlider.value = state.searchFilters.maxPrice;
              if (ui.elements.priceValueDisplay) ui.elements.priceValueDisplay.textContent = state.searchFilters.maxPrice.toLocaleString('id-ID');
              ui.renderCalendarForSearch();
              ui.initMap('searchMapCanvas'); // Peta generik
              ui.showLoading('searchResults', true); // Tampilkan loading sebelum filter
              setTimeout(() => services.filterApartments(), 100); // Filter setelah UI search page siap
              break;
            case 'apartment':
              ui.showLoading('apartmentDetail', true);
              if (state.selectedApartmentId) {
                const apartment = state.apartments.find(a => a.id === state.selectedApartmentId);
                setTimeout(() => { // Simulasi fetch
                  if (apartment) ui.renderApartmentDetail(apartment);
                  else ui.elements.apartmentDetailContainer.innerHTML = '<p class="text-center text-lg text-error p-xl">Apartemen tidak ditemukan.</p>';
                  ui.showLoading('apartmentDetail', false);
                }, 300);
              } else {
                ui.elements.apartmentDetailContainer.innerHTML = '<p class="text-center text-lg text-muted p-xl">Silakan pilih apartemen untuk dilihat detailnya.</p>';
                ui.showLoading('apartmentDetail', false);
              }
              break;
            case 'profile':
              ui.showLoading('bookingHistory', true);
              setTimeout(() => { // Simulasi fetch
                ui.renderBookingHistory();
                if (ui.elements.notificationsContainer && ui.elements.notificationsContainer.children.length <= 1 && ui.elements.noNotificationsMessage) { // <=1 jika ada placeholder
                  ui.elements.noNotificationsMessage.classList.remove('hidden');
                } else if (ui.elements.noNotificationsMessage) {
                  ui.elements.noNotificationsMessage.classList.add('hidden');
                }
                ui.showLoading('bookingHistory', false);
              }, 300);
              break;
            case 'support': case 'privacy': case 'terms':
              break; // Tidak ada data spesifik untuk dimuat
          }
        },

        filterApartments: () => {
          app.ui.showLoading('searchResults', true);
          setTimeout(() => { // Simulasi filter
            const { searchFilters, apartments } = app.state;
            const filteredResults = apartments.filter(apt => {
              let match = true;
              if (searchFilters.location && !apt.location.toLowerCase().includes(searchFilters.location)) match = false;
              if (apt.price > searchFilters.maxPrice) match = false;
              if (searchFilters.type && apt.type !== searchFilters.type) match = false;
              if (searchFilters.amenities.length > 0 && !searchFilters.amenities.every(am => apt.amenities.includes(am))) match = false;

              if (searchFilters.checkin && searchFilters.checkout) {
                const checkinDate = new Date(searchFilters.checkin + "T00:00:00Z");
                const checkoutDate = new Date(searchFilters.checkout + "T00:00:00Z");
                let isRangeBooked = false;
                for (let d = new Date(checkinDate); d < checkoutDate; d.setDate(d.getDate() + 1)) {
                  if (apt.bookedDates.includes(d.toISOString().split('T')[0])) { isRangeBooked = true; break; }
                }
                if (isRangeBooked) match = false;
              } else if (searchFilters.checkin && apt.bookedDates.includes(searchFilters.checkin)) {
                match = false;
              }
              return match;
            });
            app.ui.renderSearchResults(filteredResults);
          }, 300);
        },

        loadBookingHistory: () => {
          const storedHistory = localStorage.getItem(app.config.localStorageKeys.bookingHistory);
          if (storedHistory) {
            try { app.state.bookingHistory = JSON.parse(storedHistory); }
            catch (e) {
              console.error("Gagal memuat riwayat booking dari localStorage:", e);
              app.state.bookingHistory = JSON.parse(JSON.stringify(app.mockData.bookingHistory));
            }
          } else {
            app.state.bookingHistory = JSON.parse(JSON.stringify(app.mockData.bookingHistory));
          }
        },

        saveBookingHistory: () => {
          try {
            localStorage.setItem(app.config.localStorageKeys.bookingHistory, JSON.stringify(app.state.bookingHistory));
          } catch (e) {
            console.error("Gagal menyimpan riwayat booking ke localStorage:", e);
            app.ui.openModal("Peringatan", "<p>Gagal menyimpan riwayat booking Anda. Penyimpanan lokal mungkin penuh atau tidak didukung.</p>", "warning");
          }
        },
      },

      // Basic Unit Tests (Konsep)
      // Untuk menjalankan: buka console browser dan panggil app.runTests();
      tests: {
        testFormatPrice: () => {
          console.assert(app.utils.formatPrice(1234567) === "Rp 1.234.567", "Test formatPrice Gagal: 1234567");
          console.assert(app.utils.formatPrice(0) === "Rp 0", "Test formatPrice Gagal: 0");
          console.assert(app.utils.formatPrice(null) === "Rp -", "Test formatPrice Gagal: null");
          console.log("testFormatPrice selesai.");
        },
        testGetDaysDifference: () => {
          console.assert(app.utils.getDaysDifference("2024-01-01", "2024-01-05") === 4, "Test getDaysDifference Gagal: 4 hari");
          console.assert(app.utils.getDaysDifference("2024-01-01", "2024-01-01") === 0, "Test getDaysDifference Gagal: 0 hari");
          console.assert(app.utils.getDaysDifference(null, "2024-01-01") === 0, "Test getDaysDifference Gagal: null input");
          console.log("testGetDaysDifference selesai.");
        },
        testEscapeHTML: () => {
          console.assert(app.utils.escapeHTML("<script>alert('xss')</script>") ===
  "&lt;script&gt;alert(&#39;xss&#39;)&lt;/script&gt;", "Test escapeHTML Gagal");
  console.log("testEscapeHTML selesai.");
  },
  runAll: () => {
  console.log("Menjalankan Unit Tests Dasar...");
  app.tests.testFormatPrice();
  app.tests.testGetDaysDifference();
  app.tests.testEscapeHTML();
  console.log("Semua unit test dasar selesai.");
  }
  },

  init: () => {
  console.log("Green Valley App Initializing...");
  app.services.loadInitialData();
  app.ui.init(); // Cache elements, update UI statis (footer year, date input min).
  app.handlers.init(); // Attach event listeners global.
  app.handlers.handleRouteChange(); // Handle initial route.
  console.log("Green Valley App Ready! Untuk menjalankan tes dasar, panggil app.tests.runAll() di console.");
  }
  };

  document.addEventListener('DOMContentLoaded', app.init);
  </script>
</body>

</html>