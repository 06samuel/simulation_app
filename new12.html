<!DOCTYPE html>
<html lang="id" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Platform penyewaan apartemen dengan pencarian canggih, pembayaran aman, dan manajemen booking efisien">
    <meta name="keywords" content="penyewaan apartemen, manajemen properti, sistem sewa">
    <meta name="author" content="Green Valley">
    <title>Green Valley - Penyewaan Apartemen</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè¢</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ======= DESIGN TOKENS ======= */
        :root {
            /* Colors */
            --color-primary: hsl(210, 90%, 45%);
            --color-primary-light: hsl(210, 90%, 55%);
            --color-primary-dark: hsl(210, 90%, 35%);
            --color-accent: hsl(25, 95%, 55%);
            --color-success: hsl(142, 76%, 42%);
            --color-danger: hsl(0, 84%, 55%);
            --color-warning: hsl(36, 100%, 45%);
            --color-bg: hsl(210, 20%, 98%);
            --color-surface: hsl(0, 0%, 100%);
            --color-surface-hover: hsl(210, 15%, 97%);
            --color-border: hsl(210, 16%, 88%);
            --color-muted: hsl(210, 12%, 55%);
            --color-foreground: hsl(210, 25%, 15%);
            --color-white: hsl(0, 0%, 100%);


            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1), 0 5px 10px rgba(0, 0, 0, 0.05);

            /* Typography */
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-md: 1.125rem;
            --font-size-lg: 1.25rem;
            --font-size-xl: 1.5rem;
            --font-size-2xl: 1.75rem;
            --font-size-3xl: 2rem;
            --line-height-normal: 1.6;

            /* Spacing */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 1rem;
            --space-4: 1.5rem;
            --space-5: 2rem;
            --space-6: 3rem;

            /* Border radius */
            --radius-sm: 0.25rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;

            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            --transition-slow: 400ms ease;

            /* Heights */
            --navbar-height: 60px;
            /* Perkiraan tinggi navbar */
        }

        /* ======= BASE STYLES ======= */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            font-family: var(--font-family);
            background: var(--color-bg);
            color: var(--color-foreground);
            line-height: var(--line-height-normal);
            scroll-behavior: smooth;
        }

        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        a {
            color: var(--color-primary);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        a:hover {
            color: var(--color-primary-light);
            text-decoration: underline;
        }

        img {
            max-width: 100%;
            height: auto;
            display: block;
        }

        button,
        input,
        select,
        textarea {
            font-family: inherit;
            font-size: inherit;
            background: none;
            border: none;
            outline: none;
        }

        button {
            cursor: pointer;
        }

        :focus-visible {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
            border-radius: var(--radius-sm);
            /* Match border radius for consistency */
        }

        /* ======= UTILITY CLASSES ======= */
        .container {
            width: 100%;
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 var(--space-3);
        }

        /* Layout */
        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .justify-center {
            justify-content: center;
        }

        .justify-end {
            justify-content: flex-end;
        }

        .flex-grow {
            flex-grow: 1;
        }

        .gap-1 {
            gap: var(--space-1);
        }

        .gap-2 {
            gap: var(--space-2);
        }

        .gap-3 {
            gap: var(--space-3);
        }

        .gap-4 {
            gap: var(--space-4);
        }

        .grid {
            display: grid;
        }

        .hidden {
            display: none !important;
        }

        .w-full {
            width: 100%;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Spacing */
        .p-1 {
            padding: var(--space-1);
        }

        .p-2 {
            padding: var(--space-2);
        }

        .p-3 {
            padding: var(--space-3);
        }

        .p-4 {
            padding: var(--space-4);
        }

        .py-2 {
            padding-top: var(--space-2);
            padding-bottom: var(--space-2);
        }

        .py-3 {
            padding-top: var(--space-3);
            padding-bottom: var(--space-3);
        }

        .py-4 {
            padding-top: var(--space-4);
            padding-bottom: var(--space-4);
        }

        .py-6 {
            padding-top: var(--space-6);
            padding-bottom: var(--space-6);
        }

        .px-3 {
            padding-left: var(--space-3);
            padding-right: var(--space-3);
        }

        .mb-1 {
            margin-bottom: var(--space-1);
        }

        .mb-2 {
            margin-bottom: var(--space-2);
        }

        .mb-3 {
            margin-bottom: var(--space-3);
        }

        .mb-4 {
            margin-bottom: var(--space-4);
        }

        .mb-6 {
            margin-bottom: var(--space-6);
        }

        .mt-2 {
            margin-top: var(--space-2);
        }

        .mt-3 {
            margin-top: var(--space-3);
        }

        .mt-4 {
            margin-top: var(--space-4);
        }

        .mt-6 {
            margin-top: var(--space-6);
        }

        .pl-4 {
            padding-left: var(--space-4);
        }


        /* Typography */
        .text-center {
            text-align: center;
        }

        .text-muted {
            color: var(--color-muted);
        }

        .text-primary {
            color: var(--color-primary);
        }

        .text-success {
            color: var(--color-success);
        }

        .text-danger {
            color: var(--color-danger);
        }

        .text-warning {
            color: var(--color-warning);
        }

        .text-white {
            color: var(--color-white);
        }

        .font-bold {
            font-weight: 700;
        }

        .font-semibold {
            font-weight: 600;
        }

        .font-medium {
            font-weight: 500;
        }

        .text-xs {
            font-size: var(--font-size-xs);
        }

        .text-sm {
            font-size: var(--font-size-sm);
        }

        .text-base {
            font-size: var(--font-size-base);
        }

        .text-lg {
            font-size: var(--font-size-lg);
        }

        .text-xl {
            font-size: var(--font-size-xl);
        }

        .text-2xl {
            font-size: var(--font-size-2xl);
        }

        .text-3xl {
            font-size: var(--font-size-3xl);
        }

        .text-4xl {
            font-size: 2.25rem;
        }

        /* Tambahan jika perlu */

        /* Visual */
        .rounded {
            border-radius: var(--radius-md);
        }

        .rounded-sm {
            border-radius: var(--radius-sm);
        }

        .rounded-lg {
            border-radius: var(--radius-lg);
        }

        .rounded-xl {
            border-radius: var(--radius-xl);
        }

        .rounded-full {
            border-radius: 9999px;
        }

        .shadow {
            box-shadow: var(--shadow-sm);
        }

        .shadow-md {
            box-shadow: var(--shadow-md);
        }

        .shadow-lg {
            box-shadow: var(--shadow-lg);
        }

        .bg-surface {
            background-color: var(--color-surface);
        }

        .bg-surface-hover {
            background-color: var(--color-surface-hover);
        }

        .bg-primary {
            background-color: var(--color-primary);
            color: var(--color-white);
        }

        .bg-success {
            background-color: var(--color-success);
            color: var(--color-white);
        }

        .bg-danger {
            background-color: var(--color-danger);
            color: var(--color-white);
        }

        .bg-warning {
            background-color: var(--color-warning);
            color: var(--color-foreground);
        }

        /* Teks gelap untuk bg kuning */
        .bg-muted {
            background-color: var(--color-muted);
            color: var(--color-white);
        }

        .border {
            border: 1px solid var(--color-border);
        }

        .border-t {
            border-top: 1px solid var(--color-border);
        }

        .border-b {
            border-bottom: 1px solid var(--color-border);
        }

        .pointer {
            cursor: pointer;
        }

        .transition {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: var(--transition-normal);
        }

        .hover\:bg-surface-hover:hover {
            background-color: var(--color-surface-hover);
        }

        .sticky-sidebar {
            position: sticky;
            top: calc(var(--navbar-height) + var(--space-3));
            align-self: flex-start;
        }


        /* ======= COMPONENTS ======= */
        /* Navigation */
        .navbar {
            background: var(--color-surface);
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 1000;
            height: var(--navbar-height);
            display: flex;
            align-items: center;
        }

        .nav-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            /* Untuk container di dalam navbar */
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 var(--space-3);
        }

        .logo {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--color-primary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: var(--space-3);
        }

        .nav-link {
            padding: var(--space-2);
            font-weight: 500;
            color: var(--color-foreground);
            position: relative;
            transition: color var(--transition-fast);
        }

        .nav-link:hover,
        .nav-link.active {
            color: var(--color-primary);
        }

        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50%;
            height: 2px;
            background: var(--color-primary);
            border-radius: 2px;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--color-primary);
            color: var(--color-white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: var(--font-size-sm);
        }

        .notification-badge {
            position: relative;
        }

        .notification-badge::after {
            content: attr(data-count);
            position: absolute;
            top: -5px;
            right: -5px;
            width: 18px;
            height: 18px;
            background: var(--color-danger);
            color: var(--color-white);
            border-radius: 50%;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .mobile-menu-btn {
            display: none;
            /* Sembunyikan di desktop */
            color: var(--color-foreground);
            /* Warna ikon */
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-sm);
            font-weight: 500;
            transition: all var(--transition-fast);
            border: 1px solid transparent;
            /* Untuk konsistensi ukuran */
        }

        .btn-primary {
            background: var(--color-primary);
            color: var(--color-white);
            border-color: var(--color-primary);
        }

        .btn-primary:hover {
            background: var(--color-primary-light);
            border-color: var(--color-primary-light);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-foreground);
        }

        .btn-outline:hover {
            border-color: var(--color-primary);
            background-color: hsla(210, 90%, 45%, 0.05);
            color: var(--color-primary);
        }

        .btn-success {
            background: var(--color-success);
            color: var(--color-white);
            border-color: var(--color-success);
        }

        .btn-success:hover {
            background: hsl(142, 76%, 50%);
            border-color: hsl(142, 76%, 50%);
        }

        .btn-danger {
            background: var(--color-danger);
            color: var(--color-white);
            border-color: var(--color-danger);
        }

        .btn-danger:hover {
            background: hsl(0, 84%, 60%);
            border-color: hsl(0, 84%, 60%);
        }

        .btn-sm {
            padding: var(--space-1) var(--space-2);
            font-size: var(--font-size-sm);
        }

        .btn-lg {
            padding: var(--space-3) var(--space-4);
            font-size: var(--font-size-lg);
        }

        .btn-icon {
            padding: var(--space-2);
            /* samakan padding agar bulat */
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .btn-icon.btn-outline:hover {
            /* Khusus untuk btn-icon outline */
            background-color: var(--color-surface-hover);
        }


        /* Cards */
        .card {
            background: var(--color-surface);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .card-header {
            padding: var(--space-3);
            border-bottom: 1px solid var(--color-border);
        }

        .card-body {
            padding: var(--space-3);
        }

        .card-footer {
            padding: var(--space-3);
            border-top: 1px solid var(--color-border);
        }

        /* Property Card Specifics */
        .property-card {
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .property-card .card-body {
            /* Jika menggunakan card-body untuk konten */
            flex-grow: 1;
        }

        .property-badge {
            position: absolute;
            top: var(--space-2);
            left: var(--space-2);
            background: var(--color-surface);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            font-weight: 500;
            box-shadow: var(--shadow-sm);
            z-index: 10;
        }

        .property-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .property-card .relative {
            position: relative;
        }

        /* untuk absolute positioning di dalam image container */
        .property-card .wishlist-btn {
            position: absolute;
            top: var(--space-2);
            right: var(--space-2);
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-muted);
            transition: color var(--transition-fast), transform var(--transition-fast);
            z-index: 10;
        }

        .property-card .wishlist-btn:hover {
            transform: scale(1.1);
        }

        .property-card .wishlist-btn.active {
            color: var(--color-danger);
        }


        .property-price {
            font-size: var(--font-size-lg);
            font-weight: 700;
            color: var(--color-primary);
        }

        .property-location {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            color: var(--color-muted);
            font-size: var(--font-size-sm);
        }

        .property-rating {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            color: var(--color-warning);
            font-size: var(--font-size-sm);
        }


        /* Forms */
        .form-group {
            margin-bottom: var(--space-3);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-1);
            font-weight: 500;
            color: var(--color-foreground);
        }

        .form-control {
            width: 100%;
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            background: var(--color-surface);
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
            color: var(--color-foreground);
        }

        .form-control:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px hsla(210, 90%, 45%, 0.2);
        }

        .form-control::placeholder {
            color: var(--color-muted);
            opacity: 1;
        }


        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right var(--space-2) center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: var(--space-6);
            /* Pastikan ada ruang untuk ikon dropdown */
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            cursor: pointer;
            color: var(--color-foreground);
        }

        .checkbox-input {
            width: 18px;
            height: 18px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            appearance: none;
            position: relative;
            cursor: pointer;
            flex-shrink: 0;
            /* Agar tidak mengecil */
            transition: background-color var(--transition-fast), border-color var(--transition-fast);
        }

        .checkbox-input:checked {
            background: var(--color-primary);
            border-color: var(--color-primary);
        }

        .checkbox-input:checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--color-white);
            font-size: var(--font-size-sm);
            font-weight: bold;
        }

        .range-slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--color-border);
            border-radius: 3px;
            outline: none;
            margin: var(--space-2) 0;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--color-primary);
            border-radius: 50%;
            cursor: pointer;
            transition: transform var(--transition-fast);
        }

        .range-slider::-moz-range-thumb {
            /* Untuk Firefox */
            width: 18px;
            height: 18px;
            background: var(--color-primary);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            transition: transform var(--transition-fast);
        }

        .range-slider:hover::-webkit-slider-thumb,
        .range-slider:hover::-moz-range-thumb {
            transform: scale(1.1);
        }


        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-normal), visibility var(--transition-normal);
            padding: var(--space-3);
            /* Padding untuk konten modal agar tidak mentok layar kecil */
        }

        .modal.modal-open {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--color-surface);
            border-radius: var(--radius-md);
            width: 100%;
            /* Lebar penuh di layar kecil */
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95) translateY(20px);
            transition: transform var(--transition-normal);
            display: flex;
            flex-direction: column;
        }

        .modal.modal-open .modal-content {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            padding: var(--space-3);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .modal-body {
            padding: var(--space-3);
            overflow-y: auto;
            /* Konten body bisa scroll jika panjang */
            flex-grow: 1;
        }

        .modal-footer {
            padding: var(--space-3);
            border-top: 1px solid var(--color-border);
            display: flex;
            justify-content: flex-end;
            gap: var(--space-2);
            flex-shrink: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: var(--font-size-lg);
            cursor: pointer;
            color: var(--color-muted);
            padding: var(--space-1);
            /* Area klik lebih besar */
        }

        .modal-close:hover {
            color: var(--color-foreground);
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: var(--space-3);
            overflow-x: auto;
            /* Agar tab bisa discroll horizontal jika banyak */
        }

        .tab {
            padding: var(--space-2) var(--space-3);
            cursor: pointer;
            position: relative;
            white-space: nowrap;
            color: var(--color-muted);
            transition: color var(--transition-fast);
        }

        .tab:hover {
            color: var(--color-foreground);
        }

        .tab.active {
            color: var(--color-primary);
            font-weight: 500;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            /* Agar menyatu dengan border-bottom .tabs */
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn var(--transition-normal);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Alerts */
        .alert {
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-3);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            border: 1px solid transparent;
        }

        .alert-success {
            background: hsla(142, 76%, 42%, 0.1);
            color: var(--color-success);
            border-color: hsla(142, 76%, 42%, 0.3);
        }

        .alert-danger {
            background: hsla(0, 84%, 55%, 0.1);
            color: var(--color-danger);
            border-color: hsla(0, 84%, 55%, 0.3);
        }

        .alert-warning {
            background: hsla(36, 100%, 45%, 0.1);
            color: var(--color-warning);
            border-color: hsla(36, 100%, 45%, 0.3);
        }

        .alert i {
            font-size: var(--font-size-lg);
        }

        /* Reviews */
        .review {
            padding: var(--space-3) 0;
            border-bottom: 1px solid var(--color-border);
        }

        .review:last-child {
            border-bottom: none;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-1);
        }

        .review-author {
            font-weight: 500;
        }

        .review-date {
            color: var(--color-muted);
            font-size: var(--font-size-sm);
        }

        .review-rating {
            color: var(--color-warning);
            margin-bottom: var(--space-1);
        }

        .review-body {
            margin-top: var(--space-2);
            color: var(--color-foreground);
            line-height: var(--line-height-normal);
        }

        /* Chat */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 400px;
            /* Bisa disesuaikan atau dibuat dinamis */
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            overflow: hidden;
            background-color: var(--color-surface);
        }

        .chat-header {
            padding: var(--space-2) var(--space-3);
            border-bottom: 1px solid var(--color-border);
            background: var(--color-surface-hover);
            flex-shrink: 0;
        }

        .chat-header .user-avatar {
            width: 32px;
            height: 32px;
            font-size: var(--font-size-xs);
        }


        .chat-messages {
            flex-grow: 1;
            padding: var(--space-3);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .chat-message {
            max-width: 80%;
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-lg);
            position: relative;
            line-height: 1.4;
        }

        .chat-message.sent {
            align-self: flex-end;
            background: var(--color-primary);
            color: var(--color-white);
            border-bottom-right-radius: var(--radius-sm);
        }

        .chat-message.received {
            align-self: flex-start;
            background: var(--color-surface-hover);
            border: 1px solid var(--color-border);
            border-bottom-left-radius: var(--radius-sm);
        }

        .chat-meta {
            display: block;
            /* Bukan flex, agar bisa diatur rata kanan/kiri */
            font-size: var(--font-size-xs);
            margin-top: var(--space-1);
            opacity: 0.8;
        }

        .chat-message.sent .chat-meta {
            text-align: right;
            color: hsla(0, 0%, 100%, 0.7);
        }

        .chat-message.received .chat-meta {
            text-align: left;
            color: var(--color-muted);
        }


        .chat-input-container {
            padding: var(--space-2);
            border-top: 1px solid var(--color-border);
            background: var(--color-surface-hover);
            flex-shrink: 0;
        }

        .chat-input {
            width: 100%;
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            resize: none;
        }

        .chat-input-container .btn {
            height: 40px;
        }

        /* Samakan tinggi dengan input */


        /* Booking Timeline */
        .timeline {
            position: relative;
            padding-left: var(--space-4);
            /* Ruang untuk dot dan garis */
        }

        .timeline::before {
            content: '';
            position: absolute;
            top: var(--space-1);
            /* Mulai dari dot pertama */
            bottom: var(--space-1);
            /* Akhiri di dot terakhir */
            left: 7px;
            /* Posisi garis (setengah dari lebar dot) */
            width: 2px;
            background: var(--color-border);
        }

        .timeline-item {
            position: relative;
            padding-bottom: var(--space-3);
        }

        .timeline-item:last-child {
            padding-bottom: 0;
        }

        .timeline-item:last-child::before {
            /* Sembunyikan garis untuk item terakhir jika perlu */
            /* display: none; */
        }


        .timeline-dot {
            position: absolute;
            left: -15px;
            /* Posisi dot ( -(lebar dot/2) - padding timeline) */
            top: var(--space-1);
            /* Sejajarkan dengan teks */
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--color-primary);
            border: 2px solid var(--color-surface);
            /* Efek "mengambang" */
        }

        .timeline-item.completed .timeline-dot {
            background-color: var(--color-success);
        }

        .timeline-item.pending .timeline-dot {
            background-color: var(--color-warning);
        }


        .timeline-content {
            padding: var(--space-2) var(--space-3);
            background: var(--color-surface-hover);
            border-radius: var(--radius-sm);
            margin-left: var(--space-3);
            /* Jarak dari garis */
        }

        .timeline-date {
            font-size: var(--font-size-sm);
            color: var(--color-muted);
            margin-top: var(--space-1);
        }

        /* Map */
        .map-container {
            height: 300px;
            background: var(--color-surface-hover);
            border-radius: var(--radius-md);
            overflow: hidden;
            position: relative;
            border: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .map-placeholder {
            text-align: center;
            color: var(--color-muted);
        }

        .map-placeholder i {
            font-size: var(--font-size-3xl);
            margin-bottom: var(--space-2);
        }

        /* Badge Component (General Purpose) */
        .badge {
            display: inline-block;
            padding: var(--space-1) var(--space-2);
            font-size: var(--font-size-xs);
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: var(--radius-sm);
        }

        /* Responsive */
        @media (max-width: 1024px) {

            /* Tablet dan di bawahnya */
            .container {
                padding: 0 var(--space-2);
            }

            .nav-container {
                padding: 0 var(--space-2);
            }


            .property-grid {
                /* Untuk daftar properti di Beranda dan Pencarian */
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)) !important;
            }

            /* Form pencarian di beranda */
            .hero .search-form {
                grid-template-columns: 1fr !important;
                /* Semua input jadi satu kolom */
            }

            /* Filter pencarian di halaman search */
            #search .flex {
                /* Kontainer utama filter dan hasil */
                flex-direction: column;
            }

            #search aside {
                max-width: 100% !important;
                /* Filter jadi lebar penuh */
                margin-bottom: var(--space-4);
            }
        }

        @media (max-width: 768px) {

            /* Mobile */
            .nav-links {
                position: fixed;
                top: var(--navbar-height);
                /* Di bawah navbar */
                left: 0;
                right: 0;
                bottom: 0;
                background: var(--color-surface);
                flex-direction: column;
                align-items: stretch;
                /* Link jadi lebar penuh */
                padding: var(--space-4);
                transform: translateX(-100%);
                transition: transform var(--transition-normal);
                z-index: 999;
                overflow-y: auto;
            }

            .nav-links.active {
                /* Kelas untuk menampilkan menu mobile */
                transform: translateX(0);
            }

            .nav-link {
                padding: var(--space-3);
                text-align: center;
                border-bottom: 1px solid var(--color-border);
            }

            .nav-link:last-child {
                border-bottom: none;
            }

            .nav-link.active::after {
                display: none;
            }

            /* Sembunyikan garis bawah di mobile */
            .nav-link.active {
                background-color: var(--color-surface-hover);
            }


            .mobile-menu-btn {
                display: flex !important;
                /* Tampilkan tombol menu mobile */
            }

            .property-detail-layout {
                flex-direction: column !important;
            }

            .property-detail-layout>div:first-child {
                /* Konten utama properti */
                margin-bottom: var(--space-4);
            }

            .sticky-sidebar {
                /* Sidebar booking di detail properti */
                position: static !important;
                /* Tidak sticky di mobile */
                width: 100% !important;
            }

            .gallery {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)) !important;
            }
        }

        @media (max-width: 480px) {

            /* Small Mobile */
            .btn-lg {
                padding: var(--space-2) var(--space-3);
                font-size: var(--font-size-base);
            }

            .modal-content {
                width: 95%;
                max-height: 85vh;
            }

            .modal-footer {
                flex-direction: column;
                /* Tombol modal jadi satu kolom */
            }

            .modal-footer .btn {
                width: 100%;
            }

            .hero h1 {
                font-size: var(--font-size-2xl);
            }

            .hero p {
                font-size: var(--font-size-base);
            }
        }
    </style>
</head>

<body>
    <!-- Skip to Content Link -->
    <a href="#main-content" class="sr-only">Lewati ke konten utama</a>

    <!-- Navigation -->
    <header class="navbar">
        <div class="nav-container container">
            <a href="#home" class="logo">
                <i class="fas fa-building"></i>
                <span>Green Valley</span>
            </a>

            <button class="mobile-menu-btn btn-icon" id="mobileMenuBtn" aria-label="Buka menu navigasi"
                aria-expanded="false" aria-controls="navLinks">
                <i class="fas fa-bars" aria-hidden="true"></i>
            </button>

            <nav>
                <ul class="nav-links" id="navLinks">
                    <li><a href="#home" class="nav-link active" data-route="home">Beranda</a></li>
                    <li><a href="#search" class="nav-link" data-route="search">Cari</a></li>
                    <li><a href="#wishlist" class="nav-link" data-route="wishlist">Favorit</a></li>
                    <li><a href="#bookings" class="nav-link" data-route="bookings">Pesanan</a></li>
                </ul>
            </nav>

            <div class="user-menu">
                <button class="notification-badge btn-icon btn-outline" data-count="0" aria-label="Notifikasi">
                    <i class="fas fa-bell" aria-hidden="true"></i>
                </button>
                <div class="user-avatar" aria-label="Avatar pengguna">JD</div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="container py-4 flex-grow">
        <!-- Home -->
        <section id="home" class="view">
            <div class="hero text-center mb-6">
                <h1 class="text-3xl font-bold mb-2">Temukan Apartemen Impian Anda</h1>
                <p class="text-lg text-muted mb-4">Cari dan sewa apartemen dengan mudah dan aman.</p>

                <form class="search-form grid gap-3 mb-6" id="quickSearchForm"
                    style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="form-group">
                        <label for="quick-location" class="form-label sr-only">Lokasi</label>
                        <input type="text" id="quick-location" name="location" class="form-control"
                            placeholder="Masukkan kota atau area" aria-describedby="quick-location-desc">
                        <small id="quick-location-desc" class="sr-only">Masukkan nama kota atau landmark untuk mencari
                            apartemen.</small>
                    </div>
                    <div class="form-group">
                        <label for="quick-checkin" class="form-label sr-only">Check-in</label>
                        <input type="date" id="quick-checkin" name="checkin" class="form-control"
                            aria-label="Tanggal Check-in">
                    </div>
                    <div class="form-group">
                        <label for="quick-checkout" class="form-label sr-only">Check-out</label>
                        <input type="date" id="quick-checkout" name="checkout" class="form-control"
                            aria-label="Tanggal Check-out">
                    </div>
                    <div class="form-group">
                        <label for="quick-type" class="form-label sr-only">Tipe</label>
                        <select id="quick-type" name="type" class="form-control form-select"
                            aria-label="Tipe Apartemen">
                            <option value="">Semua Tipe</option>
                            <option value="studio">Studio</option>
                            <option value="1br">1 Kamar Tidur</option>
                            <option value="2br">2 Kamar Tidur</option>
                            <option value="penthouse">Penthouse</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search" aria-hidden="true"></i>
                        <span>Cari</span>
                    </button>
                </form>
            </div>

            <div class="mb-6">
                <h2 class="text-2xl font-bold mb-4">Rekomendasi Untuk Anda</h2>
                <div class="property-grid grid gap-4"
                    style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));" id="recommendedProperties">
                    <!-- Kartu properti akan dirender di sini oleh JavaScript -->
                </div>
            </div>

            <div class="mb-6">
                <h2 class="text-2xl font-bold mb-4">Populer di Jakarta</h2>
                <div class="property-grid grid gap-4"
                    style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));" id="popularProperties">
                    <!-- Kartu properti akan dirender di sini oleh JavaScript -->
                </div>
            </div>
        </section>

        <!-- Search -->
        <section id="search" class="view hidden">
            <h1 class="text-2xl font-bold mb-4">Pencarian Apartemen</h1>

            <div class="flex gap-4">
                <aside style="flex: 1; max-width: 300px;">
                    <form class="search-filters-form card p-3" id="searchFiltersForm">
                        <div class="form-group">
                            <label for="search-location" class="form-label">Lokasi</label>
                            <input type="text" id="search-location" name="location" class="form-control"
                                placeholder="Kota atau landmark" aria-describedby="search-location-desc">
                            <small id="search-location-desc" class="sr-only">Masukkan nama kota atau landmark untuk
                                mencari apartemen.</small>
                        </div>

                        <div class="form-group">
                            <label for="price-range" class="form-label">Harga Maks: Rp <span
                                    id="price-value">25.000.000</span></label>
                            <input type="range" id="price-range" name="price" min="1000000" max="50000000"
                                value="25000000" step="1000000" class="range-slider">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Tipe Unit</label>
                            <div class="checkbox-group" id="type-filters">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="type" class="checkbox-input" value="studio">
                                    <span>Studio</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="type" class="checkbox-input" value="1br">
                                    <span>1 Kamar</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="type" class="checkbox-input" value="2br">
                                    <span>2 Kamar</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="type" class="checkbox-input" value="penthouse">
                                    <span>Penthouse</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Fasilitas</label>
                            <div class="checkbox-group" id="amenities-filters">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="amenities" class="checkbox-input" value="pool">
                                    <span>Kolam Renang</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="amenities" class="checkbox-input" value="gym">
                                    <span>Gym</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="amenities" class="checkbox-input" value="wifi">
                                    <span>WiFi</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="amenities" class="checkbox-input" value="parking">
                                    <span>Parkir</span>
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-full">
                            <i class="fas fa-filter" aria-hidden="true"></i>
                            <span>Terapkan Filter</span>
                        </button>
                    </form>
                </aside>

                <div style="flex: 3;">
                    <div class="map-container mb-4">
                        <div class="map-placeholder">
                            <i class="fas fa-map-marked-alt" aria-hidden="true"></i>
                            <p>Peta Interaktif Akan Ditampilkan Di Sini</p>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold" id="searchResultsCount">Hasil Pencarian (0)</h2>
                        <div class="flex gap-2">
                            <button class="btn btn-outline btn-sm">
                                <i class="fas fa-sort" aria-hidden="true"></i>
                                <span>Urutkan</span>
                            </button>
                            <!-- <button class="btn btn-outline btn-sm">
                                <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
                                <span>Peta</span>
                            </button> -->
                        </div>
                    </div>

                    <div class="property-grid grid gap-4"
                        style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));" id="searchResults">
                        <!-- Hasil pencarian akan dirender di sini -->
                        <p id="no-search-results" class="text-muted text-center hidden col-span-full py-6">Tidak ada
                            properti yang sesuai dengan filter Anda.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Property Detail -->
        <section id="property" class="view hidden">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold" id="property-detail-title">Nama Properti</h1>
                <button class="btn btn-outline" id="backToPrevViewBtn">
                    <i class="fas fa-arrow-left" aria-hidden="true"></i>
                    <span>Kembali</span>
                </button>
            </div>

            <div class="gallery grid gap-3 mb-4" id="property-gallery"
                style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <!-- Gambar galeri akan dirender di sini -->
            </div>

            <div class="property-detail-layout flex gap-4">
                <div style="flex: 2;">
                    <article class="card mb-4">
                        <div class="card-body">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h2 class="text-xl font-bold" id="property-detail-type">Tipe Properti</h2>
                                    <div class="flex items-center gap-1 text-muted text-sm mt-1">
                                        <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
                                        <span id="property-detail-location">Lokasi Properti</span>
                                    </div>
                                </div>
                                <div class="property-price text-xl font-bold text-primary" id="property-detail-price">Rp
                                    0/bulan</div>
                            </div>

                            <div class="flex flex-wrap gap-x-4 gap-y-2 mb-3 text-sm text-muted"
                                id="property-detail-specs">
                                <!-- Spesifikasi (kamar tidur, kamar mandi, luas) akan dirender di sini -->
                            </div>

                            <p id="property-detail-description" class="mb-3 text-foreground">
                                Deskripsi properti akan ditampilkan di sini.
                            </p>

                            <div class="property-rating mb-3 flex items-center gap-1" id="property-detail-rating">
                                <!-- Rating akan dirender di sini -->
                            </div>

                            <div class="flex gap-2">
                                <button class="btn btn-outline">
                                    <i class="fas fa-share-alt" aria-hidden="true"></i>
                                    <span>Bagikan</span>
                                </button>
                                <button class="btn btn-outline" id="detailWishlistBtn">
                                    <i class="far fa-heart" aria-hidden="true"></i>
                                    <span>Simpan</span>
                                </button>
                            </div>
                        </div>
                    </article>

                    <section class="card mb-4">
                        <div class="card-body">
                            <h2 class="text-xl font-bold mb-3">Fasilitas</h2>
                            <div class="grid gap-3" id="property-detail-amenities"
                                style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                                <!-- Fasilitas akan dirender di sini -->
                            </div>
                        </div>
                    </section>

                    <section class="card mb-4">
                        <div class="card-body">
                            <h2 class="text-xl font-bold mb-3">Lokasi</h2>
                            <div class="map-container mb-3">
                                <div class="map-placeholder">
                                    <i class="fas fa-map-marked-alt" aria-hidden="true"></i>
                                    <p>Peta Lokasi Akan Ditampilkan Di Sini</p>
                                </div>
                            </div>
                            <p id="property-detail-address" class="text-foreground">Alamat lengkap akan ditampilkan di
                                sini.</p>
                        </div>
                    </section>

                    <section class="card">
                        <div class="card-body">
                            <h2 class="text-xl font-bold mb-3">Ulasan (<span id="property-review-count">0</span>)</h2>
                            <div id="property-reviews-list">
                                <!-- Daftar ulasan akan dirender di sini -->
                            </div>
                            <form class="review-form mt-4" id="addReviewForm">
                                <h3 class="text-lg font-semibold mb-2">Tulis Ulasan Anda</h3>
                                <div class="form-group">
                                    <label for="review-text" class="form-label sr-only">Ulasan</label>
                                    <textarea id="review-text" class="form-control" rows="4"
                                        placeholder="Bagikan pengalaman Anda..." required></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="review-rating" class="form-label">Rating</label>
                                    <select id="review-rating" class="form-control form-select" required>
                                        <option value="">Pilih Rating</option>
                                        <option value="5">5 Bintang - Luar Biasa</option>
                                        <option value="4">4 Bintang - Sangat Baik</option>
                                        <option value="3">3 Bintang - Cukup Baik</option>
                                        <option value="2">2 Bintang - Kurang</option>
                                        <option value="1">1 Bintang - Buruk</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane" aria-hidden="true"></i>
                                    <span>Kirim Ulasan</span>
                                </button>
                            </form>
                        </div>
                    </section>
                </div>

                <aside class="sticky-sidebar" style="flex: 1;">
                    <div class="card">
                        <div class="card-body">
                            <h2 class="text-xl font-bold mb-3">Pesan Sekarang</h2>
                            <form class="booking-form" id="propertyBookingForm">
                                <div class="form-group">
                                    <label for="checkin-date" class="form-label">Check-in</label>
                                    <input type="date" id="checkin-date" class="form-control" required
                                        aria-label="Tanggal Check-in">
                                </div>
                                <div class="form-group">
                                    <label for="checkout-date" class="form-label">Check-out</label>
                                    <input type="date" id="checkout-date" class="form-control" required
                                        aria-label="Tanggal Check-out">
                                </div>
                                <div class="form-group">
                                    <label for="guests" class="form-label">Jumlah Tamu</label>
                                    <select id="guests" class="form-control form-select" aria-label="Jumlah Tamu">
                                        <option value="1">1 Tamu</option>
                                        <option value="2">2 Tamu</option>
                                        <option value="3">3 Tamu</option>
                                        <option value="4">4 Tamu</option>
                                        <option value="5">5+ Tamu</option>
                                    </select>
                                </div>
                                <div class="alert alert-success mb-3 hidden" id="availability-message">
                                    <i class="fas fa-check-circle" aria-hidden="true"></i>
                                    <span>Tersedia untuk tanggal yang dipilih!</span>
                                </div>
                                <div class="alert alert-danger mb-3 hidden" id="unavailability-message">
                                    <i class="fas fa-times-circle" aria-hidden="true"></i>
                                    <span>Maaf, tidak tersedia untuk tanggal yang dipilih.</span>
                                </div>

                                <div id="booking-summary" class="hidden">
                                    <div class="flex justify-between mb-1 text-sm">
                                        <span id="booking-price-calc">Rp 0 x 0 malam/bulan</span>
                                        <span id="booking-subtotal">Rp 0</span>
                                    </div>
                                    <div class="flex justify-between mb-1 text-sm">
                                        <span>Biaya Layanan</span>
                                        <span id="booking-service-fee">Rp 0</span>
                                    </div>
                                    <hr class="my-2">
                                    <div class="flex justify-between font-bold text-lg mb-4">
                                        <span>Total</span>
                                        <span id="booking-total">Rp 0</span>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary btn-lg w-full">
                                    <i class="fas fa-calendar-check" aria-hidden="true"></i>
                                    <span>Pesan Sekarang</span>
                                </button>
                            </form>
                        </div>
                    </div>

                    <div class="card mt-4" id="owner-info-card">
                        <div class="card-body">
                            <h2 class="text-xl font-bold mb-3">Pemilik Properti</h2>
                            <div class="flex items-center gap-3 mb-3">
                                <div class="user-avatar" id="owner-avatar">?</div>
                                <div>
                                    <div class="font-bold" id="owner-name">Nama Pemilik</div>
                                    <div class="text-muted text-sm">Member Sejak <span id="owner-since">Tahun</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-between mb-1 text-sm">
                                <span class="text-muted">Tingkat Respons</span>
                                <span id="owner-response-rate">0%</span>
                            </div>
                            <div class="flex justify-between mb-1 text-sm">
                                <span class="text-muted">Waktu Respons</span>
                                <span id="owner-response-time">N/A</span>
                            </div>
                            <button class="btn btn-outline w-full mt-3" id="contactOwnerBtn">
                                <i class="fas fa-comment-dots" aria-hidden="true"></i>
                                <span>Hubungi Pemilik</span>
                            </button>
                        </div>
                    </div>
                </aside>
            </div>
        </section>

        <!-- Wishlist -->
        <section id="wishlist" class="view hidden">
            <h1 class="text-2xl font-bold mb-4">Favorit Anda</h1>
            <div class="property-grid grid gap-4" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));"
                id="wishlistPropertiesContainer">
                <!-- Properti favorit akan dirender di sini -->
            </div>
            <div class="text-center py-6 hidden" id="emptyWishlistMessage">
                <i class="fas fa-heart-broken text-4xl text-muted mb-3" aria-hidden="true"></i>
                <h3 class="text-xl font-bold mb-2">Daftar Favorit Kosong</h3>
                <p class="text-muted mb-3">Simpan properti yang Anda sukai untuk dilihat nanti.</p>
                <a href="#search" class="btn btn-primary">
                    <i class="fas fa-search" aria-hidden="true"></i>
                    <span>Cari Apartemen</span>
                </a>
            </div>
        </section>

        <!-- Bookings -->
        <section id="bookings" class="view hidden">
            <h1 class="text-2xl font-bold mb-4">Pesanan Anda</h1>
            <div class="tabs mb-4">
                <div class="tab active" data-tab="upcoming">Mendatang</div>
                <div class="tab" data-tab="completed">Selesai</div>
                <div class="tab" data-tab="cancelled">Dibatalkan</div>
            </div>

            <div class="tab-content active" id="upcoming-bookings">
                <!-- Daftar pesanan mendatang -->
                <div id="upcoming-bookings-list"></div>
                <div class="text-center py-6 hidden" id="no-upcoming-bookings-message">
                    <i class="fas fa-calendar-times text-4xl text-muted mb-3" aria-hidden="true"></i>
                    <h3 class="text-xl font-bold mb-2">Tidak Ada Pesanan Mendatang</h3>
                    <p class="text-muted mb-3">Anda belum memiliki pesanan aktif.</p>
                    <a href="#search" class="btn btn-primary">Cari Apartemen</a>
                </div>
            </div>
            <div class="tab-content" id="completed-bookings">
                <!-- Daftar pesanan selesai -->
                <div id="completed-bookings-list"></div>
                <div class="text-center py-6 hidden" id="no-completed-bookings-message">
                    <i class="fas fa-history text-4xl text-muted mb-3" aria-hidden="true"></i>
                    <h3 class="text-xl font-bold mb-2">Tidak Ada Riwayat Pesanan</h3>
                    <p class="text-muted mb-3">Pesanan yang telah selesai akan muncul di sini.</p>
                </div>
            </div>
            <div class="tab-content" id="cancelled-bookings">
                <!-- Daftar pesanan dibatalkan -->
                <div id="cancelled-bookings-list"></div>
                <div class="text-center py-6 hidden" id="no-cancelled-bookings-message">
                    <i class="fas fa-ban text-4xl text-muted mb-3" aria-hidden="true"></i>
                    <h3 class="text-xl font-bold mb-2">Tidak Ada Pesanan Dibatalkan</h3>
                    <p class="text-muted mb-3">Anda belum membatalkan pesanan apapun.</p>
                </div>
            </div>
        </section>

        <!-- Booking Detail -->
        <section id="booking-detail" class="view hidden">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold">Detail Pesanan <span id="booking-detail-id"
                        class="text-muted text-base"></span></h1>
                <button class="btn btn-outline" id="backToBookingsBtn">
                    <i class="fas fa-arrow-left" aria-hidden="true"></i>
                    <span>Kembali ke Pesanan</span>
                </button>
            </div>
            <!-- Konten Detail Booking akan dirender di sini oleh JS -->
            <div id="booking-detail-content" class="space-y-4"></div>
        </section>

        <!-- Chat -->
        <section id="chat" class="view hidden">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold">Obrolan dengan <span id="chat-with-name">Pemilik</span></h1>
                <button class="btn btn-outline" id="backFromChatBtn">
                    <i class="fas fa-arrow-left" aria-hidden="true"></i>
                    <span>Kembali</span>
                </button>
            </div>
            <div class="chat-container">
                <div class="chat-header">
                    <div class="flex items-center gap-2">
                        <div class="user-avatar" id="chat-avatar">?</div>
                        <div>
                            <div class="font-bold" id="chat-contact-name">Nama Kontak</div>
                            <div class="text-sm text-muted" id="chat-contact-status">Status Kontak</div>
                        </div>
                    </div>
                </div>
                <div class="chat-messages" id="chatMessagesContainer">
                    <!-- Pesan chat akan dirender di sini -->
                </div>
                <div class="chat-input-container">
                    <form class="flex gap-2" id="chatMessageForm">
                        <input type="text" id="chat-message-input" class="chat-input flex-grow"
                            placeholder="Ketik pesan..." required aria-label="Pesan Anda">
                        <button type="submit" class="btn btn-primary btn-icon" aria-label="Kirim pesan">
                            <i class="fas fa-paper-plane" aria-hidden="true"></i>
                        </button>
                    </form>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-surface py-6 mt-auto border-t">
        <div class="container">
            <div class="grid gap-6 mb-6" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div>
                    <h3 class="text-lg font-bold mb-3">Green Valley</h3>
                    <p class="text-muted text-sm">Platform penyewaan apartemen terpercaya di Indonesia. Temukan hunian
                        impian Anda dengan mudah, aman, dan nyaman.</p>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-3">Tautan Cepat</h3>
                    <ul class="flex flex-col gap-2 text-sm">
                        <li><a href="#home" class="text-muted hover:text-primary">Beranda</a></li>
                        <li><a href="#search" class="text-muted hover:text-primary">Cari Apartemen</a></li>
                        <li><a href="#wishlist" class="text-muted hover:text-primary">Favorit</a></li>
                        <li><a href="#bookings" class="text-muted hover:text-primary">Pesanan Saya</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-3">Bantuan</h3>
                    <ul class="flex flex-col gap-2 text-sm">
                        <li><a href="#support" class="text-muted hover:text-primary">Dukungan Pelanggan</a></li>
                        <li><a href="#terms" class="text-muted hover:text-primary">Syarat & Ketentuan</a></li>
                        <li><a href="#privacy" class="text-muted hover:text-primary">Kebijakan Privasi</a></li>
                        <li><a href="#faq" class="text-muted hover:text-primary">FAQ</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-3">Hubungi Kami</h3>
                    <ul class="flex flex-col gap-2 text-sm">
                        <li class="flex items-center gap-2 text-muted">
                            <i class="fas fa-envelope fa-fw" aria-hidden="true"></i>
                            <span>dukungan@Green Valley.com</span>
                        </li>
                        <li class="flex items-center gap-2 text-muted">
                            <i class="fas fa-phone fa-fw" aria-hidden="true"></i>
                            <span>+62 21 0000 0000</span>
                        </li>
                        <li class="flex items-center gap-2 text-muted">
                            <i class="fas fa-map-marker-alt fa-fw" aria-hidden="true"></i>
                            <span>Jakarta, Indonesia</span>
                        </li>
                    </ul>
                    <div class="flex gap-3 mt-4">
                        <a href="#" class="text-muted hover:text-primary" aria-label="Facebook Green Valley"><i
                                class="fab fa-facebook-f text-lg"></i></a>
                        <a href="#" class="text-muted hover:text-primary" aria-label="Twitter Green Valley"><i
                                class="fab fa-twitter text-lg"></i></a>
                        <a href="#" class="text-muted hover:text-primary" aria-label="Instagram Green Valley"><i
                                class="fab fa-instagram text-lg"></i></a>
                    </div>
                </div>
            </div>
            <div class="border-t border-color-border pt-6 text-center">
                <p class="text-muted text-sm">&copy; <span id="currentYear">2024</span> Green Valley. Hak Cipta
                    Dilindungi
                    Undang-Undang.</p>
            </div>
        </div>
    </footer>

    <!-- Booking Modal -->
    <div class="modal" id="booking-modal" aria-labelledby="bookingModalTitle" aria-modal="true" role="dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-xl font-bold" id="bookingModalTitle">Konfirmasi Pemesanan</h2>
                <button class="modal-close" aria-label="Tutup modal">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="booking-modal-summary">
                    <!-- Ringkasan booking di modal akan diisi JS -->
                </div>
                <div class="form-group mb-4">
                    <label for="payment-method" class="form-label">Metode Pembayaran</label>
                    <select id="payment-method" class="form-control form-select" required>
                        <option value="">Pilih metode pembayaran</option>
                        <option value="bca">Transfer Bank (BCA)</option>
                        <option value="mandiri">Transfer Bank (Mandiri)</option>
                        <option value="bni">Transfer Bank (BNI)</option>
                        <option value="gopay">GoPay</option>
                        <option value="ovo">OVO</option>
                        <option value="dana">DANA</option>
                        <option value="cc">Kartu Kredit</option>
                    </select>
                </div>
                <div class="form-group mb-0"> <!-- mb-0 karena footer modal sudah ada padding -->
                    <label class="checkbox-label">
                        <input type="checkbox" id="terms-agree" class="checkbox-input" required>
                        <span>Saya setuju dengan <a href="#terms" class="text-primary hover:underline">Syarat &
                                Ketentuan</a> dan <a href="#privacy" class="text-primary hover:underline">Kebijakan
                                Privasi</a>.</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" id="cancelBookingBtn">Batal</button>
                <button type="button" class="btn btn-primary" id="confirmBookingBtn">
                    <i class="fas fa-lock" aria-hidden="true"></i>
                    <span>Lanjutkan ke Pembayaran</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal" id="payment-modal" aria-labelledby="paymentModalTitle" aria-modal="true" role="dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-xl font-bold" id="paymentModalTitle">Instruksi Pembayaran</h2>
                <button class="modal-close" aria-label="Tutup modal">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success mb-4">
                    <i class="fas fa-check-circle" aria-hidden="true"></i>
                    <span>Pesanan Anda <strong id="payment-booking-id">#RTLXXXX</strong> telah dibuat! Silakan
                        selesaikan pembayaran.</span>
                </div>
                <div id="payment-instructions">
                    <!-- Instruksi pembayaran akan diisi JS -->
                </div>
                <div class="form-group mb-0">
                    <label for="payment-proof" class="form-label">Unggah Bukti Transfer (Opsional)</label>
                    <input type="file" id="payment-proof" class="form-control" accept="image/*,.pdf">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" id="payLaterBtn">Bayar Nanti</button>
                <button type="button" class="btn btn-primary" id="confirmPaymentBtn">
                    <i class="fas fa-check" aria-hidden="true"></i>
                    <span>Saya Sudah Bayar</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div class="modal" id="notification-modal" aria-labelledby="notificationModalTitle" aria-modal="true" role="dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-xl font-bold" id="notificationModalTitle">Notifikasi</h2>
                <button class="modal-close" aria-label="Tutup modal">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </div>
            <div class="modal-body" id="notificationListContainer">
                <!-- Daftar notifikasi akan dirender di sini -->
                <p id="no-notifications" class="text-muted text-center hidden">Tidak ada notifikasi baru.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary w-full" id="markAllNotificationsReadBtn">Tandai Semua Sudah
                    Dibaca</button>
            </div>
        </div>
    </div>


    <script>
        // State Management (Pusat Data Aplikasi)
        const state = {
            currentView: 'home', // Halaman yang sedang aktif
            previousView: 'home', // Untuk tombol kembali yang lebih cerdas
            currentPropertyId: null, // ID properti yang sedang dilihat detailnya
            currentBookingId: null, // ID booking yang sedang dilihat detailnya
            currentChatTargetId: null, // ID target chat (pemilik properti)
            user: {
                name: 'John Doe',
                email: 'john@example.com',
                avatar: 'JD', // Inisial nama
                verified: true,
                wishlist: ['prop-1'], // Menyimpan ID properti yang di-wishlist
                bookings: [ // Daftar pesanan pengguna
                    {
                        id: 'book-1', propertyId: 'prop-1', ownerId: 'owner-1',
                        propertyName: 'Luxury Penthouse', propertyImage: 'https://picsum.photos/seed/prop1/100/75',
                        checkin: '2025-06-01', checkout: '2025-06-30', guests: 2,
                        totalPrice: 25500000, paymentMethod: 'bca', paymentStatus: 'paid',
                        status: 'confirmed', // confirmed, completed, cancelled
                        createdAt: '2025-05-15T14:30:00Z',
                        timeline: [
                            { status: 'Pesanan Dibuat', date: '2025-05-15T14:30:00Z', note: 'Anda telah membuat pesanan.' },
                            { status: 'Pembayaran Diterima', date: '2025-05-15T15:45:00Z', note: 'Pembayaran dikonfirmasi.' },
                            { status: 'Pesanan Dikonfirmasi', date: '2025-05-15T16:20:00Z', note: 'Pemilik mengkonfirmasi pesanan.' },
                            { status: 'Menunggu Check-in', date: '2025-06-01T00:00:00Z', note: 'Siap untuk check-in.', pending: true },
                        ]
                    },
                    {
                        id: 'book-2', propertyId: 'prop-2', ownerId: 'owner-2',
                        propertyName: 'Modern Studio', propertyImage: 'https://picsum.photos/seed/prop2/100/75',
                        checkin: '2025-05-01', checkout: '2025-05-30', guests: 1,
                        totalPrice: 12300000, paymentMethod: 'gopay', paymentStatus: 'paid',
                        status: 'completed',
                        createdAt: '2025-04-15T10:00:00Z',
                        timeline: [
                            { status: 'Pesanan Dibuat', date: '2025-04-15T10:00:00Z' },
                            { status: 'Pembayaran Diterima', date: '2025-04-15T10:05:00Z' },
                            { status: 'Pesanan Dikonfirmasi', date: '2025-04-15T10:30:00Z' },
                            { status: 'Check-in Selesai', date: '2025-05-01T14:00:00Z' },
                            { status: 'Check-out & Selesai', date: '2025-05-30T12:00:00Z' },
                        ]
                    }
                ],
                notifications: [ // Notifikasi untuk pengguna
                    { id: 'notif-1', type: 'message', from: 'Ahmad Rahman', message: 'Mengirim pesan baru tentang Luxury Penthouse.', time: new Date(Date.now() - 10 * 60 * 1000).toISOString(), read: false, link: '#chat/owner-1' },
                    { id: 'notif-2', type: 'payment', from: 'Sistem Green Valley', message: 'Pembayaran Anda untuk Luxury Penthouse (book-1) telah dikonfirmasi.', time: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(), read: false, link: '#booking-detail/book-1' },
                    { id: 'notif-3', type: 'booking', from: 'Ahmad Rahman', message: 'Menerima permintaan booking Anda untuk Luxury Penthouse.', time: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(), read: true, link: '#booking-detail/book-1' },
                ]
            },
            properties: [ // Data properti (contoh)
                {
                    id: 'prop-1', ownerId: 'owner-1',
                    title: 'Luxury Penthouse Jakarta Pusat', location: 'Jakarta Pusat', type: 'penthouse',
                    price: 25000000, beds: 3, baths: 2, size: 120,
                    image: 'https://picsum.photos/seed/prop1/800/600',
                    images: [
                        'https://picsum.photos/seed/prop1-img1/800/600',
                        'https://picsum.photos/seed/prop1-img2/800/600',
                        'https://picsum.photos/seed/prop1-img3/800/600',
                        'https://picsum.photos/seed/prop1-img4/800/600'
                    ],
                    rating: 4.8, reviewsCount: 24,
                    amenities: ['wifi', 'pool', 'gym', 'parking', 'kitchen', 'tv', 'ac', 'security'],
                    description: 'Penthouse mewah dengan pemandangan kota yang menakjubkan. Terletak di lantai atas dengan akses ke fasilitas premium seperti kolam renang infinity, gym, dan lounge eksklusif. Interior modern dengan perabotan berkualitas tinggi, cocok untuk keluarga atau pebisnis.',
                    address: 'Apartemen Sudirman Tower, Lantai 35, Unit 3501, Jl. Sudirman No. 1, Jakarta Pusat, DKI Jakarta 10220',
                    owner: { name: 'Ahmad Rahman', avatar: 'AR', since: '2022', responseRate: '100%', responseTime: 'dalam 1 jam' },
                    reviews: [
                        { author: 'Budi S.', rating: 5, date: '2025-05-15', text: 'Pengalaman luar biasa! Apartemen sangat nyaman, bersih, dan fasilitas lengkap. Pemandangan kota dari atas sangat indah. Pemilik, Pak Ahmad, sangat responsif dan membantu. Sangat direkomendasikan!' },
                        { author: 'Citra L.', rating: 4, date: '2025-04-10', text: 'Apartemennya bagus dan mewah. Lokasi strategis. Hanya saja suara dari jalan raya sedikit terdengar jika jendela dibuka. Overall, sangat puas.' },
                    ]
                },
                {
                    id: 'prop-2', ownerId: 'owner-2',
                    title: 'Modern Studio Nyaman di Jaksel', location: 'Jakarta Selatan', type: 'studio',
                    price: 12000000, beds: 1, baths: 1, size: 45,
                    image: 'https://picsum.photos/seed/prop2/800/600',
                    images: ['https://picsum.photos/seed/prop2-img1/800/600', 'https://picsum.photos/seed/prop2-img2/800/600'],
                    rating: 4.2, reviewsCount: 15,
                    amenities: ['wifi', 'parking', 'kitchen', 'tv', 'ac'],
                    description: 'Studio modern dengan desain minimalis dan fasilitas lengkap. Lokasi strategis dekat dengan pusat perbelanjaan, kafe, dan transportasi umum. Ideal untuk profesional muda atau pasangan.',
                    address: 'Apartemen Bellagio Residence, Tower A, Lantai 10, Jl. Panglima Polim No. 10, Kebayoran Baru, Jakarta Selatan 12160',
                    owner: { name: 'Siti Lestari', avatar: 'SL', since: '2021', responseRate: '95%', responseTime: 'dalam 2 jam' },
                    reviews: [{ author: 'Rizky A.', rating: 4, date: '2025-03-20', text: 'Studio yang bersih dan nyaman. Sesuai dengan deskripsi. Proses check-in mudah.' }]
                },
                {
                    id: 'prop-3', ownerId: 'owner-3',
                    title: 'Cozy 1BR Apartment Bandung', location: 'Bandung', type: '1br',
                    price: 8000000, beds: 1, baths: 1, size: 50,
                    image: 'https://picsum.photos/seed/prop3/800/600',
                    images: ['https://picsum.photos/seed/prop3-img1/800/600'],
                    rating: 4.7, reviewsCount: 8,
                    amenities: ['wifi', 'parking', 'kitchen', 'tv', 'ac', 'heater'],
                    description: 'Apartemen 1 kamar tidur yang cozy dengan suasana tenang dan nyaman. Dekat dengan pusat kuliner Dago, factory outlet, dan tempat wisata populer di Bandung Utara.',
                    address: 'The Majesty Apartment, Jl. Dago Pakar Indah No. 25, Ciburial, Bandung, Jawa Barat 40198',
                    owner: { name: 'Eka Permana', avatar: 'EP', since: '2023', responseRate: '100%', responseTime: 'dalam 30 menit' },
                    reviews: []
                },
                {
                    id: 'prop-4', ownerId: 'owner-4',
                    title: 'Spacious 2BR Family Apartment Surabaya', location: 'Surabaya', type: '2br',
                    price: 15000000, beds: 2, baths: 2, size: 90,
                    image: 'https://picsum.photos/seed/prop4/800/600',
                    images: ['https://picsum.photos/seed/prop4-img1/800/600', 'https://picsum.photos/seed/prop4-img2/800/600', 'https://picsum.photos/seed/prop4-img3/800/600'],
                    rating: 4.5, reviewsCount: 18,
                    amenities: ['wifi', 'pool', 'gym', 'parking', 'kitchen', 'tv', 'ac', 'playground'],
                    description: 'Apartemen 2 kamar tidur yang luas, cocok untuk keluarga. Terletak di pusat kota Surabaya, dekat dengan mall besar dan akses mudah ke berbagai area. Fasilitas gedung lengkap termasuk kolam renang dan area bermain anak.',
                    address: 'Pakuwon Residence, Tower C, Lantai 22, Jl. Mayjen Yono Suwoyo No. 2, Surabaya, Jawa Timur 60227',
                    owner: { name: 'Dewi Anggraini', avatar: 'DA', since: '2022', responseRate: '98%', responseTime: 'dalam 1 jam' },
                    reviews: [
                        { author: 'Andi W.', rating: 5, date: '2025-06-01', text: 'Sangat puas! Apartemen luas, bersih, dan nyaman untuk keluarga. Anak-anak suka kolam renangnya. Lokasi juga oke banget.' },
                    ]
                }
            ],
            searchFilters: { // Filter pencarian yang aktif
                location: '', price: 50000000, type: [], amenities: [], checkin: '', checkout: ''
            },
            chatMessages: { // Pesan chat, di-grup berdasarkan target chat (ownerId)
                'owner-1': [
                    { id: 'msg1', from: 'owner', text: 'Halo, ada yang bisa saya bantu terkait Luxury Penthouse?', time: new Date(Date.now() - 5 * 60 * 1000).toISOString() },
                    { id: 'msg2', from: 'user', text: 'Halo Pak Ahmad, saya tertarik. Apakah tersedia untuk 1-30 Juni?', time: new Date(Date.now() - 4 * 60 * 1000).toISOString() },
                ],
                'owner-2': [
                    { id: 'msg3', from: 'owner', text: 'Selamat datang di Modern Studio. Ada pertanyaan?', time: new Date(Date.now() - 10 * 60 * 1000).toISOString() },
                ]
            },
            serviceFeePercentage: 0.02, // 2% biaya layanan
            minBookingDurationDays: 1, // Durasi minimal booking
        };

        // Utility Functions (Fungsi Bantuan)
        const utils = {
            $: (selector) => document.querySelector(selector), // Mirip jQuery $
            $$: (selector) => document.querySelectorAll(selector), // Mirip jQuery $
            formatPrice: (price) => { // Format harga ke Rupiah
                return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(price);
            },
            formatDate: (dateString, options = { year: 'numeric', month: 'long', day: 'numeric' }) => { // Format tanggal
                if (!dateString) return 'N/A';
                return new Date(dateString).toLocaleDateString('id-ID', options);
            },
            formatTimeAgo: (dateString) => { // Format waktu relatif (misal: 10 menit lalu)
                if (!dateString) return '';
                const date = new Date(dateString);
                const now = new Date();
                const seconds = Math.round((now - date) / 1000);
                const minutes = Math.round(seconds / 60);
                const hours = Math.round(minutes / 60);
                const days = Math.round(hours / 24);

                if (seconds < 60) return `${seconds} detik lalu`;
                if (minutes < 60) return `${minutes} menit lalu`;
                if (hours < 24) return `${hours} jam lalu`;
                if (days === 1) return `kemarin`;
                if (days < 7) return `${days} hari lalu`;
                return utils.formatDate(dateString);
            },
            getPropertyById: (id) => state.properties.find(p => p.id === id), // Cari properti berdasarkan ID
            getBookingById: (id) => state.user.bookings.find(b => b.id === id), // Cari booking berdasarkan ID
            getOwnerById: (ownerId) => { // Cari data pemilik (jika ada struktur data pemilik terpisah)
                // Untuk demo ini, kita ambil dari properti pertama yg cocok dengan ownerId
                const prop = state.properties.find(p => p.ownerId === ownerId);
                return prop ? prop.owner : { name: 'Pemilik Tidak Ditemukan', avatar: '?', since: '', responseRate: 'N/A', responseTime: 'N/A' };
            },
            getDaysBetweenDates: (date1, date2) => {
                if (!date1 || !date2) return 0;
                const d1 = new Date(date1);
                const d2 = new Date(date2);
                const diffTime = Math.abs(d2 - d1);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            },
            // Fungsi debounce untuk menunda eksekusi fungsi (misal: pada input range harga)
            debounce: (func, delay) => {
                let timeoutId;
                return (...args) => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => func.apply(null, args), delay);
                };
            },
            // Fungsi untuk menghasilkan ID unik sederhana
            generateId: (prefix = 'id') => `${prefix}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
            // Fungsi untuk membersihkan string HTML untuk keamanan dasar
            sanitizeHTML: (str) => {
                const temp = document.createElement('div');
                temp.textContent = str;
                return temp.innerHTML;
            }
        };

        // DOM Elements (Referensi ke elemen-elemen HTML)
        const elements = {
            // Navigasi & Umum
            views: utils.$$('.view'),
            navLinksContainer: utils.$('#navLinks'),
            navLinks: utils.$$('.nav-link'),
            mobileMenuBtn: utils.$('#mobileMenuBtn'),
            notificationBtn: utils.$('.notification-badge'),
            mainContent: utils.$('#main-content'),
            currentYearSpan: utils.$('#currentYear'),

            // Beranda
            quickSearchForm: utils.$('#quickSearchForm'),
            quickLocationInput: utils.$('#quick-location'),
            quickCheckinInput: utils.$('#quick-checkin'),
            quickCheckoutInput: utils.$('#quick-checkout'),
            recommendedPropertiesContainer: utils.$('#recommendedProperties'),
            popularPropertiesContainer: utils.$('#popularProperties'),

            // Pencarian
            searchFiltersForm: utils.$('#searchFiltersForm'),
            searchLocationInput: utils.$('#search-location'),
            priceRangeInput: utils.$('#price-range'),
            priceValueSpan: utils.$('#price-value'),
            typeFiltersContainer: utils.$('#type-filters'),
            amenitiesFiltersContainer: utils.$('#amenities-filters'),
            searchResultsContainer: utils.$('#searchResults'),
            searchResultsCount: utils.$('#searchResultsCount'),
            noSearchResultsMessage: utils.$('#no-search-results'),

            // Detail Properti
            propertyDetailTitle: utils.$('#property-detail-title'),
            propertyDetailType: utils.$('#property-detail-type'),
            propertyDetailLocation: utils.$('#property-detail-location'),
            propertyDetailPrice: utils.$('#property-detail-price'),
            propertyGalleryContainer: utils.$('#property-gallery'),
            propertyDetailSpecs: utils.$('#property-detail-specs'),
            propertyDetailDescription: utils.$('#property-detail-description'),
            propertyDetailRating: utils.$('#property-detail-rating'),
            propertyDetailAmenities: utils.$('#property-detail-amenities'),
            propertyDetailAddress: utils.$('#property-detail-address'),
            propertyReviewsList: utils.$('#property-reviews-list'),
            propertyReviewCount: utils.$('#property-review-count'),
            addReviewForm: utils.$('#addReviewForm'),
            detailWishlistBtn: utils.$('#detailWishlistBtn'),
            backToPrevViewBtn: utils.$('#backToPrevViewBtn'), // Tombol kembali di detail properti
            propertyBookingForm: utils.$('#propertyBookingForm'),
            checkinDateInput: utils.$('#checkin-date'),
            checkoutDateInput: utils.$('#checkout-date'),
            guestsSelect: utils.$('#guests'),
            availabilityMessage: utils.$('#availability-message'),
            unavailabilityMessage: utils.$('#unavailability-message'),
            bookingSummaryContainer: utils.$('#booking-summary'),
            bookingPriceCalcSpan: utils.$('#booking-price-calc'),
            bookingSubtotalSpan: utils.$('#booking-subtotal'),
            bookingServiceFeeSpan: utils.$('#booking-service-fee'),
            bookingTotalSpan: utils.$('#booking-total'),
            ownerInfoCard: { // Grouping elemen pemilik
                avatar: utils.$('#owner-avatar'),
                name: utils.$('#owner-name'),
                since: utils.$('#owner-since'),
                responseRate: utils.$('#owner-response-rate'),
                responseTime: utils.$('#owner-response-time'),
                contactBtn: utils.$('#contactOwnerBtn'),
            },


            // Wishlist
            wishlistPropertiesContainer: utils.$('#wishlistPropertiesContainer'),
            emptyWishlistMessage: utils.$('#emptyWishlistMessage'),

            // Pesanan (Bookings)
            tabs: utils.$$('.tab'),
            tabContents: utils.$$('.tab-content'),
            upcomingBookingsList: utils.$('#upcoming-bookings-list'),
            completedBookingsList: utils.$('#completed-bookings-list'),
            cancelledBookingsList: utils.$('#cancelled-bookings-list'),
            noUpcomingBookingsMessage: utils.$('#no-upcoming-bookings-message'),
            noCompletedBookingsMessage: utils.$('#no-completed-bookings-message'),
            noCancelledBookingsMessage: utils.$('#no-cancelled-bookings-message'),

            // Detail Pesanan
            bookingDetailContainer: utils.$('#booking-detail-content'),
            bookingDetailIdSpan: utils.$('#booking-detail-id'),
            backToBookingsBtn: utils.$('#backToBookingsBtn'),

            // Chat
            chatWithNameSpan: utils.$('#chat-with-name'),
            chatAvatar: utils.$('#chat-avatar'),
            chatContactName: utils.$('#chat-contact-name'),
            chatContactStatus: utils.$('#chat-contact-status'),
            chatMessagesContainer: utils.$('#chatMessagesContainer'),
            chatMessageForm: utils.$('#chatMessageForm'),
            chatMessageInput: utils.$('#chat-message-input'),
            backFromChatBtn: utils.$('#backFromChatBtn'),

            // Modal
            bookingModal: utils.$('#booking-modal'),
            bookingModalSummary: utils.$('#booking-modal-summary'),
            paymentMethodSelect: utils.$('#payment-method'),
            termsAgreeCheckbox: utils.$('#terms-agree'),
            cancelBookingBtn: utils.$('#cancelBookingBtn'),
            confirmBookingBtn: utils.$('#confirmBookingBtn'),

            paymentModal: utils.$('#payment-modal'),
            paymentBookingIdSpan: utils.$('#payment-booking-id'),
            paymentInstructionsContainer: utils.$('#payment-instructions'),
            paymentProofInput: utils.$('#payment-proof'),
            payLaterBtn: utils.$('#payLaterBtn'),
            confirmPaymentBtn: utils.$('#confirmPaymentBtn'),

            notificationModal: utils.$('#notification-modal'),
            notificationListContainer: utils.$('#notificationListContainer'),
            noNotificationsMessage: utils.$('#no-notifications'),
            markAllNotificationsReadBtn: utils.$('#markAllNotificationsReadBtn'),
        };

        // Render Functions (Fungsi untuk menampilkan data ke HTML)
        const render = {
            // Render kartu properti
            propertyCard: (property, isWishlistPage = false) => {
                const isInWishlist = state.user.wishlist.includes(property.id);
                return `
                    <article class="property-card card" data-id="${property.id}" aria-labelledby="prop-title-${property.id}">
                        <div class="relative">
                            <img src="${property.image}" alt="Tampilan ${property.title}" class="property-image" loading="lazy">
                            <div class="property-badge">${property.type.toUpperCase()}</div>
                            <button class="wishlist-btn btn-icon" data-id="${property.id}" aria-pressed="${isInWishlist}" aria-label="${isInWishlist ? 'Hapus dari favorit' : 'Tambah ke favorit'}">
                                <i class="${isInWishlist ? 'fas' : 'far'} fa-heart" aria-hidden="true"></i>
                            </button>
                        </div>
                        <div class="card-body p-3 flex flex-col flex-grow">
                            <h3 id="prop-title-${property.id}" class="font-bold mb-1 text-base">${utils.sanitizeHTML(property.title)}</h3>
                            <div class="property-price mb-1">${utils.formatPrice(property.price)}/bulan</div>
                            <div class="property-location mb-2">
                                <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
                                <span>${utils.sanitizeHTML(property.location)}</span>
                            </div>
                            <div class="property-rating mt-auto"> <!-- mt-auto pushes rating to bottom if card height varies -->
                                <i class="fas fa-star" aria-hidden="true"></i>
                                <span>${property.rating} (${property.reviewsCount} ulasan)</span>
                            </div>
                            ${isWishlistPage ? `
                                <button class="btn btn-danger btn-sm mt-3 remove-wishlist-item" data-id="${property.id}">
                                    <i class="fas fa-trash-alt"></i> Hapus
                                </button>` : ''}
                        </div>
                    </article>
                `;
            },
            // Render properti rekomendasi di Beranda
            recommendedProperties: () => {
                const recommended = state.properties.slice(0, 4); // Ambil 4 properti pertama
                elements.recommendedPropertiesContainer.innerHTML = recommended.map(p => render.propertyCard(p)).join('');
            },
            // Render properti populer di Beranda
            popularProperties: () => {
                // Sortir berdasarkan rating (desc) lalu ambil 4 teratas
                const popular = [...state.properties].sort((a, b) => b.rating - a.rating).slice(0, 4);
                elements.popularPropertiesContainer.innerHTML = popular.map(p => render.propertyCard(p)).join('');
            },
            // Render hasil pencarian
            searchResults: () => {
                const { location, price, type, amenities } = state.searchFilters;
                const filtered = state.properties.filter(p => {
                    const matchLocation = !location || p.location.toLowerCase().includes(location.toLowerCase()) || p.title.toLowerCase().includes(location.toLowerCase());
                    const matchPrice = p.price <= price;
                    const matchType = type.length === 0 || type.includes(p.type);
                    const matchAmenities = amenities.length === 0 || amenities.every(am => p.amenities.includes(am));
                    return matchLocation && matchPrice && matchType && matchAmenities;
                });

                elements.searchResultsCount.textContent = `Hasil Pencarian (${filtered.length})`;
                if (filtered.length > 0) {
                    elements.searchResultsContainer.innerHTML = filtered.map(p => render.propertyCard(p)).join('');
                    elements.noSearchResultsMessage.classList.add('hidden');
                    elements.searchResultsContainer.classList.remove('hidden');
                } else {
                    elements.searchResultsContainer.innerHTML = '';
                    elements.noSearchResultsMessage.classList.remove('hidden');
                    elements.searchResultsContainer.classList.add('hidden');
                }
            },
            // Render daftar favorit
            wishlistProperties: () => {
                const wishlistItems = state.properties.filter(p => state.user.wishlist.includes(p.id));
                if (wishlistItems.length > 0) {
                    elements.wishlistPropertiesContainer.innerHTML = wishlistItems.map(p => render.propertyCard(p, true)).join('');
                    elements.emptyWishlistMessage.classList.add('hidden');
                    elements.wishlistPropertiesContainer.classList.remove('hidden');
                } else {
                    elements.wishlistPropertiesContainer.innerHTML = '';
                    elements.emptyWishlistMessage.classList.remove('hidden');
                    elements.wishlistPropertiesContainer.classList.add('hidden');
                }
            },
            // Render detail properti
            propertyDetail: () => {
                const property = utils.getPropertyById(state.currentPropertyId);
                if (!property) {
                    // Handle properti tidak ditemukan, mungkin kembali ke halaman search atau home
                    view.show('search');
                    alert('Properti tidak ditemukan.');
                    return;
                }

                elements.propertyDetailTitle.textContent = property.title;
                elements.propertyDetailType.textContent = `${property.type.charAt(0).toUpperCase() + property.type.slice(1)} Apartment`;
                elements.propertyDetailLocation.textContent = property.location;
                elements.propertyDetailPrice.textContent = `${utils.formatPrice(property.price)}/bulan`;

                // Gallery
                elements.propertyGalleryContainer.innerHTML = property.images.map((img, index) => `
                    <figure class="card shadow-sm">
                        <img src="${img}" alt="Galeri ${property.title} ${index + 1}" class="w-full h-48 object-cover rounded-t" loading="lazy">
                         <figcaption class="p-2 text-center text-xs text-muted">Tampilan ${index + 1}</figcaption>
                    </figure>
                `).join('');
                // Jika tidak ada gambar utama, gunakan gambar pertama dari galeri.
                if (property.images.length > 0 && !property.image) property.image = property.images[0];


                // Spesifikasi
                elements.propertyDetailSpecs.innerHTML = `
                    <div class="flex items-center gap-1"><i class="fas fa-bed fa-fw" aria-hidden="true"></i> ${property.beds} Kamar Tidur</div>
                    <div class="flex items-center gap-1"><i class="fas fa-bath fa-fw" aria-hidden="true"></i> ${property.baths} Kamar Mandi</div>
                    <div class="flex items-center gap-1"><i class="fas fa-ruler-combined fa-fw" aria-hidden="true"></i> ${property.size} m¬≤</div>
                `;

                elements.propertyDetailDescription.textContent = property.description;

                // Rating
                let ratingStars = '';
                for (let i = 1; i <= 5; i++) {
                    if (i <= property.rating) ratingStars += '<i class="fas fa-star"></i>';
                    else if (i - 0.5 <= property.rating) ratingStars += '<i class="fas fa-star-half-alt"></i>';
                    else ratingStars += '<i class="far fa-star"></i>';
                }
                elements.propertyDetailRating.innerHTML = `${ratingStars} <span class="ml-1">${property.rating} (${property.reviewsCount} ulasan)</span>`;

                // Fasilitas
                const amenityIcons = { wifi: 'fa-wifi', pool: 'fa-swimming-pool', gym: 'fa-dumbbell', parking: 'fa-parking', kitchen: 'fa-utensils', tv: 'fa-tv', ac: 'fa-snowflake', security: 'fa-shield-alt', heater: 'fa-thermometer-three-quarters', playground: 'fa-puzzle-piece' };
                elements.propertyDetailAmenities.innerHTML = property.amenities.map(am => `
                    <div class="flex items-center gap-2 p-2 bg-surface-hover rounded text-sm">
                        <i class="fas ${amenityIcons[am] || 'fa-check-circle'} text-primary fa-fw" aria-hidden="true"></i>
                        <span>${am.charAt(0).toUpperCase() + am.slice(1)}</span>
                    </div>
                `).join('');

                elements.propertyDetailAddress.textContent = property.address;

                // Ulasan
                elements.propertyReviewCount.textContent = property.reviews.length;
                if (property.reviews.length > 0) {
                    elements.propertyReviewsList.innerHTML = property.reviews.map(review => `
                        <div class="review">
                            <div class="review-header">
                                <span class="review-author font-semibold">${utils.sanitizeHTML(review.author)}</span>
                                <span class="review-date text-xs">${utils.formatDate(review.date)}</span>
                            </div>
                            <div class="review-rating text-sm my-1">
                                ${[...Array(5)].map((_, i) => `<i class="fas fa-star ${i < review.rating ? 'text-warning' : 'text-muted opacity-50'}"></i>`).join('')}
                            </div>
                            <p class="review-body text-sm">${utils.sanitizeHTML(review.text)}</p>
                        </div>
                    `).join('');
                } else {
                    elements.propertyReviewsList.innerHTML = '<p class="text-muted text-sm">Belum ada ulasan untuk properti ini.</p>';
                }
                // Update tombol wishlist
                const isInWishlist = state.user.wishlist.includes(property.id);
                elements.detailWishlistBtn.innerHTML = `<i class="${isInWishlist ? 'fas' : 'far'} fa-heart" aria-hidden="true"></i> <span>${isInWishlist ? 'Disimpan' : 'Simpan'}</span>`;
                elements.detailWishlistBtn.setAttribute('aria-pressed', isInWishlist);


                // Info Pemilik
                const owner = property.owner;
                elements.ownerInfoCard.avatar.textContent = owner.avatar;
                elements.ownerInfoCard.name.textContent = owner.name;
                elements.ownerInfoCard.since.textContent = owner.since;
                elements.ownerInfoCard.responseRate.textContent = owner.responseRate;
                elements.ownerInfoCard.responseTime.textContent = owner.responseTime;
            },
            // Render daftar pesanan
            bookings: () => {
                const statusMap = {
                    upcoming: state.user.bookings.filter(b => b.status === 'confirmed' && new Date(b.checkin) >= new Date()),
                    completed: state.user.bookings.filter(b => b.status === 'completed' || (b.status === 'confirmed' && new Date(b.checkout) < new Date())),
                    cancelled: state.user.bookings.filter(b => b.status === 'cancelled'),
                };

                const renderList = (type, container, emptyMessageEl) => {
                    const list = statusMap[type];
                    if (list.length === 0) {
                        container.innerHTML = '';
                        emptyMessageEl.classList.remove('hidden');
                        return;
                    }
                    emptyMessageEl.classList.add('hidden');
                    container.innerHTML = list.map(booking => {
                        const property = utils.getPropertyById(booking.propertyId) || { title: booking.propertyName || 'Properti Tidak Dikenal', location: 'N/A' };
                        const statusText = { confirmed: 'Dikonfirmasi', completed: 'Selesai', cancelled: 'Dibatalkan' };
                        const statusClass = { confirmed: 'bg-success', completed: 'bg-muted', cancelled: 'bg-danger' };
                        return `
                            <article class="card mb-4" data-booking-id="${booking.id}">
                                <div class="card-body">
                                    <div class="flex flex-col sm:flex-row gap-4">
                                        <img src="${booking.propertyImage || property.image || 'https://via.placeholder.com/100x75?text=Apartemen'}" alt="${utils.sanitizeHTML(property.title)}" class="w-full sm:w-32 h-32 sm:h-24 object-cover rounded">
                                        <div class="flex-grow">
                                            <div class="flex justify-between items-start mb-1">
                                                <h2 class="text-lg font-semibold">${utils.sanitizeHTML(property.title)}</h2>
                                                <span class="badge ${statusClass[booking.status] || 'bg-muted'} text-xs">${statusText[booking.status] || booking.status}</span>
                                            </div>
                                            <div class="text-sm text-muted mb-1">
                                                <i class="fas fa-map-marker-alt fa-fw"></i> ${utils.sanitizeHTML(property.location)}
                                            </div>
                                            <div class="text-sm text-muted mb-2">
                                                <i class="fas fa-calendar-alt fa-fw"></i> ${utils.formatDate(booking.checkin)} - ${utils.formatDate(booking.checkout)}
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <div class="property-price text-base font-bold">${utils.formatPrice(booking.totalPrice)}</div>
                                                <div class="flex gap-2">
                                                    <button class="btn btn-primary btn-sm view-booking-detail" data-id="${booking.id}">
                                                        <i class="fas fa-file-invoice"></i> Detail
                                                    </button>
                                                    ${booking.status === 'confirmed' ? `
                                                        <button class="btn btn-danger btn-sm cancel-booking-btn" data-id="${booking.id}">
                                                            <i class="fas fa-times"></i> Batalkan
                                                        </button>` : ''}
                                                    ${booking.status === 'completed' ? `
                                                        <button class="btn btn-outline btn-sm rebook-btn" data-id="${booking.propertyId}">
                                                            <i class="fas fa-redo"></i> Pesan Lagi
                                                        </button>` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </article>
                        `;
                    }).join('');
                };
                renderList('upcoming', elements.upcomingBookingsList, elements.noUpcomingBookingsMessage);
                renderList('completed', elements.completedBookingsList, elements.noCompletedBookingsMessage);
                renderList('cancelled', elements.cancelledBookingsList, elements.noCancelledBookingsMessage);
            },
            // Render detail pesanan
            bookingDetail: () => {
                const booking = utils.getBookingById(state.currentBookingId);
                if (!booking) {
                    elements.bookingDetailContainer.innerHTML = '<p class="text-danger">Detail pesanan tidak ditemukan.</p>';
                    return;
                }
                const property = utils.getPropertyById(booking.propertyId) || { title: 'Properti Tidak Dikenal', address: 'N/A' };
                const owner = property.owner || { name: 'Pemilik', avatar: '?' };

                elements.bookingDetailIdSpan.textContent = `#${booking.id.toUpperCase()}`;
                elements.bookingDetailContainer.innerHTML = `
                    <div class="card mb-4">
                        <div class="card-header flex justify-between items-center">
                            <h2 class="text-xl font-bold">${utils.sanitizeHTML(property.title)}</h2>
                            <span class="badge ${booking.status === 'confirmed' ? 'bg-success' : booking.status === 'completed' ? 'bg-muted' : 'bg-danger'}">
                                ${booking.status.charAt(0).toUpperCase() + booking.status.slice(1)}
                            </span>
                        </div>
                        <div class="card-body">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <h3 class="font-semibold mb-2">Detail Pemesanan</h3>
                                    <p class="text-sm mb-1"><span class="text-muted">ID Pesanan:</span> ${booking.id}</p>
                                    <p class="text-sm mb-1"><span class="text-muted">Tanggal Pesan:</span> ${utils.formatDate(booking.createdAt)}</p>
                                    <p class="text-sm mb-1"><span class="text-muted">Check-in:</span> ${utils.formatDate(booking.checkin)}</p>
                                    <p class="text-sm mb-1"><span class="text-muted">Check-out:</span> ${utils.formatDate(booking.checkout)}</p>
                                    <p class="text-sm mb-1"><span class="text-muted">Durasi:</span> ${utils.getDaysBetweenDates(booking.checkin, booking.checkout)} malam</p>
                                    <p class="text-sm mb-1"><span class="text-muted">Jumlah Tamu:</span> ${booking.guests} orang</p>
                                </div>
                                <div>
                                    <h3 class="font-semibold mb-2">Detail Pembayaran</h3>
                                    <p class="text-sm mb-1"><span class="text-muted">Total Biaya:</span> <span class="font-semibold">${utils.formatPrice(booking.totalPrice)}</span></p>
                                    <p class="text-sm mb-1"><span class="text-muted">Metode:</span> ${booking.paymentMethod.toUpperCase()}</p>
                                    <p class="text-sm mb-1"><span class="text-muted">Status:</span> <span class="${booking.paymentStatus === 'paid' ? 'text-success' : 'text-warning'}">${booking.paymentStatus === 'paid' ? 'Lunas' : 'Belum Lunas'}</span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-body">
                            <h2 class="text-xl font-bold mb-3">Informasi Properti & Check-in</h2>
                             <p class="text-sm mb-1"><span class="text-muted">Alamat:</span> ${utils.sanitizeHTML(property.address)}</p>
                             <p class="text-sm mb-1"><span class="text-muted">Pemilik:</span> ${utils.sanitizeHTML(owner.name)}</p>
                             <p class="text-sm mt-2"><em>Instruksi check-in akan dikirimkan melalui email dan notifikasi mendekati tanggal check-in Anda.</em></p>
                             <button class="btn btn-outline btn-sm mt-3 contact-owner-from-booking" data-owner-id="${property.ownerId}">
                                <i class="fas fa-comment-dots"></i> Hubungi Pemilik
                             </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <h2 class="text-xl font-bold mb-3">Linimasa Pesanan</h2>
                            <div class="timeline">
                                ${booking.timeline.map(item => `
                                    <div class="timeline-item ${item.pending ? 'pending' : 'completed'}">
                                        <div class="timeline-dot"></div>
                                        <div class="timeline-content">
                                            <h3 class="font-semibold text-sm">${utils.sanitizeHTML(item.status)}</h3>
                                            <p class="timeline-date text-xs">${utils.formatDate(item.date, { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                                            ${item.note ? `<p class="text-xs mt-1">${utils.sanitizeHTML(item.note)}</p>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            },

            // Render pesan chat
            chatMessages: () => {
                const ownerId = state.currentChatTargetId;
                const messages = state.chatMessages[ownerId] || [];
                const owner = utils.getOwnerById(ownerId);

                elements.chatWithNameSpan.textContent = owner.name;
                elements.chatAvatar.textContent = owner.avatar;
                elements.chatContactName.textContent = owner.name;
                elements.chatContactStatus.textContent = `Pemilik Properti`; // Bisa lebih dinamis

                if (messages.length === 0) {
                    elements.chatMessagesContainer.innerHTML = `<p class="text-center text-muted p-4">Mulai percakapan dengan ${owner.name}.</p>`;
                    return;
                }
                elements.chatMessagesContainer.innerHTML = messages.map(msg => `
                    <div class="chat-message ${msg.from === 'user' ? 'sent' : 'received'}">
                        <p>${utils.sanitizeHTML(msg.text)}</p>
                        <div class="chat-meta">
                            <span>${msg.from === 'user' ? 'Anda' : owner.name}</span> &bull;
                            <span>${utils.formatTimeAgo(msg.time)}</span>
                        </div>
                    </div>
                `).join('');
                // Scroll ke pesan terakhir
                elements.chatMessagesContainer.scrollTop = elements.chatMessagesContainer.scrollHeight;
            },
            // Render notifikasi
            notifications: () => {
                const unreadCount = state.user.notifications.filter(n => !n.read).length;
                elements.notificationBtn.setAttribute('data-count', unreadCount);
                elements.notificationBtn.setAttribute('aria-label', `Notifikasi (${unreadCount} belum dibaca)`);


                if (state.user.notifications.length === 0) {
                    elements.noNotificationsMessage.classList.remove('hidden');
                    elements.notificationListContainer.innerHTML = ''; // Bersihkan list jika ada
                } else {
                    elements.noNotificationsMessage.classList.add('hidden');
                    elements.notificationListContainer.innerHTML = `
                        <div class="flex flex-col gap-2">
                            ${state.user.notifications.map(n => `
                                <a href="${n.link || '#'}" class="notification-item flex gap-3 p-3 rounded hover:bg-surface-hover ${!n.read ? 'font-semibold bg-primary/5' : ''}" data-notif-id="${n.id}">
                                    <div class="user-avatar ${n.type === 'payment' || n.type === 'system' ? 'bg-success' : 'bg-primary'} text-sm">${n.from.substring(0, 2).toUpperCase()}</div>
                                    <div class="flex-grow">
                                        <p class="text-sm leading-tight">${utils.sanitizeHTML(n.message)}</p>
                                        <p class="text-xs text-muted mt-1">${utils.formatTimeAgo(n.time)}</p>
                                    </div>
                                    ${!n.read ? '<div class="w-2 h-2 bg-primary rounded-full self-center" aria-label="Belum dibaca"></div>' : ''}
                                </a>
                            `).join('')}
                        </div>
                    `;
                }
            },
            // Update nilai harga pada slider
            updatePriceValue: (value) => {
                elements.priceValueSpan.textContent = utils.formatPrice(value);
            },
            // Update ringkasan booking di sidebar detail properti
            updateBookingSidebarSummary: () => {
                const property = utils.getPropertyById(state.currentPropertyId);
                if (!property) return;

                const checkin = elements.checkinDateInput.value;
                const checkout = elements.checkoutDateInput.value;

                if (checkin && checkout && new Date(checkout) > new Date(checkin)) {
                    const nights = utils.getDaysBetweenDates(checkin, checkout);
                    if (nights < state.minBookingDurationDays) {
                        elements.bookingSummaryContainer.classList.add('hidden');
                        elements.unavailabilityMessage.textContent = `Durasi sewa minimal ${state.minBookingDurationDays} malam/hari.`;
                        elements.unavailabilityMessage.classList.remove('hidden');
                        elements.availabilityMessage.classList.add('hidden');
                        return;
                    }

                    const subtotal = property.price * (nights / 30); // Asumsi harga per bulan, hitung proporsional
                    const serviceFee = subtotal * state.serviceFeePercentage;
                    const total = subtotal + serviceFee;

                    elements.bookingPriceCalcSpan.textContent = `${utils.formatPrice(property.price)} x ${nights} malam (proporsional)`;
                    elements.bookingSubtotalSpan.textContent = utils.formatPrice(subtotal);
                    elements.bookingServiceFeeSpan.textContent = utils.formatPrice(serviceFee);
                    elements.bookingTotalSpan.textContent = utils.formatPrice(total);

                    elements.bookingSummaryContainer.classList.remove('hidden');
                    elements.availabilityMessage.classList.remove('hidden');
                    elements.unavailabilityMessage.classList.add('hidden');
                } else {
                    elements.bookingSummaryContainer.classList.add('hidden');
                    elements.availabilityMessage.classList.add('hidden');
                    if (checkin && checkout && new Date(checkout) <= new Date(checkin)) {
                        elements.unavailabilityMessage.textContent = 'Tanggal check-out harus setelah check-in.';
                        elements.unavailabilityMessage.classList.remove('hidden');
                    } else {
                        elements.unavailabilityMessage.classList.add('hidden');
                    }
                }
            },
        };

        // View Management (Manajemen Tampilan/Halaman)
        const view = {
            // Fungsi untuk menampilkan halaman tertentu
            show: (viewId, params = null) => {
                state.previousView = state.currentView; // Simpan view sebelumnya
                state.currentView = viewId;

                elements.views.forEach(v => v.classList.add('hidden'));
                const targetView = utils.$(`#${viewId}`);
                if (targetView) {
                    targetView.classList.remove('hidden');
                    // Update URL hash
                    if (params) {
                        window.location.hash = `${viewId}/${params}`;
                    } else {
                        window.location.hash = viewId;
                    }

                    // Update link navigasi aktif
                    elements.navLinks.forEach(link => {
                        link.classList.toggle('active', link.dataset.route === viewId);
                    });
                    // Gulir ke atas halaman
                    window.scrollTo(0, 0);
                    // Fokus ke elemen utama di view baru untuk aksesibilitas
                    targetView.setAttribute('tabindex', '-1');
                    targetView.focus();

                    // Panggil fungsi render yang sesuai
                    switch (viewId) {
                        case 'home':
                            render.recommendedProperties();
                            render.popularProperties();
                            break;
                        case 'search':
                            render.searchResults(); // Mungkin perlu dipanggil ulang jika filter berubah dari URL
                            break;
                        case 'wishlist':
                            render.wishlistProperties();
                            break;
                        case 'bookings':
                            render.bookings();
                            break;
                        case 'property':
                            if (params) state.currentPropertyId = params; // params adalah propertyId
                            render.propertyDetail();
                            render.updateBookingSidebarSummary(); // Initial render untuk summary booking
                            break;
                        case 'booking-detail':
                            if (params) state.currentBookingId = params; // params adalah bookingId
                            render.bookingDetail();
                            break;
                        case 'chat':
                            if (params) state.currentChatTargetId = params; // params adalah ownerId
                            render.chatMessages();
                            break;
                    }
                } else {
                    console.error(`View dengan ID "${viewId}" tidak ditemukan.`);
                    view.show('home'); // Kembali ke home jika view tidak ada
                }
            },
            // Inisialisasi manajemen view berdasarkan URL hash
            init: () => {
                const handleHashChange = () => {
                    const hash = window.location.hash.substring(1); // Hapus '#'
                    let viewId = 'home';
                    let params = null;

                    if (hash) {
                        const parts = hash.split('/');
                        viewId = parts[0];
                        if (parts.length > 1) {
                            params = parts[1];
                        }
                    }
                    view.show(viewId, params);
                };

                window.addEventListener('hashchange', handleHashChange);
                handleHashChange(); // Panggil saat halaman pertama kali dimuat
            }
        };

        // Event Handlers (Penanganan Aksi Pengguna)
        const handlers = {
            // Inisialisasi semua event listener
            init: () => {
                // Navigasi utama
                elements.navLinksContainer.addEventListener('click', (e) => {
                    if (e.target.matches('.nav-link')) {
                        e.preventDefault();
                        const route = e.target.dataset.route;
                        view.show(route);
                        // Tutup menu mobile jika terbuka
                        elements.navLinksContainer.classList.remove('active');
                        elements.mobileMenuBtn.setAttribute('aria-expanded', 'false');
                    }
                });

                // Tombol menu mobile
                elements.mobileMenuBtn.addEventListener('click', () => {
                    const isActive = elements.navLinksContainer.classList.toggle('active');
                    elements.mobileMenuBtn.setAttribute('aria-expanded', isActive.toString());
                    elements.mobileMenuBtn.querySelector('i').classList.toggle('fa-times', isActive);
                    elements.mobileMenuBtn.querySelector('i').classList.toggle('fa-bars', !isActive);

                });

                // Tombol kembali di detail properti
                elements.backToPrevViewBtn.addEventListener('click', () => {
                    view.show(state.previousView || 'search'); // Kembali ke view sebelumnya atau default ke search
                });
                elements.backToBookingsBtn.addEventListener('click', () => view.show('bookings'));
                elements.backFromChatBtn.addEventListener('click', () => view.show(state.previousView || 'home'));


                // Form pencarian cepat (Beranda)
                elements.quickSearchForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(elements.quickSearchForm);
                    state.searchFilters.location = formData.get('location') || '';
                    state.searchFilters.type = formData.get('type') ? [formData.get('type')] : [];
                    state.searchFilters.checkin = formData.get('checkin') || '';
                    // state.searchFilters.checkout = formData.get('checkout') || ''; // Jika diperlukan
                    view.show('search'); // Langsung render hasil pencarian di halaman search
                });

                // Form filter pencarian (Halaman Search)
                elements.searchFiltersForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    handlers.applySearchFilters();
                });
                // Update filter secara dinamis untuk beberapa input
                elements.searchLocationInput.addEventListener('input', utils.debounce(handlers.applySearchFilters, 500));
                elements.priceRangeInput.addEventListener('input', () => {
                    render.updatePriceValue(elements.priceRangeInput.value);
                    utils.debounce(handlers.applySearchFilters, 500)();
                });
                elements.typeFiltersContainer.addEventListener('change', handlers.applySearchFilters);
                elements.amenitiesFiltersContainer.addEventListener('change', handlers.applySearchFilters);


                // Klik pada kartu properti (event delegation)
                document.body.addEventListener('click', (e) => {
                    // Klik tombol wishlist di kartu properti
                    const wishlistBtnCard = e.target.closest('.property-card .wishlist-btn');
                    if (wishlistBtnCard) {
                        e.stopPropagation(); // Hentikan event agar tidak trigger klik kartu
                        const propertyId = wishlistBtnCard.dataset.id;
                        handlers.toggleWishlist(propertyId, wishlistBtnCard);
                        if (state.currentView === 'wishlist') render.wishlistProperties(); // Re-render jika di halaman wishlist
                        return;
                    }

                    // Klik kartu properti untuk lihat detail
                    const propertyCard = e.target.closest('.property-card');
                    if (propertyCard) {
                        const propertyId = propertyCard.dataset.id;
                        view.show('property', propertyId);
                        return;
                    }

                    // Tombol hapus dari wishlist di halaman wishlist
                    const removeWishlistItemBtn = e.target.closest('.remove-wishlist-item');
                    if (removeWishlistItemBtn) {
                        const propertyId = removeWishlistItemBtn.dataset.id;
                        handlers.toggleWishlist(propertyId); // Ini akan menghapus
                        render.wishlistProperties(); // Re-render halaman wishlist
                        return;
                    }
                    // Tombol detail pada daftar booking
                    const viewBookingDetailBtn = e.target.closest('.view-booking-detail');
                    if (viewBookingDetailBtn) {
                        const bookingId = viewBookingDetailBtn.dataset.id;
                        view.show('booking-detail', bookingId);
                        return;
                    }
                    // Tombol "Hubungi Pemilik" dari detail booking
                    const contactOwnerFromBookingBtn = e.target.closest('.contact-owner-from-booking');
                    if (contactOwnerFromBookingBtn) {
                        const ownerId = contactOwnerFromBookingBtn.dataset.ownerId;
                        view.show('chat', ownerId);
                        return;
                    }

                    // Tombol "Batalkan Pesanan"
                    const cancelBookingBtnList = e.target.closest('.cancel-booking-btn');
                    if (cancelBookingBtnList) {
                        const bookingId = cancelBookingBtnList.dataset.id;
                        if (confirm('Apakah Anda yakin ingin membatalkan pesanan ini?')) {
                            handlers.cancelBooking(bookingId);
                        }
                        return;
                    }
                    // Tombol "Pesan Lagi"
                    const rebookBtn = e.target.closest('.rebook-btn');
                    if (rebookBtn) {
                        const propertyId = rebookBtn.dataset.id;
                        view.show('property', propertyId); // Arahkan ke detail properti untuk rebook
                        return;
                    }
                });

                // Tombol wishlist di halaman detail properti
                elements.detailWishlistBtn.addEventListener('click', () => {
                    if (state.currentPropertyId) {
                        handlers.toggleWishlist(state.currentPropertyId, elements.detailWishlistBtn);
                    }
                });
                // Tombol Hubungi Pemilik di halaman detail properti
                elements.ownerInfoCard.contactBtn.addEventListener('click', () => {
                    const property = utils.getPropertyById(state.currentPropertyId);
                    if (property && property.ownerId) {
                        view.show('chat', property.ownerId);
                    }
                });

                // Form tambah ulasan
                elements.addReviewForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const text = utils.$('#review-text').value.trim();
                    const rating = parseInt(utils.$('#review-rating').value);
                    if (text && rating && state.currentPropertyId) {
                        handlers.addReview(state.currentPropertyId, state.user.name, rating, text);
                        elements.addReviewForm.reset();
                    } else {
                        alert('Harap isi ulasan dan rating.');
                    }
                });

                // Tabs di halaman pesanan
                elements.tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabId = tab.dataset.tab;
                        elements.tabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        elements.tabContents.forEach(content => {
                            content.classList.toggle('active', content.id === `${tabId}-bookings`);
                        });
                    });
                });
                // Input tanggal di form booking detail properti
                elements.checkinDateInput.addEventListener('change', render.updateBookingSidebarSummary);
                elements.checkoutDateInput.addEventListener('change', render.updateBookingSidebarSummary);
                elements.guestsSelect.addEventListener('change', render.updateBookingSidebarSummary);

                // Form booking di detail properti
                elements.propertyBookingForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    handlers.openBookingModal();
                });

                // Modal Booking
                elements.cancelBookingBtn.addEventListener('click', () => handlers.hideModal('booking-modal'));
                elements.confirmBookingBtn.addEventListener('click', handlers.processBookingConfirmation);

                // Modal Pembayaran
                elements.payLaterBtn.addEventListener('click', () => {
                    handlers.hideModal('payment-modal');
                    view.show('bookings'); // Arahkan ke daftar pesanan
                });
                elements.confirmPaymentBtn.addEventListener('click', handlers.processPaymentConfirmation);

                // Modal Notifikasi
                elements.notificationBtn.addEventListener('click', handlers.openNotificationModal);
                elements.markAllNotificationsReadBtn.addEventListener('click', handlers.markAllNotificationsAsRead);
                // Klik pada item notifikasi
                elements.notificationListContainer.addEventListener('click', (e) => {
                    const notifItem = e.target.closest('.notification-item');
                    if (notifItem) {
                        e.preventDefault(); // Mencegah navigasi default jika <a>
                        const notifId = notifItem.dataset.notifId;
                        handlers.markNotificationAsRead(notifId); // Tandai sudah dibaca
                        handlers.hideModal('notification-modal'); // Tutup modal
                        if (notifItem.href && notifItem.getAttribute('href') !== '#') {
                            // Navigasi ke link notifikasi (misal, #booking-detail/book-1)
                            // Fungsi view.show() akan dipanggil oleh event hashchange
                            window.location.hash = notifItem.getAttribute('href');
                        }
                    }
                });
                // Menutup modal dengan tombol close
                utils.$$('.modal-close').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const modal = btn.closest('.modal');
                        if (modal) handlers.hideModal(modal.id);
                    });
                });
                // Menutup modal dengan klik di luar area konten
                utils.$$('.modal').forEach(modalEl => {
                    modalEl.addEventListener('click', (e) => {
                        if (e.target === modalEl) { // Klik pada backdrop modal
                            handlers.hideModal(modalEl.id);
                        }
                    });
                });
                // Menutup modal dengan tombol Escape
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        const openModal = utils.$('.modal.modal-open');
                        if (openModal) {
                            handlers.hideModal(openModal.id);
                        }
                    }
                });

                // Chat
                elements.chatMessageForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const text = elements.chatMessageInput.value.trim();
                    if (text && state.currentChatTargetId) {
                        handlers.sendChatMessage(state.currentChatTargetId, text);
                        elements.chatMessageInput.value = '';
                    }
                });
                // Atur tanggal minimum untuk input date
                const today = new Date().toISOString().split('T')[0];
                elements.quickCheckinInput.min = today;
                elements.checkinDateInput.min = today;

                elements.quickCheckinInput.addEventListener('change', (e) => {
                    elements.quickCheckoutInput.min = e.target.value;
                });
                elements.checkinDateInput.addEventListener('change', (e) => {
                    elements.checkoutDateInput.min = e.target.value;
                });
                // Set tahun di footer
                elements.currentYearSpan.textContent = new Date().getFullYear();

            },
            // Fungsi untuk menerapkan filter pencarian
            applySearchFilters: () => {
                state.searchFilters.location = elements.searchLocationInput.value.trim();
                state.searchFilters.price = parseInt(elements.priceRangeInput.value);
                state.searchFilters.type = Array.from(elements.typeFiltersContainer.querySelectorAll('input:checked')).map(cb => cb.value);
                state.searchFilters.amenities = Array.from(elements.amenitiesFiltersContainer.querySelectorAll('input:checked')).map(cb => cb.value);
                render.searchResults();
            },
            // Toggle properti di wishlist
            toggleWishlist: (propertyId, buttonElement = null) => {
                const index = state.user.wishlist.indexOf(propertyId);
                let added = false;
                if (index === -1) {
                    state.user.wishlist.push(propertyId); // Tambah ke wishlist
                    added = true;
                } else {
                    state.user.wishlist.splice(index, 1); // Hapus dari wishlist
                }
                // Update UI tombol jika disediakan
                if (buttonElement) {
                    buttonElement.classList.toggle('active', added);
                    buttonElement.querySelector('i').classList.toggle('fas', added);
                    buttonElement.querySelector('i').classList.toggle('far', !added);
                    if (buttonElement.matches('#detailWishlistBtn')) { // Tombol di halaman detail
                        buttonElement.querySelector('span').textContent = added ? 'Disimpan' : 'Simpan';
                    }
                    buttonElement.setAttribute('aria-pressed', added.toString());
                    buttonElement.setAttribute('aria-label', added ? 'Hapus dari favorit' : 'Tambah ke favorit');
                }
                // Re-render tampilan wishlist jika sedang aktif
                if (state.currentView === 'wishlist') {
                    render.wishlistProperties();
                }
                // Update semua kartu properti yang terlihat (jika ada)
                utils.$$(`.property-card .wishlist-btn[data-id="${propertyId}"]`).forEach(btn => {
                    btn.classList.toggle('active', added);
                    btn.querySelector('i').classList.toggle('fas', added);
                    btn.querySelector('i').classList.toggle('far', !added);
                    btn.setAttribute('aria-pressed', added.toString());
                });
            },
            // Tambah ulasan baru
            addReview: (propertyId, author, rating, text) => {
                const property = utils.getPropertyById(propertyId);
                if (property) {
                    const newReview = { author, rating, text, date: new Date().toISOString().split('T')[0] };
                    property.reviews.unshift(newReview); // Tambah di awal array
                    property.reviewsCount = property.reviews.length; // Update jumlah review
                    // Hitung ulang rating rata-rata (opsional, bisa disederhanakan)
                    const totalRating = property.reviews.reduce((sum, r) => sum + r.rating, 0);
                    property.rating = parseFloat((totalRating / property.reviewsCount).toFixed(1));

                    render.propertyDetail(); // Re-render detail properti
                }
            },
            // Buka modal
            showModal: (modalId) => {
                const modal = utils.$(`#${modalId}`);
                if (modal) {
                    modal.classList.add('modal-open');
                    // Fokus ke elemen pertama yang bisa difokus di dalam modal
                    const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                    if (focusableElements.length > 0) {
                        focusableElements[0].focus();
                    }
                }
            },
            // Tutup modal
            hideModal: (modalId) => {
                const modal = utils.$(`#${modalId}`);
                if (modal) modal.classList.remove('modal-open');
            },
            // Buka modal booking
            openBookingModal: () => {
                const property = utils.getPropertyById(state.currentPropertyId);
                const checkin = elements.checkinDateInput.value;
                const checkout = elements.checkoutDateInput.value;
                const guests = elements.guestsSelect.value;

                if (!property || !checkin || !checkout || !guests) {
                    alert('Harap lengkapi detail pemesanan (properti, tanggal, tamu).');
                    return;
                }
                if (new Date(checkout) <= new Date(checkin)) {
                    alert('Tanggal check-out harus setelah tanggal check-in.');
                    return;
                }

                const nights = utils.getDaysBetweenDates(checkin, checkout);
                if (nights < state.minBookingDurationDays) {
                    alert(`Durasi sewa minimal adalah ${state.minBookingDurationDays} malam/hari.`);
                    return;
                }

                const subtotal = property.price * (nights / 30); // Harga proporsional
                const serviceFee = subtotal * state.serviceFeePercentage;
                const total = subtotal + serviceFee;

                // Simpan detail sementara untuk modal
                state.tempBookingDetails = { property, checkin, checkout, guests, nights, subtotal, serviceFee, total };

                elements.bookingModalSummary.innerHTML = `
                    <h3 class="font-semibold text-lg mb-2">${utils.sanitizeHTML(property.title)}</h3>
                    <p class="text-sm mb-1"><span class="text-muted">Tanggal:</span> ${utils.formatDate(checkin)} - ${utils.formatDate(checkout)} (${nights} malam)</p>
                    <p class="text-sm mb-1"><span class="text-muted">Tamu:</span> ${guests} orang</p>
                    <hr class="my-3">
                    <div class="flex justify-between mb-1"><span class="text-muted">Harga Properti (${nights} malam):</span> <span>${utils.formatPrice(subtotal)}</span></div>
                    <div class="flex justify-between mb-1"><span class="text-muted">Biaya Layanan (${state.serviceFeePercentage * 100}%):</span> <span>${utils.formatPrice(serviceFee)}</span></div>
                    <div class="flex justify-between font-bold text-lg mt-2"><span class="text-muted">Total Pembayaran:</span> <span>${utils.formatPrice(total)}</span></div>
                `;
                handlers.showModal('booking-modal');
            },
            // Proses konfirmasi booking dari modal
            processBookingConfirmation: () => {
                const paymentMethod = elements.paymentMethodSelect.value;
                const termsAgreed = elements.termsAgreeCheckbox.checked;

                if (!paymentMethod) {
                    alert('Harap pilih metode pembayaran.'); return;
                }
                if (!termsAgreed) {
                    alert('Anda harus menyetujui Syarat & Ketentuan dan Kebijakan Privasi.'); return;
                }

                const { property, checkin, checkout, guests, total } = state.tempBookingDetails;
                const newBookingId = utils.generateId('book');
                const newBooking = {
                    id: newBookingId,
                    propertyId: property.id,
                    ownerId: property.ownerId,
                    propertyName: property.title,
                    propertyImage: property.image,
                    checkin, checkout, guests: parseInt(guests),
                    totalPrice: total,
                    paymentMethod,
                    paymentStatus: 'pending', // Awalnya pending
                    status: 'pending_payment', // Status booking menunggu pembayaran
                    createdAt: new Date().toISOString(),
                    timeline: [
                        { status: 'Pesanan Dibuat', date: new Date().toISOString(), note: `Menunggu pembayaran untuk ${paymentMethod.toUpperCase()}.` }
                    ]
                };
                state.user.bookings.unshift(newBooking);
                state.currentBookingId = newBookingId; // Set booking yg aktif untuk modal pembayaran

                handlers.hideModal('booking-modal');
                handlers.openPaymentModal(newBooking);
            },
            // Buka modal pembayaran
            openPaymentModal: (booking) => {
                elements.paymentBookingIdSpan.textContent = `#${booking.id.toUpperCase()}`;
                // Contoh instruksi, bisa lebih detail
                let instructions = `<p class="text-center text-lg font-semibold mb-2">Total: ${utils.formatPrice(booking.totalPrice)}</p>`;
                if (booking.paymentMethod.startsWith('bca') || booking.paymentMethod.startsWith('mandiri') || booking.paymentMethod.startsWith('bni')) {
                    instructions += `
                        <p class="mb-1">Silakan transfer ke rekening berikut:</p>
                        <ul class="list-disc list-inside bg-surface-hover p-3 rounded text-sm">
                            <li>Bank: ${booking.paymentMethod.toUpperCase()}</li>
                            <li>Nomor Rekening: <strong>${Math.floor(1000000000 + Math.random() * 9000000000)}</strong> (Contoh)</li>
                            <li>Atas Nama: <strong>PT Green Valley Indonesia</strong></li>
                            <li>Jumlah: <strong>${utils.formatPrice(booking.totalPrice)}</strong> (Mohon transfer sesuai nominal)</li>
                        </ul>
                        <p class="text-xs text-muted mt-2">Pesanan akan dikonfirmasi setelah pembayaran diterima.</p>
                    `;
                } else if (booking.paymentMethod === 'gopay' || booking.paymentMethod === 'ovo' || booking.paymentMethod === 'dana') {
                    instructions += `
                        <p class="mb-1">Silakan bayar menggunakan ${booking.paymentMethod.toUpperCase()}:</p>
                        <div class="text-center my-3">
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=Green Valley-${booking.id}-${booking.totalPrice}" alt="QR Code Pembayaran" class="mx-auto border p-1 rounded">
                        </div>
                        <p class="text-xs text-muted mt-2">Scan QR code di atas dengan aplikasi ${booking.paymentMethod.toUpperCase()} Anda.</p>
                    `;
                } else { // Kartu Kredit
                    instructions += `<p>Anda akan diarahkan ke halaman pembayaran kartu kredit (simulasi).</p>`;
                }
                elements.paymentInstructionsContainer.innerHTML = instructions;
                handlers.showModal('payment-modal');
            },
            // Proses konfirmasi pembayaran
            processPaymentConfirmation: () => {
                const booking = utils.getBookingById(state.currentBookingId);
                if (booking) {
                    booking.paymentStatus = 'paid';
                    booking.status = 'confirmed'; // Ubah status booking jadi confirmed
                    booking.timeline.push({ status: 'Pembayaran Diterima', date: new Date().toISOString(), note: `Pembayaran melalui ${booking.paymentMethod.toUpperCase()} berhasil.` });
                    booking.timeline.push({ status: 'Pesanan Dikonfirmasi', date: new Date().toISOString(), note: 'Pemilik telah dikonfirmasi.' });

                    // Tambah notifikasi
                    state.user.notifications.unshift({
                        id: utils.generateId('notif'), type: 'payment', from: 'Sistem Green Valley',
                        message: `Pembayaran untuk pesanan ${booking.id} (${utils.sanitizeHTML(booking.propertyName)}) telah berhasil.`,
                        time: new Date().toISOString(), read: false, link: `#booking-detail/${booking.id}`
                    });
                    render.notifications(); // Update badge notif

                    alert('Pembayaran berhasil! Pesanan Anda telah dikonfirmasi.');
                }
                handlers.hideModal('payment-modal');
                view.show('booking-detail', state.currentBookingId); // Tampilkan detail booking
            },
            // Kirim pesan chat (simulasi)
            sendChatMessage: (targetOwnerId, text) => {
                if (!state.chatMessages[targetOwnerId]) {
                    state.chatMessages[targetOwnerId] = [];
                }
                const newMessage = {
                    id: utils.generateId('msg'),
                    from: 'user', text,
                    time: new Date().toISOString()
                };
                state.chatMessages[targetOwnerId].push(newMessage);
                render.chatMessages(); // Re-render chat

                // Simulasi balasan dari pemilik setelah beberapa detik
                setTimeout(() => {
                    const replyText = `Terima kasih atas pesan Anda mengenai "${text.substring(0, 20)}...". Saya akan segera merespons.`;
                    const ownerReply = {
                        id: utils.generateId('msg'),
                        from: 'owner', text: replyText,
                        time: new Date().toISOString()
                    };
                    state.chatMessages[targetOwnerId].push(ownerReply);
                    render.chatMessages();
                }, 2000);
            },
            // Buka modal notifikasi
            openNotificationModal: () => {
                render.notifications();
                handlers.showModal('notification-modal');
            },
            // Tandai semua notifikasi sudah dibaca
            markAllNotificationsAsRead: () => {
                state.user.notifications.forEach(n => n.read = true);
                render.notifications(); // Re-render list dan badge
            },
            // Tandai satu notifikasi sudah dibaca
            markNotificationAsRead: (notifId) => {
                const notification = state.user.notifications.find(n => n.id === notifId);
                if (notification) {
                    notification.read = true;
                    render.notifications(); // Re-render list dan badge
                }
            },
            // Batalkan pesanan
            cancelBooking: (bookingId) => {
                const booking = utils.getBookingById(bookingId);
                if (booking && booking.status === 'confirmed') { // Hanya pesanan terkonfirmasi yang bisa dibatalkan (contoh rule)
                    booking.status = 'cancelled';
                    booking.timeline.push({ status: 'Pesanan Dibatalkan', date: new Date().toISOString(), note: 'Pesanan dibatalkan oleh pengguna.' });

                    // Tambah notifikasi pembatalan
                    state.user.notifications.unshift({
                        id: utils.generateId('notif'), type: 'booking', from: 'Sistem Green Valley',
                        message: `Pesanan ${booking.id} (${utils.sanitizeHTML(booking.propertyName)}) telah dibatalkan.`,
                        time: new Date().toISOString(), read: false, link: `#booking-detail/${booking.id}`
                    });
                    render.notifications();

                    if (state.currentView === 'bookings') {
                        render.bookings(); // Re-render daftar pesanan
                    } else if (state.currentView === 'booking-detail' && state.currentBookingId === bookingId) {
                        render.bookingDetail(); // Re-render detail pesanan jika sedang dilihat
                    }
                    alert('Pesanan berhasil dibatalkan.');
                } else {
                    alert('Pesanan ini tidak dapat dibatalkan atau sudah dalam status lain.');
                }
            },

        };

        // Inisialisasi Aplikasi
        const initApp = () => {
            view.init(); // Inisialisasi routing dan tampilan awal
            handlers.init(); // Daftarkan semua event listener
            render.notifications(); // Render notifikasi awal (terutama badge count)
        };

        // Jalankan aplikasi setelah DOM siap
        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>

</html>