<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ApartemenKu | Manajemen Apartemen Modern</title>
    <meta name="description"
        content="Aplikasi manajemen apartemen modern, intuitif, dan responsif. Kelola booking, pembayaran, dan maintenance dengan mudah.">
    <meta name="keywords" content="apartemen, manajemen apartemen, booking apartemen, sewa apartemen, properti">
    <link rel="icon" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/favicon.ico" type="image/x-icon">
    <!-- Font Awesome untuk ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
        integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Google Fonts (Inter dan Poppins) -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@600;700;800&display=swap"
        rel="stylesheet">
    <style>
        /* :: KODE CSS (Sudah Teroptimasi dan Diperbaiki) :: */

        /* Variabel Global untuk Tema dan Tata Letak */
        :root {
            --primary-color: #3B82F6;
            --primary-color-rgb: 59, 130, 246;
            /* Untuk box-shadow */
            --secondary-color: #1D4ED8;
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --danger-color: #EF4444;
            --danger-color-rgb: 239, 68, 68;
            /* Untuk box-shadow */
            --info-color: #3B82F6;

            /* Tema Terang */
            --text-color-light: #1F2937;
            --text-color-muted-light: #6B7280;
            --bg-color-light: #F9FAFB;
            --card-bg-light: #FFFFFF;
            --border-color-light: #E5E7EB;

            /* Tema Gelap - Default nilai sama dengan terang, akan di-override di [data-theme="dark"] */
            --text-color-dark: #E5E7EB;
            --text-color-muted-dark: #9CA3AF;
            --bg-color-dark: #111827;
            --card-bg-dark: #1F2937;
            --border-color-dark: #374151;

            /* Variabel Shadow */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

            /* Variabel Transisi */
            --transition-fast: all 0.2s ease-in-out;
            --transition-normal: all 0.3s ease-in-out;

            /* Variabel Tata Letak */
            --sidebar-width: 280px;
            --header-height: 70px;

            /* Variabel Radius */
            --radius-sm: 0.25rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-full: 9999px;

            /* Variabel Spasi */
            --spacing-1: 0.25rem;
            /* 4px */
            --spacing-2: 0.5rem;
            /* 8px */
            --spacing-3: 1rem;
            /* 16px */
            --spacing-4: 1.5rem;
            /* 24px */
            --spacing-5: 2rem;
            /* 32px */
            --spacing-6: 2.5rem;
            /* 40px */

            /* Inisialisasi variabel tema default (terang) */
            --text-color: var(--text-color-light);
            --text-color-muted: var(--text-color-muted-light);
            --bg-color: var(--bg-color-light);
            --card-bg: var(--card-bg-light);
            --border-color: var(--border-color-light);
        }

        /* Aturan Tema Gelap */
        [data-theme="dark"] {
            --text-color: var(--text-color-dark);
            --text-color-muted: var(--text-color-muted-dark);
            --bg-color: var(--bg-color-dark);
            --card-bg: var(--card-bg-dark);
            --border-color: var(--border-color-dark);
            --primary-color-rgb: 96, 165, 250;
            /* Biru lebih terang untuk dark mode shadow */
            --danger-color-rgb: 248, 113, 113;
            /* Merah lebih terang untuk dark mode shadow */
        }

        /* Reset CSS Dasar dan Tipografi Global */
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            font-size: 16px;
            /* Ukuran font dasar agar rem konsisten */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            /* Untuk struktur .app-container */
            flex-direction: column;
            /* Untuk struktur .app-container */
            transition: background-color var(--transition-normal), color var(--transition-normal);
            line-height: 1.6;
            overflow-x: hidden;
            /* Mencegah scroll horizontal yang tidak diinginkan */
        }

        /* :: STRUKTUR UTAMA APLIKASI (Monolith SPA) :: */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar (Navigasi Utama) */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--card-bg);
            padding: var(--spacing-4) 0;
            /* Padding atas bawah, samping diurus item */
            border-right: 1px solid var(--border-color);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1030;
            transition: transform var(--transition-normal), background-color var(--transition-normal), border-color var(--transition-normal);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-md);
        }

        .sidebar.collapsed {
            /* Untuk desktop jika ingin fitur collapse (tidak di-scope di request awal, tapi ide) */
            /* transform: translateX(-100%); JANGAN PAKAI INI JIKA MAU COLLAPSED KECIL */
            /* width: 80px; */
            /* Jika ingin collapse jadi ikon saja */
        }

        .sidebar.show {
            /* Untuk mobile */
            transform: translateX(0);
        }


        .sidebar-brand {
            font-family: 'Poppins', sans-serif;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: var(--spacing-5);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            padding: 0 var(--spacing-4);
            /* Padding brand */
        }

        .sidebar-brand i {
            font-size: 2rem;
        }

        .nav-menu {
            list-style: none;
            flex-grow: 1;
            overflow-y: auto;
            padding: 0 var(--spacing-3);
            /* Padding untuk semua item menu */
        }

        .nav-menu::-webkit-scrollbar {
            width: 6px;
        }

        .nav-menu::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: var(--radius-full);
        }

        .nav-menu::-webkit-scrollbar-thumb:hover {
            background: var(--text-color-muted);
        }

        .nav-item {
            margin-bottom: var(--spacing-1);
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: var(--spacing-2) var(--spacing-3);
            color: var(--text-color-muted);
            border-radius: var(--radius-md);
            transition: var(--transition-fast);
            font-weight: 500;
            text-decoration: none;
            font-size: 0.95rem;
        }

        .nav-link i {
            margin-right: var(--spacing-3);
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
            color: var(--text-color-muted);
            transition: var(--transition-fast);
        }

        .nav-link:hover,
        .nav-link.active {
            background-color: var(--primary-color);
            color: #fff;
        }

        .nav-link:hover i,
        .nav-link.active i {
            color: #fff;
        }

        .nav-link.active {
            font-weight: 600;
        }

        .sidebar-footer {
            margin-top: auto;
            padding-top: var(--spacing-3);
            padding-left: var(--spacing-3);
            /* Sesuaikan dengan .nav-menu */
            padding-right: var(--spacing-3);
            /* Sesuaikan dengan .nav-menu */
            border-top: 1px solid var(--border-color);
        }


        /* Wrapper Konten Utama */
        .main-wrapper {
            margin-left: var(--sidebar-width);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            transition: margin-left var(--transition-normal);
            min-width: 0;
            /* Mencegah overflow pada flex child */
        }

        /* Header Aplikasi */
        .app-header {
            height: var(--header-height);
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 0 var(--spacing-4);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1020;
            box-shadow: var(--shadow-sm);
            transition: background-color var(--transition-normal), border-color var(--transition-normal);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
        }

        .search-bar {
            display: flex;
            align-items: center;
            background-color: var(--bg-color);
            padding: var(--spacing-2) var(--spacing-3);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            min-width: 250px;
            transition: var(--transition-normal);
        }

        .search-bar i {
            color: var(--text-color-muted);
            margin-right: var(--spacing-2);
        }

        .search-bar input {
            border: none;
            background-color: transparent;
            outline: none;
            color: var(--text-color);
            font-size: 0.9rem;
            width: 100%;
        }

        .search-bar input::placeholder {
            color: var(--text-color-muted);
        }

        .profile-dropdown {
            position: relative;
        }

        .profile-dropdown-toggle {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            cursor: pointer;
            padding: var(--spacing-2);
            border-radius: var(--radius-md);
            transition: var(--transition-fast);
            font-weight: 500;
        }

        .profile-dropdown-toggle:hover {
            background-color: var(--bg-color);
        }

        .profile-dropdown-toggle img {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            object-fit: cover;
        }

        .profile-dropdown-toggle i.fa-user-circle {
            font-size: 1.8rem;
            color: var(--text-color-muted);
        }

        .profile-dropdown-toggle .fa-chevron-down {
            font-size: 0.8em;
            margin-left: var(--spacing-1);
        }


        .profile-dropdown-menu {
            position: absolute;
            top: calc(100% + var(--spacing-1));
            right: 0;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 220px;
            z-index: 1040;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: opacity var(--transition-fast), visibility var(--transition-fast) 0s linear var(--transition-fast), transform var(--transition-fast);
        }

        .profile-dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            transition: opacity var(--transition-fast), visibility var(--transition-fast) 0s linear 0s, transform var(--transition-fast);
        }

        .profile-dropdown-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            padding: var(--spacing-2) var(--spacing-3);
            color: var(--text-color);
            text-decoration: none;
            font-size: 0.9rem;
            transition: var(--transition-fast);
        }

        .profile-dropdown-item i {
            width: 16px;
            text-align: center;
            color: var(--text-color-muted);
        }

        .profile-dropdown-item:hover {
            background-color: var(--bg-color);
            color: var(--primary-color);
        }

        .profile-dropdown-item:hover i {
            color: var(--primary-color);
        }

        .profile-dropdown-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: var(--spacing-1) 0;
        }

        .theme-toggle,
        .sidebar-toggle-btn {
            cursor: pointer;
            padding: var(--spacing-2);
            background-color: transparent;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-color-muted);
            font-size: 1.1rem;
            transition: var(--transition-fast);
            line-height: 1;
            width: 40px;
            height: 40px;
            /* Ukuran konsisten */
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover,
        .sidebar-toggle-btn:hover {
            background-color: var(--bg-color);
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .sidebar-toggle-btn.d-lg-none {
            display: none;
        }

        /* Sembunyikan di desktop default */


        /* Konten Utama (Halaman) */
        .main-content {
            padding: var(--spacing-4);
            flex-grow: 1;
        }

        .page-section {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page-header {
            margin-bottom: var(--spacing-4);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-3);
        }

        .page-header h2 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-color);
        }

        /* Grid Statistik (Dashboard) */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-4);
        }

        .stats-grid .card .fa-2x {
            /* Icon di kartu statistik */
            margin-bottom: var(--spacing-2);
            display: block;
        }

        .stats-grid .card .card-title {
            font-size: 1rem;
            color: var(--text-color-muted);
            font-weight: 500;
        }

        .stats-grid .card p[data-stat] {
            font-size: 2rem;
            font-weight: 700;
            margin-top: var(--spacing-1);
        }


        /* Kartu (Komponen Umum) */
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--spacing-4);
            transition: var(--transition-normal);
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-3);
            padding-bottom: var(--spacing-3);
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
        }

        .card-footer {
            margin-top: var(--spacing-3);
            padding-top: var(--spacing-3);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-2);
        }

        /* Kartu Apartemen */
        .apartments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-4);
        }

        .apartment-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-3);
        }

        .apartment-card .card-title {
            font-size: 1.1rem;
            margin-bottom: var(--spacing-1);
        }

        .apartment-card p {
            font-size: 0.9rem;
            color: var(--text-color-muted);
            margin-bottom: var(--spacing-1);
        }

        .apartment-card .price {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: var(--spacing-3);
        }

        .apartment-actions {
            display: flex;
            gap: var(--spacing-2);
            margin-top: var(--spacing-3);
        }

        /* Filter Section */
        .filter-section {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-4);
            padding: var(--spacing-3);
            background-color: var(--card-bg);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .filter-section select,
        .filter-section input[type="text"],
        .filter-section button {
            padding: var(--spacing-2) var(--spacing-3);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 0.9rem;
            height: 40px;
        }

        .filter-section select {
            min-width: 150px;
            flex-grow: 1;
        }

        /* Agar select bisa memanjang */
        .filter-section input[type="text"] {
            flex-grow: 2;
        }

        /* Agar input teks lebih panjang */
        .filter-section button {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
            cursor: pointer;
        }

        .filter-section button:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        /* Tabel */
        .table-container {
            overflow-x: auto;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: var(--spacing-3);
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        th {
            background-color: var(--bg-color);
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            color: var(--text-color);
            white-space: nowrap;
            /* Mencegah header tabel wrap */
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background-color: var(--bg-color);
        }

        td .actions {
            display: flex;
            gap: var(--spacing-2);
        }

        td .actions .btn {
            padding: var(--spacing-1) var(--spacing-2);
        }

        /* Tombol aksi lebih kecil */

        /* Badge (Label Status) */
        .badge {
            padding: 0.3rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            color: #fff;
            text-transform: capitalize;
            line-height: 1;
            /* Perbaikan line-height */
        }

        .badge.active,
        .badge.terkonfirmasi,
        .badge.selesai {
            background-color: var(--success-color);
        }

        .badge.pending,
        .badge.menunggu {
            background-color: var(--warning-color);
            color: var(--text-color-light);
        }

        .badge.due,
        .badge.dibatalkan {
            background-color: var(--danger-color);
        }

        .badge.info {
            background-color: var(--info-color);
        }

        /* Modal (Dialog Pop-up) */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1050;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-fast), visibility var(--transition-fast) 0s linear var(--transition-fast);
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
            transition-delay: 0s;
            /* Pastikan visibility langsung saat show */
        }

        .modal-dialog {
            max-width: 600px;
            width: 90%;
            transform: translateY(-20px) scale(0.95);
            transition: transform var(--transition-normal);
        }

        .modal.show .modal-dialog {
            transform: translateY(0) scale(1);
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-3) var(--spacing-4);
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
        }

        .btn-close {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            color: var(--text-color-muted);
            cursor: pointer;
            padding: var(--spacing-1);
            line-height: 1;
            /* Perbaikan line-height */
        }

        .btn-close:hover {
            color: var(--danger-color);
        }

        .modal-body {
            padding: var(--spacing-4);
            overflow-y: auto;
            flex-grow: 1;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-2);
            padding: var(--spacing-3) var(--spacing-4);
            border-top: 1px solid var(--border-color);
        }

        /* Form (Input, Label, dll.) */
        .form-group {
            margin-bottom: var(--spacing-3);
        }

        /* Kurangi sedikit margin */
        .form-label {
            font-weight: 500;
            margin-bottom: var(--spacing-1);
            /* Kurangi sedikit margin */
            display: block;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: var(--spacing-2) var(--spacing-3);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 0.9rem;
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
            height: 44px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(var(--primary-color-rgb), 0.25);
        }

        .form-control.is-invalid {
            border-color: var(--danger-color);
        }

        .form-control.is-invalid:focus {
            box-shadow: 0 0 0 0.2rem rgba(var(--danger-color-rgb), 0.25);
        }

        .invalid-feedback {
            color: var(--danger-color);
            font-size: 0.8rem;
            margin-top: var(--spacing-1);
            display: none;
        }

        .form-control.is-invalid~.invalid-feedback,
        /* Selector untuk feedback setelah input */
        select.is-invalid~.invalid-feedback {
            display: block;
        }


        /* Tombol (Button) */
        .btn {
            padding: var(--spacing-2) var(--spacing-4);
            border-radius: var(--radius-md);
            border: 1px solid transparent;
            cursor: pointer;
            transition: var(--transition-fast);
            font-weight: 500;
            font-size: 0.9rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-2);
            line-height: 1.5;
        }

        .btn i {
            font-size: 1rem;
        }

        .btn-sm {
            padding: var(--spacing-1) var(--spacing-2);
            font-size: 0.8rem;
        }

        .btn-lg {
            padding: var(--spacing-3) var(--spacing-5);
            font-size: 1rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .btn-secondary {
            background-color: var(--text-color-muted);
            color: #fff;
            border-color: var(--text-color-muted);
        }

        .btn-secondary:hover {
            background-color: var(--text-color);
            border-color: var(--text-color);
        }

        [data-theme="dark"] .btn-secondary {
            background-color: var(--border-color-dark);
            color: var(--text-color-dark);
            border-color: var(--border-color-dark);
        }

        [data-theme="dark"] .btn-secondary:hover {
            background-color: #4B5563;
            border-color: #4B5563;
        }

        .btn-success {
            background-color: var(--success-color);
            color: #fff;
            border-color: var(--success-color);
        }

        .btn-success:hover {
            background-color: #059669;
            border-color: #059669;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: #fff;
            border-color: var(--danger-color);
        }

        .btn-danger:hover {
            background-color: #DC2626;
            border-color: #DC2626;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: var(--text-color-light);
            border-color: var(--warning-color);
        }

        .btn-warning:hover {
            background-color: #D97706;
            border-color: #D97706;
        }

        .btn-info {
            background-color: var(--info-color);
            color: #fff;
            border-color: var(--info-color);
        }

        .btn-info:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .btn-outline-primary {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background-color: transparent;
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: #fff;
        }


        /* Notifikasi Toast */
        .notification-toast {
            position: fixed;
            bottom: var(--spacing-4);
            right: var(--spacing-4);
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-left-width: 5px;
            padding: var(--spacing-3);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 1070;
            min-width: 300px;
            max-width: 400px;
            opacity: 0;
            transform: translateX(100%);
            transition: opacity var(--transition-normal), transform var(--transition-normal);
        }

        .notification-toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification-toast.info {
            border-left-color: var(--info-color);
        }

        .notification-toast.success {
            border-left-color: var(--success-color);
        }

        .notification-toast.warning {
            border-left-color: var(--warning-color);
        }

        .notification-toast.danger {
            border-left-color: var(--danger-color);
        }

        .notification-toast-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-1);
        }

        .notification-toast-title {
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
        }

        .notification-toast-body {
            font-size: 0.9rem;
            color: var(--text-color-muted);
        }

        .notification-toast .btn-close {
            font-size: 1.2rem;
        }

        /* Footer Aplikasi */
        .app-footer {
            padding: var(--spacing-3) var(--spacing-4);
            background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
            color: var(--text-color-muted);
            font-size: 0.85rem;
            text-align: center;
            margin-top: auto;
            /* Dorong footer ke bawah */
            transition: background-color var(--transition-normal), border-color var(--transition-normal);
        }

        /* Utilities (Kelas Pembantu) */
        .d-none {
            display: none !important;
        }

        .d-block {
            display: block !important;
        }

        .d-flex {
            display: flex !important;
        }

        .d-lg-none {
            display: none !important;
        }

        /* Sembunyikan di large screen (992px+) */

        .align-items-center {
            align-items: center !important;
        }

        .justify-content-between {
            justify-content: space-between !important;
        }

        .text-center {
            text-align: center !important;
        }

        .w-100 {
            width: 100% !important;
        }

        /* Spacing Utilities (Contoh, bisa diperluas) */
        .mt-1 {
            margin-top: var(--spacing-1) !important;
        }

        .mt-2 {
            margin-top: var(--spacing-2) !important;
        }

        .mt-3 {
            margin-top: var(--spacing-3) !important;
        }

        .mt-4 {
            margin-top: var(--spacing-4) !important;
        }

        .mb-1 {
            margin-bottom: var(--spacing-1) !important;
        }

        .mb-2 {
            margin-bottom: var(--spacing-2) !important;
        }

        .mb-3 {
            margin-bottom: var(--spacing-3) !important;
        }

        .mb-4 {
            margin-bottom: var(--spacing-4) !important;
        }

        /* Placeholder & Empty State */
        .chart-placeholder {
            height: 250px;
            background-color: var(--bg-color);
            border: 1px dashed var(--border-color);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color-muted);
            font-style: italic;
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-5) var(--spacing-3);
            color: var(--text-color-muted);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: var(--spacing-3);
            color: var(--border-color);
        }

        .empty-state p {
            font-size: 1.1rem;
        }

        .empty-state a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .empty-state a:hover {
            text-decoration: underline;
        }


        /* Penyesuaian untuk Perangkat Seluler dan Tablet (Responsif) */
        @media (min-width: 992px) {
            .sidebar-toggle-btn.d-lg-none {
                /* Sebenarnya ini defaultnya, tapi untuk eksplisit */
                display: none !important;
            }
        }

        @media (max-width: 991.98px) {

            /* Tablet dan di bawahnya */
            .sidebar {
                transform: translateX(-100%);
                box-shadow: var(--shadow-lg);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-wrapper {
                margin-left: 0;
            }

            .app-header .search-bar {
                display: none;
            }

            /* Sembunyikan search bar di header mobile */
            .profile-dropdown-toggle span {
                display: none;
            }

            /* Sembunyikan nama pengguna di mobile */
            .sidebar-toggle-btn.d-lg-none {
                display: inline-flex !important;
            }

            /* Tampilkan di mobile */
        }

        @media (max-width: 767.98px) {

            /* Perangkat seluler */
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .apartments-grid {
                grid-template-columns: 1fr;
            }

            .filter-section {
                flex-direction: column;
                gap: var(--spacing-2);
            }

            .filter-section select,
            .filter-section input[type="text"],
            .filter-section button {
                width: 100%;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .page-header h2 {
                font-size: 1.5rem;
            }

            .modal-dialog {
                width: 95%;
            }

            .main-content {
                padding: var(--spacing-3);
            }

            /* Padding lebih kecil di mobile */
            .app-header {
                padding: 0 var(--spacing-3);
            }
        }
    </style>
</head>

<body data-theme="light"> <!-- State tema default -->
    <!-- Layer Aplikasi Utama -->
    <div class="app-container">
        <!-- Layer Sidebar (Navigasi) -->
        <aside class="sidebar" id="appSidebar" aria-label="Navigasi Utama Aplikasi">
            <div class="sidebar-brand">
                <i class="fas fa-city"></i>
                <span>ApartemenKu</span>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="#dashboard" class="nav-link active" data-page="dashboard"><i
                            class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li class="nav-item"><a href="#apartments" class="nav-link" data-page="apartments"><i
                            class="fas fa-building"></i> Apartemen</a></li>
                <li class="nav-item"><a href="#bookings" class="nav-link" data-page="bookings"><i
                            class="fas fa-calendar-check"></i> Booking</a></li>
                <li class="nav-item"><a href="#payments" class="nav-link" data-page="payments"><i
                            class="fas fa-credit-card"></i> Pembayaran</a></li>
                <li class="nav-item"><a href="#maintenance" class="nav-link" data-page="maintenance"><i
                            class="fas fa-tools"></i> Maintenance</a></li>
                <li class="nav-item"><a href="#tenants" class="nav-link" data-page="tenants"><i
                            class="fas fa-users"></i> Penyewa</a></li>
                <li class="nav-item"><a href="#messages" class="nav-link" data-page="messages"><i
                            class="fas fa-envelope"></i> Pesan <span class="badge info"
                            style="margin-left: auto;">3</span></a></li>
                <li class="nav-item"><a href="#reports" class="nav-link" data-page="reports"><i
                            class="fas fa-chart-line"></i> Laporan</a></li>
            </ul>
            <div class="sidebar-footer">
                <a href="#settings" class="nav-link" data-page="settings"><i class="fas fa-cog"></i> Pengaturan</a>
            </div>
        </aside>

        <!-- Layer Konten Utama (Wrapper) -->
        <div class="main-wrapper" id="mainWrapper">
            <!-- Layer Header Aplikasi -->
            <header class="app-header">
                <div class="header-actions">
                    <!-- Tombol ini hanya muncul di layar kecil (mobile/tablet) -->
                    <button class="sidebar-toggle-btn d-lg-none" id="sidebarToggle" aria-label="Buka/Tutup Navigasi"
                        aria-expanded="false">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Cari cepat..." aria-label="Pencarian Cepat">
                    </div>
                </div>
                <div class="header-actions">
                    <button class="theme-toggle" id="themeToggleBtn" aria-label="Ganti Tema Gelap/Terang">
                        <i class="fas fa-moon"></i> <!-- Icon akan diubah oleh JS -->
                    </button>
                    <div class="profile-dropdown">
                        <div class="profile-dropdown-toggle" id="profileDropdownToggle" tabindex="0" role="button"
                            aria-haspopup="true" aria-expanded="false">
                            <img src="https://i.pravatar.cc/40?u=admin" alt="Avatar Pengguna">
                            <span>Admin Apartemen</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="profile-dropdown-menu" id="profileDropdownMenu"
                            aria-labelledby="profileDropdownToggle">
                            <a href="#profile" class="profile-dropdown-item" data-page="profile"><i
                                    class="fas fa-user-circle"></i> Profil Saya</a>
                            <a href="#settings-account" class="profile-dropdown-item" data-page="settings-account"><i
                                    class="fas fa-user-cog"></i> Pengaturan Akun</a>
                            <div class="profile-dropdown-divider"></div>
                            <a href="#" class="profile-dropdown-item" id="logoutButton"><i
                                    class="fas fa-sign-out-alt"></i> Logout</a>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Layer Konten Halaman Dinamis -->
            <main class="main-content" id="pageContentContainer">
                <!-- Konten akan dimuat di sini oleh JavaScript -->
            </main>

            <!-- Layer Footer Aplikasi -->
            <footer class="app-footer">
                <small>&copy; <span id="currentYear"></span> ApartemenKu. Seluruh Hak Cipta Dilindungi
                    Undang-Undang.</small>
            </footer>
        </div>
    </div>

    <!-- Layer Modal (untuk form, detail, dll.) -->
    <div class="modal" id="appModal" tabindex="-1" role="dialog" aria-labelledby="appModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="appModalLabel">Judul Modal</h5>
                    <button type="button" class="btn-close" data-dismiss="modal" aria-label="Tutup">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="appModalBody">
                    <!-- Konten modal akan dimuat di sini oleh JavaScript -->
                </div>
                <div class="modal-footer" id="appModalFooter">
                    <!-- Tombol footer modal default atau kustom akan dimuat di sini -->
                </div>
            </div>
        </div>
    </div>

    <!-- Layer Notifikasi Toast -->
    <div class="notification-toast" id="notificationToast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="notification-toast-header">
            <strong class="notification-toast-title" id="notificationToastTitle">Notifikasi</strong>
            <button type="button" class="btn-close" data-dismiss="toast" aria-label="Tutup">
                <span>&times;</span>
            </button>
        </div>
        <div class="notification-toast-body" id="notificationToastBody">
            Isi pesan notifikasi.
        </div>
    </div>

    <!-- TEMPLATE UNTUK HALAMAN-HALAMAN (Digunakan oleh JavaScript) -->
    <template id="page-template-dashboard">
        <section id="dashboard-content" class="page-section">
            <div class="page-header">
                <h2>Dashboard Ikhtisar</h2>
                <!-- Bisa tambahkan tombol aksi di sini jika perlu -->
            </div>
            <div class="stats-grid">
                <div class="card">
                    <div class="card-body">
                        <i class="fas fa-door-open fa-2x" style="color: var(--primary-color);"></i>
                        <h3 class="card-title">Unit Tersedia</h3>
                        <p data-stat="availableUnits">0</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <i class="fas fa-users fa-2x" style="color: var(--success-color);"></i>
                        <h3 class="card-title">Total Penyewa Aktif</h3>
                        <p data-stat="activeTenants">0</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <i class="fas fa-file-invoice-dollar fa-2x" style="color: var(--warning-color);"></i>
                        <h3 class="card-title">Pembayaran Tertunda</h3>
                        <p data-stat="pendingPayments">0</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <i class="fas fa-tools fa-2x" style="color: var(--danger-color);"></i>
                        <h3 class="card-title">Permintaan Maintenance</h3>
                        <p data-stat="maintenanceRequests">0</p>
                    </div>
                </div>
            </div>
            <div class="card mt-4">
                <div class="card-header">
                    <h3 class="card-title">Aktivitas Terbaru</h3>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Aktivitas</th>
                                    <th>Detail</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="activityTableBody">
                                <!-- Data aktivitas akan dimuat di sini oleh JS -->
                                <tr>
                                    <td colspan="4" class="text-center" style="padding: var(--spacing-4);">Tidak ada
                                        aktivitas terbaru.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="card mt-4">
                <div class="card-header">
                    <h3 class="card-title">Grafik Tingkat Hunian Bulanan</h3>
                </div>
                <div class="card-body">
                    <div class="chart-placeholder">Placeholder untuk grafik tingkat hunian. Implementasi grafik
                        memerlukan library eksternal atau canvas drawing manual yang kompleks (di luar scope vanilla).
                    </div>
                </div>
            </div>
        </section>
    </template>

    <template id="page-template-apartments">
        <section id="apartments-content" class="page-section">
            <div class="page-header">
                <h2>Manajemen Apartemen</h2>
                <button class="btn btn-primary" id="addApartmentBtn"><i class="fas fa-plus"></i> Tambah Unit</button>
            </div>
            <div class="filter-section">
                <input type="text" id="searchApartmentName" placeholder="Cari No. Unit / Nama Penghuni"
                    aria-label="Cari Apartemen">
                <select id="filterApartmentType" aria-label="Filter Tipe Unit">
                    <option value="">Semua Tipe</option>
                    <option value="studio">Studio</option>
                    <option value="1br">1 Kamar Tidur</option>
                    <option value="2br">2 Kamar Tidur</option>
                    <option value="3br">3+ Kamar Tidur</option>
                </select>
                <select id="filterApartmentStatus" aria-label="Filter Status Unit">
                    <option value="">Semua Status</option>
                    <option value="tersedia">Tersedia</option>
                    <option value="terisi">Terisi</option>
                    <option value="maintenance">Maintenance</option>
                </select>
                <button class="btn btn-secondary" id="applyApartmentFilterBtn"><i class="fas fa-filter"></i>
                    Terapkan</button>
            </div>
            <div class="apartments-grid" id="apartmentsGridContainer">
                <!-- Kartu apartemen akan dimuat di sini oleh JS -->
            </div>
            <div class="empty-state d-none" id="apartmentsEmptyState">
                <i class="fas fa-building"></i>
                <p>Belum ada data apartemen.</p>
                <p><a href="#" id="addApartmentLinkFromEmpty" class="btn btn-sm btn-outline-primary">Tambah unit
                        apartemen baru?</a></p>
            </div>
        </section>
    </template>

    <template id="page-template-bookings">
        <section id="bookings-content" class="page-section">
            <div class="page-header">
                <h2>Manajemen Booking</h2>
                <button class="btn btn-primary" id="addBookingBtn"><i class="fas fa-calendar-plus"></i> Tambah
                    Booking</button>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Daftar Booking</h3>
                    <!-- Bisa tambahkan filter di sini -->
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table id="bookingsTable">
                            <thead>
                                <tr>
                                    <th>ID Booking</th>
                                    <th>Nama Penyewa</th>
                                    <th>Unit Apartemen</th>
                                    <th>Check-in</th>
                                    <th>Check-out</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="bookingTableBody">
                                <!-- Data booking akan dimuat di sini oleh JS -->
                            </tbody>
                        </table>
                    </div>
                    <div class="empty-state d-none" id="bookingsEmptyState">
                        <i class="fas fa-calendar-times"></i>
                        <p>Belum ada data booking.</p>
                        <p><a href="#" id="addBookingLinkFromEmpty" class="btn btn-sm btn-outline-primary">Buat booking
                                baru?</a></p>
                    </div>
                </div>
            </div>
        </section>
    </template>

    <!-- Placeholder untuk template halaman lainnya (Payments, Maintenance, dll.) -->
    <template id="page-template-payments">
        <section id="payments-content" class="page-section">
            <div class="page-header">
                <h2 id="defaultPageTitle">Manajemen Pembayaran</h2>
                <button class="btn btn-primary" id="addPaymentBtn"><i class="fas fa-plus"></i> Catat Pembayaran</button>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="empty-state">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <p>Fitur manajemen pembayaran sedang dalam tahap pengembangan.</p>
                        <p>Data pembayaran akan ditampilkan di sini dalam bentuk tabel dengan filter dan aksi.</p>
                    </div>
                </div>
            </div>
        </section>
    </template>
    <template id="page-template-maintenance">
        <section id="maintenance-content" class="page-section">
            <div class="page-header">
                <h2 id="defaultPageTitle">Manajemen Maintenance</h2>
                <button class="btn btn-primary" id="addMaintenanceRequestBtn"><i class="fas fa-plus"></i> Buat
                    Permintaan</button>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="empty-state">
                        <i class="fas fa-tools"></i>
                        <p>Fitur manajemen maintenance sedang dalam tahap pengembangan.</p>
                        <p>Daftar permintaan maintenance, status, dan penugasan teknisi akan ada di sini.</p>
                    </div>
                </div>
            </div>
        </section>
    </template>
    <template id="page-template-tenants">
        <section id="tenants-content" class="page-section">
            <div class="page-header">
                <h2 id="defaultPageTitle">Manajemen Penyewa</h2>
                <button class="btn btn-primary" id="addTenantBtn"><i class="fas fa-user-plus"></i> Tambah
                    Penyewa</button>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>Fitur manajemen data penyewa (tenant) sedang dalam tahap pengembangan.</p>
                        <p>Informasi detail penyewa, riwayat sewa, dan kontak akan dikelola di sini.</p>
                    </div>
                </div>
            </div>
        </section>
    </template>
    <template id="page-template-messages">
        <section id="messages-content" class="page-section">
            <div class="page-header">
                <h2 id="defaultPageTitle">Pusat Pesan</h2>
                <button class="btn btn-primary" id="composeMessageBtn"><i class="fas fa-paper-plane"></i> Tulis Pesan
                    Baru</button>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="empty-state">
                        <i class="fas fa-comments"></i>
                        <p>Fitur pusat pesan untuk komunikasi dengan penyewa sedang dalam tahap pengembangan.</p>
                    </div>
                </div>
            </div>
        </section>
    </template>
    <template id="page-template-reports">
        <section id="reports-content" class="page-section">
            <div class="page-header">
                <h2 id="defaultPageTitle">Laporan</h2>
                <!-- Tombol ekspor/filter laporan -->
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="empty-state">
                        <i class="fas fa-chart-pie"></i>
                        <p>Fitur laporan (keuangan, hunian, dll.) sedang dalam tahap pengembangan.</p>
                        <p>Grafik dan tabel ringkasan akan ditampilkan di sini.</p>
                    </div>
                </div>
            </div>
        </section>
    </template>
    <template id="page-template-settings">
        <section id="settings-content" class="page-section">
            <div class="page-header">
                <h2 id="defaultPageTitle">Pengaturan Aplikasi</h2>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Preferensi Umum</h3>
                </div>
                <div class="card-body">
                    <form id="appSettingsForm">
                        <div class="form-group">
                            <label for="settingTheme" class="form-label">Tema Aplikasi</label>
                            <select id="settingTheme" name="theme" class="form-control">
                                <option value="light">Terang</option>
                                <option value="dark">Gelap</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Notifikasi Email</label>
                            <div>
                                <input type="checkbox" id="settingEmailNotif" name="emailNotifications" checked>
                                <label for="settingEmailNotif"
                                    style="font-weight:normal; margin-left:var(--spacing-1);">Aktifkan notifikasi via
                                    email</label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Simpan Pengaturan</button>
                    </form>
                </div>
            </div>
            <div class="card mt-4">
                <div class="card-header">
                    <h3 class="card-title">Pengaturan Lainnya</h3>
                </div>
                <div class="card-body">
                    <p>Pengaturan lebih lanjut seperti integrasi, manajemen user admin, dll. akan ditambahkan di sini.
                    </p>
                </div>
            </div>
        </section>
    </template>
    <template id="page-template-profile">
        <section id="profile-content" class="page-section">
            <div class="page-header">
                <h2 id="defaultPageTitle">Profil Saya</h2>
            </div>
            <div class="card">
                <div class="card-body d-flex" style="gap: var(--spacing-4); align-items: flex-start;">
                    <img src="https://i.pravatar.cc/150?u=admin" alt="Avatar Pengguna"
                        style="width:120px; height:120px; border-radius:var(--radius-full); object-fit:cover;">
                    <div style="flex-grow:1;">
                        <h3>Admin Apartemen</h3>
                        <p class="text-muted">Administrator Sistem</p>
                        <p><i class="fas fa-envelope fa-fw"></i> admin@apartemenku.com</p>
                        <p><i class="fas fa-phone fa-fw"></i> (021) 123-4567</p>
                        <button class="btn btn-sm btn-outline-primary mt-2"><i class="fas fa-edit"></i> Edit
                            Profil</button>
                    </div>
                </div>
            </div>
        </section>
    </template>
    <template id="page-template-settings-account">
        <section id="settings-account-content" class="page-section">
            <div class="page-header">
                <h2 id="defaultPageTitle">Pengaturan Akun</h2>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Ubah Password</h3>
                </div>
                <div class="card-body">
                    <form id="changePasswordForm">
                        <div class="form-group">
                            <label for="currentPassword" class="form-label">Password Saat Ini</label>
                            <input type="password" id="currentPassword" name="currentPassword" class="form-control"
                                required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword" class="form-label">Password Baru</label>
                            <input type="password" id="newPassword" name="newPassword" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="confirmNewPassword" class="form-label">Konfirmasi Password Baru</label>
                            <input type="password" id="confirmNewPassword" name="confirmNewPassword"
                                class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Ubah Password</button>
                    </form>
                </div>
            </div>
        </section>
    </template>

    <!-- Template fallback jika halaman tidak ditemukan -->
    <template id="page-template-default">
        <section class="page-section">
            <div class="page-header">
                <h2 id="defaultPageTitle">Halaman Tidak Ditemukan</h2>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle" style="color:var(--warning-color)"></i>
                        <p>Maaf, halaman yang Anda cari tidak dapat ditemukan atau sedang dalam pengembangan.</p>
                        <p>Silakan kembali ke <a href="#dashboard" class="nav-link-inline">Dashboard</a>.</p>
                    </div>
                </div>
            </div>
        </section>
    </template>

    <script>
        // :: KODE JAVASCRIPT (Vanilla JS - Native Monolith SPA) ::
        (function () {
            'use strict'; // Mode ketat untuk kualitas kode yang lebih baik

            /**
             * AppState (State Aplikasi)
             * Menyimpan semua data dan status penting aplikasi secara terpusat.
             * Ini adalah "Single Source of Truth".
             * Hirarki:
             * - AppState (root)
             *   - ui (state terkait antarmuka pengguna: tema, halaman aktif, status modal/sidebar)
             *   - data (data inti aplikasi: apartemen, booking, dll.)
             *   - preferences (preferensi pengguna yang disimpan)
             */
            const AppState = {
                ui: {
                    currentTheme: localStorage.getItem('apartemenku-theme') || 'light',
                    isSidebarOpen: window.innerWidth >= 992, // Default sidebar terbuka di desktop
                    activePage: 'dashboard', // Halaman aktif default
                    isModalOpen: false,
                    modalContext: null, // Untuk menyimpan data/konteks saat modal dibuka
                    notificationTimeout: null, // ID Timeout untuk notifikasi
                },
                data: {
                    // Contoh data awal. Dalam aplikasi nyata, ini bisa diambil dari API atau localStorage.
                    apartments: [
                        { id: 'apt001', unitNumber: 'A101', type: '1br', status: 'terisi', price: 8000000, tenantName: 'Budi Santoso', image: 'https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&q=60' },
                        { id: 'apt002', unitNumber: 'B205', type: 'studio', status: 'tersedia', price: 5500000, tenantName: null, image: 'https://images.unsplash.com/photo-1604014237800-1c9102c219da?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&q=60' },
                        { id: 'apt003', unitNumber: 'C303', type: '2br', status: 'maintenance', price: 12000000, tenantName: null, image: 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&q=60' },
                        { id: 'apt004', unitNumber: 'D407', type: '3br', status: 'tersedia', price: 15000000, tenantName: null, image: 'https://images.unsplash.com/photo-1493809842364-78817add7ffb?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&q=60' },
                    ],
                    bookings: [
                        { id: 'bk001', tenantName: 'Sarah Wijayanti', apartmentId: 'apt001', unitNumber: 'A101', checkIn: '2024-06-01', checkOut: '2024-12-01', status: 'terkonfirmasi' },
                        { id: 'bk002', tenantName: 'Riko Ramadhan', apartmentId: 'apt002', unitNumber: 'B205', checkIn: '2024-07-15', checkOut: '2025-01-15', status: 'menunggu' },
                    ],
                    activityLog: [ // Contoh data untuk aktivitas terbaru
                        { date: '2024-05-28', activity: 'Booking Baru', detail: 'Apartemen A101 - Budi Santoso', status: 'terkonfirmasi' },
                        { date: '2024-05-27', activity: 'Pembayaran Diterima', detail: 'Apartemen B205 - Siti Aminah', status: 'selesai' },
                        { date: '2024-05-27', activity: 'Permintaan Maintenance', detail: 'Apartemen C303 - Keran Bocor', status: 'pending' },
                    ],
                    // Data lain bisa ditambahkan di sini: payments, maintenanceList, tenants, messages, reports
                },
                preferences: {
                    notificationsEnabled: true,
                    // Preferensi lain bisa ditambahkan
                }
            };

            /**
             * DOMSelectors (Selektor Elemen DOM)
             * Kumpulan referensi ke elemen DOM yang sering digunakan agar lebih efisien dan mudah dikelola.
             */
            const DOM = {
                body: document.body,
                appContainer: document.querySelector('.app-container'),
                sidebar: document.getElementById('appSidebar'),
                sidebarToggle: document.getElementById('sidebarToggle'),
                mainWrapper: document.getElementById('mainWrapper'),
                themeToggleBtn: document.getElementById('themeToggleBtn'),
                profileDropdownToggle: document.getElementById('profileDropdownToggle'),
                profileDropdownMenu: document.getElementById('profileDropdownMenu'),
                logoutButton: document.getElementById('logoutButton'),
                pageContentContainer: document.getElementById('pageContentContainer'),
                currentYearSpan: document.getElementById('currentYear'),
                navLinks: document.querySelectorAll('.nav-link'), // Koleksi link navigasi sidebar
                // Elemen Modal
                appModal: document.getElementById('appModal'),
                appModalLabel: document.getElementById('appModalLabel'),
                appModalBody: document.getElementById('appModalBody'),
                appModalFooter: document.getElementById('appModalFooter'),
                // appModalSaveButton: Akan dicari secara dinamis atau dibuat saat modal di-render
                // Elemen Notifikasi Toast
                notificationToast: document.getElementById('notificationToast'),
                notificationToastTitle: document.getElementById('notificationToastTitle'),
                notificationToastBody: document.getElementById('notificationToastBody'),
            };

            /**
             * Utilities (Fungsi Pembantu)
             * Kumpulan fungsi utilitas umum yang dapat digunakan di seluruh aplikasi.
             */
            const Utils = {
                sanitizeHTML: (str) => {
                    if (str === null || typeof str === 'undefined') return '';
                    const temp = document.createElement('div');
                    temp.textContent = str;
                    return temp.innerHTML;
                },
                generateId: (prefix = 'id') => {
                    return `${prefix}-${Date.now().toString(36)}-${Math.random().toString(36).substring(2, 9)}`;
                },
                formatCurrency: (amount, currency = 'IDR') => {
                    if (typeof amount !== 'number') return amount; // Kembalikan apa adanya jika bukan angka
                    return new Intl.NumberFormat('id-ID', { style: 'currency', currency: currency, minimumFractionDigits: 0 }).format(amount);
                },
                formatDate: (dateString, options = { day: '2-digit', month: 'long', year: 'numeric' }) => {
                    if (!dateString) return '-';
                    try {
                        const date = new Date(dateString);
                        if (isNaN(date.getTime())) return dateString; // Kembalikan string asli jika tidak valid
                        return date.toLocaleDateString('id-ID', options);
                    } catch (e) {
                        return dateString; // Kembalikan string asli jika ada error parsing
                    }
                },
                debounce: (func, delay) => {
                    let timeout;
                    return function (...args) {
                        const context = this;
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(context, args), delay);
                    };
                }
            };

            /**
             * App (Objek Aplikasi Utama)
             * Mengelola semua logika inti aplikasi, termasuk routing, rendering halaman,
             * manajemen state, interaksi pengguna, dan komunikasi antar komponen.
             */
            const App = {
                /**
                 * Inisialisasi aplikasi.
                 * Dipanggil sekali saat halaman dimuat.
                 */
                init() {
                    // Validasi elemen DOM penting
                    if (!DOM.body || !DOM.pageContentContainer || !DOM.sidebar || !DOM.themeToggleBtn) {
                        console.error('Kesalahan Kritis: Elemen DOM penting tidak ditemukan. Aplikasi tidak dapat berjalan.');
                        document.body.innerHTML = '<div style="padding:20px;text-align:center;color:red;font-size:1.2em;">Terjadi kesalahan kritis saat memuat aplikasi. Beberapa komponen UI utama tidak ditemukan. Mohon periksa konsol untuk detail.</div>';
                        return;
                    }

                    this.applyTheme(AppState.ui.currentTheme, true); // Terapkan tema awal tanpa transisi
                    this.updateCurrentYear();
                    this.setupEventListeners(); // Siapkan semua event listener global

                    // Navigasi ke halaman awal berdasarkan hash URL, atau default ke dashboard
                    const initialHash = window.location.hash || '#dashboard';
                    this.navigateTo(initialHash.substring(1), true); // Navigasi awal, true untuk isInitialLoad

                    this.handleResize(); // Atur sidebar berdasarkan ukuran layar awal
                    console.info('Aplikasi ApartemenKu berhasil dimuat dan siap digunakan. Versi 1.0.0');
                },

                // :: MANAJEMEN UI INTI ::
                /**
                 * Menerapkan tema (terang/gelap) ke aplikasi.
                 * @param {string} theme - Nama tema ('light' atau 'dark').
                 * @param {boolean} instant - Jika true, terapkan tanpa transisi (untuk load awal).
                 */
                applyTheme(theme, instant = false) {
                    DOM.body.setAttribute('data-theme', theme);
                    if (DOM.themeToggleBtn) {
                        DOM.themeToggleBtn.innerHTML = `<i class="fas fa-${theme === 'light' ? 'moon' : 'sun'}"></i>`;
                        DOM.themeToggleBtn.setAttribute('aria-label', `Ganti ke tema ${theme === 'light' ? 'Gelap' : 'Terang'}`);
                    }
                    AppState.ui.currentTheme = theme;
                    localStorage.setItem('apartemenku-theme', theme);

                    if (!instant) {
                        // Transisi halus untuk body saat tema berubah (opsional, jika CSS tidak cukup)
                        // DOM.body.style.transition = 'background-color 0.3s ease, color 0.3s ease';
                        // setTimeout(() => DOM.body.style.transition = '', 300);
                    }
                },

                /** Mengganti tema antara terang dan gelap. */
                toggleTheme() {
                    const newTheme = AppState.ui.currentTheme === 'light' ? 'dark' : 'light';
                    this.applyTheme(newTheme);
                    this.showNotification(`Tema diubah ke ${newTheme === 'light' ? 'Terang' : 'Gelap'}.`, 'Perubahan Tema', 'info');
                },

                /** Membuka/menutup sidebar. */
                toggleSidebar() {
                    AppState.ui.isSidebarOpen = !AppState.ui.isSidebarOpen;
                    DOM.sidebar.classList.toggle('show', AppState.ui.isSidebarOpen);
                    // Untuk desktop, kita tidak menggunakan 'collapsed' tapi mengatur margin mainWrapper
                    // Untuk mobile, 'show' akan mentrigger transform.

                    if (window.innerWidth < 992) { // Hanya untuk mobile/tablet
                        DOM.body.style.overflow = AppState.ui.isSidebarOpen ? 'hidden' : '';
                        DOM.sidebarToggle.setAttribute('aria-expanded', AppState.ui.isSidebarOpen);
                    } else { // Untuk desktop
                        DOM.mainWrapper.style.marginLeft = AppState.ui.isSidebarOpen ? 'var(--sidebar-width)' : '0';
                        // Jika ingin sidebar collapse jadi kecil di desktop, tambahkan kelas .collapsed
                        // DOM.sidebar.classList.toggle('collapsed', !AppState.ui.isSidebarOpen);
                    }
                },

                /** Menutup sidebar, biasanya digunakan di mobile setelah klik link navigasi. */
                closeSidebar() {
                    if (window.innerWidth < 992 && AppState.ui.isSidebarOpen) {
                        this.toggleSidebar();
                    }
                },

                /** Menangani perubahan ukuran window untuk menyesuaikan tampilan sidebar. */
                handleResize() {
                    if (window.innerWidth >= 992) { // Layar Desktop
                        // Pastikan sidebar terbuka dan main-wrapper punya margin kiri
                        AppState.ui.isSidebarOpen = true; // Di desktop, anggap selalu "terbuka" (full atau collapsed)
                        DOM.sidebar.classList.remove('show'); // Hapus 'show' yang untuk mobile
                        DOM.sidebar.classList.remove('collapsed'); // Pastikan tidak collapsed by default, kecuali ada state khusus
                        DOM.mainWrapper.style.marginLeft = 'var(--sidebar-width)';
                        DOM.body.style.overflow = ''; // Pastikan body bisa scroll
                        if (DOM.sidebarToggle) DOM.sidebarToggle.setAttribute('aria-expanded', 'false');
                    } else { // Layar Tablet/Mobile
                        // Jika sidebar terbuka di mobile, biarkan. Jika tidak, pastikan ter-transform.
                        // Logika open/close di mobile dihandle oleh toggleSidebar()
                        DOM.mainWrapper.style.marginLeft = '0';
                        if (!AppState.ui.isSidebarOpen) { // Jika tertutup di mobile
                            DOM.sidebar.classList.remove('show');
                        }
                        // Status aria-expanded dihandle oleh toggleSidebar
                    }
                },

                /**
                 * Membuka/menutup dropdown (misalnya, dropdown profil).
                 * @param {HTMLElement} dropdownMenu - Elemen menu dropdown.
                 * @param {HTMLElement} toggleButton - Tombol yang memicu dropdown.
                 */
                toggleDropdown(dropdownMenu, toggleButton) {
                    if (!dropdownMenu || !toggleButton) return;
                    const isShown = dropdownMenu.classList.toggle('show');
                    toggleButton.setAttribute('aria-expanded', isShown.toString());
                },

                // :: NAVIGASI SPA (SINGLE PAGE APPLICATION) ::
                /**
                 * Navigasi ke halaman tertentu dalam SPA.
                 * @param {string} pageId - ID halaman tujuan (tanpa '#').
                 * @param {boolean} isInitialLoad - True jika ini adalah pemuatan halaman awal.
                 */
                navigateTo(pageId, isInitialLoad = false) {
                    pageId = pageId || 'dashboard'; // Fallback ke dashboard jika pageId kosong

                    // Jika bukan load awal dan halaman sudah aktif, jangan lakukan apa-apa
                    if (!isInitialLoad && AppState.ui.activePage === pageId) return;

                    AppState.ui.activePage = pageId;
                    if (!isInitialLoad) {
                        window.location.hash = pageId; // Update hash URL
                    }

                    this.loadPageContent(pageId); // Muat konten halaman

                    // Update status 'active' pada link navigasi di sidebar
                    DOM.navLinks.forEach(link => {
                        link.classList.toggle('active', link.getAttribute('href') === `#${pageId}`);
                    });

                    this.closeSidebar(); // Tutup sidebar (efeknya hanya di mobile)
                    document.title = `ApartemenKu | ${pageId.charAt(0).toUpperCase() + pageId.slice(1)}`; // Update judul tab browser
                },

                /**
                 * Memuat konten halaman dari template HTML dan merendernya.
                 * @param {string} pageId - ID halaman yang akan dimuat.
                 */
                loadPageContent(pageId) {
                    const templateId = `page-template-${pageId}`;
                    const templateElement = document.getElementById(templateId);

                    DOM.pageContentContainer.innerHTML = ''; // Bersihkan konten lama

                    if (templateElement) {
                        const content = templateElement.content.cloneNode(true);
                        DOM.pageContentContainer.appendChild(content);

                        // Panggil fungsi render spesifik untuk halaman tersebut setelah konten dimuat
                        const renderFunctionName = `render${pageId.charAt(0).toUpperCase() + pageId.slice(1)}`;
                        if (typeof this[renderFunctionName] === 'function') {
                            this[renderFunctionName]();
                        } else {
                            console.warn(`Fungsi render ${renderFunctionName} tidak ditemukan untuk halaman '${pageId}'.`);
                            // Jika fungsi render tidak ada, mungkin tampilkan halaman default atau error
                        }
                    } else {
                        // Fallback jika template halaman utama tidak ditemukan, coba load template default
                        console.warn(`Template untuk halaman '${pageId}' (${templateId}) tidak ditemukan. Memuat template default.`);
                        const defaultTemplate = document.getElementById('page-template-default');
                        if (defaultTemplate) {
                            const content = defaultTemplate.content.cloneNode(true);
                            // Kustomisasi judul halaman default jika perlu
                            const titleEl = content.querySelector('#defaultPageTitle');
                            if (titleEl) titleEl.textContent = `Halaman: ${Utils.sanitizeHTML(pageId)}`;
                            DOM.pageContentContainer.appendChild(content);
                        } else {
                            DOM.pageContentContainer.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>Konten untuk halaman '${Utils.sanitizeHTML(pageId)}' tidak dapat dimuat.</p></div>`;
                        }
                    }
                    window.scrollTo(0, 0); // Scroll ke atas halaman setiap navigasi
                },

                // :: MANAJEMEN MODAL ::
                /**
                 * Membuka modal dialog.
                 * @param {string} title - Judul modal.
                 * @param {string} bodyContentHTML - Konten HTML untuk body modal.
                 * @param {string|null} footerContentHTML - Konten HTML untuk footer modal. Jika null, gunakan footer default.
                 * @param {object|null} context - Data atau konteks tambahan untuk modal.
                 */
                openModal(title, bodyContentHTML, footerContentHTML = null, context = null) {
                    if (!DOM.appModal || !DOM.appModalLabel || !DOM.appModalBody || !DOM.appModalFooter) {
                        console.error("Elemen modal (appModal, appModalLabel, appModalBody, appModalFooter) tidak ditemukan.");
                        return;
                    }
                    DOM.appModalLabel.textContent = title;
                    DOM.appModalBody.innerHTML = bodyContentHTML; // Hati-hati dengan XSS jika bodyContentHTML dari user input

                    if (footerContentHTML) {
                        DOM.appModalFooter.innerHTML = footerContentHTML;
                    } else { // Footer default
                        DOM.appModalFooter.innerHTML = `
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                            <button type="button" class="btn btn-primary" id="appModalDefaultSaveButton">Simpan</button>`;
                    }
                    // Selalu pasang listener untuk tombol dismiss di modal (header & footer)
                    DOM.appModal.querySelectorAll('[data-dismiss="modal"]').forEach(btn => {
                        btn.replaceWith(btn.cloneNode(true)); // Hapus listener lama
                        DOM.appModal.querySelector(`[aria-label="${btn.getAttribute('aria-label')}"]`)
                            .addEventListener('click', () => this.closeModal());
                    });


                    DOM.appModal.classList.add('show');
                    DOM.appModal.setAttribute('aria-hidden', 'false');
                    DOM.body.style.overflow = 'hidden'; // Mencegah scroll body di belakang modal
                    AppState.ui.isModalOpen = true;
                    AppState.ui.modalContext = context;

                    // Fokus ke elemen interaktif pertama di modal untuk aksesibilitas
                    const focusableElements = DOM.appModal.querySelectorAll(
                        'button, [href], input:not([type="hidden"]), select, textarea, [tabindex]:not([tabindex="-1"])'
                    );
                    if (focusableElements.length > 0) {
                        focusableElements[0].focus();
                    }
                },

                /** Menutup modal dialog. */
                closeModal() {
                    if (!DOM.appModal) return;
                    DOM.appModal.classList.remove('show');
                    DOM.appModal.setAttribute('aria-hidden', 'true');
                    DOM.body.style.overflow = ''; // Kembalikan scroll body
                    AppState.ui.isModalOpen = false;
                    AppState.ui.modalContext = null;
                    // Kosongkan modal body dan footer untuk penggunaan selanjutnya (opsional, tapi bersih)
                    DOM.appModalBody.innerHTML = '';
                    DOM.appModalFooter.innerHTML = '';
                    DOM.appModalLabel.textContent = 'Judul Modal'; // Reset title
                },

                /**
                 * Menyiapkan form di dalam modal, termasuk validasi submit.
                 * @param {string} formId - ID dari elemen form di dalam modal.
                 * @param {function} submitCallback - Fungsi yang akan dipanggil saat form valid dan disubmit. Menerima FormData.
                 */
                setupModalForm(formId, submitCallback) {
                    const form = DOM.appModalBody.querySelector(`#${formId}`);
                    if (!form) {
                        console.error(`Form dengan ID "${formId}" tidak ditemukan di dalam modal.`);
                        return;
                    }

                    // Hapus event listener submit lama untuk mencegah duplikasi jika modal dibuka berkali-kali
                    // Cara simpel: simpan referensi handler atau clone & replace form (kurang ideal)
                    // Cara lebih baik: gunakan named function untuk handler dan removeEventListener
                    // Untuk vanilla murni tanpa framework, ini bisa jadi tricky. Kita akan attach sekali saja.
                    // Jika form dirender ulang setiap modal dibuka, ini tidak masalah.
                    // Kita akan mengasumsikan form dirender ulang setiap kali openModal dengan bodyContentHTML baru.

                    const handleSubmit = (event) => {
                        event.preventDefault();
                        if (this.validateForm(form)) {
                            if (typeof submitCallback === 'function') {
                                submitCallback(new FormData(form));
                            }
                        } else {
                            this.showNotification('Harap perbaiki kesalahan pada form sebelum melanjutkan.', 'Validasi Gagal', 'warning');
                            // Fokus ke input invalid pertama
                            const firstInvalid = form.querySelector('.is-invalid, :invalid');
                            if (firstInvalid) firstInvalid.focus();
                        }
                    };
                    form.removeEventListener('submit', form._currentSubmitHandler); // Hapus handler lama jika ada
                    form.addEventListener('submit', handleSubmit);
                    form._currentSubmitHandler = handleSubmit; // Simpan handler saat ini


                    // Validasi input real-time (opsional tapi baik untuk UX)
                    form.querySelectorAll('input, select, textarea').forEach(input => {
                        const handleInputValidation = () => this._validateInputElement(input);
                        input.removeEventListener('input', input._currentInputHandler);
                        input.removeEventListener('change', input._currentInputHandler); // Untuk select dan type=date
                        input.addEventListener('input', handleInputValidation);
                        input.addEventListener('change', handleInputValidation);
                        input._currentInputHandler = handleInputValidation;
                    });
                },

                /**
                 * Handler internal untuk submit form modal.
                 * @param {Event} event - Event submit.
                 * @private
                 */
                _handleModalFormSubmit(event) { // Ini akan dipanggil dari setupModalForm
                    event.preventDefault();
                    const form = event.target;
                    if (this.validateForm(form)) {
                        // Callback harus sudah di-pass dan disimpan di context atau diambil dari setup
                        if (AppState.ui.modalContext && typeof AppState.ui.modalContext.submitCallback === 'function') {
                            AppState.ui.modalContext.submitCallback(new FormData(form));
                        }
                    } else {
                        this.showNotification('Harap perbaiki error pada form sebelum melanjutkan.', 'Validasi Gagal', 'danger');
                    }
                },

                /**
                 * Memvalidasi satu elemen input.
                 * @param {HTMLInputElement|HTMLSelectElement|HTMLTextAreaElement} inputElement - Elemen input yang akan divalidasi.
                 * @private
                 */
                _validateInputElement(inputElement) {
                    const formGroup = inputElement.closest('.form-group');
                    if (!formGroup) return;
                    const feedbackElement = formGroup.querySelector('.invalid-feedback');

                    if (inputElement.checkValidity()) {
                        inputElement.classList.remove('is-invalid');
                        if (feedbackElement) feedbackElement.style.display = 'none';
                    } else {
                        inputElement.classList.add('is-invalid');
                        if (feedbackElement) {
                            feedbackElement.textContent = inputElement.validationMessage || 'Input tidak valid.';
                            feedbackElement.style.display = 'block';
                        }
                    }
                },

                /**
                 * Memvalidasi semua input yang `required` dalam sebuah form.
                 * @param {HTMLFormElement} formElement - Elemen form yang akan divalidasi.
                 * @returns {boolean} - True jika form valid, false jika tidak.
                 */
                validateForm(formElement) {
                    let isValid = true;
                    // Iterasi semua elemen yang mungkin perlu validasi
                    formElement.querySelectorAll('input, select, textarea').forEach(input => {
                        if (input.willValidate) { // Hanya validasi elemen yang bisa divalidasi
                            this._validateInputElement(input); // Panggil validasi per elemen
                            if (!input.checkValidity()) {
                                isValid = false;
                            }
                        }
                    });
                    return isValid;
                },

                // :: MANAJEMEN NOTIFIKASI TOAST ::
                /**
                 * Menampilkan notifikasi toast.
                 * @param {string} message - Pesan notifikasi.
                 * @param {string} title - Judul notifikasi.
                 * @param {string} type - Tipe notifikasi ('info', 'success', 'warning', 'danger').
                 * @param {number} duration - Durasi tampilan notifikasi dalam milidetik.
                 */
                showNotification(message, title = 'Notifikasi', type = 'info', duration = 5000) {
                    if (!DOM.notificationToast || !DOM.notificationToastTitle || !DOM.notificationToastBody) {
                        console.warn('Elemen toast notifikasi (notificationToast, notificationToastTitle, notificationToastBody) tidak ditemukan.');
                        return;
                    }
                    DOM.notificationToastTitle.textContent = title;
                    DOM.notificationToastBody.innerHTML = Utils.sanitizeHTML(message); // Selalu sanitasi pesan

                    // Hapus kelas tipe lama sebelum menambahkan yang baru
                    DOM.notificationToast.classList.remove('info', 'success', 'warning', 'danger');
                    DOM.notificationToast.classList.add(type);

                    DOM.notificationToast.classList.add('show');
                    DOM.notificationToast.setAttribute('aria-hidden', 'false');


                    // Hapus timeout lama jika ada (mencegah penutupan prematur jika notif baru muncul cepat)
                    if (AppState.ui.notificationTimeout) clearTimeout(AppState.ui.notificationTimeout);

                    AppState.ui.notificationTimeout = setTimeout(() => {
                        this.hideNotification();
                    }, duration);
                },

                /** Menyembunyikan notifikasi toast. */
                hideNotification() {
                    if (!DOM.notificationToast) return;
                    DOM.notificationToast.classList.remove('show');
                    DOM.notificationToast.setAttribute('aria-hidden', 'true');
                    if (AppState.ui.notificationTimeout) {
                        clearTimeout(AppState.ui.notificationTimeout);
                        AppState.ui.notificationTimeout = null;
                    }
                },

                // :: RENDER HALAMAN DINAMIS & DATA ::
                /** Merender konten untuk halaman Dashboard. */
                renderDashboard() {
                    // Contoh update statistik dari AppState
                    const stats = {
                        availableUnits: AppState.data.apartments.filter(apt => apt.status === 'tersedia').length,
                        activeTenants: AppState.data.apartments.filter(apt => apt.status === 'terisi').length, // Idealnya data tenant terpisah
                        pendingPayments: AppState.data.bookings.filter(b => b.status === 'menunggu_pembayaran' || b.status === 'menunggu').length, // Contoh status pembayaran
                        maintenanceRequests: AppState.data.apartments.filter(apt => apt.status === 'maintenance').length,
                    };
                    for (const key in stats) {
                        const el = DOM.pageContentContainer.querySelector(`[data-stat="${key}"]`);
                        if (el) el.textContent = stats[key];
                    }

                    // Render aktivitas terbaru
                    const activityTableBody = DOM.pageContentContainer.querySelector('#activityTableBody');
                    if (activityTableBody) {
                        activityTableBody.innerHTML = ''; // Bersihkan dulu
                        if (AppState.data.activityLog.length > 0) {
                            AppState.data.activityLog.slice(0, 5).forEach(log => { // Ambil 5 terbaru
                                const row = activityTableBody.insertRow();
                                row.innerHTML = `
                                    <td>${Utils.formatDate(log.date)}</td>
                                    <td>${Utils.sanitizeHTML(log.activity)}</td>
                                    <td>${Utils.sanitizeHTML(log.detail)}</td>
                                    <td><span class="badge ${Utils.sanitizeHTML(log.status)}">${Utils.sanitizeHTML(log.status.replace('_', ' '))}</span></td>
                                `;
                            });
                        } else {
                            activityTableBody.innerHTML = `<tr><td colspan="4" class="text-center" style="padding: var(--spacing-4);">Tidak ada aktivitas terbaru.</td></tr>`;
                        }
                    }
                    console.log("Dashboard dirender.");
                },

                /** Merender konten untuk halaman Apartemen. */
                renderApartments() {
                    const container = DOM.pageContentContainer.querySelector('#apartmentsGridContainer');
                    const emptyState = DOM.pageContentContainer.querySelector('#apartmentsEmptyState');
                    if (!container || !emptyState) {
                        console.error("Container '#apartmentsGridContainer' atau '#apartmentsEmptyState' untuk apartemen tidak ditemukan.");
                        return;
                    }
                    container.innerHTML = ''; // Bersihkan dulu

                    const apartmentsToRender = AppState.data.apartments; // Nanti bisa difilter

                    if (apartmentsToRender.length === 0) {
                        emptyState.classList.remove('d-none');
                        container.classList.add('d-none');
                    } else {
                        emptyState.classList.add('d-none');
                        container.classList.remove('d-none');
                        const fragment = document.createDocumentFragment();
                        apartmentsToRender.forEach(apt => {
                            const card = document.createElement('div');
                            card.className = 'card apartment-card'; // Kelas card utama dan spesifik
                            card.innerHTML = `
                                <img src="${Utils.sanitizeHTML(apt.image || 'https://via.placeholder.com/300x200.png?text=Gambar+Apartemen')}" alt="Gambar Apartemen ${Utils.sanitizeHTML(apt.unitNumber)}">
                                <div class="card-body">
                                    <h3 class="card-title">Unit ${Utils.sanitizeHTML(apt.unitNumber)}</h3>
                                    <p>Tipe: ${Utils.sanitizeHTML(apt.type.toUpperCase())} | Status: <span class="badge ${Utils.sanitizeHTML(apt.status)}">${Utils.sanitizeHTML(apt.status)}</span></p>
                                    <p class="price">${Utils.formatCurrency(apt.price)} / bulan</p>
                                    ${apt.tenantName ? `<p style="font-size:0.85em;"><i class="fas fa-user fa-fw"></i> Dihuni oleh: ${Utils.sanitizeHTML(apt.tenantName)}</p>` : `<p style="font-size:0.85em; color:var(--success-color);"><i class="fas fa-check-circle fa-fw"></i> Tersedia untuk disewa</p>`}
                                    <div class="apartment-actions">
                                        <button class="btn btn-sm btn-outline-primary view-apartment-details" data-id="${apt.id}" aria-label="Lihat Detail Unit ${Utils.sanitizeHTML(apt.unitNumber)}"><i class="fas fa-eye"></i> Detail</button>
                                        <button class="btn btn-sm btn-secondary edit-apartment" data-id="${apt.id}" aria-label="Edit Unit ${Utils.sanitizeHTML(apt.unitNumber)}"><i class="fas fa-edit"></i> Edit</button>
                                        <button class="btn btn-sm btn-danger delete-apartment" data-id="${apt.id}" aria-label="Hapus Unit ${Utils.sanitizeHTML(apt.unitNumber)}"><i class="fas fa-trash"></i> Hapus</button>
                                    </div>
                                </div>
                            `;
                            fragment.appendChild(card);
                        });
                        container.appendChild(fragment);
                    }
                    this._setupApartmentPageListeners(); // Pasang event listener untuk tombol-tombol di halaman ini
                    console.log("Halaman Apartemen dirender.");
                },

                /** Menyiapkan event listener khusus untuk halaman Apartemen. */
                _setupApartmentPageListeners() {
                    const addApartmentBtn = DOM.pageContentContainer.querySelector('#addApartmentBtn');
                    if (addApartmentBtn) {
                        addApartmentBtn.addEventListener('click', () => this.showApartmentForm());
                    }
                    const addApartmentLinkEmpty = DOM.pageContentContainer.querySelector('#addApartmentLinkFromEmpty');
                    if (addApartmentLinkEmpty) {
                        addApartmentLinkEmpty.addEventListener('click', (e) => {
                            e.preventDefault();
                            this.showApartmentForm();
                        });
                    }

                    // Event delegation untuk tombol action di setiap kartu apartemen
                    const apartmentsGridContainer = DOM.pageContentContainer.querySelector('#apartmentsGridContainer');
                    if (apartmentsGridContainer) {
                        apartmentsGridContainer.addEventListener('click', (event) => {
                            const targetButton = event.target.closest('button');
                            if (!targetButton) return;

                            const apartmentId = targetButton.dataset.id;
                            if (targetButton.classList.contains('view-apartment-details')) {
                                this.viewApartmentDetails(apartmentId);
                            } else if (targetButton.classList.contains('edit-apartment')) {
                                this.showApartmentForm(apartmentId);
                            } else if (targetButton.classList.contains('delete-apartment')) {
                                this.confirmDeleteApartment(apartmentId);
                            }
                        });
                    }
                    // Listener untuk filter bisa ditambahkan di sini
                },

                /** Merender konten untuk halaman Booking. */
                renderBookings() {
                    const tableBody = DOM.pageContentContainer.querySelector('#bookingTableBody');
                    const emptyState = DOM.pageContentContainer.querySelector('#bookingsEmptyState');
                    const tableElement = DOM.pageContentContainer.querySelector('#bookingsTable');

                    if (!tableBody || !emptyState || !tableElement) {
                        console.error("Elemen tabel (#bookingTableBody, #bookingsEmptyState, #bookingsTable) untuk booking tidak ditemukan.");
                        return;
                    }
                    tableBody.innerHTML = ''; // Bersihkan

                    const bookingsToRender = AppState.data.bookings; // Nanti bisa difilter

                    if (bookingsToRender.length === 0) {
                        emptyState.classList.remove('d-none');
                        tableElement.classList.add('d-none');
                    } else {
                        emptyState.classList.add('d-none');
                        tableElement.classList.remove('d-none');
                        const fragment = document.createDocumentFragment();
                        bookingsToRender.forEach(booking => {
                            const row = fragment.appendChild(document.createElement('tr'));
                            row.innerHTML = `
                                <td>${Utils.sanitizeHTML(booking.id)}</td>
                                <td>${Utils.sanitizeHTML(booking.tenantName)}</td>
                                <td>${Utils.sanitizeHTML(booking.unitNumber)}</td>
                                <td>${Utils.formatDate(booking.checkIn)}</td>
                                <td>${Utils.formatDate(booking.checkOut)}</td>
                                <td><span class="badge ${Utils.sanitizeHTML(booking.status)}">${Utils.sanitizeHTML(booking.status.replace('_', ' '))}</span></td>
                                <td class="actions">
                                    <button class="btn btn-sm btn-outline-primary view-booking-details" data-id="${booking.id}" aria-label="Lihat Detail Booking ${Utils.sanitizeHTML(booking.id)}"><i class="fas fa-eye"></i></button>
                                    <button class="btn btn-sm btn-secondary edit-booking" data-id="${booking.id}" aria-label="Edit Booking ${Utils.sanitizeHTML(booking.id)}"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-sm btn-danger delete-booking" data-id="${booking.id}" aria-label="Hapus Booking ${Utils.sanitizeHTML(booking.id)}"><i class="fas fa-trash"></i></button>
                                </td>
                            `;
                        });
                        tableBody.appendChild(fragment);
                    }
                    this._setupBookingPageListeners();
                    console.log("Halaman Booking dirender.");
                },

                _setupBookingPageListeners() {
                    const addBtn = DOM.pageContentContainer.querySelector('#addBookingBtn');
                    if (addBtn) addBtn.addEventListener('click', () => this.showBookingForm());

                    const addLinkEmpty = DOM.pageContentContainer.querySelector('#addBookingLinkFromEmpty');
                    if (addLinkEmpty) addLinkEmpty.addEventListener('click', (e) => { e.preventDefault(); this.showBookingForm(); });

                    const tableBody = DOM.pageContentContainer.querySelector('#bookingTableBody');
                    if (tableBody) {
                        tableBody.addEventListener('click', (e) => {
                            const target = e.target.closest('button');
                            if (!target) return;
                            const bookingId = target.dataset.id;
                            if (target.classList.contains('edit-booking')) this.showBookingForm(bookingId);
                            else if (target.classList.contains('delete-booking')) this.confirmDeleteBooking(bookingId);
                            else if (target.classList.contains('view-booking-details')) this.viewBookingDetails(bookingId);
                        });
                    }
                },

                renderPayments() { console.log("Render Halaman Payments: Belum diimplementasikan detailnya."); },
                renderMaintenance() { console.log("Render Halaman Maintenance: Belum diimplementasikan detailnya."); },
                renderTenants() { console.log("Render Halaman Tenants: Belum diimplementasikan detailnya."); },
                renderMessages() { console.log("Render Halaman Messages: Belum diimplementasikan detailnya."); },
                renderReports() { console.log("Render Halaman Reports: Belum diimplementasikan detailnya."); },
                renderSettings() {
                    console.log("Render Halaman Settings.");
                    const themeSelect = DOM.pageContentContainer.querySelector('#settingTheme');
                    if (themeSelect) {
                        themeSelect.value = AppState.ui.currentTheme;
                        themeSelect.addEventListener('change', (e) => {
                            this.applyTheme(e.target.value);
                            this.showNotification('Tema berhasil diubah.', 'Pengaturan Disimpan', 'success');
                        });
                    }
                    // Listener untuk form settings lainnya
                },
                renderProfile() { console.log("Render Halaman Profile: Belum diimplementasikan detailnya."); },
                renderSettingsAccount() { console.log("Render Halaman Settings-Account: Belum diimplementasikan detailnya."); },


                // :: OPERASI CRUD & FORM (CONTOH UNTUK APARTEMEN & BOOKING) ::

                /** Menampilkan form tambah/edit apartemen di modal. */
                showApartmentForm(apartmentId = null) {
                    const isEditMode = apartmentId !== null;
                    const apartment = isEditMode ? AppState.data.apartments.find(apt => apt.id === apartmentId) : {};

                    if (isEditMode && !apartment) {
                        this.showNotification('Data apartemen tidak ditemukan.', 'Error', 'danger');
                        return;
                    }

                    const formHTML = `
                        <form id="apartmentForm" novalidate>
                            <input type="hidden" name="id" value="${isEditMode ? Utils.sanitizeHTML(apartment.id) : ''}">
                            <div class="form-group">
                                <label for="unitNumber" class="form-label">Nomor Unit <span style="color:var(--danger-color)">*</span></label>
                                <input type="text" class="form-control" id="unitNumber" name="unitNumber" value="${isEditMode ? Utils.sanitizeHTML(apartment.unitNumber) : ''}" required placeholder="Contoh: A101">
                                <div class="invalid-feedback">Nomor unit wajib diisi.</div>
                            </div>
                            <div class="form-group">
                                <label for="type" class="form-label">Tipe Unit <span style="color:var(--danger-color)">*</span></label>
                                <select class="form-control" id="type" name="type" required>
                                    <option value="">Pilih tipe...</option>
                                    <option value="studio" ${isEditMode && apartment.type === 'studio' ? 'selected' : ''}>Studio</option>
                                    <option value="1br" ${isEditMode && apartment.type === '1br' ? 'selected' : ''}>1 Kamar Tidur</option>
                                    <option value="2br" ${isEditMode && apartment.type === '2br' ? 'selected' : ''}>2 Kamar Tidur</option>
                                    <option value="3br" ${isEditMode && apartment.type === '3br' ? 'selected' : ''}>3+ Kamar Tidur</option>
                                </select>
                                <div class="invalid-feedback">Tipe unit wajib dipilih.</div>
                            </div>
                            <div class="form-group">
                                <label for="price" class="form-label">Harga Sewa per Bulan <span style="color:var(--danger-color)">*</span></label>
                                <input type="number" class="form-control" id="price" name="price" value="${isEditMode ? apartment.price : ''}" required placeholder="Contoh: 5000000" min="0">
                                <div class="invalid-feedback">Harga sewa wajib diisi dan harus angka positif.</div>
                            </div>
                            <div class="form-group">
                                <label for="status" class="form-label">Status Unit <span style="color:var(--danger-color)">*</span></label>
                                <select class="form-control" id="status" name="status" required>
                                    <option value="tersedia" ${isEditMode && apartment.status === 'tersedia' ? 'selected' : ''}>Tersedia</option>
                                    <option value="terisi" ${isEditMode && apartment.status === 'terisi' ? 'selected' : ''}>Terisi</option>
                                    <option value="maintenance" ${isEditMode && apartment.status === 'maintenance' ? 'selected' : ''}>Maintenance</option>
                                </select>
                                <div class="invalid-feedback">Status unit wajib dipilih.</div>
                            </div>
                            <div class="form-group">
                                <label for="tenantName" class="form-label">Nama Penghuni (jika status 'Terisi')</label>
                                <input type="text" class="form-control" id="tenantName" name="tenantName" value="${isEditMode && apartment.tenantName ? Utils.sanitizeHTML(apartment.tenantName) : ''}" placeholder="Kosongkan jika tidak terisi">
                                <div class="invalid-feedback">Nama penghuni wajib diisi jika status 'Terisi'.</div>
                            </div>
                            <div class="form-group">
                                <label for="image" class="form-label">URL Gambar Apartemen</label>
                                <input type="url" class="form-control" id="image" name="image" value="${isEditMode && apartment.image ? Utils.sanitizeHTML(apartment.image) : ''}" placeholder="https://contoh.com/gambar.jpg">
                                <div class="invalid-feedback">URL gambar tidak valid.</div>
                            </div>
                        </form>
                    `;
                    const modalTitle = isEditMode ? `Edit Apartemen Unit ${Utils.sanitizeHTML(apartment.unitNumber)}` : 'Tambah Unit Apartemen Baru';
                    this.openModal(modalTitle, formHTML, null, { formType: 'apartment', isEditMode, apartmentId });
                    this.setupModalForm('apartmentForm', (formData) => this.saveApartment(formData));

                    // Dinamis required untuk tenantName
                    const statusSelect = DOM.appModalBody.querySelector('#status');
                    const tenantNameInput = DOM.appModalBody.querySelector('#tenantName');
                    if (statusSelect && tenantNameInput) {
                        const toggleTenantNameRequired = () => {
                            tenantNameInput.required = statusSelect.value === 'terisi';
                        };
                        statusSelect.addEventListener('change', toggleTenantNameRequired);
                        toggleTenantNameRequired(); // Panggil sekali saat form dimuat
                    }
                },

                /** Menyimpan data apartemen (baru atau editan). */
                saveApartment(formData) {
                    const id = formData.get('id') || Utils.generateId('apt'); // Generate ID jika baru
                    const unitNumber = formData.get('unitNumber');
                    const type = formData.get('type');
                    const price = parseInt(formData.get('price'), 10);
                    const status = formData.get('status');
                    const tenantName = status === 'terisi' ? formData.get('tenantName') : null; // Hanya simpan jika terisi
                    const image = formData.get('image') || null;

                    // Validasi spesifik tambahan (di luar HTML5 required)
                    if (status === 'terisi' && !tenantName) {
                        this.showNotification('Nama penghuni wajib diisi jika status unit adalah "Terisi".', 'Validasi Gagal', 'warning');
                        const tenantNameEl = DOM.appModalBody.querySelector('#tenantName');
                        if (tenantNameEl) {
                            tenantNameEl.classList.add('is-invalid');
                            tenantNameEl.focus();
                            const feedback = tenantNameEl.closest('.form-group').querySelector('.invalid-feedback');
                            if (feedback) {
                                feedback.textContent = 'Nama penghuni wajib diisi jika status unit adalah "Terisi".';
                                feedback.style.display = 'block';
                            }
                        }
                        return; // Hentikan penyimpanan
                    }


                    const apartmentData = { id, unitNumber, type, price, status, tenantName, image };
                    const context = AppState.ui.modalContext; // Ambil konteks dari state modal

                    if (context && context.isEditMode) { // Jika mode edit
                        const index = AppState.data.apartments.findIndex(apt => apt.id === context.apartmentId);
                        if (index > -1) {
                            AppState.data.apartments[index] = apartmentData;
                            this.showNotification(`Apartemen Unit ${Utils.sanitizeHTML(unitNumber)} berhasil diperbarui.`, 'Sukses', 'success');
                        } else {
                            this.showNotification('Gagal memperbarui: Apartemen tidak ditemukan.', 'Error', 'danger');
                            return;
                        }
                    } else { // Jika mode tambah baru
                        AppState.data.apartments.push(apartmentData);
                        this.showNotification(`Apartemen Unit ${Utils.sanitizeHTML(unitNumber)} berhasil ditambahkan.`, 'Sukses', 'success');
                    }
                    this.closeModal();
                    if (AppState.ui.activePage === 'apartments') {
                        this.renderApartments(); // Re-render halaman apartemen untuk menampilkan perubahan
                    }
                    // Pertimbangkan untuk memperbarui statistik dashboard juga
                    if (AppState.ui.activePage === 'dashboard') this.renderDashboard();
                },

                /** Menampilkan konfirmasi sebelum menghapus apartemen. */
                confirmDeleteApartment(apartmentId) {
                    const apartment = AppState.data.apartments.find(apt => apt.id === apartmentId);
                    if (!apartment) {
                        this.showNotification('Data apartemen tidak ditemukan.', 'Error', 'danger');
                        return;
                    }
                    const confirmationHTML = `<p>Anda yakin ingin menghapus data apartemen <strong>Unit ${Utils.sanitizeHTML(apartment.unitNumber)}</strong>? Tindakan ini tidak dapat diurungkan.</p>`;
                    const footerHTML = `
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Ya, Hapus</button>
                    `;
                    this.openModal('Konfirmasi Hapus Apartemen', confirmationHTML, footerHTML);

                    // Tambahkan event listener ke tombol konfirmasi hapus di modal
                    const confirmBtn = DOM.appModalFooter.querySelector('#confirmDeleteBtn');
                    if (confirmBtn) {
                        confirmBtn.addEventListener('click', () => {
                            AppState.data.apartments = AppState.data.apartments.filter(apt => apt.id !== apartmentId);
                            this.showNotification(`Apartemen Unit ${Utils.sanitizeHTML(apartment.unitNumber)} berhasil dihapus.`, 'Sukses', 'success');
                            this.closeModal();
                            if (AppState.ui.activePage === 'apartments') this.renderApartments();
                            if (AppState.ui.activePage === 'dashboard') this.renderDashboard();
                        }, { once: true }); // { once: true } agar listener otomatis dihapus setelah dijalankan
                    }
                },

                /** Menampilkan detail apartemen di modal. */
                viewApartmentDetails(apartmentId) {
                    const apartment = AppState.data.apartments.find(apt => apt.id === apartmentId);
                    if (!apartment) {
                        this.showNotification('Data apartemen tidak ditemukan.', 'Error', 'danger');
                        return;
                    }
                    const detailsHTML = `
                        <div class="apartment-detail-view" style="font-size: 0.95rem;">
                            <img src="${Utils.sanitizeHTML(apartment.image || 'https://via.placeholder.com/400x200.png?text=Tidak+Ada+Gambar')}" alt="Apartemen ${Utils.sanitizeHTML(apartment.unitNumber)}" style="width:100%; max-height:250px; object-fit:cover; border-radius:var(--radius-md); margin-bottom:var(--spacing-3);">
                            <h4>Unit ${Utils.sanitizeHTML(apartment.unitNumber)}</h4>
                            <p><strong>Tipe:</strong> ${Utils.sanitizeHTML(apartment.type.toUpperCase())}</p>
                            <p><strong>Status:</strong> <span class="badge ${Utils.sanitizeHTML(apartment.status)}">${Utils.sanitizeHTML(apartment.status)}</span></p>
                            <p><strong>Harga Sewa:</strong> ${Utils.formatCurrency(apartment.price)} / bulan</p>
                            ${apartment.tenantName ? `<p><strong>Dihuni oleh:</strong> ${Utils.sanitizeHTML(apartment.tenantName)}</p>` : ''}
                            <hr style="margin: var(--spacing-3) 0; border-color: var(--border-color);">
                            <p><em>Detail tambahan seperti fasilitas, luas unit, catatan khusus, dll. bisa ditambahkan di sini.</em></p>
                        </div>
                    `;
                    const footerHTML = `<button type="button" class="btn btn-primary" data-dismiss="modal">Tutup</button>`;
                    this.openModal(`Detail Apartemen - Unit ${Utils.sanitizeHTML(apartment.unitNumber)}`, detailsHTML, footerHTML);
                },

                /** Menampilkan form tambah/edit booking di modal. */
                showBookingForm(bookingId = null) {
                    const isEditMode = bookingId !== null;
                    const booking = isEditMode ? AppState.data.bookings.find(b => b.id === bookingId) : {};

                    if (isEditMode && !booking) {
                        this.showNotification('Data booking tidak ditemukan.', 'Error', 'danger');
                        return;
                    }

                    // Opsi untuk unit apartemen: hanya yang tersedia, atau yang sedang di-book jika mode edit
                    let apartmentOptionsHTML = AppState.data.apartments
                        .filter(apt => apt.status === 'tersedia' || (isEditMode && apt.id === booking.apartmentId))
                        .map(apt => `<option value="${Utils.sanitizeHTML(apt.id)}" ${isEditMode && apt.id === booking.apartmentId ? 'selected' : ''}>${Utils.sanitizeHTML(apt.unitNumber)} (${Utils.sanitizeHTML(apt.type)})</option>`)
                        .join('');

                    if (apartmentOptionsHTML === '' && !isEditMode) {
                        apartmentOptionsHTML = '<option value="" disabled>Tidak ada unit apartemen yang tersedia saat ini.</option>';
                    }


                    const formHTML = `
                        <form id="bookingForm" novalidate>
                            <input type="hidden" name="id" value="${isEditMode ? Utils.sanitizeHTML(booking.id) : ''}">
                            <div class="form-group">
                                <label for="tenantName" class="form-label">Nama Penyewa <span style="color:var(--danger-color)">*</span></label>
                                <input type="text" class="form-control" id="tenantName" name="tenantName" value="${isEditMode ? Utils.sanitizeHTML(booking.tenantName) : ''}" required>
                                <div class="invalid-feedback">Nama penyewa wajib diisi.</div>
                            </div>
                            <div class="form-group">
                                <label for="apartmentId" class="form-label">Unit Apartemen <span style="color:var(--danger-color)">*</span></label>
                                <select class="form-control" id="apartmentId" name="apartmentId" required ${apartmentOptionsHTML.includes('disabled') ? 'disabled' : ''}>
                                    <option value="">Pilih unit...</option>
                                    ${apartmentOptionsHTML}
                                </select>
                                <div class="invalid-feedback">Unit apartemen wajib dipilih.</div>
                            </div>
                            <div class="form-group">
                                <label for="checkIn" class="form-label">Tanggal Check-in <span style="color:var(--danger-color)">*</span></label>
                                <input type="date" class="form-control" id="checkIn" name="checkIn" value="${isEditMode ? booking.checkIn : ''}" required>
                                <div class="invalid-feedback">Tanggal check-in wajib diisi.</div>
                            </div>
                            <div class="form-group">
                                <label for="checkOut" class="form-label">Tanggal Check-out <span style="color:var(--danger-color)">*</span></label>
                                <input type="date" class="form-control" id="checkOut" name="checkOut" value="${isEditMode ? booking.checkOut : ''}" required>
                                <div class="invalid-feedback">Tanggal check-out wajib diisi.</div>
                            </div>
                            <div class="form-group">
                                <label for="status" class="form-label">Status Booking <span style="color:var(--danger-color)">*</span></label>
                                <select class="form-control" id="status" name="status" required>
                                    <option value="menunggu" ${isEditMode && booking.status === 'menunggu' ? 'selected' : ''}>Menunggu Konfirmasi</option>
                                    <option value="terkonfirmasi" ${isEditMode && booking.status === 'terkonfirmasi' ? 'selected' : ''}>Terkonfirmasi</option>
                                    <option value="dibatalkan" ${isEditMode && booking.status === 'dibatalkan' ? 'selected' : ''}>Dibatalkan</option>
                                    <option value="selesai" ${isEditMode && booking.status === 'selesai' ? 'selected' : ''}>Selesai (Checked-out)</option>
                                </select>
                                <div class="invalid-feedback">Status booking wajib dipilih.</div>
                            </div>
                        </form>
                    `;
                    const modalTitle = isEditMode ? `Edit Booking ${Utils.sanitizeHTML(booking.id)}` : 'Tambah Booking Baru';
                    this.openModal(modalTitle, formHTML, null, { formType: 'booking', isEditMode, bookingId });
                    this.setupModalForm('bookingForm', (formData) => this.saveBooking(formData));
                },

                saveBooking(formData) {
                    const id = formData.get('id') || Utils.generateId('bk');
                    const tenantName = formData.get('tenantName');
                    const apartmentId = formData.get('apartmentId');
                    const checkIn = formData.get('checkIn');
                    const checkOut = formData.get('checkOut');
                    const status = formData.get('status');

                    if (new Date(checkOut) <= new Date(checkIn)) {
                        this.showNotification('Tanggal check-out harus setelah tanggal check-in.', 'Validasi Gagal', 'warning');
                        const checkOutInput = DOM.appModalBody.querySelector('#checkOut');
                        if (checkOutInput) {
                            checkOutInput.classList.add('is-invalid');
                            checkOutInput.focus();
                            const feedback = checkOutInput.closest('.form-group').querySelector('.invalid-feedback');
                            if (feedback) {
                                feedback.textContent = 'Tanggal check-out harus setelah tanggal check-in.';
                                feedback.style.display = 'block';
                            }
                        }
                        return;
                    }

                    const apartment = AppState.data.apartments.find(apt => apt.id === apartmentId);
                    if (!apartment) {
                        this.showNotification('Unit apartemen yang dipilih tidak valid atau tidak ditemukan.', 'Error Input', 'danger');
                        return;
                    }

                    const bookingData = { id, tenantName, apartmentId, unitNumber: apartment.unitNumber, checkIn, checkOut, status };
                    const context = AppState.ui.modalContext;
                    let oldApartmentId = null; // Untuk handle jika unit apartemen diubah saat edit booking

                    if (context && context.isEditMode) {
                        const index = AppState.data.bookings.findIndex(b => b.id === context.bookingId);
                        if (index > -1) {
                            oldApartmentId = AppState.data.bookings[index].apartmentId; // Simpan ID apartemen lama
                            AppState.data.bookings[index] = bookingData;
                            this.showNotification(`Booking untuk ${Utils.sanitizeHTML(tenantName)} berhasil diperbarui.`, 'Sukses', 'success');
                        } else {
                            this.showNotification('Gagal memperbarui: Booking tidak ditemukan.', 'Error', 'danger'); return;
                        }
                    } else {
                        AppState.data.bookings.push(bookingData);
                        this.showNotification(`Booking untuk ${Utils.sanitizeHTML(tenantName)} berhasil ditambahkan.`, 'Sukses', 'success');
                    }

                    // Update status apartemen terkait
                    this._updateApartmentStatusAfterBooking(apartmentId, status, tenantName);
                    if (oldApartmentId && oldApartmentId !== apartmentId) { // Jika unit diubah, apartemen lama harus jadi tersedia
                        this._updateApartmentStatusAfterBooking(oldApartmentId, 'tersedia', null);
                    }


                    this.closeModal();
                    if (AppState.ui.activePage === 'bookings') this.renderBookings();
                    if (AppState.ui.activePage === 'apartments') this.renderApartments();
                    if (AppState.ui.activePage === 'dashboard') this.renderDashboard();
                },

                _updateApartmentStatusAfterBooking(apartmentId, bookingStatus, tenantNameIfConfirmed) {
                    const aptIndex = AppState.data.apartments.findIndex(a => a.id === apartmentId);
                    if (aptIndex > -1) {
                        if (bookingStatus === 'terkonfirmasi' || bookingStatus === 'selesai') { // 'selesai' berarti pernah terkonfirmasi
                            AppState.data.apartments[aptIndex].status = 'terisi';
                            AppState.data.apartments[aptIndex].tenantName = tenantNameIfConfirmed;
                        } else if (bookingStatus === 'dibatalkan' || bookingStatus === 'tersedia') { // Jika dibatalkan atau diubah ke unit lain
                            // Hanya ubah ke 'tersedia' jika tidak ada booking lain yang 'terkonfirmasi' untuk unit ini
                            const isStillBooked = AppState.data.bookings.some(b => b.apartmentId === apartmentId && (b.status === 'terkonfirmasi'));
                            if (!isStillBooked) {
                                AppState.data.apartments[aptIndex].status = 'tersedia';
                                AppState.data.apartments[aptIndex].tenantName = null;
                            }
                        }
                        // Status 'menunggu' tidak mengubah status apartemen
                    }
                },


                confirmDeleteBooking(bookingId) {
                    const booking = AppState.data.bookings.find(b => b.id === bookingId);
                    if (!booking) {
                        this.showNotification('Data booking tidak ditemukan.', 'Error', 'danger');
                        return;
                    }
                    const confirmationHTML = `<p>Anda yakin ingin menghapus data booking untuk <strong>${Utils.sanitizeHTML(booking.tenantName)} (Unit ${Utils.sanitizeHTML(booking.unitNumber)})</strong>?</p>`;
                    const footerHTML = `
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Ya, Hapus</button>
                    `;
                    this.openModal('Konfirmasi Hapus Booking', confirmationHTML, footerHTML);

                    DOM.appModalFooter.querySelector('#confirmDeleteBtn').addEventListener('click', () => {
                        const oldStatus = booking.status;
                        const oldApartmentId = booking.apartmentId;
                        AppState.data.bookings = AppState.data.bookings.filter(b => b.id !== bookingId);

                        // Jika booking yang dihapus membuat apartemen jadi tersedia
                        if (oldStatus === 'terkonfirmasi') {
                            this._updateApartmentStatusAfterBooking(oldApartmentId, 'tersedia', null);
                        }

                        this.showNotification(`Booking untuk ${Utils.sanitizeHTML(booking.tenantName)} berhasil dihapus.`, 'Sukses', 'success');
                        this.closeModal();
                        if (AppState.ui.activePage === 'bookings') this.renderBookings();
                        if (AppState.ui.activePage === 'apartments') this.renderApartments();
                        if (AppState.ui.activePage === 'dashboard') this.renderDashboard();
                    }, { once: true });
                },

                viewBookingDetails(bookingId) {
                    const booking = AppState.data.bookings.find(b => b.id === bookingId);
                    if (!booking) {
                        this.showNotification('Booking tidak ditemukan.', 'Error', 'danger'); return;
                    }
                    const apartment = AppState.data.apartments.find(apt => apt.id === booking.apartmentId);

                    const detailsHTML = `
                        <div style="font-size: 0.95rem;">
                            <h4>Detail Booking ID: ${Utils.sanitizeHTML(booking.id)}</h4>
                            <p><strong>Nama Penyewa:</strong> ${Utils.sanitizeHTML(booking.tenantName)}</p>
                            <p><strong>Unit Apartemen:</strong> ${Utils.sanitizeHTML(booking.unitNumber)} ${apartment ? `(Tipe: ${Utils.sanitizeHTML(apartment.type)})` : '(Unit tidak ditemukan)'}</p>
                            <p><strong>Tanggal Check-in:</strong> ${Utils.formatDate(booking.checkIn)}</p>
                            <p><strong>Tanggal Check-out:</strong> ${Utils.formatDate(booking.checkOut)}</p>
                            <p><strong>Status:</strong> <span class="badge ${Utils.sanitizeHTML(booking.status)}">${Utils.sanitizeHTML(booking.status.replace('_', ' '))}</span></p>
                            <hr style="margin: var(--spacing-3) 0; border-color: var(--border-color);">
                            <p><em>Detail pembayaran, kontak penyewa, histori, dll. dapat ditambahkan di sini.</em></p>
                        </div>
                    `;
                    const footerHTML = `<button type="button" class="btn btn-primary" data-dismiss="modal">Tutup</button>`;
                    this.openModal(`Detail Booking - ${Utils.sanitizeHTML(booking.tenantName)}`, detailsHTML, footerHTML);
                },

                // :: EVENT LISTENERS GLOBAL ::
                /** Menyiapkan semua event listener global untuk aplikasi. */
                setupEventListeners() {
                    // Toggle Tema
                    DOM.themeToggleBtn.addEventListener('click', () => this.toggleTheme());

                    // Toggle Sidebar (hanya untuk tombol di header mobile)
                    if (DOM.sidebarToggle) {
                        DOM.sidebarToggle.addEventListener('click', () => this.toggleSidebar());
                    }

                    // Navigasi halaman dari link sidebar
                    DOM.navLinks.forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const pageId = link.dataset.page; // Ambil dari data-page
                            if (pageId) this.navigateTo(pageId);
                        });
                    });

                    // Dropdown Profil
                    if (DOM.profileDropdownToggle && DOM.profileDropdownMenu) {
                        DOM.profileDropdownToggle.addEventListener('click', (e) => {
                            e.stopPropagation(); // Mencegah penutupan oleh listener window
                            this.toggleDropdown(DOM.profileDropdownMenu, DOM.profileDropdownToggle);
                        });
                        // Listener untuk link di dalam dropdown profil
                        DOM.profileDropdownMenu.querySelectorAll('a[data-page]').forEach(link => {
                            link.addEventListener('click', (e) => {
                                e.preventDefault();
                                const pageId = link.dataset.page;
                                this.navigateTo(pageId);
                                this.toggleDropdown(DOM.profileDropdownMenu, DOM.profileDropdownToggle); // Tutup dropdown
                            });
                        });
                    }
                    // Logout button
                    if (DOM.logoutButton) {
                        DOM.logoutButton.addEventListener('click', (e) => {
                            e.preventDefault();
                            this.showNotification('Anda telah berhasil logout.', 'Logout Sukses', 'success');
                            // Di aplikasi nyata, ini akan menghapus session/token dan redirect ke halaman login
                            // Untuk demo ini, kita hanya tutup dropdown dan kembali ke dashboard
                            if (DOM.profileDropdownMenu.classList.contains('show')) {
                                this.toggleDropdown(DOM.profileDropdownMenu, DOM.profileDropdownToggle);
                            }
                            this.navigateTo('dashboard'); // atau halaman login jika ada
                        });
                    }


                    // Menutup dropdown/modal saat klik di luar atau Escape
                    window.addEventListener('click', (e) => {
                        // Tutup dropdown profil jika klik di luar
                        if (DOM.profileDropdownMenu && DOM.profileDropdownMenu.classList.contains('show') &&
                            !DOM.profileDropdownToggle.contains(e.target) && !DOM.profileDropdownMenu.contains(e.target)) {
                            this.toggleDropdown(DOM.profileDropdownMenu, DOM.profileDropdownToggle);
                        }
                    });

                    window.addEventListener('keydown', (e) => {
                        // Tutup modal dengan tombol Escape
                        if (e.key === 'Escape' && AppState.ui.isModalOpen) {
                            this.closeModal();
                        }
                    });

                    // Tombol close pada notifikasi toast
                    const toastCloseBtn = DOM.notificationToast.querySelector('.btn-close');
                    if (toastCloseBtn) {
                        toastCloseBtn.addEventListener('click', () => this.hideNotification());
                    }

                    // Listener untuk perubahan hash URL (navigasi back/forward browser)
                    window.addEventListener('hashchange', () => {
                        const pageId = window.location.hash.substring(1);
                        if (pageId && pageId !== AppState.ui.activePage) { // Hindari reload jika hash sama
                            this.navigateTo(pageId);
                        } else if (!pageId && AppState.ui.activePage !== 'dashboard') { // Jika hash kosong, ke dashboard
                            this.navigateTo('dashboard');
                        }
                    });

                    // Listener untuk resize window
                    window.addEventListener('resize', Utils.debounce(() => this.handleResize(), 200));
                },

                // :: UTILITAS APLIKASI LAINNYA ::
                /** Memperbarui tahun copyright di footer. */
                updateCurrentYear() {
                    if (DOM.currentYearSpan) {
                        DOM.currentYearSpan.textContent = new Date().getFullYear();
                    }
                },
            };

            // Mulai aplikasi setelah DOM sepenuhnya dimuat
            document.addEventListener('DOMContentLoaded', () => {
                App.init();
            });

        })(); // Akhir dari IIFE (Immediately Invoked Function Expression)
    </script>
</body>

</html>