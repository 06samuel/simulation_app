<!DOCTYPE html>
<html lang="id" data-theme="light">

<head>
    <meta charset="UTF-_8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green Valley - Hunian Impian Anda</title>
    <style>
        /* === CSS Reset & Global Styles === */
        :root {
            --primary-color: #4CAF50;
            /* Green */
            --secondary-color: #FF9800;
            /* Orange */
            --accent-color: #2196F3;
            /* Blue */
            --text-color: #333333;
            --bg-color: #f4f4f4;
            --card-bg-color: #ffffff;
            --border-color: #dddddd;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius: 8px;
            --transition-speed: 0.3s;
        }

        [data-theme="dark"] {
            --text-color: #f0f0f0;
            --bg-color: #1a1a1a;
            --card-bg-color: #2c2c2c;
            --border-color: #444444;
            --shadow-color: rgba(255, 255, 255, 0.05);
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 0;
        }

        /* === Semantic HTML Elements Styling === */
        header {
            background-color: var(--card-bg-color);
            color: var(--text-color);
            padding: 1rem 0;
            box-shadow: 0 2px 4px var(--shadow-color);
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
        }

        header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            color: var(--primary-color);
            font-size: 1.8rem;
            margin: 0;
            cursor: pointer;
        }

        nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
        }

        nav ul li {
            margin-left: 20px;
        }

        nav ul li a,
        .nav-button {
            color: var(--text-color);
            text-decoration: none;
            font-weight: bold;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1rem;
            font-family: var(--font-family);
        }

        nav ul li a:hover,
        .nav-button:hover {
            background-color: var(--primary-color);
            color: white;
        }

        main {
            flex-grow: 1;
            padding: 20px 0;
        }

        footer {
            background-color: var(--card-bg-color);
            color: var(--text-color);
            text-align: center;
            padding: 1rem 0;
            margin-top: auto;
            box-shadow: 0 -2px 4px var(--shadow-color);
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
        }

        /* === UI Components === */
        .button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color var(--transition-speed) ease, transform 0.1s ease;
        }

        .button:hover {
            background-color: #3e8e41;
            /* Darker green */
            transform: translateY(-2px);
        }

        .button.secondary {
            background-color: var(--secondary-color);
        }

        .button.secondary:hover {
            background-color: #e68a00;
        }

        .button.accent {
            background-color: var(--accent-color);
        }

        .button.accent:hover {
            background-color: #1e87db;
        }


        .card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px var(--shadow-color);
            transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease, background-color var(--transition-speed) ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px var(--shadow-color);
        }

        .card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            margin-bottom: 15px;
        }

        .card h3 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 10px;
        }

        .property-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="date"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
        }

        /* Modal Styles */
        .modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--card-bg-color);
            margin: auto;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px var(--shadow-color);
            width: 80%;
            max-width: 600px;
            position: relative;
            animation: slideInModal 0.4s ease-out;
        }

        @keyframes slideInModal {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .close-button {
            color: var(--text-color);
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--primary-color);
            text-decoration: none;
        }

        /* Specific Page/Component Styles */
        #home-page .hero {
            text-align: center;
            padding: 50px 20px;
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius);
            margin-bottom: 30px;
        }

        #home-page .hero h2 {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        #home-page .hero p {
            font-size: 1.2rem;
            margin-bottom: 25px;
        }

        #search-form {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            align-items: flex-end;
        }

        #search-form input[type="text"] {
            flex-grow: 1;
        }

        /* Dashboard styles */
        .dashboard-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
        }

        .summary-card h4 {
            margin-top: 0;
            font-size: 1.1rem;
        }

        .summary-card p {
            font-size: 2rem;
            font-weight: bold;
            margin: 5px 0 0;
        }

        /* Notifications */
        .notifications-indicator {
            position: relative;
            cursor: pointer;
        }

        .notification-count {
            position: absolute;
            top: -5px;
            right: -8px;
            background-color: var(--secondary-color);
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7rem;
            font-weight: bold;
            display: none;
            /* Hidden by default, shown by JS */
        }

        #notifications-modal .notification-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        #notifications-modal .notification-item:last-child {
            border-bottom: none;
        }

        #notifications-modal .notification-item.unread {
            background-color: rgba(76, 175, 80, 0.1);
            /* Light green */
        }

        /* Theme Toggle */
        #theme-toggle {
            padding: 8px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            header .container {
                flex-direction: column;
                align-items: flex-start;
            }

            nav ul {
                margin-top: 10px;
                flex-direction: column;
                width: 100%;
            }

            nav ul li {
                margin-left: 0;
                margin-bottom: 5px;
                width: 100%;
            }

            nav ul li a,
            .nav-button {
                display: block;
                text-align: left;
            }

            #search-form {
                flex-direction: column;
                align-items: stretch;
            }

            .modal-content {
                width: 95%;
            }
        }

        @media (max-width: 480px) {
            header h1 {
                font-size: 1.5rem;
            }

            #home-page .hero h2 {
                font-size: 2rem;
            }

            #home-page .hero p {
                font-size: 1rem;
            }

            .property-grid {
                grid-template-columns: 1fr;
                /* Single column on very small screens */
            }
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-1 {
            margin-top: 1rem;
        }

        .mb-1 {
            margin-bottom: 1rem;
        }

        .mb-2 {
            margin-bottom: 2rem;
        }
    </style>
</head>

<body>

    <header>
        <div class="container">
            <h1 data-route="home">Green Valley</h1>
            <nav>
                <ul>
                    <li><a href="#home" data-route="home">Beranda</a></li>
                    <li><a href="#listings" data-route="listings">Properti</a></li>
                    <li><a href="#dashboard" data-route="dashboard">Dashboard Manager</a></li>
                    <li>
                        <div class="notifications-indicator" id="notifications-button">
                            üîî<span class="notification-count" id="notification-count-badge">0</span>
                        </div>
                    </li>
                    <li><button id="theme-toggle" class="nav-button" title="Ubah Tema">üåì</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <main id="router-view" class="container">
        <!-- Konten halaman akan dimuat di sini oleh JavaScript -->
    </main>

    <footer>
        <div class="container">
            <p>¬© <span id="current-year"></span> Green Valley. Semua hak dilindungi.</p>
        </div>
    </footer>

    <!-- === TEMPLATES (SFC Concept) === -->
    <template id="home-page-template">
        <section id="home-page">
            <div class="hero">
                <h2>Temukan Hunian Impianmu di Green Valley</h2>
                <p>Apartemen modern dengan fasilitas lengkap di lokasi strategis. Kenyamanan dan kualitas hidup terbaik
                    menanti Anda.</p>
                <button class="button" data-route="listings">Lihat Properti Tersedia</button>
            </div>
            <h3 class="text-center mb-2">Mengapa Memilih Green Valley?</h3>
            <div class="property-grid">
                <div class="card">
                    <h4>üìç Lokasi Strategis</h4>
                    <p>Dekat dengan pusat bisnis, area perbelanjaan, dan akses transportasi publik.</p>
                </div>
                <div class="card">
                    <h4>üõãÔ∏è Fasilitas Lengkap</h4>
                    <p>Kolam renang, gym, area bermain anak, keamanan 24 jam, dan banyak lagi.</p>
                </div>
                <div class="card">
                    <h4>‚ú® Desain Modern</h4>
                    <p>Unit apartemen dengan desain interior modern dan fungsional.</p>
                </div>
            </div>
        </section>
    </template>

    <template id="listings-page-template">
        <section id="listings-page">
            <h2>Daftar Properti</h2>
            <form id="search-form">
                <div class="form-group">
                    <label for="search-location">Cari berdasarkan lokasi atau nama:</label>
                    <input type="text" id="search-location" placeholder="Contoh: Tower A, Sudirman">
                </div>
                <button type="submit" class="button">Cari</button>
            </form>
            <div id="property-listings-grid" class="property-grid">
                <!-- Kartu properti akan dimuat di sini -->
                <p id="no-results-message" class="hidden">Tidak ada properti yang cocok dengan pencarian Anda.</p>
            </div>
        </section>
    </template>

    <template id="property-card-template">
        <article class="card property-item" data-id="{id}">
            <img src="{gambar}" alt="Properti {nama}">
            <h3>{nama}</h3>
            <p><strong>Lokasi:</strong> {lokasi}</p>
            <p><strong>Harga:</strong> Rp {harga}/bulan</p>
            <p><strong>Ketersediaan:</strong> <span class="availability-status"
                    data-available="{ketersediaan}">{statusKetersediaan}</span></p>
            <button class="button accent view-details-btn" data-id="{id}">Lihat Detail</button>
        </article>
    </template>

    <template id="dashboard-page-template">
        <section id="dashboard-page">
            <h2>Dashboard Manager</h2>
            <div class="dashboard-summary">
                <div class="summary-card">
                    <h4>Total Properti</h4>
                    <p id="dashboard-total-properties">0</p>
                </div>
                <div class="summary-card">
                    <h4>Properti Tersedia</h4>
                    <p id="dashboard-available-properties">0</p>
                </div>
                <div class="summary-card">
                    <h4>Estimasi Pendapatan Bulanan</h4>
                    <p id="dashboard-estimated-revenue">Rp 0</p>
                </div>
            </div>
            <h3>Manajemen Properti</h3>
            <div id="dashboard-property-list">
                <!-- Daftar properti untuk manajemen -->
            </div>
        </section>
    </template>

    <template id="dashboard-property-item-template">
        <div class="card dashboard-property-item" data-id="{id}">
            <h4>{nama} ({lokasi})</h4>
            <p>Status: <span class="availability-status" data-available="{ketersediaan}">{statusKetersediaan}</span></p>
            <p>Harga: Rp {harga}/bulan</p>
            <button class="button secondary toggle-availability-btn" data-id="{id}">
                {tombolAksiKetersediaan}
            </button>
            <p class="mt-1"><em>Laporan Pendapatan: (Simulasi) Bulan ini Rp {harga}</em></p>
        </div>
    </template>

    <!-- === MODALS === -->
    <div id="property-detail-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-id="property-detail-modal">√ó</span>
            <div id="modal-property-content">
                <!-- Detail properti akan dimuat di sini -->
            </div>
        </div>
    </div>
    <template id="property-detail-content-template">
        <img src="{gambar}" alt="Properti {nama}"
            style="width:100%; max-height: 300px; object-fit: cover; border-radius: var(--border-radius); margin-bottom: 15px;">
        <h2>{nama}</h2>
        <p><strong>Lokasi:</strong> {lokasi}</p>
        <p><strong>Harga:</strong> Rp {harga}/bulan</p>
        <p><strong>Deskripsi:</strong> {deskripsi}</p>
        <p><strong>Fasilitas:</strong> {fasilitas}</p>
        <p><strong>Ketersediaan:</strong> <span class="availability-status"
                data-available="{ketersediaan}">{statusKetersediaan}</span></p>
        <div id="map-placeholder" class="card"
            style="height: 200px; display:flex; align-items:center; justify-content:center; background-color: #e0e0e0; margin-top:15px;">
            Peta Lokasi (Simulasi Integrasi Peta untuk {lokasi})
        </div>
        <button class="button book-now-btn mt-1" data-id="{id}" {disabledPesan}>Pesan Sekarang</button>
    </template>


    <div id="booking-form-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-id="booking-form-modal">√ó</span>
            <h3>Formulir Pemesanan: <span id="booking-property-name"></span></h3>
            <form id="booking-form">
                <input type="hidden" id="booking-property-id">
                <div class="form-group">
                    <label for="booker-name">Nama Lengkap:</label>
                    <input type="text" id="booker-name" required>
                </div>
                <div class="form-group">
                    <label for="booker-email">Email:</label>
                    <input type="email" id="booker-email" required>
                </div>
                <div class="form-group">
                    <label for="booker-phone">Nomor Telepon:</label>
                    <input type="text" id="booker-phone" required>
                </div>
                <div class="form-group">
                    <label for="booker-movein-date">Tanggal Masuk:</label>
                    <input type="date" id="booker-movein-date" required>
                </div>
                <p><strong>Simulasi Pembayaran:</strong></p>
                <div class="form-group">
                    <label for="card-number">Nomor Kartu (Contoh: 1234-5678-9012-3456):</label>
                    <input type="text" id="card-number" value="1234-5678-9012-3456" required>
                </div>
                <button type="submit" class="button">Proses Pembayaran & Pesan</button>
            </form>
        </div>
    </div>

    <div id="booking-confirmation-modal" class="modal">
        <div class="modal-content text-center">
            <span class="close-button" data-modal-id="booking-confirmation-modal">√ó</span>
            <h2 id="confirmation-title">Pemesanan Berhasil!</h2>
            <p id="confirmation-message">Terima kasih telah melakukan pemesanan. Detail konfirmasi telah dikirim ke
                email Anda.</p>
            <p><strong>ID Transaksi (Simulasi):</strong> <span id="transaction-id"></span></p>
            <button class="button mt-1 close-confirmation-btn" data-modal-id="booking-confirmation-modal">Tutup</button>
        </div>
    </div>

    <div id="notifications-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-id="notifications-modal">√ó</span>
            <h3>Notifikasi</h3>
            <div id="notifications-list">
                <p>Tidak ada notifikasi baru.</p>
            </div>
            <button id="mark-all-read-btn" class="button mt-1">Tandai Semua Sudah Dibaca</button>
        </div>
    </div>


    <script>
        // === Green Valley SPA - Vanilla JavaScript ===

        // --- Global State & Data ---
        const AppState = {
            currentPage: 'home',
            currentUser: { id: 'manager01', role: 'manager' }, // Simulasi pengguna login sebagai manager
            properties: [
                { id: 'prop1', nama: 'Apartemen Tower Tulip A101', lokasi: 'Green Valley Central', harga: 5000000, gambar: 'https://source.unsplash.com/random/400x300/?apartment,modern', deskripsi: 'Apartemen 1BR modern dengan pemandangan kota, fully furnished.', fasilitas: 'Kolam Renang, Gym, Parkir', ketersediaan: true, idPemilik: 'manager01' },
                { id: 'prop2', nama: 'Studio Mawar B205', lokasi: 'Green Valley Residence', harga: 3500000, gambar: 'https://source.unsplash.com/random/400x300/?apartment,cozy', deskripsi: 'Studio nyaman, cocok untuk profesional muda.', fasilitas: 'Dapur Mini, Keamanan 24 Jam', ketersediaan: true, idPemilik: 'manager01' },
                { id: 'prop3', nama: 'Apartemen Anggrek C310 (2BR)', lokasi: 'Green Valley Heights', harga: 7500000, gambar: 'https://source.unsplash.com/random/400x300/?apartment,luxury', deskripsi: 'Apartemen 2 kamar tidur luas dengan balkon pribadi.', fasilitas: 'Playground, Jogging Track, Akses Lift Pribadi', ketersediaan: false, idPemilik: 'manager01' },
                { id: 'prop4', nama: 'Penthouse Edelweiss PH-01', lokasi: 'Green Valley Skytower', harga: 15000000, gambar: 'https://source.unsplash.com/random/400x300/?apartment,penthouse', deskripsi: 'Penthouse mewah dengan pemandangan 360 derajat kota.', fasilitas: 'Kolam Renang Pribadi, Rooftop Garden, Layanan Concierge', ketersediaan: true, idPemilik: 'manager01' }
            ],
            bookings: [],
            notifications: [
                // { id: 'notif1', message: 'Pemesanan baru untuk Apartemen Tower Tulip A101.', recipient: 'manager01', read: false, timestamp: new Date() }
            ]
        };

        // --- DOM Elements ---
        const routerView = document.getElementById('router-view');
        const themeToggleButton = document.getElementById('theme-toggle');
        const currentYearSpan = document.getElementById('current-year');
        const notificationsButton = document.getElementById('notifications-button');
        const notificationCountBadge = document.getElementById('notification-count-badge');

        // --- Templates ---
        const templates = {
            home: document.getElementById('home-page-template'),
            listings: document.getElementById('listings-page-template'),
            propertyCard: document.getElementById('property-card-template'),
            propertyDetail: document.getElementById('property-detail-content-template'),
            dashboard: document.getElementById('dashboard-page-template'),
            dashboardPropertyItem: document.getElementById('dashboard-property-item-template'),
        };

        // --- Utility Functions ---
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID').format(amount);
        }

        function addNotification(message, recipient = 'manager01', isUrgent = false) {
            const newNotif = {
                id: `notif${Date.now()}`,
                message,
                recipient,
                read: false,
                timestamp: new Date()
            };
            AppState.notifications.unshift(newNotif); // Add to beginning
            updateNotificationBadge();
            if (isUrgent) alert(`Notifikasi Penting: ${message}`); // Simple alert for urgent
        }

        function updateNotificationBadge() {
            const unreadCount = AppState.notifications.filter(n => !n.read && (n.recipient === AppState.currentUser.id || n.recipient === 'all')).length;
            if (unreadCount > 0) {
                notificationCountBadge.textContent = unreadCount;
                notificationCountBadge.style.display = 'inline-block';
            } else {
                notificationCountBadge.style.display = 'none';
            }
        }

        // --- Modal Management ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex'; // Use flex for centering
                // Populate content if necessary (e.g., for notifications)
                if (modalId === 'notifications-modal') renderNotificationsList();
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'none';
        }

        document.querySelectorAll('.close-button, .close-confirmation-btn').forEach(btn => {
            btn.addEventListener('click', () => closeModal(btn.dataset.modalId));
        });
        // Close modal if clicked outside content
        window.addEventListener('click', (event) => {
            document.querySelectorAll('.modal').forEach(modal => {
                if (event.target == modal) {
                    closeModal(modal.id);
                }
            });
        });

        // --- Rendering Functions (SFC-like components) ---
        function renderHomePage() {
            routerView.innerHTML = templates.home.innerHTML;
            // Add event listeners for elements within this "component"
            routerView.querySelector('[data-route="listings"]').addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('listings');
            });
        }

        function renderListingsPage(searchTerm = '') {
            routerView.innerHTML = templates.listings.innerHTML;
            const grid = routerView.querySelector('#property-listings-grid');
            const noResultsMsg = routerView.querySelector('#no-results-message');
            grid.innerHTML = ''; // Clear previous listings

            const filteredProperties = AppState.properties.filter(p =>
                p.nama.toLowerCase().includes(searchTerm.toLowerCase()) ||
                p.lokasi.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (filteredProperties.length === 0) {
                noResultsMsg.classList.remove('hidden');
            } else {
                noResultsMsg.classList.add('hidden');
                filteredProperties.forEach(prop => {
                    const cardTemplate = templates.propertyCard.innerHTML;
                    const cardHTML = cardTemplate
                        .replace(/{id}/g, prop.id)
                        .replace('{gambar}', prop.gambar)
                        .replace('{nama}', prop.nama)
                        .replace('{lokasi}', prop.lokasi)
                        .replace('{harga}', formatCurrency(prop.harga))
                        .replace('{ketersediaan}', prop.ketersediaan)
                        .replace('{statusKetersediaan}', prop.ketersediaan ? 'Tersedia' : 'Disewa');

                    const cardElement = document.createElement('div'); // Create a wrapper to parse HTML
                    cardElement.innerHTML = cardHTML;
                    const actualCard = cardElement.firstElementChild;

                    if (!prop.ketersediaan) {
                        actualCard.style.opacity = '0.7';
                        actualCard.querySelector('.view-details-btn').textContent = 'Lihat (Disewa)';
                    }

                    grid.appendChild(actualCard);
                });
            }

            // Add event listeners for search and view details
            routerView.querySelector('#search-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const term = routerView.querySelector('#search-location').value;
                renderListingsPage(term);
            });

            grid.querySelectorAll('.view-details-btn').forEach(btn => {
                btn.addEventListener('click', () => showPropertyDetail(btn.dataset.id));
            });
        }

        function showPropertyDetail(propertyId) {
            const prop = AppState.properties.find(p => p.id === propertyId);
            if (!prop) return;

            const detailContentTemplate = templates.propertyDetail.innerHTML;
            const detailHTML = detailContentTemplate
                .replace(/{id}/g, prop.id)
                .replace('{gambar}', prop.gambar)
                .replace('{nama}', prop.nama)
                .replace('{lokasi}', prop.lokasi)
                .replace('{harga}', formatCurrency(prop.harga))
                .replace('{deskripsi}', prop.deskripsi)
                .replace('{fasilitas}', prop.fasilitas)
                .replace('{ketersediaan}', prop.ketersediaan)
                .replace('{statusKetersediaan}', prop.ketersediaan ? 'Tersedia' : 'Sudah Disewa')
                .replace('{disabledPesan}', prop.ketersediaan ? '' : 'disabled');

            document.getElementById('modal-property-content').innerHTML = detailHTML;

            // Simulate map integration
            const mapPlaceholder = document.getElementById('map-placeholder');
            if (mapPlaceholder) { // Check if it's part of current template
                mapPlaceholder.innerHTML = `Peta Lokasi (Simulasi Integrasi Peta untuk ${prop.lokasi})`;
                console.log(`Simulasi Map: Menampilkan peta untuk ${prop.lokasi}`);
            }

            // Add event listener for "Book Now"
            const bookBtn = document.querySelector('#modal-property-content .book-now-btn');
            if (bookBtn) {
                bookBtn.addEventListener('click', () => {
                    closeModal('property-detail-modal');
                    showBookingForm(prop.id);
                });
            }
            openModal('property-detail-modal');
        }

        function showBookingForm(propertyId) {
            const prop = AppState.properties.find(p => p.id === propertyId);
            if (!prop || !prop.ketersediaan) {
                alert('Properti ini tidak tersedia untuk dipesan.');
                return;
            }

            document.getElementById('booking-property-name').textContent = prop.nama;
            document.getElementById('booking-property-id').value = prop.id;
            document.getElementById('booking-form').reset(); // Clear previous form data
            openModal('booking-form-modal');
        }

        function handleBookingSubmit(event) {
            event.preventDefault();
            const propertyId = document.getElementById('booking-property-id').value;
            const prop = AppState.properties.find(p => p.id === propertyId);

            if (!prop || !prop.ketersediaan) {
                alert('Maaf, properti ini baru saja tidak tersedia.');
                closeModal('booking-form-modal');
                renderCurrentPage(); // Re-render to reflect changes
                return;
            }

            const bookingDetails = {
                propertyId: propertyId,
                propertyName: prop.nama,
                bookerName: document.getElementById('booker-name').value,
                bookerEmail: document.getElementById('booker-email').value,
                bookerPhone: document.getElementById('booker-phone').value,
                moveInDate: document.getElementById('booker-movein-date').value,
                bookingDate: new Date().toISOString()
            };

            // Simulate Payment Processing
            console.log("Memproses pembayaran...");
            // Simulate API call to payment gateway
            setTimeout(() => {
                const paymentSuccess = Math.random() > 0.1; // 90% success rate
                if (paymentSuccess) {
                    const transactionId = `TRX-${Date.now()}-${Math.random().toString(36).substr(2, 5).toUpperCase()}`;
                    console.log(`Pembayaran berhasil. ID Transaksi: ${transactionId}`);

                    // Update property availability
                    prop.ketersediaan = false;
                    AppState.bookings.push({ ...bookingDetails, transactionId });

                    closeModal('booking-form-modal');
                    document.getElementById('confirmation-title').textContent = "Pemesanan Berhasil!";
                    document.getElementById('confirmation-message').textContent = `Terima kasih, ${bookingDetails.bookerName}! Pemesanan Anda untuk ${bookingDetails.propertyName} telah dikonfirmasi. Detail konfirmasi telah disimulasikan terkirim ke ${bookingDetails.bookerEmail}.`;
                    document.getElementById('transaction-id').textContent = transactionId;
                    openModal('booking-confirmation-modal');

                    // Notify manager
                    addNotification(`Pemesanan baru untuk ${prop.nama} oleh ${bookingDetails.bookerName}.`, prop.idPemilik);
                    // Notify tenant (simulated)
                    addNotification(`Pemesanan Anda untuk ${prop.nama} berhasil dikonfirmasi.`, bookingDetails.bookerEmail, true); // email as recipient id for simulation

                    renderCurrentPage(); // Re-render current page if it was listings or dashboard
                } else {
                    console.error("Pembayaran gagal.");
                    alert("Pembayaran gagal. Silakan coba lagi atau gunakan metode pembayaran lain.");
                }
            }, 1500); // Simulate 1.5 second delay
        }
        document.getElementById('booking-form').addEventListener('submit', handleBookingSubmit);


        function renderDashboardPage() {
            if (AppState.currentUser.role !== 'manager') {
                routerView.innerHTML = `<p>Akses ditolak. Halaman ini hanya untuk manager.</p>`;
                return;
            }
            routerView.innerHTML = templates.dashboard.innerHTML;

            const totalProperties = AppState.properties.length;
            const availableProperties = AppState.properties.filter(p => p.ketersediaan).length;
            const estimatedRevenue = AppState.properties
                .filter(p => !p.ketersediaan) // Rented properties
                .reduce((sum, p) => sum + p.harga, 0);

            document.getElementById('dashboard-total-properties').textContent = totalProperties;
            document.getElementById('dashboard-available-properties').textContent = availableProperties;
            document.getElementById('dashboard-estimated-revenue').textContent = `Rp ${formatCurrency(estimatedRevenue)}`;

            const propertyListContainer = document.getElementById('dashboard-property-list');
            propertyListContainer.innerHTML = ''; // Clear
            AppState.properties.forEach(prop => {
                // Hanya tampilkan properti milik manager yang login (jika ada multiple manager)
                if (prop.idPemilik === AppState.currentUser.id) {
                    const itemTemplate = templates.dashboardPropertyItem.innerHTML;
                    const itemHTML = itemTemplate
                        .replace(/{id}/g, prop.id)
                        .replace('{nama}', prop.nama)
                        .replace('{lokasi}', prop.lokasi)
                        .replace('{harga}', formatCurrency(prop.harga))
                        .replace('{ketersediaan}', prop.ketersediaan)
                        .replace('{statusKetersediaan}', prop.ketersediaan ? 'Tersedia' : 'Disewa')
                        .replace('{tombolAksiKetersediaan}', prop.ketersediaan ? 'Tandai Disewa' : 'Tandai Tersedia');

                    const itemElement = document.createElement('div');
                    itemElement.innerHTML = itemHTML;
                    propertyListContainer.appendChild(itemElement.firstElementChild);
                }
            });

            propertyListContainer.querySelectorAll('.toggle-availability-btn').forEach(btn => {
                btn.addEventListener('click', () => togglePropertyAvailability(btn.dataset.id));
            });
        }

        function togglePropertyAvailability(propertyId) {
            const prop = AppState.properties.find(p => p.id === propertyId);
            if (prop && prop.idPemilik === AppState.currentUser.id) {
                prop.ketersediaan = !prop.ketersediaan;
                addNotification(`Status properti ${prop.nama} diubah menjadi ${prop.ketersediaan ? 'Tersedia' : 'Disewa'}.`, AppState.currentUser.id);
                renderDashboardPage(); // Re-render dashboard
                // If listings page is active and displayed this property, it should ideally update too.
                // For simplicity, we only re-render dashboard. A more robust solution might use custom events.
            }
        }

        function renderNotificationsList() {
            const listContainer = document.getElementById('notifications-list');
            listContainer.innerHTML = '';
            const userNotifications = AppState.notifications.filter(n => n.recipient === AppState.currentUser.id || n.recipient === 'all');

            if (userNotifications.length === 0) {
                listContainer.innerHTML = '<p>Tidak ada notifikasi baru.</p>';
                document.getElementById('mark-all-read-btn').style.display = 'none';
                return;
            }
            document.getElementById('mark-all-read-btn').style.display = 'block';

            userNotifications.forEach(notif => {
                const item = document.createElement('div');
                item.classList.add('notification-item');
                if (!notif.read) item.classList.add('unread');
                item.innerHTML = `
                    <p>${notif.message}</p>
                    <small>${new Date(notif.timestamp).toLocaleString('id-ID')}</small>
                `;
                item.addEventListener('click', () => {
                    notif.read = true;
                    renderNotificationsList(); // Re-render list
                    updateNotificationBadge(); // Update badge count
                });
                listContainer.appendChild(item);
            });
        }

        document.getElementById('mark-all-read-btn').addEventListener('click', () => {
            AppState.notifications.forEach(n => {
                if (n.recipient === AppState.currentUser.id || n.recipient === 'all') {
                    n.read = true;
                }
            });
            renderNotificationsList();
            updateNotificationBadge();
        });

        notificationsButton.addEventListener('click', () => {
            openModal('notifications-modal');
        });


        // --- Routing ---
        const routes = {
            'home': renderHomePage,
            'listings': renderListingsPage,
            'dashboard': renderDashboardPage,
            // 'property': (id) => showPropertyDetail(id) // For direct URL access, more complex
        };

        function navigateTo(path) {
            // Basic hash-based routing
            window.location.hash = path;
        }

        function renderCurrentPage() {
            let path = window.location.hash.substring(1) || 'home';
            // Handle potential parameters like #property/prop1 later if needed
            // For now, just simple paths
            if (routes[path]) {
                AppState.currentPage = path;
                routes[path]();
                // Update active nav link (simple visual feedback)
                document.querySelectorAll('nav a').forEach(a => {
                    a.style.fontWeight = (a.getAttribute('href') === `#${path}`) ? 'bold' : 'normal';
                    a.style.textDecoration = (a.getAttribute('href') === `#${path}`) ? 'underline' : 'none';

                });
            } else {
                routerView.innerHTML = `<p>Halaman tidak ditemukan.</p>`;
            }
        }

        window.addEventListener('hashchange', renderCurrentPage);
        document.querySelectorAll('[data-route]').forEach(element => {
            element.addEventListener('click', (e) => {
                const targetRoute = e.currentTarget.dataset.route;
                if (targetRoute) {
                    e.preventDefault();
                    navigateTo(targetRoute);
                }
            });
        });


        // --- Theme Toggle ---
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('greenValleyTheme', theme);
            themeToggleButton.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåì';
        }

        themeToggleButton.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        });


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set current year in footer
            currentYearSpan.textContent = new Date().getFullYear();

            // Load saved theme or default to light
            const savedTheme = localStorage.getItem('greenValleyTheme') || 'light';
            applyTheme(savedTheme);

            // Initial page load
            renderCurrentPage();
            updateNotificationBadge(); // Initial badge count

            // Simulate initial notification for manager
            if (AppState.currentUser.role === 'manager') {
                addNotification("Selamat datang kembali di Dashboard Manager!", AppState.currentUser.id);
            }

            console.log("Aplikasi Green Valley SPA berhasil dimuat.");
        });

    </script>

</body>

</html>