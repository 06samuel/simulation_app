<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè°</text></svg>">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description"
        content="Aplikasi web untuk menemukan dan menyewa hunian impian Anda di Green Valley. Dilengkapi dengan dashboard untuk pemilik properti." />
    <title>Green Valley Rentals</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            light: '#4ade80', // green-400
                            DEFAULT: '#22c55e', // green-500
                            dark: '#16a34a',  // green-600
                        },
                        secondary: {
                            light: '#f3f4f6', // gray-100
                            DEFAULT: '#e5e7eb', // gray-200
                            dark: '#d1d5db',   // gray-300
                        },
                        accent: '#f97316', // orange-500
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-in-up': 'slideInUp 0.5s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideInUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
        }

        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            transform: translateY(0);
            opacity: 1;
        }

        .dark .modal-content {
            background-color: #1f2937;
            /* slate-800 */
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #22c55e;
            /* primary-DEFAULT */
            animation: spin 1s ease infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.1.0",
    "react-dom/": "https://esm.sh/react-dom@^19.1.0/",
    "react-router-dom": "https://esm.sh/react-router-dom@^7.6.1",
    "react/": "https://esm.sh/react@^19.1.0/"
  }
}
</script>
</head>

<body class="bg-secondary-light dark:bg-slate-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">
    <noscript>You need to enable JavaScript to run this app.</noscript>

    <div id="app-container" class="flex flex-col min-h-screen">
        <!-- Header -->
        <header id="app-header" class="bg-white dark:bg-slate-800 shadow-md sticky top-0 z-40">
            <!-- Header content will be rendered by JavaScript -->
        </header>

        <!-- Main Content Area -->
        <main id="app-main" class="flex-grow">
            <section id="page-home" class="page-content animate-fade-in">
                <!-- HomePage content will be rendered by JavaScript -->
            </section>
            <section id="page-properti" class="page-content animate-fade-in">
                <!-- PropertyListPage content will be rendered by JavaScript -->
            </section>
            <section id="page-dashboard" class="page-content animate-fade-in">
                <!-- DashboardPage content will be rendered by JavaScript -->
            </section>
        </main>

        <!-- Footer -->
        <footer id="app-footer"
            class="bg-gray-100 dark:bg-slate-800 border-t dark:border-slate-700 text-center p-6 mt-auto">
            <p class="text-sm text-gray-600 dark:text-gray-400">&copy; <span id="current-year"></span> Green Valley
                Rentals. Semua Hak Cipta Dilindungi.</p>
            <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">Dirancang dengan ‚ù§Ô∏è untuk pengalaman terbaik Anda.
            </p>
        </footer>

        <!-- Modals -->
        <div id="property-detail-modal" class="modal-overlay animate-fade-in" style="display: none;">
            <div id="property-detail-modal-content"
                class="modal-content animate-slide-in-up max-w-xl max-h-[90vh] overflow-y-auto">
                <!-- Property Detail Modal content will be rendered by JavaScript -->
            </div>
        </div>

        <div id="booking-form-modal" class="modal-overlay animate-fade-in" style="display: none;">
            <div id="booking-form-modal-content" class="modal-content animate-slide-in-up max-w-md">
                <!-- Booking Form Modal content will be rendered by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // --- START OF INLINED SCRIPT ---

        // --- Constants & Mock Data ---
        const UserRole = {
            TENANT: 'tenant',
            OWNER: 'owner',
            GUEST: 'guest'
        };

        const MOCK_USERS = [
            { id: 'user1', name: 'Budi Tenant', email: 'budi@example.com', role: UserRole.TENANT },
            { id: 'user2', name: 'Citra Owner', email: 'citra@example.com', role: UserRole.OWNER },
            { id: 'user3', name: 'Dewi Tenant', email: 'dewi@example.com', role: UserRole.TENANT },
        ];

        let MOCK_PROPERTIES = [ // Made 'let' to allow adding to it if needed in future, though not used in current spec
            {
                id: 'prop1',
                name: 'Apartemen Modern Pusat Kota',
                type: 'Apartemen',
                location: 'Jakarta Pusat',
                pricePerNight: 750000,
                description: 'Apartemen modern dengan 2 kamar tidur di jantung kota Jakarta. Akses mudah ke pusat perbelanjaan dan transportasi publik.',
                amenities: ['WiFi', 'AC', 'Kolam Renang', 'Gym', 'Parkir'],
                imageUrl: 'https://picsum.photos/seed/prop1/600/400',
                ownerId: 'user2',
                bedrooms: 2,
                bathrooms: 1,
                sqft: 70,
                rating: 4.8,
                reviews: 120,
            },
            {
                id: 'prop2',
                name: 'Villa Asri dengan Pemandangan Gunung',
                type: 'Villa',
                location: 'Bogor',
                pricePerNight: 1500000,
                description: 'Villa luas dengan 4 kamar tidur, kolam renang pribadi, dan pemandangan gunung yang menakjubkan. Cocok untuk liburan keluarga.',
                amenities: ['WiFi', 'AC', 'Kolam Renang Pribadi', 'Dapur Lengkap', 'Taman Luas', 'BBQ Area'],
                imageUrl: 'https://picsum.photos/seed/prop2/600/400',
                ownerId: 'user2',
                bedrooms: 4,
                bathrooms: 3,
                sqft: 250,
                rating: 4.9,
                reviews: 85,
            },
            {
                id: 'prop3',
                name: 'Rumah Nyaman Dekat Pantai',
                type: 'Rumah',
                location: 'Bali',
                pricePerNight: 1200000,
                description: 'Rumah tradisional Bali dengan 3 kamar tidur, hanya 5 menit jalan kaki ke pantai. Suasana tenang dan damai.',
                amenities: ['WiFi', 'AC', 'Dapur', 'Taman', 'Dekat Pantai'],
                imageUrl: 'https://picsum.photos/seed/prop3/600/400',
                ownerId: 'user2',
                bedrooms: 3,
                bathrooms: 2,
                sqft: 150,
                rating: 4.7,
                reviews: 95,
            },
            {
                id: 'prop4',
                name: 'Apartemen Studio Minimalis',
                type: 'Apartemen',
                location: 'Surabaya',
                pricePerNight: 450000,
                description: 'Studio apartemen yang bersih dan minimalis, cocok untuk pelancong solo atau pasangan. Lokasi strategis.',
                amenities: ['WiFi', 'AC', 'Dapur Mini', 'Smart TV'],
                imageUrl: 'https://picsum.photos/seed/prop4/600/400',
                ownerId: 'user2',
                bedrooms: 1,
                bathrooms: 1,
                sqft: 35,
                rating: 4.5,
                reviews: 60,
            }
        ];

        let MOCK_BOOKINGS = [
            {
                id: 'book1',
                propertyId: 'prop1',
                propertyName: 'Apartemen Modern Pusat Kota',
                userId: 'user1',
                startDate: '2024-08-01',
                endDate: '2024-08-05',
                totalPrice: 3000000,
                status: 'Dikonfirmasi',
                bookedAt: '2024-07-15T10:00:00Z',
            },
            {
                id: 'book2',
                propertyId: 'prop2',
                propertyName: 'Villa Asri dengan Pemandangan Gunung',
                userId: 'user3',
                startDate: '2024-09-10',
                endDate: '2024-09-15',
                totalPrice: 7500000,
                status: 'Dipesan',
                bookedAt: '2024-07-20T14:30:00Z',
            },
        ];

        let MOCK_NOTIFICATIONS = [
            { id: 'notif1', userId: 'user1', message: 'Booking Anda untuk Apartemen Modern Pusat Kota telah dikonfirmasi!', timestamp: new Date(Date.now() - 3600000 * 2).toISOString(), read: false, link: '#/dashboard?tab=bookings' },
            { id: 'notif2', userId: 'user2', message: 'Ada booking baru untuk Villa Asri Pemandangan Gunung.', timestamp: new Date(Date.now() - 3600000 * 5).toISOString(), read: true, link: '#/dashboard?tab=bookings' },
            { id: 'notif3', userId: 'user1', message: 'Jangan lupa review penginapan Anda sebelumnya!', timestamp: new Date(Date.now() - 3600000 * 24).toISOString(), read: true },
        ];

        // --- Icon Functions ---
        const Icons = {
            Home: (classes = "w-5 h-5") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${classes}"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955a1.5 1.5 0 012.122 0l8.954 8.955M2.25 12l8.954-8.955a1.5 1.5 0 012.122 0l8.954 8.955M2.25 12v9a1.5 1.5 0 001.5 1.5h15.001a1.5 1.5 0 001.5-1.5v-9M2.25 12h19.5" /></svg>`,
            BuildingOffice: (classes = "w-5 h-5") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${classes}"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h6.375a.375.375 0 01.375.375v1.5a.375.375 0 01-.375.375H9a.375.375 0 01-.375-.375v-1.5A.375.375 0 019 6.75zM9 12.75h6.375a.375.375 0 01.375.375v1.5a.375.375 0 01-.375.375H9a.375.375 0 01-.375-.375v-1.5A.375.375 0 019 12.75z" /></svg>`,
            UserCircle: (classes = "w-7 h-7") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${classes}"><path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" /></svg>`,
            Sun: (classes = "w-6 h-6") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${classes}"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-6.364-.386l1.591-1.591M3 12h2.25m.386-6.364l1.591 1.591M12 12a3.75 3.75 0 100 7.5 3.75 3.75 0 000-7.5z" /></svg>`,
            Moon: (classes = "w-6 h-6") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${classes}"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>`,
            Bell: (classes = "w-6 h-6") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${classes}"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>`,
            XMark: (classes = "w-6 h-6") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${classes}"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`,
            MapPin: (classes = "w-4 h-4") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${classes}"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" /></svg>`,
            Star: (classes = "w-4 h-4", fill = "currentColor") => `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${fill}" class="${classes}"><path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354l-4.557 2.403c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.007z" clip-rule="evenodd" /></svg>`,
            CreditCard: (classes = "w-5 h-5") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${classes}"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5z" /></svg>`,
            CalendarDays: (classes = "w-4 h-4") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${classes}"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5m-9-3.75h.008v.008H12v-.008zM12 15h.008v.008H12V15zm0 2.25h.008v.008H12v-.008zM9.75 15h.008v.008H9.75V15zm0 2.25h.008v.008H9.75v-.008zM7.5 15h.008v.008H7.5V15zm0 2.25h.008v.008H7.5v-.008zm6.75-4.5h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V15zm0 2.25h.008v.008h-.008v-.008zm2.25-4.5h.008v.008H16.5v-.008zm0 2.25h.008v.008H16.5V15z" /></svg>`,
            Bed: (classes = "w-6 h-6") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${classes}"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10.5 11.25h3M12 3.75v.007c0 .007 0 .014-.002.021a2.24 2.24 0 00-.002.021v.007c0 .007 0 .014-.002.021a2.24 2.24 0 00-.002.021v.007c0 .007 0 .014-.002.021a2.24 2.24 0 00-.002.021v.007M12 3.75c0 .007.002.014.002.021a2.24 2.24 0 01.002.021v.007c0 .007.002.014.002.021a2.24 2.24 0 01.002.021v.007c0 .007.002.014.002.021a2.24 2.24 0 01.002.021v.007M5.25 7.5h13.5" /></svg>`,
            Bath: (classes = "w-6 h-6") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${classes}"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 15.75V18m-7.5-6.75h.008v.008H8.25v-.008zm0 3h.008v.008H8.25v-.008zm0 3h.008v.008H8.25V18m0-3.75h.008v.008H8.25v-.008zm0 3h.008v.008H8.25V15m0 3H12m0 0V9M4.5 9H12m0 0V6.75M12 9v6.75m0-6.75h7.5V6.75M12 9H4.5" /></svg>`,
            ArrowsPointingOut: (classes = "w-6 h-6") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${classes}"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75v4.5m0-4.5h-4.5m4.5 0L15 9M20.25 20.25v-4.5m0 4.5h-4.5m4.5 0L15 15" /></svg>`,
            CheckCircle: (classes = "w-4 h-4") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${classes}"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
            ExclamationCircle: (classes = "w-12 h-12") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${classes}"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" /></svg>`,
        };

        // --- Global State ---
        let appState = {
            currentTheme: localStorage.getItem('theme') || 'light',
            currentUser: null,
            activePage: 'home',
            activeDashboardTab: 'bookings',
            selectedPropertyIdForModal: null,
            propertyForBookingModal: null,
            notifications: [],
            unreadNotificationCount: 0,
            showUserMenu: false,
            showNotifMenu: false,
            bookingFormStep: 1,
            bookingFormData: {
                startDate: '',
                endDate: '',
                totalPrice: 0,
                paymentDetails: { cardNumber: '', expiryDate: '', cvv: '', cardHolderName: '' }
            },
            bookingError: '',
            isLoading: false,
        };

        // --- Services (Simulated) ---
        const propertyService = {
            getProperties: async (filters) => {
                await new Promise(resolve => setTimeout(resolve, 300));
                let properties = MOCK_PROPERTIES;
                if (filters?.location) {
                    properties = properties.filter(p => p.location.toLowerCase().includes(filters.location.toLowerCase()));
                }
                if (filters?.type) {
                    properties = properties.filter(p => p.type === filters.type);
                }
                return properties;
            },
            getPropertyById: async (id) => {
                await new Promise(resolve => setTimeout(resolve, 200));
                return MOCK_PROPERTIES.find(p => p.id === id);
            },
            getPropertiesByOwner: async (ownerId) => {
                await new Promise(resolve => setTimeout(resolve, 300));
                return MOCK_PROPERTIES.filter(p => p.ownerId === ownerId);
            }
        };

        const bookingService = {
            createBooking: async (bookingData) => {
                await new Promise(resolve => setTimeout(resolve, 700));
                const newBooking = {
                    ...bookingData,
                    id: `book${Date.now()}`,
                    status: 'Dipesan',
                    bookedAt: new Date().toISOString(),
                };
                MOCK_BOOKINGS.push(newBooking);
                const property = MOCK_PROPERTIES.find(p => p.id === newBooking.propertyId);
                if (property) {
                    notificationService.createNotification({
                        userId: property.ownerId,
                        message: `Booking baru untuk ${property.name} dari ${MOCK_USERS.find(u => u.id === newBooking.userId)?.name || 'Pengguna'}.`,
                        link: `#/dashboard?tab=bookings&bookingId=${newBooking.id}`
                    });
                }
                return newBooking;
            },
            getBookingsByUser: async (userId) => {
                await new Promise(resolve => setTimeout(resolve, 300));
                return MOCK_BOOKINGS.filter(b => b.userId === userId).sort((a, b) => new Date(b.bookedAt).getTime() - new Date(a.bookedAt).getTime());
            },
            getBookingsForOwnerProperties: async (ownerId) => {
                await new Promise(resolve => setTimeout(resolve, 300));
                const ownerProperties = MOCK_PROPERTIES.filter(p => p.ownerId === ownerId).map(p => p.id);
                return MOCK_BOOKINGS.filter(b => ownerProperties.includes(b.propertyId)).sort((a, b) => new Date(b.bookedAt).getTime() - new Date(a.bookedAt).getTime());
            }
        };

        const notificationService = {
            getNotifications: async (userId) => {
                await new Promise(resolve => setTimeout(resolve, 100));
                return MOCK_NOTIFICATIONS.filter(n => n.userId === userId).sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());
            },
            createNotification: async (data) => {
                await new Promise(resolve => setTimeout(resolve, 50));
                const newNotif = {
                    ...data,
                    id: `notif${Date.now()}`,
                    timestamp: new Date().toISOString(),
                    read: false,
                };
                MOCK_NOTIFICATIONS.unshift(newNotif); // Add to beginning for recent first
                if (appState.currentUser && newNotif.userId === appState.currentUser.id) {
                    fetchAndUpdateNotifications(); // Update UI if it's for current user
                }
                return newNotif;
            },
            markAsRead: async (notificationId) => {
                await new Promise(resolve => setTimeout(resolve, 50));
                const notification = MOCK_NOTIFICATIONS.find(n => n.id === notificationId);
                if (notification) {
                    notification.read = true;
                    return true;
                }
                return false;
            }
        };

        // --- Helper Functions ---
        function _el(selector) { return document.querySelector(selector); }
        function _els(selector) { return document.querySelectorAll(selector); }
        function showSpinner(containerSelector) {
            const container = _el(containerSelector);
            if (container) container.innerHTML = '<div class="spinner"></div>';
        }
        function hideSpinner(containerSelector) {
            const container = _el(containerSelector);
            const spinner = container?.querySelector('.spinner');
            if (spinner) spinner.remove();
        }
        function setLoadingState(isLoading) {
            appState.isLoading = isLoading;
            // Could add a global spinner or disable buttons here
        }
        function formatPrice(price) {
            return `Rp ${price.toLocaleString('id-ID')}`;
        }
        function formatDate(dateString, options = { year: 'numeric', month: 'long', day: 'numeric' }) {
            return new Date(dateString).toLocaleDateString('id-ID', options);
        }
        function showMessage(containerSelector, message, type = 'info') {
            const container = _el(containerSelector);
            if (!container) return;
            let bgColor, textColor, borderColor;
            switch (type) {
                case 'error':
                    bgColor = 'bg-red-100 dark:bg-red-900';
                    textColor = 'text-red-700 dark:text-red-300';
                    borderColor = 'border-red-500';
                    break;
                case 'success':
                    bgColor = 'bg-green-100 dark:bg-green-900';
                    textColor = 'text-green-700 dark:text-green-300';
                    borderColor = 'border-green-500';
                    break;
                default: // info
                    bgColor = 'bg-blue-100 dark:bg-blue-900';
                    textColor = 'text-blue-700 dark:text-blue-300';
                    borderColor = 'border-blue-500';
            }
            container.innerHTML = `<div class="${bgColor} ${textColor} p-3 rounded-md border ${borderColor}">${message}</div>`;
        }


        // --- Theme Management ---
        function applyTheme() {
            if (appState.currentTheme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            localStorage.setItem('theme', appState.currentTheme);
            renderHeader(); // Re-render header to update theme icon
        }

        function toggleTheme() {
            appState.currentTheme = appState.currentTheme === 'light' ? 'dark' : 'light';
            applyTheme();
        }

        // --- Auth Management ---
        function login(userId) {
            const user = MOCK_USERS.find(u => u.id === userId);
            if (user) {
                appState.currentUser = user;
                localStorage.setItem('currentUser', userId);
                appState.showUserMenu = false;
                fetchAndUpdateNotifications();
                renderHeader();
                // Potentially navigate or refresh current page if needed
                if (window.location.hash.startsWith('#/dashboard') || appState.activePage === 'dashboard') {
                    handleRouteChange(); // Re-evaluate dashboard page
                }
            }
        }

        function logout() {
            appState.currentUser = null;
            localStorage.removeItem('currentUser');
            appState.showUserMenu = false;
            appState.notifications = [];
            appState.unreadNotificationCount = 0;
            renderHeader();
            window.location.hash = '#/'; // Navigate to home
        }

        function loadCurrentUser() {
            const storedUserId = localStorage.getItem('currentUser');
            if (storedUserId) {
                const user = MOCK_USERS.find(u => u.id === storedUserId);
                if (user) appState.currentUser = user;
            }
        }

        // --- Notification Menu Updates ---
        async function fetchAndUpdateNotifications() {
            if (appState.currentUser) {
                const notifs = await notificationService.getNotifications(appState.currentUser.id);
                appState.notifications = notifs;
                appState.unreadNotificationCount = notifs.filter(n => !n.read).length;
                if (appState.showNotifMenu) { // If menu is open, re-render it
                    renderNotificationDropdown();
                }
                renderHeader(); // To update bell icon badge
            } else {
                appState.notifications = [];
                appState.unreadNotificationCount = 0;
                if (appState.showNotifMenu) renderNotificationDropdown();
                renderHeader();
            }
        }


        // --- Rendering Functions ---

        // Header
        function renderHeader() {
            const header = _el('#app-header');
            if (!header) return;

            let userMenuHTML = '';
            if (appState.showUserMenu) {
                if (appState.currentUser) {
                    userMenuHTML = `
                    <div class="absolute right-0 mt-2 w-48 bg-white dark:bg-slate-700 rounded-md shadow-lg py-1 z-50 border dark:border-slate-600">
                        <div class="px-4 py-2 text-sm text-gray-700 dark:text-gray-200 border-b dark:border-slate-600">
                            Hai, <span class="font-medium">${appState.currentUser.name}</span>
                            <br/>
                            <span class="text-xs text-gray-500 dark:text-gray-400">(${appState.currentUser.role})</span>
                        </div>
                        <a href="#/dashboard" data-action="close-user-menu" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-600">Dashboard</a>
                        <button data-action="logout" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-600">Logout</button>
                    </div>
                `;
                } else {
                    userMenuHTML = `
                    <div class="absolute right-0 mt-2 w-56 bg-white dark:bg-slate-700 rounded-md shadow-lg py-1 z-50 border dark:border-slate-600">
                        <button data-action="login-tenant" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-600">Login sebagai Tenant (Budi)</button>
                        <button data-action="login-owner" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-600">Login sebagai Owner (Citra)</button>
                    </div>
                `;
                }
            }

            header.innerHTML = `
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <a href="#/" class="text-2xl font-bold text-primary-DEFAULT dark:text-primary-light flex items-center">
                    üè° GreenValley
                </a>
                <nav class="hidden md:flex items-center space-x-6">
                    <a href="#/" class="nav-link text-gray-600 dark:text-gray-300 hover:text-primary-DEFAULT dark:hover:text-primary-light transition-colors flex items-center">${Icons.Home("w-5 h-5 mr-1")}Beranda</a>
                    <a href="#/properti" class="nav-link text-gray-600 dark:text-gray-300 hover:text-primary-DEFAULT dark:hover:text-primary-light transition-colors flex items-center">${Icons.BuildingOffice("w-5 h-5 mr-1")}Properti</a>
                    ${appState.currentUser ? `<a href="#/dashboard" class="nav-link text-gray-600 dark:text-gray-300 hover:text-primary-DEFAULT dark:hover:text-primary-light transition-colors flex items-center">${Icons.UserCircle("w-5 h-5 mr-1")}Dashboard</a>` : ''}
                </nav>
                <div class="flex items-center space-x-3">
                    <button data-action="toggle-theme" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors" aria-label="Toggle theme">
                        ${appState.currentTheme === 'light' ? Icons.Moon("w-6 h-6 text-gray-600 dark:text-gray-300") : Icons.Sun("w-6 h-6 text-gray-600 dark:text-gray-300")}
                    </button>
                    
                    ${appState.currentUser ? `
                    <div class="relative">
                        <button data-action="toggle-notif-menu" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors relative" aria-label="Notifications">
                            ${Icons.Bell("w-6 h-6 text-gray-600 dark:text-gray-300")}
                            ${appState.unreadNotificationCount > 0 ? `<span class="absolute top-0 right-0 block h-2 w-2 rounded-full ring-2 ring-white dark:ring-slate-800 bg-red-500"></span>` : ''}
                        </button>
                        <div id="notification-dropdown-container">
                           ${appState.showNotifMenu ? renderNotificationDropdownHTML() : ''}
                        </div>
                    </div>` : ''}

                    <div class="relative">
                        <button data-action="toggle-user-menu" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors" aria-label="User menu">
                            ${Icons.UserCircle("w-7 h-7 text-gray-600 dark:text-gray-300")}
                        </button>
                        ${userMenuHTML}
                    </div>
                </div>
            </div>
        `;
            updateActiveNavLinks();
        }

        function renderNotificationDropdownHTML() {
            let notificationsHTML = '';
            const displayNotifications = appState.notifications.slice(0, 5);

            if (displayNotifications.length === 0) {
                notificationsHTML = `<p class="px-3 py-2 text-xs text-gray-500 dark:text-gray-400">Tidak ada notifikasi.</p>`;
            } else {
                notificationsHTML = displayNotifications.map(n => `
                <div data-notif-id="${n.id}" data-notif-link="${n.link || ''}" class="notification-item block px-3 py-2 text-sm cursor-pointer ${n.read ? 'text-gray-600 dark:text-gray-400' : 'text-primary-dark dark:text-primary-light font-medium'} hover:bg-gray-100 dark:hover:bg-slate-600">
                    <p class="truncate">${n.message}</p>
                    <p class="text-xs text-gray-400 dark:text-gray-500">${new Date(n.timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}</p>
                </div>
            `).join('');
            }

            return `
            <div class="absolute right-0 mt-2 w-80 bg-white dark:bg-slate-700 rounded-md shadow-lg py-1 z-50 border dark:border-slate-600 max-h-96 overflow-y-auto">
                <div class="px-3 py-2 font-semibold text-sm text-gray-800 dark:text-gray-100">Notifikasi</div>
                ${notificationsHTML}
                ${appState.notifications.length > 0 ? `<a href="#/dashboard?tab=notifications" data-action="close-notif-menu" class="block text-center px-3 py-2 text-sm text-primary-DEFAULT hover:underline">Lihat semua</a>` : ''}
            </div>
        `;
        }

        function renderNotificationDropdown() { // Renders directly into placeholder
            const container = _el('#notification-dropdown-container');
            if (container) {
                container.innerHTML = appState.showNotifMenu ? renderNotificationDropdownHTML() : '';
            }
        }


        // Property Card
        function createPropertyCardHTML(property) {
            return `
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg overflow-hidden transform hover:scale-105 transition-transform duration-300 flex flex-col">
          <img src="${property.imageUrl}" alt="${property.name}" class="w-full h-48 object-cover"/>
          <div class="p-4 flex flex-col flex-grow">
            <h3 class="text-lg font-semibold text-primary-dark dark:text-primary-light mb-1 truncate" title="${property.name}">${property.name}</h3>
            <div class="flex items-center text-sm text-gray-600 dark:text-gray-400 mb-2">
              ${Icons.MapPin("w-4 h-4 mr-1 text-gray-500 dark:text-gray-400")}
              ${property.location}
            </div>
            <div class="flex items-center text-sm text-gray-600 dark:text-gray-400 mb-2">
              <span class="font-semibold text-primary-DEFAULT dark:text-primary-light mr-1">
                ${formatPrice(property.pricePerNight)}
              </span> / malam
            </div>
            <div class="flex items-center text-sm text-yellow-500 mb-3">
              ${Icons.Star("w-4 h-4 mr-1")} ${property.rating} (${property.reviews} reviews)
            </div>
            <p class="text-xs text-gray-600 dark:text-gray-400 mb-3 line-clamp-2">${property.description}</p>
            <div class="mt-auto">
                <button 
                    data-action="open-property-detail" data-property-id="${property.id}"
                    class="w-full bg-primary-DEFAULT hover:bg-primary-dark text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200 text-sm"
                >
                    Lihat Detail
                </button>
            </div>
          </div>
        </div>
      `;
        }

        // HomePage
        async function renderHomePage() {
            const pageContainer = _el('#page-home');
            if (!pageContainer) return;

            pageContainer.innerHTML = `
            <section class="bg-gradient-to-r from-primary-light via-primary-DEFAULT to-primary-dark dark:from-green-700 dark:via-green-800 dark:to-green-900 text-white py-20 px-4 text-center">
                <h1 class="text-4xl md:text-5xl font-bold mb-4 animate-slide-in-up">Temukan Hunian Impianmu</h1>
                <p class="text-lg md:text-xl mb-8 animate-slide-in-up" style="animation-delay: '0.2s'">Jelajahi berbagai pilihan apartemen, rumah, dan villa terbaik di Green Valley.</p>
                <div class="max-w-xl mx-auto animate-slide-in-up" style="animation-delay: '0.4s'">
                    <form id="home-search-form" class="flex flex-col sm:flex-row gap-2">
                        <input 
                            type="text" 
                            name="location"
                            id="home-search-location"
                            placeholder="Cari berdasarkan lokasi (mis: Jakarta, Bogor)" 
                            class="flex-grow p-3 rounded-lg text-gray-800 focus:ring-2 focus:ring-accent focus:outline-none" 
                            aria-label="Lokasi pencarian"
                        />
                        <button type="submit" class="bg-accent hover:bg-orange-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                            Cari
                        </button>
                    </form>
                </div>
            </section>
            <section class="py-16 px-4">
                <h2 class="text-3xl font-semibold text-center mb-10 text-gray-800 dark:text-gray-100">Properti Unggulan</h2>
                <div id="featured-properties-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 max-w-6xl mx-auto">
                    <!-- Property cards will be loaded here -->
                </div>
                <div id="featured-properties-message" class="text-center text-gray-600 dark:text-gray-400"></div>
                <div class="text-center mt-12">
                    <a href="#/properti" class="bg-primary-DEFAULT hover:bg-primary-dark text-white font-semibold py-3 px-8 rounded-lg transition-colors text-lg">
                        Lihat Semua Properti
                    </a>
                </div>
            </section>
        `;

            showSpinner('#featured-properties-container');
            try {
                const allProps = await propertyService.getProperties();
                const featuredProperties = allProps.slice(0, 3);
                hideSpinner('#featured-properties-container');
                const container = _el('#featured-properties-container');
                const messageContainer = _el('#featured-properties-message');
                if (featuredProperties.length > 0) {
                    container.innerHTML = featuredProperties.map(createPropertyCardHTML).join('');
                    messageContainer.innerHTML = '';
                } else {
                    container.innerHTML = '';
                    messageContainer.innerHTML = 'Tidak ada properti unggulan saat ini.';
                }
            } catch (error) {
                console.error("Error fetching featured properties:", error);
                hideSpinner('#featured-properties-container');
                _el('#featured-properties-message').innerHTML = 'Gagal memuat properti unggulan.';
            }
        }

        // PropertyListPage
        async function renderPropertyListPage(initialFilters = {}) {
            const pageContainer = _el('#page-properti');
            if (!pageContainer) return;

            pageContainer.innerHTML = `
            <div class="container mx-auto px-4 py-8">
                <h1 class="text-3xl font-bold mb-8 text-center text-gray-800 dark:text-gray-100">Semua Properti</h1>
                <div class="mb-8 p-4 bg-white dark:bg-slate-800 rounded-lg shadow-md flex flex-col sm:flex-row gap-4 items-center">
                    <input 
                        type="text" 
                        id="property-search-term"
                        placeholder="Cari properti (nama atau lokasi)..." 
                        value="${initialFilters.location || ''}"
                        class="flex-grow p-3 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-slate-700 focus:ring-primary-DEFAULT focus:border-primary-DEFAULT outline-none"
                        aria-label="Istilah pencarian properti"
                    />
                    <select 
                        id="property-filter-type"
                        class="p-3 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-slate-700 focus:ring-primary-DEFAULT focus:border-primary-DEFAULT outline-none min-w-[150px]"
                        aria-label="Filter tipe properti"
                    >
                        <option value="">Semua Tipe</option>
                        <option value="Apartemen" ${initialFilters.type === 'Apartemen' ? 'selected' : ''}>Apartemen</option>
                        <option value="Rumah" ${initialFilters.type === 'Rumah' ? 'selected' : ''}>Rumah</option>
                        <option value="Villa" ${initialFilters.type === 'Villa' ? 'selected' : ''}>Villa</option>
                    </select>
                     <button id="filter-properties-btn" class="bg-primary-DEFAULT hover:bg-primary-dark text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                        Filter
                    </button>
                </div>
                <div id="property-list-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Property list will be loaded here -->
                </div>
                 <div id="property-list-message" class="text-center text-gray-600 dark:text-gray-400 py-10"></div>
            </div>
        `;

            applyFiltersAndRenderProperties();
        }

        async function applyFiltersAndRenderProperties() {
            const searchTerm = _el('#property-search-term').value;
            const filterType = _el('#property-filter-type').value;

            showSpinner('#property-list-container');
            _el('#property-list-message').innerHTML = '';

            try {
                // The service already filters by location and type if provided
                // Client-side filtering for name if service doesn't support it for name specifically
                const properties = await propertyService.getProperties({ location: searchTerm, type: filterType });

                const nameFilteredProperties = properties.filter(prop =>
                    prop.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    prop.location.toLowerCase().includes(searchTerm.toLowerCase()) // Service might already do location, but for robustness
                );

                hideSpinner('#property-list-container');
                const container = _el('#property-list-container');
                const messageContainer = _el('#property-list-message');

                if (nameFilteredProperties.length > 0) {
                    container.innerHTML = nameFilteredProperties.map(createPropertyCardHTML).join('');
                    messageContainer.innerHTML = '';
                } else {
                    container.innerHTML = '';
                    messageContainer.innerHTML = `
                    ${Icons.ExclamationCircle("w-12 h-12 mx-auto mb-4 text-gray-400 dark:text-gray-500")}
                    <p>Tidak ada properti yang sesuai dengan kriteria pencarian Anda.</p>
                `;
                }
            } catch (error) {
                console.error("Error fetching properties:", error);
                hideSpinner('#property-list-container');
                _el('#property-list-message').innerHTML = 'Gagal memuat properti.';
            }
        }

        // Property Detail Modal
        async function openPropertyDetailModal(propertyId) {
            appState.selectedPropertyIdForModal = propertyId;
            const modal = _el('#property-detail-modal');
            const contentContainer = _el('#property-detail-modal-content');
            if (!modal || !contentContainer) return;

            contentContainer.innerHTML = '<div class="spinner"></div>';
            modal.style.display = 'flex';

            try {
                const property = await propertyService.getPropertyById(propertyId);
                if (property) {
                    contentContainer.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100">${property.name}</h2>
                        <button data-action="close-property-detail" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" aria-label="Tutup modal">
                            ${Icons.XMark()}
                        </button>
                    </div>
                    <div class="space-y-4">
                        <img src="${property.imageUrl}" alt="${property.name}" class="w-full h-64 object-cover rounded-lg mb-4"/>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center mb-4">
                            <div class="bg-secondary-DEFAULT dark:bg-slate-700 p-3 rounded-lg">
                                ${Icons.Bed("w-6 h-6 mx-auto mb-1 text-primary-DEFAULT dark:text-primary-light")}
                                <p class="text-sm font-medium">${property.bedrooms} Kamar Tidur</p>
                            </div>
                            <div class="bg-secondary-DEFAULT dark:bg-slate-700 p-3 rounded-lg">
                                ${Icons.Bath("w-6 h-6 mx-auto mb-1 text-primary-DEFAULT dark:text-primary-light")}
                                <p class="text-sm font-medium">${property.bathrooms} Kamar Mandi</p>
                            </div>
                            <div class="bg-secondary-DEFAULT dark:bg-slate-700 p-3 rounded-lg">
                                ${Icons.ArrowsPointingOut("w-6 h-6 mx-auto mb-1 text-primary-DEFAULT dark:text-primary-light")}
                                <p class="text-sm font-medium">${property.sqft} m¬≤</p>
                            </div>
                            <div class="bg-secondary-DEFAULT dark:bg-slate-700 p-3 rounded-lg">
                                ${Icons.Star("w-6 h-6 mx-auto mb-1 text-yellow-500", "currentColor")}
                                <p class="text-sm font-medium">${property.rating}/5 (${property.reviews})</p>
                            </div>
                        </div>
                        <p class="text-gray-700 dark:text-gray-300 leading-relaxed">${property.description}</p>
                        <div>
                            <h4 class="font-semibold text-md mb-2 text-gray-800 dark:text-gray-100">Fasilitas:</h4>
                            <ul class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-sm text-gray-600 dark:text-gray-400">
                                ${property.amenities.map(amenity => `<li class="flex items-center">${Icons.CheckCircle("w-4 h-4 mr-2 text-primary-DEFAULT dark:text-primary-light")} ${amenity}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="text-lg font-bold text-primary-dark dark:text-primary-light mt-4">
                            ${formatPrice(property.pricePerNight)} <span class="text-sm font-normal text-gray-600 dark:text-gray-400">/ malam</span>
                        </div>
                        <div class="mt-4">
                            <h4 class="font-semibold text-md mb-2 text-gray-800 dark:text-gray-100">Lokasi:</h4>
                            <div class="bg-gray-200 dark:bg-slate-700 h-48 rounded-lg flex items-center justify-center">
                                ${Icons.MapPin("w-12 h-12 text-gray-400 dark:text-gray-500")}
                                <p class="ml-2 text-gray-500 dark:text-gray-400">Simulasi Peta untuk ${property.location}</p>
                            </div>
                        </div>
                        <button 
                            data-action="open-booking-form" data-property-id="${property.id}"
                            class="w-full mt-6 bg-accent hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200"
                        >
                            Pesan Sekarang
                        </button>
                    </div>
                `;
                } else {
                    contentContainer.innerHTML = '<p>Properti tidak ditemukan.</p> <button data-action="close-property-detail">Tutup</button>';
                }
            } catch (e) {
                console.error("Error fetching property for modal:", e);
                contentContainer.innerHTML = '<p>Gagal memuat detail properti.</p> <button data-action="close-property-detail">Tutup</button>';
            }
        }

        function closePropertyDetailModal() {
            _el('#property-detail-modal').style.display = 'none';
            appState.selectedPropertyIdForModal = null;
        }

        // Booking Form Modal
        function openBookingFormModal(property) {
            appState.propertyForBookingModal = property;
            appState.bookingFormStep = 1;
            appState.bookingFormData = { startDate: '', endDate: '', totalPrice: 0, paymentDetails: { cardNumber: '', expiryDate: '', cvv: '', cardHolderName: '' } };
            appState.bookingError = '';
            _el('#booking-form-modal').style.display = 'flex';
            renderBookingFormStep();
        }

        function closeBookingFormModal() {
            _el('#booking-form-modal').style.display = 'none';
            appState.propertyForBookingModal = null;
        }

        function renderBookingFormStep() {
            const property = appState.propertyForBookingModal;
            if (!property) return;
            const contentContainer = _el('#booking-form-modal-content');
            const { startDate, endDate, totalPrice, paymentDetails } = appState.bookingFormData;
            let html = '';

            const title = appState.bookingFormStep === 3 ? "Booking Berhasil" : `Pesan ${property.name}`;

            html += `
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100">${title}</h2>
                <button data-action="close-booking-form" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" aria-label="Tutup modal">
                    ${Icons.XMark()}
                </button>
            </div>
        `;
            if (appState.isLoading) {
                html += '<div class="spinner"></div>';
            } else {
                if (appState.bookingError) {
                    html += `<p class="text-red-500 bg-red-100 dark:bg-red-900 dark:text-red-300 p-3 rounded-md mb-4">${appState.bookingError}</p>`;
                }

                if (appState.bookingFormStep === 1) {
                    html += `
                    <form id="booking-step1-form" class="space-y-4">
                        <div>
                            <label for="startDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tanggal Mulai</label>
                            <input type="date" id="startDate" name="startDate" value="${startDate}" min="${new Date().toISOString().split('T')[0]}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-slate-700 shadow-sm focus:border-primary-DEFAULT focus:ring-primary-DEFAULT sm:text-sm p-2" required />
                        </div>
                        <div>
                            <label for="endDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tanggal Selesai</label>
                            <input type="date" id="endDate" name="endDate" value="${endDate}" min="${startDate || new Date().toISOString().split('T')[0]}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-slate-700 shadow-sm focus:border-primary-DEFAULT focus:ring-primary-DEFAULT sm:text-sm p-2" required />
                        </div>
                        ${totalPrice > 0 ? `<p class="text-lg font-semibold text-gray-800 dark:text-gray-100">Total: ${formatPrice(totalPrice)}</p>` : ''}
                        <button type="submit" class="w-full bg-primary-DEFAULT hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg transition-colors">Lanjut ke Pembayaran</button>
                    </form>
                `;
                } else if (appState.bookingFormStep === 2) {
                    html += `
                    <form id="booking-step2-form" class="space-y-4">
                        <p class="text-lg font-semibold">Total Pembayaran: ${formatPrice(totalPrice)}</p>
                        <div class="border dark:border-gray-700 p-4 rounded-lg space-y-3 bg-gray-50 dark:bg-slate-700">
                            <h4 class="font-medium text-md flex items-center">${Icons.CreditCard("w-5 h-5 mr-2 text-primary-DEFAULT")}Detail Kartu Kredit (Simulasi)</h4>
                            <div>
                                <label for="cardHolderName" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Nama Pemegang Kartu</label>
                                <input type="text" id="cardHolderName" name="cardHolderName" value="${paymentDetails.cardHolderName}" placeholder="Nama Lengkap" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-slate-600 shadow-sm focus:border-primary-DEFAULT focus:ring-primary-DEFAULT sm:text-sm p-2" required />
                            </div>
                            <div>
                                <label for="cardNumber" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Nomor Kartu</label>
                                <input type="text" id="cardNumber" name="cardNumber" value="${paymentDetails.cardNumber}" placeholder="0000 0000 0000 0000" maxlength="19" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-slate-600 shadow-sm focus:border-primary-DEFAULT focus:ring-primary-DEFAULT sm:text-sm p-2" required />
                            </div>
                            <div class="flex space-x-2">
                                <div class="flex-1">
                                    <label for="expiryDate" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Tanggal Kedaluwarsa</label>
                                    <input type="text" id="expiryDate" name="expiryDate" value="${paymentDetails.expiryDate}" placeholder="MM/YY" maxlength="5" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-slate-600 shadow-sm focus:border-primary-DEFAULT focus:ring-primary-DEFAULT sm:text-sm p-2" required />
                                </div>
                                <div class="flex-1">
                                    <label for="cvv" class="block text-xs font-medium text-gray-600 dark:text-gray-400">CVV</label>
                                    <input type="text" id="cvv" name="cvv" value="${paymentDetails.cvv}" placeholder="123" maxlength="4" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-slate-600 shadow-sm focus:border-primary-DEFAULT focus:ring-primary-DEFAULT sm:text-sm p-2" required />
                                </div>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button type="button" data-action="booking-prev-step" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors">Kembali</button>
                            <button type="submit" class="flex-1 bg-accent hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Bayar Sekarang</button>
                        </div>
                    </form>
                `;
                } else if (appState.bookingFormStep === 3) {
                    const lastBooking = MOCK_BOOKINGS.length > 0 ? MOCK_BOOKINGS[MOCK_BOOKINGS.length - 1] : null;
                    html += `
                    <div class="text-center space-y-4">
                        ${Icons.CheckCircle("w-16 h-16 text-primary-DEFAULT mx-auto")}
                        <h3 class="text-xl font-semibold">Pemesanan Berhasil!</h3>
                        <p class="text-gray-600 dark:text-gray-400">Terima kasih telah melakukan pemesanan di Green Valley. Konfirmasi telah dikirim ke email Anda (simulasi).</p>
                        ${lastBooking ? `<p class="text-sm">ID Booking: <span class="font-mono bg-gray-200 dark:bg-slate-700 px-1 rounded">${lastBooking.id}</span></p>` : ''}
                        <button data-action="close-booking-form" class="w-full bg-primary-DEFAULT hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg transition-colors">Tutup</button>
                    </div>
                `;
                }
            }
            contentContainer.innerHTML = html;
        }

        function handleBookingDateChange() {
            const property = appState.propertyForBookingModal;
            const startDateVal = _el('#startDate')?.value;
            const endDateVal = _el('#endDate')?.value;

            if (property && startDateVal && endDateVal) {
                appState.bookingFormData.startDate = startDateVal;
                appState.bookingFormData.endDate = endDateVal;
                const start = new Date(startDateVal);
                const end = new Date(endDateVal);
                if (end > start) {
                    const nights = Math.ceil((end.getTime() - start.getTime()) / (1000 * 3600 * 24));
                    appState.bookingFormData.totalPrice = nights * property.pricePerNight;
                    appState.bookingError = '';
                } else {
                    appState.bookingFormData.totalPrice = 0;
                    appState.bookingError = 'Tanggal Selesai harus setelah Tanggal Mulai.';
                }
            } else {
                appState.bookingFormData.totalPrice = 0;
            }
            // Re-render only price part or the whole step1 if simpler
            if (appState.bookingFormStep === 1) renderBookingFormStep();
        }

        // Dashboard Page
        function renderDashboardPage(initialTab = '') {
            const pageContainer = _el('#page-dashboard');
            if (!pageContainer) return;
            if (!appState.currentUser) {
                pageContainer.innerHTML = `
                <div class="text-center p-8">
                    <p class="text-xl">Silakan login untuk mengakses dashboard.</p>
                    <button data-action="show-login-options" class="mt-4 bg-primary-DEFAULT hover:bg-primary-dark text-white font-semibold py-2 px-4 rounded-lg">Login</button>
                </div>`;
                return;
            }

            const queryParams = new URLSearchParams(window.location.hash.split('?')[1] || '');
            let targetTab = initialTab || queryParams.get('tab') || appState.activeDashboardTab;

            // Role-based default tab if current targetTab is invalid for role
            const validTenantTabs = ['bookings', 'notifications'];
            const validOwnerTabs = ['properties', 'bookings', 'revenue', 'notifications'];

            if (appState.currentUser.role === UserRole.TENANT && !validTenantTabs.includes(targetTab)) {
                targetTab = 'bookings';
            } else if (appState.currentUser.role === UserRole.OWNER && !validOwnerTabs.includes(targetTab)) {
                targetTab = 'properties';
            }
            appState.activeDashboardTab = targetTab;


            let tabsHtml = '';
            if (appState.currentUser.role === UserRole.TENANT) {
                tabsHtml = `
                <button data-tab="bookings" class="dashboard-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${appState.activeDashboardTab === 'bookings' ? 'border-primary-DEFAULT text-primary-dark dark:text-primary-light' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:border-gray-600'}">
                    Booking Saya
                </button>
            `;
            } else if (appState.currentUser.role === UserRole.OWNER) {
                tabsHtml = `
                <button data-tab="properties" class="dashboard-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${appState.activeDashboardTab === 'properties' ? 'border-primary-DEFAULT text-primary-dark dark:text-primary-light' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:border-gray-600'}">
                    Properti Saya
                </button>
                 <button data-tab="bookings" class="dashboard-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${appState.activeDashboardTab === 'bookings' ? 'border-primary-DEFAULT text-primary-dark dark:text-primary-light' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:border-gray-600'}">
                    Booking Diterima
                </button>
                <button data-tab="revenue" class="dashboard-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${appState.activeDashboardTab === 'revenue' ? 'border-primary-DEFAULT text-primary-dark dark:text-primary-light' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:border-gray-600'}">
                    Laporan Pendapatan
                </button>
            `;
            }
            tabsHtml += `
             <button data-tab="notifications" class="dashboard-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${appState.activeDashboardTab === 'notifications' ? 'border-primary-DEFAULT text-primary-dark dark:text-primary-light' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:border-gray-600'}">
                Notifikasi
            </button>
        `;


            pageContainer.innerHTML = `
            <div class="container mx-auto px-4 py-8">
                <h1 class="text-3xl font-bold mb-2 text-gray-800 dark:text-gray-100">Dashboard</h1>
                <p class="text-gray-600 dark:text-gray-400 mb-8">Selamat datang kembali, ${appState.currentUser.name}!</p>
                <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        ${tabsHtml}
                    </nav>
                </div>
                <div id="dashboard-tab-content">
                    <!-- Tab content will be rendered here -->
                </div>
            </div>
        `;
            renderDashboardTabContent();
        }

        async function renderDashboardTabContent() {
            const tabContentContainer = _el('#dashboard-tab-content');
            if (!tabContentContainer || !appState.currentUser) return;

            showSpinner('#dashboard-tab-content');
            let contentHtml = '';

            try {
                switch (appState.activeDashboardTab) {
                    case 'bookings':
                        const serviceCall = appState.currentUser.role === UserRole.TENANT
                            ? bookingService.getBookingsByUser(appState.currentUser.id)
                            : bookingService.getBookingsForOwnerProperties(appState.currentUser.id);
                        const bookings = await serviceCall;
                        if (bookings.length === 0) {
                            contentHtml = '<p class="text-gray-600 dark:text-gray-400">Tidak ada data booking.</p>';
                        } else {
                            contentHtml = bookings.map(booking => `
                            <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow hover:shadow-md transition-shadow mb-4">
                                <h3 class="text-lg font-semibold text-primary-dark dark:text-primary-light">${booking.propertyName}</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">ID Booking: ${booking.id}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400 flex items-center">
                                    ${Icons.CalendarDays("w-4 h-4 inline mr-1")} 
                                    ${formatDate(booking.startDate)} - ${formatDate(booking.endDate)}
                                </p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Total: ${formatPrice(booking.totalPrice)}</p>
                                <p class="text-sm">Status: <span class="font-semibold px-2 py-0.5 rounded-full text-xs ${booking.status === 'Dikonfirmasi' ? 'bg-green-100 text-green-700 dark:bg-green-700 dark:text-green-100' :
                                    booking.status === 'Dipesan' ? 'bg-yellow-100 text-yellow-700 dark:bg-yellow-700 dark:text-yellow-100' :
                                        booking.status === 'Selesai' ? 'bg-blue-100 text-blue-700 dark:bg-blue-700 dark:text-blue-100' :
                                            'bg-red-100 text-red-700 dark:bg-red-700 dark:text-red-100'
                                }">${booking.status}</span></p>
                                ${appState.currentUser.role === UserRole.OWNER ? `<p class="text-sm text-gray-500 dark:text-gray-400">Dipesan oleh: ${MOCK_USERS.find(u => u.id === booking.userId)?.name || 'Tidak diketahui'}</p>` : ''}
                            </div>
                        `).join('');
                        }
                        break;
                    case 'properties': // Owner only
                        if (appState.currentUser.role === UserRole.OWNER) {
                            const properties = await propertyService.getPropertiesByOwner(appState.currentUser.id);
                            if (properties.length === 0) {
                                contentHtml = '<p class="text-gray-600 dark:text-gray-400">Anda belum memiliki properti terdaftar.</p>';
                            } else {
                                contentHtml = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${properties.map(createPropertyCardHTML).join('')}</div>`;
                            }
                        }
                        break;
                    case 'revenue': // Owner only
                        if (appState.currentUser.role === UserRole.OWNER) {
                            const ownerBookings = await bookingService.getBookingsForOwnerProperties(appState.currentUser.id);
                            const confirmedBookings = ownerBookings.filter(b => b.status === 'Dikonfirmasi' || b.status === 'Selesai');
                            const currentMonth = new Date().getMonth();
                            const currentYear = new Date().getFullYear();

                            const totalRevenue = confirmedBookings.reduce((sum, b) => sum + b.totalPrice, 0);
                            const monthlyRevenue = confirmedBookings
                                .filter(b => {
                                    const bookingDate = new Date(b.endDate);
                                    return bookingDate.getMonth() === currentMonth && bookingDate.getFullYear() === currentYear;
                                })
                                .reduce((sum, b) => sum + b.totalPrice, 0);

                            contentHtml = `
                            <div class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow">
                                        <h3 class="text-lg font-medium text-gray-500 dark:text-gray-400">Total Pendapatan (Terkonfirmasi)</h3>
                                        <p class="text-3xl font-semibold text-primary-dark dark:text-primary-light mt-1">${formatPrice(totalRevenue)}</p>
                                    </div>
                                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow">
                                        <h3 class="text-lg font-medium text-gray-500 dark:text-gray-400">Pendapatan Bulan Ini (Terkonfirmasi)</h3>
                                        <p class="text-3xl font-semibold text-primary-dark dark:text-primary-light mt-1">${formatPrice(monthlyRevenue)}</p>
                                    </div>
                                </div>
                                <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow">
                                    <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100">Grafik Pendapatan (Simulasi)</h3>
                                    <div class="h-64 bg-gray-100 dark:bg-slate-700 rounded flex items-center justify-center">
                                        <p class="text-gray-500 dark:text-gray-400">Placeholder untuk grafik.</p>
                                    </div>
                                </div>
                            </div>`;
                        }
                        break;
                    case 'notifications':
                        await fetchAndUpdateNotifications(); // Ensure latest notifications
                        if (appState.notifications.length === 0) {
                            contentHtml = '<p class="text-gray-600 dark:text-gray-400">Tidak ada notifikasi baru.</p>';
                        } else {
                            contentHtml = `<div class="space-y-3"> ${appState.notifications.map(notif => `
                            <div 
                                data-notif-id="${notif.id}" data-notif-link="${notif.link || ''}"
                                class="notification-item p-4 rounded-lg shadow cursor-pointer transition-colors ${notif.read
                                    ? 'bg-white dark:bg-slate-800 hover:bg-gray-50 dark:hover:bg-slate-700'
                                    : 'bg-primary-light bg-opacity-20 dark:bg-primary-dark dark:bg-opacity-30 hover:bg-primary-light hover:bg-opacity-30 dark:hover:bg-primary-dark dark:hover:bg-opacity-40'
                                }"
                            >
                                <p class="text-sm ${notif.read ? 'text-gray-700 dark:text-gray-300' : 'font-semibold text-primary-dark dark:text-primary-light'}">${notif.message}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${new Date(notif.timestamp).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' })}</p>
                            </div>
                        `).join('')}</div>`;
                        }
                        break;
                    default:
                        contentHtml = `<p>Konten untuk tab "${appState.activeDashboardTab}" belum tersedia.</p>`;
                }
                hideSpinner('#dashboard-tab-content');
                tabContentContainer.innerHTML = contentHtml;
            } catch (error) {
                console.error(`Error rendering dashboard tab ${appState.activeDashboardTab}:`, error);
                hideSpinner('#dashboard-tab-content');
                tabContentContainer.innerHTML = `<p class="text-red-500">Gagal memuat konten tab.</p>`;
            }
        }


        // --- Routing ---
        function showPage(pageId) {
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
                // page.style.display = 'none'; // Alternative if not using active class for display
            });
            const targetPage = _el(`#page-${pageId}`);
            if (targetPage) {
                targetPage.classList.add('active');
                // targetPage.style.display = 'block'; // Alternative
                appState.activePage = pageId;
            }
            renderHeader(); // Update nav links
        }

        function updateActiveNavLinks() {
            const currentHash = window.location.hash || '#/';
            _els('.nav-link').forEach(link => {
                if (link.getAttribute('href') === currentHash || (currentHash === '#/' && link.getAttribute('href') === '#/')) {
                    link.classList.add('text-primary-DEFAULT', 'dark:text-primary-light', 'font-semibold');
                    link.classList.remove('text-gray-600', 'dark:text-gray-300');
                } else {
                    link.classList.remove('text-primary-DEFAULT', 'dark:text-primary-light', 'font-semibold');
                    link.classList.add('text-gray-600', 'dark:text-gray-300');
                }
            });
        }


        function handleRouteChange() {
            const hash = window.location.hash || '#/';
            const hashParts = hash.substring(1).split('?');
            const path = hashParts[0] || '/';
            // const queryParams = new URLSearchParams(hashParts[1] || '');

            // Close any open menus/modals on route change, except if it's just a query param change for dashboard
            if (!path.startsWith('/dashboard') || appState.activePage !== 'dashboard') {
                appState.showUserMenu = false;
                appState.showNotifMenu = false;
                renderHeader(); // to close menus visually
                if (appState.selectedPropertyIdForModal) closePropertyDetailModal();
                if (appState.propertyForBookingModal) closeBookingFormModal();
            }


            if (path === '/' || path === '/home') {
                showPage('home');
                renderHomePage();
            } else if (path === '/properti') {
                showPage('properti');
                const params = new URLSearchParams(hashParts[1]);
                renderPropertyListPage({
                    location: params.get('lokasi') || '',
                    type: params.get('tipe') || ''
                });
            } else if (path.startsWith('/dashboard')) {
                showPage('dashboard');
                // Extract tab from path like /dashboard/bookings or query param ?tab=bookings
                const pathSegments = path.split('/');
                let tabName = '';
                if (pathSegments.length > 2 && ['bookings', 'properties', 'revenue', 'notifications'].includes(pathSegments[2])) {
                    tabName = pathSegments[2];
                } else {
                    const params = new URLSearchParams(hashParts[1]);
                    tabName = params.get('tab') || '';
                }
                renderDashboardPage(tabName);
            } else {
                // Fallback to home for unknown routes
                showPage('home');
                renderHomePage();
            }
            updateActiveNavLinks();
        }

        // --- Event Delegation and Listeners ---
        function setupEventListeners() {
            document.body.addEventListener('click', async (event) => {
                const target = event.target.closest('[data-action]');
                if (!target) return;

                const action = target.dataset.action;
                const propertyId = target.dataset.propertyId;
                const notifId = target.dataset.notifId;
                const notifLink = target.dataset.notifLink;

                switch (action) {
                    case 'toggle-theme':
                        toggleTheme();
                        break;
                    case 'toggle-user-menu':
                        appState.showUserMenu = !appState.showUserMenu;
                        if (appState.showUserMenu) appState.showNotifMenu = false; // Close other menu
                        renderHeader();
                        break;
                    case 'close-user-menu':
                        appState.showUserMenu = false;
                        renderHeader();
                        break;
                    case 'login-tenant':
                        login('user1');
                        break;
                    case 'login-owner':
                        login('user2');
                        break;
                    case 'logout':
                        logout();
                        break;
                    case 'toggle-notif-menu':
                        appState.showNotifMenu = !appState.showNotifMenu;
                        if (appState.showNotifMenu) {
                            appState.showUserMenu = false; // Close other menu
                            await fetchAndUpdateNotifications(); // Fetch fresh notifs
                        }
                        renderHeader(); // For main header part
                        renderNotificationDropdown(); // For dropdown content itself
                        break;
                    case 'close-notif-menu':
                        appState.showNotifMenu = false;
                        renderHeader();
                        renderNotificationDropdown();
                        break;
                    case 'open-property-detail':
                        if (propertyId) openPropertyDetailModal(propertyId);
                        break;
                    case 'close-property-detail':
                        closePropertyDetailModal();
                        break;
                    case 'open-booking-form':
                        if (propertyId) {
                            setLoadingState(true);
                            const prop = await propertyService.getPropertyById(propertyId);
                            setLoadingState(false);
                            if (prop) {
                                if (appState.currentUser) {
                                    openBookingFormModal(prop);
                                    closePropertyDetailModal(); // Close detail modal after opening booking
                                } else {
                                    appState.bookingError = "Anda harus login untuk melakukan pemesanan."; // Temporary error
                                    alert("Anda harus login untuk melakukan pemesanan."); // Replace with better UI
                                    // Potentially open login modal here
                                }
                            }
                        }
                        break;
                    case 'close-booking-form':
                        closeBookingFormModal();
                        break;
                    case 'booking-prev-step':
                        if (appState.bookingFormStep > 1) {
                            appState.bookingFormStep--;
                            renderBookingFormStep();
                        }
                        break;
                    case 'show-login-options': // From dashboard if not logged in
                        appState.showUserMenu = true; // reuse user menu for login
                        renderHeader(); // this will show login options in user menu
                        // scroll to header or show a dedicated login modal might be better UX
                        _el('#app-header').scrollIntoView({ behavior: 'smooth' });
                        break;
                }
            });

            // For notification items within dropdown or dashboard list
            document.body.addEventListener('click', async (event) => {
                const targetNotifItem = event.target.closest('.notification-item');
                if (targetNotifItem) {
                    const notifId = targetNotifItem.dataset.notifId;
                    const notifLink = targetNotifItem.dataset.notifLink;
                    if (notifId) {
                        await notificationService.markAsRead(notifId);
                        await fetchAndUpdateNotifications(); // Refreshes counts and visual state
                        if (appState.activePage === 'dashboard' && appState.activeDashboardTab === 'notifications') {
                            renderDashboardTabContent(); // Refresh dashboard notifications tab if active
                        }
                    }
                    if (notifLink && notifLink !== '#') {
                        window.location.hash = notifLink;
                    }
                    // Close notification menu if it was the source
                    if (event.target.closest('#notification-dropdown-container')) {
                        appState.showNotifMenu = false;
                        renderHeader();
                        renderNotificationDropdown();
                    }
                }
            });


            // Form Submissions
            document.body.addEventListener('submit', async (event) => {
                event.preventDefault();
                const form = event.target;

                if (form.id === 'home-search-form') {
                    const location = _el('#home-search-location').value;
                    window.location.hash = `#/properti?lokasi=${encodeURIComponent(location)}`;
                } else if (form.id === 'booking-step1-form') {
                    if (!appState.currentUser) {
                        appState.bookingError = "Anda harus login untuk melakukan pemesanan.";
                        renderBookingFormStep();
                        return;
                    }
                    if (!appState.bookingFormData.startDate || !appState.bookingFormData.endDate) {
                        appState.bookingError = "Silakan pilih tanggal mulai dan selesai.";
                        renderBookingFormStep();
                        return;
                    }
                    if (appState.bookingFormData.totalPrice <= 0) {
                        appState.bookingError = "Durasi menginap tidak valid atau tanggal selesai sebelum tanggal mulai.";
                        renderBookingFormStep();
                        return;
                    }
                    appState.bookingError = '';
                    appState.bookingFormStep = 2;
                    renderBookingFormStep();
                } else if (form.id === 'booking-step2-form') {
                    const cardHolderName = form.cardHolderName.value;
                    const cardNumber = form.cardNumber.value.replace(/\s/g, '');
                    const expiryDate = form.expiryDate.value;
                    const cvv = form.cvv.value;

                    if (!cardHolderName || !cardNumber || !expiryDate || !cvv) {
                        appState.bookingError = "Harap isi semua detail pembayaran.";
                        renderBookingFormStep();
                        return;
                    }
                    if (cardNumber.length !== 16 || !/^\d+$/.test(cardNumber)) {
                        appState.bookingError = "Nomor kartu tidak valid (harus 16 digit angka).";
                        renderBookingFormStep();
                        return;
                    }
                    if (!/^\d{2}\/\d{2}$/.test(expiryDate)) {
                        appState.bookingError = "Format tanggal kedaluwarsa MM/YY.";
                        renderBookingFormStep();
                        return;
                    }
                    if (cvv.length < 3 || cvv.length > 4 || !/^\d+$/.test(cvv)) {
                        appState.bookingError = "CVV tidak valid (3 atau 4 digit angka).";
                        renderBookingFormStep();
                        return;
                    }

                    appState.bookingFormData.paymentDetails = { cardHolderName, cardNumber, expiryDate, cvv };
                    appState.bookingError = '';
                    setLoadingState(true);
                    renderBookingFormStep(); // Show spinner

                    try {
                        const bookingResult = await bookingService.createBooking({
                            propertyId: appState.propertyForBookingModal.id,
                            propertyName: appState.propertyForBookingModal.name,
                            userId: appState.currentUser.id,
                            startDate: appState.bookingFormData.startDate,
                            endDate: appState.bookingFormData.endDate,
                            totalPrice: appState.bookingFormData.totalPrice,
                        });
                        // await notificationService.createNotification({userId: appState.currentUser.id, message: `Booking Anda untuk ${bookingResult.propertyName} telah diterima!`, link: `#/dashboard?tab=bookings&bookingId=${bookingResult.id}`})
                        // await fetchAndUpdateNotifications(); // Update immediately

                        appState.bookingFormStep = 3;
                    } catch (err) {
                        appState.bookingError = "Gagal memproses booking. Silakan coba lagi.";
                        console.error(err);
                    } finally {
                        setLoadingState(false);
                        renderBookingFormStep(); // Render step 3 or error
                    }
                }
            });

            // Live date changes for booking form total price
            document.body.addEventListener('change', (event) => {
                if (event.target.id === 'startDate' || event.target.id === 'endDate') {
                    if (appState.propertyForBookingModal && appState.bookingFormStep === 1) {
                        handleBookingDateChange();
                    }
                }
            });

            // Property list filter button
            document.body.addEventListener('click', (event) => {
                if (event.target.id === 'filter-properties-btn') {
                    applyFiltersAndRenderProperties();
                }
            });

            // Dashboard tab clicks
            document.body.addEventListener('click', (event) => {
                const tabButton = event.target.closest('.dashboard-tab');
                if (tabButton && tabButton.dataset.tab) {
                    appState.activeDashboardTab = tabButton.dataset.tab;
                    // Update URL hash to reflect tab change for shareability/bookmarking
                    // but be careful not to trigger a full page reload if only tab changes
                    const currentHash = window.location.hash.split('?')[0];
                    window.location.hash = `${currentHash}?tab=${appState.activeDashboardTab}`;
                    // renderDashboardPage will be called by hashchange, or call manually if hash doesn't change:
                    // if (window.location.hash === `${currentHash}?tab=${appState.activeDashboardTab}`) {
                    //     renderDashboardPage(appState.activeDashboardTab); // If hash didn't actually change but we need to re-render
                    // }
                }
            });
        }


        // --- Initialization ---
        function initApp() {
            loadCurrentUser();
            applyTheme();
            renderHeader();
            _el('#current-year').textContent = new Date().getFullYear();

            window.addEventListener('hashchange', handleRouteChange);
            handleRouteChange(); // Initial route handling

            setupEventListeners();
            fetchAndUpdateNotifications(); // Initial fetch for logged-in user
        }

        document.addEventListener('DOMContentLoaded', initApp);

        // --- END OF INLINED SCRIPT ---
    </script>
</body>

</html>