<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Headers Keamanan -->
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https://fonts.googleapis.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net;
                   style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net;
                   font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net;
                   script-src 'self' 'unsafe-inline';
                   img-src 'self' data: https://i.pravatar.cc https://images.unsplash.com https://via.placeholder.com;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), camera=(), microphone=()">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">

    <!-- Meta Informasi SEO & Aplikasi -->
    <meta name="description"
        content="Green Valley - Platform sewa apartemen terintegrasi untuk manajemen properti yang efisien dan modern.">
    <meta name="keywords"
        content="sewa apartemen, manajemen properti, aplikasi properti, Green Valley, property management system">
    <meta name="author" content="Green Valley Development Team">
    <meta name="theme-color" content="#3b82f6"> <!-- Warna tema untuk UI browser di mobile -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Open Graph / Social Media Sharing -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Green Valley - Platform Sewa Apartemen Modern">
    <meta property="og:description" content="Kelola properti sewa Anda dengan mudah menggunakan Green Valley.">
    <meta property="og:image" content="https://via.placeholder.com/1200x630?text=Green Valley+Logo">
    <meta property="og:url" content="https://GreenValley.example.com"> <!-- Ganti dengan URL sebenarnya -->

    <!-- Favicon & App Icons (Placeholder, ganti dengan ikon asli) -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://via.placeholder.com/32x32?text=GV">
    <link rel="icon" type="image/png" sizes="16x16" href="https://via.placeholder.com/16x16?text=GV">
    <link rel="apple-touch-icon" sizes="180x180" href="https://via.placeholder.com/180x180?text=Green Valley">

    <title>Green Valley - Platform Sewa Apartemen Modern</title>

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome untuk ikon (Gratis) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Bootstrap Icons (Gratis, alternatif atau pelengkap Font Awesome) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        /* ==========================================================================
           Design Tokens & Reset Global
           ========================================================================== */
        :root {
            /* Skala Font (Fluid Typography) */
            --font-size-xs: clamp(0.75rem, calc(0.7rem + 0.25vw), 0.875rem);
            /* 12px - 14px */
            --font-size-sm: clamp(0.875rem, calc(0.8rem + 0.375vw), 1rem);
            /* 14px - 16px */
            --font-size-base: clamp(1rem, calc(0.9rem + 0.5vw), 1.125rem);
            /* 16px - 18px */
            --font-size-md: clamp(1.125rem, calc(1rem + 0.625vw), 1.25rem);
            /* 18px - 20px */
            --font-size-lg: clamp(1.25rem, calc(1.1rem + 0.75vw), 1.5rem);
            /* 20px - 24px */
            --font-size-xl: clamp(1.5rem, calc(1.3rem + 1vw), 2rem);
            /* 24px - 32px */
            --font-size-2xl: clamp(2rem, calc(1.8rem + 1.25vw), 3rem);
            /* 32px - 48px */
            --font-size-3xl: clamp(2.5rem, calc(2.3rem + 1.5vw), 4rem);
            /* 40px - 64px */

            /* Skala Spasi (Fluid Spacing) */
            --spacing-px: 1px;
            --spacing-0: 0;
            --spacing-1: clamp(0.25rem, calc(0.2rem + 0.25vw), 0.5rem);
            /* 4px - 8px */
            --spacing-2: clamp(0.5rem, calc(0.4rem + 0.5vw), 0.75rem);
            /* 8px - 12px */
            --spacing-3: clamp(0.75rem, calc(0.65rem + 0.5vw), 1rem);
            /* 12px - 16px */
            --spacing-4: clamp(1rem, calc(0.85rem + 0.75vw), 1.5rem);
            /* 16px - 24px */
            --spacing-5: clamp(1.5rem, calc(1.25rem + 1.25vw), 2rem);
            /* 24px - 32px */
            --spacing-6: clamp(2rem, calc(1.75rem + 1.25vw), 3rem);
            /* 32px - 48px */
            --spacing-8: clamp(3rem, calc(2.75rem + 1.25vw), 4rem);
            /* 48px - 64px */
            --spacing-10: clamp(4rem, calc(3.75rem + 1.25vw), 5rem);
            /* 64px - 80px */

            /* Sistem Warna - Tema Terang (Default) */
            --background: #f8fafc;
            /* slate-50 */
            --foreground: #0f172a;
            /* slate-900 */
            --card: #ffffff;
            --card-foreground: #0f172a;
            --popover: #ffffff;
            --popover-foreground: #0f172a;
            --primary: #3b82f6;
            /* blue-500 */
            --primary-foreground: #ffffff;
            --primary-hover: #2563eb;
            /* blue-600 */
            --primary-active: #1d4ed8;
            /* blue-700 NEW for button press */
            --secondary: #f1f5f9;
            /* slate-100 */
            --secondary-foreground: #0f172a;
            --secondary-hover: #e2e8f0;
            /* slate-200 */
            --secondary-active: #cbd5e1;
            /* slate-300 NEW for button press */
            --muted: #f1f5f9;
            /* slate-100 */
            --muted-foreground: #64748b;
            /* slate-500 */
            --accent: #e0f2fe;
            /* sky-100 */
            --accent-foreground: #0c4a6e;
            /* sky-800 */
            --accent-hover: #bae6fd;
            /* sky-200 */
            --destructive: #ef4444;
            /* red-500 */
            --destructive-foreground: #ffffff;
            --destructive-hover: #dc2626;
            /* red-600 */
            --destructive-active: #b91c1c;
            /* red-700 NEW for button press */
            --border: #e2e8f0;
            /* slate-200 */
            --input: #e2e8f0;
            /* slate-200 */
            --input-focus: #cbd5e1;
            /* slate-300 */
            --ring: #3b82f6;
            /* blue-500 */
            --success: #22c55e;
            /* green-500 */
            --success-foreground: #ffffff;
            --warning: #f59e0b;
            /* amber-500 */
            --warning-foreground: #ffffff;
            --info: #0ea5e9;
            /* sky-500 */
            --info-foreground: #ffffff;

            /* Properti Layout */
            --radius-sm: 0.25rem;
            /* 4px */
            --radius: 0.5rem;
            /* 8px */
            --radius-md: 0.75rem;
            /* 12px */
            --radius-lg: 1rem;
            /* 16px */
            --radius-full: 9999px;
            --sidebar-width: 280px;
            --sidebar-width-collapsed: 80px;
            /* Untuk tampilan ikon saja jika diperlukan */
            --header-height: 70px;
            --footer-height: 60px;
            --container-max-width: 1280px;

            /* Bayangan (Shadows) */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --shadow-inner: inset 0 2px 4px 0 rgb(0 0 0 / 0.05);

            /* Transisi */
            --transition-all: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-colors: background-color 0.3s cubic-bezier(0.4, 0, 0.2, 1), border-color 0.3s cubic-bezier(0.4, 0, 0.2, 1), color 0.3s cubic-bezier(0.4, 0, 0.2, 1), fill 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-opacity: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-shadow: box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-transform: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            /* NEW for faster interactions */


            /* Z-index (untuk mengatur tumpukan elemen) */
            --z-0: 0;
            --z-10: 10;
            /* Konten dasar */
            --z-20: 20;
            /* Elemen di atas konten */
            --z-30: 30;
            /* Dropdown, tooltip */
            --z-40: 40;
            /* Header, sidebar sticky */
            --z-50: 50;
            /* Modal, overlay */
            --z-dropdown: 1000;
            --z-sticky: 1100;
            --z-fixed: 1200;
            --z-modal-backdrop: 1290;
            --z-modal: 1300;
            --z-alert-modal-backdrop: 1390;
            /* Sedikit di atas modal biasa jika diperlukan */
            --z-alert-modal: 1400;
            /* Sedikit di atas modal biasa jika diperlukan */
            --z-chat-widget: 1500;
            /* Untuk floating chat widget */
            --z-toast: 1600;
            --z-overlay: 1700;
            /* Overlay loading global */
        }

        /* Tema Gelap */
        .dark {
            --background: #020617;
            /* slate-950 */
            --foreground: #f1f5f9;
            /* slate-100 */
            --card: #0f172a;
            /* slate-900 */
            --card-foreground: #f1f5f9;
            --popover: #0f172a;
            --popover-foreground: #f1f5f9;
            --primary: #60a5fa;
            /* blue-400 */
            --primary-foreground: #0f172a;
            --primary-hover: #3b82f6;
            /* blue-500 */
            --primary-active: #2563eb;
            /* blue-600 */
            --secondary: #1e293b;
            /* slate-800 */
            --secondary-foreground: #f1f5f9;
            --secondary-hover: #334155;
            /* slate-700 */
            --secondary-active: #475569;
            /* slate-600 */
            --muted: #1e293b;
            --muted-foreground: #94a3b8;
            /* slate-400 */
            --accent: #1e3a8a;
            /* blue-900 */
            --accent-foreground: #bfdbfe;
            /* blue-200 */
            --accent-hover: #1e40af;
            /* blue-800 */
            --destructive: #f87171;
            /* red-400 */
            --destructive-foreground: #0f172a;
            --destructive-hover: #ef4444;
            /* red-500 */
            --destructive-active: #dc2626;
            /* red-600 */
            --border: #1e293b;
            /* slate-800 */
            --input: #1e293b;
            --input-focus: #334155;
            /* slate-700 */
            --ring: #60a5fa;
            --success: #4ade80;
            /* green-400 */
            --success-foreground: #0f172a;
            --warning: #fbbf24;
            /* amber-400 */
            --warning-foreground: #0f172a;
            --info: #38bdf8;
            /* sky-400 */
            --info-foreground: #0f172a;
        }

        /* Reset & Gaya Dasar */
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-tap-highlight-color: transparent;
            /* Menghilangkan highlight biru pada tap di mobile */
        }

        html {
            font-size: 16px;
            /* Basis untuk REM */
            scroll-behavior: smooth;
            height: 100%;
            overflow-x: hidden;
            /* Mencegah scroll horizontal yang tidak diinginkan */
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            line-height: 1.6;
            color: var(--foreground);
            background-color: var(--background);
            min-height: 100vh;
            transition: var(--transition-colors);
            text-rendering: optimizeLegibility;
            /* Meningkatkan keterbacaan teks */
            display: flex;
            /* Untuk struktur dasar aplikasi (sidebar + main) */
            flex-direction: row;
            /* Konten utama bersebelahan dengan sidebar */
        }

        /* Tipografi */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-weight: 700;
            /* Lebih tebal untuk judul */
            line-height: 1.2;
            letter-spacing: -0.025em;
            margin-bottom: var(--spacing-3);
            color: var(--foreground);
            /* Mengikuti warna teks utama */
        }

        h1 {
            font-size: var(--font-size-2xl);
        }

        h2 {
            font-size: var(--font-size-xl);
        }

        h3 {
            font-size: var(--font-size-lg);
        }

        h4 {
            font-size: var(--font-size-md);
        }

        h5 {
            font-size: var(--font-size-base);
        }

        h6 {
            font-size: var(--font-size-sm);
        }

        p {
            margin-bottom: var(--spacing-4);
            font-size: var(--font-size-base);
            color: var(--muted-foreground);
            /* Warna lebih soft untuk paragraf */
        }

        p.lead {
            font-size: var(--font-size-md);
            color: var(--foreground);
        }

        a {
            color: var(--primary);
            text-decoration: none;
            transition: var(--transition-colors);
        }

        a:hover {
            color: var(--primary-hover);
            text-decoration: underline;
        }

        /* Elemen Form */
        button,
        input,
        select,
        textarea {
            font-family: inherit;
            font-size: var(--font-size-base);
            line-height: inherit;
            color: inherit;
            border-radius: var(--radius);
        }

        button {
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            display: inline-flex;
            /* Agar ikon dan teks sejajar */
            align-items: center;
            justify-content: center;
            gap: var(--spacing-2);
            font-weight: 500;
            transition: var(--transition-fast), transform 0.1s ease-out;
            /* Added transform for press effect */
        }

        /* NEW: Button press effect */
        button:active {
            transform: scale(0.97);
        }

        button:disabled,
        input:disabled,
        select:disabled,
        textarea:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        input,
        select,
        textarea {
            padding: var(--spacing-2) var(--spacing-3);
            border: 1px solid var(--input);
            background-color: var(--background);
            /* Atau var(--card) jika form di dalam card */
            transition: var(--transition-all);
            width: 100%;
            /* Default form controls to full width */
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: var(--ring);
            box-shadow: 0 0 0 2px var(--ring);
        }

        select {
            appearance: none;
            /* Hapus tampilan default browser */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%2364748b'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right var(--spacing-2) center;
            background-size: 1.5em 1.5em;
            padding-right: var(--spacing-8);
            /* Ruang untuk ikon panah */
        }

        /* Style untuk dark mode select arrow */
        .dark select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%2394a3b8'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
        }


        /* Elemen Media */
        img,
        picture,
        video,
        canvas {
            /* Tidak ada SVG */
            display: block;
            max-width: 100%;
            height: auto;
        }

        /* Utilitas Aksesibilitas */
        .sr-only {
            /* Screen-reader only */
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .loading-placeholder {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--spacing-5);
            color: var(--muted-foreground);
            font-style: italic;
            gap: var(--spacing-2);
        }

        .loading-placeholder i {
            font-size: var(--font-size-lg);
        }

        /* NEW: Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInFromBottom {
            from {
                opacity: 0;
                transform: translateY(15px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes slideInFromRight {

            /* For sent messages */
            from {
                opacity: 0;
                transform: translateX(15px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        @keyframes slideInFromLeft {

            /* For received messages */
            from {
                opacity: 0;
                transform: translateX(-15px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        @keyframes typingDots {

            0%,
            20% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-4px);
            }
        }

        /* ==========================================================================
           Struktur Layout Utama
           ========================================================================== */
        /* .app-container sudah ada di <body> */

        .sidebar {
            width: var(--sidebar-width);
            background: var(--card);
            padding: var(--spacing-5) var(--spacing-4);
            border-right: 1px solid var(--border);
            /* Dulu position: fixed, sekarang bagian dari flex body */
            height: 100vh;
            /* Tinggi penuh viewport */
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-md);
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out, padding 0.3s ease-in-out;
            overflow-y: auto;
            /* Scroll jika konten sidebar panjang */
            z-index: var(--z-sticky);
            /* Agar di atas konten lain */
        }

        .sidebar.collapsed {
            width: 0;
            /* Atau var(--sidebar-width-collapsed) jika ingin ikon saja */
            padding-left: 0;
            padding-right: 0;
            transform: translateX(-100%);
            /* Sembunyikan sepenuhnya */
            overflow: hidden;
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-6);
            padding: 0 var(--spacing-2);
            /* Padding agar tidak terlalu mepet jika sidebar collapsed */
        }

        .sidebar-brand__icon {
            font-size: var(--font-size-2xl);
            color: var(--primary);
            transition: var(--transition-all);
        }

        .sidebar-brand__text {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--primary);
            transition: var(--transition-opacity);
            white-space: nowrap;
            /* Agar teks tidak wrap */
        }

        .sidebar.collapsed .sidebar-brand__text {
            opacity: 0;
            pointer-events: none;
        }


        .nav-menu {
            list-style: none;
            flex-grow: 1;
            /* Mengisi sisa ruang di sidebar */
        }

        .nav-item {
            margin-bottom: var(--spacing-1);
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            padding: var(--spacing-2) var(--spacing-3);
            color: var(--muted-foreground);
            /* Warna default untuk link navigasi */
            border-radius: var(--radius-md);
            transition: var(--transition-all), transform 0.1s ease-out;
            font-size: var(--font-size-base);
            font-weight: 500;
            white-space: nowrap;
        }

        .nav-link i {
            /* Ikon di navigasi */
            width: 20px;
            /* Menjaga lebar ikon konsisten */
            text-align: center;
            font-size: var(--font-size-md);
        }

        .nav-link:hover {
            background: var(--accent);
            color: var(--accent-foreground);
            text-decoration: none;
            transform: translateX(3px);
            /* NEW: Subtle hover effect */
        }

        .nav-link:active {
            transform: translateX(1px) scale(0.99);
            /* NEW: Press effect */
        }

        .nav-link.active {
            background: var(--primary);
            color: var(--primary-foreground);
            box-shadow: var(--shadow-sm);
        }

        .nav-link.active:hover {
            transform: none;
            /* Prevent hover transform on active link */
        }


        .sidebar.collapsed .nav-link span {
            /* Sembunyikan teks link saat collapsed */
            opacity: 0;
            width: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .sidebar.collapsed .nav-link {
            justify-content: center;
            /* Pusatkan ikon */
        }

        .sidebar.collapsed .nav-link:hover {
            /* NEW: No translateX for collapsed sidebar icons */
            transform: none;
        }


        .main-wrapper {
            flex-grow: 1;
            /* Mengisi sisa ruang di body */
            display: flex;
            flex-direction: column;
            height: 100vh;
            /* Memastikan wrapper utama mengisi tinggi viewport */
            overflow-y: auto;
            /* Scroll utama aplikasi ada di sini */
            transition: margin-left 0.3s ease-in-out;
            /* Jika sidebar fixed */
        }

        .app-header {
            height: var(--header-height);
            background: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 0 var(--spacing-5);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            /* Membuat header tetap di atas saat scroll */
            top: 0;
            z-index: var(--z-sticky);
            box-shadow: var(--shadow-sm);
        }

        .header-left,
        .header-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: var(--secondary);
            padding: var(--spacing-1) var(--spacing-3);
            border-radius: var(--radius-full);
            /* Membuatnya lebih rounded */
            border: 1px solid var(--border);
            max-width: 400px;
            flex-grow: 1;
            /* Agar bisa mengisi ruang jika ada */
        }

        .search-bar i {
            color: var(--muted-foreground);
            margin-right: var(--spacing-2);
        }

        .search-bar input {
            border: none;
            background: transparent;
            outline: none;
            flex-grow: 1;
            padding: var(--spacing-2) 0;
            font-size: var(--font-size-sm);
        }

        .search-bar input::placeholder {
            color: var(--muted-foreground);
        }

        .profile-dropdown {
            position: relative;
        }

        .profile-dropdown__toggle {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            cursor: pointer;
            padding: var(--spacing-1);
            border-radius: var(--radius-full);
            /* Avatar bulat */
            transition: var(--transition-all);
        }

        .profile-dropdown__toggle:hover {
            background: var(--secondary-hover);
        }

        .profile-dropdown__toggle img {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            object-fit: cover;
            border: 2px solid var(--border);
        }

        .profile-dropdown__toggle span {
            font-weight: 500;
            font-size: var(--font-size-sm);
        }

        .profile-dropdown__menu {
            position: absolute;
            top: calc(100% + var(--spacing-2));
            /* Jarak dari toggle */
            right: 0;
            background: var(--popover);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 220px;
            z-index: var(--z-dropdown);
            opacity: 0;
            transform: translateY(-10px);
            visibility: hidden;
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
        }

        .profile-dropdown__menu.show {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }

        .profile-dropdown__item {
            display: flex;
            /* Untuk ikon dan teks */
            align-items: center;
            gap: var(--spacing-2);
            padding: var(--spacing-2) var(--spacing-3);
            color: var(--popover-foreground);
            transition: var(--transition-all);
            font-size: var(--font-size-sm);
        }

        .profile-dropdown__item i {
            width: 16px;
            text-align: center;
            color: var(--muted-foreground);
        }

        .profile-dropdown__item:hover {
            background: var(--primary);
            color: var(--primary-foreground);
            text-decoration: none;
        }

        .profile-dropdown__item:hover i {
            color: var(--primary-foreground);
        }

        .profile-dropdown__divider {
            height: 1px;
            background-color: var(--border);
            margin: var(--spacing-1) 0;
        }

        .theme-toggle {
            padding: var(--spacing-2);
            border-radius: var(--radius-full);
            /* Bulat */
            background: transparent;
            /* Lebih subtle */
            color: var(--muted-foreground);
            font-size: var(--font-size-lg);
            transition: var(--transition-all);
            line-height: 1;
            /* Menghindari perubahan tinggi saat ikon berubah */
        }

        .theme-toggle:hover {
            background: var(--secondary-hover);
            color: var(--foreground);
        }

        .theme-toggle i {
            margin: 0;
        }

        /* Reset gap default dari button */

        .main-content {
            padding: var(--spacing-5);
            flex-grow: 1;
            /* Mengisi sisa ruang di main-wrapper */
        }

        .page-section {
            animation: fadeIn 0.5s ease-out;
        }

        /* ==========================================================================
           Komponen UI Kustom
           ========================================================================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-5);
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            /* Radius lebih besar untuk card */
            box-shadow: var(--shadow);
            padding: var(--spacing-5);
            transition: var(--transition-all);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-3px);
        }

        .card-header {
            padding-bottom: var(--spacing-3);
            margin-bottom: var(--spacing-3);
            border-bottom: 1px solid var(--border);
        }

        .card-header h3 {
            margin-bottom: var(--spacing-1);
        }

        .card-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            margin-bottom: var(--spacing-1);
        }

        .card-description {
            font-size: var(--font-size-sm);
            color: var(--muted-foreground);
            margin-bottom: var(--spacing-3);
        }

        .card-footer {
            padding-top: var(--spacing-3);
            margin-top: var(--spacing-3);
            border-top: 1px solid var(--border);
        }


        .apartments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-5);
        }

        .apartment-card {
            /* adalah .card */
            overflow: hidden;
            /* Agar gambar tidak keluar dari border-radius */
            display: flex;
            /* NEW: For better internal layout control */
            flex-direction: column;
            /* NEW: Stack image and content */
        }

        .apartment-card .card-body {
            /* NEW: Allow body to grow */
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .apartment-card .apartment-actions {
            /* NEW: Push actions to bottom */
            margin-top: auto;
        }

        .apartment-card img {
            width: 100%;
            height: 220px;
            object-fit: cover;
            border-bottom: 1px solid var(--border);
            margin: calc(var(--spacing-5) * -1) calc(var(--spacing-5) * -1) var(--spacing-3) calc(var(--spacing-5) * -1);
            /* Negatif margin untuk full-width image */
            border-top-left-radius: var(--radius-lg);
            /* Sesuaikan dengan card */
            border-top-right-radius: var(--radius-lg);
        }

        .apartment-card h3 {
            font-size: var(--font-size-md);
            margin-bottom: var(--spacing-2);
        }

        .apartment-card p {
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-1);
        }

        .apartment-actions {
            display: flex;
            gap: var(--spacing-2);
            margin-top: var(--spacing-4);
            flex-wrap: wrap;
            /* Agar tombol wrap di layar kecil */
        }


        .filter-section {
            display: flex;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-5);
            flex-wrap: wrap;
            /* Agar filter wrap */
            align-items: center;
            padding: var(--spacing-4);
            background-color: var(--card);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }

        .filter-section select,
        .filter-section button {
            /* Ukuran sudah diatur oleh elemen form dasar */
            flex-grow: 1;
            /* Agar elemen filter mengisi ruang */
            min-width: 180px;
            /* Lebar minimum sebelum wrap */
        }


        .table-container {
            overflow-x: auto;
            /* Penting untuk tabel responsif */
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card);
        }

        th,
        td {
            padding: var(--spacing-3) var(--spacing-4);
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: var(--font-size-sm);
        }

        th {
            background: var(--secondary);
            /* Header tabel lebih soft */
            color: var(--secondary-foreground);
            font-weight: 600;
            text-transform: uppercase;
            /* Teks header kapital */
            letter-spacing: 0.05em;
        }

        tbody tr:last-child td {
            border-bottom: none;
            /* Hapus border bawah baris terakhir */
        }

        tbody tr:hover {
            background-color: var(--accent);
        }


        .badge {
            padding: var(--spacing-1) var(--spacing-2);
            border-radius: var(--radius-full);
            /* Badge bulat */
            font-size: var(--font-size-xs);
            font-weight: 600;
            text-transform: capitalize;
        }

        .badge--active,
        .badge--lunas,
        .badge--terverifikasi {
            /* Tambahkan Lunas, Terverifikasi */
            background: var(--success);
            color: var(--success-foreground);
        }

        .badge--pending,
        .badge--menunggu-verifikasi {
            /* Tambahkan Menunggu Verifikasi */
            background: var(--warning);
            color: var(--warning-foreground);
        }

        .badge--due,
        .badge--inactive,
        .badge--dibatalkan {
            /* Tambahkan Dibatalkan */
            background: var(--destructive);
            color: var(--destructive-foreground);
        }

        .badge--info,
        .badge--deposit {
            /* Tambahkan Deposit */
            background: var(--info);
            color: var(--info-foreground);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            /* Lebih gelap */
            backdrop-filter: blur(4px);
            /* Efek blur modern */
            display: none;
            /* Default tersembunyi */
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: var(--z-modal-backdrop);
        }

        .modal-overlay.show {
            display: flex;
            opacity: 1;
        }

        #alertModalOverlay {
            /* Target spesifik untuk alert modal */
            z-index: var(--z-alert-modal-backdrop);
        }

        /* Z-index untuk payment modal agar bisa di atas modal lain jika diperlukan */
        #paymentModalOverlay {
            z-index: var(--z-modal-backdrop);
            /* Sama dengan modal lain, atau lebih tinggi jika perlu */
        }

        .modal-overlay.show .modal__dialog {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        .modal__dialog {
            /* Ini menjadi container untuk modal content */
            max-width: 600px;
            width: calc(100% - var(--spacing-8));
            /* Memberi sedikit margin di layar kecil */
            background: var(--card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            display: flex;
            flex-direction: column;
            transform: scale(0.95) translateY(20px);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            z-index: var(--z-modal);
        }

        #alertModalOverlay .modal__dialog {
            /* Konten alert modal */
            z-index: var(--z-alert-modal);
            max-width: 500px;
            /* Alert modal bisa lebih kecil */
        }

        #paymentModalDialog {
            /* Style untuk modal pembayaran */
            max-width: 700px;
            z-index: var(--z-modal);
            /* Sama dengan modal lain */
        }

        /* BEGIN: Property Detail Modal Specific Styling */
        #propertyDetailModalDialog {
            max-width: 800px;
            /* Lebih lebar untuk detail properti */
        }

        .property-detail-modal__gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: var(--spacing-2);
            margin-bottom: var(--spacing-4);
        }

        .property-detail-modal__gallery img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: var(--radius-sm);
            cursor: pointer;
            border: 2px solid transparent;
            transition: var(--transition-all);
        }

        .property-detail-modal__gallery img:hover,
        .property-detail-modal__gallery img.active-thumbnail {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .property-detail-modal__main-image-container {
            width: 100%;
            height: 300px;
            /* Sesuaikan tinggi gambar utama */
            margin-bottom: var(--spacing-4);
            border-radius: var(--radius-md);
            overflow: hidden;
            background-color: var(--secondary);
            /* Placeholder jika gambar tidak ada */
        }

        .property-detail-modal__main-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .property-detail-modal__info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-4);
        }

        .property-detail-modal__info-item strong,
        .transaction-detail-modal__info-item strong,
        /* Tambahkan untuk detail transaksi */
        .profile-info-item strong,
        /* Tambahkan untuk profil */
        .settings-item strong

        /* Tambahkan untuk settings */
            {
            display: block;
            color: var(--foreground);
            margin-bottom: var(--spacing-1);
            font-weight: 600;
            /* Perjelas strong */
        }

        .property-detail-modal__info-item p,
        .transaction-detail-modal__info-item p,
        /* Tambahkan untuk detail transaksi */
        .profile-info-item p,
        /* Tambahkan untuk profil */
        .settings-item p

        /* Tambahkan untuk settings */
            {
            margin-bottom: 0;
            font-size: var(--font-size-sm);
            color: var(--muted-foreground);
        }

        /* Style untuk .profile-info-item di halaman profil (non-modal) */
        #profile-content .profile-info-item {
            margin-bottom: var(--spacing-3);
        }

        #profile-content .profile-info-item p {
            color: var(--foreground);
            /* Warna teks profil lebih jelas */
        }


        .property-detail-modal__section-title {
            font-size: var(--font-size-md);
            font-weight: 600;
            color: var(--primary);
            margin-top: var(--spacing-4);
            margin-bottom: var(--spacing-2);
            padding-bottom: var(--spacing-1);
            border-bottom: 1px solid var(--border);
        }

        .property-detail-modal__amenities-list {
            list-style: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-2);
        }

        .property-detail-modal__amenities-list li {
            background: var(--accent);
            color: var(--accent-foreground);
            padding: var(--spacing-1) var(--spacing-2);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
        }

        .property-detail-modal__map-placeholder {
            width: 100%;
            height: 200px;
            background-color: var(--secondary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--muted-foreground);
            font-style: italic;
        }

        /* END: Property Detail Modal Specific Styling */

        /* BEGIN: Transaction Detail Modal Specific Styling */
        #transactionDetailModalDialog {
            max-width: 700px;
            /* Sedikit lebih kecil dari detail properti */
        }

        .transaction-detail-modal__info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            /* Dua kolom biasanya cukup */
            gap: var(--spacing-4);
        }

        .transaction-detail-modal__notes {
            background-color: var(--secondary);
            padding: var(--spacing-3);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            margin-top: var(--spacing-3);
        }

        /* END: Transaction Detail Modal Specific Styling */

        /* BEGIN: Payment Modal Styling */
        .payment-method-options {
            display: flex;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-4);
            justify-content: space-around;
            /* Or center */
        }

        .payment-method-options label {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--spacing-3);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-all);
            min-width: 120px;
            text-align: center;
        }

        .payment-method-options label:hover {
            border-color: var(--primary-hover);
            background-color: var(--accent);
        }

        .payment-method-options input[type="radio"] {
            appearance: none;
            /* Hide default radio */
            position: absolute;
            /* Take out of flow */
            opacity: 0;
            width: 0;
            height: 0;
        }

        .payment-method-options input[type="radio"]:checked+span {
            /* Style the span when radio is checked */
            /* No direct style here, rely on label's border or background */
        }

        .payment-method-options input[type="radio"]:checked~.payment-method-label {
            border-color: var(--primary);
            background-color: var(--accent-hover);
            box-shadow: 0 0 0 2px var(--primary);
        }

        .payment-method-options i {
            font-size: var(--font-size-2xl);
            margin-bottom: var(--spacing-2);
            color: var(--primary);
        }

        .payment-method-options span {
            font-weight: 500;
        }

        .payment-details-section {
            padding: var(--spacing-3);
            background-color: var(--secondary);
            border-radius: var(--radius-sm);
            margin-top: var(--spacing-3);
        }

        .payment-details-section p {
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-2);
        }

        .payment-details-section strong {
            color: var(--foreground);
        }

        .upload-area {
            border: 2px dashed var(--input-focus);
            padding: var(--spacing-4);
            text-align: center;
            border-radius: var(--radius-md);
            margin-top: var(--spacing-2);
            cursor: pointer;
            background-color: var(--background);
        }

        .upload-area:hover {
            border-color: var(--primary);
        }

        .upload-area i {
            font-size: var(--font-size-xl);
            color: var(--muted-foreground);
            display: block;
            margin-bottom: var(--spacing-2);
        }

        /* END: Payment Modal Styling */


        .modal__content {
            /* Konten utama modal, padding di sini */
            padding: var(--spacing-5);
            overflow-y: auto;
            /* Jika konten modal panjang */
            max-height: 85vh;
            /* Beri sedikit lebih banyak ruang untuk modal detail */
            /* Batas tinggi modal */
        }

        .modal__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: var(--spacing-3);
            border-bottom: 1px solid var(--border);
            margin-bottom: var(--spacing-4);
        }

        .modal__header .modal-title {
            /* Judul modal */
            font-size: var(--font-size-lg);
            font-weight: 600;
            margin-bottom: 0;
        }

        .modal__body {
            /* Ditambahkan untuk styling isi modal secara umum */
            /* Padding sudah ada di modal__content, ini lebih untuk struktur */
            /* Jika perlu, tambahkan styling spesifik di sini */
        }

        #alertModalOverlay .modal__body p {
            /* Styling teks pesan di alert modal */
            font-size: var(--font-size-base);
            color: var(--foreground);
            /* Lebih jelas dari muted-foreground */
            line-height: 1.6;
        }


        .modal__footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-3);
            padding-top: var(--spacing-4);
            border-top: 1px solid var(--border);
            margin-top: var(--spacing-4);
        }

        .form-group {
            margin-bottom: var(--spacing-4);
        }

        .form-label {
            font-weight: 500;
            margin-bottom: var(--spacing-2);
            display: block;
            font-size: var(--font-size-sm);
        }

        .form-control {
            /* Sudah ada style dasar, ini hanya jika perlu override */
        }

        .form-control.is-invalid {
            border-color: var(--destructive);
            box-shadow: 0 0 0 2px var(--destructive_hover);
            /* Atau ring warna destructive */
        }

        .invalid-feedback {
            color: var(--destructive);
            font-size: var(--font-size-sm);
            margin-top: var(--spacing-1);
            display: none;
        }

        .form-control.is-invalid+.invalid-feedback,
        /* Jika feedback setelah input */
        .is-invalid~.invalid-feedback

        /* Jika feedback di dalam group */
            {
            display: block;
        }


        /* Tombol (Buttons) */
        .btn {
            padding: var(--spacing-2) var(--spacing-4);
            border-radius: var(--radius-md);
            font-weight: 500;
            transition: background-color var(--transition-fast), border-color var(--transition-fast), color var(--transition-fast), transform 0.1s ease-out, box-shadow var(--transition-fast);
            line-height: 1.5;
            /* Pastikan tinggi konsisten */
            border: 1px solid transparent;
            /* Untuk outline button */
        }

        .btn i {
            /* Ikon di dalam tombol */
            font-size: var(--font-size-base);
            /* Sesuaikan ukuran ikon */
        }

        .btn--primary {
            background: var(--primary);
            color: var(--primary-foreground);
            border-color: var(--primary);
        }

        .btn--primary:hover {
            background: var(--primary-hover);
            border-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .btn--primary:active {
            background: var(--primary-active);
            border-color: var(--primary-active);
            transform: translateY(0px) scale(0.97);
            /* Adjusted for active state */
            box-shadow: var(--shadow-inner);
        }


        .btn--secondary {
            background: var(--secondary);
            color: var(--secondary-foreground);
            border-color: var(--border);
        }

        .btn--secondary:hover {
            background: var(--secondary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .btn--secondary:active {
            background: var(--secondary-active);
            transform: translateY(0px) scale(0.97);
            box-shadow: var(--shadow-inner);
        }

        .btn--danger {
            background: var(--destructive);
            color: var(--destructive-foreground);
            border-color: var(--destructive);
        }

        .btn--danger:hover {
            background: var(--destructive-hover);
            border-color: var(--destructive-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .btn--danger:active {
            background: var(--destructive-active);
            border-color: var(--destructive-active);
            transform: translateY(0px) scale(0.97);
            box-shadow: var(--shadow-inner);
        }


        .btn--outline-primary {
            background: transparent;
            color: var(--primary);
            border-color: var(--primary);
        }

        .btn--outline-primary:hover {
            background: var(--primary);
            color: var(--primary-foreground);
        }

        .btn--outline-primary:active {
            background: var(--primary-active);
            color: var(--primary-foreground);
            border-color: var(--primary-active);
        }


        .btn-sm {
            /* Tombol ukuran kecil */
            padding: var(--spacing-1) var(--spacing-2);
            font-size: var(--font-size-sm);
        }

        .btn-lg {
            /* Tombol ukuran besar */
            padding: var(--spacing-3) var(--spacing-5);
            font-size: var(--font-size-md);
        }

        .btn-close {
            /* Tombol close untuk modal, notifikasi */
            background: transparent;
            color: var(--muted-foreground);
            font-size: var(--font-size-xl);
            padding: var(--spacing-1);
            border-radius: var(--radius-full);
        }

        .btn-close:hover {
            color: var(--foreground);
            background: var(--secondary-hover);
        }

        .btn-close i {
            margin: 0;
        }


        .notification-toast {
            position: fixed;
            bottom: var(--spacing-5);
            /* Ubah ke bawah */
            right: var(--spacing-5);
            background: var(--card);
            border: 1px solid var(--border);
            border-left-width: 4px;
            /* Border kiri sebagai indikator tipe */
            padding: var(--spacing-3) var(--spacing-4);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: var(--z-toast);
            max-width: 400px;
            width: calc(100% - var(--spacing-10));
            display: none;
            /* Default tersembunyi */
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            /* NEW: Added scale for smoother entry */
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .notification-toast.show {
            display: flex;
            /* Menggunakan flex untuk align item */
            align-items: flex-start;
            /* Konten dan tombol close */
            gap: var(--spacing-3);
            opacity: 1;
            transform: translateY(0) scale(1);
            /* NEW: Added scale */
        }

        .notification-toast__icon {
            font-size: var(--font-size-lg);
            padding-top: var(--spacing-px);
            /* Penyesuaian alignment kecil */
        }

        .notification-toast__content {
            flex-grow: 1;
        }

        .notification-toast__title {
            font-weight: 600;
            margin-bottom: var(--spacing-1);
            display: block;
            /* Agar margin bottom bekerja */
        }

        .notification-toast__body {
            font-size: var(--font-size-sm);
            color: var(--muted-foreground);
        }

        .notification-toast__close-btn {
            /* Menggunakan .btn-close styling */
            margin-left: auto;
            /* Dorong ke kanan */
            align-self: flex-start;
        }

        .notification-toast--success {
            border-left-color: var(--success);
        }

        .notification-toast--success .notification-toast__icon {
            color: var(--success);
        }

        .notification-toast--warning {
            border-left-color: var(--warning);
        }

        .notification-toast--warning .notification-toast__icon {
            color: var(--warning);
        }

        .notification-toast--error {
            border-left-color: var(--destructive);
        }

        .notification-toast--error .notification-toast__icon {
            color: var(--destructive);
        }

        .notification-toast--info {
            border-left-color: var(--info);
        }

        .notification-toast--info .notification-toast__icon {
            color: var(--info);
        }

        /* ==========================================================================
           Struktur Halaman Pesan (Chatting)
           ========================================================================== */
        .messages-layout {
            display: flex;
            height: calc(100vh - var(--header-height) - var(--footer-height) - var(--spacing-5) * 2 - 50px);
            /* Estimasi tinggi untuk card title */
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            background: var(--card);
            overflow: hidden;
        }

        .messages-layout__sidebar {
            width: 300px;
            border-right: 1px solid var(--border);
            padding: var(--spacing-4);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .messages-layout__sidebar-header {
            margin-bottom: var(--spacing-3);
        }

        .messages-layout__sidebar-header input[type="search"] {
            font-size: var(--font-size-sm);
        }

        .messages-layout__conversation-list {
            list-style: none;
            flex-grow: 1;
        }

        .messages-layout__conversation-item {
            padding: var(--spacing-3);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-all), transform 0.15s ease-out;
            /* NEW */
            margin-bottom: var(--spacing-1);
            border: 1px solid transparent;
            /* For active state */
        }

        .messages-layout__conversation-item:hover {
            background-color: var(--accent-hover);
            transform: translateX(4px);
            /* NEW: Subtle hover indication */
        }

        .messages-layout__conversation-item:active {
            transform: translateX(2px) scale(0.99);
            /* NEW: Press effect */
        }

        .messages-layout__conversation-item.active {
            background-color: var(--primary);
            color: var(--primary-foreground);
            border-color: var(--primary-hover);
        }

        .messages-layout__conversation-item.active:hover {
            /* NEW */
            transform: none;
        }

        .messages-layout__conversation-item strong {
            display: block;
            font-weight: 600;
            font-size: var(--font-size-base);
            margin-bottom: var(--spacing-1);
        }

        .messages-layout__conversation-item p {
            font-size: var(--font-size-sm);
            color: var(--muted-foreground);
            /* Default */
            margin-bottom: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .messages-layout__conversation-item.active p {
            color: var(--primary-foreground);
            opacity: 0.8;
        }

        .messages-layout__chat-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: var(--spacing-4);
        }

        .messages-layout__chat-header {
            padding-bottom: var(--spacing-3);
            border-bottom: 1px solid var(--border);
            margin-bottom: var(--spacing-3);
        }

        .messages-layout__chat-header h3 {
            margin-bottom: 0;
            font-size: var(--font-size-lg);
        }

        .messages-layout__message-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: var(--spacing-2) var(--spacing-1);
            /* Adjusted padding for bubble animation */
            display: flex;
            flex-direction: column;
        }

        .messages-layout__message {
            max-width: 70%;
            padding: var(--spacing-2) var(--spacing-3);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-2);
            line-height: 1.4;
            opacity: 0;
            /* Start hidden for animation */
            transform-origin: bottom;
            /* For scale animation */
        }

        .messages-layout__message.message-arriving {
            /* NEW: For new message animation */
            animation: slideInFromBottom 0.3s ease-out forwards;
        }

        .messages-layout__message--sent.message-arriving {
            animation-name: slideInFromRight;
            /* Override for sent messages */
            transform-origin: bottom right;
        }

        .messages-layout__message--received.message-arriving {
            animation-name: slideInFromLeft;
            /* Override for received messages */
            transform-origin: bottom left;
        }

        .messages-layout__message--sent {
            background-color: var(--primary);
            color: var(--primary-foreground);
            align-self: flex-end;
            border-bottom-right-radius: var(--radius-sm);
        }

        .messages-layout__message--received {
            background-color: var(--secondary);
            color: var(--secondary-foreground);
            align-self: flex-start;
            border-bottom-left-radius: var(--radius-sm);
        }

        .messages-layout__message-meta {
            font-size: var(--font-size-xs);
            color: var(--muted-foreground);
            margin-top: var(--spacing-1);
            text-align: right;
        }

        .messages-layout__message--sent .messages-layout__message-meta {
            color: var(--primary-foreground);
            opacity: 0.7;
        }

        /* NEW: Typing indicator */
        .messages-layout__message--typing {
            padding: var(--spacing-2) var(--spacing-3);
            display: flex;
            align-items: center;
            gap: var(--spacing-1);
        }

        .messages-layout__message--typing .typing-dot {
            width: 8px;
            height: 8px;
            background-color: var(--muted-foreground);
            border-radius: 50%;
            animation: typingDots 1.2s infinite ease-in-out;
        }

        .messages-layout__message--typing .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .messages-layout__message--typing .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }


        .messages-layout__message-input-area {
            display: flex;
            gap: var(--spacing-2);
            padding-top: var(--spacing-3);
            border-top: 1px solid var(--border);
            margin-top: var(--spacing-2);
        }

        .messages-layout__message-input-area textarea {
            flex-grow: 1;
            resize: none;
            min-height: 40px;
            max-height: 120px;
            font-size: var(--font-size-sm);
        }

        .messages-layout__message-input-area button {
            height: 40px;
            /* Align with textarea approx height */
        }

        .messages-layout__no-chat-selected {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: var(--muted-foreground);
            text-align: center;
        }

        .messages-layout__no-chat-selected i {
            font-size: 3rem;
            margin-bottom: var(--spacing-3);
        }

        /* ==========================================================================
           Halaman Settings
           ========================================================================== */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-5);
        }

        .settings-category {
            /* Adalah .card */
        }

        .settings-category .card-title {
            font-size: var(--font-size-lg);
            /* Sedikit lebih besar dari default card-title */
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-3) 0;
            border-bottom: 1px solid var(--border);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item strong {
            /* Sudah diatur di atas */
            margin-bottom: 0;
            /* Override default margin-bottom dari strong */
        }

        .settings-item p {
            /* Sudah diatur di atas */
            font-size: var(--font-size-sm);
            color: var(--muted-foreground);
            margin-bottom: 0;
        }

        .settings-item-content {
            flex-grow: 1;
        }

        .settings-item-action {
            margin-left: var(--spacing-3);
            flex-shrink: 0;
            /* Agar tidak mengecil */
        }

        /* Toggle Switch (untuk settings) */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--input);
            transition: .4s;
            border-radius: var(--radius-full);
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .toggle-switch input:checked+.toggle-slider {
            background-color: var(--primary);
        }

        .toggle-switch input:focus+.toggle-slider {
            box-shadow: 0 0 1px var(--primary);
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(22px);
        }

        /* ==========================================================================
           Floating Customer Service Chat Widget
           ========================================================================== */
        .cs-chat-widget {
            position: fixed;
            bottom: var(--spacing-5);
            right: var(--spacing-5);
            z-index: var(--z-chat-widget);
        }

        .cs-chat-widget__toggle-btn {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-full);
            background-color: var(--primary);
            color: var(--primary-foreground);
            box-shadow: var(--shadow-lg);
            font-size: var(--font-size-xl);
            transition: var(--transition-all);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cs-chat-widget__toggle-btn:hover {
            background-color: var(--primary-hover);
            transform: scale(1.1);
        }

        .cs-chat-widget__popup {
            position: absolute;
            bottom: calc(100% + var(--spacing-3));
            /* Above the toggle button */
            right: 0;
            width: 350px;
            max-height: 500px;
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            visibility: hidden;
            transition: var(--transition-all);
        }

        .cs-chat-widget__popup.open {
            opacity: 1;
            transform: translateY(0) scale(1);
            visibility: visible;
        }

        .cs-chat-widget__header {
            padding: var(--spacing-3) var(--spacing-4);
            background-color: var(--primary);
            color: var(--primary-foreground);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cs-chat-widget__header h3 {
            font-size: var(--font-size-md);
            margin: 0;
        }

        .cs-chat-widget__close-btn {
            color: var(--primary-foreground);
            opacity: 0.8;
            font-size: var(--font-size-lg);
            padding: var(--spacing-1);
        }

        .cs-chat-widget__close-btn:hover {
            opacity: 1;
        }

        .cs-chat-widget__messages {
            flex-grow: 1;
            padding: var(--spacing-3);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-2);
        }

        .cs-chat-widget__message {
            max-width: 80%;
            padding: var(--spacing-2) var(--spacing-3);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            line-height: 1.5;
            opacity: 0;
            /* Start hidden for animation */
        }

        .cs-chat-widget__message.message-arriving {
            /* NEW: For new message animation */
            animation: slideInFromBottom 0.3s ease-out forwards;
        }

        .cs-chat-widget__message.user {
            background-color: var(--accent);
            color: var(--accent-foreground);
            align-self: flex-end;
            border-bottom-right-radius: var(--radius-sm);
        }

        .cs-chat-widget__message.user.message-arriving {
            animation-name: slideInFromRight;
            transform-origin: bottom right;
        }

        .cs-chat-widget__message.cs {
            background-color: var(--secondary);
            color: var(--secondary-foreground);
            align-self: flex-start;
            border-bottom-left-radius: var(--radius-sm);
        }

        .cs-chat-widget__message.cs.message-arriving {
            animation-name: slideInFromLeft;
            transform-origin: bottom left;
        }

        /* NEW: CS Typing indicator */
        .cs-chat-widget__message.cs-typing {
            padding: var(--spacing-2) var(--spacing-3);
            display: flex;
            align-items: center;
            gap: var(--spacing-1);
            background-color: var(--secondary);
            color: var(--secondary-foreground);
            align-self: flex-start;
            border-bottom-left-radius: var(--radius-sm);
        }

        .cs-chat-widget__message.cs-typing .typing-dot {
            width: 7px;
            height: 7px;
            background-color: var(--muted-foreground);
            border-radius: 50%;
            animation: typingDots 1.2s infinite ease-in-out;
        }

        .cs-chat-widget__message.cs-typing .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .cs-chat-widget__message.cs-typing .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }


        .cs-chat-widget__message-time {
            display: block;
            font-size: var(--font-size-xs);
            color: var(--muted-foreground);
            margin-top: var(--spacing-1);
            text-align: inherit;
            /* Inherits from parent's align-self */
        }

        .cs-chat-widget__message.user .cs-chat-widget__message-time {
            text-align: right;
        }

        .cs-chat-widget__message.cs .cs-chat-widget__message-time {
            text-align: left;
        }

        .cs-chat-widget__input-area {
            padding: var(--spacing-3);
            border-top: 1px solid var(--border);
            display: flex;
            gap: var(--spacing-2);
        }

        .cs-chat-widget__input-area input[type="text"] {
            flex-grow: 1;
            font-size: var(--font-size-sm);
            padding: var(--spacing-2);
        }

        .cs-chat-widget__input-area button {
            padding: var(--spacing-2);
            min-width: auto;
            /* Reset min-width from .btn */
        }


        .app-footer {
            background: var(--background);
            /* Footer lebih menyatu dengan background utama */
            border-top: 1px solid var(--border);
            padding: var(--spacing-4);
            text-align: center;
            height: var(--footer-height);
            color: var(--muted-foreground);
            font-size: var(--font-size-sm);
            margin-top: auto;
            /* Mendorong footer ke bawah jika konten pendek */
        }


        /* ==========================================================================
           Desain Responsif
           ========================================================================== */
        /* Tablet dan layar lebih kecil */
        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                /* Kembali ke fixed untuk mobile overlay */
                left: 0;
                top: 0;
                transform: translateX(-100%);
                /* Default tersembunyi */
                z-index: var(--z-fixed);
                /* Di atas segalanya kecuali modal */
            }

            .sidebar.show {
                /* Kelas untuk menampilkan sidebar di mobile */
                transform: translateX(0);
            }

            .main-wrapper {
                /* margin-left: 0; Tidak perlu karena sidebar fixed */
            }

            .app-header .search-bar {
                display: none;
                /* Sembunyikan search bar di header tablet untuk ruang */
            }

            /* BEGIN: Property Detail Modal Responsive */
            #propertyDetailModalDialog {
                max-width: calc(100% - var(--spacing-6));
            }

            .property-detail-modal__main-image-container {
                height: 250px;
            }

            /* END: Property Detail Modal Responsive */
            .messages-layout__sidebar {
                width: 250px;
            }

            .settings-grid {
                grid-template-columns: 1fr;
                /* Satu kolom di tablet */
            }
        }

        /* Mobile */
        @media (max-width: 768px) {
            :root {
                --header-height: 60px;
                /* Header lebih kecil di mobile */
            }

            .app-header {
                padding: 0 var(--spacing-3);
            }

            .profile-dropdown__toggle span {
                /* Sembunyikan nama pengguna, tampilkan avatar saja */
                display: none;
            }

            .main-content {
                padding: var(--spacing-4);
            }

            .stats-grid {
                grid-template-columns: 1fr;
                /* Satu kolom di mobile */
            }

            .apartments-grid {
                grid-template-columns: 1fr;
                /* Satu kolom di mobile */
            }

            .filter-section {
                flex-direction: column;
                gap: var(--spacing-3);
            }

            .filter-section select,
            .filter-section button {
                width: 100%;
            }

            .modal__dialog {
                /* Berlaku untuk semua modal */
                max-width: calc(100% - var(--spacing-4));
                margin: var(--spacing-2);
            }

            #paymentModalDialog {
                /* Sesuaikan modal pembayaran juga */
                max-width: calc(100% - var(--spacing-4));
            }

            .payment-method-options {
                flex-direction: column;
                /* Stack payment options on mobile */
            }

            #alertModalOverlay .modal__dialog {
                /* Khusus alert modal, bisa lebih sempit */
                max-width: calc(100% - var(--spacing-6));
                /* Contoh, sedikit lebih sempit */
            }

            /* BEGIN: Property Detail Modal Responsive Mobile */
            #propertyDetailModalDialog {
                max-width: calc(100% - var(--spacing-4));
                /* Sesuaikan dengan .modal__dialog umum */
            }

            #transactionDetailModalDialog {
                /* Responsif untuk modal detail transaksi */
                max-width: calc(100% - var(--spacing-4));
            }

            .property-detail-modal__main-image-container {
                height: 200px;
            }

            .property-detail-modal__gallery {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            }

            .property-detail-modal__gallery img {
                height: 60px;
            }

            /* END: Property Detail Modal Responsive Mobile */


            .notification-toast {
                right: var(--spacing-2);
                left: var(--spacing-2);
                bottom: var(--spacing-2);
                width: auto;
                /* Mengisi lebar dengan margin */
                max-width: none;
            }

            .btn-sm {
                /* Ukuran tombol kecil lebih sering dipakai di mobile */
                padding: var(--spacing-2) var(--spacing-3);
            }

            .messages-layout {
                flex-direction: column;
                height: calc(100vh - var(--header-height) - var(--spacing-4) * 2 - 40px);
                /* Adjust for mobile */
            }

            .messages-layout__sidebar {
                width: 100%;
                height: 200px;
                /* Fixed height for conversation list on mobile */
                border-right: none;
                border-bottom: 1px solid var(--border);
            }

            .cs-chat-widget__popup {
                width: calc(100vw - var(--spacing-8));
                max-width: 320px;
                bottom: calc(100% + var(--spacing-2));
            }

            .cs-chat-widget {
                bottom: var(--spacing-3);
                right: var(--spacing-3);
            }

            .cs-chat-widget__toggle-btn {
                width: 50px;
                height: 50px;
                font-size: var(--font-size-lg);
            }
        }

        /* Untuk sidebar collapsed yang menampilkan ikon saja, bisa ditambahkan style di sini */
        /* @media (min-width: 1025px) {
            .sidebar.collapsed {
                width: var(--sidebar-width-collapsed);
                transform: translateX(0);
            }
            .sidebar.collapsed .sidebar-brand__icon {
                margin: 0 auto;
            }
            .sidebar.collapsed .nav-link {
                justify-content: center;
            }
            .main-wrapper.sidebar-collapsed {
                margin-left: var(--sidebar-width-collapsed);
            }
        } */


        /* ==========================================================================
           Aksesibilitas Tambahan & Preferensi Pengguna
           ========================================================================== */
        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                /* Hanya sekali animasi */
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
                /* Nonaktifkan smooth scrolling */
            }
        }

        /* Fokus terlihat jelas untuk pengguna keyboard */
        :focus-visible {
            outline: 3px solid var(--primary);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px var(--background), 0 0 0 6px var(--primary) !important;
            /* !important untuk override */
            border-radius: var(--radius-sm);
        }

        /* Khusus untuk input yang sudah punya style fokus sendiri */
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            box-shadow: 0 0 0 2px var(--ring) !important;
        }


        /* ==========================================================================
           Gaya Cetak (Print Styles)
           ========================================================================== */
        @media print {
            body {
                background-color: #fff;
                /* Background putih untuk cetak */
                color: #000;
                /* Teks hitam */
                display: block;
                /* Reset flex display */
            }

            .sidebar,
            .app-header,
            .app-footer,
            .no-print,
            .theme-toggle,
            #sidebarToggle,
            .profile-dropdown,
            .cs-chat-widget,
            /* Sembunyikan chat widget saat print */
            .modal-overlay

            /* Sembunyikan semua modal saat print */
                {
                display: none !important;
                /* Sembunyikan elemen yang tidak perlu dicetak */
            }

            .main-wrapper {
                /* margin-left: 0; Tidak relevan karena display block */
                height: auto;
                overflow-y: visible;
            }

            .main-content {
                padding: 0;
            }

            .card,
            .table-container {
                box-shadow: none;
                border: 1px solid #ccc;
            }

            a {
                color: #000;
                text-decoration: underline;
            }

            a[href^="http"]::after {
                content: " (" attr(href) ")";
                /* Tampilkan URL untuk link eksternal */
                font-size: 0.8em;
            }
        }
    </style>
</head>

<body>
    <!-- Sidebar Navigasi Utama -->
    <aside class="sidebar" id="sidebar" aria-label="Navigasi Utama">
        <!-- ... Konten Sidebar ... -->
        <div class="sidebar-brand">
            <i class="fas fa-home-lg-alt sidebar-brand__icon" aria-hidden="true"></i>
            <!-- Menggunakan ikon yang lebih relevan -->
            <span class="sidebar-brand__text">Green Valley</span>
        </div>
        <nav aria-label="Menu Aplikasi">
            <ul class="nav-menu">
                <li class="nav-item"><a href="#dashboard" class="nav-link active" data-page="dashboard"><i
                            class="fas fa-tachometer-alt fa-fw" aria-hidden="true"></i>
                        <span>Dashboard</span></a></li>
                <li class="nav-item"><a href="#properties" class="nav-link" data-page="properties"><i
                            class="fas fa-building fa-fw" aria-hidden="true"></i> <span>Properti</span></a></li>
                <li class="nav-item"><a href="#bookings" class="nav-link" data-page="bookings"><i
                            class="fas fa-calendar-check fa-fw" aria-hidden="true"></i> <span>Booking</span></a>
                </li>
                <li class="nav-item"><a href="#favorites" class="nav-link" data-page="favorites"><i
                            class="fas fa-heart fa-fw" aria-hidden="true"></i> <span>Favorit</span></a></li>
                <li class="nav-item"><a href="#payments" class="nav-link" data-page="payments"><i
                            class="fas fa-credit-card fa-fw" aria-hidden="true"></i> <span>Pembayaran</span></a>
                </li>
                <li class="nav-item"><a href="#maintenance" class="nav-link" data-page="maintenance"><i
                            class="fas fa-tools fa-fw" aria-hidden="true"></i> <span>Maintenance</span></a></li>
                <li class="nav-item"><a href="#messages" class="nav-link" data-page="messages"><i
                            class="fas fa-envelope fa-fw" aria-hidden="true"></i> <span>Pesan</span></a></li>
                <li class="nav-item"><a href="#profile" class="nav-link" data-page="profile"><i
                            class="fas fa-user-circle fa-fw" aria-hidden="true"></i> <span>Profil
                            Saya</span></a></li>
                <li class="nav-item"><a href="#settings" class="nav-link" data-page="settings"><i
                            class="fas fa-cog fa-fw" aria-hidden="true"></i> <span>Pengaturan</span></a></li>
            </ul>
        </nav>
    </aside>

    <!-- Kontainer Utama Aplikasi -->
    <div class="main-wrapper" id="mainWrapper">
        <!-- Header Aplikasi -->
        <header class="app-header">
            <div class="header-left">
                <button type="button" class="btn btn--secondary btn-icon no-print" id="sidebarToggle"
                    aria-label="Buka atau Tutup Navigasi" aria-expanded="true">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="search-bar">
                    <i class="fas fa-search" aria-hidden="true"></i>
                    <input type="search" id="searchInput" placeholder="Cari properti, penyewa..."
                        aria-label="Pencarian global">
                </div>
            </div>
            <div class="header-right">
                <button type="button" class="theme-toggle no-print" id="themeToggleBtn"
                    aria-label="Ganti Tema Gelap/Terang">
                    <i class="fas fa-moon"></i> <!-- Ikon akan diubah oleh JS -->
                </button>
                <div class="profile-dropdown">
                    <button type="button" class="profile-dropdown__toggle" id="profileDropdownToggle"
                        aria-haspopup="true" aria-expanded="false" aria-controls="profileDropdownMenu">
                        <img src="https://i.pravatar.cc/40?u=Green Valleyuser" alt="Avatar Pengguna" width="40"
                            height="40" id="headerUserAvatar">
                        <span id="headerUserName">Pengguna Terhormat</span>
                        <i class="fas fa-chevron-down fa-xs" aria-hidden="true"></i>
                    </button>
                    <div class="profile-dropdown__menu" id="profileDropdownMenu" role="menu"
                        aria-labelledby="profileDropdownToggle">
                        <a href="#profile" class="profile-dropdown__item" role="menuitem" data-page-nav="profile"><i
                                class="fas fa-user-edit fa-fw" aria-hidden="true"></i>
                            Profil Saya</a>
                        <a href="#settings" class="profile-dropdown__item" role="menuitem" data-page-nav="settings"><i
                                class="fas fa-cog fa-fw" aria-hidden="true"></i>
                            Pengaturan Akun</a>
                        <div class="profile-dropdown__divider" role="separator"></div>
                        <a href="#logout" id="logoutButton" class="profile-dropdown__item" role="menuitem"><i
                                class="fas fa-sign-out-alt fa-fw" aria-hidden="true"></i> Logout</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Konten Utama Halaman -->
        <main class="main-content" id="pageContentContainer" role="main" aria-live="polite">
            <!-- ... Konten Halaman (Dashboard, Properties, dll.) ... -->
            <section id="dashboard-content" class="page-section active" aria-labelledby="dashboard-title">
                <h1 id="dashboard-title">Dashboard</h1>
                <div class="stats-grid">
                    <div class="card">
                        <h3 class="card-title">Booking Aktif</h3>
                        <p class="lead" data-stat="activeBookings">12</p>
                        <small class="text-muted">Total booking yang sedang berjalan.</small>
                    </div>
                    <div class="card">
                        <h3 class="card-title">Pembayaran Tertunda</h3>
                        <p class="lead" data-stat="pendingPayments">3</p>
                        <small class="text-muted">Jumlah tagihan yang belum dibayar.</small>
                    </div>
                    <div class="card">
                        <h3 class="card-title">Permintaan Maintenance</h3>
                        <p class="lead" data-stat="maintenanceRequests">5</p>
                        <small class="text-muted">Laporan kerusakan yang perlu ditangani.</small>
                    </div>
                    <div class="card">
                        <h3 class="card-title">Properti Favorit</h3>
                        <p class="lead" data-stat="favoriteProperties">8</p>
                        <small class="text-muted">Properti yang Anda simpan.</small>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Aktivitas Terbaru</h2>
                        <p class="card-description">Monitor kegiatan penting dalam sistem.</p>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Aktivitas</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="activityTableBody">
                                <!-- Diisi JS jika perlu dinamis, saat ini statis -->
                                <tr>
                                    <td>2025-05-27</td>
                                    <td>Booking Properti "Apartemen Harmoni A-101" oleh Budi Santoso</td>
                                    <td><span class="badge badge--active">Aktif</span></td>
                                </tr>
                                <tr>
                                    <td>2025-05-26</td>
                                    <td>Pembayaran sewa untuk "Villa Damai Blok C2" telah diterima</td>
                                    <td><span class="badge badge--lunas">Lunas</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="properties-content" class="page-section" style="display: none;"
                aria-labelledby="properties-title">
                <h1 id="properties-title">Daftar Properti</h1>
                <div class="filter-section">
                    <select id="priceRangeFilter" aria-label="Filter berdasarkan rentang harga">
                        <option value="">Semua Harga</option>
                        <option value="0-5000000">Di bawah Rp 5jt</option>
                        <option value="5000000-10000000">Rp 5jt - 10jt</option>
                        <option value="10000000-20000000">Rp 10jt - 20jt</option>
                        <option value="20000000-Infinity">Diatas Rp 20jt</option>
                    </select>
                    <select id="bedroomsFilter" aria-label="Filter berdasarkan jumlah kamar tidur">
                        <option value="">Semua Kamar</option>
                        <option value="1">1 Kamar Tidur</option>
                        <option value="2">2 Kamar Tidur</option>
                        <option value="3-Infinity">3+ Kamar Tidur</option>
                    </select>
                    <select id="amenitiesFilter" aria-label="Filter berdasarkan fasilitas">
                        <option value="">Semua Fasilitas</option>
                        <option value="parking">Parkir</option>
                        <option value="gym">Gym</option>
                        <option value="pool">Kolam Renang</option>
                        <option value="furnished">Full Furnished</option>
                    </select>
                    <button type="button" class="btn btn--primary" id="applyFilterBtn"><i class="fas fa-filter"></i>
                        Terapkan Filter</button>
                </div>
                <div class="apartments-grid" id="propertiesGrid">
                    <div class="loading-placeholder" style="grid-column: 1 / -1;">
                        <i class="fas fa-spinner fa-spin"></i> Memuat properti...
                    </div>
                </div>
                <div class="card mt-5" style="margin-top: var(--spacing-6)">
                    <h2 class="card-title">Baru Dilihat</h2>
                    <div class="apartments-grid" id="recentlyViewedGrid">
                        <div class="loading-placeholder" style="grid-column: 1 / -1;">
                            <i class="fas fa-history"></i> Anda belum melihat properti apa pun baru-baru ini.
                        </div>
                    </div>
                </div>
            </section>

            <section id="profile-content" class="page-section" style="display: none;" aria-labelledby="profile-title">
                <h1 id="profile-title">Profil Pengguna</h1>
                <div class="card">
                    <div
                        style="display: flex; align-items: center; gap: var(--spacing-4); margin-bottom: var(--spacing-5);">
                        <img src="https://i.pravatar.cc/100?u=Green Valleyuser" alt="Avatar Pengguna"
                            id="profileUserAvatar"
                            style="width: 100px; height: 100px; border-radius: var(--radius-full); object-fit: cover; border: 3px solid var(--primary);">
                        <div>
                            <h2 class="card-title" id="profileUserNameDisplay" style="margin-bottom: var(--spacing-1);">
                                Pengguna Terhormat</h2>
                            <p id="profileUserEmailDisplay" style="margin-bottom: 0; color: var(--muted-foreground);">
                                pengguna@example.com</p>
                        </div>
                    </div>

                    <div class="profile-info-item">
                        <strong>Nama Lengkap:</strong>
                        <p id="profileFullNameDisplay">Pengguna Terhormat</p>
                    </div>
                    <div class="profile-info-item">
                        <strong>Email:</strong>
                        <p id="profileEmailDisplay">pengguna@example.com</p>
                    </div>
                    <div class="profile-info-item">
                        <strong>Nomor Telepon:</strong>
                        <p id="profilePhoneDisplay">0812-3456-7890</p>
                    </div>
                    <div class="profile-info-item">
                        <strong>Bergabung Sejak:</strong>
                        <p id="profileJoinedDateDisplay">1 Januari 2024</p>
                    </div>
                    <button type="button" class="btn btn--primary" id="editProfileBtn"
                        style="margin-top: var(--spacing-3);">
                        <i class="fas fa-edit"></i> Edit Profil
                    </button>
                </div>
            </section>

            <section id="bookings-content" class="page-section" style="display: none;" aria-labelledby="bookings-title">
                <h1 id="bookings-title">Manajemen Booking</h1>
                <div class="card">
                    <div class="card-header"
                        style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-2);">
                        <div>
                            <h2 class="card-title">Daftar Booking Anda</h2>
                            <p class="card-description">Kelola semua jadwal booking properti.</p>
                        </div>
                        <button type="button" class="btn btn--primary" id="addBookingBtn"><i class="fas fa-plus"></i>
                            Tambah Booking Baru</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID Booking</th>
                                    <th>Nama Penyewa</th>
                                    <th>Properti</th>
                                    <th>Tanggal</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="bookingTableBody">
                                <tr>
                                    <td colspan="6" class="loading-placeholder">
                                        <i class="fas fa-spinner fa-spin"></i> Memuat data booking...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="favorites-content" class="page-section" style="display: none;"
                aria-labelledby="favorites-title">
                <h1 id="favorites-title">Properti Favorit Saya</h1>
                <p class="lead" style="margin-bottom: var(--spacing-4);">Ini adalah daftar properti yang telah Anda
                    simpan sebagai favorit.</p>
                <div class="apartments-grid" id="favoritesGrid">
                    <div class="loading-placeholder" style="grid-column: 1 / -1;">
                        <i class="fas fa-heart-broken"></i> Anda belum memiliki properti favorit.
                    </div>
                </div>
            </section>

            <section id="payments-content" class="page-section" style="display: none;" aria-labelledby="payments-title">
                <h1 id="payments-title">Riwayat Pembayaran</h1>
                <div class="card">
                    <h2 class="card-title">Riwayat Transaksi Keuangan</h2>
                    <p class="card-description">Semua catatan pembayaran sewa dan tagihan lainnya.</p>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID Transaksi</th>
                                    <th>Tanggal</th>
                                    <th>Deskripsi</th>
                                    <th>Jumlah</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="paymentTableBody">
                                <!-- Data akan diisi oleh JavaScript -->
                                <tr>
                                    <td colspan="6" class="loading-placeholder">
                                        <i class="fas fa-spinner fa-spin"></i> Memuat riwayat pembayaran...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="maintenance-content" class="page-section" style="display: none;"
                aria-labelledby="maintenance-title">
                <h1 id="maintenance-title">Permintaan Maintenance</h1>
                <div class="card">
                    <div class="card-header"
                        style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-2);">
                        <div>
                            <h2 class="card-title">Laporan & Status Perbaikan</h2>
                            <p class="card-description">Lacak semua permintaan perbaikan dan status pengerjaannya.</p>
                        </div>
                        <button type="button" class="btn btn--primary" id="addMaintenanceRequestBtn"><i
                                class="fas fa-plus"></i> Buat Permintaan Baru</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID Laporan</th>
                                    <th>Tanggal</th>
                                    <th>Properti</th>
                                    <th>Deskripsi</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="maintenanceTableBody">
                                <tr>
                                    <td colspan="6" class="loading-placeholder">
                                        <i class="fas fa-tools"></i> Tidak ada permintaan maintenance.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="messages-content" class="page-section" style="display: none;" aria-labelledby="messages-title">
                <h1 id="messages-title">Kotak Pesan</h1>
                <div class="card" style="padding: 0;"> <!-- Remove card padding for full layout control -->
                    <div class="messages-layout">
                        <aside class="messages-layout__sidebar" id="messagesSidebar">
                            <div class="messages-layout__sidebar-header">
                                <input type="search" id="conversationSearchInput" placeholder="Cari percakapan..."
                                    aria-label="Cari percakapan">
                            </div>
                            <ul class="messages-layout__conversation-list" id="conversationList">
                                <!-- Conversation items will be rendered here by JS -->
                                <li class="loading-placeholder" style="height: 100%;"><i
                                        class="fas fa-spinner fa-spin"></i></li>
                            </ul>
                        </aside>
                        <main class="messages-layout__chat-area" id="chatArea">
                            <div class="messages-layout__no-chat-selected" id="noChatSelected">
                                <i class="fas fa-comments"></i>
                                <p>Pilih percakapan untuk memulai chat atau buat pesan baru.</p>
                                <button type="button" class="btn btn--primary" id="createNewMessageBtn"><i
                                        class="fas fa-plus"></i> Buat Pesan Baru</button>
                            </div>
                            <div id="activeChatContent"
                                style="display: none; height: 100%; flex-direction: column; display:flex;">
                                <div class="messages-layout__chat-header" id="chatHeader">
                                    <h3 id="chatPartnerName">Nama Kontak</h3>
                                    <!-- Bisa tambahkan info status online atau avatar di sini -->
                                </div>
                                <div class="messages-layout__message-list" id="messageList">
                                    <!-- Messages will be rendered here by JS -->
                                </div>
                                <form class="messages-layout__message-input-area" id="messageInputForm">
                                    <textarea id="messageInput" placeholder="Ketik pesan Anda..."
                                        aria-label="Ketik pesan Anda" rows="1"></textarea>
                                    <button type="submit" class="btn btn--primary" aria-label="Kirim Pesan"><i
                                            class="fas fa-paper-plane"></i></button>
                                </form>
                            </div>
                        </main>
                    </div>
                </div>
            </section>

            <section id="settings-content" class="page-section" style="display: none;" aria-labelledby="settings-title">
                <h1 id="settings-title">Pengaturan Akun</h1>
                <p class="lead" style="margin-bottom: var(--spacing-4);">Kelola preferensi aplikasi dan keamanan akun
                    Anda.</p>

                <div class="settings-grid">
                    <div class="settings-category card">
                        <h2 class="card-title"><i class="fas fa-bell"
                                style="margin-right: var(--spacing-2);"></i>Notifikasi</h2>
                        <div class="settings-item">
                            <div class="settings-item-content">
                                <strong>Notifikasi Email</strong>
                                <p>Terima pembaruan penting melalui email.</p>
                            </div>
                            <div class="settings-item-action">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="settingEmailNotifications"
                                        data-setting="emailNotifications">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-content">
                                <strong>Notifikasi Push Aplikasi</strong>
                                <p>Dapatkan pemberitahuan langsung di perangkat Anda (fitur simulasi).</p>
                            </div>
                            <div class="settings-item-action">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="settingPushNotifications"
                                        data-setting="pushNotifications">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="settings-category card">
                        <h2 class="card-title"><i class="fas fa-shield-alt"
                                style="margin-right: var(--spacing-2);"></i>Keamanan</h2>
                        <div class="settings-item">
                            <div class="settings-item-content">
                                <strong>Ganti Password</strong>
                                <p>Ubah kata sandi akun Anda secara berkala.</p>
                            </div>
                            <div class="settings-item-action">
                                <button class="btn btn--secondary btn-sm" id="changePasswordBtn"><i
                                        class="fas fa-key"></i> Ubah</button>
                            </div>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-content">
                                <strong>Autentikasi Dua Faktor (2FA)</strong>
                                <p>Tambahkan lapisan keamanan ekstra (fitur simulasi).</p>
                            </div>
                            <div class="settings-item-action">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="settingTwoFactorAuth" data-setting="twoFactorAuth"
                                        disabled> <!-- Disabled for demo simplicity -->
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="settings-category card">
                        <h2 class="card-title"><i class="fas fa-paint-brush"
                                style="margin-right: var(--spacing-2);"></i>Tampilan & Aksesibilitas</h2>
                        <div class="settings-item">
                            <div class="settings-item-content">
                                <strong>Tema Aplikasi</strong>
                                <p>Pilih antara tema terang atau gelap.</p>
                            </div>
                            <div class="settings-item-action">
                                <button class="btn btn--secondary btn-sm" id="settingThemeToggleBtn"><i
                                        class="fas fa-adjust"></i> Ganti Tema</button>
                            </div>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-content">
                                <strong>Ukuran Font</strong>
                                <p>Sesuaikan ukuran teks aplikasi (fitur simulasi).</p>
                            </div>
                            <div class="settings-item-action">
                                <select id="settingFontSize" class="form-control" style="width: auto; min-width: 100px;"
                                    disabled>
                                    <option value="normal">Normal</option>
                                    <option value="large">Besar</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="settings-category card">
                        <h2 class="card-title"><i class="fas fa-globe"
                                style="margin-right: var(--spacing-2);"></i>Bahasa & Wilayah</h2>
                        <div class="settings-item">
                            <div class="settings-item-content">
                                <strong>Bahasa Aplikasi</strong>
                                <p>Pilih bahasa antarmuka.</p>
                            </div>
                            <div class="settings-item-action">
                                <select id="settingLanguage" class="form-control" style="width: auto; min-width: 120px;"
                                    data-setting="language">
                                    <option value="id">Indonesia</option>
                                    <option value="en">English (US)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="settings-category card">
                        <h2 class="card-title"><i class="fas fa-info-circle"
                                style="margin-right: var(--spacing-2);"></i>Tentang & Bantuan</h2>
                        <div class="settings-item">
                            <div class="settings-item-content">
                                <strong>Versi Aplikasi</strong>
                                <p id="appVersionDisplay">1.5.0 (Fitur Interaktif Ditingkatkan)</p>
                            </div>
                        </div>
                        <div class="settings-item">
                            <a href="#faq" class="profile-dropdown__item"
                                style="padding: var(--spacing-3) 0; width:100%; color: var(--foreground);"><i
                                    class="fas fa-question-circle fa-fw"></i> Pertanyaan Umum (FAQ)</a>
                        </div>
                        <div class="settings-item">
                            <a href="#privacy" class="profile-dropdown__item"
                                style="padding: var(--spacing-3) 0; width:100%; color: var(--foreground);"><i
                                    class="fas fa-user-secret fa-fw"></i> Kebijakan Privasi</a>
                        </div>
                        <div class="settings-item">
                            <a href="#terms" class="profile-dropdown__item"
                                style="padding: var(--spacing-3) 0; width:100%; color: var(--foreground);"><i
                                    class="fas fa-file-contract fa-fw"></i> Syarat & Ketentuan</a>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="app-footer no-print">
            <small>&copy; <span id="currentYear">2024</span> Green Valley Platform. Hak Cipta Dilindungi
                Undang-Undang. Dirancang dengan <i class="fas fa-heart" style="color:var(--destructive);"></i> oleh Tim
                Green Valley. <br>
                <hr>

                <li style="list-style: none; text-decoration: none; padding: 20px 0; "><a href="index1.html">
                        <strong>Kembali ke
                            menu awal </strong></a></li>
            </small>
        </footer>
    </div>

    <!-- Modal untuk Form Booking -->
    <div class="modal-overlay" id="bookingModalOverlay" aria-labelledby="bookingModalTitle" aria-hidden="true"
        role="dialog">
        <div class="modal__dialog" id="bookingModalDialog" role="document">
            <div class="modal__content">
                <form id="bookingForm" novalidate>
                    <div class="modal__header">
                        <h2 class="modal-title" id="bookingModalTitle">Tambah Booking Baru</h2>
                        <button type="button" class="btn-close" data-dismiss="modal" aria-label="Tutup Modal">
                            <i class="fas fa-times" aria-hidden="true"></i>
                        </button>
                    </div>
                    <div class="modal__body">
                        <input type="hidden" id="bookingId" name="bookingId">
                        <div class="form-group">
                            <label for="tenantName" class="form-label">Nama Penyewa</label>
                            <input type="text" class="form-control" id="tenantName" name="tenantName" required
                                placeholder="cth: Budi Santoso">
                            <div class="invalid-feedback">Nama penyewa wajib diisi.</div>
                        </div>
                        <div class="form-group">
                            <label for="property" class="form-label">Properti yang Dibooking</label>
                            <input type="text" class="form-control" id="property" name="property" required
                                placeholder="cth: Apartemen Harmoni A-101">
                            <div class="invalid-feedback">Nama properti wajib diisi.</div>
                        </div>
                        <div class="form-group">
                            <label for="bookingDate" class="form-label">Tanggal Mulai Sewa</label>
                            <input type="date" class="form-control" id="bookingDate" name="bookingDate" required>
                            <div class="invalid-feedback">Tanggal booking wajib diisi.</div>
                        </div>
                        <div class="form-group">
                            <label for="bookingStatus" class="form-label">Status Booking</label>
                            <select class="form-control" id="bookingStatus" name="bookingStatus" required>
                                <option value="">Pilih Status...</option>
                                <option value="active">Aktif</option>
                                <option value="pending">Menunggu Pembayaran</option>
                                <option value="inactive">Tidak Aktif/Selesai</option>
                            </select>
                            <div class="invalid-feedback">Status booking wajib dipilih.</div>
                        </div>
                    </div>
                    <div class="modal__footer">
                        <button type="button" class="btn btn--secondary" data-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn--primary"><i class="fas fa-save"></i> Simpan
                            Booking</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal untuk Form Edit Profil -->
    <div class="modal-overlay" id="profileEditModalOverlay" aria-labelledby="profileEditModalTitle" aria-hidden="true"
        role="dialog">
        <div class="modal__dialog" id="profileEditModalDialog" role="document">
            <div class="modal__content">
                <form id="profileEditForm" novalidate>
                    <div class="modal__header">
                        <h2 class="modal-title" id="profileEditModalTitle">Edit Profil Pengguna</h2>
                        <button type="button" class="btn-close" data-dismiss-profile-edit-modal
                            aria-label="Tutup Modal Edit Profil">
                            <i class="fas fa-times" aria-hidden="true"></i>
                        </button>
                    </div>
                    <div class="modal__body">
                        <div class="form-group">
                            <label for="profileEditName" class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-control" id="profileEditName" name="profileEditName" required
                                placeholder="Masukkan nama lengkap Anda">
                            <div class="invalid-feedback">Nama lengkap wajib diisi.</div>
                        </div>
                        <div class="form-group">
                            <label for="profileEditEmail" class="form-label">Alamat Email</label>
                            <input type="email" class="form-control" id="profileEditEmail" name="profileEditEmail"
                                required placeholder="cth: nama@example.com">
                            <div class="invalid-feedback">Alamat email wajib diisi dan valid.</div>
                        </div>
                        <div class="form-group">
                            <label for="profileEditPhone" class="form-label">Nomor Telepon</label>
                            <input type="tel" class="form-control" id="profileEditPhone" name="profileEditPhone"
                                placeholder="cth: 081234567890">
                            <div class="invalid-feedback">Nomor telepon tidak valid.</div>
                        </div>
                        <div class="form-group">
                            <label for="profileEditAvatarUrl" class="form-label">URL Avatar (Opsional)</label>
                            <input type="url" class="form-control" id="profileEditAvatarUrl" name="profileEditAvatarUrl"
                                placeholder="https://example.com/avatar.jpg">
                            <div class="invalid-feedback">URL Avatar tidak valid.</div>
                        </div>
                    </div>
                    <div class="modal__footer">
                        <button type="button" class="btn btn--secondary" data-dismiss-profile-edit-modal>Batal</button>
                        <button type="submit" class="btn btn--primary"><i class="fas fa-save"></i> Simpan
                            Perubahan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal untuk Detail Transaksi -->
    <div class="modal-overlay" id="transactionDetailModalOverlay" aria-labelledby="transactionDetailModalTitle"
        aria-hidden="true" role="dialog">
        <div class="modal__dialog" id="transactionDetailModalDialog" role="document">
            <div class="modal__content">
                <div class="modal__header">
                    <h2 class="modal-title" id="transactionDetailModalTitle">Detail Transaksi</h2>
                    <button type="button" class="btn-close" data-dismiss-transaction-detail-modal
                        aria-label="Tutup Detail Transaksi">
                        <i class="fas fa-times" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="modal__body" id="transactionDetailModalBody">
                    <!-- Konten detail transaksi akan diisi oleh JavaScript -->
                    <div class="loading-placeholder" style="min-height: 200px;">
                        <i class="fas fa-spinner fa-spin"></i> Memuat detail transaksi...
                    </div>
                </div>
                <div class="modal__footer">
                    <button type="button" class="btn btn--secondary"
                        data-dismiss-transaction-detail-modal>Tutup</button>
                    <!-- Opsional: Tombol aksi lain seperti "Cetak Struk" -->
                    <button type="button" class="btn btn--primary" id="printTransactionBtn" onclick="window.print();">
                        <i class="fas fa-print"></i> Cetak
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal untuk Ganti Password (Settings) -->
    <div class="modal-overlay" id="changePasswordModalOverlay" aria-labelledby="changePasswordModalTitle"
        aria-hidden="true" role="dialog">
        <div class="modal__dialog" id="changePasswordModalDialog" role="document" style="max-width: 500px;">
            <div class="modal__content">
                <form id="changePasswordForm" novalidate>
                    <div class="modal__header">
                        <h2 class="modal-title" id="changePasswordModalTitle">Ganti Password</h2>
                        <button type="button" class="btn-close" data-dismiss-change-password-modal
                            aria-label="Tutup Modal Ganti Password">
                            <i class="fas fa-times" aria-hidden="true"></i>
                        </button>
                    </div>
                    <div class="modal__body">
                        <div class="form-group">
                            <label for="currentPassword" class="form-label">Password Saat Ini</label>
                            <input type="password" class="form-control" id="currentPassword" name="currentPassword"
                                required>
                            <div class="invalid-feedback">Password saat ini wajib diisi.</div>
                        </div>
                        <div class="form-group">
                            <label for="newPassword" class="form-label">Password Baru</label>
                            <input type="password" class="form-control" id="newPassword" name="newPassword" required
                                minlength="8">
                            <div class="invalid-feedback">Password baru minimal 8 karakter.</div>
                        </div>
                        <div class="form-group">
                            <label for="confirmNewPassword" class="form-label">Konfirmasi Password Baru</label>
                            <input type="password" class="form-control" id="confirmNewPassword"
                                name="confirmNewPassword" required>
                            <div class="invalid-feedback">Konfirmasi password tidak cocok.</div>
                        </div>
                    </div>
                    <div class="modal__footer">
                        <button type="button" class="btn btn--secondary"
                            data-dismiss-change-password-modal>Batal</button>
                        <button type="submit" class="btn btn--primary"><i class="fas fa-save"></i> Simpan
                            Password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal untuk Pilihan Pembayaran -->
    <div class="modal-overlay" id="paymentModalOverlay" aria-labelledby="paymentModalTitle" aria-hidden="true"
        role="dialog">
        <div class="modal__dialog" id="paymentModalDialog" role="document">
            <div class="modal__content">
                <form id="paymentForm" novalidate>
                    <div class="modal__header">
                        <h2 class="modal-title" id="paymentModalTitle">Pilih Metode Pembayaran</h2>
                        <button type="button" class="btn-close" data-dismiss-payment-modal
                            aria-label="Tutup Modal Pembayaran">
                            <i class="fas fa-times" aria-hidden="true"></i>
                        </button>
                    </div>
                    <div class="modal__body">
                        <input type="hidden" id="paymentTransactionId" name="paymentTransactionId">
                        <div class="form-group">
                            <p class="form-label">Tagihan untuk: <strong id="paymentDescription">Deskripsi
                                    Tagihan</strong></p>
                            <p class="form-label">Jumlah: <strong id="paymentAmount"
                                    style="color: var(--primary); font-size: var(--font-size-lg);">Rp 0</strong></p>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Metode Pembayaran:</label>
                            <div class="payment-method-options">
                                <div>
                                    <input type="radio" id="payMethodBank" name="paymentMethod" value="bank" checked>
                                    <label for="payMethodBank" class="payment-method-label">
                                        <i class="fas fa-university"></i>
                                        <span>Transfer Bank</span>
                                    </label>
                                </div>
                                <div>
                                    <input type="radio" id="payMethodEwallet" name="paymentMethod" value="ewallet">
                                    <label for="payMethodEwallet" class="payment-method-label">
                                        <i class="fas fa-wallet"></i>
                                        <span>E-Wallet</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div id="bankTransferDetails" class="payment-details-section">
                            <p>Silakan transfer ke salah satu rekening berikut:</p>
                            <p><strong>BCA:</strong> 123-456-7890 a.n. Green Valley Property</p>
                            <p><strong>Mandiri:</strong> 098-765-4321 a.n. Green Valley Property</p>
                            <label for="paymentProof" class="form-label" style="margin-top: var(--spacing-3);">Upload
                                Bukti Transfer (Opsional):</label>
                            <input type="file" class="form-control" id="paymentProof" name="paymentProof"
                                accept="image/*,.pdf">
                            <div class="upload-area" id="uploadAreaPlaceholder" style="display:none;">
                                <i class="fas fa-cloud-upload-alt"></i>
                                Klik atau jatuhkan file di sini
                            </div>
                        </div>

                        <div id="eWalletDetails" class="payment-details-section" style="display: none;">
                            <p>Pilih E-Wallet:</p>
                            <select id="eWalletProvider" name="eWalletProvider" class="form-control">
                                <option value="gopay">GoPay</option>
                                <option value="ovo">OVO</option>
                                <option value="dana">DANA</option>
                                <option value="shopeepay">ShopeePay</option>
                            </select>
                            <p style="margin-top: var(--spacing-2);">Anda akan diarahkan ke aplikasi E-Wallet untuk
                                menyelesaikan pembayaran (simulasi).</p>
                        </div>
                    </div>
                    <div class="modal__footer">
                        <button type="button" class="btn btn--secondary" data-dismiss-payment-modal>Batal</button>
                        <button type="submit" class="btn btn--primary" id="confirmPaymentBtn"><i
                                class="fas fa-check-circle"></i> Konfirmasi Pembayaran</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Alert/Confirm Modal Implementation -->
    <div class="modal-overlay" id="alertModalOverlay" aria-labelledby="alertModalTitle" aria-hidden="true"
        role="dialog">
        <div class="modal__dialog" role="document">
            <div class="modal__content">
                <div class="modal__header">
                    <h2 class="modal-title" id="alertModalTitle">Konfirmasi</h2>
                    <button type="button" class="btn-close" data-dismiss-alert aria-label="Tutup">
                        <i class="fas fa-times" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="modal__body">
                    <p id="alertModalMessage">Apakah Anda yakin ingin melanjutkan tindakan ini?</p>
                </div>
                <div class="modal__footer">
                    <button type="button" class="btn btn--secondary" id="alertModalCancelBtn">Batal</button>
                    <button type="button" class="btn btn--danger" id="alertModalConfirmBtn">Ya, Lanjutkan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Property Detail Modal Implementation -->
    <div class="modal-overlay" id="propertyDetailModalOverlay" aria-labelledby="propertyDetailModalTitle"
        aria-hidden="true" role="dialog">
        <div class="modal__dialog" id="propertyDetailModalDialog" role="document">
            <div class="modal__content">
                <div class="modal__header">
                    <h2 class="modal-title" id="propertyDetailModalTitle">Detail Properti</h2>
                    <button type="button" class="btn-close" data-dismiss-property-detail-modal
                        aria-label="Tutup Detail Properti">
                        <i class="fas fa-times" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="modal__body" id="propertyDetailModalBody">
                    <div class="loading-placeholder" style="min-height: 300px;">
                        <i class="fas fa-spinner fa-spin"></i> Memuat detail properti...
                    </div>
                </div>
                <div class="modal__footer" id="propertyDetailModalFooter">
                    <button type="button" class="btn btn--secondary" data-dismiss-property-detail-modal>Tutup</button>
                    <button type="button" class="btn btn--primary" id="propertyDetailBookBtn"><i
                            class="fas fa-calendar-plus"></i> Booking Sekarang</button>
                </div>
            </div>
        </div>
    </div>

    <div class="notification-toast" id="notificationToast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="notification-toast__icon" aria-hidden="true">
            <i class="fas fa-info-circle"></i>
        </div>
        <div class="notification-toast__content">
            <strong class="notification-toast__title">Notifikasi</strong>
            <div class="notification-toast__body">Pesan notifikasi akan muncul di sini.</div>
        </div>
        <button type="button" class="btn-close notification-toast__close-btn" aria-label="Tutup Notifikasi">
            <i class="fas fa-times" aria-hidden="true"></i>
        </button>
    </div>

    <div class="cs-chat-widget no-print" id="csChatWidget">
        <button type="button" class="cs-chat-widget__toggle-btn" id="csChatToggleBtn"
            aria-label="Buka Customer Service Chat" aria-expanded="false">
            <i class="fas fa-comments"></i>
        </button>
        <div class="cs-chat-widget__popup" id="csChatPopup" role="log" aria-live="polite">
            <div class="cs-chat-widget__header">
                <h3>Customer Service</h3>
                <button type="button" class="btn-close cs-chat-widget__close-btn" id="csChatCloseBtn"
                    aria-label="Tutup Customer Service Chat">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </div>
            <div class="cs-chat-widget__messages" id="csChatMessages">
                <!-- CS Messages will be rendered here by JS -->
            </div>
            <form class="cs-chat-widget__input-area" id="csChatInputForm">
                <input type="text" id="csChatMessageInput" placeholder="Ketik pertanyaan Anda..."
                    aria-label="Pesan untuk Customer Service">
                <button type="submit" class="btn btn--primary" aria-label="Kirim Pesan ke Customer Service"><i
                        class="fas fa-paper-plane"></i></button>
            </form>
        </div>
    </div>


    <script>
        /**
         * Green Valley - Aplikasi Manajemen Properti (Vanilla JS SPA)
         * Penulis: Tim Pengembang Green Valley
         * Versi: 1.5.0 (Fitur Interaktif Ditingkatkan)
         *
         * Ringkasan Perubahan dan Fitur Baru:
         * - Implementasi halaman "Pesan" (Chat pengguna-ke-pengguna) dengan simulasi pengiriman, penerimaan, dan indikator "typing".
         * - Implementasi "Customer Service Chat Widget" dengan fungsionalitas serupa.
         * - Peningkatan animasi: Pesan chat masuk dengan efek slide-in yang halus.
         * - Peningkatan interaksi: Efek "press" pada tombol dan item navigasi.
         * - Manajemen state yang lebih baik untuk fitur chat.
         * - Modal "Detail Properti" yang lebih kaya informasi, termasuk galeri gambar dan denah lantai.
         * - Fitur "Baru Dilihat" pada halaman properti.
         * - Fitur pembayaran dengan pilihan metode (Transfer Bank, E-Wallet) dan upload bukti.
         * - Halaman "Pengaturan" dengan lebih banyak opsi (simulasi).
         * - Modal konfirmasi (Alert/Confirm) yang lebih baik.
         * - Kode JavaScript diorganisir lebih lanjut dengan objek DOM, AppState, dan Utils untuk kejelasan.
         * - Validasi form yang lebih komprehensif.
         * - Perbaikan kecil pada responsivitas dan aksesibilitas.
         * - Penyesuaian styling untuk tampilan yang lebih "fancy" dan konsisten.
         */
        (function () {
            'use strict';

            const AppState = {
                currentTheme: localStorage.getItem('theme') || 'light',
                isSidebarOpen: window.innerWidth >= 1024, // Sidebar terbuka default di desktop
                activePage: 'dashboard', // Halaman default
                currentUser: {
                    name: 'Pengguna Terhormat',
                    email: 'pengguna@greenvalley.com',
                    phone: '0812-3456-7890',
                    avatarUrl: 'https://i.pravatar.cc/100?u=GreenValleyUser', // Default avatar
                    joinedDate: '2024-01-01T00:00:00Z' // ISO String date
                },
                userSettings: JSON.parse(localStorage.getItem('userSettingsGV')) || {
                    emailNotifications: true,
                    pushNotifications: false,
                    twoFactorAuth: false,
                    language: 'id',
                },
                bookings: [
                    { id: 'bk001', tenant: 'Sarah Wijayanti', property: 'Apartemen Cendana Unit 12A', date: '2025-06-15', status: 'active' },
                    { id: 'bk002', tenant: 'Riko Pratama Putra', property: 'Studio Minimalis Blok B2', date: '2025-07-01', status: 'pending' },
                    { id: 'bk003', tenant: 'Ahmad Subagja', property: 'Rumah Cluster Magnolia No. 5', date: '2025-05-20', status: 'inactive' },
                ],
                paymentsData: [
                    {
                        id: 'TRX00123',
                        date: '2025-05-27',
                        description: 'Pembayaran Sewa Apartemen Harmoni A-101 (Juni)',
                        amount: 10000000,
                        status: 'Lunas',
                        type: 'Sewa Bulanan',
                        propertyId: 'prop001',
                        propertyName: 'Apartemen Modern di Pusat Kota',
                        method: 'Transfer Bank VA BCA',
                        notes: 'Pembayaran diterima via virtual account. Mohon simpan bukti ini.'
                    },
                    {
                        id: 'TRX00122',
                        date: '2025-04-28',
                        description: 'Tagihan Listrik Unit Villa Damai C2',
                        amount: 550000,
                        status: 'Lunas',
                        type: 'Utilitas',
                        propertyId: 'prop003',
                        propertyName: 'Villa Asri dengan Kolam Pribadi',
                        method: 'Gopay',
                        notes: 'Tagihan listrik bulan April.'
                    },
                    {
                        id: 'TRX00121',
                        date: '2025-04-05',
                        description: 'Deposit Keamanan Apartemen Sejahtera Lt.5',
                        amount: 2000000,
                        status: 'Deposit',
                        type: 'Deposit',
                        propertyId: 'prop004',
                        propertyName: 'Apartemen Minimalis Tepi Pantai',
                        method: 'Cash',
                        notes: 'Deposit akan dikembalikan setelah masa sewa berakhir dan kondisi unit baik.'
                    },
                    {
                        id: 'TRX00124',
                        date: '2025-06-01',
                        description: 'Pembayaran Sewa Studio Dekat Kampus (Juli)',
                        amount: 5500000,
                        status: 'Pending',
                        type: 'Sewa Bulanan',
                        propertyId: 'prop002',
                        propertyName: 'Studio Nyaman Dekat Kampus',
                        method: 'Belum Dipilih',
                        notes: 'Menunggu pembayaran dari penyewa.'
                    }
                ],
                properties: [
                    { id: 'prop001', title: 'Apartemen Modern di Pusat Kota', shortDescription: 'Apartemen mewah dengan 2 kamar tidur, fasilitas lengkap, dan lokasi strategis.', longDescription: 'Nikmati kemewahan tinggal di pusat kota dengan apartemen 2 kamar tidur ini. Dilengkapi dengan gym, kolam renang, dan keamanan 24 jam. Akses mudah ke pusat perbelanjaan dan transportasi publik.', image: 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8YXBhcnRtZW50fGVufDB8fDB8fA%3D%3D&auto=format&fit=crop&w=500&q=60', gallery: ['https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8YXBhcnRtZW50fGVufDB8fDB8fA%3D%3D&auto=format&fit=crop&w=800&q=80', 'https://images.unsplash.com/photo-1493809842364-78817add7ffb?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTB8fGFwYXJ0bWVudCUyMGGludGVyaW9yfGVufDB8fDB8fA%3D%3D&auto=format&fit=crop&w=500&q=60', 'https://images.unsplash.com/photo-1522771739844-6a9f6d5f14af?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8YXBhcnRtZW50JTIwaW50ZXJpb3J8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=500&q=60'], price: 10000000, priceDisplay: 'Rp 10.000.000/bulan', specs: { bedrooms: 2, bathrooms: 1, area: 60, amenities: ['parking', 'gym', 'furnished', 'pool'] }, additionalAmenities: ['Balkon Pribadi', 'Smart Home System'], availabilityDate: '2025-08-01', rules: 'Dilarang merokok di dalam unit. Hewan peliharaan tidak diizinkan.', location: { address: 'Jl. Sudirman Kav. 1, Jakarta Pusat', latitude: -6.2088, longitude: 106.8456 }, contact: { agentName: 'Budi Property', agentPhone: '0812-1111-2222', agentEmail: 'budi@example.com' }, floorPlan: 'https://via.placeholder.com/400x300?text=Denah+Lantai+Prop001' },
                    { id: 'prop002', title: 'Studio Nyaman Dekat Kampus', shortDescription: 'Studio ideal untuk mahasiswa, fully furnished, dekat transportasi umum.', longDescription: 'Studio ini sangat cocok untuk mahasiswa atau profesional muda. Lokasi strategis dekat kampus ternama dan akses mudah ke transportasi publik. Fully furnished dengan desain modern dan fungsional.', image: 'https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8YXBhcnRtZW50fGVufDB8fDB8fA%3D%3D&auto=format&fit=crop&w=500&q=60', gallery: ['https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8YXBhcnRtZW50fGVufDB8fDB8fA%3D%3D&auto=format&fit=crop&w=800&q=80', 'https://images.unsplash.com/photo-1600585152915-d208bec867a1?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Nnx8c3R1ZGlvJTIwYXBhcnRtZW50fGVufDB8fDB8fA%3D%3D&auto=format&fit=crop&w=500&q=60'], price: 5500000, priceDisplay: 'Rp 5.500.000/bulan', specs: { bedrooms: 1, bathrooms: 1, area: 35, amenities: ['parking', 'furnished'] }, additionalAmenities: ['Wi-Fi Cepat', 'Area Belajar Bersama'], availabilityDate: '2025-07-15', rules: 'Dilarang membawa hewan peliharaan. Menjaga ketenangan lingkungan.', location: { address: 'Jl. Pendidikan No. 10, Depok', latitude: -6.4025, longitude: 106.7942 }, contact: { agentName: 'Citra Agen', agentPhone: '0812-3333-4444', agentEmail: 'citra@example.com' }, floorPlan: null },
                    { id: 'prop003', title: 'Villa Asri dengan Kolam Pribadi', shortDescription: 'Villa eksklusif 3 kamar tidur, kolam renang pribadi, taman luas, di area Puncak.', longDescription: 'Rasakan ketenangan dan kemewahan di villa eksklusif ini. Terletak di kawasan Puncak yang sejuk, villa ini memiliki 3 kamar tidur, kolam renang pribadi, dan taman yang luas. Sempurna untuk liburan keluarga atau acara khusus.', image: 'https://images.unsplash.com/photo-1613490493576-7fde63acd811?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8dmlsbGF8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=500&q=60', gallery: ['https://images.unsplash.com/photo-1613490493576-7fde63acd811?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8dmlsbGF8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=800&q=80', 'https://images.unsplash.com/photo-1580587771525-78b9dba3b914?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Nnx8dmlsbGF8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=500&q=60'], price: 25000000, priceDisplay: 'Rp 25.000.000/bulan', specs: { bedrooms: 3, bathrooms: 2, area: 150, amenities: ['parking', 'pool', 'furnished', 'gym'] }, additionalAmenities: ['Taman Pribadi', 'Area BBQ'], availabilityDate: '2025-09-01', rules: 'Cocok untuk keluarga. Tidak untuk pesta besar tanpa izin.', location: { address: 'Kawasan Villa Sejuk No. 8, Puncak, Bogor', latitude: -6.7100, longitude: 106.9902 }, contact: { agentName: 'Villa Indah Group', agentPhone: '0812-5555-6666', agentEmail: 'info@villaindah.com' }, floorPlan: 'https://via.placeholder.com/400x300?text=Denah+Lantai+Prop003' },
                    { id: 'prop004', title: 'Apartemen Minimalis Tepi Pantai', shortDescription: 'Desain modern dengan 2 kamar tidur, pemandangan laut, akses langsung ke pantai.', longDescription: 'Apartemen ini menawarkan gaya hidup tepi pantai yang santai. Dengan desain minimalis modern, 2 kamar tidur, dan pemandangan laut yang menakjubkan. Akses langsung ke pantai dan fasilitas resor.', image: 'https://images.unsplash.com/photo-1512917774080-9991f1c4c750?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Nnx8YXBhcnRtZW50fGVufDB8fDB8fA%3D%3D&auto=format&fit=crop&w=500&q=60', gallery: ['https://images.unsplash.com/photo-1512917774080-9991f1c4c750?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Nnx8YXBhcnRtZW50fGVufDB8fDB8fA%3D%3D&auto=format&fit=crop&w=800&q=80'], price: 12000000, priceDisplay: 'Rp 12.000.000/bulan', specs: { bedrooms: 2, bathrooms: 2, area: 75, amenities: ['pool', 'gym'] }, additionalAmenities: ['Akses Pantai Langsung', 'Restoran Tepi Pantai'], availabilityDate: 'Segera Tersedia', rules: 'Minimum sewa 6 bulan. Deposit 2 bulan.', location: { address: 'Jl. Pantai Indah No. 101, Seminyak, Bali', latitude: -8.4095, longitude: 115.1889 }, contact: { agentName: 'Bali Best Stay', agentPhone: '0812-7777-8888', agentEmail: 'reservations@balibeststay.com' }, floorPlan: null },
                    { id: 'prop005', title: 'Rumah Klasik di Area Hijau', shortDescription: 'Lingkungan tenang dan asri, 4 kamar tidur, taman belakang luas, cocok untuk keluarga.', longDescription: 'Rumah klasik ini terletak di lingkungan yang tenang dan asri, dikelilingi pepohonan hijau. Dengan 4 kamar tidur dan taman belakang yang luas, sangat ideal untuk keluarga yang mencari kenyamanan dan privasi.', image: 'https://images.unsplash.com/photo-1570129477492-45c003edd2be?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8aG91c2V8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=500&q=60', gallery: ['https://images.unsplash.com/photo-1570129477492-45c003edd2be?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8aG91c2V8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=800&q=80'], price: 18000000, priceDisplay: 'Rp 18.000.000/bulan', specs: { bedrooms: 4, bathrooms: 3, area: 200, amenities: ['parking', 'furnished'] }, additionalAmenities: ['Taman Belakang Luas', 'Gazebo'], availabilityDate: '2025-10-01', rules: 'Diutamakan penyewa keluarga. Perawatan taman termasuk dalam sewa.', location: { address: 'Jl. Akasia Hijau No. 15, Bandung', latitude: -6.9175, longitude: 107.6191 }, contact: { agentName: 'Rumah Impian Bandung', agentPhone: '0812-9999-0000', agentEmail: 'kontak@rumahimpian.com' }, floorPlan: 'https://via.placeholder.com/400x300?text=Denah+Lantai+Prop005' }
                ],
                favorites: ['prop002'],
                recentlyViewed: [],
                editingBookingId: null,
                currentDetailPropertyId: null,
                currentPaymentTransactionId: null,
                searchQuery: '',
                filters: {
                    priceRange: '',
                    bedrooms: '',
                    amenities: ''
                },
                toastTimeout: null,
                conversations: [
                    { id: 'conv001', partnerName: 'Agen Budi Property', partnerAvatar: 'https://i.pravatar.cc/40?u=agentBudi', lastMessage: 'Siap, unitnya masih tersedia. Mau survey kapan?', timestamp: new Date(Date.now() - 3600000).toISOString(), unread: 1, typing: false },
                    { id: 'conv002', partnerName: 'Citra Agen', partnerAvatar: 'https://i.pravatar.cc/40?u=agentCitra', lastMessage: 'Terima kasih atas minatnya!', timestamp: new Date(Date.now() - 86400000).toISOString(), unread: 0, typing: false },
                    { id: 'conv003', partnerName: 'Green Valley Admin', partnerAvatar: 'https://via.placeholder.com/40x40?text=GV', lastMessage: 'Selamat datang di Green Valley!', timestamp: new Date(Date.now() - 172800000).toISOString(), unread: 0, typing: false }
                ],
                messages: {
                    'conv001': [
                        { id: 'msg001', sender: 'user', text: 'Halo, apakah apartemen di Sudirman masih ada?', timestamp: new Date(Date.now() - 7200000).toISOString() },
                        { id: 'msg002', sender: 'partner', text: 'Halo! Iya, Apartemen Modern di Pusat Kota masih tersedia.', timestamp: new Date(Date.now() - 5400000).toISOString() },
                        { id: 'msg003', sender: 'partner', text: 'Siap, unitnya masih tersedia. Mau survey kapan?', timestamp: new Date(Date.now() - 3600000).toISOString() }
                    ],
                    'conv002': [
                        { id: 'msg004', sender: 'user', text: 'Saya tertarik dengan studio dekat kampus.', timestamp: new Date(Date.now() - 90000000).toISOString() },
                        { id: 'msg005', sender: 'partner', text: 'Terima kasih atas minatnya!', timestamp: new Date(Date.now() - 86400000).toISOString() }
                    ],
                    'conv003': [
                        { id: 'msg006', sender: 'partner', text: 'Selamat datang di Green Valley! Jika ada pertanyaan, jangan ragu untuk menghubungi kami.', timestamp: new Date(Date.now() - 172800000).toISOString() }
                    ]
                },
                activeConversationId: null,
                csChatMessages: [],
                isCsChatWidgetOpen: false,
                isCsTyping: false, // NEW: For CS typing indicator
            };

            const DOM = {
                body: document.body,
                sidebar: document.getElementById('sidebar'),
                sidebarToggle: document.getElementById('sidebarToggle'),
                mainWrapper: document.getElementById('mainWrapper'),
                themeToggleBtn: document.getElementById('themeToggleBtn'),
                profileDropdownToggle: document.getElementById('profileDropdownToggle'),
                profileDropdownMenu: document.getElementById('profileDropdownMenu'),
                headerUserAvatar: document.getElementById('headerUserAvatar'),
                headerUserName: document.getElementById('headerUserName'),
                logoutButton: document.getElementById('logoutButton'),
                searchInput: document.getElementById('searchInput'),

                bookingModalOverlay: document.getElementById('bookingModalOverlay'),
                bookingForm: document.getElementById('bookingForm'),
                bookingModalTitle: document.getElementById('bookingModalTitle'),
                bookingIdInput: document.getElementById('bookingId'),
                addBookingBtn: document.getElementById('addBookingBtn'),
                bookingTableBody: document.getElementById('bookingTableBody'),

                alertModalOverlay: document.getElementById('alertModalOverlay'),
                alertModalTitle: document.getElementById('alertModalTitle'),
                alertModalMessage: document.getElementById('alertModalMessage'),
                alertModalConfirmBtn: document.getElementById('alertModalConfirmBtn'),
                alertModalCancelBtn: document.getElementById('alertModalCancelBtn'),

                profileEditModalOverlay: document.getElementById('profileEditModalOverlay'),
                profileEditForm: document.getElementById('profileEditForm'),
                profileEditModalTitle: document.getElementById('profileEditModalTitle'),
                editProfileBtn: document.getElementById('editProfileBtn'),
                profileUserAvatarDisplay: document.getElementById('profileUserAvatar'),
                profileUserNameDisplay: document.getElementById('profileUserNameDisplay'),
                profileFullNameDisplay: document.getElementById('profileFullNameDisplay'),
                profileEmailDisplay: document.getElementById('profileEmailDisplay'),
                profilePhoneDisplay: document.getElementById('profilePhoneDisplay'),
                profileJoinedDateDisplay: document.getElementById('profileJoinedDateDisplay'),

                transactionDetailModalOverlay: document.getElementById('transactionDetailModalOverlay'),
                transactionDetailModalTitle: document.getElementById('transactionDetailModalTitle'),
                transactionDetailModalBody: document.getElementById('transactionDetailModalBody'),
                paymentTableBody: document.getElementById('paymentTableBody'),

                propertyDetailModalOverlay: document.getElementById('propertyDetailModalOverlay'),
                propertyDetailModalTitle: document.getElementById('propertyDetailModalTitle'),
                propertyDetailModalBody: document.getElementById('propertyDetailModalBody'),
                propertyDetailModalFooter: document.getElementById('propertyDetailModalFooter'),
                propertyDetailBookBtn: document.getElementById('propertyDetailBookBtn'),

                pageContentContainer: document.getElementById('pageContentContainer'),
                navLinks: document.querySelectorAll('.nav-link, .profile-dropdown__item[data-page-nav]'),
                pageSections: document.querySelectorAll('.page-section'),

                propertiesGrid: document.getElementById('propertiesGrid'),
                favoritesGrid: document.getElementById('favoritesGrid'),
                recentlyViewedGrid: document.getElementById('recentlyViewedGrid'),

                priceRangeFilter: document.getElementById('priceRangeFilter'),
                bedroomsFilter: document.getElementById('bedroomsFilter'),
                amenitiesFilter: document.getElementById('amenitiesFilter'),
                applyFilterBtn: document.getElementById('applyFilterBtn'),

                notificationToast: document.getElementById('notificationToast'),
                notificationToastIcon: document.querySelector('#notificationToast .notification-toast__icon i'),
                notificationToastTitle: document.querySelector('#notificationToast .notification-toast__title'),
                notificationToastBody: document.querySelector('#notificationToast .notification-toast__body'),
                notificationToastCloseBtn: document.querySelector('#notificationToast .notification-toast__close-btn'),

                currentYearSpan: document.getElementById('currentYear'),

                messagesSidebar: document.getElementById('messagesSidebar'),
                conversationSearchInput: document.getElementById('conversationSearchInput'),
                conversationList: document.getElementById('conversationList'),
                chatArea: document.getElementById('chatArea'),
                noChatSelected: document.getElementById('noChatSelected'),
                activeChatContent: document.getElementById('activeChatContent'),
                chatHeader: document.getElementById('chatHeader'),
                chatPartnerName: document.getElementById('chatPartnerName'),
                messageList: document.getElementById('messageList'),
                messageInputForm: document.getElementById('messageInputForm'),
                messageInput: document.getElementById('messageInput'),
                createNewMessageBtn: document.getElementById('createNewMessageBtn'),

                csChatWidget: document.getElementById('csChatWidget'),
                csChatToggleBtn: document.getElementById('csChatToggleBtn'),
                csChatPopup: document.getElementById('csChatPopup'),
                csChatCloseBtn: document.getElementById('csChatCloseBtn'),
                csChatMessages: document.getElementById('csChatMessages'),
                csChatInputForm: document.getElementById('csChatInputForm'),
                csChatMessageInput: document.getElementById('csChatMessageInput'),

                settingsContent: document.getElementById('settings-content'),
                settingEmailNotifications: document.getElementById('settingEmailNotifications'),
                settingPushNotifications: document.getElementById('settingPushNotifications'),
                changePasswordBtn: document.getElementById('changePasswordBtn'),
                settingTwoFactorAuth: document.getElementById('settingTwoFactorAuth'),
                settingThemeToggleBtn: document.getElementById('settingThemeToggleBtn'),
                settingLanguage: document.getElementById('settingLanguage'),

                changePasswordModalOverlay: document.getElementById('changePasswordModalOverlay'),
                changePasswordForm: document.getElementById('changePasswordForm'),

                paymentModalOverlay: document.getElementById('paymentModalOverlay'),
                paymentForm: document.getElementById('paymentForm'),
                paymentModalTitle: document.getElementById('paymentModalTitle'),
                paymentDescription: document.getElementById('paymentDescription'),
                paymentAmount: document.getElementById('paymentAmount'),
                paymentTransactionIdInput: document.getElementById('paymentTransactionId'),
                payMethodBankRadio: document.getElementById('payMethodBank'),
                payMethodEwalletRadio: document.getElementById('payMethodEwallet'),
                bankTransferDetailsDiv: document.getElementById('bankTransferDetails'),
                eWalletDetailsDiv: document.getElementById('eWalletDetails'),
                paymentProofInput: document.getElementById('paymentProof'),
                eWalletProviderSelect: document.getElementById('eWalletProvider'),
                confirmPaymentBtn: document.getElementById('confirmPaymentBtn'),
            };

            const Utils = {
                sanitizeHTML(str) {
                    if (typeof str !== 'string') str = String(str);
                    const temp = document.createElement('div');
                    temp.textContent = str;
                    return temp.innerHTML;
                },
                debounce(fn, delay) {
                    let timeoutId;
                    return function (...args) {
                        clearTimeout(timeoutId);
                        timeoutId = setTimeout(() => fn.apply(this, args), delay);
                    };
                },
                formatDate(dateStr, options = { day: 'numeric', month: 'long', year: 'numeric' }) {
                    if (!dateStr || dateStr.toLowerCase() === 'segera tersedia') return 'Segera Tersedia';
                    try {
                        const date = new Date(dateStr);
                        if (isNaN(date.getTime())) {
                            console.warn("Invalid date string for formatDate:", dateStr);
                            return 'Tanggal Tidak Valid';
                        }
                        return date.toLocaleDateString('id-ID', options);
                    } catch (error) {
                        console.error("Error formatting date:", dateStr, error);
                        return 'Format Tanggal Salah';
                    }
                },
                formatTime(dateStr, options = { hour: '2-digit', minute: '2-digit' }) {
                    if (!dateStr) return '';
                    try {
                        const date = new Date(dateStr);
                        if (isNaN(date.getTime())) return 'Waktu Tidak Valid';
                        return date.toLocaleTimeString('id-ID', options);
                    } catch (error) {
                        console.error("Error formatting time:", dateStr, error);
                        return 'Format Waktu Salah';
                    }
                },
                generateId(prefix = 'id') {
                    return `${prefix}${Date.now().toString(36)}${Math.random().toString(36).substr(2, 5)}`;
                },
                capitalize(str) {
                    if (typeof str !== 'string' || !str) return '';
                    return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
                },
                formatCurrency(amount, currency = 'IDR') {
                    if (typeof amount !== 'number') amount = parseFloat(amount);
                    if (isNaN(amount)) return "Jumlah Tidak Valid";
                    return new Intl.NumberFormat('id-ID', { style: 'currency', currency: currency, minimumFractionDigits: 0 }).format(amount);
                },
                isValidEmail(email) {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    return emailRegex.test(email);
                },
                isValidPhone(phone) {
                    if (!phone) return true;
                    const phoneRegex = /^[+]?[0-9\s-()]{7,20}$/;
                    return phoneRegex.test(phone);
                },
                isValidUrl(string) {
                    if (!string) return true;
                    try {
                        new URL(string);
                        return true;
                    } catch (_) {
                        return false;
                    }
                }
            };

            const App = {
                init() {
                    console.info('Green Valley App Initializing...');
                    this.applyTheme(AppState.currentTheme, true);
                    this.updateSidebarState(AppState.isSidebarOpen);
                    this.updateCurrentYear();
                    this.renderUserProfileData();
                    this.setupEventListeners();

                    const initialHash = window.location.hash.substring(1) || 'dashboard';
                    this.navigateTo(initialHash, true);

                    this.initCsChatWidget();
                    console.info('Green Valley App Initialized Successfully.');
                },

                setupEventListeners() {
                    DOM.themeToggleBtn.addEventListener('click', () => this.toggleTheme());
                    DOM.sidebarToggle.addEventListener('click', () => {
                        AppState.isSidebarOpen = !AppState.isSidebarOpen;
                        this.updateSidebarState(AppState.isSidebarOpen);
                    });
                    DOM.navLinks.forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const page = link.dataset.page || link.hash.substring(1) || (link.dataset.pageNav);
                            if (page) {
                                this.navigateTo(page);
                                if (window.innerWidth < 1024 && AppState.isSidebarOpen) {
                                    AppState.isSidebarOpen = false;
                                    this.updateSidebarState(false);
                                }
                                if (DOM.profileDropdownMenu.classList.contains('show')) {
                                    this.toggleProfileDropdown(false);
                                }
                            }
                        });
                    });
                    window.addEventListener('hashchange', () => this.navigateTo(window.location.hash.substring(1) || 'dashboard', true));
                    DOM.profileDropdownToggle.addEventListener('click', () => this.toggleProfileDropdown());

                    if (DOM.logoutButton) {
                        DOM.logoutButton.addEventListener('click', (e) => {
                            e.preventDefault();
                            this.logout();
                        });
                    }

                    document.addEventListener('click', (e) => {
                        if (DOM.profileDropdownToggle && DOM.profileDropdownMenu &&
                            !DOM.profileDropdownToggle.contains(e.target) &&
                            !DOM.profileDropdownMenu.contains(e.target)) {
                            if (DOM.profileDropdownMenu.classList.contains('show')) {
                                this.toggleProfileDropdown(false);
                            }
                        }
                        if (DOM.csChatWidget && AppState.isCsChatWidgetOpen &&
                            !DOM.csChatWidget.contains(e.target)) {
                            this.toggleCsChatWidget(false);
                        }
                    });
                    if (DOM.searchInput) {
                        DOM.searchInput.addEventListener('input', Utils.debounce((e) => {
                            AppState.searchQuery = e.target.value.toLowerCase().trim();
                            if (AppState.activePage === 'properties') this.renderProperties();
                        }, 300));
                    }

                    // Booking Modal
                    if (DOM.addBookingBtn) DOM.addBookingBtn.addEventListener('click', () => this.openBookingModal());
                    if (DOM.bookingForm) DOM.bookingForm.addEventListener('submit', (e) => this.handleBookingFormSubmit(e));
                    if (DOM.bookingModalOverlay) {
                        DOM.bookingModalOverlay.addEventListener('click', (e) => {
                            if (e.target === DOM.bookingModalOverlay || e.target.closest('[data-dismiss="modal"]')) {
                                this.closeBookingModal();
                            }
                        });
                    }

                    // Profile Edit Modal
                    if (DOM.editProfileBtn) DOM.editProfileBtn.addEventListener('click', () => this.openProfileEditModal());
                    if (DOM.profileEditForm) DOM.profileEditForm.addEventListener('submit', (e) => this.handleProfileEditFormSubmit(e));
                    if (DOM.profileEditModalOverlay) {
                        DOM.profileEditModalOverlay.addEventListener('click', (e) => {
                            if (e.target === DOM.profileEditModalOverlay || e.target.closest('[data-dismiss-profile-edit-modal]')) {
                                this.closeProfileEditModal();
                            }
                        });
                    }

                    // Transaction Detail & Payment Modals
                    if (DOM.paymentTableBody) {
                        DOM.paymentTableBody.addEventListener('click', (e) => {
                            const detailButton = e.target.closest('button[data-action="view-transaction"]');
                            const payButton = e.target.closest('button[data-action="pay-transaction"]');
                            if (detailButton) {
                                const transactionId = detailButton.dataset.transactionId;
                                this.openTransactionDetailModal(transactionId);
                            } else if (payButton) {
                                const transactionId = payButton.dataset.transactionId;
                                this.openPaymentModal(transactionId);
                            }
                        });
                    }
                    if (DOM.transactionDetailModalOverlay) {
                        DOM.transactionDetailModalOverlay.addEventListener('click', (e) => {
                            if (e.target === DOM.transactionDetailModalOverlay || e.target.closest('[data-dismiss-transaction-detail-modal]')) {
                                this.closeTransactionDetailModal();
                            }
                        });
                    }
                    if (DOM.paymentModalOverlay) {
                        DOM.paymentModalOverlay.addEventListener('click', (e) => {
                            if (e.target === DOM.paymentModalOverlay || e.target.closest('[data-dismiss-payment-modal]')) {
                                this.closePaymentModal();
                            }
                        });
                        DOM.payMethodBankRadio.addEventListener('change', () => this.updatePaymentMethodDetailsView());
                        DOM.payMethodEwalletRadio.addEventListener('change', () => this.updatePaymentMethodDetailsView());
                        DOM.paymentForm.addEventListener('submit', (e) => this.handlePaymentFormSubmit(e));
                    }

                    if (DOM.notificationToastCloseBtn) DOM.notificationToastCloseBtn.addEventListener('click', () => this.hideNotification());
                    // Property Filters
                    if (DOM.applyFilterBtn) DOM.applyFilterBtn.addEventListener('click', () => this.applyPropertyFilters());
                    [DOM.priceRangeFilter, DOM.bedroomsFilter, DOM.amenitiesFilter].forEach(filterElement => {
                        if (filterElement) filterElement.addEventListener('change', () => this.applyPropertyFilters());
                    });

                    // Property Detail Modal & Actions
                    if (DOM.propertyDetailModalOverlay) {
                        DOM.propertyDetailModalOverlay.addEventListener('click', (e) => {
                            if (e.target === DOM.propertyDetailModalOverlay || e.target.closest('[data-dismiss-property-detail-modal]')) {
                                this.closePropertyDetailModal();
                            }
                        });
                    }
                    if (DOM.propertyDetailBookBtn) {
                        DOM.propertyDetailBookBtn.addEventListener('click', () => {
                            const propertyId = AppState.currentDetailPropertyId;
                            if (propertyId) {
                                const property = AppState.properties.find(p => p.id === propertyId);
                                this.closePropertyDetailModal();
                                this.openBookingModal(null, { propertyName: property.title });
                            }
                        });
                    }

                    // Event delegation for property cards (favorite, detail)
                    [DOM.propertiesGrid, DOM.favoritesGrid, DOM.recentlyViewedGrid].forEach(grid => {
                        if (grid) {
                            grid.addEventListener('click', (e) => {
                                const button = e.target.closest('button[data-action]');
                                if (!button) return;
                                const propertyId = button.dataset.propertyId;
                                const action = button.dataset.action;
                                if (action === 'favorite') this.toggleFavorite(propertyId, button);
                                else if (action === 'remove-favorite') this.toggleFavorite(propertyId);
                                else if (action === 'detail') this.openPropertyDetailModal(propertyId);
                            });
                        }
                    });

                    // Messages Page Event Listeners
                    if (DOM.conversationList) {
                        DOM.conversationList.addEventListener('click', (e) => {
                            const item = e.target.closest('.messages-layout__conversation-item');
                            if (item && item.dataset.convId) this.setActiveConversation(item.dataset.convId);
                        });
                    }
                    if (DOM.messageInputForm) {
                        DOM.messageInputForm.addEventListener('submit', (e) => {
                            e.preventDefault();
                            this.sendUserMessage();
                        });
                    }
                    if (DOM.conversationSearchInput) DOM.conversationSearchInput.addEventListener('input', Utils.debounce(() => this.renderConversationsList(), 300));
                    if (DOM.createNewMessageBtn) DOM.createNewMessageBtn.addEventListener('click', () => this.showNotification('Fitur membuat pesan baru akan segera hadir!', 'Info', 'info'));
                    if (DOM.messageInput) {
                        DOM.messageInput.addEventListener('input', function () {
                            this.style.height = 'auto';
                            this.style.height = (this.scrollHeight) + 'px';
                        });
                    }
                    // Customer Service Chat Widget Event Listeners
                    if (DOM.csChatToggleBtn) DOM.csChatToggleBtn.addEventListener('click', () => this.toggleCsChatWidget());
                    if (DOM.csChatCloseBtn) DOM.csChatCloseBtn.addEventListener('click', () => this.toggleCsChatWidget(false));
                    if (DOM.csChatInputForm) {
                        DOM.csChatInputForm.addEventListener('submit', (e) => {
                            e.preventDefault();
                            this.sendCsChatMessage();
                        });
                    }

                    // Settings Page Event Listeners
                    if (DOM.settingEmailNotifications) DOM.settingEmailNotifications.addEventListener('change', (e) => this.handleSettingChange('emailNotifications', e.target.checked));
                    if (DOM.settingPushNotifications) DOM.settingPushNotifications.addEventListener('change', (e) => this.handleSettingChange('pushNotifications', e.target.checked));
                    if (DOM.changePasswordBtn) DOM.changePasswordBtn.addEventListener('click', () => this.openChangePasswordModal());
                    if (DOM.settingThemeToggleBtn) DOM.settingThemeToggleBtn.addEventListener('click', () => this.toggleTheme());
                    if (DOM.settingLanguage) DOM.settingLanguage.addEventListener('change', (e) => this.handleSettingChange('language', e.target.value));

                    // Change Password Modal
                    if (DOM.changePasswordModalOverlay) {
                        DOM.changePasswordModalOverlay.addEventListener('click', (e) => {
                            if (e.target === DOM.changePasswordModalOverlay || e.target.closest('[data-dismiss-change-password-modal]')) {
                                this.closeChangePasswordModal();
                            }
                        });
                    }
                    if (DOM.changePasswordForm) DOM.changePasswordForm.addEventListener('submit', (e) => this.handleChangePasswordFormSubmit(e));

                    window.addEventListener('resize', Utils.debounce(() => {
                        const shouldBeOpen = window.innerWidth >= 1024;
                        if (AppState.isSidebarOpen !== shouldBeOpen && window.innerWidth >= 1024) {
                            AppState.isSidebarOpen = shouldBeOpen;
                            this.updateSidebarState(AppState.isSidebarOpen);
                        } else if (window.innerWidth < 1024 && DOM.sidebar.classList.contains('show') && !AppState.isSidebarOpen) {
                            this.updateSidebarState(false);
                        }
                    }, 200));
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') {
                            if (DOM.bookingModalOverlay && DOM.bookingModalOverlay.classList.contains('show')) this.closeBookingModal();
                            if (DOM.profileEditModalOverlay && DOM.profileEditModalOverlay.classList.contains('show')) this.closeProfileEditModal();
                            if (DOM.transactionDetailModalOverlay && DOM.transactionDetailModalOverlay.classList.contains('show')) this.closeTransactionDetailModal();
                            if (DOM.propertyDetailModalOverlay && DOM.propertyDetailModalOverlay.classList.contains('show')) this.closePropertyDetailModal();
                            if (DOM.changePasswordModalOverlay && DOM.changePasswordModalOverlay.classList.contains('show')) this.closeChangePasswordModal();
                            if (DOM.paymentModalOverlay && DOM.paymentModalOverlay.classList.contains('show')) this.closePaymentModal();
                            if (DOM.alertModalOverlay && DOM.alertModalOverlay.classList.contains('show')) {
                                const cancelBtn = DOM.alertModalCancelBtn;
                                if (cancelBtn) cancelBtn.click();
                                else App._closeAlertConfirmModalVisuals();
                            }
                            if (DOM.profileDropdownMenu && DOM.profileDropdownMenu.classList.contains('show')) this.toggleProfileDropdown(false);
                            if (AppState.isCsChatWidgetOpen) this.toggleCsChatWidget(false);
                        }
                    });
                },

                applyTheme(theme, instant = false) {
                    DOM.body.classList.toggle('dark', theme === 'dark');
                    DOM.themeToggleBtn.innerHTML = `<i class="fas fa-${theme === 'light' ? 'moon' : 'sun'}"></i>`;
                    DOM.themeToggleBtn.setAttribute('aria-label', `Ganti ke tema ${theme === 'light' ? 'Gelap' : 'Terang'}`);
                    if (DOM.settingThemeToggleBtn) {
                        DOM.settingThemeToggleBtn.innerHTML = `<i class="fas fa-${theme === 'light' ? 'moon' : 'sun'}"></i> Ganti Tema ${theme === 'light' ? 'Gelap' : 'Terang'}`;
                    }
                    if (!instant) {
                        DOM.body.style.transition = 'background-color 0.3s ease, color 0.3s ease';
                        setTimeout(() => { DOM.body.style.transition = ''; }, 300);
                    }
                },
                toggleTheme() {
                    AppState.currentTheme = AppState.currentTheme === 'light' ? 'dark' : 'light';
                    localStorage.setItem('theme', AppState.currentTheme);
                    this.applyTheme(AppState.currentTheme);
                    this.showNotification(`Tema diubah ke ${AppState.currentTheme === 'light' ? 'Terang' : 'Gelap'}`, 'Preferensi Disimpan', 'info');
                },

                updateSidebarState(isOpen) {
                    DOM.sidebar.classList.toggle('collapsed', !isOpen && window.innerWidth >= 1024);
                    DOM.sidebar.classList.toggle('show', isOpen && window.innerWidth < 1024);
                    DOM.sidebarToggle.setAttribute('aria-expanded', isOpen.toString());

                    if (window.innerWidth < 1024) DOM.body.style.overflow = isOpen ? 'hidden' : '';
                    else DOM.body.style.overflow = '';
                },

                navigateTo(pageId, isInitialLoad = false) {
                    if (!pageId) pageId = 'dashboard';
                    AppState.activePage = pageId;

                    if (!isInitialLoad || window.location.hash.substring(1) !== pageId) window.location.hash = pageId;

                    DOM.pageSections.forEach(section => {
                        const isActive = section.id === `${pageId}-content`;
                        section.style.display = isActive ? 'block' : 'none';
                        section.classList.toggle('active', isActive);
                        if (isActive && section.getAttribute('aria-labelledby')) {
                            const titleElement = document.getElementById(section.getAttribute('aria-labelledby'));
                            if (titleElement) titleElement.focus({ preventScroll: true });
                        }
                    });
                    DOM.navLinks.forEach(link => {
                        const linkPage = link.dataset.page || link.hash.substring(1) || link.dataset.pageNav;
                        link.classList.toggle('active', linkPage === pageId);
                    });

                    const activeLink = document.querySelector(`.nav-link[data-page="${pageId}"], .profile-dropdown__item[data-page-nav="${pageId}"]`);
                    const pageTitle = activeLink ? (activeLink.querySelector('span')?.textContent || activeLink.textContent).trim() : Utils.capitalize(pageId);
                    document.title = `Green Valley - ${pageTitle}`;

                    if (pageId === 'bookings' && DOM.bookingTableBody) this.renderBookings();
                    if (pageId === 'properties' && DOM.propertiesGrid) this.renderProperties();
                    if (pageId === 'favorites' && DOM.favoritesGrid) this.renderFavorites();
                    if (pageId === 'properties' && DOM.recentlyViewedGrid) this.renderRecentlyViewed();
                    if (pageId === 'profile' && DOM.profileFullNameDisplay) this.renderUserProfileData();
                    if (pageId === 'payments' && DOM.paymentTableBody) this.renderPaymentsTable();
                    if (pageId === 'messages') this.initMessagesPage();
                    if (pageId === 'settings' && DOM.settingsContent) this.renderSettingsPage();
                },

                toggleProfileDropdown(forceState) {
                    if (!DOM.profileDropdownMenu || !DOM.profileDropdownToggle) return;
                    const shouldShow = forceState !== undefined ? forceState : !DOM.profileDropdownMenu.classList.contains('show');
                    DOM.profileDropdownMenu.classList.toggle('show', shouldShow);
                    DOM.profileDropdownToggle.setAttribute('aria-expanded', shouldShow.toString());
                    if (shouldShow) {
                        const firstFocusable = DOM.profileDropdownMenu.querySelector('a, button');
                        if (firstFocusable) firstFocusable.focus();
                    } else {
                        DOM.profileDropdownToggle.focus();
                    }
                },
                async logout() {
                    const confirmed = await this.showAlertConfirm(
                        'Apakah Anda yakin ingin keluar dari aplikasi Green Valley?',
                        'Konfirmasi Logout',
                        'Ya, Logout',
                        'btn--danger'
                    );
                    if (confirmed) {
                        this.showNotification('Anda telah berhasil logout. Sampai jumpa!', 'Logout Berhasil', 'success');
                        this.toggleProfileDropdown(false);
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        this.showNotification('Logout dibatalkan.', 'Dibatalkan', 'info');
                    }
                },

                showNotification(message, title = 'Notifikasi', type = 'info', duration = 5000) {
                    if (!DOM.notificationToast || !DOM.notificationToastTitle || !DOM.notificationToastBody || !DOM.notificationToastIcon) return;
                    clearTimeout(AppState.toastTimeout);
                    DOM.notificationToastTitle.textContent = title;
                    DOM.notificationToastBody.innerHTML = Utils.sanitizeHTML(message);
                    const icons = { info: 'fa-info-circle', success: 'fa-check-circle', warning: 'fa-exclamation-triangle', error: 'fa-times-circle' };
                    DOM.notificationToastIcon.className = `fas ${icons[type] || icons.info}`;
                    DOM.notificationToast.className = 'notification-toast';
                    DOM.notificationToast.classList.add(`notification-toast--${type}`, 'show');
                    DOM.notificationToast.setAttribute('aria-live', type === 'error' || type === 'warning' ? 'assertive' : 'polite');
                    AppState.toastTimeout = setTimeout(() => this.hideNotification(), duration);
                },
                hideNotification() {
                    if (!DOM.notificationToast) return;
                    DOM.notificationToast.classList.remove('show');
                    clearTimeout(AppState.toastTimeout);
                },

                renderUserProfileData() {
                    const user = AppState.currentUser;
                    if (DOM.headerUserAvatar) DOM.headerUserAvatar.src = Utils.sanitizeHTML(user.avatarUrl);
                    if (DOM.headerUserName) DOM.headerUserName.textContent = Utils.sanitizeHTML(user.name);

                    if (AppState.activePage === 'profile') {
                        if (DOM.profileUserAvatarDisplay) DOM.profileUserAvatarDisplay.src = Utils.sanitizeHTML(user.avatarUrl);
                        if (DOM.profileUserNameDisplay) DOM.profileUserNameDisplay.textContent = Utils.sanitizeHTML(user.name);
                        if (DOM.profileFullNameDisplay) DOM.profileFullNameDisplay.textContent = Utils.sanitizeHTML(user.name);
                        if (DOM.profileEmailDisplay) DOM.profileEmailDisplay.textContent = Utils.sanitizeHTML(user.email);
                        if (DOM.profilePhoneDisplay) DOM.profilePhoneDisplay.textContent = Utils.sanitizeHTML(user.phone || '-');
                        if (DOM.profileJoinedDateDisplay) DOM.profileJoinedDateDisplay.textContent = Utils.formatDate(user.joinedDate);
                    }
                },
                openProfileEditModal() {
                    if (!DOM.profileEditForm || !DOM.profileEditModalOverlay || !DOM.profileEditModalTitle) return;
                    DOM.profileEditForm.reset();
                    DOM.profileEditForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

                    const user = AppState.currentUser;
                    DOM.profileEditForm.profileEditName.value = user.name;
                    DOM.profileEditForm.profileEditEmail.value = user.email;
                    DOM.profileEditForm.profileEditPhone.value = user.phone || '';
                    DOM.profileEditForm.profileEditAvatarUrl.value = user.avatarUrl || '';

                    DOM.profileEditModalOverlay.classList.add('show');
                    DOM.profileEditModalOverlay.setAttribute('aria-hidden', 'false');
                    DOM.body.style.overflow = 'hidden';
                    DOM.profileEditForm.profileEditName.focus();
                },
                closeProfileEditModal() {
                    if (!DOM.profileEditModalOverlay) return;
                    DOM.profileEditModalOverlay.classList.remove('show');
                    DOM.profileEditModalOverlay.setAttribute('aria-hidden', 'true');
                    DOM.body.style.overflow = '';
                },
                validateProfileEditForm() {
                    let isValid = true;
                    const form = DOM.profileEditForm;
                    const fields = [
                        { input: form.profileEditName, validator: (val) => val.trim() !== '', msg: 'Nama lengkap wajib diisi.' },
                        { input: form.profileEditEmail, validator: Utils.isValidEmail, msg: 'Alamat email tidak valid.' },
                        { input: form.profileEditPhone, validator: Utils.isValidPhone, msg: 'Nomor telepon tidak valid (opsional, jika diisi harus valid).' },
                        { input: form.profileEditAvatarUrl, validator: Utils.isValidUrl, msg: 'URL Avatar tidak valid (opsional, jika diisi harus valid).' }
                    ];

                    fields.forEach(field => {
                        const feedback = field.input.nextElementSibling;
                        if (!field.validator(field.input.value)) {
                            field.input.classList.add('is-invalid');
                            if (feedback) feedback.textContent = field.msg;
                            isValid = false;
                        } else {
                            field.input.classList.remove('is-invalid');
                        }
                    });
                    return isValid;
                },
                handleProfileEditFormSubmit(e) {
                    e.preventDefault();
                    if (!this.validateProfileEditForm()) return;

                    const formData = new FormData(DOM.profileEditForm);
                    AppState.currentUser.name = formData.get('profileEditName').trim();
                    AppState.currentUser.email = formData.get('profileEditEmail').trim();
                    AppState.currentUser.phone = formData.get('profileEditPhone').trim() || '';
                    AppState.currentUser.avatarUrl = formData.get('profileEditAvatarUrl').trim() || 'https://i.pravatar.cc/100?u=DefaultUser';

                    this.showNotification('Menyimpan perubahan profil...', 'Proses', 'info', 1000);
                    setTimeout(() => {
                        this.renderUserProfileData();
                        this.closeProfileEditModal();
                        this.showNotification('Profil berhasil diperbarui.', 'Sukses', 'success');
                    }, 1000);
                },

                renderPaymentsTable() {
                    if (!DOM.paymentTableBody) return;
                    DOM.paymentTableBody.innerHTML = `<tr><td colspan="6" class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Memuat data...</td></tr>`;

                    setTimeout(() => {
                        if (AppState.paymentsData.length === 0) {
                            DOM.paymentTableBody.innerHTML = `<tr><td colspan="6" class="loading-placeholder"><i class="fas fa-file-invoice-dollar"></i> Tidak ada riwayat pembayaran.</td></tr>`;
                            return;
                        }
                        DOM.paymentTableBody.innerHTML = AppState.paymentsData.map(trx => `
                            <tr>
                                <td>${Utils.sanitizeHTML(trx.id)}</td>
                                <td>${Utils.formatDate(trx.date)}</td>
                                <td>${Utils.sanitizeHTML(trx.description)}</td>
                                <td>${Utils.formatCurrency(trx.amount)}</td>
                                <td><span class="badge badge--${Utils.sanitizeHTML(trx.status.toLowerCase().replace(/\s+/g, '-'))}">${Utils.sanitizeHTML(trx.status)}</span></td>
                                <td>
                                    <button type="button" class="btn btn--secondary btn-sm" data-action="view-transaction" data-transaction-id="${trx.id}" aria-label="Lihat detail transaksi ${trx.id}">
                                        <i class="fas fa-eye"></i> Detail
                                    </button>
                                    ${trx.status === 'Pending' ? `
                                    <button type="button" class="btn btn--primary btn-sm" data-action="pay-transaction" data-transaction-id="${trx.id}" aria-label="Bayar transaksi ${trx.id}" style="margin-left: var(--spacing-1);">
                                        <i class="fas fa-dollar-sign"></i> Bayar
                                    </button>` : ''}
                                </td>
                            </tr>
                        `).join('');
                    }, 500);
                },
                openTransactionDetailModal(transactionId) {
                    if (!DOM.transactionDetailModalOverlay || !DOM.transactionDetailModalBody || !DOM.transactionDetailModalTitle) return;

                    const transaction = AppState.paymentsData.find(t => t.id === transactionId);
                    if (!transaction) {
                        this.showNotification('Detail transaksi tidak ditemukan.', 'Error', 'error');
                        return;
                    }

                    DOM.transactionDetailModalTitle.textContent = `Detail Transaksi: ${Utils.sanitizeHTML(transaction.id)}`;
                    DOM.transactionDetailModalBody.innerHTML = `
                        <div class="transaction-detail-modal__info-grid">
                            <div class="transaction-detail-modal__info-item"><strong>ID Transaksi:</strong> <p>${Utils.sanitizeHTML(transaction.id)}</p></div>
                            <div class="transaction-detail-modal__info-item"><strong>Tanggal:</strong> <p>${Utils.formatDate(transaction.date)}</p></div>
                            <div class="transaction-detail-modal__info-item"><strong>Jumlah:</strong> <p style="font-weight:bold; color:var(--primary);">${Utils.formatCurrency(transaction.amount)}</p></div>
                            <div class="transaction-detail-modal__info-item"><strong>Status:</strong> <p><span class="badge badge--${Utils.sanitizeHTML(transaction.status.toLowerCase().replace(/\s+/g, '-'))}">${Utils.sanitizeHTML(transaction.status)}</span></p></div>
                            <div class="transaction-detail-modal__info-item"><strong>Tipe:</strong> <p>${Utils.sanitizeHTML(transaction.type)}</p></div>
                            <div class="transaction-detail-modal__info-item"><strong>Metode Pembayaran:</strong> <p>${Utils.sanitizeHTML(transaction.method)}</p></div>
                        </div>
                        <div class="transaction-detail-modal__info-item" style="margin-top:var(--spacing-3);">
                             <strong>Deskripsi:</strong> <p>${Utils.sanitizeHTML(transaction.description)}</p>
                        </div>
                        ${transaction.propertyName ? `
                            <div class="transaction-detail-modal__info-item">
                                <strong>Properti Terkait:</strong> <p>${Utils.sanitizeHTML(transaction.propertyName)} (ID: ${Utils.sanitizeHTML(transaction.propertyId)})</p>
                            </div>
                        ` : ''}
                        ${transaction.notes ? `
                            <div class="transaction-detail-modal__info-item">
                                <strong>Catatan:</strong>
                                <div class="transaction-detail-modal__notes">
                                    ${Utils.sanitizeHTML(transaction.notes)}
                                </div>
                            </div>
                        ` : ''}
                    `;

                    DOM.transactionDetailModalOverlay.classList.add('show');
                    DOM.transactionDetailModalOverlay.setAttribute('aria-hidden', 'false');
                    DOM.body.style.overflow = 'hidden';
                    const firstFocusable = DOM.transactionDetailModalOverlay.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                    if (firstFocusable) firstFocusable.focus();
                },
                closeTransactionDetailModal() {
                    if (!DOM.transactionDetailModalOverlay) return;
                    DOM.transactionDetailModalOverlay.classList.remove('show');
                    DOM.transactionDetailModalOverlay.setAttribute('aria-hidden', 'true');
                    DOM.body.style.overflow = '';
                    if (DOM.transactionDetailModalBody) DOM.transactionDetailModalBody.innerHTML = `<div class="loading-placeholder" style="min-height: 200px;"><i class="fas fa-spinner fa-spin"></i> Memuat detail transaksi...</div>`;
                },
                openPaymentModal(transactionId) {
                    if (!DOM.paymentModalOverlay || !DOM.paymentForm) return;
                    const transaction = AppState.paymentsData.find(t => t.id === transactionId);
                    if (!transaction || transaction.status !== 'Pending') {
                        this.showNotification('Tagihan ini tidak dapat dibayar atau sudah lunas.', 'Info', 'info');
                        return;
                    }
                    AppState.currentPaymentTransactionId = transactionId;
                    DOM.paymentForm.reset();
                    DOM.paymentDescription.textContent = Utils.sanitizeHTML(transaction.description);
                    DOM.paymentAmount.textContent = Utils.formatCurrency(transaction.amount);
                    DOM.paymentTransactionIdInput.value = transactionId;
                    DOM.payMethodBankRadio.checked = true;
                    this.updatePaymentMethodDetailsView();
                    DOM.paymentModalOverlay.classList.add('show');
                    DOM.paymentModalOverlay.setAttribute('aria-hidden', 'false');
                    DOM.body.style.overflow = 'hidden';
                    DOM.payMethodBankRadio.focus();
                },
                closePaymentModal() {
                    if (!DOM.paymentModalOverlay) return;
                    DOM.paymentModalOverlay.classList.remove('show');
                    DOM.paymentModalOverlay.setAttribute('aria-hidden', 'true');
                    DOM.body.style.overflow = '';
                    AppState.currentPaymentTransactionId = null;
                },
                updatePaymentMethodDetailsView() {
                    const selectedMethod = DOM.paymentForm.paymentMethod.value;
                    DOM.bankTransferDetailsDiv.style.display = selectedMethod === 'bank' ? 'block' : 'none';
                    DOM.eWalletDetailsDiv.style.display = selectedMethod === 'ewallet' ? 'block' : 'none';
                    if (selectedMethod === 'bank') DOM.confirmPaymentBtn.innerHTML = `<i class="fas fa-check-circle"></i> Konfirmasi & Upload Bukti`;
                    else DOM.confirmPaymentBtn.innerHTML = `<i class="fas fa-check-circle"></i> Bayar dengan ${Utils.capitalize(DOM.eWalletProviderSelect.value)}`;
                },
                handlePaymentFormSubmit(e) {
                    e.preventDefault();
                    if (!AppState.currentPaymentTransactionId) return;
                    const transaction = AppState.paymentsData.find(t => t.id === AppState.currentPaymentTransactionId);
                    if (!transaction) return;

                    const selectedMethod = DOM.paymentForm.paymentMethod.value;
                    this.showNotification('Memproses pembayaran...', 'Proses', 'info', 1500);

                    setTimeout(() => {
                        if (selectedMethod === 'bank') {
                            const proofFile = DOM.paymentProofInput.files[0];
                            transaction.status = 'Menunggu Verifikasi';
                            transaction.method = 'Transfer Bank' + (proofFile ? ' (Bukti Diupload)' : '');
                            this.showNotification(`Pembayaran untuk ${transaction.id} menunggu verifikasi. ${proofFile ? 'Bukti transfer diterima.' : ''}`, 'Sukses', 'success');
                        } else {
                            transaction.status = 'Lunas';
                            transaction.method = Utils.capitalize(DOM.eWalletProviderSelect.value);
                            this.showNotification(`Pembayaran untuk ${transaction.id} dengan ${transaction.method} berhasil!`, 'Sukses', 'success');
                        }
                        this.closePaymentModal();
                        if (AppState.activePage === 'payments') this.renderPaymentsTable();
                        const relatedBooking = AppState.bookings.find(b => b.property.includes(transaction.propertyName) && b.status === 'pending');
                        if (relatedBooking && transaction.status === 'Lunas') {
                            relatedBooking.status = 'active';
                            if (AppState.activePage === 'bookings') this.renderBookings();
                        }
                    }, 1500);
                },


                renderBookings() {
                    if (!DOM.bookingTableBody) return;
                    DOM.bookingTableBody.innerHTML = `<tr><td colspan="6" class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Memuat data booking...</td></tr>`;
                    setTimeout(() => {
                        if (AppState.bookings.length === 0) {
                            DOM.bookingTableBody.innerHTML = `<tr><td colspan="6" class="loading-placeholder"><i class="fas fa-calendar-times"></i> Belum ada data booking.</td></tr>`;
                            return;
                        }
                        DOM.bookingTableBody.innerHTML = AppState.bookings.map(booking => `
                        <tr>
                            <td>${Utils.sanitizeHTML(booking.id)}</td>
                            <td>${Utils.sanitizeHTML(booking.tenant)}</td>
                            <td>${Utils.sanitizeHTML(booking.property)}</td>
                            <td>${Utils.formatDate(booking.date)}</td>
                            <td><span class="badge badge--${Utils.sanitizeHTML(booking.status)}">${Utils.sanitizeHTML(Utils.capitalize(booking.status.replace('-', ' ')))}</span></td>
                            <td>
                                <button type="button" class="btn btn--secondary btn-sm" data-action="edit" data-id="${booking.id}" aria-label="Edit booking ${booking.id}"><i class="fas fa-edit"></i> Edit</button>
                                <button type="button" class="btn btn--danger btn-sm" data-action="delete" data-id="${booking.id}" aria-label="Hapus booking ${booking.id}"><i class="fas fa-trash-alt"></i> Hapus</button>
                            </td>
                        </tr>
                    `).join('');
                        this.setupBookingActionButtons();
                    }, 500);
                },
                setupBookingActionButtons() {
                    if (!DOM.bookingTableBody) return;
                    DOM.bookingTableBody.querySelectorAll('button[data-action]').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const action = e.currentTarget.dataset.action;
                            const id = e.currentTarget.dataset.id;
                            if (action === 'edit') this.openBookingModal(id);
                            else if (action === 'delete') this.deleteBooking(id);
                        });
                    });
                },
                openBookingModal(bookingId = null, prefillData = null) {
                    if (!DOM.bookingForm || !DOM.bookingModalOverlay || !DOM.bookingModalTitle || !DOM.bookingIdInput) return;
                    DOM.bookingForm.reset();
                    DOM.bookingForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                    AppState.editingBookingId = bookingId;
                    if (bookingId) {
                        const booking = AppState.bookings.find(b => b.id === bookingId);
                        if (!booking) {
                            this.showNotification('Data booking tidak ditemukan.', 'Error', 'error');
                            return;
                        }
                        DOM.bookingModalTitle.textContent = 'Edit Data Booking';
                        DOM.bookingIdInput.value = booking.id;
                        DOM.bookingForm.tenantName.value = booking.tenant;
                        DOM.bookingForm.property.value = booking.property;
                        DOM.bookingForm.bookingDate.value = booking.date;
                        DOM.bookingForm.bookingStatus.value = booking.status;
                    } else {
                        DOM.bookingModalTitle.textContent = 'Tambah Booking Baru';
                        DOM.bookingIdInput.value = '';
                        const today = new Date();
                        DOM.bookingForm.bookingDate.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                        if (prefillData && prefillData.propertyName) DOM.bookingForm.property.value = prefillData.propertyName;
                    }
                    DOM.bookingModalOverlay.classList.add('show');
                    DOM.bookingModalOverlay.setAttribute('aria-hidden', 'false');
                    DOM.body.style.overflow = 'hidden';
                    (prefillData && prefillData.propertyName ? DOM.bookingForm.tenantName : DOM.bookingForm.property).focus();
                },
                closeBookingModal() {
                    if (!DOM.bookingModalOverlay) return;
                    DOM.bookingModalOverlay.classList.remove('show');
                    DOM.bookingModalOverlay.setAttribute('aria-hidden', 'true');
                    DOM.body.style.overflow = '';
                    AppState.editingBookingId = null;
                },
                handleBookingFormSubmit(e) {
                    e.preventDefault();
                    if (!this.validateBookingForm()) return;
                    const formData = new FormData(DOM.bookingForm);
                    const bookingData = {
                        id: formData.get('bookingId') || Utils.generateId('bk'),
                        tenant: formData.get('tenantName').trim(),
                        property: formData.get('property').trim(),
                        date: formData.get('bookingDate'),
                        status: formData.get('bookingStatus')
                    };
                    this.showNotification('Menyimpan data booking...', 'Proses', 'info', 1000);
                    setTimeout(() => {
                        if (AppState.editingBookingId) {
                            const index = AppState.bookings.findIndex(b => b.id === AppState.editingBookingId);
                            if (index > -1) AppState.bookings[index] = bookingData;
                            this.showNotification('Data booking berhasil diperbarui.', 'Sukses', 'success');
                        } else {
                            AppState.bookings.unshift(bookingData);
                            this.showNotification('Booking baru berhasil ditambahkan.', 'Sukses', 'success');
                            if (bookingData.status === 'pending') {
                                const propertyDetails = AppState.properties.find(p => p.title.toLowerCase().includes(bookingData.property.toLowerCase())) || { price: 5000000, title: bookingData.property };
                                const paymentRecord = {
                                    id: Utils.generateId('TRX'),
                                    date: new Date().toISOString().split('T')[0],
                                    description: `Pembayaran Booking ${bookingData.property}`,
                                    amount: propertyDetails.price,
                                    status: 'Pending',
                                    type: 'Booking',
                                    propertyId: propertyDetails.id || null,
                                    propertyName: propertyDetails.title,
                                    method: 'Belum Dipilih',
                                    notes: `Tagihan untuk booking ID: ${bookingData.id}`
                                };
                                AppState.paymentsData.unshift(paymentRecord);
                                if (AppState.activePage === 'payments') this.renderPaymentsTable();
                            }
                        }
                        if (AppState.activePage === 'bookings') this.renderBookings();
                        this.closeBookingModal();
                    }, 1000);
                },
                validateBookingForm() {
                    let isValid = true;
                    const requiredFields = ['tenantName', 'property', 'bookingDate', 'bookingStatus'];
                    requiredFields.forEach(fieldName => {
                        const input = DOM.bookingForm[fieldName];
                        const feedback = input.nextElementSibling && input.nextElementSibling.classList.contains('invalid-feedback') ? input.nextElementSibling : (input.parentElement.querySelector('.invalid-feedback'));
                        let value = typeof input.value === 'string' ? input.value.trim() : input.value;
                        if (!value) {
                            input.classList.add('is-invalid');
                            if (feedback) feedback.style.display = 'block';
                            isValid = false;
                        } else {
                            input.classList.remove('is-invalid');
                            if (feedback) feedback.style.display = 'none';
                        }
                    });
                    return isValid;
                },
                async deleteBooking(bookingId) {
                    const booking = AppState.bookings.find(b => b.id === bookingId);
                    const tenantName = booking ? booking.tenant : bookingId;
                    const confirmed = await this.showAlertConfirm(
                        `Yakin hapus booking <strong>${Utils.sanitizeHTML(tenantName)}</strong> (ID: ${Utils.sanitizeHTML(bookingId)})?`,
                        'Konfirmasi Hapus', 'Ya, Hapus', 'btn--danger'
                    );
                    if (confirmed) {
                        this.showNotification('Menghapus booking...', 'Proses', 'info', 1000);
                        setTimeout(() => {
                            AppState.bookings = AppState.bookings.filter(b => b.id !== bookingId);
                            if (AppState.activePage === 'bookings') this.renderBookings();
                            this.showNotification(`Booking ${Utils.sanitizeHTML(tenantName)} (ID: ${Utils.sanitizeHTML(bookingId)}) dihapus.`, 'Sukses', 'success');
                        }, 1000);
                    } else {
                        this.showNotification('Penghapusan booking dibatalkan.', 'Dibatalkan', 'info');
                    }
                },

                _closeAlertConfirmModalVisuals() {
                    if (!DOM.alertModalOverlay) return;
                    DOM.alertModalOverlay.classList.remove('show');
                    DOM.alertModalOverlay.setAttribute('aria-hidden', 'true');
                    DOM.body.style.overflow = '';
                },
                showAlertConfirm(message, title = 'Konfirmasi', confirmButtonText = 'Ya, Lanjutkan', confirmButtonClass = 'btn--primary', cancelButtonText = 'Batal') {
                    return new Promise((resolve) => {
                        if (!DOM.alertModalOverlay || !DOM.alertModalTitle || !DOM.alertModalMessage || !DOM.alertModalConfirmBtn || !DOM.alertModalCancelBtn) {
                            resolve(window.confirm(message.replace(/<strong>|<\/strong>/g, '')));
                            return;
                        }
                        DOM.alertModalTitle.textContent = title;
                        DOM.alertModalMessage.innerHTML = Utils.sanitizeHTML(message);
                        DOM.alertModalConfirmBtn.textContent = confirmButtonText;
                        DOM.alertModalConfirmBtn.className = `btn ${confirmButtonClass}`;
                        DOM.alertModalCancelBtn.textContent = cancelButtonText;
                        let confirmHandler, cancelHandler, escapeHandler, overlayClickHandler, closeButtonClickHandler;
                        const cleanupAndResolve = (value) => {
                            this._closeAlertConfirmModalVisuals();
                            DOM.alertModalConfirmBtn.removeEventListener('click', confirmHandler);
                            DOM.alertModalCancelBtn.removeEventListener('click', cancelHandler);
                            const closeBtn = DOM.alertModalOverlay.querySelector('[data-dismiss-alert]');
                            if (closeBtn) closeBtn.removeEventListener('click', closeButtonClickHandler);
                            document.removeEventListener('keydown', escapeHandler);
                            DOM.alertModalOverlay.removeEventListener('click', overlayClickHandler);
                            resolve(value);
                        };
                        confirmHandler = () => cleanupAndResolve(true);
                        cancelHandler = () => cleanupAndResolve(false);
                        escapeHandler = (e) => { if (e.key === 'Escape' && DOM.alertModalOverlay.classList.contains('show')) cancelHandler(); };
                        overlayClickHandler = (e) => { if (e.target === DOM.alertModalOverlay) cancelHandler(); };
                        closeButtonClickHandler = () => cancelHandler();
                        DOM.alertModalConfirmBtn.addEventListener('click', confirmHandler, { once: true });
                        DOM.alertModalCancelBtn.addEventListener('click', cancelHandler, { once: true });
                        const closeBtn = DOM.alertModalOverlay.querySelector('[data-dismiss-alert]');
                        if (closeBtn) closeBtn.addEventListener('click', closeButtonClickHandler, { once: true });
                        document.addEventListener('keydown', escapeHandler);
                        DOM.alertModalOverlay.addEventListener('click', overlayClickHandler);
                        DOM.alertModalOverlay.classList.add('show');
                        DOM.alertModalOverlay.setAttribute('aria-hidden', 'false');
                        DOM.body.style.overflow = 'hidden';
                        DOM.alertModalConfirmBtn.focus();
                    });
                },

                createPropertyCardHTML(property, isFavoritePage = false, isRecentlyViewedPage = false) {
                    if (!property || !property.specs) {
                        console.error("Invalid property data:", property);
                        return `<div class="card"><p class="loading-placeholder"><i class="fas fa-exclamation-triangle"></i> Error: Data properti tidak valid.</p></div>`;
                    }
                    const isFavorited = AppState.favorites.includes(property.id);
                    let favoriteIcon, favoriteText, favoriteAction, favoriteButtonClass;
                    if (isFavoritePage) {
                        favoriteIcon = 'fas fa-trash-alt'; favoriteText = 'Hapus Favorit'; favoriteAction = 'remove-favorite'; favoriteButtonClass = 'btn--danger';
                    } else {
                        favoriteIcon = isFavorited ? 'fas fa-heart text-danger' : 'far fa-heart'; favoriteText = isFavorited ? 'Difavoritkan' : 'Simpan'; favoriteAction = 'favorite'; favoriteButtonClass = isFavorited ? 'btn--primary' : 'btn--secondary';
                    }
                    return `
                    <div class="apartment-card card" data-property-id="${property.id}">
                        <img src="${Utils.sanitizeHTML(property.image)}" alt="Gambar ${Utils.sanitizeHTML(property.title)}">
                        <div class="card-body">
                            <h3>${Utils.sanitizeHTML(property.title)}</h3>
                            <p style="margin-bottom: var(--spacing-1);">${Utils.sanitizeHTML(property.shortDescription || property.longDescription.substring(0, 100) + '...')}</p>
                            <p><i class="fas fa-bed"></i> ${Utils.sanitizeHTML(property.specs.bedrooms)} KT
                               <i class="fas fa-bath" style="margin-left:var(--spacing-2)"></i> ${Utils.sanitizeHTML(property.specs.bathrooms)} KM
                               <i class="fas fa-ruler-combined" style="margin-left:var(--spacing-2)"></i> ${Utils.sanitizeHTML(property.specs.area)} m²</p>
                            <p style="font-weight:bold; color:var(--primary); font-size:var(--font-size-md); margin-top:var(--spacing-2);">${Utils.sanitizeHTML(property.priceDisplay)}</p>
                            <div class="apartment-actions">
                                <button type="button" class="btn btn--primary btn-sm" data-action="detail" data-property-id="${property.id}"><i class="fas fa-info-circle"></i> Detail</button>
                                <button type="button" class="btn ${favoriteButtonClass} btn-sm" data-action="${favoriteAction}" data-property-id="${property.id}" aria-pressed="${isFavorited.toString()}">
                                    <i class="${favoriteIcon}"></i> ${favoriteText}
                                </button>
                            </div>
                        </div>
                    </div>`;
                },
                renderProperties() {
                    if (!DOM.propertiesGrid) return;
                    DOM.propertiesGrid.innerHTML = `<div class="loading-placeholder" style="grid-column: 1 / -1;"><i class="fas fa-spinner fa-spin"></i> Memuat properti...</div>`;
                    setTimeout(() => {
                        let filteredProperties = AppState.properties;

                        if (AppState.searchQuery) {
                            filteredProperties = filteredProperties.filter(p =>
                                p.title.toLowerCase().includes(AppState.searchQuery) ||
                                (p.shortDescription && p.shortDescription.toLowerCase().includes(AppState.searchQuery)) ||
                                (p.longDescription && p.longDescription.toLowerCase().includes(AppState.searchQuery))
                            );
                        }

                        if (AppState.filters.priceRange) {
                            const [minStr, maxStr] = AppState.filters.priceRange.split('-');
                            const minPrice = parseInt(minStr);
                            const maxPrice = maxStr === 'Infinity' ? Infinity : parseInt(maxStr);
                            filteredProperties = filteredProperties.filter(p => p.price >= minPrice && p.price <= maxPrice);
                        }
                        if (AppState.filters.bedrooms) {
                            const [minBedsStr, maxBedsStr] = AppState.filters.bedrooms.split('-');
                            const minBeds = parseInt(minBedsStr);
                            const maxBeds = maxBedsStr === 'Infinity' ? Infinity : parseInt(maxBedsStr);
                            filteredProperties = filteredProperties.filter(p => p.specs.bedrooms >= minBeds && p.specs.bedrooms <= maxBeds);
                        }
                        if (AppState.filters.amenities) {
                            filteredProperties = filteredProperties.filter(p => p.specs.amenities && p.specs.amenities.includes(AppState.filters.amenities));
                        }
                        if (filteredProperties.length === 0) {
                            DOM.propertiesGrid.innerHTML = '<p class="loading-placeholder" style="grid-column: 1 / -1;"><i class="fas fa-search-minus"></i> Tidak ada properti yang cocok.</p>';
                            return;
                        }
                        DOM.propertiesGrid.innerHTML = filteredProperties.map(prop => this.createPropertyCardHTML(prop)).join('');
                    }, 300);
                },
                applyPropertyFilters() {
                    if (DOM.priceRangeFilter) AppState.filters.priceRange = DOM.priceRangeFilter.value;
                    if (DOM.bedroomsFilter) AppState.filters.bedrooms = DOM.bedroomsFilter.value;
                    if (DOM.amenitiesFilter) AppState.filters.amenities = DOM.amenitiesFilter.value;
                    this.renderProperties();
                    this.showNotification('Filter properti diterapkan.', 'Filter Aktif', 'info');
                },

                toggleFavorite(propertyId, buttonElement = null) {
                    const index = AppState.favorites.indexOf(propertyId);
                    const property = AppState.properties.find(p => p.id === propertyId);
                    if (!property) {
                        this.showNotification('Properti tidak ditemukan.', 'Error', 'error'); return;
                    }
                    if (index === -1) {
                        AppState.favorites.push(propertyId);
                        this.showNotification(`"${Utils.sanitizeHTML(property.title)}" ditambahkan ke favorit.`, 'Favorit', 'success');
                        if (buttonElement) {
                            buttonElement.innerHTML = `<i class="fas fa-heart text-danger"></i> Difavoritkan`;
                            buttonElement.classList.remove('btn--secondary', 'btn--danger');
                            buttonElement.classList.add('btn--primary');
                            buttonElement.setAttribute('aria-pressed', 'true');
                            buttonElement.dataset.action = 'favorite';
                        }
                    } else {
                        AppState.favorites.splice(index, 1);
                        this.showNotification(`"${Utils.sanitizeHTML(property.title)}" dihapus dari favorit.`, 'Favorit', 'info');
                        if (buttonElement && buttonElement.closest('#favoritesGrid')) {
                            // No visual change needed here as the card will be removed
                        } else if (buttonElement) {
                            buttonElement.innerHTML = `<i class="far fa-heart"></i> Simpan`;
                            buttonElement.classList.remove('btn--primary', 'btn--danger');
                            buttonElement.classList.add('btn--secondary');
                            buttonElement.setAttribute('aria-pressed', 'false');
                            buttonElement.dataset.action = 'favorite';
                        }
                    }
                    if (AppState.activePage === 'favorites') this.renderFavorites();

                    this.updateFavoriteButtonsAcrossPages(propertyId);
                },
                updateFavoriteButtonsAcrossPages(propertyId) {
                    const isFavorited = AppState.favorites.includes(propertyId);
                    [DOM.propertiesGrid, DOM.recentlyViewedGrid].forEach(grid => {
                        if (grid) {
                            const button = grid.querySelector(`.apartment-card[data-property-id="${propertyId}"] button[data-action="favorite"], .apartment-card[data-property-id="${propertyId}"] button[data-action="remove-favorite"]`);
                            if (button) {
                                button.innerHTML = `<i class="${isFavorited ? 'fas fa-heart text-danger' : 'far fa-heart'}"></i> ${isFavorited ? 'Difavoritkan' : 'Simpan'}`;
                                button.classList.toggle('btn--primary', isFavorited);
                                button.classList.toggle('btn--secondary', !isFavorited);
                                button.classList.remove('btn--danger');
                                button.setAttribute('aria-pressed', isFavorited.toString());
                                button.dataset.action = 'favorite';
                            }
                        }
                    });
                },
                renderFavorites() {
                    if (!DOM.favoritesGrid) return;
                    DOM.favoritesGrid.innerHTML = `<div class="loading-placeholder" style="grid-column: 1 / -1;"><i class="fas fa-spinner fa-spin"></i> Memuat favorit...</div>`;
                    setTimeout(() => {
                        const favoriteProperties = AppState.properties.filter(prop => AppState.favorites.includes(prop.id));
                        if (favoriteProperties.length === 0) {
                            DOM.favoritesGrid.innerHTML = '<p class="loading-placeholder" style="grid-column: 1 / -1;"><i class="fas fa-heart-broken"></i> Anda belum punya properti favorit.</p>';
                            return;
                        }
                        DOM.favoritesGrid.innerHTML = favoriteProperties.map(prop => this.createPropertyCardHTML(prop, true)).join('');
                    }, 300);
                },
                addToRecentlyViewed(propertyId) {

                    AppState.recentlyViewed = AppState.recentlyViewed.filter(id => id !== propertyId);
                    AppState.recentlyViewed.unshift(propertyId);
                    if (AppState.recentlyViewed.length > 3) AppState.recentlyViewed.pop();

                    if (DOM.recentlyViewedGrid && AppState.activePage === 'properties') this.renderRecentlyViewed();
                },
                renderRecentlyViewed() {
                    if (!DOM.recentlyViewedGrid) return;
                    const viewedProperties = AppState.properties
                        .filter(prop => AppState.recentlyViewed.includes(prop.id))
                        .sort((a, b) => AppState.recentlyViewed.indexOf(a.id) - AppState.recentlyViewed.indexOf(b.id));
                    if (viewedProperties.length === 0) {
                        DOM.recentlyViewedGrid.innerHTML = '<p class="loading-placeholder" style="grid-column: 1 / -1;"><i class="fas fa-history"></i> Belum ada riwayat penelusuran.</p>';
                        return;
                    }
                    DOM.recentlyViewedGrid.innerHTML = viewedProperties.map(prop => this.createPropertyCardHTML(prop, false, true)).join('');
                },
                openPropertyDetailModal(propertyId) {
                    if (!DOM.propertyDetailModalOverlay || !DOM.propertyDetailModalBody || !DOM.propertyDetailModalTitle) return;
                    AppState.currentDetailPropertyId = propertyId;
                    this.addToRecentlyViewed(propertyId);
                    const property = AppState.properties.find(p => p.id === propertyId);
                    if (!property) {
                        this.showNotification('Detail properti tidak ditemukan.', 'Error', 'error'); return;
                    }
                    DOM.propertyDetailModalTitle.textContent = Utils.sanitizeHTML(property.title);
                    DOM.propertyDetailModalBody.innerHTML = `<div class="loading-placeholder" style="min-height: 300px;"><i class="fas fa-spinner fa-spin"></i> Memuat detail...</div>`;
                    setTimeout(() => {
                        const amenitiesHTML = [...property.specs.amenities, ...(property.additionalAmenities || [])]
                            .map(amenity => `<li>${Utils.sanitizeHTML(Utils.capitalize(amenity.replace('-', ' ')))}</li>`).join('');
                        const galleryHTML = property.gallery && property.gallery.length > 0
                            ? property.gallery.map((imgUrl, index) =>
                                `<img src="${Utils.sanitizeHTML(imgUrl)}" alt="Galeri ${index + 1}" class="${index === 0 ? 'active-thumbnail' : ''}" data-img-src="${Utils.sanitizeHTML(imgUrl)}">`).join('')
                            : '<p>Tidak ada gambar galeri tambahan.</p>';
                        const mainImageSrc = (property.gallery && property.gallery.length > 0) ? property.gallery[0] : property.image;
                        DOM.propertyDetailModalBody.innerHTML = `
                            <div class="property-detail-modal__main-image-container">
                                <img src="${Utils.sanitizeHTML(mainImageSrc)}" alt="Gambar Utama ${Utils.sanitizeHTML(property.title)}" class="property-detail-modal__main-image" id="propertyDetailMainImage">
                            </div>
                            ${property.gallery && property.gallery.length > 1 ? `<div class="property-detail-modal__gallery" id="propertyDetailThumbnailGallery">${galleryHTML}</div>` : ''}
                            <h3 class="property-detail-modal__section-title">Informasi Utama</h3>
                            <div class="property-detail-modal__info-grid">
                                <div class="property-detail-modal__info-item"><strong>Harga Sewa:</strong> <p>${Utils.sanitizeHTML(property.priceDisplay)}</p></div>
                                <div class="property-detail-modal__info-item"><strong>Kamar Tidur:</strong> <p>${Utils.sanitizeHTML(property.specs.bedrooms)}</p></div>
                                <div class="property-detail-modal__info-item"><strong>Kamar Mandi:</strong> <p>${Utils.sanitizeHTML(property.specs.bathrooms)}</p></div>
                                <div class="property-detail-modal__info-item"><strong>Luas:</strong> <p>${Utils.sanitizeHTML(property.specs.area)} m²</p></div>
                                <div class="property-detail-modal__info-item"><strong>Tersedia Mulai:</strong> <p>${Utils.formatDate(property.availabilityDate)}</p></div>
                            </div>
                            <h3 class="property-detail-modal__section-title">Deskripsi Lengkap</h3><p>${Utils.sanitizeHTML(property.longDescription)}</p>
                            <h3 class="property-detail-modal__section-title">Fasilitas</h3><ul class="property-detail-modal__amenities-list">${amenitiesHTML}</ul>
                            ${property.floorPlan ? `<h3 class="property-detail-modal__section-title">Denah Lantai</h3><img src="${Utils.sanitizeHTML(property.floorPlan)}" alt="Denah Lantai" style="max-width:100%; border-radius: var(--radius-md); margin-bottom: var(--spacing-3);">` : ''}
                            <h3 class="property-detail-modal__section-title">Lokasi</h3><p><strong>Alamat:</strong> ${Utils.sanitizeHTML(property.location.address)}</p><div class="property-detail-modal__map-placeholder"><i class="fas fa-map-marked-alt"></i> Peta Lokasi (Placeholder)</div>
                            ${property.rules ? `<h3 class="property-detail-modal__section-title">Aturan Properti</h3><p>${Utils.sanitizeHTML(property.rules)}</p>` : ''}
                            <h3 class="property-detail-modal__section-title">Informasi Kontak Agen</h3>
                            <p><strong>Nama Agen:</strong> ${Utils.sanitizeHTML(property.contact.agentName)}</p>
                            <p><strong>Telepon:</strong> <a href="tel:${Utils.sanitizeHTML(property.contact.agentPhone)}">${Utils.sanitizeHTML(property.contact.agentPhone)}</a></p>
                            <p><strong>Email:</strong> <a href="mailto:${Utils.sanitizeHTML(property.contact.agentEmail)}">${Utils.sanitizeHTML(property.contact.agentEmail)}</a></p>`;
                        this.setupPropertyDetailGalleryListeners();
                    }, 200);
                    DOM.propertyDetailModalOverlay.classList.add('show');
                    DOM.propertyDetailModalOverlay.setAttribute('aria-hidden', 'false');
                    DOM.body.style.overflow = 'hidden';
                    const firstFocusable = DOM.propertyDetailModalOverlay.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                    if (firstFocusable) firstFocusable.focus();
                },
                closePropertyDetailModal() {
                    if (!DOM.propertyDetailModalOverlay) return;
                    DOM.propertyDetailModalOverlay.classList.remove('show');
                    DOM.propertyDetailModalOverlay.setAttribute('aria-hidden', 'true');
                    DOM.body.style.overflow = '';
                    AppState.currentDetailPropertyId = null;
                    if (DOM.propertyDetailModalBody) DOM.propertyDetailModalBody.innerHTML = `<div class="loading-placeholder" style="min-height: 300px;"><i class="fas fa-spinner fa-spin"></i> Memuat detail...</div>`;
                },
                setupPropertyDetailGalleryListeners() {
                    const galleryContainer = document.getElementById('propertyDetailThumbnailGallery');
                    const mainImage = document.getElementById('propertyDetailMainImage');
                    if (galleryContainer && mainImage) {
                        galleryContainer.addEventListener('click', (e) => {
                            if (e.target.tagName === 'IMG') {
                                mainImage.src = e.target.dataset.imgSrc;
                                galleryContainer.querySelectorAll('img').forEach(img => img.classList.remove('active-thumbnail'));
                                e.target.classList.add('active-thumbnail');
                            }
                        });
                    }
                },

                // Messaging System Methods
                initMessagesPage() {
                    if (!DOM.conversationList || !DOM.chatArea) return;
                    this.renderConversationsList();
                    if (AppState.activeConversationId) this.renderMessagesForConversation(AppState.activeConversationId);
                    else this.showNoChatSelected();
                },
                renderConversationsList() {
                    if (!DOM.conversationList) return;
                    DOM.conversationList.innerHTML = `<li class="loading-placeholder" style="height: 100%;"><i class="fas fa-spinner fa-spin"></i></li>`;
                    let filteredConversations = AppState.conversations;
                    const searchTerm = DOM.conversationSearchInput.value.toLowerCase();
                    if (searchTerm) {
                        filteredConversations = filteredConversations.filter(conv =>
                            conv.partnerName.toLowerCase().includes(searchTerm) || conv.lastMessage.toLowerCase().includes(searchTerm)
                        );
                    }
                    filteredConversations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    setTimeout(() => {
                        if (filteredConversations.length === 0) {
                            DOM.conversationList.innerHTML = `<li class="loading-placeholder" style="height: 100%;"><i class="fas fa-comments-dollar"></i> Tidak ada percakapan.</li>`; return;
                        }
                        DOM.conversationList.innerHTML = filteredConversations.map(conv => `
                            <li class="messages-layout__conversation-item ${conv.id === AppState.activeConversationId ? 'active' : ''}" data-conv-id="${conv.id}" tabindex="0" role="button" aria-label="Percakapan dengan ${Utils.sanitizeHTML(conv.partnerName)}">
                                <strong>${Utils.sanitizeHTML(conv.partnerName)}</strong>
                                <p>${conv.unread > 0 ? `<strong>(${conv.unread})</strong> ` : ''}${Utils.sanitizeHTML(conv.lastMessage)}</p>
                                <small style="font-size: var(--font-size-xs); opacity: 0.7;">${Utils.formatTime(conv.timestamp)}</small>
                            </li>`).join('');
                    }, 200);
                },
                setActiveConversation(convId) {
                    AppState.activeConversationId = convId;
                    const conversation = AppState.conversations.find(c => c.id === convId);
                    if (conversation) {
                        conversation.unread = 0;
                        conversation.typing = false; // Stop showing typing if user clicks
                    }
                    this.renderConversationsList();
                    this.renderMessagesForConversation(convId);
                    DOM.noChatSelected.style.display = 'none';
                    DOM.activeChatContent.style.display = 'flex';
                },
                renderMessagesForConversation(convId) {
                    if (!DOM.messageList || !DOM.chatPartnerName) return;
                    const conversation = AppState.conversations.find(c => c.id === convId);
                    const messages = AppState.messages[convId] || [];
                    if (!conversation) { this.showNoChatSelected(); return; }

                    DOM.chatPartnerName.textContent = Utils.sanitizeHTML(conversation.partnerName);
                    DOM.messageList.innerHTML = ''; // Clear existing messages

                    messages.forEach((msg, index) => {
                        const messageEl = document.createElement('div');
                        messageEl.className = `messages-layout__message messages-layout__message--${msg.sender === 'user' ? 'sent' : 'received'}`;
                        messageEl.innerHTML = `
                            <div>${Utils.sanitizeHTML(msg.text)}</div>
                            <div class="messages-layout__message-meta">${Utils.formatTime(msg.timestamp)}</div>`;
                        DOM.messageList.appendChild(messageEl);
                        // Only animate the last message if it's new, or all if it's initial load (simplified: animate all)
                        requestAnimationFrame(() => {
                            messageEl.classList.add('message-arriving');
                        });
                    });

                    if (conversation.typing) {
                        this.showTypingIndicator(DOM.messageList, 'partner');
                    }

                    DOM.messageList.scrollTop = DOM.messageList.scrollHeight;
                    DOM.messageInput.focus();
                },
                showTypingIndicator(container, senderType) {
                    const typingEl = document.createElement('div');
                    typingEl.className = `messages-layout__message messages-layout__message--${senderType === 'user' ? 'sent' : 'received'} messages-layout__message--typing message-arriving`; // Also animate typing indicator
                    typingEl.innerHTML = `<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>`;
                    container.appendChild(typingEl);
                    container.scrollTop = container.scrollHeight;
                },
                removeTypingIndicator(container) {
                    const typingEl = container.querySelector('.messages-layout__message--typing');
                    if (typingEl) typingEl.remove();
                },
                sendUserMessage() {
                    if (!AppState.activeConversationId || !DOM.messageInput) return;
                    const text = DOM.messageInput.value.trim();
                    if (!text) return;

                    const newMessage = { id: Utils.generateId('msg'), sender: 'user', text: text, timestamp: new Date().toISOString() };
                    AppState.messages[AppState.activeConversationId].push(newMessage);

                    const conversation = AppState.conversations.find(c => c.id === AppState.activeConversationId);
                    if (conversation) {
                        conversation.lastMessage = text;
                        conversation.timestamp = newMessage.timestamp;
                        conversation.typing = false; // User sent a message, partner is not typing anymore from previous interaction
                    }

                    this.renderMessagesForConversation(AppState.activeConversationId); // Will render the new user message
                    this.renderConversationsList();

                    DOM.messageInput.value = '';
                    DOM.messageInput.style.height = 'auto';
                    this.simulatePartnerReply(AppState.activeConversationId, text);
                },
                simulatePartnerReply(convId, userMessageText) {
                    const conversation = AppState.conversations.find(c => c.id === convId);
                    if (!conversation || conversation.partnerName === "Green Valley Admin") return;

                    this.removeTypingIndicator(DOM.messageList); // Remove any old one
                    conversation.typing = true;
                    this.showTypingIndicator(DOM.messageList, 'partner');

                    setTimeout(() => {
                        conversation.typing = false;
                        this.removeTypingIndicator(DOM.messageList);

                        let replyText = "Terima kasih atas pesannya. Saya akan segera merespons.";
                        if (userMessageText.toLowerCase().includes("halo") || userMessageText.toLowerCase().includes("hai")) replyText = "Halo juga! Ada yang bisa saya bantu?";
                        else if (userMessageText.toLowerCase().includes("tersedia") || userMessageText.toLowerCase().includes("available")) replyText = "Ya, unit tersebut masih tersedia. Apakah Anda ingin menjadwalkan kunjungan?";
                        else if (userMessageText.toLowerCase().includes("harga")) replyText = "Untuk informasi harga detail, silakan cek deskripsi properti atau hubungi kami langsung.";

                        const partnerMessage = { id: Utils.generateId('msg'), sender: 'partner', text: replyText, timestamp: new Date().toISOString() };
                        AppState.messages[convId].push(partnerMessage);
                        conversation.lastMessage = replyText;
                        conversation.timestamp = partnerMessage.timestamp;

                        if (AppState.activePage === 'messages' && AppState.activeConversationId === convId) {
                            // Add just the new message with animation
                            const messageEl = document.createElement('div');
                            messageEl.className = `messages-layout__message messages-layout__message--received`;
                            messageEl.innerHTML = `
                                <div>${Utils.sanitizeHTML(partnerMessage.text)}</div>
                                <div class="messages-layout__message-meta">${Utils.formatTime(partnerMessage.timestamp)}</div>`;
                            DOM.messageList.appendChild(messageEl);
                            requestAnimationFrame(() => {
                                messageEl.classList.add('message-arriving');
                            });
                            DOM.messageList.scrollTop = DOM.messageList.scrollHeight;
                        }
                        this.renderConversationsList();
                        this.showNotification(`Pesan baru dari ${conversation.partnerName}`, 'Pesan Masuk', 'info');
                    }, 1500 + Math.random() * 2000);
                },

                showNoChatSelected() {
                    DOM.noChatSelected.style.display = 'flex';
                    DOM.activeChatContent.style.display = 'none';
                },

                initCsChatWidget() {
                    if (!DOM.csChatWidget) return;
                    const initialMessage = { sender: 'cs', text: 'Selamat datang di Green Valley! Ada yang bisa kami bantu?', timestamp: new Date().toISOString() };
                    AppState.csChatMessages.push(initialMessage);
                    this.renderCsChatMessages(true); // Initial render, animate first message
                },
                toggleCsChatWidget(forceState) {
                    if (!DOM.csChatPopup || !DOM.csChatToggleBtn) return;
                    const shouldOpen = forceState !== undefined ? forceState : !AppState.isCsChatWidgetOpen;
                    AppState.isCsChatWidgetOpen = shouldOpen;
                    DOM.csChatPopup.classList.toggle('open', shouldOpen);
                    DOM.csChatToggleBtn.setAttribute('aria-expanded', shouldOpen.toString());
                    DOM.csChatToggleBtn.innerHTML = `<i class="fas fa-${shouldOpen ? 'times' : 'comments'}"></i>`;
                    DOM.csChatToggleBtn.setAttribute('aria-label', `${shouldOpen ? 'Tutup' : 'Buka'} Customer Service Chat`);
                    if (shouldOpen) { DOM.csChatMessageInput.focus(); this.renderCsChatMessages(); }
                },
                renderCsChatMessages(isInitial = false) {
                    if (!DOM.csChatMessages) return;
                    DOM.csChatMessages.innerHTML = ''; // Clear
                    AppState.csChatMessages.forEach((msg, index) => {
                        const messageEl = document.createElement('div');
                        messageEl.className = `cs-chat-widget__message ${msg.sender}`;
                        messageEl.innerHTML = `
                            <div>${Utils.sanitizeHTML(msg.text)}</div>
                            <div class="cs-chat-widget__message-time">${Utils.formatTime(msg.timestamp)}</div>`;
                        DOM.csChatMessages.appendChild(messageEl);
                        // Animate only if it's the very first message or a new one
                        if ((isInitial && index === 0) || !isInitial) {
                            requestAnimationFrame(() => { messageEl.classList.add('message-arriving'); });
                        } else { // For batch rendering after initial, make them appear instantly
                            messageEl.style.opacity = 1;
                        }
                    });
                    if (AppState.isCsTyping) {
                        this.showCsTypingIndicator();
                    }
                    DOM.csChatMessages.scrollTop = DOM.csChatMessages.scrollHeight;
                },
                showCsTypingIndicator() {
                    const typingEl = document.createElement('div');
                    typingEl.className = `cs-chat-widget__message cs-typing message-arriving`;
                    typingEl.innerHTML = `<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>`;
                    DOM.csChatMessages.appendChild(typingEl);
                    DOM.csChatMessages.scrollTop = DOM.csChatMessages.scrollHeight;
                },
                removeCsTypingIndicator() {
                    const typingEl = DOM.csChatMessages.querySelector('.cs-typing');
                    if (typingEl) typingEl.remove();
                },
                sendCsChatMessage() {
                    if (!DOM.csChatMessageInput) return;
                    const text = DOM.csChatMessageInput.value.trim();
                    if (!text) return;
                    const userMessage = { sender: 'user', text: text, timestamp: new Date().toISOString() };
                    AppState.csChatMessages.push(userMessage);
                    // Add just the new user message with animation
                    const messageEl = document.createElement('div');
                    messageEl.className = `cs-chat-widget__message user`;
                    messageEl.innerHTML = `
                        <div>${Utils.sanitizeHTML(userMessage.text)}</div>
                        <div class="cs-chat-widget__message-time">${Utils.formatTime(userMessage.timestamp)}</div>`;
                    DOM.csChatMessages.appendChild(messageEl);
                    requestAnimationFrame(() => { messageEl.classList.add('message-arriving'); });

                    DOM.csChatMessageInput.value = '';
                    AppState.isCsTyping = false; // User sent message, CS is not typing from previous
                    this.removeCsTypingIndicator();
                    this.simulateCsReply(text);
                    DOM.csChatMessages.scrollTop = DOM.csChatMessages.scrollHeight;
                },
                simulateCsReply(userQuery) {
                    AppState.isCsTyping = true;
                    this.showCsTypingIndicator();

                    setTimeout(() => {
                        AppState.isCsTyping = false;
                        this.removeCsTypingIndicator();

                        let replyText = "Terima kasih atas pertanyaan Anda. Kami akan segera membantu.";
                        if (userQuery.toLowerCase().includes('booking')) replyText = "Untuk booking, pilih properti dari halaman 'Properti', lihat detail, lalu klik 'Booking Sekarang'. Atau ke halaman 'Booking' & klik 'Tambah Booking Baru'.";
                        else if (userQuery.toLowerCase().includes('harga') || userQuery.toLowerCase().includes('biaya')) replyText = "Info harga ada di detail properti. Untuk pertanyaan spesifik, sebutkan nama propertinya.";
                        else if (userQuery.toLowerCase().includes('halo') || userQuery.toLowerCase().includes('hai')) replyText = "Halo! Ada yang bisa kami bantu hari ini?";
                        else if (userQuery.toLowerCase().includes('bantuan') || userQuery.toLowerCase().includes('tolong')) replyText = "Tentu, sampaikan pertanyaan Anda, kami siap membantu.";

                        const csMessage = { sender: 'cs', text: replyText, timestamp: new Date().toISOString() };
                        AppState.csChatMessages.push(csMessage);

                        // Add just the new CS message with animation
                        const messageEl = document.createElement('div');
                        messageEl.className = `cs-chat-widget__message cs`;
                        messageEl.innerHTML = `
                            <div>${Utils.sanitizeHTML(csMessage.text)}</div>
                            <div class="cs-chat-widget__message-time">${Utils.formatTime(csMessage.timestamp)}</div>`;
                        DOM.csChatMessages.appendChild(messageEl);
                        requestAnimationFrame(() => { messageEl.classList.add('message-arriving'); });
                        DOM.csChatMessages.scrollTop = DOM.csChatMessages.scrollHeight;

                    }, 1000 + Math.random() * 1500);
                },

                renderSettingsPage() {
                    if (!DOM.settingsContent) return;
                    DOM.settingEmailNotifications.checked = AppState.userSettings.emailNotifications;
                    DOM.settingPushNotifications.checked = AppState.userSettings.pushNotifications;
                    DOM.settingTwoFactorAuth.checked = AppState.userSettings.twoFactorAuth;
                    DOM.settingLanguage.value = AppState.userSettings.language;
                    this.applyTheme(AppState.currentTheme, true);
                },
                handleSettingChange(settingKey, value) {
                    AppState.userSettings[settingKey] = value;
                    localStorage.setItem('userSettingsGV', JSON.stringify(AppState.userSettings));
                    let ONOFF = typeof value === 'boolean' ? (value ? 'diaktifkan' : 'dinonaktifkan') : `diubah ke ${value}`;
                    this.showNotification(`Pengaturan "${Utils.capitalize(settingKey.replace(/([A-Z])/g, ' $1'))}" ${ONOFF}.`, 'Pengaturan Disimpan', 'success');

                    if (settingKey === 'language') {
                        this.showNotification(`Bahasa diubah ke ${value === 'id' ? 'Indonesia' : 'English'}. Perubahan akan terlihat setelah refresh (simulasi).`, 'Bahasa', 'info');
                    }
                },
                openChangePasswordModal() {
                    if (!DOM.changePasswordModalOverlay || !DOM.changePasswordForm) return;
                    DOM.changePasswordForm.reset();
                    DOM.changePasswordForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                    DOM.changePasswordModalOverlay.classList.add('show');
                    DOM.changePasswordModalOverlay.setAttribute('aria-hidden', 'false');
                    DOM.body.style.overflow = 'hidden';
                    DOM.changePasswordForm.currentPassword.focus();
                },
                closeChangePasswordModal() {
                    if (!DOM.changePasswordModalOverlay) return;
                    DOM.changePasswordModalOverlay.classList.remove('show');
                    DOM.changePasswordModalOverlay.setAttribute('aria-hidden', 'true');
                    DOM.body.style.overflow = '';
                },
                validateChangePasswordForm() {
                    let isValid = true;
                    const form = DOM.changePasswordForm;
                    const currentPassword = form.currentPassword;
                    const newPassword = form.newPassword;
                    const confirmNewPassword = form.confirmNewPassword;

                    [currentPassword, newPassword, confirmNewPassword].forEach(input => {
                        input.classList.remove('is-invalid');
                        const feedback = input.nextElementSibling;
                        if (feedback) feedback.textContent = '';
                    });

                    if (currentPassword.value.trim() === '') {
                        currentPassword.classList.add('is-invalid');
                        currentPassword.nextElementSibling.textContent = 'Password saat ini wajib diisi.';
                        isValid = false;
                    }
                    if (newPassword.value.length < 8) {
                        newPassword.classList.add('is-invalid');
                        newPassword.nextElementSibling.textContent = 'Password baru minimal 8 karakter.';
                        isValid = false;
                    }
                    if (newPassword.value !== confirmNewPassword.value) {
                        confirmNewPassword.classList.add('is-invalid');
                        confirmNewPassword.nextElementSibling.textContent = 'Konfirmasi password tidak cocok.';
                        isValid = false;
                    }
                    return isValid;
                },
                handleChangePasswordFormSubmit(e) {
                    e.preventDefault();
                    if (!this.validateChangePasswordForm()) return;
                    this.showNotification('Mengganti password...', 'Proses', 'info', 1500);
                    setTimeout(() => {
                        this.closeChangePasswordModal();
                        this.showNotification('Password berhasil diubah! (simulasi)', 'Sukses', 'success');
                    }, 1500);
                },

                updateCurrentYear() {
                    if (DOM.currentYearSpan) DOM.currentYearSpan.textContent = new Date().getFullYear();
                },
            };

            document.addEventListener('DOMContentLoaded', () => App.init());
        })();
    </script>
</body>

</html>