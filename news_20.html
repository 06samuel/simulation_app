<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green Valley Rentals</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            light: '#6EE7B7', // emerald-300
                            DEFAULT: '#10B981', // emerald-500
                            dark: '#047857', // emerald-700
                        },
                        secondary: {
                            light: '#7DD3FC', // sky-300
                            DEFAULT: '#0EA5E9', // sky-500
                            dark: '#0369A1', // sky-700
                        },
                        accent: {
                            DEFAULT: '#F59E0B', // amber-500
                        },
                        neutral: {
                            lightest: '#F9FAFB', // gray-50
                            lighter: '#F3F4F6', // gray-100
                            light: '#E5E7EB', // gray-200
                            DEFAULT: '#6B7280', // gray-500
                            dark: '#374151', // gray-700
                            darker: '#1F2937', // gray-800
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        #main-content-area {
            flex-grow: 1;
        }

        .nav-active {
            color: #10B981;
            /* emerald-500 */
            font-weight: 600;
            border-bottom: 2px solid #10B981;
        }

        /* Basic modal styling for visibility */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 100;
        }

        .modal-content-container {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            transform: scale(1);
            transition: all 0.3s ease-out;
            width: 100%;
            margin: auto;
        }

        .hidden {
            display: none !important;
        }

        /* For range input styling consistency */
        input[type="range"].accent-primary::-webkit-slider-thumb {
            background-color: #10B981;
        }

        input[type="range"].accent-primary::-moz-range-thumb {
            background-color: #10B981;
        }
    </style>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.1.0",
    "react-dom/": "https://esm.sh/react-dom@^19.1.0/",
    "react-router-dom": "https://esm.sh/react-router-dom@^7.6.1",
    "react/": "https://esm.sh/react@^19.1.0/"
  }
}
</script>
</head>

<body class="bg-neutral-lighter text-neutral-dark font-sans antialiased">
    <div id="app-container" class="flex flex-col min-h-screen">
        <header id="navbar-container" class="bg-white shadow-md sticky top-0 z-50"></header>
        <main id="main-content-area" class="container mx-auto px-4 py-8">
            <!-- Content will be injected here -->
        </main>
        <footer id="footer-container" class="bg-neutral-darker text-neutral-light py-12"></footer>
        <div id="modal-root"></div>
    </div>

    <script>
        // --- START OF EMBEDDED JAVASCRIPT ---

        // --- Apartment Type and Amenity Enums (as objects) ---
        const ApartmentType = {
            STUDIO: "Studio",
            ONE_BEDROOM: "1 Bedroom",
            TWO_BEDROOMS: "2 Bedrooms",
            THREE_BEDROOMS: "3 Bedrooms",
            PENTHOUSE: "Penthouse",
            LOFT: "Loft",
            DUPLEX: "Duplex",
            FAMILY: "Family Apartment",
        };

        const Amenity = {
            POOL: "Swimming Pool",
            GYM: "Gymnasium",
            PARKING: "Covered Parking",
            WIFI: "High-Speed WiFi",
            AC: "Air Conditioning",
            LAUNDRY: "In-Unit Laundry",
            KITCHEN: "Fully Equipped Kitchen",
            PET_FRIENDLY: "Pet Friendly",
            BALCONY: "Balcony/Patio",
            SECURITY: "24/7 Security",
            ELEVATOR: "Elevator Access",
            DISHWASHER: "Dishwasher",
        };

        // --- CONSTANTS ---
        const NAV_LINKS = [
            { href: "#/", label: "Home" },
            { href: "#/search", label: "Find Apartments" },
            { href: "#/profile", label: "My Profile" },
        ];

        const ALL_AMENITIES = Object.values(Amenity);
        const ALL_APARTMENT_TYPES = Object.values(ApartmentType);

        const MAX_PRICE = 5000;
        const MIN_PRICE = 50;
        const MAX_GUESTS = 10;

        // --- SVG Icons (as functions returning SVG strings) ---
        const HomeIconSVG = (className = "w-6 h-6") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${className}"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5"/></svg>`;
        const SearchIconSVG = (className = "w-6 h-6") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${className}"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/></svg>`;
        const UserCircleIconSVG = (className = "w-6 h-6") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${className}"><path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z"/></svg>`;
        const StarIconSVG = (className = "w-5 h-5", isFilled = true) => `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${isFilled ? 'currentColor' : 'none'}" class="${className} ${isFilled ? 'text-amber-400' : 'text-neutral-light'}" ${!isFilled ? 'stroke="currentColor" stroke-width="1"' : ''}><path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354l-4.597 2.927c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z" clip-rule="evenodd"/></svg>`;
        const MapPinIconSVG = (className = "w-6 h-6") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${className}"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z"/></svg>`;
        const CalendarDaysIconSVG = (className = "w-6 h-6") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${className}"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5m-9-3.75h.008v.008H12v-.008z"/></svg>`;
        const UsersIconSVG = (className = "w-6 h-6") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${className}"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z"/></svg>`;
        const AdjustmentsHorizontalIconSVG = (className = "w-6 h-6") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${className}"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75"/></svg>`;
        const XMarkIconSVG = (className = "w-6 h-6") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${className}"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`;
        const CheckCircleIconSVG = (className = "w-6 h-6") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${className}"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
        const InformationCircleIconSVG = (className = "w-6 h-6") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${className}"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" /></svg>`;
        const ShieldCheckIconSVG = (className = "w-6 h-6") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${className}"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622A11.99 11.99 0 0018.402 6a11.959 11.959 0 01-1.035-.487m-6.261 10.433L6.208 12.127a.5.5 0 01.707-.707l3.536 3.535 6.707-6.707a.5.5 0 01.707.707l-7.06 7.06z" /></svg>`;
        const CurrencyDollarIconSVG = (className = "w-6 h-6") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${className}"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
        const ChevronLeftIconSVG = (className = "w-6 h-6") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${className}"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>`;
        const ChevronRightIconSVG = (className = "w-6 h-6") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${className}"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>`;
        const BuildingIconSVG = (className = "w-8 h-8 text-primary") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${className}"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 21v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21m0 0h4.5V3.545M12.75 21h7.5V10.75M2.25 21h1.5m18 0h-1.5m-15-13.5H18M3.75 7.5h16.5M3.75 7.5V3.545M3.75 7.5v3.198M7.5 3v.008v.007H12v-.007V3M16.5 3v.008v.007H12v-.007V3m-4.5 0v3.75m-3.75-3.75h3.75m3.75 0h3.75M3.75 0v3.75M20.25 0v3.75" /></svg>`;
        const BedroomsIconSVG = (className = "w-3 h-3 mr-1") => UsersIconSVG(className);
        const BathroomsIconSVG = (className = "w-3 h-3 mr-1") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${className}"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M6.75 21v-3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21M3 3h18M3 7.5h18M3 12h18m-4.5-4.5h.008v.008h-.008V7.5zm0 3h.008v.008h-.008v-.008zm0 3h.008v.008h-.008v-.008z" /></svg>`;
        const AreaSqFtIconSVG = (className = "w-3 h-3 mr-1") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${className}"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" /></svg>`;
        const HowItWorksSearchIconSVG = (className = "w-12 h-12 text-primary mb-4") => SearchIconSVG(className);
        const HowItWorksCalendarIconSVG = (className = "w-12 h-12 text-primary mb-4") => CalendarDaysIconSVG(className);
        const HowItWorksKeyIconSVG = (className = "w-12 h-12 text-primary mb-4") => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${className}"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 00-3.213-9.193 2.056 2.056 0 00-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 00-10.026 0 1.106 1.106 0 00-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12" /></svg>`;


        const getUnsplashImage = (query = 'apartment,modern', width = 800, height = 600) => {
            return `https://source.unsplash.com/random/${width}x${height}?${query}&sig=${Math.random()}`;
        }
        const USER_AVATAR_PLACEHOLDER = (seed) => `https://source.unsplash.com/random/100x100?portrait,person&sig=${seed}`;

        // --- MOCK DATA (Adapted from apartmentService.ts) ---
        const generateRandomDate = (start, end) => new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime())).toISOString().split('T')[0];

        const mockHosts = [
            { id: 'host1', name: 'Alice Wonderland', avatarUrl: getUnsplashImage('woman,portrait', 100, 100), isVerified: true, joinDate: '2020-01-15' },
            { id: 'host2', name: 'Bob The Builder', avatarUrl: getUnsplashImage('man,portrait', 100, 100), isVerified: false, joinDate: '2021-06-10' },
            { id: 'host3', name: 'Carol Danvers', avatarUrl: getUnsplashImage('woman,professional', 100, 100), isVerified: true, joinDate: '2019-03-20' },
        ];

        const mockReviews = (apartmentId) => {
            const reviewCount = Math.floor(Math.random() * 10) + 1;
            return Array.from({ length: reviewCount }, (_, i) => ({
                id: `rev_${apartmentId}_${i}`,
                userId: `user${Math.floor(Math.random() * 100)}`,
                userName: ['John D.', 'Jane S.', 'Mike R.', 'Lisa P.'][Math.floor(Math.random() * 4)],
                userAvatarUrl: USER_AVATAR_PLACEHOLDER(`user${i}`),
                rating: Math.floor(Math.random() * 3) + 3,
                comment: ["Great place, very clean!", "Loved the location.", "Host was responsive.", "A bit noisy, but good.", "Fantastic amenities.", "Would recommend.", "Exactly as described.", "Smooth check-in.", "Beautiful views.", "Excellent value."][Math.floor(Math.random() * 10)],
                date: generateRandomDate(new Date(2022, 0, 1), new Date()),
            }));
        };

        const generateAvailability = () => {
            const availability = {};
            const today = new Date();
            for (let i = 0; i < 90; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dateString = date.toISOString().split('T')[0];
                availability[dateString] = Math.random() > 0.3 ? 'available' : 'booked';
            }
            return availability;
        };

        const mockApartmentsData = Array.from({ length: 25 }, (_, i) => {
            const reviews = mockReviews(`apt${i + 1}`);
            const totalRating = reviews.reduce((sum, r) => sum + r.rating, 0);
            const avgRating = reviews.length > 0 ? parseFloat((totalRating / reviews.length).toFixed(1)) : 0;
            const apartmentTypeValues = Object.values(ApartmentType);
            const amenityValues = Object.values(Amenity);

            return {
                id: `apt${i + 1}`,
                name: ['Luxurious Downtown Loft', 'Cozy Suburban Studio', 'Spacious Family Penthouse', 'Modern Riverside Condo', 'Chic Urban Apartment', 'Serene Garden View Flat', 'Historic City Center Suite', 'Bright & Airy Beachfront Getaway', 'Stylish Tech Hub Pad', 'Tranquil Lakeside Retreat'][i % 10],
                location: ['Downtown', 'Suburbia', 'Riverside', 'City Center', 'Uptown', 'Midtown', 'Beachside', 'Lakeside', 'Tech District', 'Historic Quarter'][i % 10],
                address: `${100 + i * 5} Main St, ${['Springfield', 'Shelbyville', 'Metropolis', 'Gotham', 'Star City'][i % 5]}, ST 12345`,
                coordinates: { lat: 34.0522 - (i * 0.01), lng: -118.2437 + (i * 0.01) },
                pricePerNight: Math.floor(Math.random() * 450) + 50,
                type: apartmentTypeValues[i % apartmentTypeValues.length],
                bedrooms: Math.floor(Math.random() * 3) + 1,
                bathrooms: Math.floor(Math.random() * 2) + 1,
                areaSqFt: Math.floor(Math.random() * 1000) + 500,
                images: Array.from({ length: Math.floor(Math.random() * 4) + 3 }, (_, k) => getUnsplashImage(`apartment,interior,${['modern', 'cozy', 'luxury', 'bright'][k % 4]}`, 800, 600) + `&id=${i + 1}_${k}`),
                amenities: amenityValues.sort(() => 0.5 - Math.random()).slice(0, Math.floor(Math.random() * (amenityValues.length / 2)) + 3),
                description: `A wonderful ${apartmentTypeValues[i % apartmentTypeValues.length]} in ${['Downtown', 'Suburbia', 'Riverside'][i % 3]}. Perfect for your next getaway.`,
                detailedDescription: `Discover the charm of this exquisite ${apartmentTypeValues[i % apartmentTypeValues.length]}. Nestled in the heart of ${['Downtown', 'Suburbia', 'Riverside'][i % 3]}, this property offers an unparalleled living experience.`,
                host: mockHosts[i % mockHosts.length],
                reviews: reviews,
                rating: avgRating,
                availabilityCalendar: generateAvailability(),
                virtualTourUrl: Math.random() > 0.7 ? 'https://www.youtube.com/embed/dQw4w9WgXcQ' : undefined,
                isFeatured: Math.random() > 0.7,
                houseRules: ["No smoking", "No parties or events", "Pets allowed upon approval"],
                cancellationPolicy: "Full refund for cancellations made within 48 hours of booking...",
                nearbyLandmarks: ["Central Park (5 min walk)", "City Museum (10 min drive)"].sort(() => 0.5 - Math.random()).slice(0, 2)
            };
        });

        let mockUserBookings = [
            {
                id: 'booking1',
                apartmentId: 'apt1',
                apartmentName: mockApartmentsData[0].name,
                apartmentImage: mockApartmentsData[0].images[0],
                userId: 'user123',
                checkInDate: '2024-08-15',
                checkOutDate: '2024-08-20',
                guests: 2,
                totalPrice: mockApartmentsData[0].pricePerNight * 5,
                status: 'confirmed',
                bookedAt: '2024-07-01T10:00:00Z'
            }
        ];

        const MOCK_USER_PROFILE = {
            id: 'user123',
            name: 'John Doe',
            email: 'john.doe@example.com',
            avatarUrl: getUnsplashImage('man, smiling', 100, 100),
            joinDate: '2022-01-15T00:00:00Z',
            bookings: [],
            preferences: { notifications: true, darkMode: false },
            loyaltyPoints: 1250,
            isVerified: true,
        };

        // --- GLOBAL STATE ---
        const appState = {
            apartments: [],
            featuredApartments: [],
            currentApartmentDetail: null,
            userProfile: MOCK_USER_PROFILE, // Initialize with mock for simplicity
            isLoading: false,
            error: null,
            filters: {
                location: '',
                checkInDate: '',
                checkOutDate: '',
                guests: 1,
                minPrice: MIN_PRICE,
                maxPrice: MAX_PRICE,
                amenities: [],
                apartmentType: [],
                bedrooms: 0,
            },
            currentRoute: { page: 'home', params: {} },
            isModalOpen: false,
            modalContent: { title: '', body: '' },
            currentImageCarouselIndex: 0,
        };

        // --- DOM Element References ---
        const navbarContainer = document.getElementById('navbar-container');
        const mainContentArea = document.getElementById('main-content-area');
        const footerContainer = document.getElementById('footer-container');
        const modalRoot = document.getElementById('modal-root');


        // --- UTILITY FUNCTIONS ---
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // --- SERVICE FUNCTIONS (Simulated API calls) ---
        async function _fetchApartments(filters = appState.filters) {
            appState.isLoading = true;
            _renderLoadingSpinner(mainContentArea, 'Filtering apartments...');
            return new Promise((resolve) => {
                setTimeout(() => {
                    let filteredData = [...mockApartmentsData];
                    if (filters.location) {
                        filteredData = filteredData.filter(apt =>
                            apt.location.toLowerCase().includes(filters.location.toLowerCase()) ||
                            apt.name.toLowerCase().includes(filters.location.toLowerCase())
                        );
                    }
                    if (filters.minPrice) filteredData = filteredData.filter(apt => apt.pricePerNight >= Number(filters.minPrice));
                    if (filters.maxPrice) filteredData = filteredData.filter(apt => apt.pricePerNight <= Number(filters.maxPrice));
                    if (filters.bedrooms && Number(filters.bedrooms) > 0) filteredData = filteredData.filter(apt => apt.bedrooms >= Number(filters.bedrooms));
                    if (filters.apartmentType && filters.apartmentType.length > 0) {
                        filteredData = filteredData.filter(apt => filters.apartmentType.includes(apt.type));
                    }
                    if (filters.amenities && filters.amenities.length > 0) {
                        filteredData = filteredData.filter(apt => filters.amenities.every(fa => apt.amenities.includes(fa)));
                    }
                    appState.apartments = filteredData;
                    appState.isLoading = false;
                    resolve(filteredData);
                }, 500);
            });
        }

        async function _fetchApartmentById(id) {
            appState.isLoading = true;
            _renderLoadingSpinner(mainContentArea, 'Loading apartment details...');
            return new Promise((resolve) => {
                setTimeout(() => {
                    const apartment = mockApartmentsData.find(apt => apt.id === id);
                    appState.currentApartmentDetail = apartment;
                    appState.isLoading = false;
                    resolve(apartment);
                }, 300);
            });
        }

        async function _fetchFeaturedApartments() {
            appState.isLoading = true;
            return new Promise((resolve) => {
                setTimeout(() => {
                    appState.featuredApartments = mockApartmentsData.filter(apt => apt.isFeatured).slice(0, 4);
                    appState.isLoading = false;
                    resolve(appState.featuredApartments);
                }, 200);
            });
        }


        async function _fetchUserBookings(userId) {
            // Simulate fetching user bookings
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve(mockUserBookings.filter(b => b.userId === userId));
                }, 300);
            });
        }

        async function _submitBooking(bookingDetails) {
            appState.isLoading = true;
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    const apartment = mockApartmentsData.find(apt => apt.id === bookingDetails.apartmentId);
                    if (!apartment) {
                        reject(new Error("Apartment not found"));
                        return;
                    }
                    const newBooking = {
                        ...bookingDetails,
                        id: `booking_${Date.now()}`,
                        status: 'confirmed',
                        bookedAt: new Date().toISOString(),
                        apartmentName: apartment.name,
                        apartmentImage: apartment.images[0]
                    };
                    mockUserBookings.push(newBooking);
                    // Update availability (simplified)
                    const bookedDates = [];
                    let currentDate = new Date(bookingDetails.checkInDate);
                    const endDate = new Date(bookingDetails.checkOutDate);
                    while (currentDate < endDate) {
                        apartment.availabilityCalendar[currentDate.toISOString().split('T')[0]] = 'booked';
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    appState.isLoading = false;
                    resolve(newBooking);
                }, 1000);
            });
        }

        async function _fetchUserProfile(userId) {
            appState.isLoading = true;
            return new Promise(async (resolve) => {
                const bookings = await _fetchUserBookings(userId);
                appState.userProfile = { ...MOCK_USER_PROFILE, bookings, id: userId };
                appState.isLoading = false;
                resolve(appState.userProfile);
            });
        }


        // --- "COMPONENT" FUNCTIONS (Return HTML Strings) ---

        function _ButtonComponent({ text, variant = 'primary', size = 'md', leftIcon, rightIcon, isLoading = false, fullWidth = false, className = '', type = 'button', id = '', dataset = {} }) {
            const baseStyles = "font-semibold rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition-all duration-150 ease-in-out inline-flex items-center justify-center";
            const variantStyles = {
                primary: 'bg-primary hover:bg-primary-dark text-white focus:ring-primary-dark',
                secondary: 'bg-secondary hover:bg-secondary-dark text-white focus:ring-secondary-dark',
                danger: 'bg-red-600 hover:bg-red-700 text-white focus:ring-red-700',
                outline: 'border border-primary text-primary hover:bg-primary-light/20 focus:ring-primary',
                ghost: 'text-primary hover:bg-primary-light/20 focus:ring-primary',
            };
            const sizeStyles = { sm: 'px-3 py-1.5 text-sm', md: 'px-4 py-2 text-base', lg: 'px-6 py-3 text-lg' };
            const loadingSpinner = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

            let datasetAttributes = '';
            for (const key in dataset) {
                datasetAttributes += ` data-${escapeHtml(key)}="${escapeHtml(dataset[key])}"`;
            }

            return `
    <button 
      type="${type}" 
      id="${id}"
      class="${baseStyles} ${variantStyles[variant]} ${sizeStyles[size]} ${isLoading ? 'opacity-75 cursor-not-allowed' : ''} ${fullWidth ? 'w-full' : ''} ${className}"
      ${isLoading ? 'disabled' : ''}
      ${datasetAttributes}
    >
      ${isLoading ? loadingSpinner : ''}
      ${leftIcon && !isLoading ? `<span class="mr-2">${leftIcon}</span>` : ''}
      ${escapeHtml(text)}
      ${rightIcon && !isLoading ? `<span class="ml-2">${rightIcon}</span>` : ''}
    </button>
  `;
        }

        function _FormFieldComponent({ label, id, error, as = 'input', type = 'text', value = '', placeholder = '', children, icon, className = '', required = false, min, max, rows = 4, checked, dataset = {} }) {
            const commonInputClasses = `block w-full px-4 py-2.5 border rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm ${error ? 'border-red-500 focus:ring-red-500 focus:border-red-500' : 'border-neutral-light focus:border-primary'} ${icon ? 'pl-10' : ''}`;

            let inputElementHTML;
            const inputProps = `id="${id}" class="${commonInputClasses} ${className}" value="${escapeHtml(value)}" placeholder="${escapeHtml(placeholder)}" ${required ? 'required' : ''} ${min !== undefined ? `min="${min}"` : ''} ${max !== undefined ? `max="${max}"` : ''}`;

            let datasetAttributes = '';
            for (const key in dataset) {
                datasetAttributes += ` data-${escapeHtml(key)}="${escapeHtml(dataset[key])}"`;
            }

            if (as === 'textarea') {
                inputElementHTML = `<textarea ${inputProps} rows="${rows}" ${datasetAttributes}>${escapeHtml(value)}</textarea>`;
            } else if (as === 'select') {
                inputElementHTML = `<select ${inputProps} ${datasetAttributes}>${children || ''}</select>`;
            } else if (type === 'checkbox') {
                inputElementHTML = `<input type="checkbox" id="${id}" class="form-checkbox h-4 w-4 text-primary focus:ring-primary-light border-neutral-DEFAULT rounded ${className}" ${checked ? 'checked' : ''} value="${escapeHtml(value)}" ${datasetAttributes}/>`;
            } else {
                inputElementHTML = `<input type="${type}" ${inputProps} ${datasetAttributes}/>`;
            }

            return `
    <div class="mb-4">
      <label for="${id}" class="block text-sm font-medium text-neutral-dark mb-1">
        ${escapeHtml(label)} ${required ? '<span class="text-red-500">*</span>' : ''}
      </label>
      <div class="relative">
        ${icon ? `<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-neutral-DEFAULT">${icon}</div>` : ''}
        ${inputElementHTML}
      </div>
      ${error ? `<p class="mt-1 text-xs text-red-600">${escapeHtml(error)}</p>` : ''}
    </div>
  `;
        }

        function _StarRatingComponent({ rating, maxRating = 5, size = 'md', className = '', showLabel = false, interactive = false, onRateDataset = {} }) {
            const starSizeClasses = { sm: 'w-4 h-4', md: 'w-5 h-5', lg: 'w-6 h-6' };
            let starsHTML = '';
            for (let i = 0; i < maxRating; i++) {
                const starValue = i + 1;
                const isFilled = rating >= starValue;
                let datasetAttrs = '';
                if (interactive) {
                    for (const key in onRateDataset) {
                        datasetAttrs += ` data-${escapeHtml(key)}="${escapeHtml(onRateDataset[key])}"`;
                    }
                    datasetAttrs += ` data-rating-value="${starValue}"`;
                }
                starsHTML += `<span ${datasetAttrs} class="${interactive ? 'cursor-pointer star-interactive' : ''}">${StarIconSVG(`${starSizeClasses[size]}`, isFilled)}</span>`;
            }
            return `
    <div class="flex items-center space-x-1 ${className}">
      ${starsHTML}
      ${showLabel ? `<span class="ml-2 text-sm ${size === 'sm' ? 'text-xs' : ''} text-neutral-DEFAULT">${rating.toFixed(1)} / ${maxRating}</span>` : ''}
    </div>
  `;
        }

        function _AmenityIconComponent(amenity, className = "w-4 h-4") {
            const icons = {
                [Amenity.POOL]: 'üèä', [Amenity.GYM]: 'üèãÔ∏è', [Amenity.PARKING]: 'üÖøÔ∏è',
                [Amenity.WIFI]: 'üì∂', [Amenity.AC]: '‚ùÑÔ∏è', [Amenity.LAUNDRY]: 'üß∫',
                [Amenity.KITCHEN]: 'üç≥', [Amenity.PET_FRIENDLY]: 'üêæ', [Amenity.BALCONY]: 'üèûÔ∏è',
                [Amenity.SECURITY]: 'üõ°Ô∏è', [Amenity.ELEVATOR]: 'üõó', [Amenity.DISHWASHER]: 'üçΩÔ∏è',
            };
            return `<span class="${className}" title="${escapeHtml(amenity)}">${icons[amenity] || '‚úîÔ∏è'}</span>`;
        }


        function _ApartmentCardComponent(apartment) {
            return `
    <article class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300 group">
      <a href="#/apartment/${apartment.id}" class="block apartment-card-link" data-apartment-id="${apartment.id}">
        <figure class="relative">
          <img
            src="${apartment.images[0] || getUnsplashImage(`apartment,interior&sig=${apartment.id}`, 400, 300)}"
            alt="${escapeHtml(apartment.name)}"
            class="w-full h-56 object-cover group-hover:scale-105 transition-transform duration-300"
            loading="lazy"
          />
          ${apartment.isFeatured ? `<span class="absolute top-2 left-2 bg-accent text-white text-xs font-semibold px-2 py-1 rounded">Featured</span>` : ''}
          <figcaption class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 via-black/50 to-transparent p-4 text-white">
            <h3 class="text-xl font-semibold truncate">${escapeHtml(apartment.name)}</h3>
            <div class="flex items-center text-sm mt-1">
              ${MapPinIconSVG('w-4 h-4 mr-1 flex-shrink-0')}
              <span class="truncate">${escapeHtml(apartment.location)}</span>
            </div>
          </figcaption>
        </figure>
      </a>
      <div class="p-5">
        <div class="flex justify-between items-start mb-2">
          ${_StarRatingComponent({ rating: apartment.rating, size: 'sm', showLabel: true })}
          <div class="text-right">
            <p class="text-xl font-bold text-primary">
              $${apartment.pricePerNight}
              <span class="text-xs text-neutral-DEFAULT font-normal">/night</span>
            </p>
          </div>
        </div>
        <p class="text-sm text-neutral-dark mb-3 h-10 overflow-hidden">
          ${escapeHtml(apartment.description.substring(0, 100))}${apartment.description.length > 100 ? '...' : ''}
        </p>
        <div class="flex flex-wrap gap-2 mb-3">
          <span class="flex items-center text-xs bg-neutral-lighter text-neutral-dark px-2 py-1 rounded-full">
            ${BedroomsIconSVG()} ${apartment.bedrooms} bed${apartment.bedrooms > 1 ? 's' : ''}
          </span>
          <span class="flex items-center text-xs bg-neutral-lighter text-neutral-dark px-2 py-1 rounded-full">
            ${BathroomsIconSVG()} ${apartment.bathrooms} bath${apartment.bathrooms > 1 ? 's' : ''}
          </span>
          <span class="flex items-center text-xs bg-neutral-lighter text-neutral-dark px-2 py-1 rounded-full">
            ${AreaSqFtIconSVG()} ${apartment.areaSqFt} sq ft
          </span>
        </div>
        <details class="mb-4">
          <summary class="text-xs text-primary hover:text-primary-dark cursor-pointer font-medium">Top Amenities</summary>
          <div class="mt-2 flex flex-wrap gap-2">
            ${apartment.amenities.slice(0, 4).map(amenity => `
              <span class="flex items-center text-xs bg-emerald-50 text-emerald-700 px-2 py-1 rounded-full">
                ${_AmenityIconComponent(amenity, "w-3 h-3 mr-1")}
                ${escapeHtml(amenity)}
              </span>
            `).join('')}
          </div>
        </details>
        ${_ButtonComponent({
                text: 'View Details',
                variant: 'primary',
                fullWidth: true,
                className: 'apartment-card-view-details-btn',
                dataset: { apartmentId: apartment.id },
                type: 'button' // important: change to button, use event listener for navigation
            })}
      </div>
    </article>
  `;
        }

        function _ImageCarouselComponent({ images, altText, className = "h-96", carouselId = "default-carousel" }) {
            if (!images || images.length === 0) {
                return `<div class="bg-neutral-light flex items-center justify-center text-neutral-DEFAULT ${className}">No Image Available</div>`;
            }

            const slidesHTML = images.map((image, index) => `
    <img
      src="${escapeHtml(image)}"
      alt="${escapeHtml(altText)} - slide ${index + 1}"
      class="w-full h-full object-cover flex-shrink-0 ${index === appState.currentImageCarouselIndex ? '' : 'hidden'} carousel-image-${carouselId}"
      loading="lazy"
      data-index="${index}"
    />
  `).join('');

            const dotsHTML = images.length > 1 ? images.map((_, slideIndex) => `
    <button
      class="w-3 h-3 rounded-full transition-colors carousel-dot-${carouselId} ${appState.currentImageCarouselIndex === slideIndex ? 'bg-white' : 'bg-white/50 hover:bg-white/75'}"
      data-slide-to="${slideIndex}"
      aria-label="Go to slide ${slideIndex + 1}"
    ></button>
  `).join('') : '';

            return `
    <div id="${carouselId}" class="relative w-full overflow-hidden rounded-lg shadow-lg ${className}">
      <div class="flex h-full"> <!-- Removed transform, will manage visibility via JS -->
        ${slidesHTML}
      </div>
      ${images.length > 1 ? `
        <button
          class="absolute top-1/2 left-2 transform -translate-y-1/2 bg-black/40 text-white p-2 rounded-full hover:bg-black/60 transition-colors focus:outline-none z-10 carousel-prev-${carouselId}"
          aria-label="Previous image"
        >
          ${ChevronLeftIconSVG('w-6 h-6')}
        </button>
        <button
          class="absolute top-1/2 right-2 transform -translate-y-1/2 bg-black/40 text-white p-2 rounded-full hover:bg-black/60 transition-colors focus:outline-none z-10 carousel-next-${carouselId}"
          aria-label="Next image"
        >
          ${ChevronRightIconSVG('w-6 h-6')}
        </button>
        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-2 z-10">
          ${dotsHTML}
        </div>
      ` : ''}
    </div>
  `;
        }

        function _ReviewItemComponent(review) {
            return `
    <div class="py-6 border-b border-neutral-light last:border-b-0">
      <div class="flex items-start space-x-4">
        <img
          src="${review.userAvatarUrl || USER_AVATAR_PLACEHOLDER(review.userId)}"
          alt="${escapeHtml(review.userName)}"
          class="w-12 h-12 rounded-full object-cover"
          loading="lazy"
        />
        <div class="flex-1">
          <div class="flex items-center justify-between">
            <h4 class="font-semibold text-neutral-darker">${escapeHtml(review.userName)}</h4>
            <span class="text-xs text-neutral-DEFAULT">${formatDate(review.date)}</span>
          </div>
          ${_StarRatingComponent({ rating: review.rating, size: 'sm', className: 'my-1' })}
          <blockquote class="mt-2 text-neutral-dark text-sm italic relative">
            <p class="before:content-['‚Äú'] before:text-2xl before:text-neutral-light before:font-serif before:absolute before:-left-3 before:-top-1
                      after:content-['‚Äù'] after:text-2xl after:text-neutral-light after:font-serif after:absolute after:-right-1 after:-bottom-px">
              ${escapeHtml(review.comment)}
            </p>
          </blockquote>
        </div>
      </div>
    </div>
  `;
        }

        function _MapPlaceholderComponent({ address, className = 'h-64', centerText = "Interactive Map Placeholder" }) {
            return `
    <div class="bg-neutral-light border border-neutral-light rounded-lg flex flex-col items-center justify-center text-neutral-DEFAULT relative overflow-hidden ${className}">
      <img 
        src="${getUnsplashImage(`map,city,abstract&sig=${address || 'map'}`, 800, 600)}" 
        alt="Abstract map background" 
        class="absolute inset-0 w-full h-full object-cover opacity-30" 
      />
      <div class="relative z-10 flex flex-col items-center p-4 text-center">
        ${MapPinIconSVG('w-12 h-12 text-primary mb-2')}
        <p class="font-semibold text-neutral-darker">${escapeHtml(centerText)}</p>
        ${address ? `<p class="text-sm mt-1 text-neutral-dark">${escapeHtml(address)}</p>` : ''}
        <p class="text-xs mt-2 italic">(A real map would show property location and nearby landmarks)</p>
      </div>
    </div>
  `;
        }

        function _LoadingSpinnerComponent(message = '', className = '') {
            return `
    <div class="flex flex-col items-center justify-center ${className}">
      <div class="w-10 h-10 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
      ${message ? `<p class="mt-3 text-sm text-neutral-dark">${escapeHtml(message)}</p>` : ''}
    </div>
  `;
        }

        function _ModalComponent({ isOpen, title, childrenHTML, onCloseId = 'genericModalCloseBtn', size = 'md' }) {
            if (!isOpen) return '';
            const sizeClasses = { sm: 'max-w-sm', md: 'max-w-md', lg: 'max-w-lg', xl: 'max-w-xl', full: 'max-w-full h-full' };
            return `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-content-container ${sizeClasses[size]}">
                ${title ? `
                <div class="flex justify-between items-center p-4 border-b border-neutral-light">
                    <h3 class="text-lg font-semibold text-neutral-darker">${escapeHtml(title)}</h3>
                    <button id="${onCloseId}" class="text-neutral-DEFAULT hover:text-neutral-darker transition-colors modal-close-trigger" aria-label="Close modal">
                        ${XMarkIconSVG('w-6 h-6')}
                    </button>
                </div>
                ` : ''}
                <div class="p-6 ${title ? '' : 'pt-8'} max-h-[80vh] overflow-y-auto">
                    ${childrenHTML}
                </div>
            </div>
        </div>
    `;
        }


        // --- RENDER FUNCTIONS (for Navbar, Footer, Pages) ---
        function _renderNavbar() {
            const currentPath = window.location.hash || '#/';
            const linksHTML = NAV_LINKS.map(link => `
    <a
      href="${link.href}"
      class="text-neutral-dark hover:text-primary transition-colors duration-200 nav-link ${currentPath === link.href || (link.href === '#/' && currentPath.startsWith('#/home')) || (link.href !== '#/' && currentPath.startsWith(link.href)) ? 'nav-active' : ''}"
    >
      ${escapeHtml(link.label)}
    </a>
  `).join('');

            navbarContainer.innerHTML = `
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <a href="#/" class="flex items-center space-x-2 text-2xl font-bold text-primary-dark">
        ${BuildingIconSVG()}
        <span>GreenValley</span>
      </a>
      <nav class="hidden md:flex space-x-6 items-center">
        ${linksHTML}
      </nav>
      <div class="flex items-center space-x-4">
        <a href="#/profile" class="text-neutral-dark hover:text-primary transition-colors duration-200" aria-label="User Profile">
          ${UserCircleIconSVG('w-7 h-7')}
        </a>
        <a href="#/search" class="md:hidden text-neutral-dark hover:text-primary transition-colors duration-200" aria-label="Search">
          ${SearchIconSVG('w-7 h-7')}
        </a>
        <!-- Mobile menu button (placeholder) -->
        <button id="mobile-menu-btn" class="md:hidden text-neutral-dark hover:text-primary transition-colors duration-200">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
        </button>
      </div>
    </div>
    <!-- Mobile Nav (hidden by default) -->
    <div id="mobile-nav-menu" class="hidden md:hidden bg-white shadow-lg py-2">
        ${NAV_LINKS.map(link => `
            <a href="${link.href}" class="block px-4 py-2 text-neutral-dark hover:bg-primary-light hover:text-white transition-colors duration-200 mobile-nav-link ${currentPath === link.href ? 'nav-active' : ''}">${escapeHtml(link.label)}</a>
        `).join('')}
    </div>
  `;
            // Add event listener for mobile menu toggle
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileNavMenu = document.getElementById('mobile-nav-menu');
            if (mobileMenuBtn && mobileNavMenu) {
                mobileMenuBtn.addEventListener('click', () => {
                    mobileNavMenu.classList.toggle('hidden');
                });
            }
            // Close mobile menu on link click
            document.querySelectorAll('.mobile-nav-link').forEach(link => {
                link.addEventListener('click', () => mobileNavMenu.classList.add('hidden'));
            });

        }

        function _renderFooter() {
            const currentYear = new Date().getFullYear();
            footerContainer.innerHTML = `
    <div class="container mx-auto px-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
        <div>
          <h5 class="text-lg font-semibold text-white mb-3">GreenValley Rentals</h5>
          <p class="text-sm text-neutral-DEFAULT">Your trusted partner for finding the perfect apartment rental.</p>
        </div>
        <div>
          <h5 class="text-lg font-semibold text-white mb-3">Quick Links</h5>
          <ul class="space-y-2">
            <li><a href="#/search" class="hover:text-primary-light transition-colors">Find Apartments</a></li>
            <li><a href="#/profile" class="hover:text-primary-light transition-colors">My Profile</a></li>
            <li><a href="#/terms" class="hover:text-primary-light transition-colors">Terms of Service</a></li>
            <li><a href="#/privacy" class="hover:text-primary-light transition-colors">Privacy Policy</a></li>
          </ul>
        </div>
        <div>
          <h5 class="text-lg font-semibold text-white mb-3">Contact Us</h5>
          <ul class="space-y-2 text-sm">
            <li>Email: <a href="mailto:support@greenvalley.com" class="hover:text-primary-light transition-colors">support@greenvalley.com</a></li>
            <li>Phone: <a href="tel:+1234567890" class="hover:text-primary-light transition-colors">+1 (234) 567-890</a></li>
            <li>Support: <a href="#/help" class="hover:text-primary-light transition-colors">24/7 Help Center</a></li>
          </ul>
        </div>
      </div>
      <div class="border-t border-neutral-dark pt-8 text-center text-sm text-neutral-DEFAULT">
        <p>&copy; ${currentYear} GreenValley Rentals. All rights reserved.</p>
        <p class="mt-1">Designed with <span class="text-red-500">&hearts;</span> for easy renting.</p>
      </div>
    </div>
  `;
        }

        function _renderLoadingSpinner(container, message = 'Loading...') {
            if (container) {
                container.innerHTML = _LoadingSpinnerComponent(message, 'my-12');
            }
        }

        function _clearLoadingSpinner(container) {
            if (container) {
                const spinner = container.querySelector('.flex.flex-col.items-center.justify-center');
                if (spinner) spinner.remove();
            }
        }

        function _TestimonialCard({ quote, author, location, avatar }) {
            return `
    <div class="bg-white p-6 rounded-lg shadow-lg">
      <blockquote class="text-neutral-dark italic mb-4 relative">
        <p class="before:content-['‚Äú'] before:text-4xl before:text-primary/30 before:font-serif before:absolute before:-left-4 before:-top-2
                  after:content-['‚Äù'] after:text-4xl after:text-primary/30 after:font-serif after:absolute after:-right-0 after:bottom--2">
          ${escapeHtml(quote)}
        </p>
      </blockquote>
      <div class="flex items-center mt-6">
        <img src="${avatar}" alt="${escapeHtml(author)}" class="w-12 h-12 rounded-full mr-4 object-cover" loading="lazy"/>
        <div>
          <p class="font-semibold text-neutral-darker">${escapeHtml(author)}</p>
          <p class="text-sm text-neutral-DEFAULT">${escapeHtml(location)}</p>
        </div>
      </div>
    </div>
  `;
        }

        function _FeatureHighlightCard({ iconSVG, title, description }) {
            return `
    <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300 transform hover:-translate-y-1">
      <div class="flex justify-center">${iconSVG}</div>
      <h3 class="text-xl font-semibold text-neutral-darker mt-4 mb-2">${escapeHtml(title)}</h3>
      <p class="text-neutral-dark text-sm">${escapeHtml(description)}</p>
    </div>
  `;
        }

        // --- PAGE RENDERING FUNCTIONS ---
        async function _renderHomePage() {
            _renderLoadingSpinner(mainContentArea, 'Loading home page...');
            await _fetchFeaturedApartments();
            _clearLoadingSpinner(mainContentArea);

            const featuredApartmentsHTML = appState.featuredApartments.length > 0
                ? appState.featuredApartments.map(_ApartmentCardComponent).join('')
                : `<p class="text-neutral-DEFAULT col-span-full text-center">No featured apartments available at the moment.</p>`;

            mainContentArea.innerHTML = `
    <div class="space-y-12">
      <section 
        class="relative bg-cover bg-center py-24 md:py-32 rounded-xl shadow-xl overflow-hidden" 
        style="background-image: url('${getUnsplashImage('modern,living,room,bright', 1600, 800)}');"
        aria-labelledby="hero-heading"
      >
        <div class="absolute inset-0 bg-black/50"></div>
        <div class="relative container mx-auto px-4 text-center text-white z-10">
          <h1 id="hero-heading" class="text-4xl md:text-6xl font-bold mb-6 leading-tight">Find Your Perfect Stay</h1>
          <p class="text-lg md:text-xl mb-10 max-w-2xl mx-auto">
            Discover unique apartments and lofts in Green Valley. Your next adventure starts here.
          </p>
          <div id="home-search-bar-container" class="max-w-4xl mx-auto">
            <!-- SearchBar will be rendered here by _renderSearchBar -->
          </div>
        </div>
      </section>

      <section aria-labelledby="featured-properties-heading">
        <div class="flex justify-between items-center mb-6">
            <h2 id="featured-properties-heading" class="text-3xl font-semibold text-neutral-darker">Featured Properties</h2>
            <a href="#/search">
                ${_ButtonComponent({ text: 'View All', variant: 'outline' })}
            </a>
        </div>
        ${appState.isLoading ? _LoadingSpinnerComponent('Loading featured apartments...') : ''}
        ${appState.error ? `<p class="text-red-500">${escapeHtml(appState.error)}</p>` : ''}
        <div id="featured-apartments-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            ${!appState.isLoading && !appState.error ? featuredApartmentsHTML : ''}
        </div>
      </section>
      
      <section class="py-12 bg-neutral-lightest rounded-xl" aria-labelledby="how-it-works-heading">
        <h2 id="how-it-works-heading" class="text-3xl font-semibold text-neutral-darker text-center mb-10">Easy Renting in 3 Steps</h2>
        <div class="container mx-auto px-4 grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
          ${_FeatureHighlightCard({
                iconSVG: HowItWorksSearchIconSVG(),
                title: "Search & Discover",
                description: "Use our advanced filters to find apartments that match your criteria perfectly."
            })}
          ${_FeatureHighlightCard({
                iconSVG: HowItWorksCalendarIconSVG(),
                title: "Book Securely",
                description: "Transparent pricing and secure payment gateway with escrow protection."
            })}
           ${_FeatureHighlightCard({
                iconSVG: HowItWorksKeyIconSVG(),
                title: "Enjoy Your Stay",
                description: "Verified hosts and 24/7 support ensure a comfortable and worry-free experience."
            })}
        </div>
      </section>

      <section class="py-12" aria-labelledby="testimonials-heading">
        <h2 id="testimonials-heading" class="text-3xl font-semibold text-neutral-darker text-center mb-10">What Our Users Say</h2>
        <div class="container mx-auto px-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          ${_TestimonialCard({
                quote: "GreenValley made finding an apartment incredibly easy. The filters are amazing!",
                author: "Sarah L.", location: "New York", avatar: getUnsplashImage('woman,smiling', 80, 80)
            })}
          ${_TestimonialCard({
                quote: "Secure payment and great communication with the host. Highly recommended!",
                author: "Michael B.", location: "San Francisco", avatar: getUnsplashImage('man,happy', 80, 80)
            })}
          ${_TestimonialCard({
                quote: "The virtual tour feature was a game-changer! Knew exactly what I was getting.",
                author: "Jessica P.", location: "Chicago", avatar: getUnsplashImage('person,professional', 80, 80)
            })}
        </div>
      </section>
    </div>
  `;
            _renderSearchBar('home-search-bar-container', appState.filters, 'home', async (newFilters) => {
                appState.filters = { ...appState.filters, ...newFilters };
                _navigateTo('/search'); // Navigate to search page with new filters
            });
            _attachApartmentCardEventListeners();
        }

        function _renderSearchBar(containerId, currentFilters, variant = 'home', onSearchCallback) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const barStyle = variant === 'home'
                ? "bg-white/80 backdrop-blur-md p-4 md:p-6 rounded-xl shadow-2xl grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end"
                : "bg-white p-4 rounded-lg shadow-lg";
            const fieldWrapperStyle = variant === 'home' ? "" : "flex-grow";

            const apartmentTypesOptions = ALL_APARTMENT_TYPES.map(type => `
    <label class="flex items-center space-x-2 text-sm cursor-pointer p-1 hover:bg-neutral-light rounded">
        <input type="checkbox" name="apartmentType" value="${escapeHtml(type)}" ${currentFilters.apartmentType?.includes(type) ? 'checked' : ''} class="form-checkbox h-4 w-4 text-primary focus:ring-primary-light border-neutral-DEFAULT rounded"/>
        <span>${escapeHtml(type)}</span>
    </label>
  `).join('');

            const amenitiesOptions = ALL_AMENITIES.map(amenity => `
    <label class="flex items-center space-x-2 text-sm cursor-pointer p-1 hover:bg-neutral-light rounded">
        <input type="checkbox" name="amenities" value="${escapeHtml(amenity)}" ${currentFilters.amenities?.includes(amenity) ? 'checked' : ''} class="form-checkbox h-4 w-4 text-primary focus:ring-primary-light border-neutral-DEFAULT rounded"/>
        <span>${escapeHtml(amenity)}</span>
    </label>
  `).join('');

            container.innerHTML = `
    <form id="search-form-${variant}" class="${barStyle}">
      <div class="${fieldWrapperStyle}">
        ${_FormFieldComponent({ label: 'Location', id: `search-location-${variant}`, type: 'text', placeholder: 'e.g., Downtown', value: currentFilters.location || '', icon: MapPinIconSVG('w-5 h-5') })}
      </div>
      <div class="${fieldWrapperStyle}">
        ${_FormFieldComponent({ label: 'Check-in', id: `search-checkin-${variant}`, type: 'date', value: currentFilters.checkInDate || '', icon: CalendarDaysIconSVG('w-5 h-5') })}
      </div>
      <div class="${fieldWrapperStyle}">
        ${_FormFieldComponent({ label: 'Check-out', id: `search-checkout-${variant}`, type: 'date', value: currentFilters.checkOutDate || '', icon: CalendarDaysIconSVG('w-5 h-5') })}
      </div>
      <div class="${fieldWrapperStyle}">
        ${_FormFieldComponent({ label: 'Guests', id: `search-guests-${variant}`, type: 'number', min: '1', max: MAX_GUESTS, value: currentFilters.guests || 1, icon: UsersIconSVG('w-5 h-5') })}
      </div>
      <div class="${variant === 'home' ? "md:col-span-2 lg:col-span-1" : ""}">
        ${_ButtonComponent({ text: 'Search', type: 'submit', fullWidth: true, variant: 'primary', size: 'lg', leftIcon: SearchIconSVG('w-5 h-5') })}
      </div>

      ${variant === 'search-page' ? `
        <div class="col-span-full mt-4">
          <details id="advanced-filters-details-${variant}" open> <!-- Default open for search page -->
            <summary class="text-sm font-medium text-primary hover:text-primary-dark cursor-pointer flex items-center">
              ${AdjustmentsHorizontalIconSVG('w-5 h-5 mr-2')}
              Advanced Filters
            </summary>
            <div class="mt-4 p-4 border border-neutral-light rounded-md bg-neutral-lightest grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              <div>
                <label class="block text-sm font-medium text-neutral-dark mb-1">Price Range ($<span id="min-price-display-${variant}">${currentFilters.minPrice || MIN_PRICE}</span> - $<span id="max-price-display-${variant}">${currentFilters.maxPrice || MAX_PRICE}</span>)</label>
                <div class="flex items-center space-x-2">
                  <span class="text-sm text-neutral-DEFAULT">$${MIN_PRICE}</span>
                  <input type="range" id="min-price-range-${variant}" min="${MIN_PRICE}" max="${MAX_PRICE}" value="${currentFilters.minPrice || MIN_PRICE}" class="w-full h-2 bg-neutral-light rounded-lg appearance-none cursor-pointer accent-primary price-range-slider"/>
                </div>
                <div class="flex items-center space-x-2 mt-1">
                    <span class="text-sm text-neutral-DEFAULT">$${MIN_PRICE}</span>
                    <input type="range" id="max-price-range-${variant}" min="${MIN_PRICE}" max="${MAX_PRICE}" value="${currentFilters.maxPrice || MAX_PRICE}" class="w-full h-2 bg-neutral-light rounded-lg appearance-none cursor-pointer accent-primary price-range-slider"/>
                    <span class="text-sm text-neutral-DEFAULT">$${MAX_PRICE}</span>
                </div>
              </div>
              <div>
                ${_FormFieldComponent({ label: 'Min. Bedrooms', id: `search-bedrooms-${variant}`, type: 'number', min: '0', value: currentFilters.bedrooms || 0 })}
              </div>
              <div>
                <h4 class="text-sm font-medium text-neutral-dark mb-2">Apartment Type</h4>
                <div class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto">${apartmentTypesOptions}</div>
              </div>
              <div class="md:col-span-2 lg:col-span-3">
                <h4 class="text-sm font-medium text-neutral-dark mb-2">Amenities</h4>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 max-h-60 overflow-y-auto">${amenitiesOptions}</div>
              </div>
              <div class="md:col-span-2 lg:col-span-3 mt-4 flex justify-end">
                 ${_ButtonComponent({ text: 'Apply Filters', type: 'submit', variant: 'secondary', size: 'md' })}
              </div>
            </div>
          </details>
        </div>
      ` : ''}
    </form>
  `;

            const form = document.getElementById(`search-form-${variant}`);
            if (form) {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(form);
                    const newFilters = {
                        location: formData.get(`search-location-${variant}`) || undefined,
                        checkInDate: formData.get(`search-checkin-${variant}`) || undefined,
                        checkOutDate: formData.get(`search-checkout-${variant}`) || undefined,
                        guests: parseInt(formData.get(`search-guests-${variant}`)) || undefined,
                        minPrice: parseInt(document.getElementById(`min-price-range-${variant}`)?.value) || MIN_PRICE,
                        maxPrice: parseInt(document.getElementById(`max-price-range-${variant}`)?.value) || MAX_PRICE,
                        bedrooms: parseInt(formData.get(`search-bedrooms-${variant}`)) || undefined,
                        apartmentType: Array.from(form.querySelectorAll('input[name="apartmentType"]:checked')).map(el => el.value),
                        amenities: Array.from(form.querySelectorAll('input[name="amenities"]:checked')).map(el => el.value),
                    };
                    onSearchCallback(newFilters);
                });

                // Price range slider updates
                const minPriceRange = document.getElementById(`min-price-range-${variant}`);
                const maxPriceRange = document.getElementById(`max-price-range-${variant}`);
                const minPriceDisplay = document.getElementById(`min-price-display-${variant}`);
                const maxPriceDisplay = document.getElementById(`max-price-display-${variant}`);

                if (minPriceRange && maxPriceRange && minPriceDisplay && maxPriceDisplay) {
                    minPriceRange.addEventListener('input', (e) => {
                        const val = parseInt(e.target.value);
                        minPriceDisplay.textContent = val;
                        if (val > parseInt(maxPriceRange.value)) {
                            maxPriceRange.value = val;
                            maxPriceDisplay.textContent = val;
                        }
                    });
                    maxPriceRange.addEventListener('input', (e) => {
                        const val = parseInt(e.target.value);
                        maxPriceDisplay.textContent = val;
                        if (val < parseInt(minPriceRange.value)) {
                            minPriceRange.value = val;
                            minPriceDisplay.textContent = val;
                        }
                    });
                }
            }
        }

        async function _renderApartmentSearchPage() {
            _renderLoadingSpinner(mainContentArea, 'Loading search results...');
            await _fetchApartments(appState.filters); // Fetch based on current global filters
            _clearLoadingSpinner(mainContentArea);

            const apartmentsGridHTML = appState.apartments.length > 0
                ? appState.apartments.map(_ApartmentCardComponent).join('')
                : `
      <div class="text-center py-12 col-span-full">
        <img src="${getUnsplashImage('empty,magnifying-glass', 300, 200)}" alt="No results" class="mx-auto mb-4 rounded-lg opacity-70" />
        <h3 class="text-xl font-semibold text-neutral-darker">No Apartments Found</h3>
        <p class="text-neutral-DEFAULT">Try adjusting your search filters or broadening your location.</p>
      </div>
    `;

            mainContentArea.innerHTML = `
    <div class="flex flex-col lg:flex-row gap-8">
      <aside id="filters-sidebar" class="lg:w-1/3 xl:w-1/4 hidden lg:block lg:sticky top-[88px] lg:top-24 left-0 w-full h-full lg:h-auto bg-white lg:bg-transparent p-4 lg:p-0 z-40 lg:z-auto overflow-y-auto lg:overflow-visible shadow-xl lg:shadow-none">
        <div class="lg:hidden flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">Filters</h2>
            ${_ButtonComponent({ text: 'Close', variant: 'ghost', id: 'close-filters-btn' })}
        </div>
        <div id="search-page-bar-container">
            <!-- SearchBar will be rendered here -->
        </div>
      </aside>
      <div class="flex-grow lg:w-2/3 xl:w-3/4">
        <section class="mb-6">
          <div class="flex justify-between items-center mb-4">
            <div>
              <h1 class="text-3xl font-semibold text-neutral-darker">Apartment Listings</h1>
              <p class="text-neutral-DEFAULT">${appState.apartments.length} properties found ${appState.filters.location ? `near "${escapeHtml(appState.filters.location)}"` : ''}</p>
            </div>
             ${_ButtonComponent({ text: 'Filters', variant: 'outline', className: 'lg:hidden', id: 'show-filters-btn', leftIcon: AdjustmentsHorizontalIconSVG('w-5 h-5') })}
          </div>
          ${_MapPlaceholderComponent({
                className: "h-64 md:h-80 rounded-lg",
                address: appState.filters.location || "Showing all areas",
                centerText: appState.filters.location ? `Apartments near ${escapeHtml(appState.filters.location)}` : "Apartment Locations"
            })}
        </section>
        ${appState.isLoading ? _LoadingSpinnerComponent('Searching for apartments...', 'my-12') : ''}
        ${appState.error ? `<p class="text-red-500 bg-red-100 p-4 rounded-md">${escapeHtml(appState.error)}</p>` : ''}
        <div id="apartments-results-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            ${!appState.isLoading && !appState.error ? apartmentsGridHTML : ''}
        </div>
      </div>
    </div>
  `;
            _renderSearchBar('search-page-bar-container', appState.filters, 'search-page', async (newFilters) => {
                appState.filters = { ...appState.filters, ...newFilters };
                _renderLoadingSpinner(document.getElementById('apartments-results-grid'), 'Applying filters...');
                await _fetchApartments(appState.filters);
                _renderApartmentSearchPage(); // Re-render the whole search page to reflect new results
            });
            _attachApartmentCardEventListeners();

            // Event listeners for mobile filter toggle
            const showFiltersBtn = document.getElementById('show-filters-btn');
            const closeFiltersBtn = document.getElementById('close-filters-btn');
            const filtersSidebar = document.getElementById('filters-sidebar');
            if (showFiltersBtn && filtersSidebar) {
                showFiltersBtn.addEventListener('click', () => filtersSidebar.classList.remove('hidden'));
            }
            if (closeFiltersBtn && filtersSidebar) {
                closeFiltersBtn.addEventListener('click', () => filtersSidebar.classList.add('hidden'));
            }
        }

        function _updateImageCarousel(carouselId, newIndex) {
            const images = document.querySelectorAll(`.carousel-image-${carouselId}`);
            const dots = document.querySelectorAll(`.carousel-dot-${carouselId}`);
            appState.currentImageCarouselIndex = newIndex;

            images.forEach((img, idx) => {
                img.classList.toggle('hidden', idx !== newIndex);
            });
            dots.forEach((dot, idx) => {
                dot.classList.toggle('bg-white', idx === newIndex);
                dot.classList.toggle('bg-white/50', idx !== newIndex);
            });
        }

        function _attachImageCarouselListeners(carouselId, numImages) {
            if (numImages <= 1) return;

            const prevBtn = document.querySelector(`.carousel-prev-${carouselId}`);
            const nextBtn = document.querySelector(`.carousel-next-${carouselId}`);
            const dots = document.querySelectorAll(`.carousel-dot-${carouselId}`);

            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    const newIndex = (appState.currentImageCarouselIndex - 1 + numImages) % numImages;
                    _updateImageCarousel(carouselId, newIndex);
                });
            }
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    const newIndex = (appState.currentImageCarouselIndex + 1) % numImages;
                    _updateImageCarousel(carouselId, newIndex);
                });
            }
            dots.forEach(dot => {
                dot.addEventListener('click', (e) => {
                    const slideTo = parseInt(e.target.dataset.slideTo);
                    _updateImageCarousel(carouselId, slideTo);
                });
            });
        }

        async function _renderApartmentDetailPage(apartmentId) {
            _renderLoadingSpinner(mainContentArea, 'Loading apartment details...');
            const apartment = await _fetchApartmentById(apartmentId);
            _clearLoadingSpinner(mainContentArea);

            if (!apartment) {
                mainContentArea.innerHTML = `<p class="text-red-500 text-center py-10 bg-red-50 p-4 rounded-md">Apartment with ID ${escapeHtml(apartmentId)} not found.</p>`;
                return;
            }
            appState.currentImageCarouselIndex = 0; // Reset for new carousel
            const carouselId = `apartment-carousel-${apartment.id}`;

            const amenitiesHTML = apartment.amenities.map(amenity => `
    <span class="flex items-center bg-emerald-50 text-emerald-700 text-sm px-3 py-1.5 rounded-full">
      <span class="mr-2 text-lg">${_AmenityIconComponent(amenity)}</span>
      ${escapeHtml(amenity)}
    </span>
  `).join('');

            const reviewsHTML = apartment.reviews.length > 0
                ? apartment.reviews.slice(0, 4).map(_ReviewItemComponent).join('')
                : `<p class="text-neutral-DEFAULT">No reviews yet for this apartment.</p>`;

            const bookingFormId = `booking-form-${apartment.id}`;

            mainContentArea.innerHTML = `
    <div class="space-y-10">
      <section aria-labelledby="apartment-name">
        <h1 id="apartment-name" class="text-4xl font-bold text-neutral-darker mb-2">${escapeHtml(apartment.name)}</h1>
        <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-neutral-dark">
          ${_StarRatingComponent({ rating: apartment.rating, size: 'md', showLabel: true })}
          <span class="flex items-center">${MapPinIconSVG('w-5 h-5 mr-1 text-primary')} ${escapeHtml(apartment.location)} - ${escapeHtml(apartment.address)}</span>
          ${apartment.host.isVerified ? `<span class="flex items-center text-sm bg-green-100 text-green-700 px-2 py-0.5 rounded-full">${ShieldCheckIconSVG('w-4 h-4 mr-1')} Verified Host</span>` : ''}
        </div>
      </section>

      <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2">
          ${_ImageCarouselComponent({ images: apartment.images, altText: apartment.name, className: "h-[500px] rounded-xl", carouselId })}
          ${apartment.virtualTourUrl ? `
            <details class="mt-6 bg-neutral-lightest p-4 rounded-lg">
              <summary class="font-semibold text-primary cursor-pointer">View 360¬∞ Virtual Tour</summary>
              <div class="mt-4 aspect-video">
                <iframe src="${escapeHtml(apartment.virtualTourUrl)}" title="Virtual Tour" class="w-full h-full rounded" allowfullscreen></iframe>
              </div>
            </details>
          ` : ''}
        </div>

        <div class="lg:col-span-1">
          <form id="${bookingFormId}" class="bg-white p-6 rounded-xl shadow-xl sticky top-24">
            <p class="text-2xl font-bold mb-1">$${apartment.pricePerNight} <span class="text-sm font-normal text-neutral-DEFAULT">/ night</span></p>
            ${_StarRatingComponent({ rating: apartment.rating, size: 'sm', className: 'mb-4' })}
            <div class="grid grid-cols-2 gap-4 mb-4">
              ${_FormFieldComponent({ label: 'Check-in', id: 'checkin-date', type: 'date', icon: CalendarDaysIconSVG('w-5 h-5'), required: true })}
              ${_FormFieldComponent({ label: 'Check-out', id: 'checkout-date', type: 'date', icon: CalendarDaysIconSVG('w-5 h-5'), required: true })}
            </div>
            ${_FormFieldComponent({ label: 'Guests', id: 'guests-count', type: 'number', min: '1', max: '10', value: '1', icon: UsersIconSVG('w-5 h-5'), required: true })}
            ${_ButtonComponent({ text: 'Request to Book', type: 'submit', fullWidth: true, variant: 'primary', size: 'lg', className: 'my-4', id: 'request-booking-btn' })}
            <p id="booking-error-${apartment.id}" class="text-sm text-red-600 mb-3 hidden"></p>
            <div id="booking-cost-summary-${apartment.id}" class="text-sm space-y-1 text-neutral-dark mt-4 pt-4 border-t border-neutral-light hidden">
                <!-- Cost summary will be injected here -->
            </div>
          </form>
        </div>
      </section>

      <section class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <div class="md:col-span-2 space-y-6">
          <div>
            <h2 class="text-2xl font-semibold text-neutral-darker mb-3">About this space</h2>
            <p class="text-neutral-dark leading-relaxed whitespace-pre-line">${escapeHtml(apartment.detailedDescription || apartment.description)}</p>
          </div>
          <div>
            <h3 class="text-xl font-semibold text-neutral-darker mb-3">What this place offers (Amenities)</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-3">${amenitiesHTML}</div>
          </div>
          <details class="bg-neutral-lightest p-4 rounded-lg">
            <summary class="font-semibold text-primary cursor-pointer flex items-center">${InformationCircleIconSVG('w-5 h-5 mr-2')} House Rules & Policies</summary>
            <div class="mt-3 space-y-2 text-sm text-neutral-dark">
              <p><strong>House Rules:</strong> ${escapeHtml(apartment.houseRules.join(', '))}</p>
              <p><strong>Cancellation Policy:</strong> ${escapeHtml(apartment.cancellationPolicy)}</p>
            </div>
          </details>
        </div>
        <div class="md:col-span-1">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold text-neutral-darker mb-4">Hosted by ${escapeHtml(apartment.host.name)}</h3>
                <div class="flex items-center space-x-3 mb-3">
                    <img src="${apartment.host.avatarUrl}" alt="${escapeHtml(apartment.host.name)}" class="w-16 h-16 rounded-full object-cover" />
                    <div>
                        <p class="font-medium">${escapeHtml(apartment.host.name)}</p>
                        <p class="text-xs text-neutral-DEFAULT">Joined in ${new Date(apartment.host.joinDate).getFullYear()}</p>
                         ${apartment.host.isVerified ? `<span class="text-xs text-green-600 flex items-center">${CheckCircleIconSVG('w-3 h-3 mr-1')}Verified</span>` : ''}
                    </div>
                </div>
                ${_ButtonComponent({ text: 'Message Host', variant: 'outline', fullWidth: true })}
                <p class="text-xs text-neutral-DEFAULT mt-3 text-center">Hosts are committed to GreenValley's hospitality standards.</p>
            </div>
        </div>
      </section>
      
      <section>
        <h2 class="text-2xl font-semibold text-neutral-darker mb-4">Location</h2>
        ${_MapPlaceholderComponent({ address: apartment.address, className: "h-80 rounded-xl" })}
        ${apartment.nearbyLandmarks && apartment.nearbyLandmarks.length > 0 ? `
            <div class="mt-4">
                <h4 class="font-medium text-neutral-dark mb-1">Nearby:</h4>
                <ul class="list-disc list-inside text-sm text-neutral-dark">
                    ${apartment.nearbyLandmarks.map(landmark => `<li key="${escapeHtml(landmark)}">${escapeHtml(landmark)}</li>`).join('')}
                </ul>
            </div>
        ` : ''}
      </section>

      <section>
        <h2 class="text-2xl font-semibold text-neutral-darker mb-1">Reviews</h2>
        ${_StarRatingComponent({ rating: apartment.rating, size: 'md', showLabel: true, className: 'mb-4' })}
        <div class="space-y-4">${reviewsHTML}</div>
        ${apartment.reviews.length > 4 ? _ButtonComponent({ text: `Show all ${apartment.reviews.length} reviews`, variant: 'outline', className: 'mt-6' }) : ''}
        <div class="mt-8 p-6 bg-neutral-lightest rounded-lg">
          <h3 class="text-xl font-semibold text-neutral-darker mb-3">Leave a Review</h3>
          <p class="text-sm text-neutral-DEFAULT mb-3">Share your experience (feature coming soon).</p>
          ${_ButtonComponent({ text: 'Submit Your Review', disabled: true })}
        </div>
      </section>
    </div>
  `;
            _attachImageCarouselListeners(carouselId, apartment.images.length);

            const bookingForm = document.getElementById(bookingFormId);
            const checkinDateEl = document.getElementById('checkin-date');
            const checkoutDateEl = document.getElementById('checkout-date');
            const guestsEl = document.getElementById('guests-count');
            const costSummaryEl = document.getElementById(`booking-cost-summary-${apartment.id}`);
            const bookingErrorEl = document.getElementById(`booking-error-${apartment.id}`);
            const requestBookingBtn = document.getElementById('request-booking-btn');

            function updateCostSummary() {
                if (!checkinDateEl.value || !checkoutDateEl.value || !costSummaryEl) return;
                const checkIn = new Date(checkinDateEl.value);
                const checkOut = new Date(checkoutDateEl.value);
                if (checkOut <= checkIn) {
                    costSummaryEl.classList.add('hidden');
                    return;
                }
                const nights = Math.max(0, (checkOut.getTime() - checkIn.getTime()) / (1000 * 3600 * 24));
                const subtotal = apartment.pricePerNight * nights;
                const serviceFee = subtotal * 0.1; // Example 10%
                const totalCost = subtotal + serviceFee;

                costSummaryEl.innerHTML = `
        <div class="flex justify-between"><span>$${apartment.pricePerNight} x ${nights} nights</span> <span>$${subtotal.toFixed(2)}</span></div>
        <div class="flex justify-between"><span>Service fee</span> <span>$${serviceFee.toFixed(2)}</span></div>
        <div class="flex justify-between font-bold text-base pt-2 border-t border-neutral-light mt-2"><span>Total</span> <span>$${totalCost.toFixed(2)}</span></div>
        <p class="text-xs text-neutral-DEFAULT mt-1 text-center">You won't be charged yet.</p>
      `;
                costSummaryEl.classList.remove('hidden');
            }

            [checkinDateEl, checkoutDateEl].forEach(el => el.addEventListener('change', updateCostSummary));

            bookingForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                bookingErrorEl.classList.add('hidden');
                bookingErrorEl.textContent = '';
                requestBookingBtn.innerHTML = _ButtonComponent({ text: 'Processing...', isLoading: true, fullWidth: true, variant: 'primary', size: 'lg' });
                requestBookingBtn.disabled = true;

                const bookingDetails = {
                    apartmentId: apartment.id,
                    userId: appState.userProfile.id || "user123", // Use logged in user if available
                    checkInDate: checkinDateEl.value,
                    checkOutDate: checkoutDateEl.value,
                    guests: parseInt(guestsEl.value),
                    totalPrice: parseFloat(costSummaryEl.querySelector('.font-bold span:last-child')?.textContent.replace('$', '')) || 0
                };

                if (!bookingDetails.checkInDate || !bookingDetails.checkOutDate || bookingDetails.guests < 1 || new Date(bookingDetails.checkOutDate) <= new Date(bookingDetails.checkInDate)) {
                    bookingErrorEl.textContent = 'Please fill in all booking details correctly.';
                    bookingErrorEl.classList.remove('hidden');
                    requestBookingBtn.innerHTML = _ButtonComponent({ text: 'Request to Book', fullWidth: true, variant: 'primary', size: 'lg' });
                    requestBookingBtn.disabled = false;
                    return;
                }

                try {
                    const newBooking = await _submitBooking(bookingDetails);
                    _navigateTo(`/booking-confirmation/${newBooking.id}`);
                } catch (err) {
                    bookingErrorEl.textContent = err.message || 'Failed to create booking.';
                    bookingErrorEl.classList.remove('hidden');
                    requestBookingBtn.innerHTML = _ButtonComponent({ text: 'Request to Book', fullWidth: true, variant: 'primary', size: 'lg' });
                    requestBookingBtn.disabled = false;
                }
            });
        }


        async function _renderUserProfilePage() {
            _renderLoadingSpinner(mainContentArea, 'Loading profile...');
            const profile = await _fetchUserProfile(appState.userProfile.id || 'user123'); // Fetch profile if not loaded or for current user
            _clearLoadingSpinner(mainContentArea);

            if (!profile) {
                mainContentArea.innerHTML = `<p class="text-red-500">Profile not found.</p>`;
                return;
            }

            const bookingsHTML = profile.bookings && profile.bookings.length > 0
                ? profile.bookings.map(booking => `
      <div class="bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow">
        <a href="#/apartment/${booking.apartmentId}" class="block group apartment-card-link" data-apartment-id="${booking.apartmentId}">
          <img src="${booking.apartmentImage}" alt="${escapeHtml(booking.apartmentName)}" class="w-full h-40 object-cover rounded-md mb-3 group-hover:opacity-90 transition-opacity" />
          <h4 class="font-semibold text-primary group-hover:underline">${escapeHtml(booking.apartmentName)}</h4>
        </a>
        <p class="text-sm text-neutral-dark">Check-in: ${formatDate(booking.checkInDate)}</p>
        <p class="text-sm text-neutral-dark">Check-out: ${formatDate(booking.checkOutDate)}</p>
        <p class="text-sm text-neutral-dark">Guests: ${booking.guests}</p>
        <p class="text-sm font-medium mt-1">Total: $${booking.totalPrice.toFixed(2)}</p>
        <span class="text-xs font-semibold px-2 py-0.5 rounded-full mt-2 inline-block ${booking.status === 'confirmed' ? 'bg-green-100 text-green-700' :
                        booking.status === 'completed' ? 'bg-blue-100 text-blue-700' :
                            booking.status === 'cancelled' ? 'bg-red-100 text-red-700' :
                                'bg-yellow-100 text-yellow-700'
                    }">${escapeHtml(booking.status.replace('_', ' ').toUpperCase())}</span>
      </div>
    `).join('')
                : `
      <div class="text-center py-10 bg-white rounded-xl shadow-md col-span-full">
        <img src="${getUnsplashImage('empty,suitcase', 200, 150)}" alt="No bookings" class="mx-auto mb-4 rounded-lg opacity-70" />
        <p class="text-neutral-DEFAULT">You haven't made any bookings yet.</p>
        <a href="#/search">${_ButtonComponent({ text: 'Find Your Next Stay', variant: 'primary', className: 'mt-4' })}</a>
      </div>
    `;

            mainContentArea.innerHTML = `
    <div class="max-w-4xl mx-auto space-y-8">
      <section class="bg-white p-8 rounded-xl shadow-lg flex flex-col md:flex-row items-center space-y-6 md:space-y-0 md:space-x-8">
        <img src="${profile.avatarUrl}" alt="${escapeHtml(profile.name)}" class="w-32 h-32 rounded-full object-cover border-4 border-primary shadow-md" />
        <div class="text-center md:text-left">
          <h1 class="text-3xl font-bold text-neutral-darker">${escapeHtml(profile.name)}</h1>
          <p class="text-neutral-DEFAULT">${escapeHtml(profile.email)}</p>
          <p class="text-sm text-neutral-DEFAULT mt-1">Joined: ${formatDate(profile.joinDate)}</p>
          ${profile.isVerified ? `<span class="mt-2 inline-flex items-center bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium">${ShieldCheckIconSVG('w-5 h-5 mr-1.5')} Verified Account</span>` : ''}
        </div>
        <div id="edit-profile-button-container" class="md:ml-auto">
          <!-- Edit button will be rendered by JS -->
        </div>
      </section>

      <section id="edit-profile-form-section" class="bg-white p-8 rounded-xl shadow-lg hidden">
        <h2 class="text-2xl font-semibold text-neutral-darker mb-6">Edit Your Information</h2>
        <form id="edit-profile-form" class="space-y-4">
          ${_FormFieldComponent({ label: 'Full Name', id: 'profile-name-edit', type: 'text', value: profile.name, required: true })}
          ${_FormFieldComponent({ label: 'Email Address', id: 'profile-email-edit', type: 'email', value: profile.email, required: true })}
          <div class="flex justify-end space-x-3">
            ${_ButtonComponent({ text: 'Cancel', type: 'button', variant: 'ghost', id: 'cancel-edit-profile-btn' })}
            ${_ButtonComponent({ text: 'Save Changes', type: 'submit', variant: 'primary' })}
          </div>
        </form>
      </section>

      <section class="bg-gradient-to-r from-primary to-emerald-600 p-6 rounded-xl shadow-lg text-white">
        <h2 class="text-2xl font-semibold mb-2">Loyalty Program</h2>
        <p class="text-lg">You have <span class="font-bold text-amber-300">${profile.loyaltyPoints}</span> loyalty points!</p>
        <p class="text-sm opacity-90">Use points for discounts on future bookings or exclusive perks.</p>
        ${_ButtonComponent({ text: 'View Rewards', variant: 'outline', className: 'mt-4 !border-white !text-white hover:!bg-white/20' })}
      </section>

      <section>
        <h2 class="text-2xl font-semibold text-neutral-darker mb-6 flex items-center">${CalendarDaysIconSVG('w-7 h-7 mr-3 text-primary')} Your Bookings</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">${bookingsHTML}</div>
      </section>
      
      <section class="bg-white p-8 rounded-xl shadow-lg">
        <h2 class="text-2xl font-semibold text-neutral-darker mb-6">Settings & Preferences</h2>
        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <label for="notifications-pref" class="text-neutral-dark">Email Notifications</label>
            <input type="checkbox" id="notifications-pref" ${profile.preferences.notifications ? 'checked' : ''} class="form-checkbox h-5 w-5 text-primary rounded focus:ring-primary-light" />
          </div>
          <p class="text-sm text-neutral-DEFAULT pt-4 border-t border-neutral-light">More settings coming soon.</p>
        </div>
      </section>
    </div>
  `;
            _attachApartmentCardEventListeners();
            _renderEditProfileButton(false); // Initially render "Edit Profile" button

            // Event listener for edit profile form
            const editProfileFormSection = document.getElementById('edit-profile-form-section');
            const editProfileForm = document.getElementById('edit-profile-form');
            const cancelEditBtn = document.getElementById('cancel-edit-profile-btn');

            if (editProfileForm) {
                editProfileForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    // Simulate save
                    const newName = document.getElementById('profile-name-edit').value;
                    const newEmail = document.getElementById('profile-email-edit').value;
                    appState.userProfile.name = newName;
                    appState.userProfile.email = newEmail;
                    editProfileFormSection.classList.add('hidden');
                    _renderUserProfilePage(); // Re-render to show updated info and button state
                });
            }
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', () => {
                    editProfileFormSection.classList.add('hidden');
                    _renderEditProfileButton(false);
                });
            }
        }

        function _renderEditProfileButton(isEditing) {
            const container = document.getElementById('edit-profile-button-container');
            if (container) {
                if (isEditing) {
                    container.innerHTML = _ButtonComponent({ text: 'Cancel Edit', variant: 'danger', id: 'toggle-edit-profile-btn' });
                } else {
                    container.innerHTML = _ButtonComponent({ text: 'Edit Profile', variant: 'outline', id: 'toggle-edit-profile-btn' });
                }
                document.getElementById('toggle-edit-profile-btn').addEventListener('click', () => {
                    const formSection = document.getElementById('edit-profile-form-section');
                    const currentlyEditing = !formSection.classList.contains('hidden');
                    formSection.classList.toggle('hidden');
                    _renderEditProfileButton(!currentlyEditing);
                    if (!currentlyEditing) { // If was not editing, now it is. Populate form.
                        if (appState.userProfile) {
                            document.getElementById('profile-name-edit').value = appState.userProfile.name;
                            document.getElementById('profile-email-edit').value = appState.userProfile.email;
                        }
                    }
                });
            }
        }


        async function _renderBookingConfirmationPage(bookingId) {
            _renderLoadingSpinner(mainContentArea, 'Loading booking confirmation...');
            // Simulate fetching the specific booking
            const booking = mockUserBookings.find(b => b.id === bookingId) || (await _fetchUserBookings(appState.userProfile.id || 'user123')).find(b => b.id === bookingId);
            _clearLoadingSpinner(mainContentArea);

            if (!booking) {
                mainContentArea.innerHTML = `<p class="text-red-500">Booking not found.</p>`;
                return;
            }

            mainContentArea.innerHTML = `
    <div class="max-w-2xl mx-auto text-center py-12">
      ${CheckCircleIconSVG('w-24 h-24 text-primary mx-auto mb-6')}
      <h1 class="text-4xl font-bold text-neutral-darker mb-4">Booking Confirmed!</h1>
      <p class="text-lg text-neutral-dark mb-8">
        Thank you for booking with GreenValley. Your stay at <strong class="text-primary">${escapeHtml(booking.apartmentName)}</strong> is confirmed.
      </p>
      <div class="bg-white p-8 rounded-xl shadow-xl text-left space-y-4 mb-8 border border-primary-light">
        <h2 class="text-2xl font-semibold text-neutral-darker mb-4 border-b pb-3">Booking Summary (ID: ${escapeHtml(booking.id)})</h2>
        <div><img src="${booking.apartmentImage}" alt="${escapeHtml(booking.apartmentName)}" class="w-full h-48 object-cover rounded-lg mb-4" /></div>
        <div class="flex items-center">${MapPinIconSVG('w-5 h-5 mr-3 text-primary flex-shrink-0')} <span class="text-neutral-dark"><strong>Apartment:</strong> ${escapeHtml(booking.apartmentName)}</span></div>
        <div class="flex items-center">${CalendarDaysIconSVG('w-5 h-5 mr-3 text-primary flex-shrink-0')} <span class="text-neutral-dark"><strong>Check-in:</strong> ${formatDate(booking.checkInDate)}</span></div>
        <div class="flex items-center">${CalendarDaysIconSVG('w-5 h-5 mr-3 text-primary flex-shrink-0')} <span class="text-neutral-dark"><strong>Check-out:</strong> ${formatDate(booking.checkOutDate)}</span></div>
        <div class="flex items-center">${UsersIconSVG('w-5 h-5 mr-3 text-primary flex-shrink-0')} <span class="text-neutral-dark"><strong>Guests:</strong> ${booking.guests}</span></div>
        <div class="flex items-center pt-3 border-t mt-3">${CurrencyDollarIconSVG('w-5 h-5 mr-3 text-primary flex-shrink-0')} <span class="text-neutral-dark font-semibold"><strong>Total Price:</strong> $${booking.totalPrice.toFixed(2)}</span></div>
      </div>
      <p class="text-sm text-neutral-DEFAULT mb-6">You will receive an email confirmation shortly.</p>
      <div class="space-x-4">
        <a href="#/">${_ButtonComponent({ text: 'Back to Home', variant: 'primary', size: 'lg' })}</a>
        <a href="#/profile">${_ButtonComponent({ text: 'View My Bookings', variant: 'outline', size: 'lg' })}</a>
      </div>
      <details class="mt-10 text-sm text-neutral-dark bg-neutral-lightest p-4 rounded-lg text-left">
        <summary class="font-medium text-primary cursor-pointer">Important Information</summary>
        <ul class="list-disc list-inside mt-2 space-y-1 pl-4">
          <li>Remember to bring a valid ID for check-in.</li>
          <li>Contact your host for any specific arrival instructions.</li>
          <li>For assistance, contact our <a href="#/help" class="text-primary underline hover:text-primary-dark">24/7 support</a>.</li>
        </ul>
      </details>
    </div>
  `;
        }

        function _renderNotFoundPage() {
            mainContentArea.innerHTML = `
    <div class="flex flex-col items-center justify-center min-h-[calc(100vh-200px)] text-center px-4">
      <img src="${getUnsplashImage('lost,compass,map', 400, 300)}" alt="Lost illustration" class="w-64 h-auto mb-8 rounded-lg shadow-lg" />
      <h1 class="text-6xl font-bold text-primary mb-4">404</h1>
      <h2 class="text-3xl font-semibold text-neutral-darker mb-3">Page Not Found</h2>
      <p class="text-neutral-dark max-w-md mb-8">Oops! The page you're looking for doesn't seem to exist.</p>
      <a href="#/">${_ButtonComponent({ text: 'Go Back to Homepage', variant: 'primary', size: 'lg' })}</a>
    </div>
  `;
        }

        function _renderModal() {
            modalRoot.innerHTML = _ModalComponent({
                isOpen: appState.isModalOpen,
                title: appState.modalContent.title,
                childrenHTML: appState.modalContent.body,
                onCloseId: 'global-modal-close-btn'
            });
            if (appState.isModalOpen) {
                document.getElementById('global-modal-close-btn')?.addEventListener('click', _closeModal);
                document.getElementById('modal-overlay')?.addEventListener('click', (e) => {
                    if (e.target.id === 'modal-overlay') _closeModal();
                });
            }
        }

        function _openModal(title, bodyHTML) {
            appState.isModalOpen = true;
            appState.modalContent = { title, body: bodyHTML };
            _renderModal();
        }

        function _closeModal() {
            appState.isModalOpen = false;
            _renderModal(); // Re-renders an empty modalRoot, effectively closing it
        }

        // --- ROUTING ---
        function _handleHashChange() {
            _renderNavbar(); // Re-render navbar to update active links
            const hash = window.location.hash.replace(/^#\/?|\/$/g, '').split('/');
            const page = hash[0] || 'home';
            const param1 = hash[1];
            // const param2 = hash[2]; // For more complex routes if needed

            appState.currentRoute = { page, params: { id: param1 } }; // Basic param handling

            // Basic scroll to top on page change
            window.scrollTo(0, 0);

            switch (page) {
                case 'home': _renderHomePage(); break;
                case 'search': _renderApartmentSearchPage(); break;
                case 'apartment': _renderApartmentDetailPage(param1); break;
                case 'profile': _renderUserProfilePage(); break;
                case 'booking-confirmation': _renderBookingConfirmationPage(param1); break;
                // Add cases for terms, privacy, help if they become actual pages
                case 'terms': mainContentArea.innerHTML = `<h1>Terms of Service</h1><p>Content coming soon...</p>`; break;
                case 'privacy': mainContentArea.innerHTML = `<h1>Privacy Policy</h1><p>Content coming soon...</p>`; break;
                case 'help': mainContentArea.innerHTML = `<h1>Help Center</h1><p>24/7 Support: Call us at +1234567890 or email support@greenvalley.com</p>`; break;
                default: _renderNotFoundPage(); break;
            }
        }

        function _navigateTo(path) {
            window.location.hash = path;
        }

        // Attach event listeners for apartment cards (using event delegation)
        function _attachApartmentCardEventListeners() {
            mainContentArea.addEventListener('click', function (event) {
                // For View Details button on ApartmentCard
                const buttonTarget = event.target.closest('.apartment-card-view-details-btn');
                if (buttonTarget) {
                    const apartmentId = buttonTarget.dataset.apartmentId;
                    if (apartmentId) {
                        _navigateTo(`/apartment/${apartmentId}`);
                    }
                    return;
                }

                // For the entire card link (figure/image part)
                const linkTarget = event.target.closest('.apartment-card-link');
                if (linkTarget) {
                    event.preventDefault(); // Prevent default if it was an <a> wrapped around, now it's handled by JS
                    const apartmentId = linkTarget.dataset.apartmentId;
                    if (apartmentId) {
                        _navigateTo(`/apartment/${apartmentId}`);
                    }
                    return;
                }
            });
        }


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initial render of static parts
            _renderNavbar();
            _renderFooter();

            // Set up routing and initial page load
            window.addEventListener('hashchange', _handleHashChange);
            _handleHashChange(); // Load initial page based on hash or default
            _attachApartmentCardEventListeners(); // Attach global listeners for dynamically added cards
        });

        // --- END OF EMBEDDED JAVASCRIPT ---
    </script>
</body>

</html>