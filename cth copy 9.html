<!DOCTYPE html>
<html lang="id" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green Valley - Platform Sewa Apartemen Premium</title>
    <link rel="icon"
        href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAAbwAAAG8B8aLcQwAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAPMSURBVFjDrZdbaFxVFMd/570zk0xmMiUzaZq0SWOLpFXUhbHFQlHcFDEUBK0UcaFbRaCtG6OuXFlExUUXItGVUF2IqF1Y7YIuBNEGjUBrJVZCY9OkzSQ9jUxm0kxmMienc897jrjZGSwfzuxOfOf87znn/O85YqSTAeD6yF0kQh9K6NPB9yGOVSJAAQp890hFPYwPjEL5t9M5T0gGgPnz9jJLDgJ4jYJHLgyG8hN+4yIwkQSy95lbgXQ8QBda0ZzTBiVVOgqA2WzWrbUAXdUJ0HjQgRI9JgB4tT40zZnNAGgM2FFY2eZQEAEgqLoElrYFAFRD1qPZgGSUFADQ+qQ0gOBOQN8CADZKOgnQEaDaOkvWSoBmxAXQF1ArAsjSOkFkYnQ2j9nbgGZkF+jGVgCYuX0fAGS3iXnUAjBoKAA0KvwjQBOgKqHbs/bxQJkUHwDoVLYXAlAHiAbokPTs/RUAKoA2AJSFuSkuQF8BYGT3y8kXgCO2S9m7R6wLAFpJXyQAnQLQFxDV9Fk7GgB73qV5Nl9LwAQA/XUBCG0YAZC/8j5gJsQqQAdAi/16JwCaAHT0E74zS0kAVgK4T0PZU3/gV/FzJ6YVAGUfL20FQDcgaA+oBMDj7S/WNgB273K6Q9n6QhA5gA0A3b8nAFgG87GkdpWZvAfA1gfbEu0A0AlAgxJ6LQQgAnhG8Z32YiA2ADSti+7Hw20A8P9XgL4AaAXAVcB67h2rRQCn0/lO230FQCmAp4G89wAUAKxlJLWhQCdAvwOAmgCqAdACyKcCGAXQDeBQCxQBDAZ4UUAkAExuFozSgGYA3Y0hG9BvANqAowCeAjwLIAigBWL/EMBOgD6ARAA3AZQCnAPQCbAXsF0LwCGAxwb52ADQCbAbYDbgPQCXAa8A/gXwqYAvAnwG2GvATD/iz/L93S0AFYB/h1+AaAE8BHgFQPcBzgoA4q8/i0n6HkDxLwB35wFoJgL0AOAiYPUv0A+gKyA1wFkAXwHeLQF3WwLgH0BLgHOAOoB2ALUC6AKoJbCKAFAIsBZwCGAEAFUABgB8APgBEOkGABMAjgAEAAZAAEAAYADkAxAATAI4h5j2xVqAfwMUBfyPPM9kS0AkAFUAwFkAlQBNgOkBnQB9Hn/0xO/ABTj8kL8ALkAVwI6D/gBILjMCuAkwnc/1HwDkGgPumA/wvwGmhAYUoC5iAvwLTPw41kTAAAAAASUVORK5CYII=">
    <!-- Contoh favicon.png dari data URI -->

    <!-- Icon Online Gratis: Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Font Online Gratis: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <style>
        /* === SISTEM DESAIN TERPADU & VARIABEL CSS === */
        :root {
            --font-primary: 'Inter', sans-serif;

            --primary-hue: 214;
            --primary-saturation: 90%;
            --primary-lightness: 52%;
            --primary-color: hsl(var(--primary-hue), var(--primary-saturation), var(--primary-lightness));
            --primary-color-hover: hsl(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) + 10%));
            --primary-color-active: hsl(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) - 5%));

            --secondary-hue: 180;
            --secondary-saturation: 50%;
            --secondary-lightness: 45%;
            --secondary-color: hsl(var(--secondary-hue), var(--secondary-saturation), var(--secondary-lightness));


            --background-light: 0 0% 100%;
            --foreground-light: 222 20% 18%;
            --card-background-light: 0 0% 98%;
            --border-color-light: 0 0% 90%;
            --sidebar-bg-light: 0 0% 95%;

            --background-dark: 226 32% 10%;
            --foreground-dark: 210 40% 98%;
            --card-background-dark: 226 32% 15%;
            --border-color-dark: 226 32% 25%;
            --sidebar-bg-dark: 226 32% 12%;


            --background: hsl(var(--background-light));
            --foreground: hsl(var(--foreground-light));
            --card-background: hsl(var(--card-background-light));
            --border-color: hsl(var(--border-color-light));
            --sidebar-background: hsl(var(--sidebar-bg-light));


            --radius-sm: 0.25rem;
            /* 4px */
            --radius-md: 0.5rem;
            /* 8px */
            --radius-lg: 0.75rem;
            /* 12px */

            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 12px -2px rgba(0, 0, 0, 0.1), 0 2px 8px -2px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 15px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 40px -5px rgba(0, 0, 0, 0.1), 0 10px 30px -5px rgba(0, 0, 0, 0.08);

            --transition-duration: 0.3s;
            --transition-timing: cubic-bezier(0.4, 0, 0.2, 1);
            --transition-main: all var(--transition-duration) var(--transition-timing);

            --container-width: 1280px;
            --sidebar-width: 260px;
            --gap-xs: 0.25rem;
            --gap-sm: 0.5rem;
            --gap-md: 1rem;
            --gap-lg: 1.5rem;
            --gap-xl: 2rem;
        }

        /* === TEMA GELAP === */
        html.dark {
            --background: hsl(var(--background-dark));
            --foreground: hsl(var(--foreground-dark));
            --card-background: hsl(var(--card-background-dark));
            --border-color: hsl(var(--border-color-dark));
            --sidebar-background: hsl(var(--sidebar-bg-dark));
        }

        /* === RESET & DASAR TIPOGRAFI === */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
            font-size: 16px;
        }

        body {
            font-family: var(--font-primary);
            background-color: var(--background);
            color: var(--foreground);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: var(--transition-main);
            display: flex;
            /* Untuk layout dengan sidebar */
            min-height: 100vh;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: var(--gap-md);
        }

        h1 {
            font-size: 2.5rem;
        }

        h2 {
            font-size: 2rem;
        }

        h3 {
            font-size: 1.5rem;
        }

        h4 {
            font-size: 1.25rem;
        }

        p {
            margin-bottom: var(--gap-md);
        }

        a {
            color: var(--primary-color);
            text-decoration: none;
            transition: var(--transition-main);
        }

        a:hover {
            color: var(--primary-color-hover);
            text-decoration: underline;
        }

        img {
            max-width: 100%;
            height: auto;
            display: block;
        }

        ul,
        ol {
            list-style: none;
        }

        /* === STRUKTUR UTAMA APLIKASI DENGAN SIDEBAR === */
        .app-wrapper {
            display: flex;
            flex-direction: column;
            /* Header di atas, lalu konten utama */
            width: 100%;
            transition: margin-left var(--transition-duration) var(--transition-timing);
        }

        .app-wrapper.sidebar-active {
            /* Digunakan jika sidebar fix di kiri dan konten utama geser */
            /* margin-left: var(--sidebar-width);  */
        }

        /* === UTILITAS === */
        .container {
            width: 90%;
            max-width: var(--container-width);
            margin-left: auto;
            margin-right: auto;
            padding-top: var(--gap-xl);
            padding-bottom: var(--gap-xl);
        }

        .d-flex {
            display: flex;
        }

        .align-items-center {
            align-items: center;
        }

        .justify-content-between {
            justify-content: space-between;
        }

        .justify-content-center {
            justify-content: center;
        }

        .justify-content-end {
            justify-content: flex-end;
        }

        .flex-column {
            flex-direction: column;
        }

        .flex-grow-1 {
            flex-grow: 1;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .mt-1 {
            margin-top: var(--gap-sm);
        }

        .mb-1 {
            margin-bottom: var(--gap-sm);
        }

        .mt-2 {
            margin-top: var(--gap-md);
        }

        .mb-2 {
            margin-bottom: var(--gap-md);
        }

        .mt-3 {
            margin-top: var(--gap-lg);
        }

        .mb-3 {
            margin-bottom: var(--gap-lg);
        }

        .mt-4 {
            margin-top: var(--gap-xl);
        }

        .mb-4 {
            margin-bottom: var(--gap-xl);
        }

        .p-1 {
            padding: var(--gap-sm);
        }

        .p-2 {
            padding: var(--gap-md);
        }

        .p-3 {
            padding: var(--gap-lg);
        }

        .p-4 {
            padding: var(--gap-xl);
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        .badge {
            display: inline-block;
            padding: 0.25em 0.6em;
            font-size: 0.75em;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: var(--radius-sm);
            background-color: var(--secondary-color);
            color: white;
        }

        .badge.primary {
            background-color: var(--primary-color);
        }

        .badge.warning {
            background-color: hsl(45, 100%, 50%);
            color: var(--foreground-light);
        }

        .badge.danger {
            background-color: hsl(0, 70%, 50%);
        }

        .badge.success {
            background-color: hsl(120, 60%, 45%);
        }


        /* === KOMPONEN UI === */
        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--gap-sm);
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            transition: var(--transition-main);
            background-color: var(--primary-color);
            color: white;
            border: 1px solid transparent;
            cursor: pointer;
            text-decoration: none;
        }

        .button:hover {
            background-color: var(--primary-color-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            text-decoration: none;
        }

        .button:active {
            background-color: var(--primary-color-active);
            transform: translateY(0);
        }

        .button i {
            font-size: 1em;
        }

        .button-outline {
            background-color: transparent;
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .button-outline:hover {
            background-color: hsla(var(--primary-hue), var(--primary-saturation), var(--primary-lightness), 0.1);
            color: var(--primary-color-hover);
        }

        .button-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .button-danger {
            background-color: hsl(0, 70%, 50%);
        }

        .button-danger:hover {
            background-color: hsl(0, 70%, 60%);
        }

        .input-group {
            margin-bottom: var(--gap-md);
        }

        .input-group label {
            display: block;
            margin-bottom: var(--gap-sm);
            font-weight: 500;
        }

        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background-color: var(--background);
            color: var(--foreground);
            font-family: inherit;
            font-size: 1rem;
            transition: var(--transition-main);
        }

        .input-group input:focus,
        .input-group textarea:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px hsla(var(--primary-hue), var(--primary-saturation), var(--primary-lightness), 0.2);
        }

        .input-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .card {
            background-color: var(--card-background);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--gap-lg);
            transition: var(--transition-main);
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .card-title {
            margin-top: 0;
            margin-bottom: var(--gap-md);
        }

        .card-header {
            padding: var(--gap-md) var(--gap-lg);
            margin: calc(var(--gap-lg) * -1) calc(var(--gap-lg) * -1) var(--gap-lg);
            border-bottom: 1px solid var(--border-color);
            background-color: hsla(0, 0%, 0%, 0.02);
        }

        html.dark .card-header {
            background-color: hsla(0, 0%, 100%, 0.02);
        }

        /* === HEADER & NAVIGASI === */
        .site-header {
            background-color: var(--card-background);
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: var(--transition-main);
            width: 100%;
        }

        .site-header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: var(--gap-md);
            padding-bottom: var(--gap-md);
        }

        .logo {
            font-weight: 800;
            font-size: 1.75rem;
            color: var(--primary-color);
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: var(--gap-lg);
        }

        .nav-links a {
            font-weight: 500;
            color: var(--foreground);
            padding: var(--gap-sm) 0;
            position: relative;
        }

        .nav-links a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background-color: var(--primary-color);
            transition: width var(--transition-duration) var(--transition-timing);
        }

        .nav-links a:hover::after,
        .nav-links a.active::after {
            width: 100%;
        }

        .nav-links a.active {
            color: var(--primary-color);
            font-weight: 600;
        }

        .theme-toggle,
        .mobile-menu-toggle,
        .sidebar-toggle-btn {
            background: none;
            border: none;
            color: var(--foreground);
            cursor: pointer;
            font-size: 1.5rem;
            padding: var(--gap-sm);
            border-radius: var(--radius-sm);
            transition: var(--transition-main);
        }

        .theme-toggle:hover,
        .mobile-menu-toggle:hover,
        .sidebar-toggle-btn:hover {
            color: var(--primary-color);
            background-color: hsla(var(--primary-hue), var(--primary-saturation), var(--primary-lightness), 0.1);
        }

        .mobile-menu-toggle {
            display: none;
        }

        /* Sembunyikan di desktop */
        .sidebar-toggle-btn {
            display: none;
        }

        /* Ditampilkan jika sidebar ada */

        .user-profile-dropdown {
            position: relative;
        }

        .user-profile-button {
            display: flex;
            align-items: center;
            gap: var(--gap-sm);
            background: none;
            border: none;
            cursor: pointer;
            padding: var(--gap-sm);
            border-radius: var(--radius-md);
            transition: var(--transition-main);
        }

        .user-profile-button:hover {
            background-color: hsla(0, 0%, 0%, 0.05);
        }

        html.dark .user-profile-button:hover {
            background-color: hsla(0, 0%, 100%, 0.05);
        }

        .user-profile-button img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border-color);
        }

        .user-profile-button span {
            font-weight: 500;
            color: var(--foreground);
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: calc(100% + var(--gap-sm));
            right: 0;
            background-color: var(--card-background);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 1001;
            min-width: 200px;
            list-style: none;
            padding: var(--gap-sm) 0;
        }

        .user-profile-dropdown.open .dropdown-menu {
            display: block;
        }

        .dropdown-menu a,
        .dropdown-menu button {
            display: block;
            width: 100%;
            text-align: left;
            padding: var(--gap-sm) var(--gap-md);
            color: var(--foreground);
            text-decoration: none;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .dropdown-menu a:hover,
        .dropdown-menu button:hover {
            background-color: hsla(var(--primary-hue), var(--primary-saturation), var(--primary-lightness), 0.1);
            color: var(--primary-color);
        }

        .dropdown-menu .divider {
            height: 1px;
            background-color: var(--border-color);
            margin: var(--gap-sm) 0;
        }

        .dropdown-menu i {
            margin-right: var(--gap-md);
            width: 16px;
            text-align: center;
        }

        /* === SIDEBAR PENGGUNA === */
        .user-sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-background);
            padding: var(--gap-lg) 0;
            height: 100vh;
            /* Penuh tinggi viewport */
            position: fixed;
            /* Tetap di kiri */
            top: 0;
            left: 0;
            z-index: 999;
            /* Di bawah header sticky, tapi di atas konten lain */
            overflow-y: auto;
            box-shadow: var(--shadow-md);
            transition: transform var(--transition-duration) var(--transition-timing);
            transform: translateX(-100%);
            /* Sembunyi di luar layar kiri by default */
        }

        .user-sidebar.open {
            transform: translateX(0);
            /* Munculkan sidebar */
        }

        .user-sidebar .sidebar-header {
            padding: 0 var(--gap-lg) var(--gap-lg) var(--gap-lg);
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: var(--gap-lg);
        }

        .user-sidebar .sidebar-header img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: var(--gap-sm);
            border: 3px solid var(--primary-color);
            padding: 3px;
            background-color: var(--background);
        }

        .user-sidebar .sidebar-header h4 {
            margin-bottom: var(--gap-xs);
            font-size: 1.1rem;
        }

        .user-sidebar .sidebar-header p {
            font-size: 0.85rem;
            color: hsl(var(--foreground-light), 0.7);
            margin-bottom: 0;
        }

        html.dark .user-sidebar .sidebar-header p {
            color: hsl(var(--foreground-dark), 0.7);
        }

        .sidebar-nav a {
            display: flex;
            align-items: center;
            gap: var(--gap-md);
            padding: var(--gap-md) var(--gap-lg);
            color: var(--foreground);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition-main);
            border-left: 3px solid transparent;
        }

        .sidebar-nav a:hover {
            background-color: hsla(var(--primary-hue), var(--primary-saturation), var(--primary-lightness), 0.1);
            color: var(--primary-color);
            border-left-color: var(--primary-color);
        }

        .sidebar-nav a.active {
            background-color: hsla(var(--primary-hue), var(--primary-saturation), var(--primary-lightness), 0.15);
            color: var(--primary-color);
            font-weight: 600;
            border-left-color: var(--primary-color);
        }

        .sidebar-nav a i {
            font-size: 1.1em;
            width: 20px;
            /* Jaga alignment */
            text-align: center;
        }

        /* Konten Utama */
        .main-content {
            flex-grow: 1;
            padding-left: 0;
            /* Default, akan diubah JS jika sidebar visible */
            transition: padding-left var(--transition-duration) var(--transition-timing);
        }

        .main-content.sidebar-visible {
            padding-left: var(--sidebar-width);
        }


        /* === BAGIAN HERO === */
        .hero-section {
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1600&q=80') no-repeat center center/cover;
            color: white;
            padding: 6rem 0;
            text-align: center;
        }

        .hero-section .container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .hero-section h1 {
            font-size: 3.5rem;
            margin-bottom: var(--gap-md);
            max-width: 800px;
        }

        .hero-section p {
            font-size: 1.25rem;
            max-width: 700px;
            margin-bottom: var(--gap-lg);
            opacity: 0.9;
        }

        /* === BAGIAN PROPERTI UNGGULAN & LISTING === */
        .section-title {
            text-align: center;
            margin-bottom: var(--gap-xl);
        }

        .section-title h2 {
            margin-bottom: var(--gap-sm);
        }

        .section-title p {
            font-size: 1.125rem;
            color: hsl(var(--foreground-light), 0.7);
        }

        html.dark .section-title p {
            color: hsl(var(--foreground-dark), 0.7);
        }

        .property-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: var(--gap-lg);
        }

        .property-card .property-image {
            height: 220px;
            background-size: cover;
            background-position: center;
            border-top-left-radius: var(--radius-lg);
            border-top-right-radius: var(--radius-lg);
        }

        .property-card .property-details {
            padding: var(--gap-md);
        }

        .property-card h3 {
            font-size: 1.25rem;
            margin-bottom: var(--gap-sm);
        }

        .property-price {
            font-weight: 700;
            font-size: 1.375rem;
            color: var(--primary-color);
            margin-bottom: var(--gap-sm);
        }

        .property-location {
            display: flex;
            align-items: center;
            gap: var(--gap-sm);
            margin-bottom: var(--gap-md);
            color: hsl(var(--foreground-light), 0.7);
        }

        html.dark .property-location {
            color: hsl(var(--foreground-dark), 0.7);
        }

        .property-location i {
            color: var(--primary-color);
        }

        .property-features {
            display: flex;
            gap: var(--gap-md);
            margin-bottom: var(--gap-md);
            font-size: 0.9rem;
            color: hsl(var(--foreground-light), 0.8);
        }

        html.dark .property-features {
            color: hsl(var(--foreground-dark), 0.8);
        }

        .property-features span {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .property-features i {
            color: var(--primary-color);
        }

        /* === BAGIAN VIRTUAL TOUR (Placeholder) === */
        .virtual-tour-placeholder {
            position: relative;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            aspect-ratio: 16 / 9;
            background-color: hsl(var(--primary-hue), 20%, 90%);
        }

        .virtual-tour-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .tour-controls {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: var(--transition-main);
        }

        .virtual-tour-placeholder:hover .tour-controls {
            opacity: 1;
        }

        /* === BAGIAN PEMBAYARAN === */
        .payment-methods {
            display: flex;
            flex-wrap: wrap;
            gap: var(--gap-md);
            justify-content: center;
            margin-bottom: var(--gap-lg);
        }

        .payment-card {
            flex-basis: 200px;
            padding: var(--gap-lg);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            text-align: center;
            cursor: pointer;
            transition: var(--transition-main);
        }

        .payment-card:hover,
        .payment-card.selected {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
            transform: translateY(-3px);
        }

        .payment-card i {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: var(--gap-sm);
        }

        .payment-card h3 {
            font-size: 1.125rem;
            margin-bottom: 0;
        }

        #paymentDetailsContainer {
            max-width: 500px;
            margin: var(--gap-lg) auto 0;
        }


        /* === BAGIAN ULASAN === */
        .review-form {
            margin-bottom: var(--gap-xl);
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .rating-stars {
            display: flex;
            gap: var(--gap-sm);
            margin-bottom: var(--gap-md);
            font-size: 2rem;
        }

        .rating-stars span {
            cursor: pointer;
            color: #ccc;
            transition: color 0.2s;
        }

        .rating-stars span.active,
        .rating-stars span:hover,
        .rating-stars span:hover~span {
            color: #ffd700;
        }

        .rating-stars:hover span {
            color: #ffd700;
        }

        .rating-stars span.selected,
        .rating-stars span.selected~span {
            color: #ffd700;
        }

        .rating-stars.rated span:not(.selected):not(:hover) {
            color: #ccc;
        }

        .review-card {
            margin-bottom: var(--gap-md);
            padding: var(--gap-lg);
        }

        .review-card .rating {
            font-size: 1.2rem;
            color: #ffd700;
            margin-bottom: var(--gap-sm);
        }

        .review-card p {
            margin-bottom: var(--gap-sm);
        }

        .review-card time {
            font-size: 0.875rem;
            color: hsl(var(--foreground-light), 0.6);
        }

        html.dark .review-card time {
            color: hsl(var(--foreground-dark), 0.6);
        }

        /* === BAGIAN TENTANG & KONTAK === */
        .about-content,
        .contact-form-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--gap-xl);
            align-items: start;
        }

        .contact-info p {
            display: flex;
            align-items: center;
            gap: var(--gap-sm);
            margin-bottom: var(--gap-sm);
        }

        .contact-info i {
            color: var(--primary-color);
            width: 20px;
        }

        /* === FOOTER === */
        .site-footer {
            background-color: var(--card-background);
            padding: var(--gap-xl) 0;
            border-top: 1px solid var(--border-color);
            color: hsl(var(--foreground-light), 0.8);
            margin-top: auto;
            /* Dorong footer ke bawah */
        }

        html.dark .site-footer {
            color: hsl(var(--foreground-dark), 0.8);
        }

        .footer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--gap-lg);
            margin-bottom: var(--gap-xl);
        }

        .footer-column h3 {
            font-size: 1.125rem;
            margin-bottom: var(--gap-md);
            color: var(--foreground);
        }

        .footer-column ul li {
            margin-bottom: var(--gap-sm);
        }

        .footer-column ul li a {
            color: inherit;
            text-decoration: none;
        }

        .footer-column ul li a:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }

        .social-links a {
            font-size: 1.5rem;
            margin-right: var(--gap-md);
            color: inherit;
        }

        .social-links a:hover {
            color: var(--primary-color);
        }

        .copyright {
            text-align: center;
            padding-top: var(--gap-lg);
            border-top: 1px solid var(--border-color);
            font-size: 0.875rem;
        }

        /* === CHAT WIDGET === */
        .chat-container {
            position: fixed;
            bottom: var(--gap-lg);
            right: var(--gap-lg);
            z-index: 1001;
        }

        .chat-toggle-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 1.75rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-main);
        }

        .chat-toggle-button:hover {
            background-color: var(--primary-color-hover);
            transform: scale(1.1);
        }

        .chat-window {
            display: none;
            position: absolute;
            bottom: calc(100% + var(--gap-md));
            right: 0;
            width: 350px;
            max-height: 450px;
            background-color: var(--card-background);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            flex-direction: column;
        }

        .chat-window.open {
            display: flex;
        }

        .chat-header {
            padding: var(--gap-md);
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header .close-chat {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .chat-messages {
            flex-grow: 1;
            padding: var(--gap-md);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--gap-sm);
        }

        .chat-msg {
            padding: var(--gap-sm) var(--gap-md);
            border-radius: var(--radius-md);
            max-width: 80%;
            word-wrap: break-word;
        }

        .chat-msg.user {
            background-color: var(--primary-color);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: var(--radius-sm);
        }

        .chat-msg.system {
            background-color: var(--border-color);
            color: var(--foreground);
            align-self: flex-start;
            border-bottom-left-radius: var(--radius-sm);
        }

        .chat-msg time {
            display: block;
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.25rem;
        }

        .chat-input-container {
            padding: var(--gap-md);
            border-top: 1px solid var(--border-color);
        }

        .chat-input-container input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background-color: var(--background);
            color: var(--foreground);
        }

        .chat-input-container input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* === HALAMAN ADMIN === */
        .admin-dashboard-grid,
        .user-dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: var(--gap-lg);
            margin-top: var(--gap-lg);
        }

        .dashboard-card {
            text-align: center;
            padding: var(--gap-lg);
        }

        /* Generic dashboard card */
        .dashboard-card .icon {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: var(--gap-md);
        }

        .dashboard-card .title {
            font-size: 1rem;
            color: hsl(var(--foreground-light), 0.7);
            margin-bottom: var(--gap-sm);
        }

        html.dark .dashboard-card .title {
            color: hsl(var(--foreground-dark), 0.7);
        }

        .dashboard-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: var(--gap-xs);
        }

        .dashboard-card .description {
            font-size: 0.875rem;
        }

        .property-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--gap-lg);
            box-shadow: var(--shadow-sm);
        }

        .property-table th,
        .property-table td {
            border: 1px solid var(--border-color);
            padding: var(--gap-md);
            text-align: left;
            vertical-align: middle;
        }

        .property-table th {
            background-color: var(--card-background);
            font-weight: 600;
        }

        .property-table tr:nth-child(even) {
            background-color: hsl(var(--background-light), 0.02);
        }

        html.dark .property-table tr:nth-child(even) {
            background-color: hsl(var(--background-dark), 0.02);
        }

        .property-table .actions button {
            padding: 0.4rem 0.8rem;
            margin-right: var(--gap-sm);
            font-size: 0.875rem;
        }

        .property-table .actions button:last-child {
            margin-right: 0;
        }

        /* === HALAMAN PROFIL PENGGUNA === */
        .profile-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--gap-xl);
        }

        @media (min-width: 992px) {
            .profile-container {
                grid-template-columns: 300px 1fr;
            }
        }

        .profile-sidebar .avatar-upload {
            text-align: center;
            margin-bottom: var(--gap-lg);
        }

        .profile-sidebar .avatar-upload img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: var(--gap-md);
            border: 4px solid var(--primary-color);
            padding: 4px;
            background-color: var(--background);
            box-shadow: var(--shadow-md);
        }

        .profile-sidebar .avatar-upload input[type="file"] {
            display: none;
        }

        .profile-sidebar .avatar-upload .button {
            display: block;
            width: 100%;
        }

        .profile-info-item {
            margin-bottom: var(--gap-md);
        }

        .profile-info-item strong {
            display: block;
            margin-bottom: var(--gap-xs);
            font-weight: 600;
        }

        .profile-info-item span {
            color: hsl(var(--foreground-light), 0.8);
        }

        html.dark .profile-info-item span {
            color: hsl(var(--foreground-dark), 0.8);
        }

        /* === RESPONSIVE === */
        @media (max-width: 991.98px) {

            /* Di bawah large (Bootstrap lg breakpoint) */
            .nav-links {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 100%;
                left: 0;
                width: 100%;
                background-color: var(--card-background);
                box-shadow: var(--shadow-md);
                padding: var(--gap-md);
                gap: var(--gap-md);
            }

            .nav-links.open {
                display: flex;
            }

            .nav-links a {
                width: 100%;
                text-align: center;
            }

            .mobile-menu-toggle {
                display: block;
            }

            .user-sidebar {
                box-shadow: var(--shadow-lg);
                /* Lebih jelas di mobile */
            }

            /* Jika sidebar terbuka di mobile, konten utama tidak bergeser, sidebar overlay */
            .main-content.sidebar-visible {
                padding-left: 0;
            }

            .sidebar-toggle-btn {
                display: inline-flex;
                /* Tampilkan tombol toggle sidebar di header */
            }

            .site-header .container {
                /* Pastikan tombol sidebar ada di kiri logo mobile */
                /* Penyesuaian mungkin diperlukan tergantung urutan elemen di HTML */
            }
        }

        @media (min-width: 992px) {

            /* Layar besar (lg dan di atasnya) */
            .user-sidebar {
                transform: translateX(0);
                /* Selalu tampil di layar besar */
                /* box-shadow: none; */
                /* Atau tetap pakai shadow */
                /* border-right: 1px solid var(--border-color); */
            }

            .app-wrapper.sidebar-active .main-content {
                /* Konten geser jika sidebar fix */
                padding-left: var(--sidebar-width);
            }

            .sidebar-toggle-btn {
                display: none;
                /* Sembunyikan tombol sidebar di header desktop */
            }
        }

        @media (max-width: 768px) {

            /* Mobile besar dan di bawahnya */
            h1 {
                font-size: 2rem;
            }

            .hero-section h1 {
                font-size: 2.5rem;
            }

            .hero-section p {
                font-size: 1.125rem;
            }

            .property-grid {
                grid-template-columns: 1fr;
            }

            .footer-grid {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .footer-column .social-links {
                justify-content: center;
            }

            .chat-window {
                width: 90vw;
                max-height: 70vh;
            }

            .about-content,
            .contact-form-container {
                grid-template-columns: 1fr;
            }

            .about-image,
            .contact-info {
                text-align: left;
            }
        }

        @media (min-width: 768px) {

            /* Tablet dan di atasnya */
            .about-content,
            .contact-form-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }


        /* Efek page transition */
        #app-root>* {
            animation: fadeIn 0.5s var(--transition-timing);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Overlay untuk sidebar di mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 998;
            /* Di bawah sidebar, di atas konten */
            transition: opacity var(--transition-duration) var(--transition-timing);
        }

        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }
    </style>
</head>

<body>
    <!-- Sidebar Pengguna (Awalnya Tersembunyi) -->
    <aside class="user-sidebar" id="userSidebar" aria-hidden="true">
        <div class="sidebar-header">
            <img id="sidebarUserAvatar" src="https://via.placeholder.com/100?text=U" alt="Avatar Pengguna">
            <h4 id="sidebarUserName">Nama Pengguna</h4>
            <p id="sidebarUserEmail">email@pengguna.com</p>
        </div>
        <nav class="sidebar-nav" id="userSidebarNav">
            <a href="/dashboard-pengguna" data-route="/dashboard-pengguna"><i class="fas fa-tachometer-alt fa-fw"></i>
                Dasbor</a>
            <a href="/profil" data-route="/profil"><i class="fas fa-user-circle fa-fw"></i> Profil Saya</a>
            <a href="/properti" data-route="/properti"><i class="fas fa-building fa-fw"></i> Cari Apartemen</a>
            <a href="/booking-saya" data-route="/booking-saya"><i class="fas fa-calendar-check fa-fw"></i> Booking
                Saya</a>
            <a href="/favorit-saya" data-route="/favorit-saya"><i class="fas fa-heart fa-fw"></i> Properti Favorit</a>
            <a href="/pembayaran-saya" data-route="/pembayaran-saya"><i class="fas fa-credit-card fa-fw"></i> Riwayat
                Pembayaran</a>
            <a href="/maintenance-saya" data-route="/maintenance-saya"><i class="fas fa-tools fa-fw"></i> Permintaan
                Maintenance</a>
            <a href="/pesan-saya" data-route="/pesan-saya"><i class="fas fa-envelope fa-fw"></i> Pesan Saya</a>
            <a href="#" id="userLogoutSidebarButton" class="mt-3" style="color: hsl(0, 60%, 60%);"><i
                    class="fas fa-sign-out-alt fa-fw"></i> Logout</a>
        </nav>
    </aside>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>


    <div class="app-wrapper" id="appWrapper">
        <!-- Header & Navigation -->
        <header class="site-header">
            <div class="container">
                <div class="d-flex align-items-center">
                    <button class="sidebar-toggle-btn" id="sidebarToggleBtnHeader" aria-label="Buka Sidebar Pengguna"
                        aria-expanded="false">
                        <i class="fas fa-bars"></i>
                    </button>
                    <a href="/" class="logo" data-route="/" style="margin-left: var(--gap-sm);">Green Valley</a>
                </div>
                <nav class="main-navigation">
                    <div class="nav-links" id="mainNavLinks">
                        <a href="/" data-route="/">Beranda</a>
                        <a href="/properti" data-route="/properti">Properti</a>
                        <a href="/virtual-tour" data-route="/virtual-tour">Virtual Tour</a>
                        <a href="/tentang" data-route="/tentang">Tentang Kami</a>
                        <a href="/kontak" data-route="/kontak">Kontak</a>
                        <a href="/admin" data-route="/admin" class="nav-admin-link" style="display: none;">Admin</a>
                    </div>
                </nav>
                <div class="header-actions d-flex align-items-center gap-md">
                    <button class="theme-toggle" id="themeToggle" aria-label="Ganti tema">
                        <i class="fas fa-moon"></i>
                    </button>

                    <!-- User Profile / Login Button -->
                    <div id="userAuthContainer">
                        <!-- Akan diisi oleh JS: Tombol Login/Register atau Dropdown Profil Pengguna -->
                    </div>

                    <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Buka menu navigasi utama"
                        aria-expanded="false">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Konten Utama Aplikasi (SPA Root) -->
        <main id="app-root" class="main-content">
            <!-- Konten halaman akan dimuat di sini oleh JavaScript -->
        </main>

        <!-- Footer -->
        <footer class="site-footer">
            <div class="container">
                <div class="footer-grid">
                    <div class="footer-column">
                        <h3>Green Valley</h3>
                        <p>Platform sewa apartemen premium dengan fitur virtual tour dan sistem pembayaran yang aman dan
                            terpercaya untuk pengalaman penyewaan terbaik Anda.</p>
                    </div>
                    <div class="footer-column">
                        <h3>Tautan Cepat</h3>
                        <ul>
                            <li><a href="/" data-route="/">Beranda</a></li>
                            <li><a href="/properti" data-route="/properti">Semua Properti</a></li>
                            <li><a href="/pembayaran" data-route="/pembayaran">Metode Pembayaran</a></li>
                            <li><a href="/ulasan" data-route="/ulasan">Ulasan Pengguna</a></li>
                            <li><a href="/admin" data-route="/admin" class="nav-admin-link"
                                    style="display: none;">Dasbor Admin</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Hubungi Kami</h3>
                        <ul>
                            <li><i class="fas fa-map-marker-alt"></i> Jl. Apartemen Indah No. 1, Jakarta</li>
                            <li><i class="fas fa-phone"></i> +62 21 555 0123</li>
                            <li><i class="fas fa-envelope"></i> support@Green Valley.com</li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Ikuti Kami</h3>
                        <div class="social-links">
                            <a href="#" aria-label="Facebook Green Valley"><i class="fab fa-facebook-f"></i></a>
                            <a href="#" aria-label="Twitter Green Valley"><i class="fab fa-twitter"></i></a>
                            <a href="#" aria-label="Instagram Green Valley"><i class="fab fa-instagram"></i></a>
                            <a href="#" aria-label="LinkedIn Green Valley"><i class="fab fa-linkedin-in"></i></a>
                        </div>
                    </div>
                </div>
                <div class="copyright">
                    <p>&copy; <span id="currentYear"></span> Green Valley. Semua Hak Cipta Dilindungi.</p>
                </div>
            </div>
        </footer>
    </div> <!-- .app-wrapper -->


    <!-- Chat Widget -->
    <div class="chat-container">
        <button class="chat-toggle-button" id="chatToggleButton" aria-label="Buka chat">
            <i class="fas fa-comments"></i>
        </button>
        <div class="chat-window" id="chatWindow">
            <div class="chat-header">
                <span>Chat dengan Dukungan</span>
                <button class="close-chat" id="closeChatButton" aria-label="Tutup chat"><i
                        class="fas fa-times"></i></button>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-container">
                <input type="text" id="chatInput" class="chat-input" placeholder="Ketik pesan Anda..."
                    aria-label="Input pesan chat">
            </div>
        </div>
    </div>

    <script>
        //<![CDATA[
        /**
         * Green Valley - PLATFORM SEWA APARTEMEN PREMIUM
         * Versi: 1.1.0
         * Penulis: AI Assistant (dengan supervisi & pengembangan)
         * Deskripsi: Aplikasi SPA Monolith Vanilla JavaScript untuk platform penyewaan apartemen
         *            dengan fitur pengguna terautentikasi dan area admin.
         */

        // === STATE APLIKASI GLOBAL ===
        const appState = {
            currentTheme: localStorage.getItem('theme') || 'light',
            chat: { isOpen: false, messages: [] },
            reviews: JSON.parse(localStorage.getItem('reviewsGreen Valley')) || [],
            currentRating: 0,
            properties: JSON.parse(localStorage.getItem('propertiesGreen Valley')) || [
                { id: 1, name: 'Apartemen Mewah Sudirman', price: '15.000.000', location: 'Sudirman, Jakarta Pusat', image: 'https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=60', beds: 2, baths: 2, area: 85, description: 'Apartemen mewah dengan pemandangan kota, fasilitas lengkap, dan akses mudah ke pusat bisnis.', virtualTourLink: 'https://www.example.com/tour/sudirman' },
                { id: 2, name: 'Apartemen Exclusive Kemang', price: '12.500.000', location: 'Kemang, Jakarta Selatan', image: 'https://images.unsplash.com/photo-1493809842364-78817add7ffb?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=60', beds: 3, baths: 2, area: 100, description: 'Apartemen exclusive di area premium dengan fasilitas kolam renang, gym, dan keamanan 24 jam.', virtualTourLink: 'https://www.example.com/tour/kemang' },
                { id: 3, name: 'Apartemen Modern Kuningan', price: '10.000.000', location: 'Kuningan, Jakarta Selatan', image: 'https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=60', beds: 2, baths: 1, area: 75, description: 'Apartemen modern dengan desain minimalis, lokasi strategis, dan akses mudah ke mall dan perkantoran.', virtualTourLink: 'https://www.example.com/tour/kuningan' },
                { id: 4, name: 'Studio Nyaman di Pusat Kota', price: '7.000.000', location: 'Thamrin, Jakarta Pusat', image: 'https://images.unsplash.com/photo-1512917774080-9991f1c4c750?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=60', beds: 1, baths: 1, area: 45, description: 'Studio apartemen yang nyaman dan fully-furnished, cocok untuk profesional muda.', virtualTourLink: 'https://www.example.com/tour/thamrin' }
            ],
            isAdmin: JSON.parse(localStorage.getItem('isAdminGreen Valley')) || false,
            isUserLoggedIn: JSON.parse(localStorage.getItem('isUserLoggedInGreen Valley')) || false,
            currentUser: JSON.parse(localStorage.getItem('currentUserGreen Valley')) || {
                name: 'Pengguna Tamu',
                email: 'tamu@example.com',
                photo: 'https://via.placeholder.com/150/777777/FFFFFF?Text=User',
                bookings: [
                    { id: 'B001', propertyName: 'Apartemen Mewah Sudirman', date: '2024-08-01', status: 'Aktif' }
                ],
                favorites: [1, 3], // Array of property IDs
                maintenanceRequests: [
                    { id: 'M001', propertyName: 'Apartemen Mewah Sudirman', request: 'Keran bocor', date: '2024-07-15', status: 'Selesai' }
                ],
                paymentHistory: [
                    { id: 'P001', propertyName: 'Apartemen Mewah Sudirman', amount: '15.000.000', date: '2024-07-01', method: 'Kartu Kredit' }
                ],
                messages: [
                    { id: 'MSG001', sender: 'Sistem', subject: 'Selamat Datang!', content: 'Selamat datang di Green Valley!', date: new Date().toISOString(), read: false }
                ]
            },
            isSidebarOpen: false,
        };

        // === UTILITIES ===
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        function sanitizeHTML(str) {
            if (str === null || typeof str === 'undefined') return '';
            const temp = document.createElement('div');
            temp.textContent = String(str);
            return temp.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function formatCurrency(amount) {
            if (typeof amount === 'string') amount = parseFloat(amount.replace(/\./g, ''));
            if (isNaN(amount)) return 'N/A';
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
        }


        // === SISTEM TEMA ===
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            document.documentElement.classList.toggle('dark', theme === 'dark');
            const themeIcon = $('#themeToggle i');
            if (themeIcon) {
                themeIcon.classList.toggle('fa-moon', theme === 'light');
                themeIcon.classList.toggle('fa-sun', theme === 'dark');
            }
            appState.currentTheme = theme;
            localStorage.setItem('theme', theme);
        }
        function toggleTheme() {
            const newTheme = appState.currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
        }

        // === NAVIGASI MOBILE (TOPNAV) ===
        function toggleMobileMenu() {
            const navLinks = $('#mainNavLinks');
            const menuToggle = $('#mobileMenuToggle');
            if (!navLinks || !menuToggle) return;
            navLinks.classList.toggle('open');
            const isOpen = navLinks.classList.contains('open');
            menuToggle.setAttribute('aria-expanded', isOpen.toString());
            menuToggle.querySelector('i').classList.toggle('fa-bars', !isOpen);
            menuToggle.querySelector('i').classList.toggle('fa-times', isOpen);
        }

        // === SIDEBAR PENGGUNA ===
        const userSidebar = $('#userSidebar');
        const sidebarToggleBtnHeader = $('#sidebarToggleBtnHeader');
        const appWrapper = $('#appWrapper');
        const mainContent = $('#app-root');
        const sidebarOverlay = $('#sidebarOverlay');

        function toggleUserSidebar(forceOpen = null) {
            if (!userSidebar) return;
            const shouldBeOpen = forceOpen !== null ? forceOpen : !appState.isSidebarOpen;

            appState.isSidebarOpen = shouldBeOpen;
            userSidebar.classList.toggle('open', shouldBeOpen);
            userSidebar.setAttribute('aria-hidden', !shouldBeOpen);

            if (sidebarToggleBtnHeader) {
                sidebarToggleBtnHeader.setAttribute('aria-expanded', shouldBeOpen);
                sidebarToggleBtnHeader.querySelector('i').classList.toggle('fa-bars', !shouldBeOpen);
                sidebarToggleBtnHeader.querySelector('i').classList.toggle('fa-times', shouldBeOpen);
            }

            if (window.innerWidth < 992) { // Mobile view: sidebar as overlay
                if (sidebarOverlay) sidebarOverlay.classList.toggle('active', shouldBeOpen);
                if (mainContent) mainContent.classList.remove('sidebar-visible'); // Pastikan tidak ada padding
                if (appWrapper) appWrapper.classList.remove('sidebar-active');
            } else { // Desktop view: sidebar pushes content
                if (mainContent) mainContent.classList.toggle('sidebar-visible', shouldBeOpen && appState.isUserLoggedIn);
                if (appWrapper) appWrapper.classList.toggle('sidebar-active', shouldBeOpen && appState.isUserLoggedIn);
                if (sidebarOverlay) sidebarOverlay.classList.remove('active');
            }
        }

        function closeSidebarOnClickOutside(event) {
            if (appState.isSidebarOpen && userSidebar && !userSidebar.contains(event.target) && sidebarToggleBtnHeader && !sidebarToggleBtnHeader.contains(event.target)) {
                if (window.innerWidth < 992) { // Hanya tutup otomatis di mobile
                    toggleUserSidebar(false);
                }
            }
        }


        // === ROUTER SPA ===
        const appRoot = $('#app-root');
        const routes = {
            '/': renderBerandaPage,
            '/properti': renderPropertiPage,
            '/properti/:id': renderDetailPropertiPage,
            '/virtual-tour': renderVirtualTourPage,
            '/pembayaran': renderPembayaranPage, // Halaman pembayaran umum
            '/ulasan': renderUlasanPage,
            '/tentang': renderTentangPage,
            '/kontak': renderKontakPage,
            '/login': renderLoginPage,
            '/register': renderRegisterPage,
            // Rute Admin
            '/admin': renderAdminLoginPage,
            '/admin/dashboard': renderAdminDashboardPage,
            '/admin/properti': renderAdminPropertiPage,
            '/admin/properti/tambah': renderAdminTambahPropertiPage,
            '/admin/properti/edit/:id': renderAdminEditPropertiPage,
            // Rute Pengguna Terautentikasi
            '/dashboard-pengguna': renderUserDashboardPage,
            '/profil': renderUserProfilePage,
            '/booking-saya': renderUserBookingsPage,
            '/favorit-saya': renderUserFavoritesPage,
            '/pembayaran-saya': renderUserPaymentHistoryPage, // Riwayat pembayaran pengguna
            '/maintenance-saya': renderUserMaintenancePage,
            '/pesan-saya': renderUserMessagesPage,
            '/404': renderNotFoundPage
        };

        function matchRoute(path) {
            if (routes[path]) return { handler: routes[path], params: {} };
            for (const routePattern in routes) {
                const paramNames = [];
                const regexPattern = new RegExp('^' + routePattern.replace(/:(\w+)/g, (match, paramName) => {
                    paramNames.push(paramName);
                    return '([^\\/]+)';
                }) + '$');
                const matchResult = path.match(regexPattern);
                if (matchResult) {
                    const params = {};
                    paramNames.forEach((name, index) => { params[name] = matchResult[index + 1]; });
                    return { handler: routes[routePattern], params: params };
                }
            }
            return { handler: routes['/404'], params: {} };
        }

        function navigateTo(path, pushState = true) {
            // Proteksi rute admin dan pengguna
            const isAdminRoute = path.startsWith('/admin/') && path !== '/admin';
            const isUserRoute = ['/dashboard-pengguna', '/profil', '/booking-saya', '/favorit-saya', '/pembayaran-saya', '/maintenance-saya', '/pesan-saya'].includes(path);

            if (isAdminRoute && !appState.isAdmin) { path = '/admin'; } // Redirect ke login admin
            if (isUserRoute && !appState.isUserLoggedIn) { path = '/login'; } // Redirect ke login pengguna
            if ((path === '/login' || path === '/register') && appState.isUserLoggedIn) { path = '/dashboard-pengguna'; } // Jika sudah login, ke dashboard

            if (pushState) window.history.pushState({ path }, '', path);

            const { handler, params } = matchRoute(path);
            appRoot.innerHTML = handler(params);
            window.scrollTo(0, 0);
            updateActiveNavLink(path);
            updateUserAuthUI(); // Update UI terkait autentikasi (header, sidebar)
            initializePageScripts(path, params);

            if ($('#mainNavLinks')?.classList.contains('open')) toggleMobileMenu();
            if (appState.isSidebarOpen && window.innerWidth < 992) toggleUserSidebar(false); // Tutup sidebar mobile saat navigasi
        }

        function updateActiveNavLink(currentPath) {
            $$('.nav-links a, .sidebar-nav a').forEach(link => {
                link.classList.remove('active');
                const linkPath = link.getAttribute('href');
                if (linkPath === currentPath || (linkPath !== '/' && currentPath.startsWith(linkPath) && linkPath.length > 1)) {
                    // Khusus untuk /properti, jangan aktif jika pathnya /properti/:id pada nav utama
                    if (link.closest('.nav-links') && linkPath === '/properti' && currentPath.startsWith('/properti/') && currentPath.split('/').length > 2 && !isNaN(parseInt(currentPath.split('/')[2]))) {
                        // Ini detail properti, jangan aktifkan /properti di topnav
                    } else {
                        link.classList.add('active');
                    }
                }
            });
            // Jika path /properti/:id, aktifkan /properti di topnav dan sidebar
            if (currentPath.startsWith('/properti/') && currentPath.split('/').length > 2 && !isNaN(parseInt(currentPath.split('/')[2]))) {
                const propertiLinkTopNav = $('.nav-links a[data-route="/properti"]');
                if (propertiLinkTopNav) propertiLinkTopNav.classList.add('active');
                const propertiLinkSidebar = $('.sidebar-nav a[data-route="/properti"]');
                if (propertiLinkSidebar) propertiLinkSidebar.classList.add('active');
            }
        }

        // === TEMPLATE HALAMAN ===

        function renderPropertyCard(property, options = { showAdminActions: false, showUserActions: false }) {
            const isFavorite = appState.isUserLoggedIn && appState.currentUser.favorites.includes(property.id);
            return `
            <article class="card property-card">
                <div class="property-image" style="background-image: url('${sanitizeHTML(property.image)}');" role="img" aria-label="Gambar ${sanitizeHTML(property.name)}"></div>
                <div class="property-details">
                    <h3>${sanitizeHTML(property.name)}</h3>
                    <div class="property-price">${formatCurrency(property.price)}/bulan</div>
                    <div class="property-location"><i class="fas fa-map-marker-alt"></i> ${sanitizeHTML(property.location)}</div>
                    <p>${sanitizeHTML(property.description.substring(0, 100))}${property.description.length > 100 ? '...' : ''}</p>
                    <div class="property-features">
                        <span><i class="fas fa-bed"></i> ${property.beds} KT</span>
                        <span><i class="fas fa-bath"></i> ${property.baths} KM</span>
                        <span><i class="fas fa-ruler-combined"></i> ${property.area}m</span>
                    </div>
                    <div class="d-flex align-items-center" style="gap: var(--gap-sm); flex-wrap: wrap;">
                        <button class="button button-sm" onclick="navigateTo('/properti/${property.id}')">
                            <i class="fas fa-eye"></i> Detail
                        </button>
                        ${property.virtualTourLink ? `<a href="${sanitizeHTML(property.virtualTourLink)}" target="_blank" class="button button-sm button-outline">
                            <i class="fas fa-vr-cardboard"></i> Tour
                        </a>` : ''}
                        ${options.showUserActions && appState.isUserLoggedIn ? `
                            <button class="button button-sm button-outline favorite-btn ${isFavorite ? 'active' : ''}" onclick="toggleFavorite(${property.id}, this)" aria-label="${isFavorite ? 'Hapus dari favorit' : 'Tambah ke favorit'}">
                                <i class="fas fa-heart"></i>
                            </button>
                        ` : ''}
                    </div>
                    ${options.showAdminActions ? `
                    <div class="mt-2 d-flex" style="gap: var(--gap-sm);">
                        <button class="button button-sm button-outline" onclick="navigateTo('/admin/properti/edit/${property.id}')"><i class="fas fa-edit"></i> Edit</button>
                        <button class="button button-sm button-danger" onclick="deleteProperty(${property.id})"><i class="fas fa-trash"></i> Hapus</button>
                    </div>
                    ` : ''}
                </div>
            </article>
        `;
        }

        function renderBerandaPage() {
            const featuredProperties = appState.properties.slice(0, 3);
            return `
            <section class="hero-section" id="beranda">
                <div class="container">
                    <h1>Temukan Apartemen Premium Impian Anda</h1>
                    <p>Platform sewa apartemen premium dengan fitur virtual tour dan sistem pembayaran yang aman dan terpercaya.</p>
                    <button class="button" onclick="navigateTo('/properti')"><i class="fas fa-search"></i> Cari Apartemen</button>
                </div>
            </section>
            <section class="featured-properties container" id="properti-unggulan">
                <div class="section-title">
                    <h2>Properti Unggulan Kami</h2>
                    <p>Pilihan apartemen premium terbaik yang siap huni untuk Anda.</p>
                </div>
                <div class="property-grid">
                    ${featuredProperties.map(prop => renderPropertyCard(prop, { showUserActions: true })).join('')}
                </div>
                 <div class="text-center mt-3">
                    <button class="button button-outline" onclick="navigateTo('/properti')">
                        Lihat Semua Properti <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </section>
            <section class="container" id="fitur-utama">
                <div class="section-title"><h2>Mengapa Memilih Green Valley?</h2><p>Kami menawarkan pengalaman terbaik.</p></div>
                <div class="property-grid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));">
                     <div class="card text-center"><i class="fas fa-vr-cardboard fa-3x mb-2" style="color:var(--primary-color);"></i><h4>Virtual Tour Imersif</h4><p>Jelajahi apartemen dari rumah Anda.</p></div>
                    <div class="card text-center"><i class="fas fa-shield-alt fa-3x mb-2" style="color:var(--primary-color);"></i><h4>Transaksi Aman</h4><p>Sistem pembayaran terverifikasi.</p></div>
                    <div class="card text-center"><i class="fas fa-headset fa-3x mb-2" style="color:var(--primary-color);"></i><h4>Dukungan Responsif</h4><p>Tim kami siap membantu Anda.</p></div>
                </div>
            </section>
            <section class="container" id="ajakan-bertindak">
                <div class="card" style="background-color: var(--primary-color); color: white; text-align: center;">
                    <h2>Siap Menemukan Hunian Ideal Anda?</h2>
                    <p style="opacity: 0.9;">Ribuan pilihan apartemen premium menanti. Mulai pencarian Anda!</p>
                    <button class="button" style="background-color: white; color: var(--primary-color);" onclick="navigateTo('/properti')"><i class="fas fa-building"></i> Jelajahi Properti</button>
                </div>
            </section>
        `;
        }

        function renderPropertiPage() {
            return `
            <section class="all-properties container" id="properti">
                <div class="section-title"><h2>Semua Properti</h2><p>Temukan apartemen yang sesuai.</p></div>
                <div class="filter-bar card mb-3 p-2">
                    <div class="d-flex" style="gap: var(--gap-md); flex-wrap: wrap;">
                        <input type="text" id="searchProperty" placeholder="Cari nama atau lokasi..." class="input-group" style="flex-grow: 1; margin-bottom:0;">
                        <select id="sortProperty" class="input-group" style="margin-bottom:0;">
                            <option value="default">Urutkan (Default)</option>
                            <option value="price_asc">Harga Terendah</option><option value="price_desc">Harga Tertinggi</option>
                            <option value="name_asc">Nama A-Z</option>
                        </select>
                    </div>
                </div>
                <div class="property-grid" id="propertyListing">
                    ${appState.properties.length > 0 ? appState.properties.map(prop => renderPropertyCard(prop, { showUserActions: true })).join('') : '<p class="text-center" style="grid-column: 1 / -1;">Tidak ada properti.</p>'}
                </div>
            </section>
        `;
        }

        function renderDetailPropertiPage(params) {
            const propertyId = parseInt(params.id);
            const property = appState.properties.find(p => p.id === propertyId);
            if (!property) return renderNotFoundPage({ message: 'Properti tidak ditemukan.' });
            const isFavorite = appState.isUserLoggedIn && appState.currentUser.favorites.includes(property.id);

            return `
            <section class="property-detail-section container">
                <div class="card">
                    <div class="d-flex flex-column" style="gap: var(--gap-lg); @media (min-width: 992px) { flex-direction: row; }">
                        <div style="flex: 1.5;">
                             <img src="${sanitizeHTML(property.image)}" alt="Gambar ${sanitizeHTML(property.name)}" style="width:100%; border-radius: var(--radius-md); aspect-ratio: 16/9; object-fit: cover;">
                        </div>
                        <div style="flex: 1;">
                            <h1>${sanitizeHTML(property.name)}</h1>
                            <div class="property-price" style="font-size: 1.75rem;">${formatCurrency(property.price)}/bulan</div>
                            <div class="property-location mb-2"><i class="fas fa-map-marker-alt"></i> ${sanitizeHTML(property.location)}</div>
                            <div class="property-features mb-2" style="font-size: 1rem;">
                                <span><i class="fas fa-bed"></i> ${property.beds} KT</span>
                                <span><i class="fas fa-bath"></i> ${property.baths} KM</span>
                                <span><i class="fas fa-ruler-combined"></i> ${property.area}m</span>
                            </div>
                            <p>${sanitizeHTML(property.description)}</p>
                            <div class="d-flex flex-column" style="gap: var(--gap-sm);">
                                ${property.virtualTourLink ? `<a href="${sanitizeHTML(property.virtualTourLink)}" target="_blank" class="button">
                                    <i class="fas fa-vr-cardboard"></i> Buka Virtual Tour
                                </a>` : ''}
                                <button class="button button-outline" onclick="initiateChatWithAgent('${property.name}')">
                                    <i class="fas fa-comments"></i> Hubungi Agen
                                </button>
                                ${appState.isUserLoggedIn ? `
                                <button class="button button-outline favorite-btn ${isFavorite ? 'active' : ''}" onclick="toggleFavorite(${property.id}, this, true)">
                                    <i class="fas fa-heart"></i> ${isFavorite ? 'Hapus dari Favorit' : 'Tambah ke Favorit'}
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-3 card">
                    <h3 class="card-title">Ulasan Properti Ini</h3>
                    <p>Fitur ulasan per properti akan segera hadir. Untuk saat ini, lihat <a href="/ulasan" data-route="/ulasan">ulasan umum platform</a>.</p>
                </div>
            </section>
        `;
        }


        function renderVirtualTourPage() {
            const randomProperty = appState.properties.length > 0 ? appState.properties[Math.floor(Math.random() * appState.properties.length)] : null;
            const tourImage = randomProperty ? randomProperty.image : 'https://images.unsplash.com/photo-1580587771525-78b9dba3b914?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1200&q=80';
            const tourName = randomProperty ? `Interior ${randomProperty.name}` : 'Interior Apartemen Contoh';
            return `
            <section class="container" id="virtual-tour">
                <div class="section-title"><h2>Virtual Tour</h2><p>Jelajahi apartemen impian Anda secara virtual.</p></div>
                <div class="virtual-tour-placeholder card">
                    <img src="${tourImage}" alt="${tourName}" style="width: 100%; height: auto;">
                    <div class="tour-controls">
                        <button class="button" onclick="alert('Memulai Virtual Tour untuk ${sanitizeHTML(tourName)}... (Fitur ini adalah placeholder)')">
                            <i class="fas fa-play"></i> Mulai Tour
                        </button>
                    </div>
                </div>
                <p class="text-center mt-2">Pilih properti dari <a href="/properti" data-route="/properti">halaman properti</a> kami untuk Virtual Tour spesifik.</p>
            </section>`;
        }

        function renderPembayaranPage() {
            return `
            <section class="container" id="pembayaran">
                <div class="section-title"><h2>Sistem Pembayaran</h2><p>Pilih metode pembayaran yang nyaman.</p></div>
                <div class="payment-methods">
                    <div class="payment-card" data-method="credit-card"><i class="fas fa-credit-card"></i><h3>Kartu Kredit/Debit</h3></div>
                    <div class="payment-card" data-method="bank-transfer"><i class="fas fa-university"></i><h3>Transfer Bank</h3></div>
                    <div class="payment-card" data-method="ewallet"><i class="fas fa-wallet"></i><h3>E-Wallet</h3></div>
                </div>
                <div id="paymentDetailsContainer" class="card" style="display:none;">
                    <h4 id="selectedPaymentMethodTitle" class="card-title"></h4>
                    <form id="paymentForm"><div id="paymentFields"></div>
                        <button type="submit" class="button mt-2">Proses Pembayaran</button>
                    </form>
                </div>
                <p class="text-center mt-3">Jika Anda sudah login, riwayat pembayaran dapat dilihat di <a href="/pembayaran-saya" data-route="/pembayaran-saya">halaman riwayat pembayaran Anda</a>.</p>
            </section>`;
        }

        function renderUlasanPage() {
            return `
            <section class="container" id="ulasan">
                <div class="section-title"><h2>Ulasan Pengguna</h2><p>Apa kata mereka tentang Green Valley.</p></div>
                <div class="review-form card">
                    <h3>Berikan Ulasan Anda</h3>
                    <div class="rating-stars" id="ratingStarsContainer">
                        ${[1, 2, 3, 4, 5].map(v => `<span data-value="${v}" aria-label="Beri ${v} bintang"></span>`).join('')}
                    </div>
                    <div class="input-group"><label for="reviewName">Nama Anda</label><input type="text" id="reviewName" placeholder="Nama Anda" required></div>
                    <div class="input-group"><label for="reviewInput">Ulasan Anda</label><textarea id="reviewInput" placeholder="Tulis ulasan Anda..." rows="4" required></textarea></div>
                    <button class="button" id="submitReviewButton">Kirim Ulasan</button>
                </div>
                <div id="reviewsListContainer" class="mt-3"></div>
            </section>`;
        }
        function renderReviewCard(review) {
            return `
            <article class="card review-card">
                <div class="rating">${''.repeat(review.rating)}${''.repeat(5 - review.rating)}</div>
                <h4>${sanitizeHTML(review.name || 'Pengguna Anonim')}</h4>
                <p>"${sanitizeHTML(review.text)}"</p>
                <time>${formatDate(review.date)}</time>
            </article>`;
        }

        function renderTentangPage() {
            return `
            <section class="container" id="tentang">
                <div class="section-title"><h2>Tentang Green Valley</h2><p>Kenali lebih dekat platform kami.</p></div>
                <div class="about-content card">
                    <div class="about-text">
                        <h3>Misi Kami</h3><p>Green Valley berdedikasi merevolusi cara Anda mencari dan menyewa apartemen premium. Pengalaman mudah, transparan, dan menyenangkan.</p>
                        <h3>Visi Kami</h3><p>Menjadi platform penyewaan apartemen nomor satu di Indonesia, dikenal karena inovasi, keandalan, dan kepuasan pelanggan.</p>
                        <h3>Nilai-Nilai Kami</h3>
                        <ul>
                            <li><i class="fas fa-check-circle" style="color:var(--primary-color); margin-right: var(--gap-sm);"></i><strong>Integritas:</strong> Jujur dan transparan.</li>
                            <li><i class="fas fa-lightbulb" style="color:var(--primary-color); margin-right: var(--gap-sm);"></i><strong>Inovasi:</strong> Terus mengembangkan fitur.</li>
                            <li><i class="fas fa-users" style="color:var(--primary-color); margin-right: var(--gap-sm);"></i><strong>Fokus Pelanggan:</strong> Kepuasan Anda prioritas.</li>
                        </ul>
                    </div>
                    <div class="about-image mt-3 mt-md-0">
                        <img src="https://images.unsplash.com/photo-1542744173-8e7e53415bb0?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=60" alt="Tim Green Valley" style="border-radius: var(--radius-md); box-shadow: var(--shadow-md);">
                    </div>
                </div>
            </section>`;
        }

        function renderKontakPage() {
            return `
            <section class="container" id="kontak">
                <div class="section-title"><h2>Hubungi Kami</h2><p>Ada pertanyaan? Jangan ragu menghubungi kami.</p></div>
                <div class="contact-form-container card">
                    <div class="contact-info">
                        <h3>Informasi Kontak</h3>
                        <p><i class="fas fa-map-marker-alt fa-fw"></i> Jl. Apartemen Indah No. 1, Jakarta</p>
                        <p><i class="fas fa-phone fa-fw"></i> +62 21 555 0123</p>
                        <p><i class="fab fa-whatsapp fa-fw"></i> +62 812 3456 7890</p>
                        <p><i class="fas fa-envelope fa-fw"></i> support@Green Valley.com</p>
                        <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d15866.66699698056!2d106.82041334900961!3d-6.17539239551139!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x2e69f5d2e764b12d%3A0x3d2ad6e1e0e9bcc8!2sNational%20Monument!5e0!3m2!1sen!2sid!4v1678888888888!5m2!1sen!2sid" width="100%" height="250" style="border:0; border-radius: var(--radius-md); margin-top: var(--gap-md);" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade" title="Peta Lokasi Green Valley"></iframe>
                    </div>
                    <form id="contactForm">
                        <h3>Kirim Pesan Langsung</h3>
                        <div class="input-group"><label for="contactName">Nama</label><input type="text" id="contactName" name="name" required></div>
                        <div class="input-group"><label for="contactEmail">Email</label><input type="email" id="contactEmail" name="email" required></div>
                        <div class="input-group"><label for="contactSubject">Subjek</label><input type="text" id="contactSubject" name="subject" required></div>
                        <div class="input-group"><label for="contactMessage">Pesan</label><textarea id="contactMessage" name="message" rows="5" required></textarea></div>
                        <button type="submit" class="button">Kirim <i class="fas fa-paper-plane"></i></button>
                    </form>
                </div>
            </section>`;
        }

        function renderLoginPage() {
            return `
            <section class="container text-center" style="max-width: 450px;">
                <div class="card p-3">
                    <h2 class="card-title">Login Pengguna</h2>
                    <form id="userLoginForm">
                        <div class="input-group">
                            <label for="userEmail">Email</label>
                            <input type="email" id="userEmail" value="user@example.com" required>
                        </div>
                        <div class="input-group">
                            <label for="userPassword">Password</label>
                            <input type="password" id="userPassword" value="password" required>
                        </div>
                        <button type="submit" class="button" style="width: 100%;">Login</button>
                    </form>
                    <p class="mt-2">Belum punya akun? <a href="/register" data-route="/register">Daftar di sini</a>.</p>
                    <p class="mt-1" style="font-size: 0.8rem;">(Gunakan email: <strong>user@example.com</strong>, password: <strong>password</strong> untuk demo)</p>
                </div>
            </section>`;
        }

        function renderRegisterPage() {
            return `
            <section class="container text-center" style="max-width: 450px;">
                <div class="card p-3">
                    <h2 class="card-title">Daftar Akun Baru</h2>
                    <form id="userRegisterForm">
                        <div class="input-group">
                            <label for="registerName">Nama Lengkap</label>
                            <input type="text" id="registerName" required>
                        </div>
                        <div class="input-group">
                            <label for="registerEmail">Email</label>
                            <input type="email" id="registerEmail" required>
                        </div>
                        <div class="input-group">
                            <label for="registerPassword">Password</label>
                            <input type="password" id="registerPassword" required>
                        </div>
                         <div class="input-group">
                            <label for="registerConfirmPassword">Konfirmasi Password</label>
                            <input type="password" id="registerConfirmPassword" required>
                        </div>
                        <button type="submit" class="button" style="width: 100%;">Daftar</button>
                    </form>
                    <p class="mt-2">Sudah punya akun? <a href="/login" data-route="/login">Login di sini</a>.</p>
                </div>
            </section>`;
        }

        // Halaman Pengguna Terautentikasi
        function renderUserDashboardPage() {
            if (!appState.isUserLoggedIn) { navigateTo('/login'); return ''; }
            const currentUser = appState.currentUser;
            const activeBookings = currentUser.bookings.filter(b => b.status === 'Aktif').length;
            const pendingPayments = 0; // Dummy
            const maintenanceRequests = currentUser.maintenanceRequests.filter(r => r.status === 'Dalam Proses').length;
            const savedProperties = currentUser.favorites.length;

            return `
            <section class="container" id="user-dashboard">
                <h2 class="mb-1">Dasbor Pengguna</h2>
                <p class="mb-3">Selamat datang kembali, ${sanitizeHTML(currentUser.name)}!</p>
                <div class="user-dashboard-grid">
                    <div class="card dashboard-card">
                        <i class="fas fa-calendar-check icon"></i>
                        <div class="value">${activeBookings}</div>
                        <div class="title">Booking Aktif</div>
                        <a href="/booking-saya" data-route="/booking-saya" class="button button-sm button-outline mt-1">Lihat Detail</a>
                    </div>
                    <div class="card dashboard-card">
                        <i class="fas fa-wallet icon"></i>
                        <div class="value">${pendingPayments}</div>
                        <div class="title">Pembayaran Tertunda</div>
                        <a href="/pembayaran-saya" data-route="/pembayaran-saya" class="button button-sm button-outline mt-1">Lihat Detail</a>
                    </div>
                    <div class="card dashboard-card">
                        <i class="fas fa-tools icon"></i>
                        <div class="value">${maintenanceRequests}</div>
                        <div class="title">Permintaan Maintenance</div>
                        <a href="/maintenance-saya" data-route="/maintenance-saya" class="button button-sm button-outline mt-1">Lihat Detail</a>
                    </div>
                    <div class="card dashboard-card">
                        <i class="fas fa-heart icon"></i>
                        <div class="value">${savedProperties}</div>
                        <div class="title">Properti Disimpan</div>
                        <a href="/favorit-saya" data-route="/favorit-saya" class="button button-sm button-outline mt-1">Lihat Detail</a>
                    </div>
                </div>
                <div class="card mt-3">
                    <h3 class="card-title">Properti Terbaru</h3>
                    <div class="property-grid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));">
                        ${appState.properties.slice(0, 2).map(p => renderPropertyCard(p, { showUserActions: true })).join('')}
                    </div>
                    <div class="text-right mt-2">
                        <a href="/properti" data-route="/properti" class="button button-outline">Lihat Semua <i class="fas fa-arrow-right"></i></a>
                    </div>
                </div>
            </section>`;
        }

        function renderUserProfilePage() {
            if (!appState.isUserLoggedIn) { navigateTo('/login'); return ''; }
            const user = appState.currentUser;
            return `
            <section class="container" id="user-profile">
                <h2>Profil Saya</h2>
                <div class="profile-container mt-3">
                    <aside class="profile-sidebar card p-3">
                        <div class="avatar-upload">
                            <img src="${sanitizeHTML(user.photo)}" alt="Avatar ${sanitizeHTML(user.name)}" id="profileAvatarPreview">
                            <input type="file" id="avatarFile" accept="image/*">
                            <label for="avatarFile" class="button button-outline button-sm">Ganti Foto Profil</label>
                        </div>
                        <div class="profile-info-item">
                            <strong>Nama:</strong>
                            <span id="profileInfoName">${sanitizeHTML(user.name)}</span>
                        </div>
                        <div class="profile-info-item">
                            <strong>Email:</strong>
                            <span id="profileInfoEmail">${sanitizeHTML(user.email)}</span>
                        </div>
                         <button class="button button-sm mt-2" id="editProfileButton">Edit Profil</button>
                    </aside>
                    <div class="profile-main card p-3">
                        <h3 class="card-title">Edit Informasi Profil</h3>
                        <form id="userProfileForm">
                            <div class="input-group">
                                <label for="profileName">Nama Lengkap</label>
                                <input type="text" id="profileName" value="${sanitizeHTML(user.name)}" required>
                            </div>
                            <div class="input-group">
                                <label for="profileEmail">Alamat Email</label>
                                <input type="email" id="profileEmail" value="${sanitizeHTML(user.email)}" required>
                            </div>
                            <hr class="my-3">
                            <h4 class="h5">Ganti Password (Opsional)</h4>
                            <div class="input-group">
                                <label for="profileOldPassword">Password Lama</label>
                                <input type="password" id="profileOldPassword">
                            </div>
                            <div class="input-group">
                                <label for="profileNewPassword">Password Baru</label>
                                <input type="password" id="profileNewPassword">
                            </div>
                            <div class="input-group">
                                <label for="profileConfirmPassword">Konfirmasi Password Baru</label>
                                <input type="password" id="profileConfirmPassword">
                            </div>
                            <button type="submit" class="button">Simpan Perubahan</button>
                        </form>
                    </div>
                </div>
            </section>`;
        }

        function renderUserBookingsPage() {
            if (!appState.isUserLoggedIn) { navigateTo('/login'); return ''; }
            const bookings = appState.currentUser.bookings;
            return `
            <section class="container" id="user-bookings">
                <h2>Booking Saya</h2>
                <div class="card mt-3">
                    ${bookings.length === 0 ? '<p class="text-center">Anda belum memiliki booking.</p>' : `
                    <div style="overflow-x:auto;">
                        <table class="property-table">
                            <thead><tr><th>ID Booking</th><th>Nama Properti</th><th>Tanggal</th><th>Status</th><th>Aksi</th></tr></thead>
                            <tbody>
                                ${bookings.map(b => `
                                <tr>
                                    <td>${sanitizeHTML(b.id)}</td>
                                    <td>${sanitizeHTML(b.propertyName)}</td>
                                    <td>${formatDate(b.date)}</td>
                                    <td><span class="badge ${b.status === 'Aktif' ? 'success' : 'warning'}">${sanitizeHTML(b.status)}</span></td>
                                    <td><button class="button button-sm button-outline" onclick="alert('Lihat detail booking ${b.id}')">Detail</button></td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>`}
                </div>
            </section>`;
        }

        function renderUserFavoritesPage() {
            if (!appState.isUserLoggedIn) { navigateTo('/login'); return ''; }
            const favoriteIds = appState.currentUser.favorites;
            const favoriteProperties = appState.properties.filter(p => favoriteIds.includes(p.id));
            return `
            <section class="container" id="user-favorites">
                <h2>Properti Favorit Saya</h2>
                <div class="mt-3">
                    ${favoriteProperties.length === 0 ? '<div class="card p-3 text-center"><p>Anda belum memiliki properti favorit.</p><a href="/properti" data-route="/properti" class="button">Cari Properti Sekarang</a></div>' : `
                    <div class="property-grid">
                        ${favoriteProperties.map(p => renderPropertyCard(p, { showUserActions: true })).join('')}
                    </div>`}
                </div>
            </section>`;
        }

        function renderUserPaymentHistoryPage() {
            if (!appState.isUserLoggedIn) { navigateTo('/login'); return ''; }
            const payments = appState.currentUser.paymentHistory;
            return `
            <section class="container" id="user-payment-history">
                <h2>Riwayat Pembayaran Saya</h2>
                <div class="card mt-3">
                     ${payments.length === 0 ? '<p class="text-center">Anda belum memiliki riwayat pembayaran.</p>' : `
                    <div style="overflow-x:auto;">
                        <table class="property-table">
                            <thead><tr><th>ID Pembayaran</th><th>Properti</th><th>Jumlah</th><th>Tanggal</th><th>Metode</th></tr></thead>
                            <tbody>
                                ${payments.map(p => `
                                <tr>
                                    <td>${sanitizeHTML(p.id)}</td>
                                    <td>${sanitizeHTML(p.propertyName)}</td>
                                    <td>${formatCurrency(p.amount)}</td>
                                    <td>${formatDate(p.date)}</td>
                                    <td>${sanitizeHTML(p.method)}</td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>`}
                </div>
            </section>`;
        }

        function renderUserMaintenancePage() {
            if (!appState.isUserLoggedIn) { navigateTo('/login'); return ''; }
            const requests = appState.currentUser.maintenanceRequests;
            return `
            <section class="container" id="user-maintenance">
                <h2>Permintaan Maintenance Saya</h2>
                <div class="card mt-3 p-3">
                    <h3 class="card-title">Ajukan Permintaan Baru</h3>
                    <form id="maintenanceRequestForm">
                        <div class="input-group">
                            <label for="maintenanceProperty">Pilih Properti (jika ada booking aktif)</label>
                            <select id="maintenanceProperty" required>
                                <option value="">-- Pilih Properti --</option>
                                ${appState.currentUser.bookings.filter(b => b.status === 'Aktif').map(b => `<option value="${b.propertyName}">${b.propertyName}</option>`).join('') || '<option value="" disabled>Tidak ada booking aktif</option>'}
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="maintenanceIssue">Deskripsi Masalah</label>
                            <textarea id="maintenanceIssue" rows="3" placeholder="Contoh: AC tidak dingin, keran bocor, dll." required></textarea>
                        </div>
                        <button type="submit" class="button">Kirim Permintaan</button>
                    </form>
                </div>
                <div class="card mt-3">
                    <h3 class="card-title">Riwayat Permintaan</h3>
                     ${requests.length === 0 ? '<p class="text-center">Anda belum memiliki riwayat permintaan maintenance.</p>' : `
                    <div style="overflow-x:auto;">
                        <table class="property-table">
                            <thead><tr><th>ID</th><th>Properti</th><th>Permintaan</th><th>Tanggal</th><th>Status</th></tr></thead>
                            <tbody>
                                ${requests.map(r => `
                                <tr>
                                    <td>${sanitizeHTML(r.id)}</td>
                                    <td>${sanitizeHTML(r.propertyName)}</td>
                                    <td>${sanitizeHTML(r.request)}</td>
                                    <td>${formatDate(r.date)}</td>
                                    <td><span class="badge ${r.status === 'Selesai' ? 'success' : (r.status === 'Dalam Proses' ? 'warning' : 'primary')}">${sanitizeHTML(r.status)}</span></td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>`}
                </div>
            </section>`;
        }

        function renderUserMessagesPage() {
            if (!appState.isUserLoggedIn) { navigateTo('/login'); return ''; }
            const messages = appState.currentUser.messages.sort((a, b) => new Date(b.date) - new Date(a.date)); // Terbaru dulu
            return `
            <section class="container" id="user-messages">
                <h2>Pesan Saya</h2>
                <div class="card mt-3">
                    ${messages.length === 0 ? '<p class="text-center">Tidak ada pesan.</p>' : `
                    <ul style="list-style:none; padding:0;">
                        ${messages.map(msg => `
                        <li style="border-bottom: 1px solid var(--border-color); padding: var(--gap-md) 0; ${!msg.read ? 'font-weight:bold;' : ''}" 
                            onclick="markMessageAsRead('${msg.id}')" data-message-id="${msg.id}" role="button" tabIndex="0"
                            onkeypress="if(event.key==='Enter' || event.key===' ') markMessageAsRead('${msg.id}')">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>
                                    <i class="fas ${msg.read ? 'fa-envelope-open' : 'fa-envelope'} fa-fw" style="color: ${msg.read ? 'inherit' : 'var(--primary-color)'};"></i>
                                    <strong>Dari:</strong> ${sanitizeHTML(msg.sender)} - <em>${sanitizeHTML(msg.subject)}</em>
                                </span>
                                <small>${formatDate(msg.date)}</small>
                            </div>
                            <p class="mt-1" style="margin-left: calc(var(--gap-md) + 20px); font-weight:normal;">${sanitizeHTML(msg.content.substring(0, 100))}${msg.content.length > 100 ? '...' : ''}</p>
                        </li>`).join('')}
                    </ul>`}
                </div>
            </section>`;
        }


        // Halaman Admin
        function renderAdminLoginPage() {
            if (appState.isAdmin) { navigateTo('/admin/dashboard'); return ''; }
            return `
            <section class="container text-center" style="max-width: 450px;">
                <div class="card p-3">
                    <h2 class="card-title">Login Admin</h2>
                    <form id="adminLoginForm">
                        <div class="input-group"><label for="adminUsername">Username</label><input type="text" id="adminUsername" value="admin" required></div>
                        <div class="input-group"><label for="adminPassword">Password</label><input type="password" id="adminPassword" value="password" required></div>
                        <button type="submit" class="button" style="width:100%;">Login</button>
                    </form>
                    <p class="mt-1" style="font-size: 0.8rem;">(Username: <strong>admin</strong>, Password: <strong>password</strong>)</p>
                </div>
            </section>`;
        }
        function renderAdminDashboardPage() {
            if (!appState.isAdmin) { navigateTo('/admin'); return ''; }
            const totalProperties = appState.properties.length;
            const totalReviews = appState.reviews.length;
            const activeRentals = Math.floor(Math.random() * totalProperties); // Dummy
            const totalUsers = Math.floor(Math.random() * 100) + 50; // Dummy
            return `
            <section class="container" id="admin-dashboard">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>Dasbor Admin</h2>
                    <button class="button button-outline" onclick="adminLogout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
                <div class="admin-dashboard-grid">
                    <div class="card dashboard-card"><i class="fas fa-building icon"></i><div class="value">${totalProperties}</div><div class="title">Total Properti</div></div>
                    <div class="card dashboard-card"><i class="fas fa-star icon"></i><div class="value">${totalReviews}</div><div class="title">Total Ulasan</div></div>
                    <div class="card dashboard-card"><i class="fas fa-key icon"></i><div class="value">${activeRentals}</div><div class="title">Sewa Aktif</div></div>
                    <div class="card dashboard-card"><i class="fas fa-users icon"></i><div class="value">${totalUsers}</div><div class="title">Total Pengguna</div></div>
                </div>
                <div class="mt-3">
                    <a href="/admin/properti" data-route="/admin/properti" class="button"><i class="fas fa-list-alt"></i> Kelola Properti</a>
                    <a href="/admin/properti/tambah" data-route="/admin/properti/tambah" class="button button-outline"><i class="fas fa-plus-circle"></i> Tambah Properti</a>
                </div>
            </section>`;
        }
        function renderAdminPropertiPage() {
            if (!appState.isAdmin) { navigateTo('/admin'); return ''; }
            let tableRows = appState.properties.map(prop => `
            <tr>
                <td>${prop.id}</td>
                <td><img src="${sanitizeHTML(prop.image)}" alt="${sanitizeHTML(prop.name)}" style="width: 80px; height: 50px; object-fit: cover; border-radius: var(--radius-sm);"></td>
                <td>${sanitizeHTML(prop.name)}</td><td>${formatCurrency(prop.price)}</td><td>${sanitizeHTML(prop.location)}</td>
                <td class="actions">
                    <button class="button button-sm button-outline" onclick="navigateTo('/admin/properti/edit/${prop.id}')"><i class="fas fa-edit"></i></button>
                    <button class="button button-sm button-danger" onclick="deleteProperty(${prop.id})"><i class="fas fa-trash"></i></button>
                </td></tr>`).join('');
            if (appState.properties.length === 0) tableRows = `<tr><td colspan="6" class="text-center">Belum ada properti.</td></tr>`;
            return `
            <section class="container" id="admin-properti">
                 <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>Manajemen Properti</h2>
                    <div>
                        <a href="/admin/properti/tambah" data-route="/admin/properti/tambah" class="button"><i class="fas fa-plus-circle"></i> Tambah</a>
                        <a href="/admin/dashboard" data-route="/admin/dashboard" class="button button-outline"><i class="fas fa-arrow-left"></i> Dasbor</a>
                    </div>
                </div>
                <div class="card" style="overflow-x: auto;"><table class="property-table">
                    <thead><tr><th>ID</th><th>Gambar</th><th>Nama</th><th>Harga</th><th>Lokasi</th><th>Aksi</th></tr></thead>
                    <tbody>${tableRows}</tbody>
                </table></div>
            </section>`;
        }
        function renderAdminTambahPropertiPage() { if (!appState.isAdmin) { navigateTo('/admin'); return ''; } return renderPropertyForm(); }
        function renderAdminEditPropertiPage(params) {
            if (!appState.isAdmin) { navigateTo('/admin'); return ''; }
            const property = appState.properties.find(p => p.id === parseInt(params.id));
            if (!property) return renderNotFoundPage({ message: 'Properti edit tidak ditemukan.' });
            return renderPropertyForm(property);
        }
        function renderPropertyForm(property = null) {
            const isEdit = property !== null;
            return `
            <section class="container" id="admin-form-properti">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>${isEdit ? `Edit Properti: ${sanitizeHTML(property.name)}` : 'Tambah Properti Baru'}</h2>
                    <a href="/admin/properti" data-route="/admin/properti" class="button button-outline"><i class="fas fa-arrow-left"></i> Batal</a>
                </div>
                <div class="card">
                    <form id="propertyForm" data-mode="${isEdit ? 'edit' : 'add'}" ${isEdit ? `data-id="${property.id}"` : ''}>
                        <div class="input-group"><label for="propName">Nama Properti</label><input type="text" id="propName" value="${isEdit ? sanitizeHTML(property.name) : ''}" required></div>
                        <div class="input-group"><label for="propPrice">Harga (Rp/bulan, angka saja)</label><input type="number" id="propPrice" value="${isEdit ? property.price.replace(/\./g, '') : ''}" placeholder="15000000" required></div>
                        <div class="input-group"><label for="propLocation">Lokasi</label><input type="text" id="propLocation" value="${isEdit ? sanitizeHTML(property.location) : ''}" required></div>
                        <div class="input-group"><label for="propImage">URL Gambar</label><input type="url" id="propImage" value="${isEdit ? sanitizeHTML(property.image) : ''}" placeholder="https://..." required></div>
                         <div class="d-flex" style="gap: var(--gap-md); flex-wrap:wrap;">
                            <div class="input-group" style="flex:1;"><label for="propBeds">Kamar Tidur</label><input type="number" id="propBeds" value="${isEdit ? property.beds : ''}" min="1" required></div>
                            <div class="input-group" style="flex:1;"><label for="propBaths">Kamar Mandi</label><input type="number" id="propBaths" value="${isEdit ? property.baths : ''}" min="1" required></div>
                            <div class="input-group" style="flex:1;"><label for="propArea">Luas (m)</label><input type="number" id="propArea" value="${isEdit ? property.area : ''}" min="10" required></div>
                        </div>
                        <div class="input-group"><label for="propDesc">Deskripsi</label><textarea id="propDesc" rows="5" required>${isEdit ? sanitizeHTML(property.description) : ''}</textarea></div>
                        <div class="input-group"><label for="propTourLink">Link Virtual Tour (Opsional)</label><input type="url" id="propTourLink" value="${isEdit && property.virtualTourLink ? sanitizeHTML(property.virtualTourLink) : ''}" placeholder="https://..."></div>
                        <button type="submit" class="button">${isEdit ? 'Simpan Perubahan' : 'Tambahkan Properti'}</button>
                    </form>
                </div>
            </section>`;
        }

        function renderNotFoundPage(context = {}) {
            return `
            <section class="container text-center" style="padding: 4rem 0;">
                <i class="fas fa-exclamation-triangle fa-5x mb-3" style="color: var(--primary-color);"></i>
                <h1>404 - Halaman Tidak Ditemukan</h1>
                <p>${sanitizeHTML(context.message || "Maaf, halaman yang Anda cari tidak ada.")}</p>
                <a href="/" data-route="/" class="button"><i class="fas fa-home"></i> Kembali ke Beranda</a>
            </section>`;
        }

        // === INISIALISASI HALAMAN SETELAH RENDER ===
        function initializePageScripts(path, params) {
            if (path === '/properti') initPropertiPageScripts();
            if (path === '/pembayaran') initPembayaranPageScripts();
            if (path === '/ulasan') initUlasanPageScripts();
            if (path === '/kontak') initKontakPageScripts();
            if (path === '/login') initUserLoginPageScripts();
            if (path === '/register') initUserRegisterPageScripts();
            if (path === '/profil') initUserProfilePageScripts();
            if (path === '/maintenance-saya') initUserMaintenancePageScripts();
            if (path === '/admin') initAdminLoginPageScripts();
            if (path.startsWith('/admin/properti/tambah') || path.startsWith('/admin/properti/edit/')) initPropertyFormScripts();
            // Untuk detail properti, event listener pada tombol favorit ditangani saat render
        }

        function initPropertiPageScripts() {
            const searchInput = $('#searchProperty');
            const sortSelect = $('#sortProperty');
            const propertyListing = $('#propertyListing');
            function filterAndSortProperties() {
                let filtered = [...appState.properties];
                const searchTerm = searchInput.value.toLowerCase();
                if (searchTerm) filtered = filtered.filter(p => p.name.toLowerCase().includes(searchTerm) || p.location.toLowerCase().includes(searchTerm));
                const sortBy = sortSelect.value;
                if (sortBy === 'price_asc') filtered.sort((a, b) => parseFloat(a.price.replace(/\./g, '')) - parseFloat(b.price.replace(/\./g, '')));
                else if (sortBy === 'price_desc') filtered.sort((a, b) => parseFloat(b.price.replace(/\./g, '')) - parseFloat(a.price.replace(/\./g, '')));
                else if (sortBy === 'name_asc') filtered.sort((a, b) => a.name.localeCompare(b.name));
                renderFilteredProperties(filtered);
            }
            function renderFilteredProperties(props) {
                propertyListing.innerHTML = props.length > 0 ? props.map(p => renderPropertyCard(p, { showUserActions: true })).join('') : '<p class="text-center" style="grid-column: 1 / -1;">Properti tidak ditemukan.</p>';
            }
            if (searchInput) searchInput.addEventListener('input', filterAndSortProperties);
            if (sortSelect) sortSelect.addEventListener('change', filterAndSortProperties);
            filterAndSortProperties();
        }

        function initPembayaranPageScripts() {
            const paymentCards = $$('.payment-card');
            const detailsContainer = $('#paymentDetailsContainer');
            const fields = $('#paymentFields');
            const title = $('#selectedPaymentMethodTitle');
            const form = $('#paymentForm');
            const methodDetails = {
                'credit-card': { title: 'Kartu Kredit/Debit', fields: `<div class="input-group"><label for="cardNumber">Nomor Kartu</label><input type="text" id="cardNumber" pattern="[0-9]{13,16}" required></div><div class="d-flex" style="gap:var(--gap-md);"><div class="input-group" style="flex:1;"><label for="expiryDate">Kadaluarsa</label><input type="month" id="expiryDate" required></div><div class="input-group" style="flex:1;"><label for="cvv">CVV</label><input type="text" id="cvv" pattern="[0-9]{3,4}" required></div></div>` },
                'bank-transfer': { title: 'Transfer Bank', fields: `<p>Transfer ke BCA: 123-456-7890 a/n Green Valley.</p>` },
                'ewallet': { title: 'E-Wallet', fields: `<div class="input-group"><label for="ewalletType">Pilih E-Wallet</label><select id="ewalletType" required><option value="">--Pilih--</option><option value="gopay">Gopay</option></select></div>` }
            };
            paymentCards.forEach(card => card.addEventListener('click', () => {
                paymentCards.forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                const method = card.dataset.method;
                title.textContent = `Detail: ${methodDetails[method].title}`;
                fields.innerHTML = methodDetails[method].fields;
                detailsContainer.style.display = 'block';
                form.querySelector('button[type="submit"]').style.display = (method === 'bank-transfer') ? 'none' : 'block';
            }));
            if (form) form.addEventListener('submit', (e) => { e.preventDefault(); alert('Pembayaran diproses... (Simulasi)'); form.reset(); detailsContainer.style.display = 'none'; paymentCards.forEach(c => c.classList.remove('selected')); });
        }

        function initUlasanPageScripts() {
            const starsContainer = $('#ratingStarsContainer');
            const stars = starsContainer ? starsContainer.querySelectorAll('span') : [];
            const nameInput = $('#reviewName');
            const reviewInput = $('#reviewInput');
            const submitBtn = $('#submitReviewButton');
            const listContainer = $('#reviewsListContainer');

            function updateStarsVisual(rating) { stars.forEach(s => s.classList.toggle('selected', parseInt(s.dataset.value) <= rating)); }
            function handleStarHover(e) { if (!starsContainer.classList.contains('rated')) { const r = parseInt(e.target.dataset.value); stars.forEach(s => { s.style.color = parseInt(s.dataset.value) <= r ? '#ffd700' : '#ccc'; }); } }
            function handleStarMouseOut() { if (!starsContainer.classList.contains('rated')) updateStarsVisual(appState.currentRating); else updateStarsVisual(appState.currentRating); }
            stars.forEach(star => {
                star.addEventListener('click', () => { appState.currentRating = parseInt(star.dataset.value); updateStarsVisual(appState.currentRating); starsContainer.classList.add('rated'); });
                star.addEventListener('mouseover', handleStarHover);
            });
            if (starsContainer) starsContainer.addEventListener('mouseout', handleStarMouseOut);

            function renderAllReviews() {
                if (!listContainer) return;
                listContainer.innerHTML = appState.reviews.length > 0 ? appState.reviews.sort((a, b) => new Date(b.date) - new Date(a.date)).map(renderReviewCard).join('') : '<p class="text-center">Belum ada ulasan.</p>';
            }
            if (submitBtn) submitBtn.addEventListener('click', () => {
                const name = nameInput.value.trim(); const text = reviewInput.value.trim();
                if (!name || appState.currentRating === 0 || !text) { alert('Lengkapi nama, rating, dan ulasan.'); return; }
                appState.reviews.push({ id: Date.now(), name, text, rating: appState.currentRating, date: new Date().toISOString() });
                localStorage.setItem('reviewsGreen Valley', JSON.stringify(appState.reviews));
                renderAllReviews();
                nameInput.value = ''; reviewInput.value = ''; appState.currentRating = 0; updateStarsVisual(0); starsContainer.classList.remove('rated');
                alert('Ulasan terkirim!');
            });
            renderAllReviews();
        }

        function initKontakPageScripts() {
            const form = $('#contactForm');
            if (form) form.addEventListener('submit', (e) => { e.preventDefault(); alert('Pesan terkirim! (Simulasi)'); form.reset(); });
        }

        function initUserLoginPageScripts() {
            const form = $('#userLoginForm');
            if (form) form.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = $('#userEmail').value;
                const password = $('#userPassword').value;
                // Simulasi login
                if (email === 'user@example.com' && password === 'password') {
                    appState.isUserLoggedIn = true;
                    // appState.currentUser sudah ada defaultnya, bisa di-override jika ada data dari "server"
                    appState.currentUser.email = email; // Update email jika beda
                    appState.currentUser.name = "Pengguna Terdaftar"; // Atau ambil dari form register sebelumnya
                    localStorage.setItem('isUserLoggedInGreen Valley', JSON.stringify(true));
                    localStorage.setItem('currentUserGreen Valley', JSON.stringify(appState.currentUser));
                    updateUserAuthUI();
                    navigateTo('/dashboard-pengguna');
                } else {
                    alert('Email atau password salah.');
                }
            });
        }

        function initUserRegisterPageScripts() {
            const form = $('#userRegisterForm');
            if (form) form.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = $('#registerName').value;
                const email = $('#registerEmail').value;
                const password = $('#registerPassword').value;
                const confirmPassword = $('#registerConfirmPassword').value;

                if (password !== confirmPassword) {
                    alert('Password dan konfirmasi password tidak cocok!');
                    return;
                }
                // Simulasi registrasi
                appState.isUserLoggedIn = true;
                appState.currentUser = {
                    name: name, email: email, photo: 'https://via.placeholder.com/150/777777/FFFFFF?Text=' + name.charAt(0).toUpperCase(),
                    bookings: [], favorites: [], maintenanceRequests: [], paymentHistory: [], messages: [{ id: 'REG001', sender: 'Sistem', subject: 'Selamat Bergabung!', content: `Halo ${name}, selamat datang di Green Valley! Akun Anda berhasil dibuat.`, date: new Date().toISOString(), read: false }]
                };
                localStorage.setItem('isUserLoggedInGreen Valley', JSON.stringify(true));
                localStorage.setItem('currentUserGreen Valley', JSON.stringify(appState.currentUser));
                updateUserAuthUI();
                alert('Registrasi berhasil! Anda sekarang login.');
                navigateTo('/dashboard-pengguna');
            });
        }

        function initUserProfilePageScripts() {
            const form = $('#userProfileForm');
            const avatarFile = $('#avatarFile');
            const avatarPreview = $('#profileAvatarPreview');
            const editProfileButton = $('#editProfileButton'); // Jika ada tombol edit mode

            if (editProfileButton) { // Jika ada mode lihat dan mode edit terpisah
                $('#userProfileForm').style.display = 'none'; // Sembunyikan form awal
                editProfileButton.addEventListener('click', () => {
                    $('#userProfileForm').style.display = 'block';
                    editProfileButton.style.display = 'none'; // Sembunyikan tombol edit
                });
            }


            if (avatarFile && avatarPreview) {
                avatarFile.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            avatarPreview.src = event.target.result;
                            appState.currentUser.photo = event.target.result; // Simpan sebagai base64
                            localStorage.setItem('currentUserGreen Valley', JSON.stringify(appState.currentUser));
                            updateUserAuthUI(); // Update avatar di header/sidebar
                        }
                        reader.readAsDataURL(file);
                    }
                });
            }

            if (form) form.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = $('#profileName').value;
                const email = $('#profileEmail').value;
                // Validasi password jika diisi
                const oldPassword = $('#profileOldPassword').value;
                const newPassword = $('#profileNewPassword').value;
                const confirmPassword = $('#profileConfirmPassword').value;

                if (newPassword && newPassword !== confirmPassword) {
                    alert('Password baru dan konfirmasi tidak cocok.'); return;
                }
                // Logika update password (simulasi)
                if (oldPassword && newPassword) {
                    // Cek oldPassword (dummy, asumsikan selalu benar jika diisi)
                    alert('Password berhasil diubah (simulasi).');
                }

                appState.currentUser.name = name;
                appState.currentUser.email = email;
                localStorage.setItem('currentUserGreen Valley', JSON.stringify(appState.currentUser));
                updateUserAuthUI(); // Update nama/email di UI
                $('#profileInfoName').textContent = name;
                $('#profileInfoEmail').textContent = email;

                alert('Profil berhasil diperbarui!');
                if (editProfileButton) { // Kembali ke mode lihat
                    $('#userProfileForm').style.display = 'none';
                    editProfileButton.style.display = 'block';
                }
            });
        }

        function initUserMaintenancePageScripts() {
            const form = $('#maintenanceRequestForm');
            if (form) form.addEventListener('submit', (e) => {
                e.preventDefault();
                const propertyName = $('#maintenanceProperty').value;
                const issue = $('#maintenanceIssue').value;
                if (!propertyName || !issue) { alert('Pilih properti dan deskripsikan masalah.'); return; }

                const newRequest = {
                    id: 'M' + String(Date.now()).slice(-3),
                    propertyName,
                    request: issue,
                    date: new Date().toISOString(),
                    status: 'Diajukan'
                };
                appState.currentUser.maintenanceRequests.push(newRequest);
                localStorage.setItem('currentUserGreen Valley', JSON.stringify(appState.currentUser));
                alert('Permintaan maintenance terkirim!');
                form.reset();
                navigateTo('/maintenance-saya', false); // Re-render halaman
            });
        }


        function initAdminLoginPageScripts() {
            const form = $('#adminLoginForm');
            if (form) form.addEventListener('submit', (e) => {
                e.preventDefault();
                if ($('#adminUsername').value === 'admin' && $('#adminPassword').value === 'password') {
                    appState.isAdmin = true; localStorage.setItem('isAdminGreen Valley', JSON.stringify(true));
                    updateAdminLinksVisibility(); navigateTo('/admin/dashboard');
                } else { alert('Username atau password admin salah!'); }
            });
        }
        function initPropertyFormScripts() {
            const form = $('#propertyForm');
            if (form) form.addEventListener('submit', (e) => {
                e.preventDefault();
                const mode = form.dataset.mode;
                const id = mode === 'edit' ? parseInt(form.dataset.id) : Date.now();
                const data = {
                    id, name: $('#propName').value.trim(),
                    price: parseFloat($('#propPrice').value).toLocaleString('id-ID'),
                    location: $('#propLocation').value.trim(), image: $('#propImage').value.trim(),
                    beds: parseInt($('#propBeds').value), baths: parseInt($('#propBaths').value), area: parseInt($('#propArea').value),
                    description: $('#propDesc').value.trim(), virtualTourLink: $('#propTourLink').value.trim() || null
                };
                if (!data.name || !data.price || !data.location || !data.image || isNaN(data.beds) || isNaN(data.baths) || isNaN(data.area) || !data.description) {
                    alert('Lengkapi semua field wajib.'); return;
                }
                if (mode === 'add') appState.properties.push(data);
                else { const idx = appState.properties.findIndex(p => p.id === id); if (idx !== -1) appState.properties[idx] = data; }
                localStorage.setItem('propertiesGreen Valley', JSON.stringify(appState.properties));
                alert(`Properti ${mode === 'add' ? 'ditambahkan' : 'diperbarui'}!`);
                navigateTo('/admin/properti');
            });
        }

        // === FUNGSI AUTENTIKASI & UI PENGGUNA ===
        function updateUserAuthUI() {
            const authContainer = $('#userAuthContainer');
            const sidebar = $('#userSidebar');
            const sidebarToggle = $('#sidebarToggleBtnHeader');

            if (!authContainer || !sidebar || !sidebarToggle) return;

            if (appState.isUserLoggedIn) {
                const user = appState.currentUser;
                authContainer.innerHTML = `
                <div class="user-profile-dropdown" id="userProfileDropdown">
                    <button class="user-profile-button" id="userProfileBtn" aria-expanded="false" aria-controls="userDropdownMenu">
                        <img src="${sanitizeHTML(user.photo)}" alt="Avatar ${sanitizeHTML(user.name)}">
                        <span>${sanitizeHTML(user.name.split(' ')[0])}</span>
                        <i class="fas fa-caret-down" style="font-size:0.8em;"></i>
                    </button>
                    <ul class="dropdown-menu" id="userDropdownMenu" role="menu" aria-labelledby="userProfileBtn">
                        <li><a href="/dashboard-pengguna" data-route="/dashboard-pengguna" role="menuitem"><i class="fas fa-tachometer-alt"></i> Dasbor</a></li>
                        <li><a href="/profil" data-route="/profil" role="menuitem"><i class="fas fa-user-circle"></i> Profil Saya</a></li>
                        <li class="divider"></li>
                        <li><button id="userLogoutButton" role="menuitem"><i class="fas fa-sign-out-alt"></i> Logout</button></li>
                    </ul>
                </div>`;
                $('#userProfileBtn').addEventListener('click', () => {
                    $('#userProfileDropdown').classList.toggle('open');
                    const isOpen = $('#userProfileDropdown').classList.contains('open');
                    $('#userProfileBtn').setAttribute('aria-expanded', isOpen.toString());
                });
                $('#userLogoutButton').addEventListener('click', userLogout);

                // Update sidebar info
                $('#sidebarUserAvatar').src = sanitizeHTML(user.photo);
                $('#sidebarUserName').textContent = sanitizeHTML(user.name);
                $('#sidebarUserEmail').textContent = sanitizeHTML(user.email);
                sidebar.style.display = 'block'; // Tampilkan sidebar
                sidebarToggle.style.display = 'inline-flex'; // Tampilkan tombol toggle sidebar di header
                if (window.innerWidth >= 992) { // Desktop: sidebar visible by default
                    toggleUserSidebar(true);
                }

            } else { // Pengguna tidak login
                authContainer.innerHTML = `
                    <a href="/login" data-route="/login" class="button button-outline button-sm">Login</a>
                    <a href="/register" data-route="/register" class="button button-sm" style="margin-left: var(--gap-sm);">Daftar</a>`;
                sidebar.style.display = 'none'; // Sembunyikan sidebar
                sidebarToggle.style.display = 'none'; // Sembunyikan tombol toggle sidebar
                if (mainContent) mainContent.classList.remove('sidebar-visible');
                if (appWrapper) appWrapper.classList.remove('sidebar-active');
                if (appState.isSidebarOpen) toggleUserSidebar(false); // Pastikan sidebar tertutup
            }
            updateAdminLinksVisibility(); // Juga update link admin jika ada perubahan status
        }

        function userLogout() {
            appState.isUserLoggedIn = false;
            appState.currentUser = { name: 'Tamu', email: '', photo: 'https://via.placeholder.com/150', bookings: [], favorites: [], maintenanceRequests: [], paymentHistory: [], messages: [] }; // Reset user
            localStorage.removeItem('isUserLoggedInGreen Valley');
            localStorage.removeItem('currentUserGreen Valley');
            if ($('#userProfileDropdown')?.classList.contains('open')) {
                $('#userProfileDropdown').classList.remove('open');
                $('#userProfileBtn').setAttribute('aria-expanded', 'false');
            }
            updateUserAuthUI();
            if (appState.isSidebarOpen) toggleUserSidebar(false); // Tutup sidebar
            navigateTo('/');
        }

        // === FUNGSI ADMIN ===
        function adminLogout() {
            appState.isAdmin = false; localStorage.removeItem('isAdminGreen Valley');
            updateAdminLinksVisibility(); navigateTo('/');
        }
        function updateAdminLinksVisibility() {
            $$('.nav-admin-link').forEach(link => { link.style.display = appState.isAdmin ? 'inline-block' : 'none'; });
        }
        function deleteProperty(id) {
            if (confirm(`Yakin hapus properti ID ${id}?`)) {
                appState.properties = appState.properties.filter(p => p.id !== id);
                localStorage.setItem('propertiesGreen Valley', JSON.stringify(appState.properties));
                alert(`Properti ID ${id} dihapus.`);
                navigateTo(window.location.pathname === '/admin/properti' ? '/admin/properti' : '/admin/dashboard', false);
            }
        }

        // === FUNGSI PENGGUNA (FAVORIT, DLL) ===
        function toggleFavorite(propertyId, buttonElement, isOnDetailPage = false) {
            if (!appState.isUserLoggedIn) { navigateTo('/login'); return; }
            const index = appState.currentUser.favorites.indexOf(propertyId);
            if (index > -1) { // Sudah favorit, hapus
                appState.currentUser.favorites.splice(index, 1);
            } else { // Belum favorit, tambah
                appState.currentUser.favorites.push(propertyId);
            }
            localStorage.setItem('currentUserGreen Valley', JSON.stringify(appState.currentUser));

            // Update tampilan tombol
            if (buttonElement) {
                buttonElement.classList.toggle('active', index === -1); // active jika baru ditambahkan
                if (isOnDetailPage) {
                    buttonElement.innerHTML = `<i class="fas fa-heart"></i> ${index === -1 ? 'Hapus dari Favorit' : 'Tambah ke Favorit'}`;
                } else {
                    buttonElement.setAttribute('aria-label', index === -1 ? 'Hapus dari favorit' : 'Tambah ke favorit');
                }
            }
            // Jika di halaman favorit, re-render untuk update list
            if (window.location.pathname === '/favorit-saya') {
                navigateTo('/favorit-saya', false);
            }
        }

        function markMessageAsRead(messageId) {
            const message = appState.currentUser.messages.find(m => m.id === messageId);
            if (message && !message.read) {
                message.read = true;
                localStorage.setItem('currentUserGreen Valley', JSON.stringify(appState.currentUser));
                // Update UI secara visual jika diperlukan, atau re-render halaman pesan
                const messageElement = $(`[data-message-id="${messageId}"]`);
                if (messageElement) {
                    messageElement.style.fontWeight = 'normal';
                    const icon = messageElement.querySelector('i.fa-envelope');
                    if (icon) {
                        icon.classList.remove('fa-envelope');
                        icon.classList.add('fa-envelope-open');
                        icon.style.color = 'inherit';
                    }
                }
                // Bisa tambahkan logika untuk expand/tampilkan detail pesan
                alert(`Pesan dari ${message.sender} dibaca:\n${message.content}`);
            } else if (message && message.read) {
                alert(`Detail Pesan dari ${message.sender}:\n${message.content}`);
            }
        }


        // === SISTEM CHAT ===
        const chatToggle = $('#chatToggleButton'), chatWindow = $('#chatWindow');
        const closeChat = $('#closeChatButton'), chatMessages = $('#chatMessages'), chatInput = $('#chatInput');
        function toggleChatWindow(forceOpen = null) {
            appState.chat.isOpen = forceOpen !== null ? forceOpen : !appState.chat.isOpen;
            chatWindow.classList.toggle('open', appState.chat.isOpen);
            chatToggle.innerHTML = appState.chat.isOpen ? '<i class="fas fa-times"></i>' : '<i class="fas fa-comments"></i>';
            chatToggle.setAttribute('aria-label', appState.chat.isOpen ? 'Tutup chat' : 'Buka chat');
            if (appState.chat.isOpen) { chatInput.focus(); if (appState.chat.messages.length === 0) addChatMessage('Selamat datang! Ada yang bisa kami bantu?', 'system', true); }
        }
        function addChatMessage(text, sender, skipAutoResponse = false) {
            if (!text.trim()) return;
            const msg = { text: sanitizeHTML(text.trim()), sender, timestamp: new Date() };
            appState.chat.messages.push(msg); renderChatMessages();
            if (sender === 'user' && !skipAutoResponse) {
                chatInput.value = '';
                setTimeout(() => addChatMessage("Terima kasih, tim kami akan segera merespons.", 'system', true), 1500);
            }
        }
        function renderChatMessages() {
            if (!chatMessages) return;
            chatMessages.innerHTML = appState.chat.messages.map(m => `<div class="chat-msg ${m.sender}"><p>${m.text}</p><time>${m.timestamp.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}</time></div>`).join('');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        function initiateChatWithAgent(propertyName) {
            toggleChatWindow(true);
            const defaultMessage = `Halo, saya tertarik dengan properti "${sanitizeHTML(propertyName)}". Info lebih lanjut?`;
            if (chatInput) { chatInput.value = defaultMessage; chatInput.focus(); }
            else { addChatMessage(defaultMessage, 'system', true); }
        }

        // === INISIALISASI GLOBAL ===
        document.addEventListener('DOMContentLoaded', () => {
            applyTheme(appState.currentTheme);
            $('#themeToggle')?.addEventListener('click', toggleTheme);
            $('#mobileMenuToggle')?.addEventListener('click', toggleMobileMenu);
            $('#currentYear').textContent = new Date().getFullYear();

            // Sidebar listeners
            if (sidebarToggleBtnHeader) sidebarToggleBtnHeader.addEventListener('click', () => toggleUserSidebar());
            if (sidebarOverlay) sidebarOverlay.addEventListener('click', () => toggleUserSidebar(false)); // Tutup jika klik overlay
            document.addEventListener('click', closeSidebarOnClickOutside); // Tutup jika klik di luar sidebar (mobile)
            const userLogoutSidebarBtn = $('#userLogoutSidebarButton');
            if (userLogoutSidebarBtn) userLogoutSidebarBtn.addEventListener('click', (e) => { e.preventDefault(); userLogout(); });


            // Router SPA event listeners
            document.body.addEventListener('click', e => {
                const targetLink = e.target.closest('a[data-route]');
                if (targetLink) { e.preventDefault(); navigateTo(targetLink.getAttribute('href')); }
                // Tutup dropdown user jika klik di luar
                const userDropdown = $('#userProfileDropdown');
                if (userDropdown && userDropdown.classList.contains('open') && !userDropdown.contains(e.target)) {
                    userDropdown.classList.remove('open');
                    $('#userProfileBtn').setAttribute('aria-expanded', 'false');
                }
            });
            window.addEventListener('popstate', e => { navigateTo(e.state && e.state.path ? e.state.path : window.location.pathname, false); });

            // Chat Widget
            if (chatToggle) chatToggle.addEventListener('click', () => toggleChatWindow());
            if (closeChat) closeChat.addEventListener('click', () => toggleChatWindow(false));
            if (chatInput) chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addChatMessage(chatInput.value, 'user'); });
            renderChatMessages();

            updateUserAuthUI(); // Inisialisasi UI login/profil & sidebar
            navigateTo(window.location.pathname, false); // Muat halaman awal
        });
        //]]>
    </script>
</body>

</html>